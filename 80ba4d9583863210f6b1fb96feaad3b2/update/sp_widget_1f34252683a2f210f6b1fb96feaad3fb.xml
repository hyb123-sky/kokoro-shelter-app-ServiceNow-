<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, $timeout) {
    var c = this;
    c.error = '';
    c.success = false;
    c.geoSuccess = ''; // æ–°å¢ï¼šç”¨äºå­˜å‚¨åœ°ç†ç¼–ç æˆåŠŸä¿¡æ¯
    c.geoError = '';   // æ–°å¢ï¼šç”¨äºå­˜å‚¨åœ°ç†ç¼–ç å¤±è´¥ä¿¡æ¯
    
    // ä» Server è·å– Token
    c.server.get().then(function(response) {
        if (response.data.token) {
            // console.log("Token retrieved.");
            $timeout(function() {
                testMap(response.data.token);
            }, 500);
        } else {
            c.error = "No token returned from server.";
        }
    });
    
    function testMap(token) {
        try {
            if (typeof mapboxgl === 'undefined') {
                c.error = 'Mapbox GL JS library is not loaded.';
                return;
            }
            
            mapboxgl.accessToken = token;
            
            var map = new mapboxgl.Map({
                container: 'test-map',
                style: 'mapbox://styles/mapbox/dark-v10', // ä¿æŒæ·±è‰²æ¨¡å¼
                center: [139.6917, 35.6895], // ä¸œäº¬
                zoom: 10
            });
            
            map.on('load', function() {
                c.success = true;
                c.error = ''; 
                map.resize(); // å…³é”®ï¼šé˜²æ­¢åœ°å›¾æ˜¾ç¤ºä¸å…¨
                
                // --- æ–°å¢ï¼šæµ‹è¯• Geocoding API (æŸ¥è¯¢ä¸œäº¬å¡”) ---
                console.log("æ­£åœ¨æµ‹è¯• Geocoding API...");
                var geocodingUrl = 'https://api.mapbox.com/geocoding/v5/mapbox.places/Tokyo%20Tower.json?access_token=' + token;
                
                fetch(geocodingUrl)
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.features && data.features.length > 0) {
                            console.log("âœ… Geocoding æˆåŠŸ! åæ ‡:", data.features[0].center);
                            // æ›´æ–° UI æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                            c.geoSuccess = "Geocoding API is working! Found: " + data.features[0].place_name;
                        } else {
                            console.warn("Geocoding è¿”å›äº†ç©ºæ•°æ®");
                            c.geoError = "Geocoding returned no results.";
                        }
                        $scope.$apply(); // åˆ·æ–°é¡µé¢æ˜¾ç¤º
                    })
                    .catch(function(error) {
                        console.error("âŒ Geocoding å¤±è´¥:", error);
                        c.geoError = "Geocoding failed: " + error.message;
                        $scope.$apply();
                    });
                // ---------------------------------------------
                
                $timeout(function() {
                    $scope.$apply();
                });
            });
            
            map.on('error', function(e) {
                console.error("Mapbox Error:", e);
                c.error = 'Map error: ' + (e.error ? e.error.message : 'Unknown error');
                $scope.$apply();
            });

        } catch (e) {
            console.error(e);
            c.error = 'Exception: ' + e.message;
        }
    }
};]]></client_script>
        <controller_as>c</controller_as>
        <css>#test-map {
    border: 2px solid #ddd;
    border-radius: 4px;
}

.panel {
    margin: 20px;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>mapbox_test</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Mapbox Test</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    // ä¿®æ­£ï¼šä½¿ç”¨å®Œæ•´çš„ã€æ­£ç¡®çš„å±æ€§åç§°
    // ä¹‹å‰é”™è¯¯å†™æˆäº† .mapbc
    data.token = gs.getProperty('x_1821654_kokoro_0.kokoro.mapbox.api_key', '');
    
    if (!data.token) {
        gs.error('[Kokoro Map Test] Token not found using property: x_1821654_kokoro_0.kokoro.mapbox.api_key');
        data.error = 'Token not configured in System Properties';
    } else {
        // å¯é€‰ï¼šè°ƒè¯•æ—¥å¿—
        // gs.info('[Kokoro Map Test] Token found: ' + data.token.substring(0, 5) + '...');
    }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-23 01:20:52</sys_created_on>
        <sys_id>1f34252683a2f210f6b1fb96feaad3fb</sys_id>
        <sys_mod_count>10</sys_mod_count>
        <sys_name>Mapbox Test</sys_name>
        <sys_package display_value="Kokoro Shelter" source="x_1821654_kokoro_0">80ba4d9583863210f6b1fb96feaad3b2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Kokoro Shelter">80ba4d9583863210f6b1fb96feaad3b2</sys_scope>
        <sys_update_name>sp_widget_1f34252683a2f210f6b1fb96feaad3fb</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-23 04:23:54</sys_updated_on>
        <template><![CDATA[<div>
    <h2>Mapbox Token Test</h2>
    <div id="test-map" style="width: 100%; height: 400px;"></div>
    
    <div style="margin-top: 10px;">
        <p ng-if="c.error" style="color: red; font-weight: bold;">âŒ {{c.error}}</p>
        <p ng-if="c.success" style="color: green; font-weight: bold;">âœ… Token is valid! Map Loaded.</p>
        
        <p ng-if="c.geoSuccess" style="color: blue; font-weight: bold; margin-top: 5px;">
            ]]>ğŸ“<![CDATA[ {{c.geoSuccess}}
        </p>
        <p ng-if="c.geoError" style="color: orange; font-weight: bold; margin-top: 5px;">
            âš ï¸ {{c.geoError}}
        </p>
    </div>
</div>]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>1f34252683a2f210f6b1fb96feaad3fb</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-23 01:20:52</sys_created_on>
        <sys_id>5734252683a2f210f6b1fb96feaad3ff</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-23 01:20:52</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
