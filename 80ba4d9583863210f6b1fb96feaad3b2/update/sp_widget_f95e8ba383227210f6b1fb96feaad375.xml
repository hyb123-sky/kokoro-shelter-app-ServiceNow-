<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, $uibModal, spUtil, $timeout, $window, $interval, $element) {
    var c = this;

    // ============================================================
    // KOKORO VOLUNTEER DASHBOARD - CLIENT SCRIPT v16.0 (Inventory Integrated)
    // 包含: 
    // 1. Sniper Protocol (UI Cleaner)
    // 2. Full Business Logic
    // 3. SLA & Auto Assignment
    // 4. State Flow Logic
    // 5. Resource Monitoring (库存监控)
    // ============================================================

    // ------------------------------------------------------------
    // [PART 1] UI CLEANER (THE SNIPER) - STRICTLY PRESERVED
    // ------------------------------------------------------------
    
    // 1. 坐标狙击手：物理清除左下角的任何干扰元素
    function runSniper() {
        var windowHeight = $window.innerHeight;
        var allElements = document.body.getElementsByTagName('*');
        
        for (var i = 0; i < allElements.length; i++) {
            var el = allElements[i];
            
            // 安全检查
            if (el.tagName === 'SCRIPT' || el.tagName === 'STYLE' || el.tagName === 'LINK') continue;
            if (el.classList.contains('kokoro-volunteer-container') || el.closest('.kokoro-volunteer-container')) continue;
            if (el.classList.contains('modal') || el.closest('.modal') || el.classList.contains('modal-backdrop')) continue;
            
            var rect = el.getBoundingClientRect();
            
            // 筛选条件: 可见的小物体
            if (rect.width > 0 && rect.height > 0 && rect.width < 100 && rect.height < 100) {
                var distBottom = windowHeight - rect.bottom;
                var distLeft = rect.left;
                
                // 击杀区域: 左下角 120px * 120px
                if (distBottom >= 0 && distBottom < 120 && distLeft >= 0 && distLeft < 120) {
                    // 执行清除
                    el.style.setProperty('display', 'none', 'important');
                    el.style.setProperty('visibility', 'hidden', 'important');
                    el.style.setProperty('opacity', '0', 'important');
                    el.style.setProperty('pointer-events', 'none', 'important');
                    
                    if (el.parentElement) {
                        var parentRect = el.parentElement.getBoundingClientRect();
                        if (parentRect.width < 150 && parentRect.height < 150) {
                             el.parentElement.style.setProperty('display', 'none', 'important');
                        }
                    }
                }
            }
        }
    }

    // 2. CSS 辅助隐藏
    function injectStyles() {
        var styleId = 'kokoro-sniper-style';
        if (document.getElementById(styleId)) return;
        
        var css = 'nav, header, footer, .sp-page-header, .navbar { display: none !important; } ';
        css += '.sp-page-row-options, .u_p_floating_container, .sn-chat-overlay, .theme-picker, .icon-palette { display: none !important; opacity: 0 !important; pointer-events: none !important; }';
        css += '.sla-critical { color: #ff3b30; font-weight: bold; } .sla-warning { color: #ff9500; } .sla-ok { color: #34c759; }'; // SLA样式
        css += '.progress-bar-danger { background-color: #d9534f; } .progress-bar-warning { background-color: #f0ad4e; } .progress-bar-success { background-color: #5cb85c; }'; // 进度条样式
        
        var style = document.createElement('style');
        style.id = styleId;
        style.appendChild(document.createTextNode(css));
        document.head.appendChild(style);
    }

    // 3. 启动清理策略
    injectStyles();
    // 高频扫描 15秒 (应对加载延迟)
    var sniperInterval = $interval(runSniper, 300);
    $timeout(function() {
        $interval.cancel(sniperInterval);
        // 之后转为低频巡逻
        sniperInterval = $interval(runSniper, 2000);
    }, 15000);


    // ------------------------------------------------------------
    // [PART 2] BUSINESS LOGIC & NEW FEATURES
    // ------------------------------------------------------------

    c.view = 'dashboard';
    c.currentTime = '';
    c.filteredList = null;
    c.currentFilter = null;

    c.data.user_name = c.data.user_name || 'Operator';
    c.data.list = c.data.list || []; 
    c.data.myTasks = c.data.myTasks || [];
    c.data.volunteers = c.data.volunteers || [];
    c.data.resourceStatus = c.data.resourceStatus || []; // 库存状态

    // === SLA统计初始化 ===
    c.slaStats = c.data.slaStats || { breached: 0, atRisk: 0, ok: 0 };
    
    // === 志愿者状态初始化 ===
    c.volunteerStatus = {
        isOnline: true,
        currentZone: '',
        taskCount: 0
    };

    // 字典与状态
    c.statusNames = { '1': 'DRAFT', '10': 'SUBMITTED', '11': 'ASSIGNED', '2': 'IN_PROGRESS', '4': 'COMPLETED', '5': 'CANCELLED', '6': 'ON_HOLD' };
    c.dict = { 'Water': '飲料水', 'Food': '食料', 'Medical': '医療・薬', 'Baby': '乳幼児用品', 'Power': '電源・充電', 'Other': 'その他', 'Family Area': 'ファミリーエリア', 'Single Area': '単身エリア', 'Medical Area': '医療・ケアエリア', 'Critical': '限界 (SOS)', 'High': '困っている', 'Medium': '普通', 'Low': '急ぎません' };

    // ==========================================
    // 新增：状态转换图逻辑
    // ==========================================
    c.stateFlow = {
        1: { name: 'New', next: ['Submitted'], color: '#888' },
        10: { name: 'Submitted', next: ['Assigned', 'Cancelled'], color: '#007aff' },
        11: { name: 'Assigned', next: ['In Progress', 'On Hold', 'Cancelled'], color: '#5856d6' },
        2: { name: 'In Progress', next: ['On Hold', 'Completed', 'Cancelled'], color: '#ff9500' },
        6: { name: 'On Hold', next: ['In Progress', 'Completed', 'Cancelled'], color: '#ffcc00' },
        4: { name: 'Completed', next: [], color: '#34c759' },
        5: { name: 'Cancelled', next: [], color: '#ff3b30' }
    };

    c.getStateInfo = function(stateValue) {
        return c.stateFlow[stateValue] || { name: 'Unknown', next: [], color: '#888' };
    };

    // --- 画面迁移 ---
    c.goToUserView = function() { $window.location.href = '?id=kokoro_user'; };

    // --- 系统时钟 ---
    function updateSystemTime() {
        var now = new Date();
        c.currentTime = ('0' + now.getHours()).slice(-2) + ':' + ('0' + now.getMinutes()).slice(-2) + ':' + ('0' + now.getSeconds()).slice(-2);
    }
    updateSystemTime();
    var timeInterval = $interval(updateSystemTime, 1000);

    // --- 相对时间格式化 ---
    c.formatTime24h = function(createdOn) {
        if (!createdOn) return '--:--';
        try {
            var date = new Date(createdOn);
            if (isNaN(date.getTime())) return '--:--';
            
            var now = new Date();
            var diffMs = now - date;
            var diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            var diffDays = Math.floor(diffHours / 24);
            
            if (diffDays > 0) {
                var h = ('0' + date.getHours()).slice(-2);
                var m = ('0' + date.getMinutes()).slice(-2);
                return diffDays + '日前 ' + h + ':' + m;
            } else if (diffHours > 0) {
                return diffHours + '時間前';
            } else {
                var diffMinutes = Math.floor(diffMs / (1000 * 60));
                return diffMinutes + '分前';
            }
        } catch (e) { return '--:--'; }
    };

    // ==========================================
    // SLA显示格式化
    // ==========================================
    /** * 格式化SLA剩余时间 
     */
    c.formatSLARemaining = function(minutes) {
        if (!minutes && minutes !== 0) return '--';
        minutes = parseInt(minutes) || 0;
        
        if (minutes < 0) {
            var overdue = Math.abs(minutes);
            if (overdue < 60) return '-' + overdue + '分超過';
            return '-' + Math.floor(overdue/60) + '時間超過';
        }
        
        if (minutes < 60) return minutes + '分';
        if (minutes < 1440) return Math.floor(minutes/60) + '時間' + (minutes%60 > 0 ? minutes%60 + '分' : '');
        return Math.floor(minutes/1440) + '日';
    };

    /** * 获取SLA状态样式类 
     */
    c.getSLAClass = function(sla) {
        if (!sla) return '';
        
        if (sla.is_breached || sla.status === 'critical') {
            return 'sla-critical';
        } else if (sla.status === 'warning') {
            return 'sla-warning';
        }
        return 'sla-ok';
    };

    /** * 获取SLA进度条颜色 
     */
    c.getSLABarColor = function(sla) {
        if (!sla) return '#888';
        
        if (sla.is_breached || sla.status === 'critical') {
            return '#ff3b30'; // 红色
        } else if (sla.status === 'warning') {
            return '#ff9500'; // 橙色
        }
        return '#34c759'; // 绿色
    };
    
    // 保留旧的格式化函数以防兼容性问题
    c.formatHours = function(minutes) { return c.formatSLARemaining(minutes); };

    // ==========================================
    // 自动分配与状态
    // ==========================================
    /** * 手动触发自动分配 
     */
    c.triggerAutoAssign = function(sysId, forceReassign) {
        if (!sysId) return;
        
        c.server.get({
            action: 'trigger_auto_assign',
            sys_id: sysId,
            force_reassign: forceReassign || false
        }).then(function(response) {
            if (response.data.success) {
                spUtil.addInfoMessage('自動分配完了: ' + response.data.assigned_to + 
                                     ' (スコア: ' + response.data.score + ')');
                c.server.update().then(processListItems);
            } else {
                spUtil.addErrorMessage('自動分配失敗: ' + (response.data.error || '志願者が見つかりません'));
            }
        });
    };

    /** * 更新志愿者位置 
     */
    c.updateMyLocation = function(zone) {
        if (!zone) return;
        
        c.server.get({
            action: 'update_location',
            zone: zone
        }).then(function(response) {
            if (response.data.success) {
                c.volunteerStatus.currentZone = zone;
                spUtil.addInfoMessage(response.data.message || '位置を更新しました');
            }
        });
    };

    /** * 切换在线/离线状态 
     */
    c.toggleAvailability = function() {
        var newStatus = !c.volunteerStatus.isOnline;
        
        c.server.get({
            action: 'set_availability',
            available: newStatus
        }).then(function(response) {
            if (response.data.success) {
                c.volunteerStatus.isOnline = newStatus;
                spUtil.addInfoMessage(response.data.message);
            }
        });
    };

    function processListItems() {
        if (c.data.list) { angular.forEach(c.data.list, function(item) { item.time_24h = c.formatTime24h(item.created_on); }); }
        if (c.data.myTasks) { angular.forEach(c.data.myTasks, function(item) { item.time_24h = c.formatTime24h(item.created_on); }); }
    }
    processListItems();

    // --- 筛选逻辑 ---
    c.filterByUrgency = function(u) { c.currentFilter = {type:'urgency', value:u}; c.filteredList = c.data.list.filter(function(i){return i.urgency===u;}); };
    c.filterByAssignment = function(s) { c.currentFilter = {type:'assignment', value:s}; c.filteredList = c.data.list.filter(function(i){return s==='unassigned' ? !i.assigned_to_id : !!i.assigned_to_id;}); };
    c.clearFilters = function() { c.currentFilter = null; c.filteredList = null; };

    // --- 实时监听 ---
    spUtil.recordWatch($scope, 'x_1821654_kokoro_0_silent_wish', '', function() {
        c.server.update().then(function() { processListItems(); });
    });
    // 监听库存变化
    spUtil.recordWatch($scope, 'x_1821654_kokoro_0_kokoro_inventory', '', function() {
        c.server.update();
    });

    // --- 辅助函数 ---
    function showSuccess(msg) { spUtil.addInfoMessage(msg); }
    function showError(msg) { spUtil.addErrorMessage(msg || 'エラーが発生しました'); }
    function handleServerResponse(response, successCallback) {
        if (!response || !response.data) { showError('サーバーエラー'); return false; }
        if (response.data.error) { showError(response.data.error); return false; } // 优先显示服务器返回的错误
        if (successCallback) successCallback(response.data);
        return true;
    }

    // --- 模态框逻辑 ---
    c.openModal = function(item) {
        if (!c.data.volunteers || c.data.volunteers.length === 0) {
            c.server.get({ action: 'get_volunteers' }).then(function(r) {
                if (r && r.data && r.data.volunteers) { c.data.volunteers = r.data.volunteers; }
            });
        }

        var modalInstance = $uibModal.open({
            templateUrl: 'volunteerModalTemplate',
            scope: $scope,
            size: 'lg',
            backdrop: 'static',
            windowClass: 'kokoro-modal-window'
        });

        $scope.item = angular.copy(item);
        $scope.c = c;
        $scope.newComment = '';
        $scope.statusMenuOpen = false;

        $scope.toggleStatusMenu = function($event) { if ($event) $event.stopPropagation(); $scope.statusMenuOpen = !$scope.statusMenuOpen; };
        $window.onclick = function() { if ($scope.statusMenuOpen) $timeout(function() { $scope.statusMenuOpen = false; }); };
        $scope.cancel = function() { modalInstance.dismiss('cancel'); };

        // 按钮: 分配
        $scope.assignToMe = function(item) {
            c.server.get({ action: 'assign_to_me', sys_id: item.sys_id }).then(function(r) {
                handleServerResponse(r, function() {
                    item.assigned_to_id = c.data.user_id; item.assigned_to_name = c.data.user_name;
                    $scope.item.assigned_to_id = c.data.user_id; $scope.item.assigned_to_name = c.data.user_name;
                    if (item.state == 1 || item.state == 10) { item.state = 11; $scope.item.state = 11; }
                    showSuccess('担当者に設定しました');
                    c.server.update().then(processListItems);
                });
            });
        };

        // 按钮: 状态
        $scope.changeStatus = function(item, newState) {
            var ns = parseInt(newState);
            if (ns === 11 && !item.assigned_to_id) { $scope.assignToMe(item); return; }
            if (ns === 2 && !item.assigned_to_id) { showError('先に担当者を設定してください'); return; }
            
            c.server.get({ action: 'change_status', sys_id: item.sys_id, new_state: newState }).then(function(r) {
                // handleServerResponse 会自动处理库存不足等错误信息
                if (handleServerResponse(r, function() {
                    item.state = ns; $scope.item.state = ns; $scope.statusMenuOpen = false;
                    showSuccess('ステータスを更新しました');
                    c.server.update().then(processListItems);
                    if (ns === 4 || ns === 5) { $timeout(function() { modalInstance.close(); }, 1000); }
                }));
            });
        };

        // 按钮: 评论
        $scope.postComment = function(item) {
            if (!$scope.newComment || !$scope.newComment.trim()) return;
            c.server.get({ action: 'add_comment', sys_id: item.sys_id, message: $scope.newComment }).then(function(r) {
                handleServerResponse(r, function() {
                    if (!item.history) item.history = [];
                    item.history.unshift({ user: c.data.user_name || 'Me', text: $scope.newComment, date: new Date().toLocaleString() });
                    $scope.item.history = item.history; $scope.newComment = '';
                    showSuccess('コメントを追加しました');
                });
            });
        };
        
        // 按钮: 自动分配 (模态框内)
        $scope.triggerAutoAssign = function(item) {
             c.triggerAutoAssign(item.sys_id, true);
        };

        modalInstance.result.finally(function() { c.server.update().then(processListItems); });
    };

    // --- Dashboard 直接操作 ---
    c.updateStatus = function(sys_id, action) {
        if (!sys_id || !action) return;
        c.server.get({ action: action, sys_id: sys_id }).then(function(r) {
            handleServerResponse(r, function() {
                showSuccess('ステータス更新しました');
                c.server.update().then(processListItems);
            });
        });
    };

    // ==========================================
    // 更新SLA显示的定时器 (增强版)
    // ==========================================
    // 每30秒更新SLA显示
    var slaUpdateInterval = $interval(function() {
        angular.forEach(c.data.list, function(item) {
            if (!item.sla) return;
            
            // 增加已用时间 (30秒 = 0.5分钟)
            item.sla.elapsed = (item.sla.elapsed || 0) + 0.5;
            item.sla.remaining = Math.max(0, item.sla.target - item.sla.elapsed);
            item.sla.percentage = Math.min(100, Math.round((item.sla.elapsed / item.sla.target) * 100));
            
            // 更新状态
            if (item.sla.elapsed > item.sla.target) {
                item.sla.status = 'critical';
                item.sla.is_breached = true;
            } else if (item.sla.percentage >= 80) {
                item.sla.status = 'warning';
            }
        });
    }, 30000);

    // 资源清理
    $scope.$on('$destroy', function() {
        if (timeInterval) $interval.cancel(timeInterval);
        if (slaUpdateInterval) $interval.cancel(slaUpdateInterval);
        if (sniperInterval) $interval.cancel(sniperInterval);
    });
};]]></client_script>
        <controller_as>c</controller_as>
        <css>&lt;style&gt;
/* ============================================================
   KOKORO DASHBOARD CSS v12.0 BUGFIX (完整修复版)
   修复: Modal卡死 + 配色统一黑白灰 + 文字可见性
   ============================================================ */

/* 1. 基础隐藏 - 保持原有逻辑 */
nav, header, footer, .sp-page-header, .navbar, .polaris-header, 
.sn-polaris-nav, .sn-canvas-header, #sp-nav-bar, .sp-row-background,
.cms-header, .navpage-header, .sn-chat-overlay, .help-button-wrapper, 
.sp-ac-root, .sw-session-repro-button, button.help-button, 
.sn-connect-floating-wrapper, #u_chat_button, .cm-help-button, 
.sp-page-row-options, .theme-picker, .sp-debug-tool, .u_p_floating_container,
div[ng-controller="spPageRowOptions"], a[title="Toggle Layout"], .btn-floating, 
.sp-icon-edit, .guided-tour-overlay, .code-editor-container, 
.icon-palette, .fa-cog, .sp-icon-color, .sp-preview-pill {
  display: none !important; opacity: 0 !important; pointer-events: none !important;
  z-index: -9999 !important; width: 0 !important; height: 0 !important;
}

/* 位置打击 */
body &gt; div[style*="bottom"], body &gt; button[style*="bottom"] {
    display: none !important; opacity: 0 !important; pointer-events: none !important;
}

/* 2. 基础布局 */
html, body {
  height: 100% !important; width: 100% !important;
  overflow: hidden !important; position: fixed !important;
  background: #f5f5f5 !important; margin: 0 !important; padding: 0 !important;
}

/* ============================================================
   [CRITICAL FIX] MODAL Z-INDEX - 修复卡死的关键
   ============================================================ */
.modal { 
  z-index: 999999 !important;
  position: fixed !important;
  display: block !important;
}
.modal-backdrop { 
  z-index: 999998 !important;
  background-color: rgba(0,0,0,0.85) !important;
  backdrop-filter: blur(3px) !important;
}
.modal-dialog { 
  z-index: 1000000 !important;
  position: relative !important;
  margin: 50px auto !important;
  max-width: 900px !important;
  width: 90% !important;
}
.modal-content {
  background: #fff !important;
  border: 1px solid #e0e0e0 !important;
  border-radius: 0 !important;
  box-shadow: 0 25px 50px rgba(0,0,0,0.4) !important;
  color: #333 !important;
  font-family: "Rajdhani", sans-serif !important;
  overflow: visible !important;
  z-index: 1000001 !important;
}

/* Modal 内部样式 - 极简黑白 */
.modal-header-clean { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  padding: 18px 25px; 
  background: #fafafa; 
  border-bottom: 1px solid #e0e0e0; 
}
.header-badge { 
  background: #000; 
  color: #fff; 
  padding: 4px 12px; 
  font-weight: 700; 
  font-size: 0.75rem; 
  margin-right: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.header-id { 
  font-family: "JetBrains Mono", monospace; 
  font-weight: 700; 
  font-size: 1rem; 
  color: #333;
}
.header-close { 
  background: #fff; 
  border: 1px solid #ccc; 
  width: 32px; 
  height: 32px; 
  cursor: pointer; 
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.header-close:hover { 
  background: #000; 
  color: #fff; 
  border-color: #000; 
}

.modal-body-grid { 
  display: grid; 
  grid-template-columns: 1fr 320px; 
  min-height: 500px;
  max-height: 70vh;
  overflow: hidden;
}
.body-main { 
  padding: 25px; 
  border-right: 1px solid #f0f0f0;
  overflow-y: auto;
  max-height: 70vh;
}
.body-sidebar { 
  background: #fafafa; 
  padding: 25px;
  overflow-y: auto;
  max-height: 70vh;
}

.ticket-title { 
  font-family: "Rajdhani", sans-serif; 
  font-size: 1.4rem; 
  font-weight: 700; 
  margin: 0 0 20px 0; 
  border-bottom: 1px solid #f0f0f0; 
  padding-bottom: 15px;
  color: #1a1a1a;
}
.qty-badge-black { 
  background: #000; 
  color: #fff; 
  padding: 3px 10px; 
  font-size: 0.75rem; 
  margin-left: 10px;
  border-radius: 2px;
}

.action-bar { 
  display: flex; 
  gap: 10px; 
  margin-bottom: 20px; 
  flex-wrap: wrap; 
}
.btn-purple-outline, .btn-normal, .action-btn { 
  border: 1px solid #ccc; 
  background: #fff; 
  padding: 8px 16px; 
  font-weight: 700; 
  cursor: pointer; 
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
  transition: 0.2s;
}
.btn-purple-outline:hover, .btn-normal:hover { 
  background: #000; 
  color: #fff; 
  border-color: #000;
}
.action-btn { 
  background: #000 !important; 
  color: #fff !important; 
  border-color: #000 !important;
}
.action-btn:hover { 
  background: #333 !important; 
}

.desc-box { 
  background: #fafafa; 
  border: 1px solid #e0e0e0; 
  padding: 20px; 
  margin-bottom: 20px;
  border-left: 3px solid #000;
}
.desc-section-title { 
  font-size: 0.75rem; 
  color: #666; 
  margin-bottom: 12px; 
  font-weight: 700; 
  letter-spacing: 1px;
  text-transform: uppercase;
}
.desc-grid { 
  display: grid; 
  gap: 12px; 
}
.desc-item { 
  display: flex; 
  gap: 10px; 
  align-items: flex-start; 
  font-size: 0.85rem; 
}
.desc-icon { 
  width: 24px; 
  text-align: center; 
  color: #666; 
}
.desc-label { 
  font-weight: 700; 
  color: #333; 
  margin-right: 6px; 
}

.activity-area { 
  margin-top: 20px; 
}
.note-input { 
  width: 100%; 
  border: 1px solid #d0d0d0; 
  padding: 12px; 
  min-height: 80px; 
  margin-bottom: 10px;
  font-family: "Rajdhani", sans-serif;
  font-size: 0.9rem;
  resize: vertical;
}
.submit-btn { 
  background: #ccc; 
  color: #fff; 
  border: none; 
  padding: 8px 18px; 
  font-weight: 700; 
  cursor: not-allowed; 
  float: right;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
}
.submit-btn.ready { 
  background: #000; 
  cursor: pointer; 
}
.submit-btn.ready:hover {
  background: #333;
}

.sidebar-block { 
  margin-bottom: 20px; 
  padding-bottom: 15px; 
  border-bottom: 1px solid #e8e8e8; 
}
.sb-label { 
  font-size: 0.7rem; 
  color: #999; 
  margin-bottom: 8px; 
  font-weight: 700; 
  letter-spacing: 1px;
  text-transform: uppercase;
}
.user-row { 
  display: flex; 
  align-items: center; 
  gap: 10px; 
}
.avatar-box { 
  width: 32px; 
  height: 32px; 
  background: #000; 
  color: #fff; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-weight: 700;
  font-size: 0.9rem;
}
.avatar-box.orange { 
  background: #ff9500; 
}
.user-name-text {
  font-size: 0.85rem;
  font-weight: 600;
  color: #333;
}

.state-indicator {
  padding: 6px 14px; 
  border-radius: 2px; 
  color: #fff; 
  font-weight: 700;
  text-transform: uppercase; 
  font-size: 0.75rem; 
  display: inline-block;
  background: #666;
  letter-spacing: 1px;
}

.priority-btn {
  background: #f0f0f0;
  color: #333;
  padding: 6px 12px;
  font-weight: 700;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.ai-card { 
  background: #fafafa; 
  border: 1px solid #e0e0e0; 
  padding: 15px; 
  margin-bottom: 20px;
  border-left: 3px solid #666;
}
.ai-head { 
  color: #333; 
  font-weight: 700; 
  font-size: 0.75rem; 
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.ai-text { 
  font-size: 0.8rem; 
  color: #666;
  line-height: 1.5;
}

.sla-progress {
  height: 6px;
  background: #f0f0f0;
  overflow: hidden;
  margin-bottom: 8px;
}
.sla-fill {
  height: 100%;
  background: #000;
  transition: width 0.3s;
}
.sla-text {
  font-size: 0.7rem;
  color: #666;
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-family: "JetBrains Mono", monospace;
}
.sla-badge {
  background: #f0f0f0;
  color: #666;
  padding: 4px 10px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.sla-badge.sla-critical {
  background: #ffebee;
  color: #ff4444;
}

.dropdown-wrapper { 
  position: relative; 
  display: inline-block; 
}
.status-menu { 
  position: absolute; 
  top: 100%; 
  left: 0; 
  background: #fff; 
  border: 1px solid #d0d0d0; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
  z-index: 10; 
  min-width: 180px;
}
.status-item { 
  padding: 10px 16px; 
  cursor: pointer; 
  font-size: 0.8rem; 
  border-bottom: 1px solid #f0f0f0;
  transition: 0.15s;
  font-weight: 600;
}
.status-item:hover { 
  background: #fafafa; 
}
.status-item.danger { 
  color: #ff4444; 
}

/* ============================================================
   主容器 - 极简黑白配色
   ============================================================ */
.kokoro-volunteer-container {
  font-family: "Rajdhani", "JetBrains Mono", sans-serif;
  position: fixed !important; 
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 100 !important; 
  background: #f5f5f5;
  color: #1a1a1a;
  overflow-y: auto;
  padding-bottom: 60px;
}

/* 警报横幅 - 保持红色用于紧急 */
.safety-banner {
  background: #ff4444;
  color: #fff; 
  padding: 10px 40px; 
  font-weight: 700;
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  font-size: 0.85rem;
  border-bottom: 2px solid rgba(255,255,255,0.2);
}
.safety-banner button {
  background: rgba(0,0,0,0.3); 
  border: 1px solid rgba(255,255,255,0.5);
  color: #fff; 
  padding: 5px 15px; 
  font-weight: 700;
  cursor: pointer; 
  transition: 0.2s;
  text-transform: uppercase;
  font-size: 0.7rem;
  letter-spacing: 0.5px;
}
.safety-banner button:hover { 
  background: #fff; 
  color: #ff4444 !important;
}

/* 头部 - 纯黑配色 */
.command-header {
  background: #000;
  border-bottom: 1px solid #333;
  padding: 15px 40px;
  display: flex; 
  align-items: center; 
  justify-content: space-between;
  position: sticky; 
  top: 0; 
  z-index: 50;
}
.command-logo { 
  display: flex; 
  align-items: center; 
  gap: 15px; 
}
.logo-icon {
  width: 48px; 
  height: 48px; 
  background: #fff;
  color: #000;
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-weight: 900; 
  font-size: 1.8rem;
  border-radius: 2px;
}
.logo-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.logo-title { 
  font-family: "Orbitron", monospace; 
  font-size: 1.5rem; 
  font-weight: 700; 
  color: #fff;
  letter-spacing: 2px;
}
.logo-subtitle { 
  font-size: 0.7rem; 
  color: #999; 
  letter-spacing: 3px; 
  text-transform: uppercase;
}
.system-status { 
  display: flex; 
  align-items: center; 
  gap: 15px; 
  font-family: "JetBrains Mono", monospace; 
  font-size: 0.75rem; 
  color: #999; 
}
.status-indicator { 
  display: flex; 
  align-items: center; 
  gap: 6px; 
}
.status-dot { 
  width: 8px; 
  height: 8px; 
  background: #4caf50; 
  border-radius: 50%; 
}
.version-tag {
  color: #666;
}
.system-time {
  color: #999;
}

/* 导航栏 - 极简 */
.nav-tabs-custom {
  margin: 0;
  background: #fff;
  display: flex; 
  gap: 0; 
  border: none;
  border-bottom: 1px solid #e0e0e0;
}
.nav-tabs-custom .tab {
  padding: 15px 30px; 
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  color: #666; 
  font-weight: 700; 
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.85rem;
  letter-spacing: 1px;
  text-transform: uppercase;
}
.nav-tabs-custom .tab:hover { 
  background: #fafafa;
  color: #1a1a1a;
}
.nav-tabs-custom .tab.active {
  background: transparent;
  color: #000;
  border-bottom-color: #000;
}
.tab-number {
  font-family: "Orbitron", monospace;
  font-weight: 700;
  color: #ccc;
}
.tab.active .tab-number {
  color: #000;
}

.scan-line-header {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 8px 40px;
  background: #fafafa;
  border-bottom: 1px solid #e0e0e0;
}
.scan-line {
  flex: 1;
  height: 1px;
  background: #e0e0e0;
}
.scan-label {
  font-size: 0.7rem;
  color: #999;
  font-weight: 700;
  letter-spacing: 2px;
  font-family: "Orbitron", monospace;
}

.board-container { 
  padding: 30px 40px; 
  max-width: 1920px; 
  margin: 0 auto; 
}

/* 志愿者状态面板 - 极简 */
.volunteer-status-panel {
  background: #fff; 
  border: 1px solid #e0e0e0; 
  border-left: 3px solid #000;
  padding: 18px 30px; 
  margin-bottom: 30px;
  display: flex; 
  align-items: center; 
  gap: 35px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.status-row { 
  display: flex; 
  align-items: center; 
  gap: 12px; 
  font-weight: 700; 
  color: #333;
  font-size: 0.85rem;
}
.btn-online { 
  background: #000; 
  color: #fff; 
  border: none; 
  padding: 6px 18px; 
  border-radius: 2px; 
  font-weight: 700; 
  cursor: pointer; 
  transition: all 0.2s;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
}
.btn-online:hover {
  background: #333;
}
.btn-offline { 
  background: #e0e0e0; 
  color: #999; 
  border: none; 
  padding: 6px 18px; 
  border-radius: 2px; 
  cursor: not-allowed;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
}
.status-row select { 
  padding: 6px 12px; 
  border: 1px solid #ccc; 
  border-radius: 2px; 
  font-family: "JetBrains Mono", monospace;
  font-weight: 600;
  font-size: 0.8rem;
  background: #fff;
  cursor: pointer;
}

/* 统计卡片 - 极简 */
.stats-section { 
  background: transparent; 
  border: none; 
  margin-bottom: 30px;
}
.section-header {
  background: transparent; 
  border-bottom: 1px solid #e0e0e0;
  padding: 10px 0; 
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-tag { 
  background: #000; 
  color: #fff; 
  font-family: "Orbitron", monospace; 
  padding: 3px 10px;
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 1px;
  border-radius: 2px;
}
.section-title { 
  font-family: "Rajdhani", sans-serif; 
  font-weight: 800; 
  letter-spacing: 2px; 
  font-size: 1.1rem;
  color: #1a1a1a;
  text-transform: uppercase;
}
.section-time {
  margin-left: auto;
  font-size: 0.75rem;
  color: #999;
  font-family: "JetBrains Mono", monospace;
}

.stats-row { 
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.stat-card {
  background: #fff; 
  padding: 20px;
  position: relative; 
  transition: all 0.2s;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  flex: 1;
  min-width: 180px;
}
.stat-card.clickable {
  cursor: pointer;
}
.stat-card::before {
  content: ''; 
  position: absolute; 
  left: 0; 
  top: 0; 
  width: 3px; 
  height: 100%;
  background: #e0e0e0; 
  transition: 0.2s;
}
.stat-card:hover { 
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  transform: translateY(-2px);
}
.stat-card:hover::before { 
  background: #000;
}

.stat-label { 
  font-family: "Rajdhani", sans-serif; 
  font-weight: 700; 
  color: #666; 
  letter-spacing: 1px; 
  display: flex; 
  justify-content: space-between; 
  font-size: 0.8rem;
  margin-bottom: 5px;
  text-transform: uppercase;
}
.stat-code { 
  font-family: "Orbitron", monospace; 
  font-weight: 700;
  color: #1a1a1a;
}
.stat-suffix {
  color: #999;
  font-size: 0.7rem;
}

.stat-num {
  font-family: "Orbitron", monospace; 
  font-size: 2.5rem; 
  font-weight: 700;
  color: #1a1a1a; 
  margin: 8px 0;
  line-height: 1;
}

.stat-name {
  font-size: 0.75rem;
  color: #999;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-bottom: 10px;
}

.stat-footer { 
  display: flex; 
  justify-content: space-between; 
  border-top: 1px solid #f0f0f0; 
  padding-top: 10px; 
  margin-top: 10px; 
  align-items: center;
}
.stat-change { 
  font-family: "JetBrains Mono", monospace; 
  font-weight: 600; 
  font-size: 0.75rem;
  color: #666;
}
.stat-change.negative {
  color: #ff4444;
}
.stat-change.positive {
  color: #4caf50;
}
.stat-status { 
  font-size: 0.65rem; 
  padding: 3px 8px; 
  border-radius: 2px; 
  font-weight: 700; 
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.stat-status.nominal { 
  background: #f5f5f5; 
  color: #666; 
}
.stat-status.warning { 
  background: #fff3e0; 
  color: #f57c00; 
}
.stat-status.critical { 
  background: #ffebee; 
  color: #ff4444; 
}

/* 两列布局 */
.two-column-layout { 
  display: grid; 
  grid-template-columns: 1fr 420px; 
  gap: 30px; 
  margin-top: 30px; 
}

/* 警报列表 - 极简表格 */
.alert-section { 
  background: #fff; 
  padding: 0; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
  overflow: hidden;
  border: 1px solid #e0e0e0;
}
.alert-section .section-header {
  padding: 15px 25px;
  margin: 0;
  border-bottom: 1px solid #e0e0e0;
}
.alert-list { 
  padding: 0; 
  max-height: 600px; 
  overflow-y: auto; 
}

.alert-item {
  display: grid; 
  grid-template-columns: 100px 70px 60px 60px auto 30px; 
  gap: 12px;
  padding: 12px 25px; 
  border-bottom: 1px solid #f5f5f5;
  transition: all 0.15s; 
  cursor: pointer; 
  align-items: center;
  position: relative;
}
.alert-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 3px;
  background: transparent;
  transition: 0.15s;
}
.alert-item:hover { 
  background: #fafafa;
}
.alert-item:hover::before {
  background: #000;
}

.alert-id { 
  font-family: "JetBrains Mono", monospace; 
  font-weight: 600; 
  color: #666; 
  font-size: 0.75rem;
}

.alert-priority { 
  font-family: "Orbitron", monospace; 
  font-size: 0.65rem; 
  padding: 3px 6px; 
  font-weight: 700; 
  background: #f0f0f0; 
  color: #666; 
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.alert-priority.p-critical { 
  background: #ff4444;
  color: #fff; 
}
.alert-priority.p-high { 
  background: #333;
  color: #fff; 
}
.alert-priority.p-medium {
  background: #999;
  color: #fff;
}

.alert-zone {
  font-size: 0.75rem;
  color: #999;
  font-weight: 600;
}

.alert-time {
  font-family: "JetBrains Mono", monospace;
  font-size: 0.7rem;
  color: #999;
}

.alert-content { 
  font-weight: 600; 
  color: #333; 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis;
  font-size: 0.85rem;
}

.alert-arrow {
  color: #ccc;
  font-weight: 700;
}

.empty-board {
  padding: 60px 20px;
  text-align: center;
  color: #999;
}
.empty-board i {
  font-size: 3rem;
  margin-bottom: 15px;
  color: #ccc;
}
.empty-board h4 {
  margin: 10px 0;
  color: #666;
  font-weight: 700;
  letter-spacing: 1px;
}
.empty-board p {
  color: #999;
  font-size: 0.85rem;
}

/* 右侧面板 - 极简 */
.side-panel-wrapper {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.side-panel-enhanced { 
  background: #fff; 
  padding: 20px; 
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.data-stream-widget {
  margin-bottom: 15px;
}

.widget-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 15px; 
  padding-bottom: 10px; 
  border-bottom: 1px solid #f0f0f0; 
}

.widget-title { 
  font-family: "Rajdhani", sans-serif; 
  font-weight: 700; 
  font-size: 0.85rem; 
  letter-spacing: 1px; 
  color: #1a1a1a;
  text-transform: uppercase;
}

.live-indicator { 
  background: #4caf50; 
  width: 6px; 
  height: 6px; 
  border-radius: 50%; 
  animation: blink 2s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.live-metric-card {
  background: #fafafa;
  padding: 12px;
  border-left: 3px solid #000;
  margin-bottom: 10px;
  transition: 0.2s;
}
.live-metric-card:hover { 
  background: #fff;
}

.metric-row { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 6px; 
}

.metric-label { 
  font-weight: 600; 
  font-size: 0.75rem; 
  color: #666;
}

.metric-value { 
  font-family: "Orbitron", monospace; 
  font-weight: 700; 
  font-size: 1.3rem; 
  color: #1a1a1a;
}

.metric-mini-bar { 
  height: 3px; 
  background: #e8e8e8; 
  overflow: hidden; 
  margin-top: 6px;
}

.metric-mini-fill { 
  height: 100%; 
  background: #000;
  transition: width 0.5s ease;
}

.ai-insight-card {
  background: #fafafa;
  border: 1px solid #e0e0e0;
  padding: 15px;
  border-left: 3px solid #666;
}

.ai-header { 
  font-weight: 700; 
  font-size: 0.75rem;
  color: #333;
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.ai-content { 
  font-size: 0.8rem; 
  line-height: 1.6; 
  color: #666;
}

.ai-tags { 
  display: flex; 
  gap: 6px; 
  margin-top: 10px; 
  flex-wrap: wrap;
}

.ai-tag { 
  background: #e0e0e0; 
  color: #666; 
  padding: 3px 8px; 
  font-size: 0.65rem; 
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* 资源状态 - 极简 */
.resource-section-enhanced {
  background: #fff;
  padding: 20px;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.resource-section-enhanced .section-header {
  padding: 0 0 15px 0;
  margin-bottom: 20px;
}

.resource-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 0.8rem;
}
.resource-header .label {
  display: flex;
  align-items: center;
  gap: 5px;
  color: #333;
}
.resource-header .code {
  font-family: "JetBrains Mono", monospace;
  color: #999;
  font-size: 0.7rem;
}

.resource-bar {
  height: 8px;
  background: #f0f0f0;
  overflow: hidden;
  margin-bottom: 15px;
}

.resource-fill {
  height: 100%;
  background: #000;
  transition: width 0.3s;
}

/* 移除彩色 */
.resource-fill.low,
.resource-fill.medium,
.resource-fill.high {
  background: #000 !important;
}

/* 卡片网格 */
.card-section {
  margin-top: 30px;
}

.card-grid, .task-grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
  gap: 20px; 
}

.jira-card {
  background: #fff; 
  padding: 20px;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  transition: all 0.2s;
  position: relative;
  cursor: pointer;
}
.jira-card::before { 
  content: ''; 
  position: absolute; 
  left: 0; 
  top: 0; 
  width: 3px; 
  height: 100%; 
  background: #e0e0e0;
  transition: 0.2s; 
}
.jira-card:hover { 
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}
.jira-card:hover::before {
  background: #000;
}
.jira-card.priority-Critical::before { 
  background: #ff4444;
}

.card-top { 
  display: flex; 
  justify-content: space-between; 
  margin-bottom: 12px; 
  align-items: flex-start;
}
.card-id { 
  font-family: "JetBrains Mono", monospace; 
  color: #666; 
  font-weight: 600;
  font-size: 0.75rem;
}
.status-tag {
  font-weight: 700; 
  font-size: 0.65rem; 
  padding: 3px 8px;
  background: #f0f0f0; 
  color: #666; 
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-radius: 2px;
}

.card-title {
  font-size: 1rem;
  font-weight: 700;
  color: #1a1a1a;
  margin-bottom: 10px;
  line-height: 1.3;
}
.qty-badge {
  background: #000;
  color: #fff;
  padding: 2px 8px;
  font-size: 0.7rem;
  margin-left: 8px;
  border-radius: 2px;
}

.card-main {
  margin-bottom: 15px;
}

.card-loc {
  font-size: 0.8rem;
  color: #666;
  margin-bottom: 8px;
}

.card-detail {
  font-size: 0.8rem;
  color: #999;
  line-height: 1.4;
}

.card-sla { 
  margin: 12px 0; 
  padding-top: 10px; 
  border-top: 1px dashed #e0e0e0; 
}
.sla-bar-container { 
  height: 4px; 
  background: #f0f0f0; 
  overflow: hidden; 
  margin-bottom: 5px;
}
.sla-bar { 
  height: 100%; 
  background: #000;
  transition: width 0.3s;
}
.sla-info { 
  display: flex; 
  justify-content: space-between; 
  font-size: 0.65rem; 
  font-family: "JetBrains Mono", monospace; 
  color: #999;
  font-weight: 600;
}
.sla-info.sla-critical {
  color: #ff4444;
}
.sla-info.sla-warning {
  color: #f57c00;
}

.metal-divider {
  height: 1px;
  background: #e0e0e0;
  margin: 15px 0;
}

.card-footer { 
  font-size: 0.75rem;
}

.priority-badge {
  background: #f0f0f0;
  color: #666;
  padding: 3px 8px;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.65rem;
  letter-spacing: 0.5px;
  border-radius: 2px;
}
.priority-badge.priority-Critical {
  background: #ff4444;
  color: #fff;
}

.btn-jira {
  border: 1px solid #ccc; 
  background: #fff; 
  padding: 8px 15px;
  font-weight: 700; 
  text-transform: uppercase;
  cursor: pointer; 
  color: #333;
  font-size: 0.7rem;
  letter-spacing: 0.5px;
  transition: 0.2s;
  width: 100%;
  margin-top: 10px;
}
.btn-jira:hover { 
  background: #000; 
  color: #fff; 
  border-color: #000;
}
.btn-jira.progress { 
  border-color: #666; 
  color: #666; 
}
.btn-jira.progress:hover { 
  background: #666; 
  color: #fff;
}
.btn-jira.success { 
  border-color: #4caf50; 
  color: #4caf50; 
}
.btn-jira.success:hover { 
  background: #4caf50; 
  color: #fff;
}

.completed-msg {
  text-align: center;
  padding: 10px;
  background: #f5f5f5;
  color: #666;
  font-weight: 600;
  font-size: 0.75rem;
  cursor: pointer;
  margin-top: 10px;
}

/* 响应式 */
@media (max-width: 1200px) { 
  .two-column-layout { 
    grid-template-columns: 1fr; 
  }
  .modal-body-grid { 
    grid-template-columns: 1fr; 
  } 
  .body-sidebar { 
    border-top: 1px solid #f0f0f0;
    border-right: none;
  } 
}

@media (max-width: 768px) { 
  .volunteer-status-panel { 
    flex-direction: column; 
    align-items: flex-start; 
    gap: 12px; 
  }
  .stats-row {
    flex-direction: column;
  }
  .stat-card {
    min-width: auto;
  }
  .alert-item { 
    grid-template-columns: auto 1fr auto; 
  } 
  .alert-zone, .alert-time { 
    display: none; 
  }
  .command-header { 
    padding: 15px 20px; 
  }
  .board-container { 
    padding: 20px; 
  }
}

/* 滚动条美化 */
.alert-list::-webkit-scrollbar,
.kokoro-volunteer-container::-webkit-scrollbar,
.body-main::-webkit-scrollbar,
.body-sidebar::-webkit-scrollbar {
  width: 6px;
}

.alert-list::-webkit-scrollbar-track,
.kokoro-volunteer-container::-webkit-scrollbar-track,
.body-main::-webkit-scrollbar-track,
.body-sidebar::-webkit-scrollbar-track {
  background: #f5f5f5;
}

.alert-list::-webkit-scrollbar-thumb,
.kokoro-volunteer-container::-webkit-scrollbar-thumb,
.body-main::-webkit-scrollbar-thumb,
.body-sidebar::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 3px;
}

.alert-list::-webkit-scrollbar-thumb:hover,
.kokoro-volunteer-container::-webkit-scrollbar-thumb:hover,
.body-main::-webkit-scrollbar-thumb:hover,
.body-sidebar::-webkit-scrollbar-thumb:hover {
  background: #999;
}

/* 确保所有交互元素可点击 */
button, .btn-jira, .btn-online, .btn-offline, .tab, .alert-item, .jira-card {
  pointer-events: auto !important;
  cursor: pointer !important;
}

/* 文本选择 */
.clickable {
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}
&lt;/style&gt;</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>kokoro_volunteer</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Kokoro Volunteer Dashboard</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    // ==========================================
    // 0. 初始化变量与数组
    // ==========================================
    data.myTasks = [];
    data.list = [];
    data.user_id = gs.getUserID();
    data.user_name = gs.getUserDisplayName();
    
    // 定义 isVolunteer 变量
    var isVolunteer = gs.hasRole('x_1821654_kokoro_0.volunteer') || gs.hasRole('admin');
    data.isVolunteer = isVolunteer;

    // ==========================================
    // 1. 扩展配置信息 (Enterprise Tables)
    // ==========================================
    var CONFIG = {
        tables: {
            SILENT_WISH: 'x_1821654_kokoro_0_silent_wish',
            INVENTORY: 'x_1821654_kokoro_0_kokoro_inventory',
            INVENTORY_TX: 'x_1821654_kokoro_0_kokoro_inventory_transact', // 修正: 对应截图中的表名 _transact
            PROCESS_EVENT: 'x_1821654_kokoro_0_process_event',
            USER_PROFILE: 'x_1821654_kokoro_0_user_profile', 
            EMERGENCY_MESSAGE: 'x_1821654_kokoro_0_emergency_message', 
            HEARTBEAT: 'x_1821654_kokoro_0_heartbeat' 
        },
        wishStates: {
            SUBMITTED: '1',    // New
            IN_PROGRESS: '2',  // Work in Progress
            COMPLETED: '4',    // Closed Complete
            CANCELLED: '7'     // Cancelled
        },
        resourceKeys: ['food', 'water', 'medical', 'clothing', 'hygiene'],
        thresholds: {
            CRITICAL: 15, 
            WARNING: 35   
        }
    };

    // ==========================================
    // 2. 核心监察函数: 获取资源状态
    // ==========================================
    data.resourceStatus = [];
    function getResourceStatus() {
        var status = [];
        var grInv = new GlideRecord(CONFIG.tables.INVENTORY);
        grInv.addActiveQuery();
        grInv.query();

        while (grInv.next()) {
            var current = parseFloat(grInv.getValue('current_quantity')) || 0;
            var max = parseFloat(grInv.getValue('max_capacity')) || 100;
            var percentage = Math.round((current / max) * 100);

            status.push({
                label: grInv.getDisplayValue('item_name'), // 修正: 去除 u_
                code: grInv.getValue('item_code'),      // 修正: 去除 u_
                percent: percentage,
                status_color: percentage < CONFIG.thresholds.CRITICAL ? 'danger' : 
                             (percentage < CONFIG.thresholds.WARNING ? 'warning' : 'success')
            });
        }
        return status;
    }
    data.resourceStatus = getResourceStatus();

    // ==========================================
    // 3. 企业级库存扣减逻辑 (事务性处理)
    // ==========================================
    function updateInventory(itemCode, quantity, wishId) {
        var grInv = new GlideRecord(CONFIG.tables.INVENTORY);
        grInv.addQuery('item_code', itemCode); // 修正: 去除 u_
        grInv.query();

        if (grInv.next()) {
            var oldQty = parseFloat(grInv.getValue('current_quantity'));
            var newQty = oldQty - quantity;

            if (newQty < 0) return { success: false, message: '在庫不足' };

            // 1. 更新主表
            grInv.setValue('current_quantity', newQty);
            grInv.update();

            // 2. 插入交易表 (Audit Trail)
            var grTx = new GlideRecord(CONFIG.tables.INVENTORY_TX);
            grTx.initialize();
            grTx.setValue('inventory_item', grInv.getUniqueValue()); // 修正: 去除 u_
            grTx.setValue('type', 'disbursement'); // 修正: 去除 u_
            grTx.setValue('quantity', quantity);   // 修正: 去除 u_
            grTx.setValue('related_wish', wishId); // 修正: 字段名为 related_wish
            grTx.insert();

            // 3. 记录流程事件
            logProcessEvent(wishId, 'Inventory Decr: ' + itemCode + ' (' + quantity + ')', gs.getUserID());
            return { success: true };
        }
        return { success: false, message: '物品コードが見つかりません' };
    }

    // ==========================================
    // 4. 输入处理: 当 Wish 状态变为 "In Progress" 时尝试锁定/扣减库存
    // ==========================================
    if (input && input.action === 'change_status' && input.new_state === '2') {
        var wishGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
        if (wishGr.get(input.sys_id)) {
            var category = wishGr.getValue('u_category'); 
            var qty = parseInt(wishGr.getValue('u_quantity')) || 1;
            
            if (category) {
                var invResult = updateInventory(category.toUpperCase(), qty, input.sys_id);
                if (!invResult.success) {
                    data.error = "在庫チェック失敗: " + invResult.message;
                    return;
                }
            }
        }
    }

    // === SLA统计 ===
    data.slaStats = {
        breached: 0,
        atRisk: 0,
        ok: 0
    };
    try {
        if (typeof x_1821654_kokoro_0.KokoroSLAEngine !== 'undefined') {
            var slaEngine = new x_1821654_kokoro_0.KokoroSLAEngine();
            
            var breachedWishes = slaEngine.getBreachedWishes();
            data.slaStats.breached = breachedWishes.length;
            
            var atRiskWishes = slaEngine.getAtRiskWishes(80);
            data.slaStats.atRisk = atRiskWishes.length;
        }
        
        var gaSLA = new GlideAggregate('x_1821654_kokoro_0_sla_task');
        gaSLA.addQuery('status', 'in_progress');
        gaSLA.addQuery('percentage', '<', 80);
        gaSLA.addAggregate('COUNT');
        gaSLA.query();
        if (gaSLA.next()) {
            data.slaStats.ok = parseInt(gaSLA.getAggregate('COUNT')) || 0;
        }
    } catch (e) {
        gs.debug('[Kokoro] SLA stats not available: ' + e.message);
    }

    // ==========================================
    // 工具函数
    // ==========================================
    function sanitizeInput(inputVal, maxLength) {
        if (!inputVal) return '';
        var cleaned = String(inputVal)
            .replace(/[<>\"'&]/g, '')
            .replace(/[\r\n]+/g, ' ')
            .trim();
        if (maxLength && cleaned.length > maxLength) {
            cleaned = cleaned.substring(0, maxLength);
        }
        return cleaned;
    }

    function validateSysId(sysId) {
        if (!sysId) return false;
        return /^[a-f0-9]{32}$/.test(String(sysId));
    }

    function logProcessEvent(caseId, activity, userId) {
        try {
            var pe = new GlideRecord(CONFIG.tables.PROCESS_EVENT);
            pe.initialize();
            pe.setValue('case_id', caseId || '');
            pe.setValue('activity', sanitizeInput(activity, 200));
            pe.setValue('timestamp', new GlideDateTime());
            pe.setValue('user', userId || gs.getUserID());
            pe.insert();
        } catch (e) {
            gs.error('[Kokoro] Process event log error: ' + e.message);
        }
    }

    // ==========================================
    // 状态验证器
    // ==========================================
    var StateValidator = {
        allowedTransitions: {
            '1':  ['10', '11', '5'],
            '10': ['1', '11', '5'],
            '11': ['10', '2', '5', '6'],
            '2':  ['4', '5', '6'],
            '4':  [],
            '5':  [],
            '6':  ['11', '2', '5']
        },
        
        validateTransition: function(fromState, toState) {
            fromState = String(fromState);
            toState = String(toState);
            
            if (!fromState || fromState === '' || fromState === 'undefined' || fromState === 'null') {
                return { valid: true };
            }
            
            if (!this.allowedTransitions.hasOwnProperty(fromState)) {
                return { valid: false, message: '無効な現在状態: ' + fromState };
            }
            
            var allowed = this.allowedTransitions[fromState];
            if (allowed.indexOf(toState) === -1) {
                return { 
                    valid: false, 
                    message: fromState + ' から ' + toState + ' への遷移は許可されていません' 
                };
            }
            
            return { valid: true };
        }
    };

    // ==========================================
    // 加载用户资料
    // ==========================================
    function loadUserProfile() {
        try {
            var grProfile = new GlideRecord(CONFIG.tables.USER_PROFILE);
            grProfile.addQuery('user', data.user_id);
            grProfile.setLimit(1);
            grProfile.query();

            if (grProfile.next()) {
                data.emergency_email = grProfile.getValue('emergency_conact_email') || "";
                data.medical_info = grProfile.getValue('medical_conditions') || "";
                data.blood_type = grProfile.getValue('blood_type') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Profile load error: " + e.message);
        }
    }

    function loadDigitalWill() {
        try {
            var grWill = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
            grWill.addQuery('user', data.user_id);
            grWill.addQuery('is_active', true);
            grWill.addQuery('message_type', 'Last_Will');
            grWill.orderByDesc('sys_created_on');
            grWill.setLimit(1);
            grWill.query();

            if (grWill.next()) {
                data.saved_will = grWill.getValue('message_encrypted') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Will load error: " + e.message);
        }
    }

    loadUserProfile();
    loadDigitalWill();

    // ==========================================
    // 构建任务项 (Integrated SLA)
    // ==========================================
    function buildTaskItem(gr) {
        var taskItem = {
            sys_id: gr.getUniqueValue(),
            number: gr.getValue('number') || '',
            category: gr.getValue('u_category') || '',
            category_display: gr.getDisplayValue('u_category') || '未分類',
            zone: gr.getDisplayValue('shelter_zone') || '',
            detail_loc: gr.getValue('detail_loc') || gr.getValue('wish_content') || '',
            desc: gr.getValue('u_remarks') || '',
            urgency: gr.getValue('u_urgency') || 'Medium',
            contact: gr.getValue('u_contact_info') || '',
            reporter_name: gr.getDisplayValue('sys_created_by') || '一般ユーザー',
            assigned_to_name: gr.getDisplayValue('assigned_to') || '',
            assigned_to_id: gr.getValue('assigned_to') || '',
            state: parseInt(gr.getValue('state')) || 10,
            state_label: gr.getDisplayValue('state') || '',
            quantity: parseInt(gr.getValue('u_quantity')) || 1,
            remarks: gr.getValue('u_remarks') || '',
            affected_count: gr.getValue('u_affected_count') || '不明',
            history: [],
            attachments: [],
            sla: null 
        };

        // 时间计算
        var created = new GlideDateTime(gr.sys_created_on);
        var now = new GlideDateTime();
        var diffMs = GlideDateTime.subtract(created, now).getNumericValue(); 
        var minutes = Math.floor(diffMs / 1000 / 60);

        if (minutes < 60) {
            taskItem.time_ago = minutes + "分前";
        } else if (minutes < 1440) {
            taskItem.time_ago = Math.floor(minutes / 60) + "時間前";
        } else {
            taskItem.time_ago = Math.floor(minutes / 1440) + "日前";
        }

        taskItem.created_on = gr.getDisplayValue('sys_created_on');

        // === SLA信息获取 ===
        try {
            if (typeof x_1821654_kokoro_0.KokoroSLAEngine !== 'undefined') {
                var slaEngine = new x_1821654_kokoro_0.KokoroSLAEngine();
                var slaInfo = slaEngine.getSLAInfo(taskItem.sys_id);
                
                if (slaInfo.has_sla) {
                    taskItem.sla = {
                        elapsed: slaInfo.elapsed,
                        target: slaInfo.target,
                        remaining: slaInfo.remaining,
                        percentage: slaInfo.percentage,
                        status: slaInfo.status, 
                        is_breached: slaInfo.is_breached
                    };
                }
            }
        } catch (e) {
            gs.debug('[Kokoro] SLA engine not available for item ' + taskItem.number);
        }

        // 默认计算（Fallback）
        if (!taskItem.sla) {
            var defaultTargets = {
                'Critical': 30, 'High': 60, 'Medium': 120, 'Low': 240
            };
            var target = defaultTargets[taskItem.urgency] || 120;
            
            taskItem.sla = {
                elapsed: minutes,
                target: target,
                remaining: Math.max(0, target - minutes),
                percentage: Math.min(100, Math.round((minutes / target) * 100)),
                status: minutes > target ? 'critical' : (minutes > target * 0.8 ? 'warning' : 'ok'),
                is_breached: minutes > target
            };
        }

        // 附件
        try {
            var att = new GlideRecord('sys_attachment');
            att.addQuery('table_sys_id', taskItem.sys_id);
            att.setLimit(1);
            att.orderByDesc('sys_created_on');
            att.query();
            if (att.next()) {
                taskItem.image_url = '/' + att.sys_id + '.iix';
            }
        } catch (e) {}

        // 活动历史
        try {
            var journal = new GlideRecord('sys_journal_field');
            journal.addQuery('element_id', taskItem.sys_id);
            journal.addQuery('element', 'work_notes');
            journal.orderByDesc('sys_created_on');
            journal.setLimit(10);
            journal.query();
            while (journal.next()) {
                taskItem.history.push({
                    user: journal.getDisplayValue('sys_created_by') || 'System',
                    text: journal.getValue('value') || '',
                    date: journal.getDisplayValue('sys_created_on')
                });
            }
        } catch (e) {}

        return taskItem;
    }

    // ==========================================
    // 加载志愿者列表
    // ==========================================
    function loadVolunteerList() {
        var volunteerList = [];
        try {
            var roleGr = new GlideRecord('sys_user_has_role');
            roleGr.addQuery('role.name', 'x_1821654_kokoro_0.volunteer');
            roleGr.query();
            var volIds = [];
            while (roleGr.next()) {
                volIds.push(roleGr.getValue('user'));
            }
            
            if (volIds.length > 0) {
                var userGr = new GlideRecord('sys_user');
                userGr.addQuery('sys_id', 'IN', volIds.join(','));
                userGr.addQuery('active', true);
                userGr.query();
                while (userGr.next()) {
                    volunteerList.push({
                        sys_id: userGr.getUniqueValue(),
                        name: userGr.getDisplayValue('name') || userGr.getValue('user_name')
                    });
                }
            }
            
            // 添加管理员
            var adminGr = new GlideRecord('sys_user');
            adminGr.addQuery('active', true);
            adminGr.addQuery('roles', 'CONTAINS', 'admin');
            adminGr.setLimit(10);
            adminGr.query();
            while (adminGr.next()) {
                var alreadyExists = volunteerList.some(function(v) { 
                    return v.sys_id === adminGr.getUniqueValue(); 
                });
                if (!alreadyExists) {
                    volunteerList.push({
                        sys_id: adminGr.getUniqueValue(),
                        name: adminGr.getDisplayValue('name') || adminGr.getValue('user_name')
                    });
                }
            }
        } catch (e) {
            gs.error("[Kokoro] Load volunteer list error: " + e.message);
        }
        return volunteerList;
    }

    // ==========================================
    // 处理输入
    // ==========================================
    if (input) {

        // === 位置更新 ===
        if (input.action === 'update_location' && input.zone) {
            try {
                var assignEngine = new x_1821654_kokoro_0.KokoroAutoAssignment();
                assignEngine.updateVolunteerLocation(data.user_id, input.zone);
                data.success = true;
                data.message = '位置を更新しました';
            } catch (e) {
                data.error = '位置更新に失敗しました: ' + e.message;
            }
            return;
        }

        // === 可用性更新 ===
        if (input.action === 'set_availability') {
            try {
                var assignEngine2 = new x_1821654_kokoro_0.KokoroAutoAssignment();
                assignEngine2.setVolunteerAvailability(data.user_id, input.available);
                data.success = true;
                data.message = input.available ? 'オンラインになりました' : 'オフラインになりました';
            } catch (e) {
                data.error = '状態更新に失敗しました: ' + e.message;
            }
            return;
        }

        // === 手动触发自动分配 ===
        if (input.action === 'trigger_auto_assign' && input.sys_id) {
            if (!isVolunteer) {
                data.error = '権限がありません';
                return;
            }
            
            try {
                var assignEngine3 = new x_1821654_kokoro_0.KokoroAutoAssignment();
                var result = assignEngine3.autoAssign(input.sys_id, { forceReassign: input.force_reassign });
                
                if (result.success) {
                    data.success = true;
                    data.assigned_to = result.volunteer_name;
                    data.score = result.score;
                } else {
                    data.error = result.reason;
                }
            } catch (e) {
                data.error = '自動分配に失敗しました: ' + e.message;
            }
            return;
        }

        // === 获取SLA详情 ===
        if (input.action === 'get_sla_info' && input.sys_id) {
            try {
                var slaEngine2 = new x_1821654_kokoro_0.KokoroSLAEngine();
                data.sla_info = slaEngine2.getSLAInfo(input.sys_id);
                data.success = true;
            } catch (e) {
                data.error = 'SLA情報の取得に失敗しました';
            }
            return;
        }

        if (input.action === 'get_volunteers') {
            data.volunteers = loadVolunteerList();
            data.success = true;
            return;
        }

        if (input.action === 'save_settings') {
            try {
                var successProfile = false;
                var successWill = true;

                var grUp = new GlideRecord(CONFIG.tables.USER_PROFILE);
                grUp.addQuery('user', data.user_id);
                grUp.query();

                if (grUp.next()) {
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.update() != null);
                } else {
                    grUp.initialize();
                    grUp.setValue('user', data.user_id);
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.insert() != null);
                }

                if (input.will && String(input.will).trim() !== '') {
                    var oldMsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldMsg.addQuery('user', data.user_id);
                    oldMsg.addQuery('is_active', true);
                    oldMsg.addQuery('message_type', 'Last_Will');
                    oldMsg.query();
                    while (oldMsg.next()) {
                        oldMsg.setValue('is_active', false);
                        oldMsg.update();
                    }

                    var emsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsg.initialize();
                    emsg.setValue('user', data.user_id);
                    emsg.setValue('message_encrypted', sanitizeInput(input.will, 4000));
                    emsg.setValue('message_type', 'Last_Will');
                    emsg.setValue('is_active', true);
                    emsg.setValue('created_at', new GlideDateTime());
                    successWill = (emsg.insert() != null);
                }

                if (successProfile && successWill) {
                    data.success = true;
                    logProcessEvent(data.user_id, 'User settings updated', data.user_id);
                } else {
                    data.error = "保存失敗";
                }

            } catch (e) {
                gs.error("[Kokoro] Save error: " + e.message);
                data.error = "保存エラー";
            }
            return;
        }

        if (input.action === 'submit_record' || input.action === 'update_record') {
            if (!input.location || !input.category || !input.urgency) {
                data.error = "必須項目が不足";
                return;
            }

            try {
                var gr = new GlideRecord(CONFIG.tables.SILENT_WISH);

                if (input.action === 'update_record' && input.sys_id) {
                    if (!validateSysId(input.sys_id)) {
                        data.error = "無効なID";
                        return;
                    }
                    if (!gr.get(input.sys_id)) {
                        data.error = "レコードが見つかりません";
                        return;
                    }
                } else {
                    gr.initialize();
                    gr.setValue('state', CONFIG.wishStates.SUBMITTED);
                }

                gr.setValue('shelter_zone', sanitizeInput(input.location, 100));
                gr.setValue('u_category', sanitizeInput(input.category, 50));
                gr.setValue('u_quantity', parseInt(input.quantity) || 1);
                gr.setValue('u_urgency', sanitizeInput(input.urgency, 20));
                gr.setValue('u_affected_count', sanitizeInput(input.affected_count, 10));
                gr.setValue('u_remarks', sanitizeInput(input.remarks, 1000));
                gr.setValue('u_contact_info', sanitizeInput(input.contact, 200));
                gr.setValue('detail_loc', sanitizeInput(input.detail_loc, 200));

                var fullDescription =
                    "【詳細場所】: " + sanitizeInput(input.detail_loc, 200) + "\n" +
                    "【支援種別】: " + input.category + " x " + (input.quantity || 1) + "\n" +
                    "【緊急度】: " + input.urgency + "\n" +
                    "【対象人数】: " + (input.affected_count || '1') + "\n" +
                    "【備考】: " + (input.remarks || 'なし');

                gr.setValue('wish_content', fullDescription);

                if (input.action === 'submit_record') {
                    var sysId = gr.insert();
                    if (sysId) {
                        data.ticketNumber = gr.getValue('number');
                        data.newRecordID = sysId;
                        data.success = true;
                        logProcessEvent(sysId, 'Wish submitted: ' + input.category, data.user_id);
                    } else {
                        data.error = "作成失敗";
                    }
                } else {
                    if (gr.update()) {
                        data.ticketNumber = gr.getValue('number');
                        data.success = true;
                        logProcessEvent(input.sys_id, 'Wish updated', data.user_id);
                    } else {
                        data.error = "更新失敗";
                    }
                }
            } catch (e) {
                gs.error("[Kokoro] Submit error: " + e.message);
                data.error = "エラーが発生しました: " + e.message;
            }
            return;
        }

        if (input.action === 'upload_attachment' && input.sys_id) {
            try {
                if (!validateSysId(input.sys_id)) {
                    data.error = "無効なID";
                    return;
                }
                var attachment = new GlideSysAttachment();
                if (input.file_data) {
                    var cleanBase64 = input.file_data.split(',')[1] || input.file_data;
                    attachment.writeBase64(
                        input.table || CONFIG.tables.SILENT_WISH,
                        input.sys_id,
                        sanitizeInput(input.file_name, 100),
                        input.content_type,
                        cleanBase64
                    );
                    data.success = true;
                }
            } catch (e) {
                gs.error("[Kokoro] Attachment error: " + e.message);
            }
            return;
        }

        if (input.action === 'register_heartbeat') {
            try {
                var hb = new GlideRecord(CONFIG.tables.HEARTBEAT);
                hb.initialize();
                hb.setValue('u_user', data.user_id);
                hb.setValue('u_timestamp', new GlideDateTime());
                hb.setValue('u_status', 'Safe');

                var hbId = hb.insert();
                data.heartbeat_id = hbId;
                data.success = true;
                logProcessEvent(hbId, 'Heartbeat registered', data.user_id);
            } catch (e) {
                gs.error("[Kokoro] Heartbeat error: " + e.message);
                data.error = "心跳注册失败";
            }
            return;
        }

        if (input.action === 'update_will') {
            try {
                if (input.message) {
                    var oldQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldQuick.addQuery('user', data.user_id);
                    oldQuick.addQuery('is_active', true);
                    oldQuick.addQuery('message_type', 'Quick_Will');
                    oldQuick.query();
                    while (oldQuick.next()) {
                        oldQuick.setValue('is_active', false);
                        oldQuick.update();
                    }

                    var emsgQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsgQuick.initialize();
                    emsgQuick.setValue('user', data.user_id);
                    emsgQuick.setValue('message_encrypted', sanitizeInput(input.message, 4000));
                    emsgQuick.setValue('message_type', 'Quick_Will');
                    emsgQuick.setValue('is_active', true);
                    emsgQuick.setValue('created_at', new GlideDateTime());

                    if (emsgQuick.insert()) {
                        data.success = true;
                    }
                }
            } catch (e) {
                gs.error("[Kokoro] Quick will error: " + e.message);
            }
            return;
        }

        // 志愿者操作
        if (input.sys_id) {
            if (!validateSysId(input.sys_id)) {
                data.error = "無効なID";
                return;
            }

            var taskGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            if (!taskGr.get(input.sys_id)) {
                data.error = "タスクが見つかりません";
                return;
            }

            var currentState = String(taskGr.getValue('state') || '10');

            if (input.action === 'assign_to_me') {
                if (!isVolunteer) {
                    data.error = "ボランティア権限が必要です";
                    return;
                }

                taskGr.setValue('assigned_to', data.user_id);
                
                if (currentState === '1' || currentState === '10') {
                    var validationAssign = StateValidator.validateTransition(currentState, '11');
                    if (validationAssign.valid) {
                        taskGr.setValue('state', '11');
                    }
                }
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + data.user_name, data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'assign_to' && input.assignee_id) {
                if (!isVolunteer) {
                    data.error = "ボランティア権限が必要です";
                    return;
                }

                taskGr.setValue('assigned_to', input.assignee_id);
                
                if (currentState === '1' || currentState === '10') {
                    var validationAssignTo = StateValidator.validateTransition(currentState, '11');
                    if (validationAssignTo.valid) {
                        taskGr.setValue('state', '11');
                    }
                }
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + input.assignee_id, data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'change_status' && input.new_state) {
                var newState = String(input.new_state);
                var validationChange = StateValidator.validateTransition(currentState, newState);
                
                if (!validationChange.valid) {
                    data.error = validationChange.message;
                    return;
                }

                if ((newState === '2' || newState === '4') && taskGr.assigned_to.nil()) {
                    data.error = "先に担当者を設定してください";
                    return;
                }

                taskGr.setValue('state', newState);
                
                if (newState === '4') {
                    taskGr.setValue('u_completed_at', new GlideDateTime());
                }
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Status changed to ' + newState, data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'start') {
                var validationStart = StateValidator.validateTransition(currentState, '2');
                if (!validationStart.valid) {
                    data.error = validationStart.message;
                    return;
                }

                if (taskGr.getValue('assigned_to') != data.user_id && !gs.hasRole('admin')) {
                    data.error = "自分に担当されたタスクのみ開始できます";
                    return;
                }

                taskGr.setValue('state', '2');
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task started', data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'complete') {
                var validationComplete = StateValidator.validateTransition(currentState, '4');
                if (!validationComplete.valid) {
                    data.error = validationComplete.message;
                    return;
                }

                taskGr.setValue('state', '4');
                taskGr.setValue('u_completed_at', new GlideDateTime());
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task completed', data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'add_comment' && input.message) {
                try {
                    taskGr.work_notes = sanitizeInput(input.message, 1000);
                    taskGr.update();
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Comment added', data.user_id);
                } catch (e) {
                    data.error = "コメント追加失敗";
                }
                return;
            }
        }
    }

    // ==========================================
    // 5. 加载数据列表
    // ==========================================
    if (isVolunteer) {
        // 加载“我的任务”
        try {
            var myGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            myGr.addQuery('assigned_to', data.user_id);
            myGr.orderByDesc('sys_updated_on');
            myGr.setLimit(50);
            myGr.query();
            while (myGr.next()) {
                data.myTasks.push(buildTaskItem(myGr));
            }
        } catch (e) {
            gs.error("[Kokoro] My tasks load error: " + e.message);
        }

        // 加载“所有任务”
        try {
            var allGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            allGr.orderByDesc('sys_created_on');
            allGr.setLimit(100);
            allGr.query();
            while (allGr.next()) {
                data.list.push(buildTaskItem(allGr));
            }
        } catch (e) {
            gs.error("[Kokoro] All tasks load error: " + e.message);
        }

        // 加载统计数据
        try {
            var gaOpen = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaOpen.addNullQuery('assigned_to');
            gaOpen.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaOpen.addAggregate('COUNT');
            gaOpen.query();
            if (gaOpen.next()) {
                data.openCount = parseInt(gaOpen.getAggregate('COUNT')) || 0;
            }

            var gaSOS = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaSOS.addQuery('u_urgency', 'Critical');
            gaSOS.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaSOS.addAggregate('COUNT');
            gaSOS.query();
            if (gaSOS.next()) {
                data.sosCount = parseInt(gaSOS.getAggregate('COUNT')) || 0;
            }
        } catch (e) {
            gs.error("[Kokoro] Stats error: " + e.message);
        }

        data.volunteers = loadVolunteerList();
    } else {
        try {
            var myRequestGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            myRequestGr.addQuery('sys_created_by', gs.getUserName());
            myRequestGr.orderByDesc('sys_created_on');
            myRequestGr.setLimit(20);
            myRequestGr.query();
            while (myRequestGr.next()) {
                data.list.push(buildTaskItem(myRequestGr));
            }
        } catch(e) {
            gs.error("[Kokoro] User tasks load error: " + e.message);
        }
    }

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-26 11:41:20</sys_created_on>
        <sys_id>f95e8ba383227210f6b1fb96feaad375</sys_id>
        <sys_mod_count>67</sys_mod_count>
        <sys_name>Kokoro Volunteer Dashboard</sys_name>
        <sys_package display_value="Kokoro Shelter" source="x_1821654_kokoro_0">80ba4d9583863210f6b1fb96feaad3b2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Kokoro Shelter">80ba4d9583863210f6b1fb96feaad3b2</sys_scope>
        <sys_update_name>sp_widget_f95e8ba383227210f6b1fb96feaad375</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-30 04:13:34</sys_updated_on>
        <template><![CDATA[<style>
/* ============================================================
   KOKORO DASHBOARD CSS v9.5 (FUSED EDITION)
   包含：原有样式 + 增强面板样式 + 资源条修复
   ============================================================ */

/* 1. 基础隐藏 (原有) */
nav, header, footer, .sp-page-header, .navbar, .polaris-header, 
.sn-polaris-nav, .sn-canvas-header, #sp-nav-bar, .sp-row-background,
.cms-header, .navpage-header {
  display: none !important;
}

/* 2. 针对性隐藏已知组件 */
.sn-chat-overlay, .help-button-wrapper, .sp-ac-root, .sw-session-repro-button,
button.help-button, .sn-connect-floating-wrapper, #u_chat_button, .cm-help-button,
.sp-page-row-options, .theme-picker, .sp-debug-tool, div[ng-controller="spPageRowOptions"],
a[title="Toggle Layout"], .btn-floating, .sp-icon-edit,
.guided-tour-overlay, .code-editor-container, 
.icon-palette, .fa-cog, .sp-icon-color, .sp-preview-pill {
  display: none !important;
  visibility: hidden !important;
  width: 0 !important; height: 0 !important;
  pointer-events: none !important;
  opacity: 0 !important;
  z-index: -9999 !important;
}

/* ★★★ 基于位置的无差别打击 ★★★ */
body > div[style*="position: fixed"][style*="bottom"],
body > div[style*="position:fixed"][style*="bottom"],
body > button[style*="position: fixed"][style*="bottom"],
body > div[style*="position: fixed"][style*="left"], 
body > div[style*="position:fixed"][style*="left"] {
    display: none !important;
    opacity: 0 !important;
    pointer-events: none !important;
    z-index: -9999 !important;
}

/* 3. 基础布局修复 */
html, body {
  height: 100% !important; width: 100% !important;
  overflow: hidden !important; position: fixed !important;
  background: #f4f4f4 !important;
}

/* 4. Modal 核心修复 */
.modal { z-index: 20000 !important; }
.modal-backdrop { z-index: 19999 !important; background-color: rgba(0,0,0,0.9) !important; backdrop-filter: blur(2px); }
.modal-dialog { margin-top: 50px; z-index: 20001 !important; max-width: 900px; width: 90%; }
.modal-content {
  background: #fdfdfd !important;
  border: 2px solid #1a1a1a !important;
  border-radius: 0 !important;
  box-shadow: 0 30px 60px rgba(0,0,0,0.8) !important;
  color: #333 !important;
  font-family: "JetBrains Mono", monospace !important;
  padding: 0 !important;
  overflow: visible !important;
}

/* 5. 模态框内部样式 */
.modal-header-clean { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #f0f0f0; border-bottom: 2px solid #1a1a1a; }
.header-badge { background: #1a1a1a; color: #fff; padding: 4px 10px; font-weight: 700; font-size: 0.8rem; margin-right: 12px; }
.header-id { font-family: "Orbitron", monospace; font-weight: 700; font-size: 1.1rem; }
.header-close { background: none; border: 1px solid #ccc; width: 32px; height: 32px; cursor: pointer; transition: all 0.2s; }
.header-close:hover { background: #d32f2f; color: #fff; border-color: #d32f2f; }
.modal-body-grid { display: grid; grid-template-columns: 1fr 300px; min-height: 500px; }
.body-main { padding: 24px; border-right: 1px solid #eee; }
.ticket-title { font-family: "Rajdhani", sans-serif; font-size: 1.5rem; font-weight: 700; margin: 0 0 20px 0; border-bottom: 1px solid #eee; padding-bottom: 15px; }
.qty-badge-black { background: #000; color: #fff; padding: 2px 8px; font-size: 0.8rem; vertical-align: middle; margin-left: 10px; }
.action-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
.btn-purple-outline { border: 1px solid #6200ea; color: #6200ea; background: #fff; padding: 8px 16px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
.btn-normal { border: 1px solid #ccc; background: #fff; padding: 8px 16px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
.action-btn { background: #1a1a1a; color: #fff; border: none; padding: 8px 16px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: "Rajdhani", sans-serif; }
.action-btn:hover { background: #333; }
.desc-box { background: #fafafa; border: 1px solid #eee; padding: 16px; margin-bottom: 24px; }
.desc-section-title { font-size: 0.8rem; color: #999; margin-bottom: 12px; font-weight: 700; letter-spacing: 1px; }
.desc-grid { display: grid; gap: 12px; }
.desc-item { display: flex; gap: 10px; align-items: flex-start; font-size: 0.9rem; }
.desc-icon { width: 24px; text-align: center; color: #666; }
.desc-label { font-weight: 700; color: #555; margin-right: 6px; }
.activity-area { margin-top: 20px; }
.note-input { width: 100%; border: 1px solid #ccc; padding: 10px; min-height: 60px; margin-bottom: 10px; }
.submit-btn { background: #ccc; color: #fff; border: none; padding: 8px 16px; font-weight: 700; cursor: not-allowed; float: right; }
.submit-btn.ready { background: #1a1a1a; cursor: pointer; }
.body-sidebar { background: #fcfcfc; padding: 24px; }
.sidebar-block { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #eee; }
.sb-label { font-size: 0.75rem; color: #999; margin-bottom: 8px; font-weight: 700; letter-spacing: 1px; }
.user-row { display: flex; align-items: center; gap: 10px; }
.avatar-box { width: 32px; height: 32px; background: #1a1a1a; color: #fff; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: 700; }
.avatar-box.orange { background: #ff9500; }
.status-pill { background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; }
.ai-card { background: #f3e5f5; border: 1px solid #e1bee7; padding: 12px; margin-bottom: 24px; }
.ai-head { color: #7b1fa2; font-weight: 700; font-size: 0.8rem; margin-bottom: 6px; }
.ai-text { font-size: 0.85rem; color: #4a148c; }
.dropdown-wrapper { position: relative; display: inline-block; }
.status-menu { position: absolute; top: 100%; left: 0; background: #fff; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; min-width: 160px; }
.status-item { padding: 10px 16px; cursor: pointer; font-size: 0.85rem; border-bottom: 1px solid #eee; }
.status-item:hover { background: #f5f5f5; }
.status-item.danger { color: #d32f2f; }

/* 志愿者状态面板 */
.volunteer-status-panel {
  background: #fff; border: 1px solid #ddd; border-left: 4px solid #000;
  padding: 12px 20px; margin-bottom: 20px;
  display: flex; align-items: center; gap: 30px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.status-row { display: flex; align-items: center; gap: 10px; font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #333; }
.btn-online { background: #34c759; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
.btn-offline { background: #888; color: #fff; border: none; padding: 6px 16px; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
.status-row select { padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; font-family: 'JetBrains Mono'; }

/* 卡片内部 SLA & Status Indicator */
.card-sla { margin: 10px 0; padding-top: 8px; border-top: 1px dashed #eee; }
.sla-bar-container { height: 4px; background: #eee; border-radius: 2px; overflow: hidden; margin-bottom: 4px; }
.sla-bar { height: 100%; transition: width 0.3s ease; }
.sla-info { display: flex; justify-content: space-between; font-size: 10px; font-family: 'Orbitron', monospace; color: #666; font-weight: 700; }
.sla-percentage { color: #333; }
.sla-remaining { display: flex; align-items: center; gap: 4px; }
.sla-critical { color: #ff3b30 !important; }
.sla-warning { color: #ff9500 !important; }
.sla-ok { color: #34c759 !important; }

.state-indicator {
    padding: 6px 14px; border-radius: 4px; color: white; font-weight: 700;
    text-transform: uppercase; font-size: 0.85rem; display: inline-block;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-family: 'Rajdhani', sans-serif; letter-spacing: 1px;
}

/* ==============================================
   ★ NEW ENHANCED COMPONENTS CSS ★
   (整合了右侧增强面板的样式)
   ============================================== */

/* Side Panel Enhanced Wrapper */
.side-panel-enhanced {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 20px;
}

/* Data Stream Widget */
.data-stream-widget {
    background: #fff;
    border: 1px solid #ddd;
    padding: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

.widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #1a1a1a;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.widget-title {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    color: #1a1a1a;
    display: flex;
    align-items: center;
    gap: 8px;
}

.live-indicator {
    width: 8px; height: 8px;
    background: #34c759;
    border-radius: 50%;
    box-shadow: 0 0 5px #34c759;
    animation: blink 2s infinite;
}

/* Live Metric Card */
.live-metric-card {
    background: #fafafa;
    border-left: 4px solid #333;
    padding: 12px;
    margin-bottom: 10px;
    transition: transform 0.2s;
}
.live-metric-card:hover { transform: translateX(2px); }

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.metric-label { font-size: 0.8rem; font-weight: 700; color: #555; }
.metric-value { font-family: 'Orbitron', monospace; font-weight: 700; color: #1a1a1a; }

.metric-mini-bar {
    height: 3px; background: #eee; width: 100%; overflow: hidden;
}
.metric-mini-fill {
    height: 100%; background: #666;
}

/* AI Insight Card (Enhanced) */
.ai-insight-card {
    background: #fdfbff;
    border: 1px solid #d1c4e9;
    padding: 16px;
    position: relative;
    overflow: hidden;
}
.ai-insight-card::before {
    content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
    background: linear-gradient(to bottom, #7b1fa2, #ba68c8);
}
.ai-header {
    color: #6a1b9a; font-weight: 700; font-size: 0.9rem; margin-bottom: 10px;
    display: flex; align-items: center; gap: 8px;
}
.ai-content {
    font-size: 0.85rem; color: #4a148c; line-height: 1.5; margin-bottom: 12px;
}
.ai-tags { display: flex; gap: 6px; flex-wrap: wrap; }
.ai-tag {
    background: rgba(123, 31, 162, 0.1); color: #7b1fa2;
    padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 700;
}

/* Resource Section New Style */
.resource-section-enhanced .resource-header {
    display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 6px;
}
.resource-section-enhanced .label {
    font-size: 0.85rem; font-weight: 700; color: #333;
}
.resource-section-enhanced .code {
    font-family: 'JetBrains Mono', monospace; color: #999; font-size: 0.75rem; margin-right: 5px;
}
.resource-section-enhanced .resource-bar {
    height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-bottom: 15px;
}
.resource-section-enhanced .resource-fill {
    height: 100%; transition: width 0.5s ease;
}
.resource-fill.low { background: #ff3b30; }
.resource-fill.medium { background: #ffcc00; }
.resource-fill.high { background: #34c759; }

/* 响应式 */
@media (max-width: 800px) { 
  .modal-body-grid { grid-template-columns: 1fr; } 
  .body-sidebar { border-top: 1px solid #eee; } 
  .volunteer-status-panel { flex-direction: column; align-items: flex-start; gap: 10px; }
}

@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
</style>

<div class="kokoro-volunteer-container">
   
  <div class="safety-banner">
    <div><i class="fa fa-exclamation-triangle"></i> ALERT: 現在、余震警報発令中。安全を確保してください。</div>
    <button ng-click="c.goToUserView()">
      <i class="fa fa-mobile"></i> USER_VIEW
    </button>
  </div>

  <div class="command-header">
    <div class="command-logo">
      <div class="logo-icon">K</div>
      <div class="logo-text">
        <span class="logo-title">KOKORO</span>
        <span class="logo-subtitle">COMMAND_INTERFACE</span>
      </div>
    </div>
    <div class="system-status">
      <div class="status-indicator">
        <span class="status-dot"></span>
        <span class="status-text">SYS_ONLINE</span>
      </div>
      <span class="version-tag">v2.5.0-fused</span>
      <span class="system-time">{{c.currentTime}}</span>
    </div>
  </div>

  <div class="nav-tabs-custom">
    <div class="tab" ng-class="{'active': c.view === 'dashboard'}" ng-click="c.view = 'dashboard'">
      <span class="tab-number">01</span> / OVERVIEW
    </div>
    <div class="tab" ng-class="{'active': c.view === 'tactical'}" ng-click="c.view = 'tactical'">
      <span class="tab-number">02</span> / TACTICAL
    </div>
    <div class="tab" ng-class="{'active': c.view === 'mine'}" ng-click="c.view = 'mine'">
      <span class="tab-number">03</span> / OPERATORS ({{c.data.myTasks.length}})
    </div>
  </div>

  <div class="scan-line-header">
    <div class="scan-line"></div>
    <span class="scan-label">DISASTER_RESPONSE_SYSTEM</span>
    <div class="scan-line"></div>
  </div>

  <div class="board-container">
      
    <div class="view-dashboard" ng-if="c.view === 'dashboard' || c.view === 'tactical'">
        
      <div class="volunteer-status-panel" ng-if="c.data.is_volunteer">
        <div class="status-row">
          <span><i class="fa fa-power-off"></i> 状態:</span>
          <button ng-click="c.toggleAvailability()" 
                  ng-class="{'btn-online': c.volunteerStatus.isOnline, 'btn-offline': !c.volunteerStatus.isOnline}">
            {{c.volunteerStatus.isOnline ? 'オンライン' : 'オフライン'}}
          </button>
        </div>
        <div class="status-row">
          <span><i class="fa fa-map-pin"></i> 現在地:</span>
          <select ng-model="c.volunteerStatus.currentZone" ng-change="c.updateMyLocation(c.volunteerStatus.currentZone)">
            <option value="">未設定</option>
            <option value="Family Area">ファミリーエリア</option>
            <option value="Single Area">単身エリア</option>
            <option value="Medical Area">医療エリア</option>
            <option value="Staff Room">スタッフルーム</option>
          </select>
        </div>
      </div>
        
      <div class="stats-section">
        <div class="section-header">
          <span class="section-tag">01</span>
          <span class="section-title">METRICS_OVERVIEW</span>
          <span class="section-time">{{c.currentTime}}</span>
        </div>
          
        <div class="stats-row" style="display: flex; gap: 15px; flex-wrap: wrap;">
          <div class="stat-card clickable" ng-click="c.filterByUrgency('Critical')">
            <div class="stat-label">
              <span class="stat-code">REQ</span>
              <span class="stat-suffix">_01</span>
            </div>
            <div class="stat-num">{{c.data.sosCount}}</div>
            <div class="stat-name">CRITICAL_SOS</div>
            <div class="stat-footer">
              <span class="stat-change" ng-class="{'negative': c.data.sosCount > 0, 'positive': c.data.sosCount === 0}">
                {{c.data.sosCount > 0 ? 'URGENT' : 'CLEAR'}}
              </span>
              <span class="stat-status" ng-class="{'critical': c.data.sosCount > 0, 'nominal': c.data.sosCount === 0}">
                {{c.data.sosCount > 0 ? 'ALERT' : 'NOMINAL'}}
              </span>
            </div>
          </div>
            
          <div class="stat-card clickable" ng-click="c.filterByAssignment('unassigned')">
            <div class="stat-label">
              <span class="stat-code">OPN</span>
              <span class="stat-suffix">_02</span>
            </div>
            <div class="stat-num">{{c.data.openCount}}</div>
            <div class="stat-name">UNASSIGNED_REQUESTS</div>
            <div class="stat-footer">
              <span class="stat-change" ng-class="{'negative': c.data.openCount > 5, 'positive': c.data.openCount <= 5}">
                {{c.data.openCount > 5 ? 'HIGH' : 'NORMAL'}}
              </span>
              <span class="stat-status" ng-class="{'warning': c.data.openCount > 5, 'nominal': c.data.openCount <= 5}">
                {{c.data.openCount > 5 ? 'BACKLOG' : 'NOMINAL'}}
              </span>
            </div>
          </div>
            
          <div class="stat-card clickable" ng-click="c.clearFilters()">
            <div class="stat-label">
              <span class="stat-code">TOT</span>
              <span class="stat-suffix">_03</span>
            </div>
            <div class="stat-num">{{c.data.list.length}}</div>
            <div class="stat-name">TOTAL_ACTIVE</div>
            <div class="stat-footer">
              <span class="stat-change positive">TRACKED</span>
              <span class="stat-status nominal">NOMINAL</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label">
              <span class="stat-code">OPR</span>
              <span class="stat-suffix">_04</span>
            </div>
            <div class="stat-num">{{c.data.volunteers.length || '--'}}</div>
            <div class="stat-name">ACTIVE_OPERATORS</div>
            <div class="stat-footer">
              <span class="stat-change positive">ONLINE</span>
              <span class="stat-status nominal">NOMINAL</span>
            </div>
          </div>

          <div class="stat-card" ng-if="c.slaStats">
            <div class="stat-label">
              <span class="stat-code">SLA</span>
              <span class="stat-suffix">_STATUS</span>
            </div>
            <div class="stat-num" ng-class="{'text-danger': c.slaStats.breached > 0}" style="color: {{c.slaStats.breached > 0 ? '#ff3b30' : 'inherit'}}">
              {{c.slaStats.breached}}
            </div>
            <div class="stat-name">BREACHED</div>
            <div class="stat-footer">
              <span class="stat-change" ng-class="{'negative': c.slaStats.atRisk > 0}">
                {{c.slaStats.atRisk}} AT_RISK
              </span>
              <span class="stat-status" ng-class="{'critical': c.slaStats.breached > 0, 'warning': c.slaStats.atRisk > 0, 'nominal': c.slaStats.breached === 0 && c.slaStats.atRisk === 0}">
                {{c.slaStats.breached > 0 ? 'ALERT' : (c.slaStats.atRisk > 0 ? 'WARN' : 'OK')}}
              </span>
            </div>
          </div>

        </div>
      </div>

      <div class="two-column-layout">
          
        <div class="alert-section">
          <div class="section-header">
            <span class="section-tag">02</span>
            <span class="section-title">ALERT_FEED</span>
            <span class="section-tag" style="margin-left:auto; background:transparent; border:1px solid var(--border-color); color:var(--text-muted);">
              {{(c.filteredList || c.data.list).length}}
            </span>
          </div>
            
          <div class="alert-list">
            <div class="alert-item" ng-class="'priority-' + item.urgency" 
                 ng-repeat="item in (c.filteredList || c.data.list) | limitTo:20" 
                 ng-click="c.openModal(item)">
              <span class="alert-id">{{item.number | limitTo:12}}</span>
              <span class="alert-priority" ng-class="{
                'p-critical': item.urgency === 'Critical',
                'p-high': item.urgency === 'High',
                'p-medium': item.urgency === 'Medium',
                'p-low': item.urgency === 'Low'
              }">P{{item.urgency === 'Critical' ? '1' : item.urgency === 'High' ? '2' : item.urgency === 'Medium' ? '3' : '4'}}_{{item.urgency | uppercase | limitTo:4}}</span>
              <span class="alert-zone">{{item.zone | limitTo:6}}</span>
              <span class="alert-time">{{item.time_24h}}</span>
              <span class="alert-content">{{c.dict[item.category] || item.category}} x{{item.quantity}} - {{item.detail_loc | limitTo:30}}</span>
              <span class="alert-arrow">→</span>
            </div>

            <div class="empty-board" ng-if="!(c.filteredList || c.data.list) || (c.filteredList || c.data.list).length === 0">
              <i class="fa fa-check-circle"></i>
              <h4>ALL_CLEAR</h4>
              <p>現在、待機中のリクエストはありません</p>
            </div>
          </div>
        </div>

        <div class="side-panel-wrapper">
          
            <div class="side-panel-enhanced">
                <div class="data-stream-widget">
                    <div class="widget-header">
                        <div class="widget-title">
                            <i class="fa fa-chart-line"></i> リアルタイム分析
                        </div>
                        <div class="live-indicator"></div>
                    </div>
                    
                    <div class="live-metric-card">
                        <div class="metric-row">
                            <span class="metric-label">応答率</span>
                            <span class="metric-value">94%</span>
                        </div>
                        <div class="metric-mini-bar">
                            <div class="metric-mini-fill" style="width: 94%"></div>
                        </div>
                    </div>
                    
                    <div class="live-metric-card">
                        <div class="metric-row">
                            <span class="metric-label">待機タスク</span>
                            <span class="metric-value">{{c.data.openCount}}</span>
                        </div>
                        <div class="metric-mini-bar">
                            <div class="metric-mini-fill" style="width: 78%"></div>
                        </div>
                    </div>
                </div>

                <div class="ai-insight-card">
                    <div class="ai-header">
                        <i class="fa fa-robot"></i> AI インサイト
                    </div>
                    <div class="ai-content">
                        現在の配送効率は先週比で<strong>+12%</strong>向上しています。
                        食料品の需要が<strong>18時〜20時</strong>に集中する傾向があります。
                    </div>
                    <div class="ai-tags">
                        <span class="ai-tag">効率UP</span>
                        <span class="ai-tag">需要予測</span>
                        <span class="ai-tag">最適化</span>
                    </div>
                </div>
            </div>

            <div class="resource-section-enhanced" style="margin-top: 20px;">
                <div class="section-header" style="padding: 0 0 15px 0; margin-bottom: 20px;">
                    <span class="section-tag">03</span>
                    <span class="section-title">RESOURCE_STATUS</span>
                </div>

                <div>
                    <div class="resource-header">
                        <div class="label"><span class="code">[FOOD]</span> <span>食料</span></div>
                        <span style="font-family: 'Orbitron'; font-weight: 700;">{{c.data.resources.food || 42}}%</span>
                    </div>
                    <div class="resource-bar">
                        <div class="resource-fill" 
                             ng-class="{'low': (c.data.resources.food || 42) < 30, 'medium': (c.data.resources.food || 42) >= 30 && (c.data.resources.food || 42) < 60, 'high': (c.data.resources.food || 42) >= 60}"
                             style="width: {{c.data.resources.food || 42}}%"></div>
                    </div>
                </div>

                <div>
                    <div class="resource-header">
                        <div class="label"><span class="code">[WATR]</span> <span>飲料水</span></div>
                        <span style="font-family: 'Orbitron'; font-weight: 700;">{{c.data.resources.water || 78}}%</span>
                    </div>
                    <div class="resource-bar">
                        <div class="resource-fill" 
                             ng-class="{'low': (c.data.resources.water) < 30, 'medium': (c.data.resources.water) >= 30 && (c.data.resources.water) < 60, 'high': (c.data.resources.water) >= 60}"
                             style="width: {{c.data.resources.water || 78}}%"></div>
                    </div>
                </div>

                <div>
                    <div class="resource-header">
                        <div class="label"><span class="code">[MEDI]</span> <span>医療品</span></div>
                        <span style="font-family: 'Orbitron'; font-weight: 700;">{{c.data.resources.medical || 12}}%</span>
                    </div>
                    <div class="resource-bar">
                        <div class="resource-fill" 
                             ng-class="{'low': (c.data.resources.medical) < 30, 'medium': (c.data.resources.medical) >= 30 && (c.data.resources.medical) < 60, 'high': (c.data.resources.medical) >= 60}"
                             style="width: {{c.data.resources.medical || 12}}%"></div>
                    </div>
                </div>

                <div>
                    <div class="resource-header">
                        <div class="label"><span class="code">[CLTH]</span> <span>衣類</span></div>
                        <span style="font-family: 'Orbitron'; font-weight: 700;">{{c.data.resources.clothing || 89}}%</span>
                    </div>
                    <div class="resource-bar">
                        <div class="resource-fill" 
                             ng-class="{'low': (c.data.resources.clothing) < 30, 'medium': (c.data.resources.clothing) >= 30 && (c.data.resources.clothing) < 60, 'high': (c.data.resources.clothing) >= 60}"
                             style="width: {{c.data.resources.clothing || 89}}%"></div>
                    </div>
                </div>

                <div>
                    <div class="resource-header">
                        <div class="label"><span class="code">[HYGN]</span> <span>衛生用品</span></div>
                        <span style="font-family: 'Orbitron'; font-weight: 700;">{{c.data.resources.hygiene || 34}}%</span>
                    </div>
                    <div class="resource-bar">
                        <div class="resource-fill" 
                             ng-class="{'low': (c.data.resources.hygiene) < 30, 'medium': (c.data.resources.hygiene) >= 30 && (c.data.resources.hygiene) < 60, 'high': (c.data.resources.hygiene) >= 60}"
                             style="width: {{c.data.resources.hygiene || 34}}%"></div>
                    </div>
                </div>
            </div>

        </div> </div>

      <div class="card-section" ng-if="c.view === 'tactical'">
        <div class="section-header">
          <span class="section-tag">04</span>
          <span class="section-title">REQUEST_GRID</span>
          <span class="section-tag" style="margin-left:auto; background:transparent; border:1px solid var(--border-color); color:var(--text-muted);">
            {{(c.filteredList || c.data.list).length}} ITEMS
          </span>
        </div>
          
        <div class="card-grid">
          <div class="jira-card" ng-class="'priority-' + item.urgency" 
               ng-repeat="item in (c.filteredList || c.data.list)" 
               ng-click="c.openModal(item)">
            <div class="card-top">
              <span class="card-id">{{item.number}}</span>
              <span class="status-tag" ng-class="'status-' + item.state">
                {{c.statusNames[item.state] || item.state_label || 'OPEN'}}
              </span>
            </div>
              
            <div class="card-title">
              {{c.dict[item.category] || item.category_display}}
              <span class="qty-badge">x{{item.quantity}}</span>
            </div>
              
            <div class="card-loc">
              <i class="fa fa-map-marker"></i> {{item.zone}} - {{item.detail_loc}}
            </div>
              
            <div class="card-detail" ng-if="item.remarks">
              {{item.remarks | limitTo:60}}{{item.remarks.length > 60 ? '...' : ''}}
            </div>
            
            <div class="card-sla" ng-if="item.sla">
              <div class="sla-bar-container">
                <div class="sla-bar"
                     ng-style="{width: item.sla.percentage + '%', background: c.getSLABarColor(item.sla)}">
                </div>
              </div>
              <div class="sla-info" ng-class="c.getSLAClass(item.sla)">
                <span class="sla-percentage">{{item.sla.percentage}}%</span>
                <span class="sla-remaining">
                  <i class="fa" ng-class="{'fa-clock-o': !item.sla.is_breached, 'fa-exclamation-triangle': item.sla.is_breached}"></i>
                  {{c.formatSLARemaining(item.sla.remaining)}}
                </span>
              </div>
            </div>
            
            <div class="metal-divider"></div>
              
            <div class="card-footer">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="priority-badge" ng-class="'priority-' + item.urgency">
                  <i class="fa fa-arrow-up" ng-if="item.urgency === 'Critical'"></i>
                  {{c.dict[item.urgency] || item.urgency}}
                </span>
                <span style="font-size:12px; color:var(--text-muted); font-family:'Orbitron',monospace;">
                  {{item.time_24h}}
                </span>
              </div>
              <div style="margin-top:10px; font-size:12px; color:var(--text-secondary);">
                <i class="fa fa-user"></i> 
                {{item.assigned_to_name || 'UNASSIGNED'}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="view-mine" ng-if="c.view === 'mine'">
      <div class="card-section">
        <div class="section-header">
          <span class="section-tag">03</span>
          <span class="section-title">MY_OPERATIONS</span>
          <span class="section-tag" style="margin-left:auto; background:transparent; border:1px solid var(--border-color); color:var(--text-muted);">
            {{c.data.myTasks.length}} ACTIVE
          </span>
        </div>

        <div class="task-grid">
          <div class="jira-card" ng-class="'priority-' + task.urgency" ng-repeat="task in c.data.myTasks" ng-click="c.openModal(task)">
            <div class="card-top">
              <span class="card-id">{{task.number}}</span>
              <span class="status-tag" ng-class="'status-' + task.state">
                {{c.statusNames[task.state] || task.state_label}}
              </span>
            </div>
            <div class="card-main">
              <div class="card-title">
                {{c.dict[task.category] || task.category}}
                <span class="qty-badge">x{{task.quantity}}</span>
              </div>
              <div class="card-loc">
                <i class="fa fa-map-marker"></i> {{c.dict[task.location] || task.location}}
              </div>
              <div class="card-detail">
                {{task.detail_loc || 'NO_DETAIL'}}
              </div>
              
              <div class="card-sla" ng-if="task.sla">
                  <div class="sla-bar-container">
                    <div class="sla-bar"
                         ng-style="{width: task.sla.percentage + '%', background: c.getSLABarColor(task.sla)}">
                    </div>
                  </div>
                  <div class="sla-info" ng-class="c.getSLAClass(task.sla)">
                    <span class="sla-percentage">{{task.sla.percentage}}%</span>
                    <span class="sla-remaining">
                      <i class="fa" ng-class="{'fa-clock-o': !task.sla.is_breached, 'fa-exclamation-triangle': task.sla.is_breached}"></i>
                      {{c.formatSLARemaining(task.sla.remaining)}}
                    </span>
                  </div>
                </div>

            </div>
              
            <div class="metal-divider"></div>
              
            <div class="card-footer">
              <button class="btn-jira progress" ng-if="task.state == 11" ng-click="$event.stopPropagation(); c.updateStatus(task.sys_id, 'start')">
                <i class="fa fa-play"></i> START_DELIVERY
              </button>
                
              <button class="btn-jira success" ng-if="task.state == 2" ng-click="$event.stopPropagation(); c.updateStatus(task.sys_id, 'complete')">
                <i class="fa fa-check"></i> MARK_COMPLETE
              </button>
                
              <div class="completed-msg" ng-if="task.state == 4" ng-click="c.openModal(task)">
                <i class="fa fa-check-circle"></i> COMPLETED - VIEW_DETAILS
              </div>
            </div>
          </div>
            
          <div class="empty-board" ng-if="c.data.myTasks.length === 0" style="grid-column: 1 / -1;">
            <i class="fa fa-inbox"></i>
            <h4>NO_ACTIVE_OPERATIONS</h4>
            <p>OVERVIEWタブからタスクを取得してください</p>
          </div>
        </div>
      </div>
    </div>
      
  </div>
</div>

<script type="text/ng-template" id="volunteerModalTemplate">
  <div class="modal-content kokoro-modal-window">
    
    <div class="modal-header-clean">
      <div class="header-left">
        <span class="header-badge"><i class="fa fa-truck"></i> RESCUE_REQUEST</span>
        <span class="header-id">{{item.number}}</span>
      </div>
      <button class="header-close" ng-click="cancel()">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <div class="modal-body-grid">
      
      <div class="body-main">
        <h2 class="ticket-title">
          {{c.dict[item.category] || item.category}}未対応の救援要請
          <span class="qty-badge-black">x{{item.quantity}}</span>
        </h2>

        <div class="action-bar">
          <div class="dropdown-wrapper">
            <button class="btn-purple-outline" ng-click="toggleStatusMenu($event)">
              {{c.statusNames[item.state] || 'OPEN'}} <i class="fa fa-chevron-down"></i>
            </button>
            <div class="status-menu" ng-show="statusMenuOpen">
              <div class="status-item" ng-click="changeStatus(item, '11');" ng-if="item.state != 11 && item.state != 4">
                <i class="fa fa-user-plus"></i> ASSIGNED
              </div>
              <div class="status-item" ng-click="changeStatus(item, '2');" ng-if="item.state == 11">
                <i class="fa fa-bicycle"></i> IN_PROGRESS
              </div>
              <div class="status-item" ng-click="changeStatus(item, '4');" ng-if="item.state == 2">
                <i class="fa fa-check"></i> COMPLETED
              </div>
              <div class="status-item danger" ng-click="changeStatus(item, '5');">
                <i class="fa fa-ban"></i> CANCELLED
              </div>
            </div>
          </div>

          <button class="btn-normal" ng-click="assignToMe(item)" ng-if="item.state != 4">
            <i class="fa fa-user"></i> {{item.assigned_to_name ? 'REASSIGN' : 'SYSTEM ADMINISTRATOR'}}
          </button>

          <button class="action-btn" ng-click="triggerAutoAssign(item)" 
                  ng-if="!item.assigned_to_id" 
                  title="自動的に最適な志願者を割り当て">
             <i class="fa fa-magic"></i> 自動分配
          </button>
          <button class="action-btn" ng-click="triggerAutoAssign(item)" 
                  ng-if="item.assigned_to_id" 
                  title="別の志願者に再分配">
             <i class="fa fa-refresh"></i> 再分配
          </button>

        </div>

        <div class="desc-box">
          <div class="desc-section-title"><i class="fa fa-align-left"></i> DESCRIPTION</div>
          <div class="desc-grid">
            <div class="desc-item">
              <div class="desc-icon loc"><i class="fa fa-map-marker"></i></div>
              <div><span class="desc-label">LOCATION:</span> {{item.zone}} - {{item.detail_loc}}</div>
            </div>
            <div class="desc-item">
              <div class="desc-icon type"><i class="fa fa-cube"></i></div>
              <div><span class="desc-label">TYPE:</span> {{c.dict[item.category] || item.category}} x {{item.quantity}}</div>
            </div>
            <div class="desc-item">
              <div class="desc-icon users"><i class="fa fa-users"></i></div>
              <div><span class="desc-label">AFFECTED:</span> {{item.affected_count || '不明'}}</div>
            </div>
            <div class="desc-item" ng-if="item.remarks">
              <div class="desc-icon"><i class="fa fa-info-circle"></i></div>
              <div><span class="desc-label">NOTES:</span> {{item.remarks}}</div>
            </div>
          </div>
        </div>

        <div class="activity-area">
          <div class="desc-section-title"><i class="fa fa-comments"></i> ACTIVITY_LOG</div>
          <textarea class="note-input" ng-model="newComment" placeholder="ADD_INTERNAL_NOTE..."></textarea>
          <button class="submit-btn" ng-class="{'ready': newComment}" ng-disabled="!newComment" ng-click="postComment(item)">
            <i class="fa fa-paper-plane"></i> SUBMIT
          </button>
          
          <div style="margin-top:20px; max-height:150px; overflow-y:auto; border-top:1px solid #eee;">
            <div style="padding:10px 0; border-bottom:1px solid #f9f9f9;" ng-repeat="h in item.history">
              <div style="font-weight:700; font-size:12px; color:#1a1a1a;">
                 {{h.user}} <span style="font-weight:400; color:#999; margin-left:8px;">{{h.date}}</span>
              </div>
              <div style="font-size:13px; margin-top:4px; color:#555;">{{h.text}}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="body-sidebar">
        
        <div class="sidebar-block">
          <div class="sb-label">STATUS</div>
          <div class="state-indicator" ng-style="{background: c.getStateInfo(item.state).color}">
            {{c.getStateInfo(item.state).name}}
          </div>
        </div>

        <div class="sidebar-block">
          <div class="sb-label">ASSIGNEE</div>
          <div class="user-row" ng-if="item.assigned_to_name">
            <div class="avatar-box">{{item.assigned_to_name.charAt(0)}}</div>
            <div class="user-name-text">{{item.assigned_to_name}}</div>
          </div>
          <div class="user-row" ng-if="!item.assigned_to_name">
            <div class="avatar-box" style="background:#ddd; color:#999;">?</div>
            <div class="user-name-text" style="color:#999;">UNASSIGNED</div>
          </div>
        </div>

        <div class="sidebar-block">
          <div class="sb-label">REPORTER</div>
          <div class="user-row">
            <div class="avatar-box orange">{{item.reporter_name.charAt(0)}}</div>
            <div class="user-name-text">{{item.reporter_name}}</div>
          </div>
        </div>

        <div class="sidebar-block">
          <div class="sb-label">PRIORITY</div>
          <div class="priority-btn">
             <i class="fa fa-arrow-right"></i> {{c.dict[item.urgency] || item.urgency}}
          </div>
        </div>
        
        <div class="sidebar-block">
          <div class="sb-label">LOCATION</div>
          <div style="font-weight:700; color:#333; font-size:14px;"><i class="fa fa-map-marker" style="color:#ff3b30;"></i> {{item.zone}}</div>
          <div style="font-size:12px; color:#666;">{{item.detail_loc}}</div>
        </div>

        <div class="ai-card">
          <div class="ai-head"><i class="fa fa-magic"></i> AI_ANALYSIS</div>
          <div class="ai-text">
            [{{item.urgency}}] 通常対応で問題なし。
          </div>
        </div>

        <div class="sidebar-block">
          <div class="sb-label">SLA_TRACKING</div>
          <div class="sla-progress">
             <div class="sla-fill" style="width:{{item.sla.percentage}}%; background-color: {{c.getSLABarColor(item.sla)}};"></div>
          </div>
          <div class="sla-text">
            <span>ELAPSED: {{c.formatHours(item.sla.elapsed)}}</span>
            <span>REMAIN: {{c.formatSLARemaining(item.sla.remaining)}}</span>
          </div>
          <div class="sla-badge" ng-class="c.getSLAClass(item.sla)">
             <i class="fa" ng-class="{'fa-check': !item.sla.is_breached, 'fa-exclamation': item.sla.is_breached}"></i> 
             {{item.sla.is_breached ? 'BREACHED' : 'WITHIN_SLA'}}
          </div>
        </div>

      </div>

    </div>
  </div>
</script>]]></template>
    </sp_widget>
</record_update>
