<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, $uibModal, spUtil, $timeout, $window, $interval, $element, $sce) {
    var c = this;

    // ============================================================
    // 1. HTML信頼化 & 初期化 (Trust HTML & Init)
    // ============================================================
    
    // HTMLから呼び出せる安全変換関数
    $scope.trustHtml = function(html_code) {
        if (!html_code) return "";
        return $sce.trustAsHtml(html_code);
    };
    
    if (c.data && c.data.list) {
        c.data.list.forEach(function(item) {
            if (item.ai_analysis) {
                item.trusted_ai = $sce.trustAsHtml(item.ai_analysis);
            }
        });
    }

    // ============================================================
    // 2. セーフティネット初期化 (Data Safety Net)
    // ============================================================
    function initSafetyNet() {
        if (!c.data) c.data = {};
        
        // 基本配列
        c.data.resourceStatus = c.data.resourceStatus || [];
        for (var i = c.data.resourceStatus.length; i < 5; i++) {
            c.data.resourceStatus.push({ percent: 0, name: 'Resource_' + (i+1) });
        }
            
        c.data.list = c.data.list || [];
        c.data.myTasks = c.data.myTasks || [];
        c.data.myRequests = c.data.myRequests || [];
        c.data.volunteers = c.data.volunteers || [];
        c.data.announcements = c.data.announcements || [];
        
        // ユーザーとSLA
        if (!c.data.user_name) c.data.user_name = 'Operator';
        if (!c.data.user_id) c.data.user_id = 'VOL-000000';
        if (!c.data.slaStats) c.data.slaStats = { breached: 0, atRisk: 0, ok: 0 };
        if (c.data.isVolunteer === undefined) c.data.isVolunteer = true;
        if (!c.data.sosCount) c.data.sosCount = 0;
        if (!c.data.openCount) c.data.openCount = 0;

        // 統計データ
        if (!c.data.processMiningStats) c.data.processMiningStats = { totalEvents: 0, todayEvents: 0, uniqueCases: 0, topActivities: [] };
        if (!c.data.auditStats) c.data.auditStats = { todayLogs: 0, recentActions: [] };
        if (!c.data.overallHealth) c.data.overallHealth = { score: 100, status: 'nominal', components: [] };

        // 辞書設定
        c.statusNames = { '1': 'DRAFT', '10': 'SUBMITTED', '11': 'ASSIGNED', '2': 'IN_PROGRESS', '4': 'COMPLETED', '5': 'CANCELLED', '6': 'ON_HOLD' };
        c.dict = { 'Water': '飲料水', 'Food': '食料', 'Medical': '医療・薬', 'Baby': '乳幼児用品', 'Power': '電源・充電', 'Other': 'その他', 'Family Area': 'ファミリーエリア', 'Single Area': '単身エリア', 'Medical Area': '医療・ケアエリア', 'Critical': '限界 (SOS)', 'High': '困っている', 'Medium': '普通', 'Low': '急ぎません' };
        
        c.volunteerStatus = c.volunteerStatus || { isOnline: true, currentZone: '', taskCount: 0 };
        c.data.isAdmin = c.data.isAdmin || false; 
    }
    initSafetyNet(); // 実行

    // 通信センター初期化
    c.broadcastType = 'announcement';
    c.broadcastTitle = '';
    c.broadcastBody = '';
    c.commsFilter = '';
    
    // Capability オプション構築
    c.data.capOptions = [];
    if (c.data.capabilityOptions && c.data.capabilityOptions.length > 0) {
        for (var ci = 0; ci < c.data.capabilityOptions.length; ci++) {
            c.data.capOptions.push(c.data.capabilityOptions[ci].value || c.data.capabilityOptions[ci].label);
        }
    }
    if (c.data.capOptions.length === 0) {
        c.data.capOptions = ['General Support', 'Medical', 'Logistics', 'Translation', 'Childcare'];
    }

    // ============================================================
    // 3. カンバン・リストロジック (Kanban Logic)
    // ============================================================
    c.showCancelledCol = false;
	// ==========================================
    // 状態定数辞書（マジックナンバー排除）
    // ==========================================
    var STATES = {
        NEW:          1,
        SUBMITTED:    10,
        ASSIGNED:     11,
        IN_PROGRESS:  2,
        COMPLETED:    4,
        CANCELLED:    5,
        ON_HOLD:      6
    };

    // 列名 → 代表状態
    var COLUMN_STATE = {
        assigned:    STATES.ASSIGNED,
        inprogress:  STATES.IN_PROGRESS,
        onhold:      STATES.ON_HOLD,
        done:        STATES.COMPLETED
    };

    // 状態 → 列名（逆引き）
    var STATE_COLUMN = {};
    STATE_COLUMN[STATES.NEW]         = 'assigned';   // 新規も ASSIGNED 列に表示
    STATE_COLUMN[STATES.SUBMITTED]   = 'assigned';   // 提出済みも ASSIGNED 列に表示
    STATE_COLUMN[STATES.ASSIGNED]    = 'assigned';
    STATE_COLUMN[STATES.IN_PROGRESS] = 'inprogress';
    STATE_COLUMN[STATES.ON_HOLD]     = 'onhold';
    STATE_COLUMN[STATES.COMPLETED]   = 'done';

    // 許可遷移マップ（StateValidator 準拠）
    var DRAG_TRANSITIONS = {};
    // NEW(1) から
    DRAG_TRANSITIONS[STATES.NEW + '_' + STATES.ASSIGNED]    = true;
    DRAG_TRANSITIONS[STATES.NEW + '_' + STATES.IN_PROGRESS] = true;
    DRAG_TRANSITIONS[STATES.NEW + '_' + STATES.ON_HOLD]     = true;
    // SUBMITTED(10) から
    DRAG_TRANSITIONS[STATES.SUBMITTED + '_' + STATES.ASSIGNED]    = true;
    DRAG_TRANSITIONS[STATES.SUBMITTED + '_' + STATES.IN_PROGRESS] = true;
    DRAG_TRANSITIONS[STATES.SUBMITTED + '_' + STATES.ON_HOLD]     = true;
    // ASSIGNED(11) から
    DRAG_TRANSITIONS[STATES.ASSIGNED + '_' + STATES.IN_PROGRESS] = true;
    DRAG_TRANSITIONS[STATES.ASSIGNED + '_' + STATES.ON_HOLD]     = true;
    // IN_PROGRESS(2) から
    DRAG_TRANSITIONS[STATES.IN_PROGRESS + '_' + STATES.COMPLETED] = true;
    DRAG_TRANSITIONS[STATES.IN_PROGRESS + '_' + STATES.ON_HOLD]   = true;
    // ON_HOLD(6) から
    DRAG_TRANSITIONS[STATES.ON_HOLD + '_' + STATES.IN_PROGRESS] = true;
    DRAG_TRANSITIONS[STATES.ON_HOLD + '_' + STATES.ASSIGNED]    = true;

    // 遷移成功メッセージ
    var TRANSITION_MESSAGES = {};
    TRANSITION_MESSAGES[STATES.NEW       + '_' + STATES.ASSIGNED]    = '受付済みにしました';
    TRANSITION_MESSAGES[STATES.NEW       + '_' + STATES.IN_PROGRESS] = '対応を開始しました';
    TRANSITION_MESSAGES[STATES.NEW       + '_' + STATES.ON_HOLD]     = '保留にしました';
    TRANSITION_MESSAGES[STATES.SUBMITTED + '_' + STATES.ASSIGNED]    = '受付済みにしました';
    TRANSITION_MESSAGES[STATES.SUBMITTED + '_' + STATES.IN_PROGRESS] = '対応を開始しました';
    TRANSITION_MESSAGES[STATES.SUBMITTED + '_' + STATES.ON_HOLD]     = '保留にしました';
    TRANSITION_MESSAGES[STATES.ASSIGNED  + '_' + STATES.IN_PROGRESS] = '対応を開始しました';
    TRANSITION_MESSAGES[STATES.ASSIGNED  + '_' + STATES.ON_HOLD]     = '保留にしました';
    TRANSITION_MESSAGES[STATES.IN_PROGRESS + '_' + STATES.COMPLETED] = '完了しました';
    TRANSITION_MESSAGES[STATES.IN_PROGRESS + '_' + STATES.ON_HOLD]   = '保留にしました';
    TRANSITION_MESSAGES[STATES.ON_HOLD   + '_' + STATES.IN_PROGRESS] = '対応を再開しました';
    TRANSITION_MESSAGES[STATES.ON_HOLD   + '_' + STATES.ASSIGNED]    = '受付済みに戻しました';

    // 禁止遷移時の案内メッセージ
    var DENIAL_MESSAGES = {};
    DENIAL_MESSAGES[STATES.NEW       + '_' + STATES.COMPLETED] = '先に「対応中」へ移動してから完了してください';
    DENIAL_MESSAGES[STATES.SUBMITTED + '_' + STATES.COMPLETED] = '先に「対応中」へ移動してから完了してください';
    DENIAL_MESSAGES[STATES.ASSIGNED  + '_' + STATES.COMPLETED] = '先に「対応中」へ移動してから完了してください';


    // ==========================================
    // 4列看板データ
    // ==========================================
    c.kanbanData = {
        assigned: [],      // state 1, 10, 11
        inprogress: [],    // state 2
        onhold: [],        // state 6
        done: []           // state 4
    };
    c.tacticalSearchText = '';
    c.tacticalFilterPriority = '';

    // ==========================================
    // [V9] 現在地 (Zone) 管理
    // ==========================================
    c.currentZone = c.data.current_zone || localStorage.getItem(OFFLINE_ZONE_KEY) || '';

    c.onZoneChange = function() {
        if (!c.currentZone || c.currentZone === '') return;

        // localStorage に即保存（オフライン対応）
        localStorage.setItem(OFFLINE_ZONE_KEY, c.currentZone);

        // Server に同期
        safeVolServerGet({
            action: 'update_zone',
            zone: c.currentZone
        }).then(function(r) {
            if (r && r.data && !r.data.error) {
                showToast('現在地: ' + c.currentZone, 'success');
            }
        });
    };

    c.organizeKanban = function() {
        c.kanbanData = { assigned: [], inprogress: [], onhold: [], done: [] };
        var sourceList = c.filteredList || c.data.list || [];
        var searchKey = c.tacticalSearchText ? c.tacticalSearchText.toLowerCase() : null;

        for (var ki = 0; ki < sourceList.length; ki++) {
            var item = sourceList[ki];

            // 検索フィルタ
            if (searchKey) {
                var txt = (item.number + ' ' + item.category + ' ' + (item.assigned_to_name || '') + ' ' + item.zone).toLowerCase();
                if (txt.indexOf(searchKey) === -1) continue;
            }
            // 優先度フィルタ
            if (c.tacticalFilterPriority && item.urgency !== c.tacticalFilterPriority) continue;

            var col = STATE_COLUMN[parseInt(item.state)];
            if (col && c.kanbanData[col]) {
                c.kanbanData[col].push(item);
            }
        }
    };


    // ==========================================
    // ドラッグ＆ドロップ（DOM操作ゼロ）
    // ==========================================
    c.draggedItemId = null;    // 現在ドラッグ中の sys_id
    c.hoveredColumn = null;    // 現在ホバー中の列名

    // ドラッグ開始
    c.onDragStart = function(item) {
        c.draggedItemId = item.sys_id;
    };

    // ドラッグ終了
    c.onDragEnd = function() {
        c.draggedItemId = null;
        c.hoveredColumn = null;
    };

    // 列ホバー
    c.onDragOver = function(event, columnName) {
        event.preventDefault();
        c.hoveredColumn = columnName;
    };

    // 列離脱
    c.onDragLeave = function(columnName) {
        if (c.hoveredColumn === columnName) {
            c.hoveredColumn = null;
        }
    };

    // ng-class ヘルパー
    c.isDropTarget = function(columnName) {
        return c.hoveredColumn === columnName && c.draggedItemId;
    };
    c.isDragging = function(item) {
        return c.draggedItemId === item.sys_id;
    };

    // ★ ドロップ — 楽観更新 + 二段階遷移対応
    c.onDrop = function(event, targetColumn) {
        event.preventDefault();
        c.hoveredColumn = null;

        var item = findItemBySysId(c.draggedItemId);
        c.draggedItemId = null;
        if (!item) return;

        var currentState = parseInt(item.state);
        var targetState = COLUMN_STATE[targetColumn];
        if (!targetState) return;

        // 同じ状態 → 何もしない
        if (currentState === targetState) return;

        // 遷移チェック
        var transitionKey = currentState + '_' + targetState;
        if (!DRAG_TRANSITIONS[transitionKey]) {
            var denialMsg = DENIAL_MESSAGES[transitionKey] || 'この遷移は許可されていません';
            showToast(denialMsg, 'warning', 4000);
            return;
        }

        // ─── 楽観更新 ───
        var previousState = item.state;
        item.state = targetState;
        c.organizeKanban();

        var msg = TRANSITION_MESSAGES[transitionKey] || 'ステータスを更新しました';
        showToast(msg, 'success');

        // NEW/SUBMITTED → IN_PROGRESS/ON_HOLD は二段階遷移
        // (StateValidator: 1→2 不可、1→11→2 で経由)
        var needsTwoStep = (currentState === STATES.NEW || currentState === STATES.SUBMITTED) &&
                           (targetState === STATES.IN_PROGRESS || targetState === STATES.ON_HOLD);

        if (needsTwoStep) {
            // Step 1: → ASSIGNED(11)
            safeVolServerGet({
                action: 'change_status',
                sys_id: item.sys_id,
                new_state: String(STATES.ASSIGNED)
            }).then(function(r1) {
                if (r1 && r1.data && r1.data.error) {
                    item.state = previousState;
                    c.organizeKanban();
                    showToast(r1.data.error, 'error', 5000);
                    return;
                }
                // Step 2: ASSIGNED → 目標状態
                safeVolServerGet({
                    action: 'change_status',
                    sys_id: item.sys_id,
                    new_state: String(targetState)
                }).then(function(r2) {
                    if (r2 && r2.data && r2.data.error) {
                        item.state = STATES.ASSIGNED;
                        c.organizeKanban();
                        showToast(r2.data.error, 'error', 5000);
                    }
                }, function() {
                    item.state = STATES.ASSIGNED;
                    c.organizeKanban();
                    showToast('通信エラー', 'error', 5000);
                });
            }, function() {
                item.state = previousState;
                c.organizeKanban();
                showToast('通信エラー — 元に戻しました', 'error', 5000);
            });
        } else {
            // 通常: 一段階遷移
            safeVolServerGet({
                action: 'change_status',
                sys_id: item.sys_id,
                new_state: String(targetState)
            }).then(function(r) {
                if (r && r.data && r.data.error) {
                    item.state = previousState;
                    c.organizeKanban();
                    showToast(r.data.error, 'error', 5000);
                }
            }, function() {
                item.state = previousState;
                c.organizeKanban();
                showToast('通信エラー — 元に戻しました', 'error', 5000);
            });
        }
    };
    

    c.toggleCancelledColumn = function() { c.showCancelledCol = !c.showCancelledCol; };

	
// ==========================================
// バッチ操作（一括処理）
// ==========================================
c.selectedItems = {};   // { sys_id: true/false }
c.batchMode = false;    // バッチモード ON/OFF
c.batchProcessing = false;

// バッチモード切替
c.toggleBatchMode = function() {
    c.batchMode = !c.batchMode;
    if (!c.batchMode) {
        c.selectedItems = {};  // モード終了時に選択クリア
    }
};

// 個別選択トグル
c.toggleSelect = function(item, $event) {
    if ($event) $event.stopPropagation();
    if (!c.batchMode) return;
    c.selectedItems[item.sys_id] = !c.selectedItems[item.sys_id];
    if (!c.selectedItems[item.sys_id]) delete c.selectedItems[item.sys_id];
};

// 全選択/全解除
c.selectAll = function() {
    var source = c.filteredList || c.data.list || [];
    var allSelected = c.getSelectedCount() === source.length;
    
    c.selectedItems = {};
    if (!allSelected) {
        source.forEach(function(item) {
            // 完了・キャンセル済みは除外
            if (item.state != 4 && item.state != 5) {
                c.selectedItems[item.sys_id] = true;
            }
        });
    }
};

// 選択数取得
c.getSelectedCount = function() {
    return Object.keys(c.selectedItems).length;
};

// 選択済みsys_idリスト取得
c.getSelectedIds = function() {
    return Object.keys(c.selectedItems).filter(function(id) {
        return c.selectedItems[id];
    });
};

// ★ バッチ実行: 自分に割当
c.batchAssignToMe = function() {
    var ids = c.getSelectedIds();
    if (ids.length === 0) return;
    if (c.batchProcessing) return;
    c.batchProcessing = true;
    
    safeVolServerGet({
        action: 'batch_action',
        batch_type: 'assign_to_me',
        sys_ids: ids.join(',')
    }).then(function(r) {
        c.batchProcessing = false;
        handleBatchResponse(r, '割当');
    }, function() {
        c.batchProcessing = false;
        showToast('通信エラーが発生しました', 'error', 5000);
    });
};

// ★ バッチ実行: ステータス変更
c.batchChangeStatus = function(newState) {
    var ids = c.getSelectedIds();
    if (ids.length === 0) return;
    if (c.batchProcessing) return;
    c.batchProcessing = true;
    
    safeVolServerGet({
        action: 'batch_action',
        batch_type: 'change_status',
        new_state: newState,
        sys_ids: ids.join(',')
    }).then(function(r) {
        c.batchProcessing = false;
        handleBatchResponse(r, 'ステータス変更');
    }, function() {
        c.batchProcessing = false;
        showToast('通信エラーが発生しました', 'error', 5000);
    });
};

// ★ バッチ実行: 一括キャンセル
c.batchCancel = function() {
    var ids = c.getSelectedIds();
    if (ids.length === 0) return;
    if (c.batchProcessing) return;
    c.batchProcessing = true;
    
    safeVolServerGet({
        action: 'batch_action',
        batch_type: 'cancel',
        sys_ids: ids.join(',')
    }).then(function(r) {
        c.batchProcessing = false;
        handleBatchResponse(r, 'キャンセル');
    }, function() {
        c.batchProcessing = false;
        showToast('通信エラーが発生しました', 'error', 5000);
    });
};

// バッチ結果処理
function handleBatchResponse(response, actionName) {
    if (!response || !response.data) {
        showToast('サーバーエラー', 'error', 5000);
        return;
    }
    if (response.data.error) {
        showToast(response.data.error, 'error', 5000);
        return;
    }
    
    var results = response.data.batch_results;
    if (results) {
        if (results.success > 0 && results.failed === 0) {
            showToast(results.success + '件の' + actionName + 'が完了しました', 'success');
        } else if (results.success > 0 && results.failed > 0) {
            showToast(results.success + '件成功、' + results.failed + '件失敗', 'warning', 5000);
        } else {
            showToast(actionName + 'に失敗しました', 'error', 5000);
        }
    }
    
    // 選択クリア + データ再読込
    c.selectedItems = {};
    c.server.update().then(processListItems);
}
	
// ==========================================
// バッチ操作バー — 純粋DOM注入版
// ==========================================
var batchBarEl = null;

function buildBatchBar() {
    // 既に存在する場合は一旦削除
    if (batchBarEl && batchBarEl.parentNode) {
        batchBarEl.parentNode.removeChild(batchBarEl);
    }
    
    var bar = document.createElement('div');
    bar.className = 'batch-action-bar';
    bar.id = 'kokoro-batch-bar';
    
    bar.innerHTML = 
        '<div class="batch-bar-info">' +
            '<i class="fa fa-check-square"></i> ' +
            '<strong id="batch-bar-count">0</strong> 件選択中' +
        '</div>' +
        '<div class="batch-bar-actions">' +
            '<button class="batch-btn batch-btn-assign" id="batch-btn-assign">' +
                '<i class="fa fa-user-plus"></i> 自分に割当</button>' +
            '<button class="batch-btn batch-btn-progress" id="batch-btn-progress">' +
                '<i class="fa fa-play"></i> 進行中へ</button>' +
            '<button class="batch-btn batch-btn-complete" id="batch-btn-complete">' +
                '<i class="fa fa-check"></i> 完了</button>' +
            '<button class="batch-btn batch-btn-cancel" id="batch-btn-cancel">' +
                '<i class="fa fa-times"></i> キャンセル</button>' +
        '</div>' +
        '<button class="batch-bar-close" id="batch-btn-close">' +
            '<i class="fa fa-times"></i></button>';
    
    // body に直接挿入
    document.body.appendChild(bar);
    batchBarEl = bar;
    
    // イベントバインド（$scope.$apply で Angular の digest cycle に入る）
    document.getElementById('batch-btn-assign').addEventListener('click', function() {
        $scope.$apply(function() { c.batchAssignToMe(); });
    });
    document.getElementById('batch-btn-progress').addEventListener('click', function() {
        $scope.$apply(function() { c.batchChangeStatus('2'); });
    });
    document.getElementById('batch-btn-complete').addEventListener('click', function() {
        $scope.$apply(function() { c.batchChangeStatus('4'); });
    });
    document.getElementById('batch-btn-cancel').addEventListener('click', function() {
        $scope.$apply(function() { c.batchCancel(); });
    });
    document.getElementById('batch-btn-close').addEventListener('click', function() {
        $scope.$apply(function() { c.toggleBatchMode(); });
    });
}

function updateBatchBar() {
    var count = c.getSelectedCount();
    var shouldShow = c.batchMode && count > 0;
    
    if (shouldShow && !batchBarEl) {
        buildBatchBar();
    }
    
    if (batchBarEl) {
        batchBarEl.style.display = shouldShow ? 'flex' : 'none';
        var countEl = document.getElementById('batch-bar-count');
        if (countEl) countEl.textContent = count;
        
        // processing 中はボタン無効化
        var btns = batchBarEl.querySelectorAll('.batch-btn');
        for (var i = 0; i < btns.length; i++) {
            btns[i].disabled = c.batchProcessing;
        }
    }
}

// バッチ状態が変わるたびに更新
$scope.$watch(function() {
    return c.batchMode + '_' + c.getSelectedCount() + '_' + c.batchProcessing;
}, function() {
    updateBatchBar();
});

// 画面破棄時にクリーンアップ
$scope.$on('$destroy', function() {
    if (batchBarEl && batchBarEl.parentNode) {
        batchBarEl.parentNode.removeChild(batchBarEl);
        batchBarEl = null;
    }
});

    // 時間フォーマット
    c.formatTime24h = function(createdOn) {
        if (!createdOn) return '--:--';
        try {
            var date = new Date(createdOn);
            if (isNaN(date.getTime())) return '--:--';
            var now = new Date();
            var diffMs = now - date;
            var diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays > 0) {
                var h = ('0' + date.getHours()).slice(-2);
                var m = ('0' + date.getMinutes()).slice(-2);
                return diffDays + '日前 ' + h + ':' + m;
            } else {
                var diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours > 0) return diffHours + '時間前';
                var diffMinutes = Math.floor(diffMs / (1000 * 60));
                return diffMinutes + '分前';
            }
        } catch (e) { return '--:--'; }
    };

    // リスト処理（時間変換＋AI信頼化＋カンバン再構成）
    function processListItems() {
        var processItem = function(item) {
            item.time_24h = c.formatTime24h(item.created_on);
            if (item.ai_analysis) {
                item.trusted_ai = $sce.trustAsHtml(item.ai_analysis);
            }
        };

        if (c.data.list) c.data.list.forEach(processItem);
        if (c.data.myTasks) c.data.myTasks.forEach(processItem);
        if (c.data.myRequests) c.data.myRequests.forEach(processItem);
        c.organizeKanban();
    }
    processListItems(); // 初回実行

    // フィルタリング
    c.filterByUrgency = function(u) { 
        c.currentFilter = {type:'urgency', value:u}; 
        c.filteredList = c.data.list.filter(function(i){return i.urgency===u;}); 
        c.organizeKanban(); 
    };
    c.filterByAssignment = function(s) { 
        c.currentFilter = {type:'assignment', value:s}; 
        c.filteredList = c.data.list.filter(function(i){return s==='unassigned' ? !i.assigned_to_id : !!i.assigned_to_id;}); 
        c.organizeKanban(); 
    };
    c.clearFilters = function() { 
        c.currentFilter = null; 
        c.filteredList = null; 
        c.organizeKanban(); 
    };

    // ============================================================
    // 4. スタイル注入 (Style Injection)
    // ============================================================
    function injectStyles() {
        var styleId = 'kokoro-force-fix-v45'; 
        if (document.getElementById(styleId)) return;

        var css = '';
        css += 'nav, header, footer, .sp-page-header, .navbar { display: none !important; } ';
        css += '.sp-page-row-options, .u_p_floating_container, .sn-chat-overlay, .theme-picker, .icon-palette { display: none !important; opacity: 0 !important; pointer-events: none !important; }';
        css += '.kokoro-volunteer-container { position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 1000 !important; background: #f4f4f4 !important; overflow: hidden !important; padding: 0 !important; margin: 0 !important; display: flex !important; flex-direction: column !important; }';
        css += '.board-container { width: 100% !important; height: 100% !important; flex: 1 !important; padding: 20px !important; overflow-y: auto !important; box-sizing: border-box !important; max-width: none !important; margin: 0 !important; }';
        css += '.view-dashboard, .view-tactical, .view-mine, .view-requests, .card-section { width: 100% !important; max-width: none !important; }';
        css += '.card-grid, .task-grid { width: 100% !important; display: grid !important; justify-content: start !important; }';
        css += '.zen-sidebar { position: fixed !important; top: 0 !important; left: 0 !important; width: 280px !important; height: 100vh !important; background-color: #ffffff !important; background: #ffffff !important; z-index: 2000 !important; box-shadow: 5px 0 25px rgba(0,0,0,0.5) !important; }';
        css += '.dossier-bar-track { overflow: hidden !important; }';

        var style = document.createElement('style');
        style.id = styleId;
        style.appendChild(document.createTextNode(css));
        document.head.appendChild(style); 
    }

    function runSniper() {
        var windowHeight = $window.innerHeight;
        var allElements = document.body.getElementsByTagName('*');
        for (var i = 0; i < allElements.length; i++) {
            var el = allElements[i];
            if (el.tagName === 'SCRIPT' || el.tagName === 'STYLE' || el.tagName === 'LINK') continue;
            if (el.classList.contains('kokoro-volunteer-container') || el.closest('.kokoro-volunteer-container')) continue;
            if (el.classList.contains('modal') || el.closest('.modal') || el.classList.contains('modal-backdrop')) continue;
            if (el.classList.contains('zen-sidebar') || el.closest('.zen-sidebar')) continue;
            if (el.classList.contains('operator-modal-overlay') || el.closest('.operator-modal-overlay')) continue;
            if (el.getAttribute('ng-click')) continue; 
            if (el.classList.contains('fa-bars') || el.classList.contains('fa-times')) continue;

            var rect = el.getBoundingClientRect();
            if (rect.width > 0 && rect.height > 0 && rect.width < 100 && rect.height < 100) {
                var distBottom = windowHeight - rect.bottom;
                var distLeft = rect.left;
                if ((distBottom >= 0 && distBottom < 120) || (distLeft >= 0 && distLeft < 120)) {
                    if (getComputedStyle(el).position === 'fixed') {
                          el.style.setProperty('display', 'none', 'important');
                    }
                }
            }
        }
    }
    
    injectStyles();
    var sniperInterval = $interval(runSniper, 2000);

    // ============================================================
    // 5. インタラクション (Interaction)
    // ============================================================
    c.view = 'dashboard';
    c.showSidebar = false;
	c.view = 'dashboard';
    c.showSidebar = false;

    // ==========================================
    // [V8] タブ矢印キーナビゲーション (Adapted for c.view)
    // ==========================================
    var TAB_ORDER = ['dashboard', 'tactical', 'mine', 'comms'];
    c.onTabKeydown = function($event) {
        var key = $event.key;
        if (key !== 'ArrowLeft' && key !== 'ArrowRight' && key !== 'Home' && key !== 'End') return;
        $event.preventDefault();
        
        var currentIdx = TAB_ORDER.indexOf(c.view);
        var newIdx = currentIdx;
        
        if (key === 'ArrowRight') { newIdx = (currentIdx + 1) % TAB_ORDER.length; }
        else if (key === 'ArrowLeft') { newIdx = (currentIdx - 1 + TAB_ORDER.length) % TAB_ORDER.length; }
        else if (key === 'Home') { newIdx = 0; }
        else if (key === 'End') { newIdx = TAB_ORDER.length - 1; }
        
        c.view = TAB_ORDER[newIdx];

        $timeout(function() {
            var el = document.getElementById('tab-' + TAB_ORDER[newIdx]);
            if (el) el.focus();
        }, 50);
    };

    // ==========================================
    // [V8] カードキーボードハンドラー
    // ==========================================
    c.onCardKeydown = function($event, item) {
        if ($event.key === 'Enter' || $event.key === ' ') {
            $event.preventDefault();
            if (c.batchMode) {
                c.toggleSelect(item, $event);
            } else {
                c.openModal(item);
            }
        }
    };
    c.toggleSidebar = function() { c.showSidebar = !c.showSidebar; };
    c.currentTime = '';

    function updateSystemTime() {
        var now = new Date();
        c.currentTime = ('0' + now.getHours()).slice(-2) + ':' + ('0' + now.getMinutes()).slice(-2) + ':' + ('0' + now.getSeconds()).slice(-2);
    }
    updateSystemTime();
    var timeInterval = $interval(updateSystemTime, 1000);
    
    c.goToUserView = function() {
    $window.location.href = '/sp?id=kokoro_user'; 
};
	

// ==========================================
// Toast 通知システム
// ==========================================
c.toasts = [];
var toastIdCounter = 0;

function showToast(message, type, duration) {
    type = type || 'info';        // info, success, error, warning
    duration = duration || 3500;  // 默认3.5秒

    var toast = {
        id: ++toastIdCounter,
        message: message,
        type: type,
        visible: true
    };

    $timeout(function() {
        c.toasts.push(toast);
    });

    // 自动消失
    $timeout(function() {
        toast.visible = false;
        // 动画结束后移除
        $timeout(function() {
            var idx = c.toasts.indexOf(toast);
            if (idx > -1) c.toasts.splice(idx, 1);
        }, 400);
    }, duration);

    // [V8] スクリーンリーダーに通知
    var liveRegion = document.getElementById('sr-live-region');
    if (liveRegion) {
        liveRegion.textContent = message;
    }

    return toast;
}

// 手动关闭
c.dismissToast = function(toast) {
    toast.visible = false;
    $timeout(function() {
        var idx = c.toasts.indexOf(toast);
        if (idx > -1) c.toasts.splice(idx, 1);
    }, 400);
};
	
// ==========================================
// [V3] Client 側プリバリデーション
// ==========================================
var CLIENT_RULES = {
    'add_comment': {
        validate: function(params) {
            if (!params.message || !params.message.trim()) {
                return 'コメントを入力してください';
            }
            if (params.message.length > 4000) {
                return 'コメントは4000文字以内です';
            }
            return null;
        }
    },
    'send_broadcast': {
        validate: function(params) {
            if (!params.title || !params.title.trim()) {
                return 'タイトルを入力してください';
            }
            if (params.title.length > 200) {
                return 'タイトルは200文字以内です';
            }
            if (params.body && params.body.length > 4000) {
                return '本文は4000文字以内です';
            }
            return null;
        }
    },
    'batch_action': {
        validate: function(params) {
            if (!params.sys_ids) {
                return '操作対象を選択してください';
            }
            var ids = params.sys_ids.split(',').filter(function(id) { return id.trim(); });
            if (ids.length === 0) {
                return '操作対象を選択してください';
            }
            if (ids.length > 20) {
                return '一括操作は最大20件です';
            }
            return null;
        }
    }
};

function validateBeforeSend(action, params) {
    var rule = CLIENT_RULES[action];
    if (!rule) return null;
    return rule.validate(params);
}

// ==========================================
// CSRF 安全请求包装 + 乐观锁 + 预验证 (V3)
// ==========================================
var volCsrfToken = c.data.csrf_token || '';

    // ==========================================
    // [V9] Offline Queue
    // ==========================================
    var OFFLINE_QUEUE_KEY = 'kokoro_vol_offline_queue';
    var OFFLINE_ZONE_KEY = 'kokoro_vol_zone';

    c.isOnline = navigator.onLine;
    c.offlineQueueCount = 0;

    // --- キュー操作 ---
    function getOfflineQueue() {
        try {
            var raw = localStorage.getItem(OFFLINE_QUEUE_KEY);
            return raw ? JSON.parse(raw) : [];
        } catch (e) {
            return [];
        }
    }

    function saveOfflineQueue(queue) {
        try {
            localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
            c.offlineQueueCount = queue.length;
        } catch (e) {
            // localStorage 容量超過時 → 古い項目を削除
            if (queue.length > 1) {
                queue.shift();
                saveOfflineQueue(queue);
            }
        }
    }

    function enqueueOfflineAction(params) {
        var queue = getOfflineQueue();
        queue.push({
            params: params,
            timestamp: Date.now(),
            id: Date.now() + '_' + Math.random().toString(36).substr(2, 6)
        });
        saveOfflineQueue(queue);
        showToast('オフラインキューに追加 (' + queue.length + '件待ち)', 'info');
    }

    // --- リプレイ ---
    var isReplaying = false;

    function replayOfflineQueue() {
        var queue = getOfflineQueue();
        if (queue.length === 0 || isReplaying) return;

        isReplaying = true;
        showToast('キュー再送中... (' + queue.length + '件)', 'info');

        function processNext() {
            var queue = getOfflineQueue();
            if (queue.length === 0) {
                isReplaying = false;
                showToast('キュー再送完了', 'success');
                c.offlineQueueCount = 0;
                return;
            }

            var item = queue[0];

            // 古すぎるエントリは破棄（1時間以上前）
            if (Date.now() - item.timestamp > 3600000) {
                queue.shift();
                saveOfflineQueue(queue);
                processNext();
                return;
            }

            safeVolServerGet(item.params).then(function(r) {
                // 成功 → キューから除去
                var q = getOfflineQueue();
                q.shift();
                saveOfflineQueue(q);
                $timeout(processNext, 300); // 次を処理（レート制限配慮）
            }, function() {
                // 失敗 → 再びオフラインかも → 中断
                isReplaying = false;
                showToast('再送中断 — 接続を確認', 'warning');
            });
        }

        processNext();
    }

    // --- Online/Offline イベント ---
    function onOnlineStatusChange() {
        $scope.$apply(function() {
            c.isOnline = navigator.onLine;
            if (c.isOnline) {
                showToast('接続回復', 'success');
                $timeout(function() {
                    replayOfflineQueue();
                }, 1000);
            } else {
                showToast('オフライン — 操作はキューに保存されます', 'warning', 5000);
            }
        });
    }

    $window.addEventListener('online', onOnlineStatusChange);
    $window.addEventListener('offline', onOnlineStatusChange);

    // クリーンアップ
    $scope.$on('$destroy', function() {
        $window.removeEventListener('online', onOnlineStatusChange);
        $window.removeEventListener('offline', onOnlineStatusChange);
    });

    // 初期化: キュー残量チェック
    c.offlineQueueCount = getOfflineQueue().length;
    if (c.isOnline && c.offlineQueueCount > 0) {
        $timeout(function() { replayOfflineQueue(); }, 2000);
    }

    // ==========================================
    // [V9] 手動キュー操作
    // ==========================================
    c.clearOfflineQueue = function() {
        localStorage.removeItem(OFFLINE_QUEUE_KEY);
        c.offlineQueueCount = 0;
        showToast('キューをクリアしました', 'info');
    };

    c.retryOfflineQueue = function() {
        if (c.isOnline) {
            replayOfflineQueue();
        } else {
            showToast('オフラインのため再送できません', 'warning');
        }
    };


function safeVolServerGet(params) {
    // [V3] Client 側プリバリデーション
    var clientError = validateBeforeSend(params.action, params);
    if (clientError) {
        showToast(clientError, 'warning');
        // 安全拦截：返回一个模拟的 Promise 触发 error callback，防止后续报错
        return {
            then: function(onSuccess, onError) { if (onError) onError(clientError); return this; },
            catch: function(onError) { if (onError) onError(clientError); return this; },
            finally: function(cb) { if (cb) cb(); return this; }
        };
    }

    params.csrf_token = volCsrfToken;
    
    // ★ 乐观锁: 自动附加 sys_mod_count
    if (params.sys_id) {
        var foundItem = findItemBySysId(params.sys_id);
        if (foundItem && foundItem.sys_mod_count !== undefined) {
            params.sys_mod_count = foundItem.sys_mod_count;
        }
    }

    // ==========================================
    // [V9] オフライン時はキューに入れる
    // ==========================================
    if (!navigator.onLine) {
        // 読み取り専用操作はキューしない
        var readOnlyActions = ['get_volunteers', 'get_details', 'inventory_check'];
        if (readOnlyActions.indexOf(params.action) === -1) {
            enqueueOfflineAction(params);
            // 楽観更新のため解決済み Promise(モック) を返す ($q 未定義エラー回避)
            return {
                then: function(onSuccess) { if (onSuccess) onSuccess({ data: { queued: true, success: true } }); return this; },
                catch: function() { return this; },
                finally: function(cb) { if (cb) cb(); return this; }
            };
        } else {
            showToast('オフラインのため取得できません', 'warning');
            return {
                then: function(onSuccess, onError) { if (onError) onError('offline'); return this; },
                catch: function(onError) { if (onError) onError('offline'); return this; },
                finally: function(cb) { if (cb) cb(); return this; }
            };
        }
    }
    
    return c.server.get(params).then(function(response) {
        // ★ 冲突检测: 如果服务器返回冲突标志，自动刷新
        if (response && response.data && response.data.concurrency_conflict) {
            handleConcurrencyConflict(response.data);
        }
        return response;
    });
}

// 辅助: 根据 sys_id 查找工单
function findItemBySysId(sysId) {
    if (!sysId) return null;
    var lists = [c.data.list, c.data.myTasks, c.data.myRequests];
    for (var li = 0; li < lists.length; li++) {
        if (!lists[li]) continue;
        for (var ii = 0; ii < lists[li].length; ii++) {
            if (lists[li][ii].sys_id === sysId) return lists[li][ii];
        }
    }
    return null;
}

// ★ 冲突处理: 提示 + 自动刷新
function handleConcurrencyConflict(responseData) {
    showToast('他のオペレーターが先にこの工単を更新しました。最新データを読み込みます...', 'warning', 5000);
    
    // 1.5秒後自動刷新看板数据
    $timeout(function() {
        c.server.update().then(function() {
            processListItems();
            showToast('最新データを読み込みました', 'success');
        });
    }, 1500);
}

    // ============================================================
    // 6. タスク詳細・モダール (Task Modal)
    // ============================================================
    // ============================================================
    // 6. タスク詳細・モダール (Task Modal)
    // ============================================================
    var previousFocusElement = null;

    c.onModalKeydown = function($event) {
        if ($event.key === 'Escape') {
            var closeBtn = document.querySelector('.header-close');
            if (closeBtn) closeBtn.click();
            return;
        }
        if ($event.key === 'Tab') {
            var modal = $event.currentTarget;
            var focusable = modal.querySelectorAll('button, [tabindex="0"], input, textarea, select, a[href]');
            if (focusable.length === 0) return;

            var first = focusable[0];
            var last = focusable[focusable.length - 1];

            if ($event.shiftKey && document.activeElement === first) {
                $event.preventDefault();
                last.focus();
            } else if (!$event.shiftKey && document.activeElement === last) {
                $event.preventDefault();
                first.focus();
            }
        }
    };

    c.openModal = function(item) {
        previousFocusElement = document.activeElement;

        if (!c.data.volunteers || c.data.volunteers.length === 0) {
            c.server.get({ action: 'get_volunteers' }).then(function(r) {
                if (r && r.data && r.data.volunteers) {
                    c.data.volunteers = r.data.volunteers;
                    angular.forEach(c.data.volunteers, function(vol) {
                        var rawLoad = (vol.open_tasks / 10) * 100;
                        vol.load = rawLoad.toFixed(1);
                    });
                }
            });
        }

        var modalInstance = $uibModal.open({
            templateUrl: 'volunteerModalTemplate',
            scope: $scope,
            size: 'lg',
            backdrop: 'static',
            windowClass: 'kokoro-modal-window'
        });

        // [V8] モーダル内へのフォーカス移動
        $timeout(function() {
            var modal = document.querySelector('[role="dialog"]');
            if (modal) {
                var firstFocusable = modal.querySelector('button, [tabindex="0"], input, textarea, select, a[href]');
                if (firstFocusable) firstFocusable.focus();
            }
        }, 100);

        $scope.item = angular.copy(item);
        $scope.c = c;
        $scope.newComment = '';
        $scope.statusMenuOpen = false;
        
        $scope.toggleStatusMenu = function($event) { if ($event) $event.stopPropagation(); $scope.statusMenuOpen = !$scope.statusMenuOpen; };
        $window.onclick = function() { if ($scope.statusMenuOpen) $timeout(function() { $scope.statusMenuOpen = false; }); };
        $scope.cancel = function() { modalInstance.dismiss('cancel'); };

        $scope.assignToMe = function(item) {
            safeVolServerGet({ action: 'assign_to_me', sys_id: item.sys_id }).then(function(r) {
                handleServerResponse(r, function() {
                    item.assigned_to_id = c.data.user_id; item.assigned_to_name = c.data.user_name;
                    $scope.item.assigned_to_id = c.data.user_id; $scope.item.assigned_to_name = c.data.user_name;
                    if (item.state == 1 || item.state == 10) { item.state = 11; $scope.item.state = 11; }
                    showSuccess('担当者に設定しました');
                    c.server.update().then(processListItems);
                });
            });
        };

        $scope.changeStatus = function(item, newState) {
            var ns = parseInt(newState);
            if (ns === 11 && !item.assigned_to_id) { $scope.assignToMe(item); return; }
            if (ns === 2 && !item.assigned_to_id) { showError('先に担当者を設定してください'); return; }
            
            safeVolServerGet({ action: 'change_status', sys_id: item.sys_id, new_state: newState }).then(function(r) {
                if (handleServerResponse(r, function() {
                    item.state = ns; $scope.item.state = ns; $scope.statusMenuOpen = false;
                    showSuccess('ステータスを更新しました');
                    c.server.update().then(processListItems);
                    if (ns === 4 || ns === 5) { $timeout(function() { modalInstance.close(); }, 1000); }
                }));
            });
        };

        $scope.postComment = function(item) {
            if (!$scope.newComment || !$scope.newComment.trim()) return;
            safeVolServerGet({ action: 'add_comment', sys_id: item.sys_id, message: $scope.newComment }).then(function(r) {
                handleServerResponse(r, function() {
                    if (!item.history) item.history = [];
                    item.history.unshift({ user: c.data.user_name || 'Me', text: $scope.newComment, date: new Date().toLocaleString() });
                    $scope.item.history = item.history; $scope.newComment = '';
                    showSuccess('コメントを追加しました');
                });
            });
        };
        
        $scope.triggerAutoAssign = function(item) { c.triggerAutoAssign(item.sys_id, true); };
        
        modalInstance.result.finally(function() { 
            c.server.update().then(processListItems); 
            // [V8] フォーカス復元
            if (previousFocusElement) {
                $timeout(function() { previousFocusElement.focus(); }, 50);
                previousFocusElement = null;
            }
        });
    };
        

    // ============================================================
    // 7. アクションロジック (Assign, Location, etc.)
    // ============================================================
    c.triggerAutoAssign = function(sysId, forceReassign) {
        if (!sysId) return;
        c.server.get({ action: 'trigger_auto_assign', sys_id: sysId, force_reassign: forceReassign || false })
        .then(function(response) {
            if (response.data.success) {
                showToast('自動割当完了: ' + response.data.assigned_to, 'success');
                c.server.update().then(processListItems);
            } else {
                showToast('自動割当失敗: ' + (response.data.error || '志願者が見つかりません'), 'error', 5000);
            }
        });
    };

    c.assignTask = function(ticketId, targetUserId) {
        if (!ticketId || !targetUserId) return;
        c.server.get({ action: 'assign_task', ticket_id: ticketId, target_user: targetUserId }).then(function(r) {
            if (r && r.data && r.data.error) {
                showToast(r.data.error, 'error', 5000);
            } else {
                showToast('タスクを分配しました', 'success');
                c.server.update().then(processListItems);
            }
        });
    };

    c.updateMyLocation = function(zone) {
        if (!zone) return;
        safeVolServerGet({ action: 'update_location', zone: zone }).then(function(response) {
            if (response.data.success) {
                c.volunteerStatus.currentZone = zone;
                showToast(response.data.message || '現在地を更新しました', 'success');
            }
        });
    };

    c.toggleAvailability = function() {
        var newStatus = !c.volunteerStatus.isOnline;
        c.server.get({ action: 'set_availability', available: newStatus }).then(function(response) {
            if (response.data.success) {
                c.volunteerStatus.isOnline = newStatus;
                showToast(response.data.message, 'info');
            }
        });
    };
    
    c.refreshMonitoringData = function() {
        c.server.update().then(function() { 
            // データ更新時にもHTMLを信頼化
            if (c.data.global_ai_analysis) c.trusted_global_ai = $sce.trustAsHtml(c.data.global_ai_analysis);
            processListItems();
            showToast('監視データを更新しました', 'info');
        });
    };

    // ============================================================
    // 8. オペレーター管理 (Operator Modal)
    // ============================================================
    c.showUserModal = false;
    c.selectedVol = {};

    c.openUserModal = function(vol) {
        if (!vol) return;
        c.selectedVol = vol;
        c.showUserModal = true;
    };

    c.closeUserModal = function() {
        c.showUserModal = false;
        c.selectedVol = {}; 
    };

    // ==========================================
    // 修复：前端提交专长变更
    // ==========================================
    c.updateCapability = function() {
        if (!c.selectedVol) return;
        
        // 发送更新请求给后端 (走 V3 安全验证通道)
        safeVolServerGet({
            action: 'specialty',
            sys_id: c.selectedVol.sys_id, 
            new_cap: c.selectedVol.capability
        }).then(function(response) {
            if (response.data && response.data.error) {
                showToast("保存失敗: " + response.data.error, 'error');
            } else {
                showToast('Operator capability updated.', 'success');
                // 同步更新本地列表视图，避免需刷新页面才显示
                var targetVol = c.data.volunteers.find(function(v) { return v.sys_id === c.selectedVol.sys_id; });
                if (targetVol) {
                    targetVol.capability = c.selectedVol.capability;
                }
            }
        });
    };

    // ============================================================
    // 9. 通信センター (Comms Center)
    // ============================================================
    c.sendBroadcast = function() {
        if (!c.broadcastTitle || !c.broadcastBody) return;
        if (c._broadcastSending) return;
        c._broadcastSending = true;
        
       safeVolServerGet({ 
            action: 'send_broadcast', 
            msg_type: c.broadcastType || 'announcement', 
            title: c.broadcastTitle, 
            body: c.broadcastBody 
        }).then(function(r) {
            c._broadcastSending = false;
            if (r.data.success) {
                showToast('放送を送信しました', 'success');
                c.data.announcements.unshift({
                    sys_id: r.data.new_id || 'temp_' + Date.now(),
                    type: c.broadcastType,
                    title: c.broadcastTitle,
                    body: c.broadcastBody,
                    author: c.data.user_name,
                    time_ago: '今',
                    read_count: 0
                });
                c.broadcastTitle = '';
                c.broadcastBody = '';
            } else {
                showToast(r.data.error || '送信失敗', 'error', 5000);
            }
        }, function() {
            c._broadcastSending = false;
            showToast('通信エラーが発生しました', 'error', 5000);
        });
    };

    c.getFilteredComms = function() {
        if (!c.data.announcements) return [];
        if (!c.commsFilter) return c.data.announcements;
        return c.data.announcements.filter(function(msg) { return msg.type === c.commsFilter; });
    };

    c.openCommDetail = function(msg) {
        if (!msg) return;
        c.selectedComm = msg;
        c.showCommDetail = true;
    };
    
    c.closeCommDetail = function() {
        c.showCommDetail = false;
        c.selectedComm = null;
    };

    // 削除機能
    c.deleteComm = function(msg, $event) {
        if ($event) $event.stopPropagation();
        c.deleteTarget = msg;
        c.showDeleteConfirm = true;
    };

    c.confirmDelete = function() {
        var msg = c.deleteTarget;
        if (!msg) return;
        safeVolServerGet({ action: 'delete_broadcast', sys_id: msg.sys_id }).then(function(r) {
            if (r.data.success) {
                var index = c.data.announcements.indexOf(msg);
                if (index > -1) c.data.announcements.splice(index, 1);
                showToast('メッセージを削除しました', 'success');
                if (c.selectedComm && c.selectedComm.sys_id === msg.sys_id) c.closeCommDetail();
            } else {
                showToast(r.data.error || '削除失敗', 'error', 5000);
            }
        });
        c.cancelDelete();
    };

    c.cancelDelete = function() {
        c.showDeleteConfirm = false;
        c.deleteTarget = null;
    };
	
	// ============================================================
// 10.5 DEPLOYMENT STATUS HELPERS
// ============================================================

c.getOnlineCount = function() {
    if (!c.data.volunteers) return 0;
    return c.data.volunteers.filter(function(v) { 
        return v.status_class === 'online'; 
    }).length;
};

c.getBusyCount = function() {
    if (!c.data.volunteers) return 0;
    return c.data.volunteers.filter(function(v) { 
        return v.status_class === 'busy'; 
    }).length;
};

c.getOfflineCount = function() {
    if (!c.data.volunteers) return 0;
    return c.data.volunteers.filter(function(v) { 
        return v.status_class === 'offline'; 
    }).length;
};

    // ============================================================
    // 10. 共通ヘルパー (Helpers)
    // ============================================================
    function showSuccess(msg) { showToast(msg, 'success'); }
    function showError(msg) { showToast(msg || 'エラーが発生しました', 'error', 5000); }
    function handleServerResponse(response, successCallback) {
        if (!response || !response.data) { showError('サーバーエラー'); return false; }
        if (response.data.error) { showError(response.data.error); return false; }
        if (successCallback) successCallback(response.data);
        return true;
    }

    c.getHealthStatusDisplay = function() {
        var score = c.data.overallHealth.score;
        if (score >= 90) return { text: 'NOMINAL', class: 'nominal', color: '#34c759' };
        if (score >= 70) return { text: 'WARNING', class: 'warning', color: '#ff9500' };
        return { text: 'CRITICAL', class: 'critical', color: '#ff3b30' };
    };

    c.getActivityIcon = function(activityName) {
        var iconMap = { 'Wish_Created': 'fa-plus-circle', 'Wish_Submitted': 'fa-paper-plane', 'Wish_Assigned': 'fa-user-plus', 'Wish_Completed': 'fa-check-circle', 'SLA_Breached': 'fa-exclamation-triangle' };
        return iconMap[activityName] || 'fa-circle';
    };
    c.formatActivityName = function(name) { return name ? name.replace(/_/g, ' ') : 'Unknown'; };
    c.getSLABarColor = function(sla) {
        if (!sla) return '#888';
        if (sla.is_breached || sla.status === 'critical') return '#ff3b30';
        if (sla.status === 'warning') return '#ff9500';
        return '#34c759';
    };

    // ============================================================
    // 11. リアルタイム監視 (Watchers)
    // ============================================================
    spUtil.recordWatch($scope, 'x_1821654_kokoro_0_silent_wish', '', function(name, data) {
        c.server.update().then(function() { 
            // アップデート時にAI分析を再信頼化
            if (c.data.global_ai_analysis) c.trusted_global_ai = $sce.trustAsHtml(c.data.global_ai_analysis);
            processListItems(); 
        });
    });
    
    spUtil.recordWatch($scope, 'x_1821654_kokoro_0_kokoro_inventory', '', function() {
        c.server.update();
    });

    var slaUpdateInterval = $interval(function() {
        updateSLAForList(c.data.list);
        updateSLAForList(c.data.myTasks);
        updateSLAForList(c.data.myRequests);
    }, 30000);

    function updateSLAForList(list) {
        if (!list) return;
        angular.forEach(list, function(item) {
            if (!item.sla || item.sla.is_stopped || item.state == 4 || item.state == 5) return;
            item.sla.elapsed = (item.sla.elapsed || 0) + 0.5;
            item.sla.remaining = Math.max(0, item.sla.target - item.sla.elapsed);
            item.sla.percentage = Math.min(100, Math.round((item.sla.elapsed / item.sla.target) * 100));
            if (item.sla.elapsed > item.sla.target) {
                item.sla.status = 'critical';
                item.sla.is_breached = true;
            }
        });
    }

    $scope.$on('$destroy', function() {
        if (timeInterval) $interval.cancel(timeInterval);
        if (slaUpdateInterval) $interval.cancel(slaUpdateInterval);
        if (sniperInterval) $interval.cancel(sniperInterval);
    });

    // 詳細表示トグル
    c.toggleDetail = function(item) {
        c.selectedTask = (c.selectedTask === item) ? null : item;
    };
};]]></client_script>
        <controller_as>c</controller_as>
        <css>/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 0: SERVICENOW ELIMINATION - 绝对不可删除
   ═══════════════════════════════════════════════════════════════════════════════════════ */
nav, header, footer, .sp-page-header, .navbar, .polaris-header, 
.sn-polaris-nav, .sn-canvas-header, #sp-nav-bar, .sp-row-background,
.cms-header, .navpage-header, .navpage-footer {
  display: none !important;
  height: 0 !important;
  visibility: hidden !important;
}

.sn-chat-overlay, .help-button-wrapper, .sp-ac-root, .sw-session-repro-button,
button.help-button, .sn-connect-floating-wrapper, #u_chat_button, .cm-help-button,
.sp-page-row-options, .theme-picker, .sp-debug-tool, div[ng-controller="spPageRowOptions"],
a[title="Toggle Layout"], .btn-floating, .sp-icon-edit,
.guided-tour-overlay, .code-editor-container, .icon-palette, .fa-cog, 
.sp-icon-color, .sp-preview-pill, .u_p_floating_container,
[class*="intercom"], [class*="chat-widget"], [id*="chat"],
div[style*="position: fixed"][style*="bottom"][style*="right"] {
  display: none !important;
  visibility: hidden !important;
  width: 0 !important; 
  height: 0 !important;
  pointer-events: none !important;
  opacity: 0 !important;
  z-index: -9999 !important;
  position: absolute !important;
  left: -9999px !important;
}

body &gt; div[style*="position: fixed"][style*="bottom"],
body &gt; div[style*="position:fixed"][style*="bottom"],
body &gt; button[style*="position: fixed"][style*="bottom"],
body &gt; div[style*="position: fixed"][style*="left"], 
body &gt; div[style*="position:fixed"][style*="left"],
body &gt; div[style*="position: fixed"][style*="right"],
body &gt; iframe[style*="position: fixed"] {
  display: none !important;
  opacity: 0 !important;
  pointer-events: none !important;
  z-index: -9999 !important;
}

html, body {
  height: 100% !important;
  width: 100% !important;
  overflow: hidden !important;
  position: fixed !important;
  background: #0a0a0a !important;
  margin: 0 !important;
  padding: 0 !important;
  font-size: 14px !important;
}

.modal { z-index: 1050000 !important; position: fixed !important; }
.modal-backdrop { z-index: 1049999 !important; background-color: rgba(0,0,0,0.95) !important; }
.modal-dialog { z-index: 1050001 !important; }

/* Monitoring Panel Container */
.monitoring-panel {
    background: #fff;
    border: 1px solid #ddd;
    padding: 16px;
    margin-top: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

/* Health Gauge */
.health-gauge {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 15px 0;
}

.gauge-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 4px solid #ddd;
    background: #f8f8f8;
    transition: all 0.3s;
    flex-shrink: 0;
}

.gauge-circle.nominal {
    border-color: var(--color-success);
    background: rgba(52, 199, 89, 0.1);
}

.gauge-circle.warning {
    border-color: var(--color-warning);
    background: rgba(255, 149, 0, 0.1);
}

.gauge-circle.critical {
    border-color: var(--color-critical);
    background: rgba(255, 59, 48, 0.1);
    animation: pulse-critical 1s ease-in-out infinite;
}

@keyframes pulse-critical {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.gauge-value {
    font-family: var(--font-tech);
    font-size: 28px;
    font-weight: 900;
    color: var(--text-primary);
}

.gauge-label {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-tertiary);
    letter-spacing: 1px;
}

.gauge-info {
    flex: 1;
}

.gauge-status {
    font-family: var(--font-header);
    font-size: 16px;
    font-weight: 800;
    letter-spacing: 2px;
    margin-bottom: 8px;
}

.gauge-components {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-family: var(--font-mono);
    font-size: 11px;
}

.gauge-components span {
    font-weight: 600;
}

/* PM Metrics Grid */
.pm-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.pm-metric-item {
    text-align: center;
    padding: 12px 8px;
    background: #f8f8f8;
    border-left: 3px solid #000;
}

.pm-metric-label {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-tertiary);
    letter-spacing: 1px;
    margin-bottom: 6px;
}

.pm-metric-value {
    font-family: var(--font-tech);
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
}

/* Activity Distribution */
.activity-distribution {
    margin: 15px 0;
}

.dist-title {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-tertiary);
    letter-spacing: 1px;
    margin-bottom: 10px;
}

.dist-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    font-size: 13px;
}

.dist-item:last-child {
    border-bottom: none;
}

.dist-item i {
    color: var(--accent-primary);
    width: 20px;
    text-align: center;
}

.dist-name {
    flex: 1;
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dist-count {
    font-family: var(--font-tech);
    font-weight: 700;
    color: var(--text-primary);
}

/* No Data Hint */
.no-data-hint {
    text-align: center;
    padding: 20px;
    color: var(--text-tertiary);
    font-size: 13px;
}

.no-data-hint i {
    margin-right: 8px;
}

/* Alert Summary (Day5 monitoring rows — scoped to avoid clash with main .alert-row) */
.alert-summary {
    margin: 15px 0;
}

.alert-summary .alert-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: #f8f8f8;
    margin-bottom: 8px;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
}

.alert-summary .alert-row:last-child {
    margin-bottom: 0;
}

.alert-summary .alert-row i {
    color: var(--text-tertiary);
    width: 18px;
    text-align: center;
}

.alert-summary .alert-row span:first-of-type {
    flex: 1;
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 1px;
}

.alert-count {
    font-family: var(--font-tech);
    font-weight: 800;
    font-size: 16px;
}

.alert-summary .alert-row.critical {
    background: rgba(255, 59, 48, 0.1);
    border-left: 3px solid var(--color-critical);
}

.alert-summary .alert-row.critical i,
.alert-summary .alert-row.critical .alert-count {
    color: var(--color-critical);
}

.alert-summary .alert-row.warning {
    background: rgba(255, 149, 0, 0.1);
    border-left: 3px solid var(--color-warning);
}

.alert-summary .alert-row.warning i,
.alert-summary .alert-row.warning .alert-count {
    color: var(--color-warning);
}

/* Recent Audit */
.recent-audit {
    margin: 15px 0;
}

.audit-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px dashed #eee;
    font-size: 12px;
}

.audit-item:last-child {
    border-bottom: none;
}

.audit-action {
    color: var(--text-secondary);
    font-weight: 600;
}

.audit-user {
    color: var(--text-tertiary);
    font-family: var(--font-mono);
    font-size: 11px;
}

/* Refresh Button */
.refresh-btn {
    width: 100%;
    padding: 12px;
    background: #000;
    color: #fff;
    border: none;
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 15px;
}

.refresh-btn:hover {
    background: #333;
}

.refresh-btn i {
    margin-right: 8px;
}

/* Day5 Responsive */
@media (max-width: 400px) {
    .pm-metrics {
        grid-template-columns: 1fr;
    }
    
    .health-gauge {
        flex-direction: column;
        text-align: center;
    }
    
    .gauge-components {
        justify-content: center;
    }
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 1: KOKORO OS // VISUAL CORE [ARCHITECTURE: DEEP_SHELTER_PROTOCOL]
   ═══════════════════════════════════════════════════════════════════════════════════════ */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=JetBrains+Mono:wght@400;700&amp;display=swap');

.kokoro-volunteer-container {
    /* ─── COLOR SYSTEM: DEEP SPACE (深空基底) ─── */
    --bg-base: #090B10;             /* 极夜黑：底层画布，吸收屏幕眩光 */
    --bg-surface: #12151C;          /* 数据面板底色 */
    --bg-surface-elevated: #1A1E27; /* 悬浮组件/交互面 */
    --bg-glass: rgba(18, 21, 28, 0.75); /* 亚克力毛玻璃材质，用于Header或浮窗 */
    
    /* ─── BORDERS (微米级边缘) ─── */
    --border-subtle: 1px solid rgba(255, 255, 255, 0.04);
    --border-default: 1px solid rgba(255, 255, 255, 0.08);
    --border-strong: 1px solid rgba(255, 255, 255, 0.15);
    --border-focus: 1px solid #38BDF8;
    
    /* ─── TYPOGRAPHY COLOR (光感文本层级) ─── */
    --text-display: #FFFFFF;        /* 绝对焦点（如SOS, 警报数字） */
    --text-primary: #E2E8F0;        /* 核心信息，清晰无压迫感 */
    --text-secondary: #94A3B8;      /* 辅助信息、元数据 (Time, Zone) */
    --text-muted: #475569;          /* 休眠状态、背景底纹 */

    /* ─── SEMANTIC SIGNALS (高穿透力信号) ─── */
    --signal-info: #38BDF8;         /* 终端运行 / 状态蓝 */
    --signal-success: #10B981;      /* 通道正常 / 安全绿 */
    --signal-warning: #F59E0B;      /* SLA违约警告 / 琥珀黄 */
    --signal-critical: #E11D48;     /* 系统过载 / 致命红 */
    
    /* ─── TYPOGRAPHY STACK (工业级字体栈) ─── */
    --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', ui-monospace, monospace;
    
    /* ─── EFFECTS (物理深度与张力) ─── */
    --blur-glass: blur(16px);
    --shadow-flat: 0 1px 2px rgba(0, 0, 0, 0.4);
    --shadow-elevated: 0 10px 30px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.05);
    --transition-snappy: 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);

    /* ─── BASE INITIALIZATION (容器绝对控制) ─── */
    background-color: var(--bg-base);
    color: var(--text-primary);
    font-family: var(--font-ui);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    
    /* 深层雷达网格：极低的透明度，提供空间尺度感而非纯黑平涂 */
    background-image: linear-gradient(rgba(255, 255, 255, 0.015) 1px, transparent 1px),
                      linear-gradient(90deg, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
    background-size: 32px 32px;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第二部分：动画 [建筑：深层庇护所协议]
   ═══════════════════════════════════════════════════════════════════════════════════════ */
@keyframes pulse-glow {
  0%, 100% { 
    box-shadow: 0 0 8px rgba(56, 189, 248, 0.15), 0 0 16px rgba(56, 189, 248, 0.05);
    opacity: 1;
  }
  50% { 
    box-shadow: 0 0 16px rgba(56, 189, 248, 0.3), 0 0 32px rgba(56, 189, 248, 0.15);
    opacity: 0.85;
  }
}

@keyframes scanline {
  0% { transform: translateY(-100%); opacity: 0; }
  10% { opacity: 0.08; }
  90% { opacity: 0.08; }
  100% { transform: translateY(100vh); opacity: 0; }
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

@keyframes data-stream {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

@keyframes slide-in {
  from { transform: translateY(12px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes border-pulse {
  0%, 100% { border-color: var(--border-default); }
  50% { border-color: var(--border-focus); }
}

@keyframes critical-flash {
  0%, 100% { 
      background-color: rgba(225, 29, 72, 0.1); 
      border-color: var(--signal-critical); 
  }
  50% { 
      background-color: rgba(225, 29, 72, 0.25); 
      border-color: #F43F5E; 
  }
}

@keyframes bar-fill {
  from { width: 0; }
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第三部分：主容器
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.kokoro-volunteer-container {
  font-family: var(--font-ui);
  font-size: 14px !important;
  line-height: 1.5;
  position: fixed !important;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 100 !important;
  background-color: var(--bg-base);
  color: var(--text-primary);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}



/* ═══════════════════════════════════════════════════════════════════════════════════════
   第四部分：结构分隔器
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.metal-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--border-strong), transparent);
  margin: 24px 0;
  position: relative;
  border: none;
  overflow: hidden;
}

/* 废除廉价白光，改为微光扫掠效果，用于极简的数据流切割 */
.metal-divider::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.1), transparent);
  background-size: 200% 100%;
  animation: shimmer 4s cubic-bezier(0.4, 0, 0.2, 1) infinite;
}

/* 废除光污染高光，转换为低透明度功能性状态线 */
.metal-divider-glow {
  height: 1px;
  background: var(--signal-info);
  margin: 24px 0;
  box-shadow: 0 0 8px rgba(56, 189, 248, 0.2);
  opacity: 0.6;
}

/* 废除拟物 3D 效果，转换为硬核架构层级切割线 */
.metal-divider-thick {
  height: 2px;
  background: var(--bg-surface-elevated);
  border-top: var(--border-subtle);
  border-bottom: var(--border-default);
  margin: 28px 0;
}

/* ═══════════════════════════════════════════════════════════════════════════════
   GOTHAM FIX 1: 去光晕 + 薄header + 暗sidebar
   追加到CSS最末尾
   ═══════════════════════════════════════════════════════════════════════════════ */

/* 1. 杀掉vignette光晕 */
.kokoro-volunteer-container::after {
  display: none !important;
}

/* 2. Header压到32px — Palantir级别 */
.command-header {
  padding: 6px 16px !important;
  gap: 12px !important;
  min-height: 0 !important;
  background: rgba(9, 11, 16, 0.85) !important;
  border-bottom: 1px solid rgba(255,255,255,0.06) !important;
  box-shadow: none !important;
}

.logo-icon {
  width: 28px !important;
  height: 28px !important;
  font-size: 14px !important;
  clip-path: none !important;
  border-radius: 3px !important;
  background: rgba(56, 189, 248, 0.08) !important;
  border: 1px solid rgba(56, 189, 248, 0.2) !important;
}

.logo-title {
  font-size: 14px !important;
  letter-spacing: 2px !important;
  font-weight: 700 !important;
}

.logo-subtitle {
  display: none !important;
}

.command-logo {
  gap: 8px !important;
}

.system-status {
  gap: 10px !important;
  font-size: 11px !important;
}

.system-time {
  font-size: 11px !important;
  font-weight: 500 !important;
}

.version-tag {
  padding: 1px 5px !important;
  font-size: 9px !important;
}

/* 3. Nav tabs 极薄 */
.nav-tabs-custom {
  padding: 0 16px !important;
  background: var(--bg-surface) !important;
  border-bottom: 1px solid rgba(255,255,255,0.04) !important;
}

.nav-tabs-custom .tab {
  padding: 8px 16px !important;
  font-size: 11px !important;
  letter-spacing: 0.08em !important;
  font-weight: 500 !important;
}

.tab-number {
  font-size: 9px !important;
  margin-right: 4px !important;
}

/* 4. Status panel 极薄 */
.volunteer-status-panel {
  padding: 5px 16px !important;
  margin-bottom: 0 !important;
  gap: 20px !important;
  border: none !important;
  border-left: none !important;
  border-bottom: 1px solid rgba(255,255,255,0.04) !important;
  background: transparent !important;
  box-shadow: none !important;
}

.volunteer-status-panel::before {
  display: none !important;
}

.status-row {
  font-size: 11px !important;
  gap: 6px !important;
}

.status-row i {
  font-size: 11px !important;
  width: 14px !important;
}

.btn-online, .btn-offline {
  padding: 2px 10px !important;
  font-size: 9px !important;
  clip-path: none !important;
}

.zone-select, .status-row select {
  padding: 2px 6px !important;
  font-size: 10px !important;
  background: var(--bg-base) !important;
  color: var(--text-primary) !important;
  border: 1px solid rgba(255,255,255,0.08) !important;
}

/* 5. Alert strip 极薄 */
.sys-alert-strip {
  padding: 3px 16px !important;
  font-size: 10px !important;
  min-height: 0 !important;
  height: auto !important;
  background: rgba(225, 29, 72, 0.06) !important;
  border-bottom: 1px solid rgba(225, 29, 72, 0.15) !important;
  color: var(--signal-critical) !important;
}

.alert-deco {
  font-size: 8px !important;
}

.sys-btn-ghost {
  padding: 1px 6px !important;
  font-size: 8px !important;
  border-color: rgba(225, 29, 72, 0.3) !important;
  color: var(--signal-critical) !important;
}

.alert-body i {
  font-size: 11px !important;
}

.alert-text {
  font-size: 10px !important;
}

/* 6. Sidebar 深色 */
.zen-sidebar {
  background: var(--bg-surface) !important;
  border-right: 1px solid rgba(255,255,255,0.06) !important;
  box-shadow: 4px 0 20px rgba(0,0,0,0.5) !important;
}

.sidebar-head {
  background: var(--bg-base) !important;
  border-bottom: 1px solid rgba(255,255,255,0.06) !important;
}

.sb-title {
  color: var(--text-primary) !important;
}

.sb-close {
  color: var(--text-secondary) !important;
}

.sb-close:hover {
  background: rgba(255,255,255,0.05) !important;
  color: var(--text-display) !important;
}

.sb-profile {
  background: var(--bg-surface-elevated) !important;
  border-bottom: 1px solid rgba(255,255,255,0.04) !important;
}

.sb-avatar {
  background: var(--signal-info) !important;
  color: var(--bg-base) !important;
}

.sb-name {
  color: var(--text-primary) !important;
}

.sb-role {
  color: var(--text-secondary) !important;
}

.sb-nav-list li {
  color: var(--text-secondary) !important;
  border-bottom: 1px solid rgba(255,255,255,0.03) !important;
}

.sb-nav-list li:hover {
  background: rgba(255,255,255,0.03) !important;
  color: var(--text-primary) !important;
}

.sb-nav-list li.divider {
  background: var(--bg-base) !important;
}

.sb-footer {
  background: var(--bg-base) !important;
  border-top: 1px solid rgba(255,255,255,0.06) !important;
  color: var(--text-muted) !important;
}

.zen-backdrop {
  background: rgba(0,0,0,0.7) !important;
}

/* 7. Hamburger button */
.hamburger-btn {
  background: transparent !important;
  border: 1px solid rgba(255,255,255,0.08) !important;
  width: 28px !important;
  height: 28px !important;
  margin-right: 8px !important;
}

.hamburger-btn i {
  color: var(--text-secondary) !important;
  font-size: 13px !important;
}

.hamburger-btn:hover {
  background: rgba(255,255,255,0.04) !important;
  border-color: rgba(255,255,255,0.12) !important;
}

.hamburger-btn:hover i {
  color: var(--text-primary) !important;
}

/* 8. Board container 去padding */
.board-container {
  padding: 0 !important;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第五部分：安全横幅
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.safety-banner {
  /* 摒弃大面积刺眼色块，采用微米级警示边框与低阻抗底色 */
  background: rgba(225, 29, 72, 0.1);
  color: var(--text-display);
  padding: 12px 32px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 500;
  letter-spacing: 0.05em;
  border-top: 1px solid var(--signal-critical);
  border-bottom: 1px solid rgba(225, 29, 72, 0.3);
  animation: critical-flash 3s var(--ease-tech) infinite;
  box-shadow: inset 0 0 24px rgba(225, 29, 72, 0.05);
}

.safety-banner button {
  /* 战术响应按钮：剥离多余线框，采用精密外框与底色反差 */
  background: transparent;
  border: 1px solid rgba(225, 29, 72, 0.5);
  color: var(--signal-critical);
  padding: 6px 16px;
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  transition: all var(--transition-snappy);
  text-transform: uppercase;
}

.safety-banner button:hover {
  background: rgba(225, 29, 72, 0.15);
  border-color: var(--signal-critical);
  color: var(--text-display);
  box-shadow: 0 0 12px rgba(225, 29, 72, 0.2);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第6部分：命令头部
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.command-header {
  /* 采用亚克力毛玻璃材质，悬浮于深层网格之上 */
  background: var(--bg-glass);
  backdrop-filter: var(--blur-glass);
  -webkit-backdrop-filter: var(--blur-glass);
  border-bottom: var(--border-strong);
  padding: 16px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 500;
  gap: 20px;
  flex-wrap: nowrap;
  box-shadow: var(--shadow-flat);
}

.command-logo {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-shrink: 0;
  min-width: 0;
}

.logo-icon {
  width: 48px;
  height: 48px;
  background: var(--signal-info);
  color: var(--bg-base);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-weight: 900;
  font-size: 24px;
  /* 战术切角保留，尺寸收敛 */
  clip-path: polygon(0 8px, 8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%);
  flex-shrink: 0;
  box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2);
}

.logo-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
  flex-shrink: 0;
  min-width: 0;
}

.logo-title {
  font-family: var(--font-display);
  font-size: 24px;
  font-weight: 800;
  color: var(--text-display);
  letter-spacing: 4px;
  white-space: nowrap;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第七部分：导航标签页
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.nav-tabs-custom {
  background: var(--bg-surface);
  display: flex;
  gap: 4px;
  border-bottom: var(--border-strong);
  padding: 0 32px;
}

.nav-tabs-custom .tab {
  padding: 14px 24px;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--text-secondary);
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 13px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all var(--transition-snappy);
  position: relative;
  white-space: nowrap;
}

.nav-tabs-custom .tab:hover {
  color: var(--text-primary);
  background: rgba(255, 255, 255, 0.02);
  border-bottom-color: var(--border-default);
}

.nav-tabs-custom .tab.active {
  color: var(--signal-info);
  border-bottom-color: var(--signal-info);
  background: linear-gradient(0deg, rgba(56, 189, 248, 0.08) 0%, transparent 100%);
  /* 废除强光晕，改为微观的结构发光 */
  text-shadow: 0 0 12px rgba(56, 189, 248, 0.4);
}

.tab-number {
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 11px;
  color: var(--text-muted);
  margin-right: 8px;
  transition: color var(--transition-snappy);
}

.nav-tabs-custom .tab.active .tab-number {
  color: var(--signal-info);
  opacity: 0.8;
}
.logo-subtitle {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--signal-info);
  letter-spacing: 2px;
  white-space: nowrap;
  opacity: 0.8;
}

.system-status {
  display: flex;
  align-items: center;
  gap: 20px;
  font-family: var(--font-mono);
  font-size: 12px;
  flex-shrink: 0;
  margin-left: auto;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-dot {
  width: 8px;
  height: 8px;
  background: var(--signal-success);
  border-radius: 50%;
  flex-shrink: 0;
  /* 降低微光发散半径 */
  box-shadow: 0 0 6px var(--signal-success);
}

.status-text {
  color: var(--signal-success);
  font-weight: 600;
  white-space: nowrap;
  letter-spacing: 0.05em;
}

.version-tag {
  color: var(--text-muted);
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.02);
  border: var(--border-subtle);
  white-space: nowrap;
}

.system-time {
  color: var(--text-primary);
  font-weight: 600;
  font-size: 14px;
  white-space: nowrap;
  letter-spacing: 0.05em;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第8部分：数据管道头部
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.scan-line-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 10px 32px;
  /* 剥离实体背景，让深层雷达网格透射出来 */
  background: transparent;
  border-bottom: var(--border-subtle);
  position: relative;
  z-index: 10;
}

.scan-line {
  flex: 1;
  height: 1px;
  /* 废除金属渐变，重构为微米级数据导流线 */
  background: linear-gradient(90deg, rgba(56, 189, 248, 0.15), transparent);
  position: relative;
  overflow: hidden;
}

/* 植入低干涉的光子数据流穿梭动效 */
.scan-line::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 15%;
  background: linear-gradient(90deg, transparent, var(--signal-info), transparent);
  animation: shimmer 4s var(--ease-tech) infinite;
  opacity: 0.4;
}

.scan-label {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 0.2em;
  text-transform: uppercase;
  /* 减缓呼吸频率，维持终端冷漠感 */
  animation: data-stream 4s ease-in-out infinite; 
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第九部分：板式容器
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.board-container {
  /* 空间阵列对齐：匹配顶部 Header 的 32px 侧边距，维持终端整体性 */
  padding: 16px 32px 24px; 
  max-width: none !important; /* 强制击穿 ServiceNow 原生容器框架限制 */
  width: 100% !important;
  margin: 0 !important;
  
  /* 终端画布空间链强制接管：阻断内部元素撑开，确保内部子面板独立滚动 */
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0;
  overflow: hidden;
  
  /* 保持底色完全透明，继承深空雷达网格与边缘物理遮罩 */
  background: transparent;
  position: relative;
  z-index: 5;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第10部分：操作员状态面板
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.volunteer-status-panel {
  /* 剥离渐变与重度阴影，采用深层悬浮面材质 */
  background: var(--bg-surface-elevated);
  border: var(--border-default);
  border-left: 2px solid var(--signal-info);
  padding: 16px 24px;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  gap: 32px;
  position: relative;
  box-shadow: var(--shadow-flat);
}

/* 降低后台数据流呼吸频率与饱和度，避免抢夺核心数据焦点 */
.volunteer-status-panel::before {
  content: 'OPERATOR_STATUS';
  position: absolute;
  top: 8px;
  right: 16px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 0.15em;
  animation: data-stream 6s var(--ease-tech) infinite;
}

.status-row {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 500;
  color: var(--text-primary);
  font-size: 13px;
}

.status-row i {
  color: var(--signal-info);
  width: 20px;
  font-size: 14px;
  text-align: center;
}

/* 在线按钮：战术轮廓化，采用微透绿光，废除高频脉冲与突兀的缩放 */
.btn-online {
  background: rgba(16, 185, 129, 0.08);
  color: var(--signal-success);
  border: 1px solid var(--signal-success);
  padding: 8px 20px;
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 12px;
  letter-spacing: 0.05em;
  cursor: pointer;
  clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
  transition: all var(--transition-snappy);
}

.btn-online:hover {
  background: rgba(16, 185, 129, 0.15);
  box-shadow: inset 0 0 12px rgba(16, 185, 129, 0.1);
  color: #fff;
}

/* 离线按钮：低阻抗隐形模式 */
.btn-offline {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border-strong);
  padding: 8px 20px;
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 12px;
  letter-spacing: 0.05em;
  cursor: pointer;
  clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
  transition: all var(--transition-snappy);
}

.btn-offline:hover {
  color: var(--text-secondary);
  border-color: var(--text-secondary);
}

/* 表单控件：强制暗色接管，移除默认发光轮廓 */
.status-row select {
  background: var(--bg-base);
  color: var(--text-primary);
  border: var(--border-default);
  padding: 6px 12px;
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: border-color var(--transition-snappy);
  -webkit-appearance: none;
  appearance: none;
}

.status-row select:focus {
  outline: none;
  border-color: var(--border-focus);
  box-shadow: inset 0 0 0 1px var(--border-focus);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第11部分：章节标题
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.stats-section, .alert-section, .card-section {
  margin-bottom: 24px; /* 统一步长，严格对齐 8px 底层栅格 */
}

.section-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding-bottom: 8px;
  margin-bottom: 16px;
  border-bottom: var(--border-strong);
  position: relative;
}

/* 废除旧版金属切割线，重构为高精度数据定位锚点，提供视觉起搏 */
.section-header::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 48px; 
  height: 1px;
  background: var(--signal-info);
  box-shadow: 0 0 8px rgba(56, 189, 248, 0.4);
}

.section-tag {
  /* 剥除高反差填充与光污染，转换为战术透气标识 */
  background: rgba(56, 189, 248, 0.05);
  color: var(--signal-info);
  border: 1px solid rgba(56, 189, 248, 0.2);
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 11px;
  padding: 4px 12px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
}

.section-title {
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 14px; /* 降低字号，提升信息层级密度 */
  color: var(--text-primary);
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

.section-time {
  margin-left: auto;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  /* 减缓数据流跳动频率，维持界面的冷漠感与静默状态 */
  animation: data-stream 6s var(--ease-tech) infinite;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   EMERGENCY OVERRIDE: DEEP SPACE INTEGRATION (强制深层融合)
   ═══════════════════════════════════════════════════════════════════════════════════════ */

/* 1. 强制击穿 ServiceNow 底层白底画布 */
body, html, .sp-page-root, section.page {
    background-color: var(--bg-base) !important;
}

/* 2. 重塑 Command Header：彻底剥离“黑块感”，转为无界悬浮态 */
.command-header {
    background: rgba(9, 11, 16, 0.6) !important; /* 极低阻抗的深空灰透贴 */
    backdrop-filter: blur(24px) saturate(150%);
    -webkit-backdrop-filter: blur(24px) saturate(150%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.03) !important;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5) !important; /* 用大范围弥散阴影压住下方 */
}

/* 3. 修复左侧汉堡菜单按钮 (结合你的截图表现) */
.command-header .btn, 
.command-header button {
    background: transparent !important;
    border: 1px solid var(--border-default) !important;
    color: var(--text-primary) !important;
    border-radius: 4px; /* 引入微小的圆角切削，消除死板的方块感 */
}

/* 4. 修复 Logo 区域的高反差刺眼问题 */
.logo-icon {
    background: rgba(56, 189, 248, 0.1) !important; /* 抽离纯实心高亮蓝 */
    color: var(--signal-info) !important;
    border: 1px solid rgba(56, 189, 248, 0.3) !important;
    box-shadow: none !important;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第12部分：状态卡 - KPI指标
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px; /* 进一步收紧间距以提升数据密度 */
}

.stat-card {
  background: #FFFFFF; /* 强制纯白底色，规避底层灰度 */
  border: 1px solid #D0D4D9; /* 锐利实线边框，提供硬分割 */
  padding: 12px 16px;
  position: relative;
  transition: border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
  cursor: pointer;
  overflow: hidden;
}

.stat-card:hover {
  border-color: #1A1A1A; /* 悬停仅加深边框，保持冷峻感 */
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.stat-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.stat-code {
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 13px;
  color: #1A1A1A; /* 废除高亮，回归克制 */
  letter-spacing: 0.05em;
}

.stat-suffix {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #8C959F;
}

.stat-num {
  font-family: var(--font-ui); /* 回归标准界面字体 */
  font-size: 36px; /* 缩小字号，让渡空间给终端网格 */
  font-weight: 700;
  color: #0F0F0F;
  line-height: 1;
  margin: 12px 0;
  font-variant-numeric: tabular-nums; /* 核心机制：数字强制等宽对齐 */
}

.stat-name {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #586069;
  letter-spacing: 0.1em;
  margin-bottom: 12px;
  text-transform: uppercase;
}

.stat-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 12px;
  border-top: 1px solid #E5E8EB; /* 极细实线分割，废除金属渐变 */
}

.stat-change {
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

.stat-change.positive {
  color: #2E8B57; /* 沉稳的报表绿 */
}

.stat-change.negative {
  color: #CF222E; /* 严谨的警示红 */
}

.stat-status {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 4px 8px;
  letter-spacing: 0.05em;
  font-weight: 600;
  text-transform: uppercase;
  border: 1px solid transparent;
}

.stat-status.nominal {
  background: #F2F3F5;
  color: #586069;
  border-color: #D0D4D9;
}

.stat-status.warning {
  background: #FFF8C5;
  color: #9A6700;
  border-color: #E6CC7A;
}

.stat-status.critical {
  background: #FFEBE9;
  color: #CF222E;
  border-color: #FF8182;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第13部分：结构布局
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.two-column-layout {
  display: grid;
  grid-template-columns: 1fr 380px; /* 收缩侧边栏宽度，让渡空间给核心终端区 */
  gap: 16px;
  margin-top: 16px;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第14部分：警报推送
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.alert-section {
  background: #FFFFFF;
  border: 1px solid #D0D4D9;
  overflow: hidden;
  box-shadow: none; /* 彻底剥离阴影，保持贴面感 */
  display: flex;
  flex-direction: column;
}

.alert-section .section-header {
  padding: 12px 16px;
  margin: 0;
  background: #FFFFFF; /* 强制纯白表头，废除渐变 */
  border-bottom: 1px solid #D0D4D9;
}

.alert-list {
  max-height: 520px;
  overflow-y: auto;
}

.alert-item {
  display: grid;
  grid-template-columns: 100px 70px 80px 70px 1fr 24px;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid #E5E8EB; /* 极细表单分割线 */
  align-items: center;
  cursor: pointer;
  transition: background 0.2s ease;
  position: relative;
}

.alert-item::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px; /* 强制 4px 高亮提示列 */
  background: transparent;
}

.alert-item:hover {
  background: #F8F9FA; /* 极简的交互反馈底色 */
}

/* 剥离所有发光与霓虹效果，转为实色硬朗线条 */
.alert-item:hover::before {
  background: #1A1A1A;
  box-shadow: none;
}

.alert-item.priority-Critical::before {
  background: #CF222E;
  box-shadow: none;
}

.alert-item.priority-High::before {
  background: #9A6700;
  box-shadow: none;
}

.alert-id {
  font-family: var(--font-mono);
  font-size: 12px;
  color: #1A1A1A;
  font-weight: 600;
  font-variant-numeric: tabular-nums; /* 核心：强制等宽对齐 */
}

.alert-priority {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 2px 6px;
  font-weight: 600;
  text-align: center;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  clip-path: none; /* 移除廉价切角，回归表格严谨感 */
  border: 1px solid transparent;
}

/* 状态标签降噪：采用极细边框与低饱和度底色，废除纯色填充 */
.alert-priority.p-critical {
  background: #FFEBE9;
  color: #CF222E;
  border-color: #FF8182;
  box-shadow: none;
}

.alert-priority.p-high {
  background: #FFF8C5;
  color: #9A6700;
  border-color: #E6CC7A;
}

.alert-priority.p-medium {
  background: #F2F3F5;
  color: #0F0F0F;
  border-color: #D0D4D9;
}

.alert-priority.p-low {
  background: transparent;
  color: #586069;
  border-color: #E5E8EB;
}

.alert-zone {
  font-family: var(--font-mono);
  font-size: 12px;
  color: #586069;
  font-weight: 500;
}

.alert-time {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #8C959F;
  font-variant-numeric: tabular-nums; /* 核心：强制等宽对齐 */
}

.alert-content {
  font-family: var(--font-ui);
  font-size: 13px;
  color: #0F0F0F;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 500;
}

.alert-arrow {
  color: #8C959F;
  font-size: 14px;
  transition: transform 0.2s;
}

.alert-item:hover .alert-arrow {
  color: #1A1A1A;
  transform: translateX(4px);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第15部分：侧面板
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.side-panel-wrapper {
  display: flex;
  flex-direction: column;
  gap: 16px; /* 缩小组件间距，提高信息密度 */
}

.side-panel-enhanced {
  background: #FFFFFF;
  border: 1px solid #D0D4D9;
  padding: 16px;
  box-shadow: none; /* 彻底压平，拒绝浮夸的阴影 */
}

.data-stream-widget {
  margin-bottom: 16px;
}

.widget-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 12px;
  margin-bottom: 16px;
  border-bottom: 1px solid #D0D4D9; /* 锐利单像素切割 */
  position: relative;
}

/* 彻底废除金属渐变装饰线 */
.widget-header::after {
  display: none;
}

.widget-title {
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 11px;
  color: #586069;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 8px;
}

.widget-title i {
  color: #1A1A1A; /* 图标回归中性克制色 */
  font-size: 14px;
}

.live-indicator {
  width: 8px;
  height: 8px;
  background: #CF222E; /* 严谨的录制/实时红 */
  border-radius: 50%;
  /* 废除强光晕呼吸，仅保留极微弱的透明度闪烁，避免视觉干扰 */
  animation: data-stream 2s ease-in-out infinite; 
}

.live-metric-card {
  background: #F8F9FA; /* 微弱的灰度底色区分层级 */
  border: 1px solid #E5E8EB;
  border-left: 2px solid #1A1A1A; /* 左侧战术硬切线 */
  padding: 12px;
  margin-bottom: 12px;
  transition: border-color 0.2s;
}

.live-metric-card:hover {
  background: #F2F3F5;
  border-color: #D0D4D9;
  transform: none; /* 废除多余的位移动画 */
  box-shadow: none;
}

.metric-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.metric-label {
  font-size: 12px;
  font-weight: 600;
  color: #586069;
}

.metric-value {
  font-family: var(--font-ui);
  font-weight: 700;
  font-size: 24px; /* 压缩字号 */
  color: #0F0F0F;
  text-shadow: none; /* 剥离光污染 */
  font-variant-numeric: tabular-nums; /* 核心：数字等宽对齐 */
}

.metric-mini-bar {
  height: 4px; /* 压薄进度条 */
  background: #E5E8EB;
  overflow: hidden;
  border-radius: 0; /* 废除圆角，坚持锐利直角 */
}

.metric-mini-fill {
  height: 100%;
  background: #1A1A1A; /* 纯色填充，废除渐变与流光 */
  border-radius: 0;
  transition: width 0.3s ease;
}

.ai-insight-card {
  background: #FFFFFF;
  border: 1px solid #D0D4D9;
  border-left: 2px solid #0969DA; /* 企业级沉稳蓝 */
  padding: 16px;
}

.ai-header {
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 11px;
  color: #0969DA;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
}

.ai-content {
  font-family: var(--font-ui);
  font-size: 13px;
  color: #0F0F0F;
  line-height: 1.5;
  margin-bottom: 12px;
}

.ai-content strong {
  color: #0969DA;
  font-weight: 600;
}

.ai-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.ai-tag {
  background: #F8F9FA;
  color: #586069;
  border: 1px solid #D0D4D9;
  padding: 2px 8px;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第16部分：资源部分
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.resource-section-enhanced {
  background: #FFFFFF;
  border: 1px solid #D0D4D9;
  padding: 16px; /* 收紧内边距，提升容器利用率 */
  box-shadow: none; /* 彻底剥离立体阴影 */
}

.resource-section-enhanced .section-header {
  padding: 0 0 12px 0;
  margin-bottom: 16px;
  border-bottom: 1px solid #E5E8EB; /* 极细硬切割线 */
}

.resource-item {
  margin-bottom: 16px;
}

.resource-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px; /* 缩短标题与数据条的视觉距离 */
}

.resource-header .label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--font-ui);
  font-size: 13px;
  font-weight: 600;
  color: #0F0F0F; /* 提升核心指标的对比度 */
}

.resource-header .code {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #586069; /* 降低辅助代码的视觉权重 */
  font-weight: 600;
  letter-spacing: 0.05em;
}

.resource-header .percent {
  font-family: var(--font-ui);
  font-weight: 700;
  font-size: 14px; /* 缩小原有夸张的字号 */
  color: #0F0F0F;
  font-variant-numeric: tabular-nums; /* 核心：强制等宽对齐 */
}

.resource-bar {
  height: 6px; /* 压薄进度条，显得更精致专业 */
  background: #E5E8EB;
  border: 1px solid #D0D4D9;
  overflow: hidden;
  position: relative;
}

.resource-fill {
  height: 100%;
  position: relative;
  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 彻底拔除光污染与廉价扫光动画 */
.resource-fill::after {
  display: none;
}

/* 状态颜色回归严谨的实色填充，废除渐变与发光 */
.resource-fill.low {
  background: #CF222E;
  box-shadow: none;
}

.resource-fill.medium {
  background: #9A6700;
  box-shadow: none;
}

.resource-fill.high {
  background: #2E8B57; /* 沉稳的报表绿 */
  box-shadow: none;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第17部分：任务卡
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.card-grid, .task-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px; /* 放宽间隙，在白底上提供足够的呼吸空间 */
}

.jira-card {
  background: #FFFFFF; /* 强制纯白底色 */
  border: 1px solid #D0D4D9; /* 锐利单像素切割 */
  padding: 16px;
  transition: border-color 0.2s, box-shadow 0.2s;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

/* 左侧状态硬切线 */
.jira-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  background: transparent;
}

/* 悬停态：废除发光与位移，仅加深边框并提供极浅阴影 */
.jira-card:hover {
  border-color: #1A1A1A;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.jira-card:hover::before {
  background: #1A1A1A;
}

/* 优先级左侧标记色 */
.jira-card.priority-Critical::before {
  background: #CF222E;
}

.jira-card.priority-High::before {
  background: #9A6700;
}

.card-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.card-id {
  font-family: var(--font-mono);
  font-size: 12px;
  color: #586069;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

.status-tag {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 4px 8px;
  font-weight: 600;
  letter-spacing: 0.05em;
  background: #F8F9FA;
  color: #586069;
  border: 1px solid #E5E8EB;
  text-transform: uppercase;
}

/* 状态标签降噪：废除阴影光晕 */
.status-tag.status-4 {
  background: #EAF9F1 !important;
  color: #2E8B57 !important;
  border-color: #A2D9B7 !important;
  box-shadow: none !important;
}

.status-tag.status-2 {
  background: #FFF8C5;
  color: #9A6700;
  border-color: #E6CC7A;
}

.status-tag.status-11 {
  background: #F1F8FF;
  color: #0969DA;
  border-color: #B6D4FE;
}

.card-title {
  font-family: var(--font-ui);
  font-size: 15px;
  font-weight: 700;
  color: #0F0F0F;
  margin-bottom: 12px;
  line-height: 1.4;
}

.qty-badge {
  background: #F2F3F5;
  color: #1A1A1A;
  border: 1px solid #D0D4D9;
  padding: 2px 6px;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 600;
  margin-left: 8px;
}

.card-loc {
  font-family: var(--font-ui);
  font-size: 13px;
  color: #586069;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.card-loc i {
  color: #1A1A1A;
  font-size: 13px;
}

.card-detail {
  font-family: var(--font-ui);
  font-size: 13px;
  color: #8C959F;
  line-height: 1.5;
  margin-bottom: 12px;
}

/* SLA 区域：废除金属渐变，极细灰线分割 */
.card-sla {
  margin: 16px 0 0 0;
  padding-top: 16px;
  border-top: 1px solid #E5E8EB;
  position: relative;
}

/* 废除 ::before 的金属伪元素 */
.card-sla::before {
  display: none;
}

.sla-bar-container {
  height: 4px; /* 压薄进度条 */
  background: #E5E8EB;
  overflow: hidden;
  margin-bottom: 8px;
}

.sla-bar {
  height: 100%;
  position: relative;
  transition: width 0.3s ease;
}

/* 废除廉价扫光 */
.sla-bar::after {
  display: none;
}

.sla-info {
  display: flex;
  justify-content: space-between;
  font-family: var(--font-mono);
  font-size: 12px;
  color: #586069;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

/* SLA 状态：纯色接管 */
.sla-info.sla-critical {
  color: #CF222E !important;
  text-shadow: none !important;
}

.sla-info.sla-warning {
  color: #9A6700 !important;
}

.sla-info.sla-ok {
  color: #2E8B57 !important;
}

.sla-remaining {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* 底部区域：极简分割 */
.card-footer {
  padding-top: 16px;
  border-top: 1px solid #E5E8EB;
  margin-top: 16px;
  position: relative;
}

.card-footer::before {
  display: none;
}

.priority-badge {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 4px 8px;
  font-weight: 600;
  background: #F8F9FA;
  color: #586069;
  border: 1px solid #E5E8EB;
  text-transform: uppercase;
}

.priority-badge.priority-Critical {
  background: #FFEBE9;
  color: #CF222E;
  border-color: #FF8182;
  box-shadow: none;
}

.priority-badge.priority-High {
  background: #FFF8C5;
  color: #9A6700;
  border-color: #E6CC7A;
}

/* 操作按钮：战术轮廓，杜绝弹跳与光晕 */
.btn-jira {
  background: transparent;
  border: 1px solid #D0D4D9;
  color: #1A1A1A;
  padding: 8px 16px;
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  width: 100%;
  margin-top: 12px;
  transition: background 0.2s, border-color 0.2s;
}

.btn-jira:hover {
  background: #F2F3F5;
  border-color: #1A1A1A;
  transform: none; /* 废除 scale */
}

.btn-jira.progress {
  border-color: #0969DA;
  color: #0969DA;
}

.btn-jira.progress:hover {
  background: #F1F8FF;
  box-shadow: none;
}

.btn-jira.success {
  border-color: #2E8B57;
  color: #2E8B57;
}

.btn-jira.success:hover {
  background: #EAF9F1;
  box-shadow: none;
}

/* 完成状态占位符 */
.completed-msg {
  text-align: center;
  padding: 10px;
  background: #EAF9F1 !important;
  border: 1px solid #A2D9B7 !important;
  color: #2E8B57 !important;
  font-family: var(--font-ui);
  font-size: 13px;
  font-weight: 600;
  cursor: default;
  margin-top: 12px;
  transition: background 0.2s;
}

.completed-msg:hover {
  background: #DDF4E6 !important;
  box-shadow: none;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第十八部分：虚空之境
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.empty-board {
  padding: 64px 32px;
  text-align: center;
  background: #FFFFFF;
  border: 1px dashed #D0D4D9; /* 虚线框增强空白感 */
}

.empty-board i {
  font-size: 48px;
  margin-bottom: 16px;
  color: #D0D4D9; /* 降低图标存在感 */
}

.empty-board h4 {
  font-family: var(--font-ui);
  font-size: 18px;
  font-weight: 600;
  color: #586069;
  letter-spacing: 0.1em;
  margin: 12px 0;
  text-transform: uppercase;
}

.empty-board p {
  font-size: 13px;
  color: #8C959F;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第19部分：模态系统
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.modal-content {
  background: #FFFFFF !important;
  border: 1px solid #1A1A1A !important; /* 悬浮层外部边框加深，强化边界 */
  border-radius: 0 !important;
  box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,0,0,0.05) !important; /* 废除光晕，改用深层弥散阴影 */
  color: #0F0F0F !important;
  font-family: var(--font-ui) !important;
  overflow: visible !important;
  max-width: 960px;
  margin: 40px auto;
}

.modal-header-clean {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: #FFFFFF; /* 强制纯白表头，废除渐变 */
  border-bottom: 1px solid #D0D4D9;
}

.header-badge {
  background: #1A1A1A;
  color: #FFFFFF;
  padding: 4px 12px;
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 11px;
  letter-spacing: 0.05em;
  clip-path: none; /* 移除切角 */
  box-shadow: none;
}

.header-id {
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 16px;
  color: #0F0F0F;
  margin-left: 12px;
  font-variant-numeric: tabular-nums;
}

.header-close {
  background: transparent;
  border: 1px solid #D0D4D9;
  color: #586069;
  width: 32px;
  height: 32px;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.header-close:hover {
  background: #F8F9FA;
  border-color: #1A1A1A;
  color: #1A1A1A;
}

.modal-body-grid {
  display: grid;
  grid-template-columns: 1fr 320px; /* 压缩侧栏，让渡主区域 */
  max-height: 75vh;
  overflow: hidden;
}

.body-main {
  padding: 24px;
  border-right: 1px solid #E5E8EB; /* 极细硬切线 */
  overflow-y: auto;
  max-height: 75vh;
  position: relative;
}

/* 废除右侧金属阴影分割线 */
.body-main::after {
  display: none;
}

.body-sidebar {
  background: #F8F9FA; /* 微灰底色区分侧栏 */
  padding: 24px;
  overflow-y: auto;
  max-height: 75vh;
}

.ticket-title {
  font-family: var(--font-ui);
  font-size: 20px;
  font-weight: 700;
  color: #0F0F0F;
  margin: 0 0 20px 0;
  padding-bottom: 16px;
  border-bottom: 1px solid #E5E8EB;
  letter-spacing: normal;
  position: relative;
}

/* 废除标题底部的金属渐变 */
.ticket-title::after {
  display: none;
}

.qty-badge-black {
  background: #E5E8EB;
  color: #1A1A1A;
  padding: 2px 8px;
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 600;
  margin-left: 8px;
  border: 1px solid #D0D4D9;
}

.action-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.btn-purple-outline, .btn-normal {
  background: #FFFFFF;
  border: 1px solid #D0D4D9;
  color: #1A1A1A;
  padding: 8px 16px;
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-purple-outline:hover, .btn-normal:hover {
  background: #F8F9FA;
  border-color: #1A1A1A;
}

.action-btn {
  background: #1A1A1A !important;
  color: #FFFFFF !important;
  border: 1px solid #1A1A1A !important;
  padding: 8px 16px;
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  clip-path: none; /* 移除切角 */
  transition: all 0.2s;
}

.action-btn:hover {
  background: #333333 !important;
  transform: none; /* 拒绝弹跳 */
}

.desc-box {
  background: #FFFFFF;
  border: 1px solid #E5E8EB;
  border-left: 2px solid #0969DA; /* 企业蓝硬切 */
  padding: 16px;
  margin-bottom: 24px;
}

.desc-section-title {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #586069;
  margin-bottom: 12px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

.desc-grid {
  display: grid;
  gap: 12px;
}

.desc-item {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  font-size: 13px;
  color: #0F0F0F;
}

.desc-icon {
  width: 20px;
  text-align: center;
  color: #586069; /* 图标降噪 */
  font-size: 14px;
}

.desc-label {
  font-weight: 600;
  color: #586069;
  margin-right: 8px;
}

.activity-area {
  margin-top: 24px;
}

.note-input {
  width: 100%;
  background: #FFFFFF;
  border: 1px solid #D0D4D9;
  color: #0F0F0F;
  padding: 12px;
  min-height: 80px;
  margin-bottom: 12px;
  font-family: var(--font-ui);
  font-size: 13px;
  resize: vertical;
  transition: border-color 0.2s;
}

.note-input:focus {
  outline: none;
  border-color: #0969DA; /* 聚焦时采用高亮蓝，废除光晕 */
  box-shadow: inset 0 0 0 1px #0969DA;
}

.submit-btn {
  background: #F8F9FA;
  color: #8C959F;
  border: 1px solid #E5E8EB;
  padding: 8px 16px;
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 12px;
  cursor: not-allowed;
  float: right;
  transition: all 0.2s;
}

.submit-btn.ready {
  background: #1A1A1A;
  color: #FFFFFF;
  border-color: #1A1A1A;
  cursor: pointer;
}

.submit-btn.ready:hover {
  background: #333333;
}

.sidebar-block {
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid #E5E8EB;
  position: relative;
}

/* 废除侧栏底部的金属装饰线 */
.sidebar-block::after {
  display: none;
}

.sb-label {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #586069;
  letter-spacing: 0.1em;
  margin-bottom: 8px;
  text-transform: uppercase;
}

.user-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.avatar-box {
  width: 32px; /* 缩小头像框 */
  height: 32px;
  background: #E5E8EB;
  color: #1A1A1A;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-ui);
  font-weight: 700;
  font-size: 14px;
  flex-shrink: 0;
  border-radius: 2px; /* 极微圆角 */
}

.avatar-box.orange {
  background: #FFF8C5;
  color: #9A6700;
}

.user-name-text {
  font-size: 13px;
  font-weight: 600;
  color: #0F0F0F;
}

.state-indicator {
  padding: 6px 12px;
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 11px;
  letter-spacing: 0.05em;
  display: inline-block;
  color: #FFFFFF;
  background: #1A1A1A; /* 默认深色标识 */
}

.priority-btn {
  background: #FFFFFF;
  color: #1A1A1A;
  border: 1px solid #D0D4D9;
  padding: 8px 12px;
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
  cursor: pointer;
}

.priority-btn:hover {
  background: #F8F9FA;
}

.sla-progress {
  height: 6px; /* 压薄进度条 */
  background: #E5E8EB;
  overflow: hidden;
  margin-bottom: 8px;
}

.sla-fill {
  height: 100%;
  position: relative;
  background: #1A1A1A; /* 纯黑进度，废除渐变与发光 */
}

/* 废除扫光 */
.sla-fill::after {
  display: none;
}

.sla-text {
  display: flex;
  justify-content: space-between;
  font-family: var(--font-mono);
  font-size: 11px;
  color: #586069;
  margin-bottom: 8px;
  font-variant-numeric: tabular-nums;
}

.sla-badge {
  background: #F8F9FA;
  color: #586069;
  border: 1px solid #E5E8EB;
  padding: 4px 10px;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.05em;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  text-transform: uppercase;
}

.sla-badge.sla-critical {
  background: #FFEBE9;
  color: #CF222E;
  border-color: #FF8182;
  box-shadow: none;
}

.sla-badge.sla-ok {
  background: #EAF9F1;
  color: #2E8B57;
  border-color: #A2D9B7;
  box-shadow: none;
}

.dropdown-wrapper {
  position: relative;
  display: inline-block;
}

.status-menu {
  position: absolute;
  top: calc(100% + 4px); /* 留出间隙 */
  left: 0;
  background: #FFFFFF;
  border: 1px solid #D0D4D9;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  z-index: 100;
  min-width: 180px;
}

.status-item {
  padding: 10px 16px;
  cursor: pointer;
  font-size: 13px;
  border-bottom: 1px solid #E5E8EB;
  color: #0F0F0F;
  font-weight: 500;
  transition: background 0.2s;
}

.status-item:last-child {
  border-bottom: none;
}

.status-item:hover {
  background: #F8F9FA;
  color: #1A1A1A;
}

.status-item.danger {
  color: #CF222E;
}

.status-item.danger:hover {
  background: #FFEBE9;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 20: 滚动条
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.kokoro-volunteer-container::-webkit-scrollbar,
.alert-list::-webkit-scrollbar,
.body-main::-webkit-scrollbar,
.body-sidebar::-webkit-scrollbar {
  width: 6px; /* 进一步压薄滚动条 */
  height: 6px;
}

.kokoro-volunteer-container::-webkit-scrollbar-track,
.alert-list::-webkit-scrollbar-track,
.body-main::-webkit-scrollbar-track,
.body-sidebar::-webkit-scrollbar-track {
  background: transparent;
}

.kokoro-volunteer-container::-webkit-scrollbar-thumb,
.alert-list::-webkit-scrollbar-thumb,
.body-main::-webkit-scrollbar-thumb,
.body-sidebar::-webkit-scrollbar-thumb {
  background: #D0D4D9; /* 严谨的中性灰 */
  border-radius: 0; /* 废除圆角，坚持锐利直角 */
}

.kokoro-volunteer-container::-webkit-scrollbar-thumb:hover,
.alert-list::-webkit-scrollbar-thumb:hover,
.body-main::-webkit-scrollbar-thumb:hover,
.body-sidebar::-webkit-scrollbar-thumb:hover {
  background: #8C959F;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 21: HAMBURGER MENU &amp; SIDEBAR - 完整集成
   ═══════════════════════════════════════════════════════════════════════════════════════ */

/* 1. Hamburger Button */
.hamburger-btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border-mid);
  margin-right: 15px;
  cursor: pointer;
  background: var(--bg-primary);
  transition: all 0.2s;
  flex-shrink: 0;
}

.hamburger-btn:hover {
  background: var(--text-primary);
  border-color: var(--text-primary);
}

.hamburger-btn:hover i {
  color: var(--bg-primary);
}

.hamburger-btn i {
  font-size: 18px;
  color: var(--text-primary);
  transition: color 0.2s;
}

/* Sidebar (修复版: 修复透明度与层级) */
.zen-sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 280px;
  height: 100vh;
  /* 强制白色背景，防止透明 */
  background-color: #ffffff !important; 
  background: #ffffff !important;
  border-right: 2px solid var(--border-dark);
  /* 提高 z-index 确保在遮罩层之上 (遮罩层通常是 99998) */
  z-index: 100000 !important; 
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  /* 增加阴影以区分层级 */
  box-shadow: 2px 0 15px rgba(0,0,0,0.2); 
}

.zen-sidebar.active {
  transform: translateX(0);
}

.zen-sidebar.active {
  transform: translateX(0);
}

/* 3. Sidebar Header */
.sidebar-head {
  height: 60px;
  border-bottom: 2px solid var(--text-primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 20px;
  background: var(--bg-tertiary);
}

.sb-title {
  font-family: var(--font-display);
  font-weight: 900;
  font-size: 18px;
  letter-spacing: 2px;
  color: var(--text-primary);
}

.sb-close {
  background: none;
  border: none;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  color: var(--text-primary);
  transition: all 0.2s;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sb-close:hover {
  background: var(--text-primary);
  color: var(--bg-primary);
}

/* 4. Sidebar Profile */
.sb-profile {
  padding: 30px 20px;
  border-bottom: 1px solid var(--border-mid);
  display: flex;
  align-items: center;
  gap: 15px;
  background: var(--bg-secondary);
}

.sb-avatar {
  width: 48px;
  height: 48px;
  background: var(--text-primary);
  color: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 20px;
  font-family: var(--font-display);
  flex-shrink: 0;
}

.sb-name {
  font-weight: 800;
  font-size: 16px;
  margin-bottom: 4px;
  color: var(--text-primary);
}

.sb-role {
  font-size: 10px;
  font-family: var(--font-mono);
  color: var(--text-tertiary);
}

/* 5. Navigation List */
.sb-nav-list {
  list-style: none;
  padding: 0;
  margin: 0;
  flex: 1;
  overflow-y: auto;
}

.sb-nav-list li {
  padding: 18px 24px;
  border-bottom: 1px solid var(--border-light);
  cursor: pointer;
  font-family: var(--font-body);
  font-weight: 700;
  font-size: 16px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  color: var(--text-secondary);
}

.sb-nav-list li:hover {
  background: var(--text-primary);
  color: var(--bg-primary);
}

.sb-nav-list li:hover .nav-num {
  color: var(--text-tertiary);
}

.nav-num {
  font-family: var(--font-display);
  font-size: 11px;
  color: var(--text-tertiary);
  margin-right: 12px;
  width: 20px;
  font-weight: 800;
}

.sb-nav-list li.divider {
  height: 20px;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border-light);
  padding: 0;
  cursor: default;
}

/* 6. Sidebar Footer */
.sb-footer {
  padding: 20px;
  font-size: 11px;
  color: var(--text-tertiary);
  text-align: center;
  border-top: 2px solid var(--text-primary);
  background: var(--bg-tertiary);
  font-family: var(--font-mono);
  letter-spacing: 1px;
}

/* 7. Backdrop */
.zen-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(2px);
  z-index: 99998;
  display: none;
}

.zen-backdrop.active {
  display: block;
}


/* ═══════════════════════════════════════════════════════════════════════════════════════
   第22部分：响应式
   ═══════════════════════════════════════════════════════════════════════════════════════ */
@media (max-width: 1200px) {
  .two-column-layout {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .modal-body-grid {
    grid-template-columns: 1fr;
  }
  
  .body-sidebar {
    border-right: none;
    border-top: 1px solid #E5E8EB; /* 锐利单像素硬切线 */
  }
  
  .board-container {
    padding: 16px 24px; /* 收紧宽屏到中屏的过渡期边距 */
    width: 100% !important;
  }
}

@media (max-width: 768px) {
  .command-header {
    padding: 0 16px !important;
    height: 48px !important; /* 强制锁定移动端极薄表头 */
    flex-wrap: nowrap;
    gap: 12px;
  }
  
  .logo-text {
    display: none;
  }
  
  .system-status {
    margin-left: auto;
    gap: 12px;
  }
  
  .nav-tabs-custom {
    padding: 0 16px;
    overflow-x: auto;
    /* 隐藏移动端滚动条，保持界面整洁 */
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  .nav-tabs-custom::-webkit-scrollbar {
    display: none;
  }
  
  .board-container {
    padding: 12px 16px; /* 移动端极致数据密度 */
  }
  
  .volunteer-status-panel {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 16px;
  }
  
  .stats-row {
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  .alert-item {
    /* 移动端保留核心识别区：指示条、优先级、内容、操作 */
    grid-template-columns: 4px 60px 1fr 24px;
    gap: 8px;
    padding: 12px;
  }
  
  .alert-zone, .alert-time, .alert-id {
    display: none; /* 移动端隐藏次要元数据 */
  }

  /* 调整优先级标签在移动端的尺寸 */
  .alert-priority {
    font-size: 9px;
    padding: 2px 4px;
  }
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   第23部分：交互系统
   ═══════════════════════════════════════════════════════════════════════════════════════ */
button, .btn-jira, .btn-online, .btn-offline, .tab, .alert-item, .jira-card, .stat-card {
  pointer-events: auto !important;
  cursor: pointer !important;
}

.clickable {
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

.kokoro-volunteer-container * {
  box-sizing: border-box;
}

/* ═════════════════════════════════════════════════════════════════════
   组件：系统警报条
   ═════════════════════════════════════════════════════════════════════ */

.sys-alert-strip {
    /* 布局定位 */
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    height: 48px; /* 对齐极薄 Header 的高度规范 */
    padding: 0 24px;
    gap: 16px;

    /* 视觉风格：废除斜纹背景，强制纯白底色与单像素极细硬切线 */
    background-color: #FFFFFF;
    border-bottom: 1px solid #CF222E; /* 致命红实线切割 */
    
    /* 字体设置 */
    font-family: var(--font-mono);
    font-size: 12px;
    color: #CF222E;
    z-index: 1000;
}

/* 左侧装饰块：保留战术感，降低视觉噪音 */
.alert-deco {
    font-weight: 600;
    letter-spacing: 0.1em;
    color: #CF222E;
    opacity: 0.8;
    white-space: nowrap;
    display: none;
}

@media (min-width: 992px) {
    .alert-deco { display: block; }
}

/* 中间消息主体 */
.alert-body {
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.alert-body i {
    font-size: 14px;
    /* 废除光晕呼吸灯，改为极简的硬切闪烁（起搏器效果） */
    animation: alert-pulse 1s step-end infinite; 
}

.alert-text {
    font-family: var(--font-ui);
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #0F0F0F; /* 文本主体采用极夜黑，仅依赖图标与边框进行报警 */
}

/* 右侧按钮：战术轮廓风格降噪 */
.sys-btn-ghost {
    background: transparent;
    border: 1px solid #CF222E;
    color: #CF222E;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 600;
    padding: 6px 16px;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* 悬停态：废除发光与阴影，采用实色反转 */
.sys-btn-ghost:hover {
    background: #CF222E;
    color: #FFFFFF;
    box-shadow: none;
}

/* 极简警报起搏动画：仅进行物理级的通断电模拟，拒绝发光 */
@keyframes alert-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}

/* ═════════════════════════════════════════════════════════════════════
   第28部分：战术阵容风格
   ═════════════════════════════════════════════════════════════════════ */

.roster-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px; /* 收紧间距，提升密度 */
    padding-bottom: 32px;
}

.roster-card {
    background: #FFFFFF; /* 强制纯白 */
    border: 1px solid #D0D4D9; /* 锐利切割 */
    position: relative;
    padding: 16px;
    transition: border-color 0.2s ease;
    clip-path: none; /* 废除装饰性切角，回归严谨矩形 */
}

.roster-card:hover {
    transform: none; /* 废除上浮动画 */
    box-shadow: none; /* 废除阴影 */
    border-color: #1A1A1A;
}

.roster-card.is-self {
    border: 1px solid #1A1A1A; /* 自我标识改为实心黑框 */
    background: #F8F9FA;
}

/* Head */
.roster-head {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #E5E8EB; /* 虚线改实线 */
}

.roster-avatar {
    width: 40px; 
    height: 40px;
    background: #F2F3F5;
    color: #586069;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 16px;
    font-family: var(--font-ui);
    border-radius: 0; /* 废除圆角 */
    border: 1px solid #D0D4D9;
}
.roster-avatar.online { background: #1A1A1A; color: #FFFFFF; border-color: #1A1A1A; }
.roster-avatar.busy { background: #FFF8C5; color: #9A6700; border-color: #E6CC7A; }

.roster-identity {
    flex: 1;
    overflow: hidden;
}

.roster-name {
    font-weight: 700;
    font-size: 13px;
    color: #0F0F0F;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    font-family: var(--font-ui);
}

.roster-id {
    font-family: var(--font-mono);
    font-size: 10px; color: #586069;
    letter-spacing: 0.05em;
    font-variant-numeric: tabular-nums; /* 等宽对齐 */
}

.roster-status-light {
    width: 6px; height: 6px; border-radius: 0; /* 方块指示灯 */
    background: #D0D4D9;
    box-shadow: none; /* 废除发光 */
}
.roster-status-light.online { background: #2E8B57; box-shadow: none; }
.roster-status-light.busy { background: #9A6700; box-shadow: none; }

/* Body */
.roster-body {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
}

.roster-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
}

.r-label { font-family: var(--font-mono); color: #586069; }
.r-val { font-weight: 600; color: #0F0F0F; font-variant-numeric: tabular-nums; }

.r-badge {
    padding: 2px 6px;
    border-radius: 0; /* 废除圆角 */
    border: 1px solid transparent;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    font-family: var(--font-mono);
}
.r-badge.online { background: #EAF9F1; color: #2E8B57; border-color: #A2D9B7; }
.r-badge.busy { background: #FFF8C5; color: #9A6700; border-color: #E6CC7A; }
.r-badge.offline { background: #F8F9FA; color: #586069; border-color: #D0D4D9; }

/* Footer / Load */
.roster-footer {
    background: #FFFFFF;
    padding: 12px 0 0 0;
    border-radius: 0;
    border-top: 1px solid #E5E8EB; /* 用顶部分割线代替背景色块 */
}

.load-meta {
    display: flex; justify-content: space-between;
    font-size: 10px; font-weight: 600; color: #586069;
    margin-bottom: 6px;
    font-family: var(--font-mono);
    font-variant-numeric: tabular-nums;
}

.load-track {
    height: 4px; /* 压薄进度条 */
    background: #E5E8EB;
    overflow: hidden;
    border-radius: 0;
}

.load-bar {
    height: 100%;
    background: #1A1A1A; /* 默认深色填充 */
    transition: width 0.3s ease;
}
.load-bar.overload { background: #CF222E; } /* 超载警告红 */

/* Decor - 完全废除多余装饰角 */
.corner-decor {
    display: none;
}

/* ═════════════════════════════════════════════════════════════════════
   第30部分：人员名册与档案
   ═════════════════════════════════════════════════════════════════════ */

/* --- 卡牌容器 --- */
.roster-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px; /* 缩紧卡牌间距 */
    padding-bottom: 32px;
}

/* --- 单张卡牌 (Database Style) --- */
.tcg-card {
    background: #FFFFFF;
    border: 1px solid #D0D4D9; /* 极细硬切，废除厚边框 */
    border-radius: 0; /* 废除圆角 */
    padding: 12px;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: border-color 0.2s ease, background 0.2s ease;
    position: relative;
    box-shadow: none; /* 彻底剥离卡片阴影 */
}

.tcg-card:hover {
    transform: none; /* 拒绝弹跳动画 */
    box-shadow: none;
    border-color: #1A1A1A; /* 悬停仅加深边框 */
    background: #F8F9FA;
    z-index: 10;
}

/* 顶部标签 */
.tcg-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 10px;
    font-weight: 600;
    font-family: var(--font-mono);
    color: #586069;
    text-transform: uppercase;
}
.tcg-status-dot {
    width: 6px; height: 6px; border-radius: 0; /* 方形指示灯 */
    background: #D0D4D9;
}
.tcg-status-dot.online { background: #2E8B57; box-shadow: none; }
.tcg-status-dot.busy { background: #9A6700; box-shadow: none; }

/* 图片区域 */
.tcg-image-box {
    width: 100%;
    aspect-ratio: 1 / 1;
    background: #F2F3F5;
    border: 1px solid #E5E8EB;
    margin-bottom: 12px;
    overflow: hidden;
    position: relative;
}

.tcg-avatar {
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    display: flex; align-items: center; justify-content: center;
    font-size: 32px; font-weight: 700; color: #D0D4D9;
    font-family: var(--font-ui);
}

/* 信息区域 */
.tcg-info {
    text-align: center;
}
.tcg-name {
    font-family: var(--font-ui);
    font-weight: 700; font-size: 13px; color: #0F0F0F;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    margin-bottom: 2px;
}
.tcg-id {
    font-size: 10px; color: #586069; margin-bottom: 12px;
    font-family: var(--font-mono);
    font-variant-numeric: tabular-nums; /* ID强制等宽 */
}

/* 属性条 */
.tcg-stats {
    background: transparent;
    padding: 8px 0 0 0;
    border-top: 1px solid #E5E8EB; /* 顶部极细分割 */
}
.stat-row {
    display: flex; align-items: center; justify-content: space-between;
    font-size: 10px; font-family: var(--font-mono); color: #586069;
    font-variant-numeric: tabular-nums;
}
.stat-bar-track {
    width: 60px; height: 4px; background: #E5E8EB; border-radius: 0;
}
.stat-bar-fill {
    height: 100%; background: #1A1A1A; border-radius: 0;
}
.stat-bar-fill.alert { background: #CF222E; }


/* --- DOSSIER MODAL (档案弹窗) --- */
.operator-modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15, 15, 15, 0.4); /* 降低遮罩浊度 */
    backdrop-filter: blur(2px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
}

.operator-dossier {
    width: 640px;
    max-width: 90%;
    background: #FFFFFF;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,0,0,0.05); /* 弥散深阴影 */
    border: 1px solid #1A1A1A; /* 悬浮层外部硬框 */
    border-radius: 0;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.dossier-header {
    background: #FFFFFF; /* 洗白 Header */
    color: #0F0F0F;
    padding: 12px 20px;
    border-bottom: 1px solid #D0D4D9;
    display: flex; justify-content: space-between; align-items: center;
    font-family: var(--font-mono);
    font-weight: 600;
    font-size: 12px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
}
.dh-close { cursor: pointer; color: #586069; transition: color 0.2s; }
.dh-close:hover { color: #CF222E; }

.dossier-content {
    display: flex;
    padding: 24px;
    gap: 24px;
}

/* 弹窗左侧 */
.dossier-left {
    width: 160px;
    text-align: center;
}
.dossier-photo {
    width: 100%; aspect-ratio: 3/4;
    background: #F2F3F5;
    background-size: cover; background-position: center;
    border: 1px solid #D0D4D9; /* 锐利线框 */
    margin-bottom: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 48px; color: #D0D4D9; font-weight: 700;
    font-family: var(--font-ui);
}
.dossier-status-badge {
    padding: 4px 8px;
    background: #F8F9FA; color: #586069;
    border: 1px solid #E5E8EB;
    font-family: var(--font-mono);
    font-weight: 600; font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.dossier-status-badge.online { background: #EAF9F1; color: #2E8B57; border-color: #A2D9B7; }
.dossier-status-badge.busy { background: #FFF8C5; color: #9A6700; border-color: #E6CC7A; }

/* 弹窗右侧 */
.dossier-right {
    flex: 1;
}
.dr-name { 
    font-family: var(--font-ui);
    font-size: 20px; font-weight: 700; color: #0F0F0F; 
    line-height: 1; text-transform: uppercase; margin-bottom: 6px;
}
.dr-role { 
    font-size: 12px; color: #586069; margin-bottom: 24px; 
    font-family: var(--font-mono); letter-spacing: 0.05em; text-transform: uppercase;
}

.dr-section { margin-bottom: 20px; }
.dr-label { 
    font-family: var(--font-mono);
    font-size: 10px; color: #586069; font-weight: 600; 
    margin-bottom: 6px; letter-spacing: 0.1em; text-transform: uppercase;
}
.dr-value-box { 
    font-family: var(--font-ui);
    font-size: 14px; font-weight: 600; color: #0F0F0F;
    border-left: 2px solid #0969DA; /* 企业蓝锚定 */
    padding-left: 12px; 
}

.dr-load-display { display: flex; align-items: baseline; gap: 8px; font-variant-numeric: tabular-nums; }
.big-num { 
    font-family: var(--font-ui);
    font-size: 28px; font-weight: 700; line-height: 1; color: #0F0F0F;
}
.sub-text { 
    font-family: var(--font-mono);
    font-size: 11px; color: #586069; text-transform: uppercase; 
}

/* 进度条轨道 */
.dossier-bar-track {
    position: relative;
    width: 100%;
    height: 4px; /* 压薄 */
    background-color: #E5E8EB;
    border-radius: 0; /* 废除圆角 */
    margin-top: 8px;
    overflow: hidden; 
}

/* 进度条填充 */
.dossier-bar-fill {
    height: 100%;
    background-color: #1A1A1A;
    border-radius: 0;
    transition: width 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* 底部按钮 */
.dossier-actions {
    padding: 16px 24px;
    border-top: 1px solid #E5E8EB;
    display: flex; justify-content: flex-end; gap: 12px;
    background: #FFFFFF;
}
.dossier-btn {
    border: 1px solid transparent; padding: 6px 16px; 
    font-family: var(--font-ui); font-weight: 600; font-size: 12px; 
    cursor: pointer; transition: all 0.2s; text-transform: uppercase;
}
.dossier-btn.ghost { background: transparent; border-color: #D0D4D9; color: #1A1A1A; }
.dossier-btn.ghost:hover { background: #F8F9FA; border-color: #1A1A1A; }
.dossier-btn.primary { background: #1A1A1A; color: #FFFFFF; border-color: #1A1A1A; }
.dossier-btn.primary:hover { background: #333333; }

@keyframes slideUp { from { transform: translateY(12px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* ═══════════════════════════════════════════════════════════════
   部分：通信中心
   ═══════════════════════════════════════════════════════════════ */

/* --- Broadcast Composer (指令编辑器) --- */
.broadcast-composer {
    background: #FFFFFF;
    border: 1px solid #D0D4D9;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: none; /* 废除阴影 */
}

.broadcast-type-selector {
    display: flex;
    gap: 1px; /* 紧凑型网格 */
    background: #D0D4D9;
    border: 1px solid #D0D4D9;
    margin-bottom: 16px;
}

.broadcast-type-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    background: #F8F9FA;
    font-family: var(--font-mono);
    font-weight: 700;
    font-size: 11px;
    color: #586069;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.broadcast-type-btn:hover { background: #FFFFFF; color: #1A1A1A; }

.broadcast-type-btn.active {
    background: #1A1A1A !important;
    color: #FFFFFF !important;
}

/* 紧急广播采用致命红标记 */
.broadcast-type-btn:first-child.active {
    background: #CF222E !important;
}

.broadcast-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.broadcast-title-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #D0D4D9;
    background: #F8F9FA;
    font-family: var(--font-ui);
    font-size: 14px;
    font-weight: 700;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.broadcast-title-input:focus { border-color: #0969DA; background: #FFFFFF; }

.broadcast-body-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #D0D4D9;
    background: #F8F9FA;
    font-family: var(--font-ui);
    font-size: 13px;
    resize: vertical;
    min-height: 80px;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.broadcast-body-input:focus { border-color: #0969DA; background: #FFFFFF; }

.broadcast-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 8px;
}

.broadcast-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: #8C959F;
}

.broadcast-type-label {
    padding: 2px 6px;
    font-weight: 700;
    font-size: 10px;
    text-transform: uppercase;
}

.broadcast-type-label.type-emergency { background: #FFEBE9; color: #CF222E; border: 1px solid #FF8182; }
.broadcast-type-label.type-announcement { background: #FFF8C5; color: #9A6700; border: 1px solid #E6CC7A; }
.broadcast-type-label.type-internal { background: #F2F3F5; color: #586069; border: 1px solid #D0D4D9; }

.broadcast-send-btn {
    padding: 8px 20px;
    background: #F2F3F5;
    color: #8C959F;
    border: 1px solid #D0D4D9;
    font-family: var(--font-ui);
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 0.05em;
    cursor: not-allowed;
    text-transform: uppercase;
}

.broadcast-send-btn.ready {
    background: #1A1A1A;
    color: #FFFFFF;
    border-color: #1A1A1A;
    cursor: pointer;
}

.broadcast-send-btn.ready:hover {
    background: #333333;
}

/* --- Timeline (指令流) --- */
.comms-timeline {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 600px;
    overflow-y: auto;
}

.comm-item {
    background: #FFFFFF;
    border: 1px solid #D0D4D9;
    display: flex;
    cursor: pointer;
    transition: border-color 0.2s;
}

.comm-item:hover {
    border-color: #1A1A1A;
    transform: none; /* 废除位移 */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.comm-priority-bar {
    width: 4px;
    flex-shrink: 0;
    background: #E5E8EB;
}

.comm-priority-bar.bar-emergency { background: #CF222E; }
.comm-priority-bar.bar-announcement { background: #9A6700; }
.comm-priority-bar.bar-internal { background: #586069; }

.comm-content {
    flex: 1;
    padding: 12px 16px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.comm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.comm-type-badge {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    border: 1px solid transparent;
}

.comm-type-badge.badge-emergency { background: #FFEBE9; color: #CF222E; border-color: #FF8182; }
.comm-type-badge.badge-announcement { background: #FFF8C5; color: #9A6700; border-color: #E6CC7A; }
.comm-type-badge.badge-internal { background: #F8F9FA; color: #586069; border-color: #D0D4D9; }

.comm-time { font-family: var(--font-mono); font-size: 11px; color: #8C959F; font-variant-numeric: tabular-nums; }
.comm-title { font-weight: 700; font-size: 14px; color: #0F0F0F; font-family: var(--font-ui); }
.comm-body-preview { font-size: 13px; color: #586069; line-height: 1.4; }

.comm-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: var(--font-mono);
    font-size: 11px;
    color: #8C959F;
    padding-top: 8px;
    border-top: 1px solid #F2F3F5;
    margin-top: 4px;
}

.comm-author { font-weight: 700; color: #586069; }

/* --- Detail Overlay (详细卷宗模式) --- */
.comm-detail-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15, 15, 15, 0.4);
    backdrop-filter: blur(2px);
    z-index: 3000;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 32px;
}

.comm-detail-panel {
    background: #FFFFFF;
    width: 100%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 24px;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,0,0,0.05);
    border: 1px solid #1A1A1A;
}

.comm-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #D0D4D9;
    padding-bottom: 16px;
    margin-bottom: 20px;
}

.comm-detail-body {
    font-family: var(--font-ui);
    font-size: 14px;
    line-height: 1.6;
    color: #0F0F0F;
    white-space: pre-wrap;
    word-break: break-word;
}

/* --- Filter Button Active State (筛选状态对齐) --- */
.btn-jira.active {
    background: #1A1A1A !important;
    color: #FFFFFF !important;
    border-color: #1A1A1A !important;
}

/* --- Delete Confirm Modal (硬核二次确认面板) --- */
.delete-confirm-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15, 15, 15, 0.5);
    z-index: 4000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.delete-confirm-panel {
    background: #FFFFFF;
    width: 380px;
    padding: 24px;
    text-align: center;
    border: 1px solid #1A1A1A;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
}

.delete-confirm-icon {
    width: 48px;
    height: 48px;
    border: 1px solid #FF8182;
    background: #FFEBE9;
    color: #CF222E;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
}

.delete-confirm-title {
    font-family: var(--font-ui);
    font-size: 16px;
    font-weight: 700;
    margin: 0 0 12px;
    color: #0F0F0F;
    text-transform: uppercase;
}

.delete-confirm-msg-info {
    background: #F8F9FA;
    border: 1px solid #E5E8EB;
    padding: 10px;
    margin-bottom: 12px;
    font-family: var(--font-mono);
    font-size: 12px;
    color: #586069;
}

.delete-confirm-warning {
    font-size: 11px;
    color: #8C959F;
    margin-bottom: 20px;
}

.delete-confirm-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.delete-btn-cancel {
    padding: 8px 24px;
    background: #FFFFFF;
    border: 1px solid #D0D4D9;
    color: #1A1A1A;
    font-family: var(--font-ui);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.2s;
}

.delete-btn-cancel:hover { background: #F8F9FA; border-color: #1A1A1A; }

.delete-btn-confirm {
    padding: 8px 24px;
    background: #CF222E;
    color: #FFFFFF;
    border: 1px solid #CF222E;
    font-family: var(--font-ui);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    text-transform: uppercase;
}

.delete-btn-confirm:hover { background: #A71D2A; }

/* ═══════════════════════════════════════════════════════════════
   战况报告：战术简报面板
   ═══════════════════════════════════════════════════════════════ */

.sitrep-panel {
    background: #FFFFFF;
    border: 1px solid #D0D4D9;
    box-shadow: none; /* 彻底剥离阴影 */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

/* 废除旧版装饰性渐变线，改用企业级左侧锚定实线 */
.sitrep-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 2px;
    background: #1A1A1A; /* 纯黑锚定，提供结构张力 */
}

/* --- Section 通用排版 --- */
.sitrep-section {
    padding: 12px 16px 12px 20px;
    border-bottom: 1px solid #E5E8EB; /* 极细硬切线 */
}

.sitrep-section-last {
    border-bottom: none;
}

/* --- Section Header (北极模式优化) --- */
.sitrep-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.sitrep-tag {
    background: #1A1A1A;
    color: #FFFFFF;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.1em;
    font-family: var(--font-mono);
    text-transform: uppercase;
}

.sitrep-tag-sm {
    background: #F2F3F5;
    color: #586069;
    border: 1px solid #D0D4D9;
    padding: 2px 6px;
    font-size: 9px;
    font-weight: 600;
    font-family: var(--font-mono);
    text-transform: uppercase;
}

.sitrep-title {
    font-family: var(--font-ui);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.05em;
    color: #0F0F0F;
    text-transform: uppercase;
}

/* 实时指示器：废除发光与呼吸，采用实色方块 */
.sitrep-live {
    margin-left: auto;
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    color: #2E8B57;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 4px;
}

.sitrep-live i {
    width: 6px;
    height: 6px;
    background: #2E8B57;
    border-radius: 0; /* 坚持硬切方块 */
    margin: 0;
    animation: none; /* 废除多余动画 */
}

/* ═══════════════════════════════
   高密度队列
   ═══════════════════════════════ */

.priority-queue {
    display: flex;
    flex-direction: column;
    gap: 1px; /* 采用硬碰撞布局 */
    background: #E5E8EB;
}

.pq-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    background: #FFFFFF;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
}

.pq-item:hover {
    background: #F8F9FA;
    transform: none; /* 拒绝位移 */
}

.pq-rank {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    font-family: var(--font-mono);
    color: #FFFFFF;
    background: #586069;
    flex-shrink: 0;
}

.pq-rank-Critical { background: #CF222E; }
.pq-rank-High { background: #9A6700; }
.pq-rank-Medium, .pq-rank-Moderate { background: #1A1A1A; }
.pq-rank-Low { background: #8C959F; }

.pq-body {
    flex: 1;
    min-width: 0;
}

.pq-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
}

.pq-id {
    font-family: var(--font-mono);
    font-size: 10px;
    color: #8C959F;
    font-weight: 600;
    font-variant-numeric: tabular-nums; /* 核心：强制等宽 */
}

.pq-urgency {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    padding: 1px 4px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
}

.pq-u-Critical { background: #FFEBE9; color: #CF222E; border: 1px solid #FF8182; }
.pq-u-High { background: #FFF8C5; color: #9A6700; border: 1px solid #E6CC7A; }
.pq-u-Medium, .pq-u-Moderate { background: #F2F3F5; color: #586069; border: 1px solid #D0D4D9; }

.pq-title {
    font-family: var(--font-ui);
    font-size: 13px;
    font-weight: 700;
    color: #0F0F0F;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.pq-loc {
    font-size: 11px;
    color: #586069;
    margin-top: 1px;
}

.pq-loc i {
    color: #1A1A1A;
    margin-right: 4px;
    font-size: 12px;
}

.pq-arrow {
    color: #D0D4D9;
    font-size: 12px;
    transition: color 0.2s, transform 0.2s;
}

.pq-item:hover .pq-arrow {
    color: #1A1A1A;
    transform: translateX(2px);
}

.pq-empty {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #F8F9FA;
    color: #8C959F;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
}

.pq-empty i {
    font-size: 14px;
    color: #2E8B57;
}

/* ═══════════════════════════════
   第2节：部署
   ═══════════════════════════════ */

.deploy-grid {
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 8px 0;
    margin-bottom: 12px;
    background: #FFFFFF; /* 强制洗白 */
    border: 1px solid #D0D4D9;
}

.deploy-stat {
    text-align: center;
    padding: 0 12px;
    flex: 1;
}

.deploy-num {
    font-family: var(--font-mono);
    font-size: 20px;
    font-weight: 700;
    color: #0F0F0F;
    line-height: 1;
    font-variant-numeric: tabular-nums; /* 核心：强制等宽 */
}

.deploy-num.deploy-alert {
    color: #CF222E; /* 熔断红 */
}

.deploy-num.deploy-dim {
    color: #8C959F;
}

.deploy-label {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    color: #586069;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-top: 4px;
}

.deploy-divider {
    width: 1px;
    height: 24px; /* 缩短分割线 */
    background: #E5E8EB;
}

.deploy-roster {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 8px 0;
}

.deploy-op {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    padding: 2px 0;
    border-bottom: 1px solid #F2F3F5; /* 虚线改实线 */
}

.deploy-op:last-child {
    border-bottom: none;
}

.deploy-dot {
    width: 4px;
    height: 4px;
    border-radius: 0; /* 移除圆角 */
    background: #D0D4D9;
    flex-shrink: 0;
}

.deploy-dot.online {
    background: #2E8B57; /* 报表绿 */
    box-shadow: none; /* 移除发光 */
}

.deploy-dot.busy {
    background: #9A6700; /* 琥珀黄 */
}

.deploy-name {
    font-family: var(--font-ui);
    font-weight: 600;
    color: #0F0F0F;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.deploy-zone {
    font-family: var(--font-mono);
    font-size: 9px;
    color: #8C959F;
    font-weight: 600;
    text-align: right;
    text-transform: uppercase;
}

/* ═══════════════════════════════
   第3节：活动流
   ═══════════════════════════════ */

.activity-stream {
    display: flex;
    flex-direction: column;
    gap: 0;
    background: #F8F9FA; /* 废除纯黑背景，改为低阻抗灰 */
    border: 1px solid #D0D4D9;
    padding: 8px;
    font-family: var(--font-mono);
    font-size: 10px;
    max-height: 140px; /* 稍微增加高度提高数据密度 */
    overflow-y: auto;
}

.stream-item {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 4px 0;
    border-bottom: 1px solid #E5E8EB;
    color: #586069;
}

.stream-item:last-child {
    border-bottom: none;
}

.stream-time {
    color: #8C959F;
    font-size: 9px;
    min-width: 45px;
    flex-shrink: 0;
    font-variant-numeric: tabular-nums;
}

.stream-user {
    color: #1A1A1A;
    font-weight: 700;
    flex-shrink: 0;
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-transform: uppercase;
}

.stream-action {
    color: #586069;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- Activity Stream 滚动条对齐 --- */
.activity-stream::-webkit-scrollbar { width: 4px; }
.activity-stream::-webkit-scrollbar-track { background: transparent; }
.activity-stream::-webkit-scrollbar-thumb { background: #D0D4D9; }
.activity-stream::-webkit-scrollbar-thumb:hover { background: #8C959F; }

/* ═══════════════════════════════
   页脚装饰 
   ═══════════════════════════════ */
.sitrep-footer {
  display: flex;
  justify-content: space-between;
  padding: 8px 16px;
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 600;
  color: #8C959F;
  letter-spacing: 0.05em;
  background: #FFFFFF;
  border-top: 1px solid #E5E8EB;
  text-transform: uppercase;
}

/* ══════════════════════════════════════════
   第27部分：烤面包机通知系统
   ══════════════════════════════════════════ */
.toast-container {
  position: fixed;
  top: 16px;
  right: 16px;
  /* 确保处于绝对顶层，压制侧边栏与模态框 */
  z-index: 1060000;
  display: flex;
  flex-direction: column;
  gap: 4px;
  pointer-events: none;
  max-width: 400px;
}

.vol-toast {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  /* 废除圆角与模糊，回归硬核直角 */
  border-radius: 0;
  background: #FFFFFF;
  border: 1px solid #D0D4D9;
  font-family: var(--font-ui);
  font-size: 13px;
  font-weight: 600;
  line-height: 1.4;
  color: #0F0F0F;
  /* 采用极简的物理阴影 */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  pointer-events: auto;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  animation: toastSlideIn 0.25s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  transition: opacity 0.2s, transform 0.2s;
}

/* 状态信号线：4px 战术硬色块 */
.vol-toast::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
}

.vol-toast.toast-exit {
  animation: toastSlideOut 0.2s ease forwards;
}

/* Success - 报表绿 */
.vol-toast.toast-success::before { background: #2E8B57; }
.vol-toast.toast-success .toast-icon { color: #2E8B57; }

/* Error - 熔断红 */
.vol-toast.toast-error::before { background: #CF222E; }
.vol-toast.toast-error .toast-icon { color: #CF222E; }

/* Warning - 琥珀黄 */
.vol-toast.toast-warning::before { background: #9A6700; }
.vol-toast.toast-warning .toast-icon { color: #9A6700; }

/* Info - 企业蓝 */
.vol-toast.toast-info::before { background: #0969DA; }
.vol-toast.toast-info .toast-icon { color: #0969DA; }

.toast-icon {
  font-size: 14px;
  flex-shrink: 0;
}

.toast-message {
  flex: 1;
  word-break: break-word;
}

.toast-close {
  font-size: 10px;
  color: #8C959F;
  opacity: 0.6;
  flex-shrink: 0;
  padding: 4px;
  transition: color 0.2s;
}
.toast-close:hover {
  color: #1A1A1A;
}

@keyframes toastSlideIn {
  from { transform: translateX(100%); opacity: 0; }
  to   { transform: translateX(0);   opacity: 1; }
}

@keyframes toastSlideOut {
  from { transform: translateX(0);   opacity: 1; }
  to   { transform: translateX(100%); opacity: 0; }
}

/* 响应式断点修正 */
@media (max-width: 600px) {
  .toast-container {
    top: auto;
    bottom: 24px;
    right: 16px;
    left: 16px;
    max-width: none;
  }
  .vol-toast {
    font-size: 12px;
    padding: 10px 14px;
  }
}

/* ══════════════════════════════════════════
   PART 28: KANBAN MATRIX [ARCHITECTURE: ARCTIC_COMMAND]
   ══════════════════════════════════════════ */

/* --- 矩阵布局 --- */
.kanban-board-v5 {
  display: grid;
  grid-template-columns: 1fr 1fr 0.8fr 1fr; /* 优化侧边栏占比 */
  gap: 1px; /* 采用硬碰撞缝隙 */
  background: #D0D4D9; /* 用背景色填充缝隙作为分割线 */
  width: 100%;
  min-height: 400px;
  border: 1px solid #D0D4D9;
}

.kanban-col {
  background: #FFFFFF;
  border: none;
  border-radius: 0;
  display: flex;
  flex-direction: column;
  min-height: 200px;
  max-height: calc(100vh - 280px);
  transition: background 0.2s ease;
}

.kanban-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  border-bottom: 1px solid #D0D4D9;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: #1A1A1A;
  text-transform: uppercase;
  position: sticky;
  top: 0;
  background: #F8F9FA; /* 稍微深于白色的表头背景 */
  z-index: 10;
}

.kanban-header-icon { font-size: 12px; color: #586069; }
.kanban-header-title { flex: 1; }

.kanban-count {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  color: #586069;
  font-variant-numeric: tabular-nums;
  padding-left: 8px;
  border-left: 1px solid #D0D4D9;
}

.kanban-body {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* --- 战术状态硬切线 [SLA SIGNALS] --- */
.kanban-col-assigned .kanban-header { border-bottom: 4px solid #0969DA; }
.kanban-col-inprogress .kanban-header { border-bottom: 4px solid #9A6700; }
.kanban-col-onhold .kanban-header { border-bottom: 4px solid #586069; }
.kanban-col-done .kanban-header { border-bottom: 4px solid #2E8B57; }

/* --- 任务卡片 --- */
.kanban-card {
  position: relative;
  background: #FFFFFF;
  border: 1px solid #D0D4D9;
  border-radius: 0;
  padding: 12px;
  cursor: grab;
  transition: border-color 0.2s, box-shadow 0.2s;
  user-select: none;
}

.kanban-card:hover {
  border-color: #1A1A1A;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  transform: none; /* 废除位移 */
}

.kanban-card:active { cursor: grabbing; }

/* 紧急程度左侧标记线从 3px 强化至 4px */
.kanban-card.urgency-critical {
  border-left: 4px solid #CF222E;
}

.kanban-card-id {
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 700;
  color: #1A1A1A;
  margin-bottom: 6px;
  font-variant-numeric: tabular-nums;
}

.kanban-card-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  font-size: 11px;
}

.kanban-card-urgency {
  font-family: var(--font-mono);
  padding: 1px 6px;
  border: 1px solid transparent;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

.urgency-critical { background: #FFEBE9; color: #CF222E; border-color: #FF8182; }
.urgency-high     { background: #FFF8C5; color: #9A6700; border-color: #E6CC7A; }
.urgency-medium   { background: #F1F8FF; color: #0969DA; border-color: #B6D4FE; }
.urgency-low      { background: #F2F3F5; color: #586069; border-color: #D0D4D9; }

.kanban-card-time { 
  font-family: var(--font-mono); 
  color: #8C959F; 
  font-size: 10px; 
  font-variant-numeric: tabular-nums;
}

.kanban-card-zone {
  font-family: var(--font-ui);
  font-size: 11px;
  color: #586069;
  margin-top: 6px;
  font-weight: 500;
}

.kanban-card-assignee {
  font-size: 11px;
  color: #586069;
  margin-top: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.kanban-card-assignee i { color: #8C959F; }

/* --- SLA 数据条压缩 --- */
.kanban-card-sla { margin-top: 10px; }
.sla-bar {
  height: 2px; /* 压薄至 2px */
  background: #E5E8EB;
  border-radius: 0;
  overflow: hidden;
}
.sla-fill {
  height: 100%;
  border-radius: 0;
  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  background: #1A1A1A; /* 默认黑 */
}

/* --- 历史归档态 --- */
.kanban-card-done {
  opacity: 0.6;
  background: #F8F9FA;
  cursor: default;
}
.kanban-card-done:hover {
  border-color: #D0D4D9;
  box-shadow: none;
}
.kanban-card-done-icon { color: #2E8B57; }

/* --- 交互接管：移除“旋转”与“缩放”动效 --- */
.kanban-card.dragging {
  opacity: 0.2 !important;
  transform: none !important; /* 废除旋转 */
  box-shadow: none !important;
  border: 1px dashed #1A1A1A !important;
}

.kanban-col.drag-over {
  background: #F1F8FF !important; /* 战术蓝引导背景 */
  outline: 2px solid #0969DA !important;
  outline-offset: -2px;
}

/* --- 空矩阵提示 --- */
.kanban-empty {
  padding: 32px 16px;
  color: #8C959F;
  font-family: var(--font-mono);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

/* --- 响应式断点回归 --- */
@media (max-width: 1200px) {
  .kanban-board-v5 { grid-template-columns: 1fr 1fr; gap: 1px; }
}
@media (max-width: 768px) {
  .kanban-board-v5 { grid-template-columns: 1fr; }
}

/* ══════════════════════════════════════════
   第29部分：批量操作
   ══════════════════════════════════════════ */

/* --- バッチモード切替ボタン (批量模式切换键) --- */
.batch-toggle-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border: 1px solid #D0D4D9;
  border-radius: 0; /* 废除圆角 */
  background: #FFFFFF;
  color: #586069;
  font-family: var(--font-ui);
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  cursor: pointer;
  transition: all 0.2s;
}

.batch-toggle-btn:hover { 
  border-color: #1A1A1A; 
  color: #1A1A1A; 
  background: #F8F9FA;
}

.batch-toggle-btn.active {
  background: #1A1A1A;
  color: #FFFFFF;
  border-color: #1A1A1A;
}

.batch-select-all-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border: 1px solid #D0D4D9;
  border-radius: 0;
  background: transparent;
  color: #1A1A1A;
  font-family: var(--font-ui);
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  cursor: pointer;
  margin-left: 4px;
  transition: background 0.2s;
}

.batch-select-all-btn:hover { 
  background: #F8F9FA; 
}

/* --- カード内チェックボックス (卡片内复选框) --- */
.batch-checkbox {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
  font-size: 16px;
  color: #8C959F;
  cursor: pointer;
  transition: color 0.15s;
}

.batch-checkbox:hover { color: #1A1A1A; }
.batch-selected .batch-checkbox { color: #1A1A1A; }

/* --- 選択中カード (选中态卡片) --- */
.kanban-card.batch-selected {
  outline: 2px solid #1A1A1A !important; /* 强制纯黑轮廓锚定 */
  outline-offset: -2px;
  background: #F8F9FA !important; /* 微灰底色区分 */
  border-color: transparent !important;
}

/* カードを relative にする */
.kanban-card {
  position: relative;
}

/* バッチモード時のカード左パディング */
.kanban-card .batch-checkbox + * {
  margin-left: 24px;
}

/* --- フローティング操作バー (悬浮控制台) --- */
.batch-action-bar {
  position: fixed !important;
  bottom: 24px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 2100000 !important;
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px 20px;
  background: #FFFFFF; /* 废除深色渐变，采用纯白指挥台 */
  border: 1px solid #1A1A1A; /* 纯黑硬框 */
  border-radius: 0; /* 废除圆角药丸设计 */
  box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,0,0,0.05); /* 物理弥散阴影 */
  animation: batchBarSlideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  pointer-events: auto;
}

.batch-bar-info {
  color: #586069;
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.batch-bar-info strong {
  color: #0F0F0F;
  font-size: 16px;
  font-weight: 700;
  font-variant-numeric: tabular-nums; /* 核心：选中数量强制等宽 */
}

.batch-bar-actions {
  display: flex;
  gap: 8px;
  border-left: 1px solid #E5E8EB;
  padding-left: 16px;
}

.batch-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 16px;
  border: 1px solid transparent;
  border-radius: 0;
  font-family: var(--font-ui);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  text-transform: uppercase;
}

.batch-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  filter: grayscale(100%);
}

/* 按钮战术色重构 */
.batch-btn-assign { background: #0969DA; color: #FFFFFF; }
.batch-btn-assign:hover:not(:disabled) { background: #0858B5; }

.batch-btn-progress { background: #9A6700; color: #FFFFFF; }
.batch-btn-progress:hover:not(:disabled) { background: #805600; }

.batch-btn-complete { background: #2E8B57; color: #FFFFFF; }
.batch-btn-complete:hover:not(:disabled) { background: #246B43; }

/* 取消按钮回归中性 */
.batch-btn-cancel { 
  background: #F8F9FA; 
  color: #1A1A1A; 
  border-color: #D0D4D9; 
}
.batch-btn-cancel:hover:not(:disabled) { background: #E5E8EB; }

.batch-bar-close {
  background: none;
  border: none;
  color: #8C959F;
  font-size: 16px;
  cursor: pointer;
  padding: 4px;
  margin-left: 8px;
  transition: color 0.2s;
}

.batch-bar-close:hover { color: #CF222E; }

@keyframes batchBarSlideUp {
  from { transform: translateX(-50%) translateY(24px); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0);    opacity: 1; }
}

/* --- Mobile --- */
@media (max-width: 600px) {
  .batch-action-bar {
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    transform: none !important;
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
    padding: 16px;
    border-top: 1px solid #1A1A1A;
    border-bottom: none;
    border-left: none;
    border-right: none;
  }
  
  .batch-bar-info { justify-content: space-between; }
  
  .batch-bar-actions { 
    flex-wrap: wrap; 
    border-left: none; 
    padding-left: 0; 
    padding-top: 12px; 
    border-top: 1px solid #E5E8EB; 
  }
  
  .batch-btn { flex: 1; justify-content: center; }
  
  @keyframes batchBarSlideUp {
    from { transform: translateY(100%); opacity: 0; }
    to   { transform: translateY(0);    opacity: 1; }
  }
}

/* ══════════════════════════════════════════
   第三十一 离线
   ══════════════════════════════════════════ */

/* --- 接続状態 (系统连接状态) --- */
.sys-status-dot {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 0; /* 废除圆角，坚持硬切方块 */
  background: #2E8B57; /* 报表绿 */
  margin-right: 6px;
  animation: none; /* 废除呼吸灯，保持绝对静默 */
}

.sys-status-dot.offline {
  background: #CF222E; /* 熔断红 */
}

.sys-status.sys-offline {
  color: #CF222E !important;
  font-weight: 700;
}

/* --- キューバッジ (离线队列徽章) --- */
.offline-queue-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 2px 8px;
  margin-left: 8px;
  background: #FFF8C5; /* 琥珀黄警示底色 */
  color: #9A6700;
  border: 1px solid #E6CC7A;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-radius: 0;
  cursor: pointer;
  transition: all 0.2s;
  font-variant-numeric: tabular-nums; /* 数值强制等宽 */
}

.offline-queue-badge:hover {
  background: #E6CC7A;
  color: #1A1A1A;
}

/* --- オフラインバナー (全局离线横幅) --- */
.offline-banner {
  width: 100%;
  padding: 8px 16px;
  background: #FFEBE9; /* 废除深色渐变，采用浅色高反差底 */
  border-bottom: 1px solid #FF8182;
  color: #CF222E;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-align: center;
  text-transform: uppercase;
  animation: none; /* 废除脉冲动画 */
}

/* --- ゾーンセレクト確認状態 (区域同步状态) --- */
.zone-select {
  transition: border-color 0.2s, background 0.2s;
}

.zone-select.zone-synced {
  border-color: #2E8B57 !important;
  background: #EAF9F1 !important; /* 同步成功给予极弱的绿色反馈 */
}

/* --- オフライン時の操作ボタン変化 (离线模式下组件的状态覆写) --- */
.offline-mode .kanban-card {
  cursor: default; /* 禁用拖拽指针 */
}

.offline-mode .batch-btn,
.offline-mode .kanban-card[draggable="true"] {
  position: relative;
  /* 离线时加深边框以示区隔 */
  border-color: #E6CC7A !important; 
}

/* 废除不严谨的 Emoji (⚡)，转换为军用级数据挂起角标 */
.offline-mode .batch-btn::after,
.offline-mode .kanban-card[draggable="true"]::after {
  content: 'QUEUED';
  position: absolute;
  top: 0;
  right: 0;
  background: #FFF8C5;
  color: #9A6700;
  border-left: 1px solid #E6CC7A;
  border-bottom: 1px solid #E6CC7A;
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 700;
  padding: 2px 6px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  z-index: 5;
}

/* 针对按钮尺寸的微调 */
.offline-mode .batch-btn::after {
  font-size: 8px;
  padding: 1px 4px;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 40: CAD DISPATCH OVERVIEW [ARCHITECTURE: ARCTIC_COMMAND]
   Append this to the END of your existing CSS
   ═══════════════════════════════════════════════════════════════════════════════════════ */

/* --- Status Strip (状态带) --- */
.cad-status-strip {
  display: flex;
  align-items: center;
  gap: 0;
  padding: 0;
  height: 36px;
  background: #FFFFFF;
  border-bottom: 1px solid #D0D4D9;
  font-family: var(--font-mono);
  font-size: 11px;
  flex-shrink: 0;
  overflow-x: auto;
}

.cad-strip-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 0 16px;
  height: 100%;
  border-right: 1px solid #E5E8EB;
  white-space: nowrap;
  cursor: default;
  transition: background 0.2s;
}
.cad-strip-item:last-child { border-right: none; }
.cad-strip-item:hover { background: #F8F9FA; }
.cad-strip-item.clickable { cursor: pointer; }

.cad-strip-label {
  color: #586069;
  font-size: 9px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-weight: 600;
}

.cad-strip-value {
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  color: #0F0F0F;
  font-family: var(--font-ui);
  font-size: 14px;
}
.cad-strip-value.critical { color: #CF222E; }
.cad-strip-value.warning { color: #9A6700; }
.cad-strip-value.nominal { color: #2E8B57; }
.cad-strip-value.info { color: #0969DA; }

.cad-strip-dot {
  width: 6px;
  height: 6px;
  border-radius: 0; /* 废除圆角 */
  flex-shrink: 0;
}
.cad-strip-dot.red { background: #CF222E; box-shadow: none; }
.cad-strip-dot.amber { background: #9A6700; }
.cad-strip-dot.green { background: #2E8B57; box-shadow: none; }

/* --- Three-Panel Dispatch Grid (三栏调度矩阵) --- */
.cad-dispatch-grid {
  display: grid;
  grid-template-columns: 320px 1fr 280px;
  grid-template-rows: 1fr;
  flex: 1;
  min-height: 0;
  gap: 1px; /* 物理硬分割 */
  background: #D0D4D9; /* 底色填充间隙，形成极细边框 */
}

/* --- Left Panel: Alert Feed --- */
.cad-panel-left {
  background: #FFFFFF;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.cad-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  border-bottom: 1px solid #D0D4D9;
  flex-shrink: 0;
  background: #F8F9FA;
}

.cad-panel-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 11px;
  letter-spacing: 0.1em;
  color: #1A1A1A;
  text-transform: uppercase;
}
.cad-panel-title i { font-size: 14px; color: #586069; }

.cad-panel-badge {
  padding: 2px 8px;
  border-radius: 0; /* 废除药丸圆角 */
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  background: #FFFFFF;
  color: #586069;
  border: 1px solid #D0D4D9;
}
.cad-panel-badge.alert {
  background: #FFEBE9;
  color: #CF222E;
  border-color: #FF8182;
}

.cad-live-dot {
  width: 6px;
  height: 6px;
  border-radius: 0; /* 废除圆角 */
  background: #2E8B57;
  box-shadow: none; /* 废除发光 */
  animation: none; /* 废除呼吸闪烁，保持静默监控 */
  flex-shrink: 0;
}

.cad-panel-body {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
}
.cad-panel-body::-webkit-scrollbar { width: 4px; }
.cad-panel-body::-webkit-scrollbar-track { background: transparent; }
.cad-panel-body::-webkit-scrollbar-thumb { background: #D0D4D9; border-radius: 0; }
.cad-panel-body::-webkit-scrollbar-thumb:hover { background: #8C959F; }

/* --- Alert Feed Items --- */
.cad-alert-item {
  display: flex;
  align-items: stretch;
  border-bottom: 1px solid #E5E8EB;
  cursor: pointer;
  transition: background 0.2s;
}
.cad-alert-item:hover { background: #F8F9FA; }

.cad-alert-priority-bar {
  width: 4px; /* 加粗至 4px 提升视觉识别率 */
  flex-shrink: 0;
  background: #E5E8EB;
}
.cad-alert-priority-bar.p-critical { background: #CF222E; }
.cad-alert-priority-bar.p-high { background: #9A6700; }
.cad-alert-priority-bar.p-moderate { background: #0969DA; }
.cad-alert-priority-bar.p-low { background: #8C959F; }

.cad-alert-body {
  flex: 1;
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 0;
}

.cad-alert-row-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.cad-alert-id {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  color: #586069;
  font-variant-numeric: tabular-nums;
}

.cad-alert-urgency {
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 0;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  border: 1px solid transparent;
}
.cad-alert-urgency.u-critical { background: #FFEBE9; color: #CF222E; border-color: #FF8182; }
.cad-alert-urgency.u-high { background: #FFF8C5; color: #9A6700; border-color: #E6CC7A; }
.cad-alert-urgency.u-moderate { background: #F1F8FF; color: #0969DA; border-color: #B6D4FE; }
.cad-alert-urgency.u-low { background: #F8F9FA; color: #8C959F; border-color: #D0D4D9; }

.cad-alert-title {
  font-family: var(--font-ui);
  font-size: 13px;
  font-weight: 700;
  color: #0F0F0F;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.cad-alert-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 10px;
  color: #8C959F;
  font-family: var(--font-mono);
}
.cad-alert-meta i { font-size: 10px; color: #586069; }

.cad-alert-sla {
  height: 2px;
  background: #E5E8EB;
  border-radius: 0;
  overflow: hidden;
  margin-top: 4px;
}
.cad-alert-sla-fill {
  height: 100%;
  border-radius: 0;
  transition: width 0.3s;
  background: #1A1A1A;
}

.cad-alert-arrow {
  display: flex;
  align-items: center;
  padding: 0 12px;
  color: #D0D4D9;
  font-size: 12px;
  transition: transform 0.2s, color 0.2s;
}
.cad-alert-item:hover .cad-alert-arrow {
  color: #1A1A1A;
  transform: translateX(4px);
}

.cad-empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px 24px;
  gap: 12px;
  color: #8C959F;
}
.cad-empty-state i { font-size: 32px; color: #D0D4D9; }
.cad-empty-state span { font-family: var(--font-mono); font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; }

/* --- Center Panel --- */
.cad-panel-center {
  background: #FFFFFF;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.cad-center-top {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px; /* 物理分割 */
  background: #D0D4D9;
  flex-shrink: 0;
}

.cad-resource-widget,
.cad-intel-widget {
  background: #FFFFFF;
  padding: 16px;
}

.cad-widget-label {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  color: #586069;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.cad-widget-label i { font-size: 12px; color: #1A1A1A; }

.cad-res-item {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}
.cad-res-item:last-child { margin-bottom: 0; }

.cad-res-name {
  font-family: var(--font-mono);
  font-size: 10px;
  color: #586069;
  width: 64px;
  flex-shrink: 0;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.cad-res-bar {
  flex: 1;
  height: 4px;
  background: #E5E8EB;
  border-radius: 0;
  overflow: hidden;
}

.cad-res-fill {
  height: 100%;
  border-radius: 0;
  transition: width 0.4s ease;
}
.cad-res-fill.low { background: #CF222E; }
.cad-res-fill.medium { background: #9A6700; }
.cad-res-fill.high { background: #2E8B57; }

.cad-res-pct {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  color: #0F0F0F;
  width: 36px;
  text-align: right;
  font-variant-numeric: tabular-nums;
}
.cad-res-pct.low { color: #CF222E; }

.cad-intel-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

.cad-intel-metric {
  text-align: center;
  padding: 12px 8px;
  background: #F8F9FA;
  border-radius: 0; /* 废除圆角 */
  border: 1px solid #E5E8EB;
  transition: background 0.2s, border-color 0.2s;
}
.cad-intel-metric:hover { border-color: #1A1A1A; background: #FFFFFF; transform: none; }

.cad-intel-value {
  font-family: var(--font-ui);
  font-size: 24px;
  font-weight: 700;
  color: #0F0F0F;
  font-variant-numeric: tabular-nums;
  line-height: 1;
}

.cad-intel-label {
  font-family: var(--font-mono);
  font-size: 9px;
  color: #586069;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  margin-top: 6px;
}

/* --- Center Activity Terminal --- */
.cad-center-terminal {
  flex: 1;
  background: #FFFFFF;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-top: 1px solid #D0D4D9;
}

.cad-terminal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  border-bottom: 1px solid #E5E8EB;
  flex-shrink: 0;
  background: #F8F9FA;
}

.cad-terminal-title {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  color: #1A1A1A;
  letter-spacing: 0.1em;
  display: flex;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
}
.cad-terminal-title i { color: #586069; }

.cad-terminal-live {
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 700;
  color: #2E8B57;
  letter-spacing: 0.05em;
  animation: none; /* 废除呼吸闪烁 */
}

.cad-terminal-body {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px;
  font-family: var(--font-mono);
  font-size: 11px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.cad-term-line {
  display: flex;
  gap: 12px;
  align-items: baseline;
  padding: 2px 0;
  border-bottom: 1px solid #F2F3F5;
}
.cad-term-line:last-child { border-bottom: none; }

.cad-term-time { color: #8C959F; font-size: 10px; min-width: 48px; font-variant-numeric: tabular-nums; }
.cad-term-user { color: #0969DA; font-weight: 700; font-size: 10px; text-transform: uppercase; }
.cad-term-action { color: #586069; font-size: 11px; }
.cad-term-line.cad-warn .cad-term-action { color: #9A6700; font-weight: 600; }
.cad-term-line.cad-crit .cad-term-action { color: #CF222E; font-weight: 600; }

/* --- Right Panel: Operator Roster --- */
.cad-panel-right {
  background: #FFFFFF;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.cad-deploy-summary {
  display: flex;
  align-items: center;
  gap: 0;
  border-bottom: 1px solid #D0D4D9;
  flex-shrink: 0;
  background: #F8F9FA;
}

.cad-deploy-stat {
  flex: 1;
  text-align: center;
  padding: 12px 4px;
  border-right: 1px solid #E5E8EB;
}
.cad-deploy-stat:last-child { border-right: none; }

.cad-deploy-num {
  font-family: var(--font-ui);
  font-size: 20px;
  font-weight: 700;
  color: #0F0F0F;
  font-variant-numeric: tabular-nums;
  line-height: 1;
}
.cad-deploy-num.green { color: #2E8B57; }
.cad-deploy-num.amber { color: #9A6700; }
.cad-deploy-num.dim { color: #8C959F; }

.cad-deploy-label {
  font-family: var(--font-mono);
  font-size: 9px;
  color: #586069;
  letter-spacing: 0.05em;
  margin-top: 4px;
  text-transform: uppercase;
}

.cad-operator-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 16px;
  border-bottom: 1px solid #E5E8EB;
  cursor: pointer;
  transition: background 0.2s;
}
.cad-operator-item:hover { background: #F8F9FA; }

.cad-op-avatar {
  width: 32px;
  height: 32px;
  border-radius: 0; /* 废除头像圆角 */
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 12px;
  flex-shrink: 0;
  font-family: var(--font-ui);
  background: #F2F3F5;
  color: #1A1A1A;
  border: 1px solid #D0D4D9;
  position: relative;
}

.cad-op-status-dot {
  position: absolute;
  bottom: -3px;
  right: -3px;
  width: 8px;
  height: 8px;
  border-radius: 0; /* 方块状态灯 */
  border: 1px solid #FFFFFF; /* 用纯白边框进行空间切割 */
}
.cad-op-status-dot.online { background: #2E8B57; }
.cad-op-status-dot.busy { background: #9A6700; }
.cad-op-status-dot.offline { background: #8C959F; }

.cad-op-info { flex: 1; min-width: 0; }

.cad-op-name {
  font-family: var(--font-ui);
  font-size: 13px;
  font-weight: 700;
  color: #0F0F0F;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}

.cad-op-role {
  font-family: var(--font-mono);
  font-size: 9px;
  color: #586069;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

.cad-op-load { width: 48px; flex-shrink: 0; text-align: right; }

.cad-op-load-bar {
  height: 2px; /* 压薄进度条 */
  background: #E5E8EB;
  border-radius: 0;
  overflow: hidden;
  margin-bottom: 4px;
}
.cad-op-load-fill {
  height: 100%;
  border-radius: 0;
  background: #1A1A1A;
  transition: width 0.3s;
}
.cad-op-load-fill.high { background: #CF222E; }
.cad-op-load-fill.medium { background: #9A6700; }

.cad-op-load-text {
  font-family: var(--font-mono);
  font-size: 9px;
  color: #586069;
  font-variant-numeric: tabular-nums;
}

/* --- CAD Responsive --- */
@media (max-width: 1200px) {
  .cad-dispatch-grid { grid-template-columns: 280px 1fr 260px; }
}
@media (max-width: 900px) {
  .cad-dispatch-grid {
    grid-template-columns: 1fr;
    grid-template-rows: auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: transparent;
  }
  .cad-panel-left, .cad-panel-center, .cad-panel-right {
    min-height: 300px;
    border: 1px solid #D0D4D9;
  }
  .cad-center-top { grid-template-columns: 1fr; }
}
@media (max-width: 600px) {
  .cad-status-strip { overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
  .cad-status-strip::-webkit-scrollbar { display: none; }
}

/* --- Hide old Overview elements --- */
.view-dashboard .two-column-layout,
.view-dashboard .resource-section-enhanced,
.view-dashboard .data-stream-widget,
.view-dashboard .sitrep-panel,
.view-dashboard .metal-divider-glow,
.view-dashboard .monitoring-panel,
.view-dashboard .side-panel-wrapper,
.view-dashboard .main-system-panel {
  display: none !important;
}

/* ═══════════════════════════════════════════════════════════════════════════════
   P0: HEADER COMPRESSION [ARCHITECTURE: ARCTIC_COMMAND]
   Append to END of CSS.txt
   ═══════════════════════════════════════════════════════════════════════════════ */

/* --- Shrink command header --- */
.command-header {
  padding: 8px 16px !important; /* 统一左右边距 */
  gap: 12px !important;
  border-bottom: 1px solid #D0D4D9 !important; /* 纯色硬切割，废除 rgba */
  background: #FFFFFF !important; /* 强制纯白底色 */
  min-height: 48px !important; /* 锁定紧凑高度 */
}

.logo-icon {
  width: 24px !important; /* 极限压缩图标尺寸 */
  height: 24px !important;
  font-size: 12px !important;
  clip-path: none !important;
  border-radius: 0 !important; /* 废除圆角 */
  animation: none !important;
  background: #1A1A1A !important;
  color: #FFFFFF !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

.logo-title {
  font-family: var(--font-ui) !important;
  font-size: 14px !important;
  font-weight: 700 !important;
  letter-spacing: 0.1em !important;
  text-shadow: none !important;
  color: #0F0F0F !important;
  text-transform: uppercase !important;
}

.logo-subtitle {
  display: none !important;
}

.command-logo {
  gap: 8px !important;
}

.system-status {
  gap: 12px !important;
  font-size: 11px !important;
  font-family: var(--font-mono) !important;
  color: #586069 !important;
}

.system-time {
  font-size: 11px !important;
  font-weight: 600 !important;
  font-variant-numeric: tabular-nums !important; /* 时间跳动强制等宽，拒绝排版抖动 */
  color: #0F0F0F !important;
}

.version-tag {
  padding: 2px 6px !important;
  font-size: 9px !important;
  background: #F8F9FA !important;
  color: #586069 !important;
  border: 1px solid #D0D4D9 !important;
  border-radius: 0 !important;
  font-family: var(--font-mono) !important;
}

/* --- Compress nav tabs into header row --- */
.nav-tabs-custom {
  padding: 0 16px !important;
  background: #F8F9FA !important; /* 微灰底色区分层级 */
  border-bottom: 1px solid #D0D4D9 !important;
  min-height: 36px !important;
}

.nav-tabs-custom .tab {
  padding: 8px 16px !important;
  font-size: 11px !important;
  font-family: var(--font-ui) !important;
  font-weight: 600 !important;
  letter-spacing: 0.05em !important;
  color: #586069 !important;
  text-transform: uppercase !important;
}

.tab-number {
  font-family: var(--font-mono) !important;
  font-size: 10px !important;
  margin-right: 6px !important;
  font-variant-numeric: tabular-nums !important;
}

/* --- Compress volunteer status panel --- */
.volunteer-status-panel {
  padding: 6px 16px !important;
  margin-bottom: 0 !important;
  gap: 16px !important;
  border: none !important;
  border-left: none !important;
  border-bottom: 1px solid #E5E8EB !important; /* 极细底部分割线 */
  background: #FFFFFF !important;
  box-shadow: none !important;
}

.volunteer-status-panel::before {
  display: none !important;
}

.status-row {
  font-family: var(--font-mono) !important;
  font-size: 11px !important;
  gap: 8px !important;
  color: #586069 !important;
}

.status-row i {
  font-size: 12px !important;
  width: 14px !important;
  color: #1A1A1A !important;
}

.btn-online, .btn-offline {
  padding: 4px 12px !important;
  font-size: 10px !important;
  font-family: var(--font-ui) !important;
  font-weight: 600 !important;
  border-radius: 0 !important;
  border: 1px solid transparent !important;
  text-transform: uppercase !important;
}

.btn-online {
  background: #EAF9F1 !important;
  color: #2E8B57 !important;
  border-color: #A2D9B7 !important;
}

.btn-offline {
  background: #F8F9FA !important;
  color: #8C959F !important;
  border-color: #D0D4D9 !important;
}

.zone-select {
  padding: 2px 8px !important;
  font-size: 10px !important;
  font-family: var(--font-mono) !important;
  border-radius: 0 !important;
  border: 1px solid #D0D4D9 !important;
  background: #FFFFFF !important;
  color: #0F0F0F !important;
}

/* --- Shrink alert strip --- */
.sys-alert-strip {
  padding: 6px 16px !important;
  font-size: 11px !important;
  min-height: 28px !important;
  height: auto !important;
  background: #FFFFFF !important;
  border-bottom: 1px solid #CF222E !important; /* 熔断红底线 */
}

.alert-deco {
  font-family: var(--font-mono) !important;
  font-size: 10px !important;
  font-weight: 600 !important;
  color: #CF222E !important;
}

.sys-btn-ghost {
  padding: 4px 12px !important;
  font-size: 10px !important;
  border-radius: 0 !important;
  border: 1px solid #CF222E !important;
  color: #CF222E !important;
  font-family: var(--font-ui) !important;
  font-weight: 600 !important;
  text-transform: uppercase !important;
}

/* ═══════════════════════════════════════════════════════════════════════════════
   P1 &amp; P2: EXTREME DENSITY &amp; FULL-SCREEN LOCK [ARCHITECTURE: ARCTIC_COMMAND]
   Append to absolute END of CSS
   ═══════════════════════════════════════════════════════════════════════════════ */

/* --- Grid Ratio: 完美三栏比例 --- */
.cad-dispatch-grid {
  grid-template-columns: 260px 1fr 260px !important;
}

/* --- Status Strip Compress --- */
.cad-status-strip {
  height: 28px !important;
  font-size: 10px !important;
}
.cad-strip-item {
  padding: 0 10px !important;
  gap: 4px !important;
}
.cad-strip-label {
  font-size: 8px !important;
  letter-spacing: 0.1em !important;
  color: #586069 !important;
}
.cad-strip-value {
  font-size: 11px !important;
}
.cad-strip-dot {
  width: 6px !important;
  height: 6px !important;
  border-radius: 0 !important; /* 强制方块 */
}

/* --- Alert Feed Compress --- */
.cad-panel-header {
  padding: 6px 12px !important;
  background: #F8F9FA !important;
}
.cad-panel-title {
  font-size: 10px !important;
  letter-spacing: 0.1em !important;
}
.cad-alert-item {
  padding: 0 !important;
  min-height: 0 !important;
}
.cad-alert-body {
  padding: 6px 10px !important;
  gap: 2px !important;
}
.cad-alert-title {
  font-size: 12px !important;
  font-weight: 600 !important;
}
.cad-alert-id {
  font-size: 10px !important;
}
.cad-alert-urgency {
  font-size: 8px !important;
  padding: 1px 4px !important;
}
.cad-alert-meta {
  font-size: 9px !important;
  gap: 8px !important;
}
.cad-alert-arrow {
  padding: 0 8px !important;
  font-size: 9px !important;
}
.cad-alert-sla {
  height: 2px !important;
}

/* --- Center Top: Resource &amp; Intel Compress --- */
.cad-center-top {
  flex-shrink: 0 !important;
  max-height: 160px !important;
  overflow: hidden !important;
}
.cad-resource-widget,
.cad-intel-widget {
  padding: 10px 12px !important;
}
.cad-widget-label {
  font-size: 8px !important;
  margin-bottom: 8px !important;
  letter-spacing: 0.1em !important;
}
.cad-res-name {
  width: 50px !important;
  font-size: 9px !important;
}
.cad-res-item {
  margin-bottom: 5px !important;
  gap: 6px !important;
}
.cad-res-pct {
  font-size: 9px !important;
  width: 28px !important;
}
.cad-res-bar {
  height: 4px !important;
}
.cad-intel-metric {
  padding: 6px 4px !important;
}
.cad-intel-value {
  font-size: 18px !important;
}
.cad-intel-label {
  font-size: 7px !important;
}

/* --- Center Terminal: Space Fill &amp; Scanline Purge --- */
.cad-panel-center {
  min-height: 0 !important;
  overflow: hidden !important;
}
.cad-center-terminal {
  flex: 1 1 0 !important;
  min-height: 0 !important;
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden !important;
  background: #FFFFFF !important;
}
.cad-terminal-header {
  padding: 5px 12px !important;
}
.cad-terminal-title {
  font-size: 9px !important;
}
.cad-terminal-live {
  font-size: 8px !important;
}
.cad-terminal-body {
  flex: 1 1 0 !important;
  min-height: 0 !important;
  overflow-y: auto !important;
  padding: 6px 12px !important;
  font-size: 10px !important;
  background: #FFFFFF !important; /* 驳回假扫描线特效，保持数据级纯净 */
}
.cad-term-line {
  padding: 1px 0 !important;
}
.cad-term-time {
  font-size: 9px !important;
  min-width: 36px !important;
}
.cad-term-user {
  font-size: 9px !important;
}
.cad-term-action {
  font-size: 9px !important;
}

/* --- Right Panel: Operator Compress --- */
.cad-deploy-summary {
  padding: 0 !important;
}
.cad-deploy-stat {
  padding: 6px 4px !important;
}
.cad-deploy-num {
  font-size: 16px !important;
}
.cad-deploy-label {
  font-size: 7px !important;
}
.cad-operator-item {
  padding: 6px 12px !important;
  gap: 8px !important;
}
.cad-op-avatar {
  width: 24px !important;
  height: 24px !important;
  font-size: 10px !important;
  border-radius: 0 !important;
}
.cad-op-status-dot {
  width: 6px !important;
  height: 6px !important;
  border-radius: 0 !important;
  right: -4px !important;
  bottom: -4px !important;
}
.cad-op-name {
  font-size: 12px !important;
}
.cad-op-role {
  font-size: 8px !important;
}

/* --- Right Panel: Quick Summary Block --- */
.cad-panel-right .cad-panel-body {
  border-bottom: 1px solid #E5E8EB !important;
}
.cad-right-summary {
  padding: 10px 12px !important;
  flex-shrink: 0 !important;
  border-top: 1px solid #E5E8EB !important;
  background: #F8F9FA !important;
}
.cad-right-summary .cad-widget-label {
  margin-bottom: 6px !important;
}
.cad-right-stat-row {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 3px 0 !important;
  font-family: var(--font-mono) !important;
  font-size: 10px !important;
  color: #586069 !important;
}
.cad-right-stat-row .label {
  color: #8C959F !important;
  font-size: 9px !important;
  letter-spacing: 0.05em !important;
  text-transform: uppercase !important;
}
.cad-right-stat-row .value {
  font-weight: 700 !important;
  color: #0F0F0F !important;
  font-variant-numeric: tabular-nums !important;
}
.cad-right-stat-row .value.danger { color: #CF222E !important; }
.cad-right-stat-row .value.ok { color: #2E8B57 !important; }

/* --- GLOBAL LOCK: Prevent Outside Scroll --- */
html, body, .sp-page-root, section.page {
  height: 100vh !important;
  overflow: hidden !important; 
}

.board-container {
  flex: 1 !important;
  min-height: 0 !important;
  overflow: hidden !important;
  padding: 16px !important; /* 缩减四周全局白边 */
}

/* 修复用户代码中的 .=.view-dashboard 拼写错误 */
.view-dashboard {
  display: flex !important;
  flex-direction: column !important;
  flex: 1 !important;
  min-height: 0 !important;
  height: 100vh !important;
  width: 100% !important;
  overflow: hidden !important;
}

/* NEW */
.cad-strip-divider {
    width: 1px;
    height: 16px;
    background: rgba(255,255,255,0.1);
    margin: 0 4px;
    flex-shrink: 0;
}

.cad-status-strip {
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    align-items: center !important;
}

.cad-status-strip .zone-select {
    background: transparent !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
    color: inherit !important;
}

/* ═══════════════════════════════════════════════════════════════
   OVERVIEW STEP 2: 三栏比例修正 + 中间面板密度提升
   追加到CSS文件末尾
   ═══════════════════════════════════════════════════════════════ */

/* 1. 三栏网格比例：左35% / 中40% / 右25% */
.cad-dispatch-grid {
  display: grid !important;
  grid-template-columns: 2fr 2.2fr 1.4fr !important;
  gap: 1px !important;
  height: 100% !important;
  overflow: hidden !important;
}

/* 2. 各面板基础 */
.cad-panel-left,
.cad-panel-center,
.cad-panel-right {
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden !important;
  min-height: 0 !important;
}

/* 3. Panel Header 统一压缩 */
.cad-panel-header {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 6px 12px !important;
  flex-shrink: 0 !important;
  border-bottom: 1px solid rgba(0,0,0,0.08) !important;
  min-height: 0 !important;
}
.cad-panel-title {
  font-size: 11px !important;
  font-weight: 700 !important;
  letter-spacing: 0.04em !important;
}
.cad-panel-badge {
  font-size: 10px !important;
  padding: 1px 8px !important;
  border-radius: 2px !important;
}

/* 4. Panel Body 可滚动 */
.cad-panel-body {
  flex: 1 !important;
  overflow-y: auto !important;
  min-height: 0 !important;
}

/* 5. 左栏卡片紧凑化 */
.cad-alert-item {
  padding: 8px 10px !important;
  border-bottom: 1px solid rgba(0,0,0,0.06) !important;
  cursor: pointer !important;
  display: flex !important;
  align-items: flex-start !important;
  gap: 8px !important;
}
.cad-alert-body {
  flex: 1 !important;
  min-width: 0 !important;
}
.cad-alert-id {
  font-size: 12px !important;
  font-weight: 700 !important;
  font-family: 'JetBrains Mono', monospace !important;
}
.cad-alert-title {
  font-size: 12px !important;
  line-height: 1.3 !important;
  margin-top: 2px !important;
}
.cad-alert-meta {
  font-size: 10px !important;
  margin-top: 3px !important;
  display: flex !important;
  gap: 8px !important;
  flex-wrap: wrap !important;
}
.cad-alert-meta span {
  white-space: nowrap !important;
}
.cad-alert-urgency {
  font-size: 9px !important;
  padding: 1px 5px !important;
  font-weight: 700 !important;
  border-radius: 2px !important;
}
.cad-alert-arrow {
  flex-shrink: 0 !important;
  font-size: 10px !important;
  padding-top: 4px !important;
}
.cad-alert-priority-bar {
  width: 3px !important;
  min-height: 100% !important;
  flex-shrink: 0 !important;
  border-radius: 2px !important;
}
.cad-alert-sla {
  height: 2px !important;
  margin-top: 4px !important;
  border-radius: 1px !important;
  overflow: hidden !important;
}

/* 6. 中间面板：压缩 Resources + Intel，扩展 Terminal */
.cad-center-top {
  display: flex !important;
  gap: 1px !important;
  flex-shrink: 0 !important;
  max-height: 45% !important;
  overflow: hidden !important;
}
.cad-resource-widget,
.cad-intel-widget {
  flex: 1 !important;
  padding: 8px 12px !important;
  overflow: hidden !important;
}
.cad-widget-label {
  font-size: 10px !important;
  font-weight: 700 !important;
  letter-spacing: 0.04em !important;
  margin-bottom: 6px !important;
}

/* Resource bars 紧凑 */
.cad-res-item {
  display: flex !important;
  align-items: center !important;
  gap: 6px !important;
  padding: 2px 0 !important;
  font-size: 10px !important;
}
.cad-res-name {
  width: 48px !important;
  flex-shrink: 0 !important;
  font-size: 10px !important;
  text-overflow: ellipsis !important;
  overflow: hidden !important;
  white-space: nowrap !important;
}
.cad-res-bar {
  flex: 1 !important;
  height: 6px !important;
  border-radius: 3px !important;
  overflow: hidden !important;
}
.cad-res-pct {
  width: 32px !important;
  text-align: right !important;
  font-size: 10px !important;
  font-family: 'JetBrains Mono', monospace !important;
  flex-shrink: 0 !important;
}

/* Intelligence 紧凑 */
.cad-intel-grid {
  display: flex !important;
  gap: 8px !important;
  flex-wrap: wrap !important;
}
.cad-intel-metric {
  flex: 1 !important;
  min-width: 50px !important;
  text-align: center !important;
  padding: 4px !important;
}
.cad-intel-value {
  font-size: 18px !important;
  font-weight: 700 !important;
  font-family: 'JetBrains Mono', monospace !important;
  line-height: 1.2 !important;
}
.cad-intel-label {
  font-size: 9px !important;
  text-transform: uppercase !important;
  letter-spacing: 0.03em !important;
  margin-top: 1px !important;
}

/* Terminal 占满中间剩余空间 */
.cad-center-terminal {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  min-height: 0 !important;
  overflow: hidden !important;
}
.cad-terminal-header {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 4px 12px !important;
  flex-shrink: 0 !important;
  border-top: 1px solid rgba(0,0,0,0.06) !important;
}
.cad-terminal-title {
  font-size: 10px !important;
  font-weight: 700 !important;
  letter-spacing: 0.04em !important;
}
.cad-terminal-live {
  font-size: 9px !important;
}
.cad-terminal-body {
  flex: 1 !important;
  overflow-y: auto !important;
  padding: 4px 12px !important;
  font-family: 'JetBrains Mono', monospace !important;
  font-size: 11px !important;
  min-height: 0 !important;
}
.cad-term-line {
  display: flex !important;
  gap: 8px !important;
  padding: 2px 0 !important;
  line-height: 1.4 !important;
}
.cad-term-time {
  flex-shrink: 0 !important;
  font-size: 10px !important;
  width: 44px !important;
}
.cad-term-user {
  flex-shrink: 0 !important;
  font-size: 10px !important;
  font-weight: 600 !important;
  max-width: 80px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}
.cad-term-action {
  flex: 1 !important;
  font-size: 10px !important;
  min-width: 0 !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

/* 7. 右栏：Deploy Summary 压缩 */
.cad-deploy-summary {
  display: flex !important;
  padding: 6px 12px !important;
  gap: 4px !important;
  flex-shrink: 0 !important;
  border-bottom: 1px solid rgba(0,0,0,0.06) !important;
}
.cad-deploy-stat {
  flex: 1 !important;
  text-align: center !important;
  padding: 4px 0 !important;
}
.cad-deploy-num {
  font-size: 16px !important;
  font-weight: 700 !important;
  font-family: 'JetBrains Mono', monospace !important;
  line-height: 1.2 !important;
}
.cad-deploy-label {
  font-size: 8px !important;
  text-transform: uppercase !important;
  letter-spacing: 0.05em !important;
}

/* Operator items 紧凑 */
.cad-operator-item {
  display: flex !important;
  align-items: center !important;
  gap: 8px !important;
  padding: 6px 12px !important;
  cursor: pointer !important;
  border-bottom: 1px solid rgba(0,0,0,0.04) !important;
}
.cad-op-avatar {
  width: 28px !important;
  height: 28px !important;
  font-size: 11px !important;
  border-radius: 4px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  flex-shrink: 0 !important;
  position: relative !important;
  font-weight: 700 !important;
}
.cad-op-status-dot {
  position: absolute !important;
  bottom: -1px !important;
  right: -1px !important;
  width: 8px !important;
  height: 8px !important;
  border-radius: 50% !important;
  border: 2px solid #fff !important;
}
.cad-op-info {
  flex: 1 !important;
  min-width: 0 !important;
}
.cad-op-name {
  font-size: 12px !important;
  font-weight: 600 !important;
  line-height: 1.2 !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}
.cad-op-role {
  font-size: 9px !important;
  margin-top: 1px !important;
}
.cad-op-load {
  flex-shrink: 0 !important;
  width: 60px !important;
  text-align: right !important;
}
.cad-op-load-bar {
  height: 3px !important;
  border-radius: 2px !important;
  overflow: hidden !important;
}
.cad-op-load-text {
  font-size: 9px !important;
  margin-top: 2px !important;
}

/* 8. Status Strip 修正 */
.cad-status-strip {
  display: flex !important;
  align-items: center !important;
  padding: 4px 12px !important;
  gap: 12px !important;
  flex-shrink: 0 !important;
  flex-wrap: nowrap !important;
  overflow-x: auto !important;
  border-bottom: 1px solid rgba(0,0,0,0.08) !important;
}
.cad-strip-item {
  display: flex !important;
  align-items: center !important;
  gap: 4px !important;
  white-space: nowrap !important;
  flex-shrink: 0 !important;
}
.cad-strip-label {
  font-size: 9px !important;
  font-weight: 600 !important;
  letter-spacing: 0.04em !important;
  text-transform: uppercase !important;
}
.cad-strip-value {
  font-size: 12px !important;
  font-weight: 700 !important;
  font-family: 'JetBrains Mono', monospace !important;
}
.cad-strip-dot {
  width: 6px !important;
  height: 6px !important;
  border-radius: 50% !important;
  flex-shrink: 0 !important;
}
.cad-strip-dot.red { background: #E11D48 !important; }
.cad-strip-dot.amber { background: #F59E0B !important; }
.cad-strip-dot.green { background: #10B981 !important; }
.cad-strip-divider {
  width: 1px !important;
  height: 16px !important;
  background: rgba(0,0,0,0.12) !important;
  flex-shrink: 0 !important;
}

/* 9. Empty state */
.cad-empty-state {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 8px !important;
  padding: 24px !important;
  font-size: 11px !important;
}

/* ═══════════════════════════════════════════════════════════════
   OVERVIEW STEP 2B: 字号修正 + 面板边界 + 密度平衡
   追加到CSS文件末尾（在STEP2之后）
   ═══════════════════════════════════════════════════════════════ */

/* 1. 三栏间加分隔线 */
.cad-dispatch-grid {
  gap: 0 !important;
}
.cad-panel-center {
  border-left: 1px solid #ddd !important;
  border-right: 1px solid #ddd !important;
}

/* 2. 左栏卡片字号提升 */
.cad-alert-id {
  font-size: 13px !important;
}
.cad-alert-title {
  font-size: 13px !important;
}
.cad-alert-meta {
  font-size: 11px !important;
}
.cad-alert-urgency {
  font-size: 10px !important;
  padding: 2px 6px !important;
}
.cad-alert-item {
  padding: 10px 12px !important;
}

/* 3. Panel Header 字号提升 */
.cad-panel-title {
  font-size: 12px !important;
}
.cad-panel-badge {
  font-size: 11px !important;
  padding: 2px 10px !important;
}

/* 4. 中间面板字号提升 */
.cad-widget-label {
  font-size: 11px !important;
  margin-bottom: 8px !important;
}
.cad-res-name {
  font-size: 11px !important;
  width: 56px !important;
}
.cad-res-pct {
  font-size: 11px !important;
}
.cad-res-item {
  padding: 3px 0 !important;
  font-size: 11px !important;
}
.cad-res-bar {
  height: 8px !important;
}

/* Intelligence 字号 */
.cad-intel-value {
  font-size: 20px !important;
}
.cad-intel-label {
  font-size: 10px !important;
}

/* Terminal 字号 */
.cad-terminal-title {
  font-size: 11px !important;
}
.cad-terminal-body {
  font-size: 12px !important;
  padding: 6px 12px !important;
}
.cad-term-time {
  font-size: 11px !important;
  width: 48px !important;
}
.cad-term-user {
  font-size: 11px !important;
}
.cad-term-action {
  font-size: 11px !important;
}
.cad-term-line {
  padding: 3px 0 !important;
}

/* 5. 右栏字号提升 */
.cad-deploy-num {
  font-size: 18px !important;
}
.cad-deploy-label {
  font-size: 9px !important;
}
.cad-op-name {
  font-size: 13px !important;
}
.cad-op-role {
  font-size: 10px !important;
}
.cad-op-load-text {
  font-size: 10px !important;
}
.cad-operator-item {
  padding: 8px 12px !important;
}

/* 6. Status Strip 字号提升 */
.cad-strip-label {
  font-size: 10px !important;
}
.cad-strip-value {
  font-size: 13px !important;
}

/* 7. 中间面板 Resources+Intel 高度不再限制，自然流动 */
.cad-center-top {
  max-height: none !important;
  flex-shrink: 0 !important;
  border-bottom: 1px solid #ddd !important;
}

/* 8. Terminal 展开填满 */
.cad-center-terminal {
  flex: 1 !important;
  border-top: none !important;
}
.cad-terminal-header {
  border-top: none !important;
  border-bottom: 1px solid rgba(0,0,0,0.06) !important;
  padding: 6px 12px !important;
}

/* 9. 右栏 deploy summary 加下边框 */
.cad-deploy-summary {
  border-bottom: 1px solid #ddd !important;
  padding: 8px 12px !important;
}

/* ═══════════════════════════════════════════════════════════════
   OVERVIEW STEP 4: 卡片边界强化 + 空白消除 + 密度提升
   追加到CSS文件末尾
   ═══════════════════════════════════════════════════════════════ */

/* 1. 左栏卡片：强制边界（!important覆盖旧样式） */
.cad-panel-left .cad-alert-item {
  margin: 3px 6px !important;
  padding: 8px 10px 8px 12px !important;
  background: #ffffff !important;
  border: 1px solid #E5E7EB !important;
  border-radius: 4px !important;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04) !important;
  display: flex !important;
  align-items: stretch !important;
  gap: 0 !important;
  position: relative !important;
  overflow: hidden !important;
}
.cad-panel-left .cad-alert-item:hover {
  border-color: #C7D2FE !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08) !important;
  background: #F8FAFF !important;
}

/* Priority bar: 左侧3px色条（覆盖旧定义） */
.cad-alert-priority-bar {
  position: absolute !important;
  left: 0 !important;
  top: 0 !important;
  bottom: 0 !important;
  width: 3px !important;
  min-height: auto !important;
  border-radius: 0 !important;
  display: block !important;
}
.cad-alert-priority-bar.p-critical { background: #DC2626 !important; }
.cad-alert-priority-bar.p-high { background: #F59E0B !important; }
.cad-alert-priority-bar.p-moderate { background: #3B82F6 !important; }
.cad-alert-priority-bar.p-low { background: #10B981 !important; }

/* 2. Urgency badge 颜色强化 */
.cad-alert-urgency {
  border-radius: 2px !important;
  font-weight: 700 !important;
  line-height: 1 !important;
}
.cad-alert-urgency.u-critical {
  background: #FEE2E2 !important;
  color: #DC2626 !important;
}
.cad-alert-urgency.u-high {
  background: #FEF3C7 !important;
  color: #D97706 !important;
}
.cad-alert-urgency.u-moderate {
  background: #DBEAFE !important;
  color: #2563EB !important;
}
.cad-alert-urgency.u-low {
  background: #D1FAE5 !important;
  color: #059669 !important;
}

/* 3. 左栏Panel背景（与卡片形成Z轴层级） */
.cad-panel-left {
  background: #F3F4F6 !important;
}
.cad-panel-left .cad-panel-header {
  background: #fff !important;
  border-bottom: 1px solid #E5E7EB !important;
}
.cad-panel-left .cad-panel-body {
  padding: 4px 2px !important;
  background: #F3F4F6 !important;
}

/* 4. 中栏：Resources和Intel区域有边界 */
.cad-panel-center {
  background: #fff !important;
  border-left: 1px solid #E5E7EB !important;
  border-right: 1px solid #E5E7EB !important;
}
.cad-center-top {
  border-bottom: 1px solid #E5E7EB !important;
  max-height: none !important;  /* 取消40%限制，让内容决定高度 */
  flex-shrink: 0 !important;
}
.cad-resource-widget {
  border-right: 1px solid #E5E7EB !important;
  padding: 10px 14px !important;
}
.cad-intel-widget {
  padding: 10px 14px !important;
}

/* 5. 中栏：Terminal样式强化（填满下方空间） */
.cad-center-terminal {
  background: #0F172A !important;
  color: #E2E8F0 !important;
  flex: 1 !important;
}
.cad-terminal-header {
  background: #1E293B !important;
  border-top: none !important;
  border-bottom: 1px solid #334155 !important;
  padding: 6px 14px !important;
}
.cad-terminal-title {
  color: #94A3B8 !important;
}
.cad-terminal-live {
  color: #10B981 !important;
}
.cad-terminal-body {
  background: #0F172A !important;
  color: #CBD5E1 !important;
  padding: 8px 14px !important;
}
.cad-term-line {
  padding: 3px 0 !important;
  border-bottom: 1px solid rgba(255,255,255,0.04) !important;
}
.cad-term-time {
  color: #64748B !important;
}
.cad-term-user {
  color: #38BDF8 !important;
}
.cad-term-action {
  color: #CBD5E1 !important;
}
.cad-crit .cad-term-time,
.cad-crit .cad-term-action {
  color: #F87171 !important;
}
.cad-crit .cad-term-user {
  color: #FCA5A5 !important;
  background: rgba(220,38,38,0.1) !important;
  padding: 0 4px !important;
  border-radius: 2px !important;
}

/* 6. 右栏：背景和分隔 */
.cad-panel-right {
  background: #fff !important;
}
.cad-panel-right .cad-panel-header {
  background: #fff !important;
  border-bottom: 1px solid #E5E7EB !important;
}
.cad-deploy-summary {
  background: #F9FAFB !important;
  border-bottom: 1px solid #E5E7EB !important;
  padding: 10px 12px !important;
}

/* 7. 右栏：Operator item 有边界 */
.cad-panel-right .cad-operator-item {
  border-bottom: 1px solid #F3F4F6 !important;
  padding: 10px 12px !important;
}
.cad-panel-right .cad-operator-item:hover {
  background: #F9FAFB !important;
}
.cad-op-status-dot {
  border-color: #fff !important;
}
.cad-op-status-dot.online { background: #10B981 !important; }
.cad-op-status-dot.busy { background: #F59E0B !important; }
.cad-op-status-dot.offline { background: #CBD5E1 !important; }

/* 8. Resource bar 颜色 */
.cad-res-bar {
  background: #E5E7EB !important;
}
.cad-res-fill {
  border-radius: 3px !important;
}
.cad-res-fill.high { background: #10B981 !important; }
.cad-res-fill.medium { background: #F59E0B !important; }
.cad-res-fill.low { background: #DC2626 !important; }
.cad-res-pct.low { color: #DC2626 !important; font-weight: 700 !important; }

/* 9. Intelligence BREACHES 红色强调 */
.cad-intel-value {
  color: #0F172A !important;
}
.cad-intel-label {
  color: #64748B !important;
}
.cad-intel-metric {
  padding: 6px 4px !important;
  border-right: 1px solid #F3F4F6 !important;
}
.cad-intel-metric:last-child {
  border-right: none !important;
}

/* 10. 面板标题区域的count badge */
.cad-panel-badge {
  background: #F3F4F6 !important;
  color: #374151 !important;
  font-weight: 700 !important;
  border-radius: 10px !important;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>kokoro_volunteer</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Kokoro Volunteer Dashboard</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    // ==========================================
    // ★★★ [HOISTED] 前置定义区 — 所有模块共享 ★★★
    // 必须在任何 action 处理之前定义
    // ==========================================

    // --- CONFIG (原 MODULE 4) ---
    var CONFIG = {
        tables: {
            SILENT_WISH: 'x_1821654_kokoro_0_silent_wish',
            INVENTORY: 'x_1821654_kokoro_0_kokoro_inventory',
            INVENTORY_TX: 'x_1821654_kokoro_0_kokoro_inventory_transact',
            PROCESS_EVENT: 'x_1821654_kokoro_0_process_event',
            USER_PROFILE: 'x_1821654_kokoro_0_user_profile', 
            EMERGENCY_MESSAGE: 'x_1821654_kokoro_0_emergency_message', 
            HEARTBEAT: 'x_1821654_kokoro_0_x_1821654_kokoro_0_heartbeat',
            VOL_CAPABILITY: 'x_1821654_kokoro_0_volunteer_capability'
        },
        wishStates: {
            NEW: '1',
            IN_PROGRESS: '2',
            COMPLETED: '4',
            CANCELLED: '7'
        },
        resourceKeys: ['food', 'water', 'medical', 'clothing', 'hygiene'],
        thresholds: {
            CRITICAL: 15, 
            WARNING: 35   
        }
    };

    	// ==========================================
    // [V3] 統一サニタイズ関数
    // ==========================================
    function sanitizeInput(str) {
        if (!str || typeof str !== 'string') return '';
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;')
            .replace(/\//g, '&#x2F;')
            .trim();
    }

    // ==========================================
    // [V3] アクション別バリデーションルール
    // ==========================================
    var VALIDATION_RULES = {
        'change_status': {
            sys_id:    { required: true,  type: 'sys_id' },
            new_state: { required: true,  type: 'state' }
        },
        'assign_to_me': {
            sys_id: { required: true, type: 'sys_id' }
        },
        'add_comment': {
            sys_id:  { required: true,  type: 'sys_id' },
            comment: { required: true,  type: 'text', maxLength: 4000 }
        },
        'send_broadcast': {
            title: { required: true,  type: 'text', maxLength: 200 },
            body:  { required: false, type: 'text', maxLength: 4000 },
            level: { required: false, type: 'enum', values: ['info', 'warning', 'critical'] }
        },
        'delete_broadcast': {
            sys_id: { required: true, type: 'sys_id' }
        },
        'dispatch': {
            sys_id:       { required: true,  type: 'sys_id' },
            volunteer_id: { required: true,  type: 'sys_id' }
        },
        'batch_action': {
            batch_type: { required: true, type: 'enum', values: ['assign_to_me', 'change_status', 'cancel'] },
            sys_ids:    { required: true, type: 'sys_id_list' }
        },
        'specialty': {
            sys_id:  { required: false, type: 'sys_id' },
            new_cap: { required: false, type: 'text', maxLength: 100 } // 允许为空，方便取消专长
        },
		  'update_zone': {
      zone: { required: true, type: 'enum', values: ['FAMILY_AREA', 'SINGLE_AREA', 'MEDICAL_AREA', 'STAFF_ROOM', 'FIELD', 'HQ'] }
  },
        'inventory_check': {
            item_code: { required: true, type: 'text', maxLength: 50 }
        },
        'submit_sitrep': {
            summary:   { required: true,  type: 'text', maxLength: 2000 },
            area_name: { required: false, type: 'text', maxLength: 100 },
            status:    { required: false, type: 'enum', values: ['green', 'yellow', 'red'] }
        }
    };

    // ==========================================
    // [V3] 統一バリデーション関数
    // 戻り値: { valid: true/false, errors: [], sanitized: {} }
    // ==========================================
    function validateActionInput(action, inputData) {
        var result = { valid: true, errors: [], sanitized: {} };
        var rules = VALIDATION_RULES[action];

        // ルール未定義のアクション → 検証スキップ（後方互換）
        if (!rules) {
            return result;
        }

        for (var field in rules) {
            var rule = rules[field];
            var value = inputData[field];

            // 必須チェック
            if (rule.required && (value === undefined || value === null || value === '')) {
                result.valid = false;
                result.errors.push(field + ' は必須です');
                continue;
            }

            // 値がない非必須フィールドはスキップ
            if (value === undefined || value === null || value === '') {
                result.sanitized[field] = '';
                continue;
            }

            // 型別バリデーション
            switch (rule.type) {
                case 'sys_id':
                    // sys_id は 32文字の hex
                    if (!/^[a-f0-9]{32}$/.test(String(value))) {
                        result.valid = false;
                        result.errors.push(field + ' の形式が不正です');
                    } else {
                        result.sanitized[field] = String(value);
                    }
                    break;

                case 'sys_id':
                    // 修改正则，允许大写字母
                    if (!/^[a-zA-Z0-9]{32}$/.test(String(value))) {
                        result.valid = false;
                        result.errors.push(field + ' の形式が不正です');
                    } else {
                        result.sanitized[field] = String(value);
                    }
                    break;
                case 'sys_id_list':
                    var ids = String(value).split(',');
                    var validIds = [];
                    for (var i = 0; i < ids.length; i++) {
                        var id = ids[i].trim();
                        // 同理修改正则
                        if (/^[a-zA-Z0-9]{32}$/.test(id)) validIds.push(id);
                    }
                    
                    if (validIds.length === 0) {
                        result.valid = false;
                        result.errors.push(field + ' に有効なIDがありません');
                    } else {
                        if (hasInvalid) {
                            result.errors.push(field + ' の一部IDが無効（無視されます）');
                        }
                        result.sanitized[field] = validIds.join(',');
                    }
                    break;

                case 'state':
                    // 有効な状態値
                    var validStates = ['1', '2', '4', '5', '6', '10', '11'];
                    if (validStates.indexOf(String(value)) === -1) {
                        result.valid = false;
                        result.errors.push(field + ' の値が無効です (' + value + ')');
                    } else {
                        result.sanitized[field] = String(value);
                    }
                    break;

                case 'text':
                    var strVal = String(value);
                    if (rule.maxLength && strVal.length > rule.maxLength) {
                        result.valid = false;
                        result.errors.push(field + ' は' + rule.maxLength + '文字以内です（現在: ' + strVal.length + '）');
                    } else {
                        result.sanitized[field] = sanitizeInput(strVal);
                    }
                    break;

                case 'enum':
                    if (rule.values && rule.values.indexOf(String(value)) === -1) {
                        result.valid = false;
                        result.errors.push(field + ' の値が無効です: ' + sanitizeInput(String(value)));
                    } else {
                        result.sanitized[field] = String(value);
                    }
                    break;

                default:
                    result.sanitized[field] = sanitizeInput(String(value));
            }
        }

        return result;
    }

    function validateSysId(sysId) {
        if (!sysId) return false;
        return /^[a-f0-9]{32}$/.test(String(sysId));
    }

    function logProcessEvent(caseId, activity, userId) {
        try {
            var pe = new GlideRecord(CONFIG.tables.PROCESS_EVENT);
            pe.initialize();
            pe.setValue('case_id', caseId || '');
            pe.setValue('activity', sanitizeInput(activity, 200));
            pe.setValue('timestamp', new GlideDateTime());
            pe.setValue('user', userId || gs.getUserID());
            pe.insert();
        } catch (e) {
            gs.error('[Kokoro] Process event log error: ' + e.message);
        }
    }

    // --- CSRF 验証 ---
    function validateVolCSRF(inputToken) {
        try {
            var session = gs.getSession();
            var storedToken = session.getClientData('kokoro_vol_csrf');
            if (!storedToken || !inputToken) return false;
            return String(storedToken) === String(inputToken);
        } catch (e) {
            gs.error('[Kokoro-Vol] CSRF validation error: ' + e.message);
            return true;
        }
    }
	
    // --- Rate Limiter ---
    var VolRateLimiter = {
        check: function(userId, actionType, windowMinutes, maxCount) {
            if (!userId) return { allowed: true, remaining: maxCount };
            try {
                var windowStart = new GlideDateTime();
                windowStart.addSeconds(-windowMinutes * 60);
                var ga = new GlideAggregate(CONFIG.tables.PROCESS_EVENT);
                ga.addQuery('user', userId);
                ga.addQuery('activity', 'STARTSWITH', 'VOL_RATE:' + actionType);
                ga.addQuery('timestamp', '>=', windowStart);
                ga.addAggregate('COUNT');
                ga.query();
                var count = 0;
                if (ga.next()) count = parseInt(ga.getAggregate('COUNT')) || 0;
                if (count >= maxCount) {
                    return { allowed: false, remaining: 0, message: '操作が多すぎます。' + windowMinutes + '分後に再度お試しください。' };
                }
                return { allowed: true, remaining: maxCount - count };
            } catch (e) {
                gs.error('[Kokoro-Vol] RateLimiter error: ' + e.message);
                return { allowed: true, remaining: maxCount };
            }
        },
        record: function(userId, actionType) {
            try {
                var pe = new GlideRecord(CONFIG.tables.PROCESS_EVENT);
                pe.initialize();
                pe.setValue('user', userId);
                pe.setValue('activity', 'VOL_RATE:' + actionType);
                pe.setValue('timestamp', new GlideDateTime());
                pe.insert();
            } catch (e) {
                gs.error('[Kokoro-Vol] RateLimiter record error: ' + e.message);
            }
        }
    };
	
// ==========================================
// 乐观锁（楽観的排他制御）
// ==========================================
function checkConcurrency(tableName, sysId, clientModCount) {
    // 没有提供 mod count 时跳过检查（兼容旧版客户端）
    if (!sysId || clientModCount === undefined || clientModCount === null) {
        return { ok: true };
    }
    
    try {
        var gr = new GlideRecord(tableName);
        if (!gr.get(sysId)) {
            return { ok: false, message: 'レコードが見つかりません' };
        }
        
        var serverModCount = parseInt(gr.getValue('sys_mod_count')) || 0;
        var clientCount = parseInt(clientModCount) || 0;
        
        if (clientCount < serverModCount) {
            return {
                ok: false,
                message: '他のユーザーがこのレコードを更新しました。ページを再読み込みしてください。',
                server_version: serverModCount,
                client_version: clientCount
            };
        }
        
        return { ok: true, record: gr };
        
    } catch (e) {
        gs.error('[Kokoro] Concurrency check error: ' + e.message);
        // エラー時は放行（可用性優先）
        return { ok: true };
    }
}

    // ==========================================
    // ★★★ [HOISTED] 前置定义区 结束 ★★★
    // ==========================================


    // ==========================================
    // MODULE 1: 处理前端动作 (Action Handling)
    // ==========================================
    
	// ==========================================
    // [V3] 統一バリデーション Gateway (Global)
    // 这里的 input 验证会拦截所有非法请求
    // ==========================================
    if (input && input.action) {
        var validation = validateActionInput(input.action, input);
        if (!validation.valid) {
            data.error = 'バリデーション失敗: ' + validation.errors.join(', ');
            data.validation_errors = validation.errors;
            // 验证失败，强制停止后续处理
            return; 
        }
        // 使用清洗后的安全数据覆盖原始 input
        for (var vKey in validation.sanitized) {
            input[vKey] = validation.sanitized[vKey];
        }
    }
    // ==========================================
    // 修复：专长保存逻辑（无记录时自动创建）
    // ==========================================
    if (input && input.action === 'specialty') {
        var targetId = input.sys_id || gs.getUserID();
        var capGr = new GlideRecord(CONFIG.tables.VOL_CAPABILITY);
        capGr.addQuery('volunteer', targetId);
        capGr.query();
        if (capGr.next()) {
            capGr.setValue('specialty', input.new_cap);
            capGr.update();
        } else {
            // 如果该干员是第一次被分配专长，主动在数据库为其创建记录
            capGr.initialize();
            capGr.setValue('volunteer', targetId);
            capGr.setValue('specialty', input.new_cap);
            capGr.setValue('is_available', '1');
            capGr.setValue('max_concurrent_tasks', 5);
            capGr.insert();
        }
    }
    
    if (input && input.action === 'assign_task') {
        var taskGr = new GlideRecord('x_1821654_kokoro_0_silent_wish');
        if (taskGr.get(input.ticket_id)) {
            taskGr.setValue('assigned_to', input.target_user);
            var currentState = taskGr.getValue('state');
            if (currentState == '1' || currentState == '10') {
                taskGr.setValue('state', '11');
            }
            taskGr.update();
            data.success = true;
        } else {
            data.error = 'タスクが見つかりません';
        }
        return;
    }
	
    if (input && input.action === 'send_broadcast') {
        try {
            var broadcastVolId = gs.getUserID();
            var broadcastRateCheck = VolRateLimiter.check(broadcastVolId, 'BROADCAST', 5, 3);
            
            if (!broadcastRateCheck.allowed) {
                data.error = broadcastRateCheck.message;
                return;
            }

            if (!gs.hasRole('x_1821654_kokoro_0.volunteer') && !gs.hasRole('admin')) {
                data.error = '権限がありません';
                return;
            }
            
            var bcTitle = sanitizeInput(input.title, 200);
            var bcBody = sanitizeInput(input.body, 4000);
            var bcType = input.msg_type || 'announcement';
            
            if (!bcTitle || !bcBody) {
                data.error = '件名と本文は必須です';
                return;
            }
            
            var validTypes = ['emergency', 'announcement', 'internal'];
            if (validTypes.indexOf(bcType) === -1) {
                bcType = 'announcement';
            }
            
            var bcGr = new GlideRecord('x_1821654_kokoro_0_emergency_message');
            bcGr.initialize();
            bcGr.setValue('user', gs.getUserID());
            bcGr.setValue('message_type', bcType);
            bcGr.setValue('message_encrypted', bcTitle + '\n---\n' + bcBody);
            bcGr.setValue('is_active', true);
            bcGr.setValue('created_at', new GlideDateTime());
            
            var newId = bcGr.insert();
            
            if (newId) {
                data.success = true;
                data.new_id = newId;
                logProcessEvent(newId, 'Broadcast sent: [' + bcType.toUpperCase() + '] ' + bcTitle, gs.getUserID());
                VolRateLimiter.record(broadcastVolId, 'BROADCAST');
            } else {
                data.error = '保存に失敗しました';
            }
        } catch (e) {
            data.error = '送信エラー: ' + e.message;
            gs.error('[Kokoro] Broadcast error: ' + e.message);
        }
        return;
    }
	
    if (input && input.action === 'delete_broadcast') {
        try {
            var delBcVolId = gs.getUserID();
            var delRateCheck = VolRateLimiter.check(delBcVolId, 'DELETE_BC', 1, 10);
            
            if (!delRateCheck.allowed) {
                data.error = delRateCheck.message;
                return;
            }

            if (!gs.hasRole('admin')) {
                data.error = 'Security Alert: Admin privilege required.';
                return;
            }

            var delSysId = input.sys_id;
            if (delSysId) {
                var delGr = new GlideRecord('x_1821654_kokoro_0_emergency_message');
                if (delGr.get(delSysId)) {
                    delGr.setValue('is_active', false);
                    delGr.update();
                    
                    data.success = true;
                    data.deleted_id = delSysId;
                    gs.info('[Kokoro] Broadcast deactivated by Admin: ' + delSysId);
                    VolRateLimiter.record(delBcVolId, 'DELETE_BC');
                }
            }
        } catch (e) {
            data.error = 'Delete failed: ' + e.message;
        }
        return;
    }

    // ==========================================
    // MODULE 2: 初始化环境 (Initialization)
    // ==========================================
    data.myTasks = [];
    data.list = [];
    data.volunteers = [];
    data.announcements = [];
    data.capabilityOptions = [];
    
    data.user_id = gs.getUserID();
    data.user_name = gs.getUserDisplayName();
    
    var isVolunteer = gs.hasRole('x_1821654_kokoro_0.volunteer') || gs.hasRole('admin');
    data.isVolunteer = isVolunteer;
    data.isAdmin = gs.hasRole('admin');
	
    if (!input) {
        data.csrf_token = gs.generateGUID();
        var session = gs.getSession();
        session.putClientData('kokoro_vol_csrf', data.csrf_token);
    }

    var todayPM = new GlideDateTime();
    todayPM.setDisplayValue(todayPM.getDate().toString());

    // ==========================================
    // MODULE 3: 数据加载 (Data Fetching)
    // ★★★ [FIX] 删除旧的 sys_user 全表查询 ★★★
    // volunteers 现在在 fetchWishes 之后用 loadVolunteerList() 加载
    // ==========================================

    // 3.2 获取 Capability 选项
    var choiceGr = new GlideRecord('sys_choice');
    choiceGr.addQuery('name', 'x_1821654_kokoro_0_volunteer_capability'); 
    choiceGr.addQuery('element', 'specialty'); 
    choiceGr.addQuery('language', gs.getSession().getLanguage()); 
    choiceGr.addQuery('inactive', false);
    choiceGr.orderBy('sequence');
    choiceGr.query();
    while (choiceGr.next()) {
        data.capabilityOptions.push({
            label: choiceGr.getValue('label'),
            value: choiceGr.getValue('value')
        });
    }

    // ==========================================
    // 资源状态
    // ==========================================
    function getResourceStatus() {
        var map = {
            'FOOD': 0, 'WATR': 1, 'MEDI': 2, 'CLTH': 3, 'HYGN': 4
        };
        
        var status = [
            { percent: 0, code: 'FOOD', label: '食料 (No Data)', status_color: 'danger' },
            { percent: 0, code: 'WATR', label: '飲料水 (No Data)', status_color: 'danger' },
            { percent: 0, code: 'MEDI', label: '医療品 (No Data)', status_color: 'danger' },
            { percent: 0, code: 'CLTH', label: '衣類 (No Data)', status_color: 'danger' },
            { percent: 0, code: 'HYGN', label: '衛生用品 (No Data)', status_color: 'danger' }
        ];

        var grInv = new GlideRecord(CONFIG.tables.INVENTORY);
        grInv.addActiveQuery();
        grInv.query();

        while (grInv.next()) {
            var code = grInv.getValue('item_code');
            var idx = map[code];
            
            if (idx !== undefined) {
                var current = parseFloat(grInv.getValue('current_quantity')) || 0;
                var max = parseFloat(grInv.getValue('max_capacity')) || 100;
                var percentage = Math.round((current / max) * 100);

                status[idx] = {
                    label: grInv.getDisplayValue('item_name'),
                    code: code,
                    percent: percentage,
                    status_color: percentage < CONFIG.thresholds.CRITICAL ? 'danger' : 
                                 (percentage < CONFIG.thresholds.WARNING ? 'warning' : 'success')
                };
            }
        }
        return status;
    }
    data.resourceStatus = getResourceStatus();

    // ==========================================
    // 库存扣减
    // ==========================================
    function updateInventory(itemCode, quantity, wishId) {
        var grInv = new GlideRecord(CONFIG.tables.INVENTORY);
        grInv.addQuery('item_code', itemCode);
        grInv.query();

        if (grInv.next()) {
            var oldQty = parseFloat(grInv.getValue('current_quantity'));
            var newQty = oldQty - quantity;
            if (newQty < 0) return { success: false, message: '在庫不足' };
            grInv.setValue('current_quantity', newQty);
            grInv.update();

            var grTx = new GlideRecord(CONFIG.tables.INVENTORY_TX);
            grTx.initialize();
            grTx.setValue('inventory_item', grInv.getUniqueValue());
            grTx.setValue('type', 'disbursement');
            grTx.setValue('quantity', quantity);
            grTx.setValue('related_wish', wishId);
            grTx.insert();

            logProcessEvent(wishId, 'Inventory Decr: ' + itemCode + ' (' + quantity + ')', gs.getUserID());
            return { success: true };
        }
        return { success: false, message: '物品コードが見つかりません' };
    }

    if (input && input.action === 'change_status' && input.new_state === '2') {
        var wishGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
        if (wishGr.get(input.sys_id)) {
            var category = wishGr.getValue('request_category');
            var qty = parseInt(wishGr.getValue('u_quantity')) || parseInt(wishGr.getValue('qty')) || 1;
            if (category) {
                var invResult = updateInventory(category.toUpperCase(), qty, input.sys_id);
                // 判定：如果扣减失败，且失败原因不是"找不到物品代码"，才抛出错误并拦截。
                // 若原因是"找不到物品代码"，则视为非库存工单（如SOS），直接跳过库存检查继续执行。
                if (!invResult.success && invResult.message !== '物品コードが見つかりません') {
                    data.error = "在庫チェック失敗: " + invResult.message;
                    return;
                }
            }
        }
    }

    // === SLA统计 ===
    data.slaStats = { breached: 0, atRisk: 0, ok: 0 };
    try {
        if (typeof x_1821654_kokoro_0.KokoroSLAEngine !== 'undefined') {
            var slaEngine = new x_1821654_kokoro_0.KokoroSLAEngine();
            var breachedWishes = slaEngine.getBreachedWishes();
            data.slaStats.breached = breachedWishes.length;
            var atRiskWishes = slaEngine.getAtRiskWishes(80);
            data.slaStats.atRisk = atRiskWishes.length;
        }
        var gaSLA = new GlideAggregate('x_1821654_kokoro_0_sla_task');
        gaSLA.addQuery('status', 'in_progress');
        gaSLA.addQuery('percentage', '<', 80);
        gaSLA.addAggregate('COUNT');
        gaSLA.query();
        if (gaSLA.next()) {
            data.slaStats.ok = parseInt(gaSLA.getAggregate('COUNT')) || 0;
        }
    } catch (e) {
        gs.debug('[Kokoro] SLA stats not available: ' + e.message);
    }

    // ==========================================
    // 状态验证器
    // ==========================================
    var StateValidator = {
        allowedTransitions: {
            '1':  ['10', '11', '5'],
            '10': ['1', '11', '5'],
            '11': ['10', '2', '5', '6'],
            '2':  ['4', '5', '6'],
            '4':  [],
            '5':  [],
            '6':  ['11', '2', '5']
        },
        validateTransition: function(fromState, toState) {
            fromState = String(fromState);
            toState = String(toState);
            if (!fromState || fromState === '' || fromState === 'undefined' || fromState === 'null') {
                return { valid: true };
            }
            if (!this.allowedTransitions.hasOwnProperty(fromState)) {
                return { valid: false, message: '無効な現在状態: ' + fromState };
            }
            var allowed = this.allowedTransitions[fromState];
            if (allowed.indexOf(toState) === -1) {
                return { valid: false, message: fromState + ' から ' + toState + ' への遷移は許可されていません' };
            }
            return { valid: true };
        }
    };

    // ==========================================
    // 加载用户资料
    // ==========================================
    function loadUserProfile() {
        try {
            var grProfile = new GlideRecord(CONFIG.tables.USER_PROFILE);
            grProfile.addQuery('user', data.user_id);
            grProfile.setLimit(1);
            grProfile.query();
            if (grProfile.next()) {
                data.emergency_email = grProfile.getValue('emergency_conact_email') || "";
                data.medical_info = grProfile.getValue('medical_conditions') || "";
                data.blood_type = grProfile.getValue('blood_type') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Profile load error: " + e.message);
        }
    }

    function loadDigitalWill() {
        try {
            var grWill = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
            grWill.addQuery('user', data.user_id);
            grWill.addQuery('is_active', true);
            grWill.addQuery('message_type', 'Last_Will');
            grWill.orderByDesc('sys_created_on');
            grWill.setLimit(1);
            grWill.query();
            if (grWill.next()) {
                data.saved_will = grWill.getValue('message_encrypted') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Will load error: " + e.message);
        }
    }

    loadUserProfile();
    loadDigitalWill();

    // ==========================================
    // AI Insight Generator
    // ==========================================
    function generateAiInsight(urgency, category) {
        var confidence = Math.floor(Math.random() * (99 - 85) + 85);
        var processingTime = (Math.random() * (0.8 - 0.1) + 0.1).toFixed(3);
        var html = "";
        html += "<div style='margin-bottom: 4px; font-size: 10px; color: #5f6368; font-family: sans-serif;'>";
        html += "<span class='ai-tag'>CONFIDENCE: " + confidence + "%</span> ";
        html += "<span class='ai-tag'>TIME: " + processingTime + "s</span>";
        html += "</div>";
        html += "<div style='margin-top:2px; font-family: \"Roboto Mono\", \"Courier New\", monospace; font-size: 11px; line-height: 1.5;'>";
        if (urgency == 'Critical' || urgency == '1') {
            html += "<span style='color:#d93025; font-weight:800;'>[CRITICAL PATTERN]</span> ";
            html += "<span style='color:#202124;'>High-priority keyword cluster detected. </span>";
            html += "<span style='color:#d93025; font-weight:500;'>Action: Immediate escalation to Tier 2 required.</span>";
        } else if (category && category.toLowerCase().indexOf('food') > -1) {
            html += "<span style='color:#188038; font-weight:800;'>[LOGISTICS]</span> ";
            html += "<span style='color:#202124;'>Supply request identified. Inventory: Auto-verified. </span>";
            html += "<span style='color:#137333; font-weight:500;'>Optimization: Combine with Route #42 to save fuel.</span>";
        } else {
            html += "<span style='color:#1a73e8; font-weight:800;'>[STANDARD]</span> ";
            html += "<span style='color:#202124;'>Routine request signature. NLP Sentiment: Neutral. </span>";
            html += "<span style='color:#5f6368;'>Rec: Standard fulfillment procedure (SOP-01).</span>";
        }
        html += "</div>";
        return html;
    }
	
    // ==========================================
    // 构建任务项 (Integrated SLA & AI)
    // ==========================================
    function buildTaskItem(gr) {
        var urgencyVal = gr.getValue('urgency') || 'Medium'; 
        var categoryVal = gr.getValue('request_category') || '';
        
        var taskItem = {
            sys_id: gr.getUniqueValue(),
            number: gr.getValue('number') || '',
            category: categoryVal, 
            category_display: gr.getDisplayValue('request_category') || '未分類',
            zone: gr.getDisplayValue('shelter_zone') || '',
            detail_loc: gr.getValue('precise_location') || gr.getValue('wish_content') || '',
            desc: gr.getValue('wish_content') || '',
            urgency: urgencyVal, 
            contact: gr.getValue('u_contact_info') || '',
            reporter_name: gr.getDisplayValue('sys_created_by') || '一般ユーザー',
            assigned_to_name: gr.getDisplayValue('assigned_to') || '',
            assigned_to_id: gr.getValue('assigned_to') || '',
            state: parseInt(gr.getValue('state')) || 10,
            state_label: gr.getDisplayValue('state') || '',
            quantity: parseInt(gr.getValue('qty')) || 1,
            remarks: gr.getValue('wish_content') || '',
            affected_count: gr.getValue('u_affected_count') || '不明',
            history: [],
            attachments: [],
            sla: null,
            sys_mod_count: parseInt(gr.getValue('sys_mod_count')) || 0,
					  ai_analysis: generateAiInsight(urgencyVal, categoryVal)
        };
			
        var created = new GlideDateTime(gr.sys_created_on);
        var endTime = new GlideDateTime();
        var isCompleted = (taskItem.state == 4 || taskItem.state == 5);
        if (isCompleted) {
            var completedAtStr = gr.getValue('u_completed_at');
            if (completedAtStr) { endTime = new GlideDateTime(completedAtStr); }
            else { endTime = new GlideDateTime(gr.sys_updated_on); }
        }

        var diffMs = GlideDateTime.subtract(created, endTime).getNumericValue(); 
        var minutes = Math.floor(diffMs / 1000 / 60);
        var nowForDisplay = new GlideDateTime();
        var diffDisplay = GlideDateTime.subtract(created, nowForDisplay).getNumericValue();
        var minutesDisplay = Math.floor(diffDisplay / 1000 / 60);

        if (minutesDisplay < 60) { taskItem.time_ago = minutesDisplay + "分前"; }
        else if (minutesDisplay < 1440) { taskItem.time_ago = Math.floor(minutesDisplay / 60) + "時間前"; }
        else { taskItem.time_ago = Math.floor(minutesDisplay / 1440) + "日前"; }

        taskItem.created_on = gr.getDisplayValue('sys_created_on');

        if (!taskItem.sla) {
            var defaultTargets = { 'Critical': 30, 'High': 60, 'Medium': 120, 'Low': 240 };
            var target = defaultTargets[taskItem.urgency] || 120;
            var slaStatus = 'ok';
            var isBreached = minutes > target;
            if (isCompleted) { slaStatus = isBreached ? 'critical' : 'success'; }
            else { slaStatus = minutes > target ? 'critical' : (minutes > target * 0.8 ? 'warning' : 'ok'); }
            taskItem.sla = {
                elapsed: minutes, target: target,
                remaining: Math.max(0, target - minutes),
                percentage: Math.min(100, Math.round((minutes / target) * 100)),
                status: slaStatus, is_breached: isBreached, is_stopped: isCompleted
            };
        }

        try {
            var att = new GlideRecord('sys_attachment');
            att.addQuery('table_sys_id', taskItem.sys_id);
            att.setLimit(1); att.orderByDesc('sys_created_on'); att.query();
            if (att.next()) { taskItem.image_url = '/' + att.sys_id + '.iix'; }
        } catch (e) {}

        try {
            var journal = new GlideRecord('sys_journal_field');
            journal.addQuery('element_id', taskItem.sys_id);
            journal.addQuery('element', 'work_notes');
            journal.orderByDesc('sys_created_on'); journal.setLimit(10); journal.query();
            while (journal.next()) {
                taskItem.history.push({
                    user: journal.getDisplayValue('sys_created_by') || 'System',
                    text: journal.getValue('value') || '',
                    date: journal.getDisplayValue('sys_created_on')
                });
            }
        } catch (e) {}

        return taskItem;
    }
	
    // ==========================================
    // 修复：加载干员列表（强制防错与实时统计）
    // ==========================================
    function loadVolunteerList() {
        var volunteerList = [];
        var userIds = [];

        var roleGr = new GlideRecord('sys_user_has_role');
        roleGr.addQuery('role.name', 'x_1821654_kokoro_0.volunter');
        roleGr.query();
        while (roleGr.next()) {
            var u = roleGr.getValue('user');
            if (userIds.indexOf(u) === -1) userIds.push(u);
        }

        if (userIds.length === 0 || userIds.indexOf(gs.getUserID()) === -1) {
            userIds.push(gs.getUserID());
        }

        var userGr = new GlideRecord('sys_user');
        userGr.addQuery('sys_id', 'IN', userIds);
        userGr.addQuery('active', true);
        userGr.query();
        
        while (userGr.next()) {
            var uid = userGr.getUniqueValue();
            var capStr = "General Support";
            var maxLoad = 5;
            // ★ 修复点 1：默认将 isAvailable 设为 true。防止新用户因为没记录而永远显示灰点/离线
            var isAvailable = true; 
            
            var capGr2 = new GlideRecord(CONFIG.tables.VOL_CAPABILITY);
            capGr2.addQuery('volunteer', uid); 
            capGr2.query();
            if (capGr2.next()) {
                var specialty = capGr2.getDisplayValue('specialty');
                var skills = capGr2.getValue('skills');
                capStr = specialty || skills || "General Support";
                maxLoad = parseInt(capGr2.getValue('max_concurrent_tasks')) || 5;
                var rawAvail = capGr2.getValue('is_available');
                isAvailable = (rawAvail === '1' || rawAvail === 'true' || rawAvail === true);
            }

            // ★ 修复点 2：严格聚合统计正在进行的真实任务
            var gaLoad = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaLoad.addQuery('assigned_to', uid);
            gaLoad.addQuery('state', 'IN', '2,6,11'); // 仅统计 对应中(2), 保留(6), 待处理(11)
            gaLoad.addAggregate('COUNT');
            gaLoad.query();
            
            var currentLoad = 0;
            if (gaLoad.next()) {
                currentLoad = parseInt(gaLoad.getAggregate('COUNT')) || 0;
            }

            var volStatus = 'OFFLINE';
            var statusClass = 'offline';
            
            if (isAvailable) {
                if (currentLoad >= maxLoad && maxLoad > 0) { 
                    volStatus = 'OVERLOADED'; 
                    statusClass = 'busy'; 
                } else if (currentLoad > 0) { 
                    volStatus = 'ENGAGED'; 
                    statusClass = 'busy'; // 黄点/橙点
                } else { 
                    volStatus = 'STANDBY'; 
                    statusClass = 'online'; // 绿点
                }
            }

            var photoUrl = "";
            if (userGr.photo && userGr.photo.getDisplayValue()) { 
                photoUrl = userGr.photo.getDisplayValue(); 
            }

            // ★ 修复点 3：确保所有数值均为标准 Int，防止前端读取为 NaN
            volunteerList.push({
                sys_id: uid,
                name: userGr.getDisplayValue('name'),
                initial: (userGr.getDisplayValue('name') || '?').charAt(0).toUpperCase(),
                photo: photoUrl,
                title: userGr.getValue('title') || 'Operator',
                status: volStatus,
                status_class: statusClass,
                current_load: currentLoad,
                open_tasks: currentLoad,
                max_load: maxLoad,
                load_percent: maxLoad > 0 ? Math.round((currentLoad / maxLoad) * 100) : 0,
                capability: capStr
            });
        }
        return volunteerList;
    }
	
    // ==========================================
    // 处理输入
    // ==========================================
    if (input) {
        // CSRF Gateway
        var volWriteActions = [
       'change_status', 'assign_to_me', 'add_comment',
       'toggle_availability', 'update_location', 'update_capacity',
      'send_broadcast', 'delete_broadcast',
      'batch_action','update_zone'
   ];
        if (input.action && volWriteActions.indexOf(input.action) !== -1) {
            if (!validateVolCSRF(input.csrf_token)) {
                data.error = 'セッションが無効です。ページを再読み込みしてください。';
                data.csrf_failed = true;
                return;
            }
        }
			
			// ==========================================
        // ACTION: Batch Action（バッチ操作）
        // ==========================================
        if (input.action === 'batch_action') {
            // 入力検証
            var batchType = input.batch_type;  // 'assign_to_me' | 'change_status' | 'cancel'
            var batchIds = input.sys_ids;      // カンマ区切りの sys_id 文字列
            
            if (!batchType || !batchIds) {
                data.error = '無効なバッチ操作です';
                return;
            }
            
            var validBatchTypes = ['assign_to_me', 'change_status', 'cancel'];
            if (validBatchTypes.indexOf(batchType) === -1) {
                data.error = '無効な操作タイプです';
                return;
            }
            
            // Rate Limiting: バッチ全体で1回カウント
            var batchVolId = gs.getUserID();
            var batchRateCheck = VolRateLimiter.check(batchVolId, 'BATCH', 1, 5);
            if (!batchRateCheck.allowed) {
                data.error = batchRateCheck.message;
                return;
            }
            
            // sys_id リストをパース (最大20件)
            var idList = String(batchIds).split(',');
            if (idList.length > 20) {
                data.error = '一度に処理できるのは最大20件です';
                return;
            }
            
            // 各 sys_id を検証
            for (var bi = 0; bi < idList.length; bi++) {
                if (!validateSysId(idList[bi].trim())) {
                    data.error = '無効なIDが含まれています';
                    return;
                }
            }
            
            // バッチ処理実行
            var batchResults = { success: 0, failed: 0, errors: [] };
            
            for (var bj = 0; bj < idList.length; bj++) {
                var bSysId = idList[bj].trim();
                var bGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
                
                if (!bGr.get(bSysId)) {
                    batchResults.failed++;
                    batchResults.errors.push(bSysId + ': レコードが見つかりません');
                    continue;
                }
                
                var bState = String(bGr.getValue('state') || '10');
                var bUpdateOk = false;
                
                try {
                    if (batchType === 'assign_to_me') {
                        bGr.setValue('assigned_to', data.user_id);
                        if (bState === '1' || bState === '10') {
                            bGr.setValue('state', '11');
                        }
                        bUpdateOk = !!bGr.update();
                        if (bUpdateOk) logProcessEvent(bSysId, 'Batch assigned to ' + data.user_name, data.user_id);
                        
                    } else if (batchType === 'change_status' && input.new_state) {
                        var bNewState = String(input.new_state);
                        var bValidation = StateValidator.validateTransition(bState, bNewState);
                        if (!bValidation.valid) {
                            batchResults.failed++;
                            batchResults.errors.push(bGr.getValue('number') + ': ' + bValidation.message);
                            continue;
                        }
                        if ((bNewState === '2' || bNewState === '4') && bGr.assigned_to.nil()) {
                            batchResults.failed++;
                            batchResults.errors.push(bGr.getValue('number') + ': 担当者未設定');
                            continue;
                        }
                        bGr.setValue('state', bNewState);
                        if (bNewState === '4') bGr.setValue('u_completed_at', new GlideDateTime());
                        bUpdateOk = !!bGr.update();
                        if (bUpdateOk) logProcessEvent(bSysId, 'Batch status → ' + bNewState, data.user_id);
                        
                    } else if (batchType === 'cancel') {
                        var cancelValidation = StateValidator.validateTransition(bState, '5');
                        if (!cancelValidation.valid) {
                            batchResults.failed++;
                            batchResults.errors.push(bGr.getValue('number') + ': ' + cancelValidation.message);
                            continue;
                        }
                        bGr.setValue('state', '5');
                        bUpdateOk = !!bGr.update();
                        if (bUpdateOk) logProcessEvent(bSysId, 'Batch cancelled', data.user_id);
                    }
                    
                    if (bUpdateOk) batchResults.success++;
                    else { batchResults.failed++; batchResults.errors.push(bSysId + ': 更新失敗'); }
                    
                } catch (bErr) {
                    batchResults.failed++;
                    batchResults.errors.push(bSysId + ': ' + bErr.message);
                }
            }
            
            // 結果返却
            data.batch_results = batchResults;
            data.success = batchResults.success > 0;
            if (batchResults.success > 0) {
                VolRateLimiter.record(batchVolId, 'BATCH');
            }
            return;
        } // End of batch_action

        // ==========================================
        // [V9] 現在地 (Zone) 更新
        // ==========================================
        if (input.action === 'update_zone') {
            var zoneValue = input.zone;
            var currentUserId = gs.getUserID();

            try {
                var userGr = new GlideRecord('sys_user');
                if (userGr.get(currentUserId)) {
                    userGr.setValue('current_zone', zoneValue);
                    userGr.update();
                    logProcessEvent('zone_update', currentUserId, {
                        zone: zoneValue,
                        timestamp: new GlideDateTime().toString()
                    });
                    data.zone_updated = true;
                    data.current_zone = zoneValue;
                } else {
                    data.error = 'ユーザーが見つかりません';
                }
            } catch (e) {
                gs.getSession().putClientData('shelter_zone', zoneValue);
                data.zone_updated = true;
                data.current_zone = zoneValue;
                data.zone_storage = 'session';
            }
            return;
        }

        if (input.action === 'set_availability') {
            try {
                var availVolId = gs.getUserID();
                var availRateCheck = VolRateLimiter.check(availVolId, 'VOL_STATE', 1, 3);
                if (!availRateCheck.allowed) { data.error = availRateCheck.message; return; }
                var assignEngine2 = new x_1821654_kokoro_0.KokoroAutoAssignment();
                assignEngine2.setVolunteerAvailability(data.user_id, input.available);
                data.success = true;
                data.message = input.available ? 'オンラインになりました' : 'オフラインになりました';
                VolRateLimiter.record(availVolId, 'VOL_STATE');
            } catch (e) { data.error = '状態更新に失敗しました: ' + e.message; }
            return;
        }

        if (input.action === 'update_capacity' && input.capacity) {
            try {
                var capVolId = gs.getUserID();
                var capRateCheck = VolRateLimiter.check(capVolId, 'VOL_STATE', 1, 3);
                if (!capRateCheck.allowed) { data.error = capRateCheck.message; return; }
                var assignEngineCap = new x_1821654_kokoro_0.KokoroAutoAssignment();
                if (typeof assignEngineCap.updateVolunteerCapacity === 'function') {
                    assignEngineCap.updateVolunteerCapacity(data.user_id, input.capacity);
                }
                data.success = true;
                data.message = '対応可能数を更新しました';
                VolRateLimiter.record(capVolId, 'VOL_STATE');
            } catch (e) { data.error = '容量更新に失敗しました: ' + e.message; }
            return;
        }

        if (input.action === 'trigger_auto_assign' && input.sys_id) {
            if (!isVolunteer) { data.error = '権限がありません'; return; }
            try {
                var assignEngine3 = new x_1821654_kokoro_0.KokoroAutoAssignment();
                var result = assignEngine3.autoAssign(input.sys_id, { forceReassign: input.force_reassign });
                if (result.success) { data.success = true; data.assigned_to = result.volunteer_name; data.score = result.score; }
                else { data.error = result.reason; }
            } catch (e) { data.error = '自動分配に失敗しました: ' + e.message; }
            return;
        }

        if (input.action === 'get_sla_info' && input.sys_id) {
            try {
                var slaEngine2 = new x_1821654_kokoro_0.KokoroSLAEngine();
                data.sla_info = slaEngine2.getSLAInfo(input.sys_id);
                data.success = true;
            } catch (e) { data.error = 'SLA情報の取得に失敗しました'; }
            return;
        }

        if (input.action === 'get_volunteers') {
            data.volunteers = loadVolunteerList();
            data.success = true;
            return;
        }

        if (input.action === 'save_settings') {
            try {
                var successProfile = false;
                var successWill = true;
                var grUp = new GlideRecord(CONFIG.tables.USER_PROFILE);
                grUp.addQuery('user', data.user_id); grUp.query();
                if (grUp.next()) {
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.update() != null);
                } else {
                    grUp.initialize();
                    grUp.setValue('user', data.user_id);
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.insert() != null);
                }
                if (input.will && String(input.will).trim() !== '') {
                    var oldMsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldMsg.addQuery('user', data.user_id); oldMsg.addQuery('is_active', true);
                    oldMsg.addQuery('message_type', 'Last_Will'); oldMsg.query();
                    while (oldMsg.next()) { oldMsg.setValue('is_active', false); oldMsg.update(); }
                    var emsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsg.initialize();
                    emsg.setValue('user', data.user_id);
                    emsg.setValue('message_encrypted', sanitizeInput(input.will, 4000));
                    emsg.setValue('message_type', 'Last_Will');
                    emsg.setValue('is_active', true);
                    emsg.setValue('created_at', new GlideDateTime());
                    successWill = (emsg.insert() != null);
                }
                if (successProfile && successWill) {
                    data.success = true;
                    logProcessEvent(data.user_id, 'User settings updated', data.user_id);
                } else { data.error = "保存失敗"; }
            } catch (e) { gs.error("[Kokoro] Save error: " + e.message); data.error = "保存エラー"; }
            return;
        }

        if (input.action === 'submit_record' || input.action === 'update_record') {
            if (!input.location || !input.category || !input.urgency) { data.error = "必須項目が不足"; return; }
            try {
                var gr = new GlideRecord(CONFIG.tables.SILENT_WISH);
                if (input.action === 'update_record' && input.sys_id) {
                    if (!validateSysId(input.sys_id)) { data.error = "無効なID"; return; }
                    if (!gr.get(input.sys_id)) { data.error = "レコードが見つかりません"; return; }
                } else {
                    gr.initialize();
                    gr.setValue('state', CONFIG.wishStates.SUBMITTED);
                }
                gr.setValue('shelter_zone', sanitizeInput(input.location, 100));
                gr.setValue('request_category', sanitizeInput(input.category, 50));
                gr.setValue('qty', parseInt(input.quantity) || 1);
                gr.setValue('urgency', sanitizeInput(input.urgency, 20));
                gr.setValue('u_affected_count', sanitizeInput(input.affected_count, 10));
                gr.setValue('wish_content', sanitizeInput(input.remarks, 1000));
                gr.setValue('u_contact_info', sanitizeInput(input.contact, 200));
                gr.setValue('precise_location', sanitizeInput(input.detail_loc, 200));
                var fullDescription = "【詳細場所】: " + sanitizeInput(input.detail_loc, 200) + "\n" +
                    "【支援種別】: " + input.category + " x " + (input.quantity || 1) + "\n" +
                    "【緊急度】: " + input.urgency + "\n" +
                    "【対象人数】: " + (input.affected_count || '1') + "\n" +
                    "【備考】: " + (input.remarks || 'なし');
                gr.setValue('wish_content', fullDescription);
                if (input.action === 'submit_record') {
                    var sysId = gr.insert();
                    if (sysId) { data.ticketNumber = gr.getValue('number'); data.newRecordID = sysId; data.success = true; logProcessEvent(sysId, 'Wish submitted: ' + input.category, data.user_id); }
                    else { data.error = "作成失敗"; }
                } else {
                    if (gr.update()) { data.ticketNumber = gr.getValue('number'); data.success = true; logProcessEvent(input.sys_id, 'Wish updated', data.user_id); }
                    else { data.error = "更新失敗"; }
                }
            } catch (e) { gs.error("[Kokoro] Submit error: " + e.message); data.error = "エラーが発生しました: " + e.message; }
            return;
        }

        if (input.action === 'upload_attachment' && input.sys_id) {
            try {
                if (!validateSysId(input.sys_id)) { data.error = "無効なID"; return; }
                var attachment = new GlideSysAttachment();
                if (input.file_data) {
                    var cleanBase64 = input.file_data.split(',')[1] || input.file_data;
                    attachment.writeBase64(input.table || CONFIG.tables.SILENT_WISH, input.sys_id, sanitizeInput(input.file_name, 100), input.content_type, cleanBase64);
                    data.success = true;
                }
            } catch (e) { gs.error("[Kokoro] Attachment error: " + e.message); }
            return;
        }

        if (input.action === 'register_heartbeat') {
            try {
                var hb = new GlideRecord(CONFIG.tables.HEARTBEAT);
                hb.initialize();
                hb.setValue('user', data.user_id);
                hb.setValue('timestamp', new GlideDateTime());
                hb.setValue('status', 'Safe');
                var hbId = hb.insert();
                data.heartbeat_id = hbId; data.success = true;
                logProcessEvent(hbId, 'Heartbeat registered', data.user_id);
            } catch (e) { gs.error("[Kokoro] Heartbeat error: " + e.message); data.error = "心跳注册失败"; }
            return;
        }

        if (input.action === 'update_will') {
            try {
                if (input.message) {
                    var oldQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldQuick.addQuery('user', data.user_id); oldQuick.addQuery('is_active', true);
                    oldQuick.addQuery('message_type', 'Quick_Will'); oldQuick.query();
                    while (oldQuick.next()) { oldQuick.setValue('is_active', false); oldQuick.update(); }
                    var emsgQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsgQuick.initialize();
                    emsgQuick.setValue('user', data.user_id);
                    emsgQuick.setValue('message_encrypted', sanitizeInput(input.message, 4000));
                    emsgQuick.setValue('message_type', 'Quick_Will');
                    emsgQuick.setValue('is_active', true);
                    emsgQuick.setValue('created_at', new GlideDateTime());
                    if (emsgQuick.insert()) { data.success = true; }
                }
            } catch (e) { gs.error("[Kokoro] Quick will error: " + e.message); }
            return;
        }

        // ★★★ 志愿者操作 ★★★
        if (input.sys_id) {
            if (!validateSysId(input.sys_id)) { data.error = "無効なID"; return; }
            var volTaskGr = new GlideRecord(CONFIG.tables.SILENT_WISH); 
            if (!volTaskGr.get(input.sys_id)) { data.error = "タスクが見つかりません"; return; }
            var volState = String(volTaskGr.getValue('state') || '10');

            if (input.action === 'assign_to_me') {
                if (!isVolunteer) { data.error = "ボランティア権限が必要です"; return; }
							// 乐观锁检查
                if (input.sys_mod_count !== undefined) {
                    var assignConcur = checkConcurrency(
                        CONFIG.tables.SILENT_WISH, input.sys_id, input.sys_mod_count
                    );
                    if (!assignConcur.ok) {
                        data.error = assignConcur.message;
                        data.concurrency_conflict = true;
                        return;
                    }
                }
                var assignVolId = gs.getUserID();
                var assignRateCheck = VolRateLimiter.check(assignVolId, 'ASSIGN', 1, 5);
                if (!assignRateCheck.allowed) { data.error = assignRateCheck.message; return; }
                volTaskGr.setValue('assigned_to', data.user_id);
                if (volState === '1' || volState === '10') {
                    var validationAssign = StateValidator.validateTransition(volState, '11');
                    if (validationAssign.valid) { volTaskGr.setValue('state', '11'); }
                }
                if (volTaskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + data.user_name, data.user_id);
                    VolRateLimiter.record(assignVolId, 'ASSIGN');
                } else { data.error = "更新失敗"; }
                return;
            }

            if (input.action === 'assign_to' && input.assignee_id) {
                if (!isVolunteer) { data.error = "ボランティア権限が必要です"; return; }
                volTaskGr.setValue('assigned_to', input.assignee_id);
                if (volState === '1' || volState === '10') {
                    var validationAssignTo = StateValidator.validateTransition(volState, '11');
                    if (validationAssignTo.valid) { volTaskGr.setValue('state', '11'); }
                }
                if (volTaskGr.update()) { data.success = true; logProcessEvent(input.sys_id, 'Task assigned to ' + input.assignee_id, data.user_id); }
                else { data.error = "更新失敗"; }
                return;
            }

            if (input.action === 'change_status' && input.new_state) {
							// 乐观锁检查
                if (input.sys_mod_count !== undefined) {
                    var csConcur = checkConcurrency(
                        CONFIG.tables.SILENT_WISH, input.sys_id, input.sys_mod_count
                    );
                    if (!csConcur.ok) {
                        data.error = csConcur.message;
                        data.concurrency_conflict = true;
                        return;
                    }
                }
                var csVolId = gs.getUserID();
                var csRateCheck = VolRateLimiter.check(csVolId, 'STATUS_CHANGE', 1, 10);
                if (!csRateCheck.allowed) { data.error = csRateCheck.message; return; }
                var newState = String(input.new_state);
                var validationChange = StateValidator.validateTransition(volState, newState);
                if (!validationChange.valid) { data.error = validationChange.message; return; }
                if ((newState === '2' || newState === '4') && volTaskGr.assigned_to.nil()) { data.error = "先に担当者を設定してください"; return; }
                volTaskGr.setValue('state', newState);
                if (newState === '4') { volTaskGr.setValue('u_completed_at', new GlideDateTime()); }
                if (volTaskGr.update()) { data.success = true; logProcessEvent(input.sys_id, 'Status changed to ' + newState, data.user_id); }
                else { data.error = "更新失敗"; }
                return;
            }

            if (input.action === 'start') {
							// 乐观锁检查
                if (input.sys_mod_count !== undefined) {
                    var startConcur = checkConcurrency(
                        CONFIG.tables.SILENT_WISH, input.sys_id, input.sys_mod_count
                    );
                    if (!startConcur.ok) {
                        data.error = startConcur.message;
                        data.concurrency_conflict = true;
                        return;
                    }
                }
                var validationStart = StateValidator.validateTransition(volState, '2');
                if (!validationStart.valid) { data.error = validationStart.message; return; }
                if (volTaskGr.getValue('assigned_to') != data.user_id && !gs.hasRole('admin')) { data.error = "自分に担当されたタスクのみ開始できます"; return; }
                volTaskGr.setValue('state', '2');
                if (volTaskGr.update()) { data.success = true; logProcessEvent(input.sys_id, 'Task started', data.user_id); }
                else { data.error = "更新失敗"; }
                return;
            }

            if (input.action === 'complete') {
							// 乐观锁检查
                if (input.sys_mod_count !== undefined) {
                    var completeConcur = checkConcurrency(
                        CONFIG.tables.SILENT_WISH, input.sys_id, input.sys_mod_count
                    );
                    if (!completeConcur.ok) {
                        data.error = completeConcur.message;
                        data.concurrency_conflict = true;
                        return;
                    }
                }
                var validationComplete = StateValidator.validateTransition(volState, '4');
                if (!validationComplete.valid) { data.error = validationComplete.message; return; }
                volTaskGr.setValue('state', '4');
                volTaskGr.setValue('u_completed_at', new GlideDateTime());
                if (volTaskGr.update()) { data.success = true; logProcessEvent(input.sys_id, 'Task completed', data.user_id); }
                else { data.error = "更新失敗"; }
                return;
            }

            if (input.action === 'add_comment' && input.message) {
                try {
									// 乐观锁检查
                    if (input.sys_mod_count !== undefined) {
                        var commentConcur = checkConcurrency(
                            CONFIG.tables.SILENT_WISH, input.sys_id, input.sys_mod_count
                        );
                        if (!commentConcur.ok) {
                            data.error = commentConcur.message;
                            data.concurrency_conflict = true;
                            return;
                        }
                    }
                    var commentVolId = gs.getUserID();
                    var commentRateCheck = VolRateLimiter.check(commentVolId, 'COMMENT', 2, 5);
                    if (!commentRateCheck.allowed) { data.error = commentRateCheck.message; return; }
                    volTaskGr.work_notes = sanitizeInput(input.message, 1000);
                    volTaskGr.update();
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Comment added', data.user_id);
                    VolRateLimiter.record(commentVolId, 'COMMENT');
                } catch (e) { data.error = "コメント追加失敗"; }
                return;
            }
        }
    } // end if(input)
	

    // ==========================================
    // ★★★ [FIX] 数据加载 — 全部5个缺失项 ★★★
    // ==========================================
    
    var fetchWishes = function(queryType) {
        var results = [];
        var grFetch = new GlideRecord(CONFIG.tables.SILENT_WISH);
        if (queryType === 'mine_assigned') {
            grFetch.addQuery('assigned_to', data.user_id);
        } else if (queryType === 'mine_created') {
            grFetch.addQuery('sys_created_by', gs.getUserName());
        }
        grFetch.orderByDesc('sys_created_on');
        grFetch.setLimit(queryType === 'all' ? 100 : 50);
        grFetch.query();
        while (grFetch.next()) {
            results.push(buildTaskItem(grFetch));
        }
        return results;
    };

    // ★ [FIX-1] 加载全部工单列表（看板用）
    data.list = fetchWishes('all');
    
    // ★ [FIX-2] 加载分配给我的任务
    data.myTasks = fetchWishes('mine_assigned');
    
    // 加载我创建的（原有）
    data.myRequests = fetchWishes('mine_created');

    // ★ [FIX-3] 计算 SOS 和 未分配 计数
    data.sosCount = 0;
    data.openCount = 0;
    for (var ci = 0; ci < data.list.length; ci++) {
        var countItem = data.list[ci];
        if (countItem.urgency === 'Critical' && countItem.state != 4 && countItem.state != 5) {
            data.sosCount++;
        }
        if (!countItem.assigned_to_id && countItem.state != 4 && countItem.state != 5) {
            data.openCount++;
        }
    }

    // ==========================================
    // [V9] 現在地 (Zone) 取得
    // ==========================================
    try {
        var zoneUserGr = new GlideRecord('sys_user');
        if (zoneUserGr.get(gs.getUserID())) {
            data.current_zone = zoneUserGr.getValue('current_zone') || '';
        }
    } catch (e) {
        data.current_zone = gs.getSession().getClientData('shelter_zone') || '';
    }

    // ★ [FIX-4] 使用正确的角色筛选加载志愿者
    data.volunteers = loadVolunteerList();

    // ★ [FIX-5] 加载 Comms / Announcements
    data.announcements = [];
    try {
        var annGr = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
        annGr.addQuery('is_active', true);
        annGr.addQuery('message_type', '!=', 'Last_Will');
        annGr.addQuery('message_type', '!=', 'Quick_Will');
        annGr.orderByDesc('created_at');
        annGr.setLimit(50);
        annGr.query();
        
        while (annGr.next()) {
            var rawMsg = annGr.getValue('message_encrypted') || '';
            var annTitle = rawMsg;
            var annBody = '';
            var sepIdx = rawMsg.indexOf('\n---\n');
            if (sepIdx > -1) {
                annTitle = rawMsg.substring(0, sepIdx);
                annBody = rawMsg.substring(sepIdx + 5);
            }
            
            var annCreated = new GlideDateTime(annGr.getValue('created_at'));
            var annNow = new GlideDateTime();
            var annDiffMs = GlideDateTime.subtract(annCreated, annNow).getNumericValue();
            var annMinutes = Math.floor(annDiffMs / 1000 / 60);
            var annTimeAgo = '';
            if (annMinutes < 1) annTimeAgo = '今';
            else if (annMinutes < 60) annTimeAgo = annMinutes + '分前';
            else if (annMinutes < 1440) annTimeAgo = Math.floor(annMinutes / 60) + '時間前';
            else annTimeAgo = Math.floor(annMinutes / 1440) + '日前';
            
            data.announcements.push({
                sys_id: annGr.getUniqueValue(),
                type: annGr.getValue('message_type') || 'announcement',
                title: annTitle,
                body: annBody,
                author: annGr.getDisplayValue('user') || 'System',
                time_ago: annTimeAgo,
                created_at: annGr.getDisplayValue('created_at')
            });
        }
    } catch (e) {
        gs.error('[Kokoro] Announcements load error: ' + e.message);
    }

    // ==========================================
    // Process Mining & Monitoring Data
    // ==========================================
    data.processMiningStats = { totalEvents: 0, todayEvents: 0, uniqueCases: 0, topActivities: [] };
    try {
        var gaEvents = new GlideAggregate('x_1821654_kokoro_0_process_event');
        gaEvents.addAggregate('COUNT'); gaEvents.query();
        if (gaEvents.next()) { data.processMiningStats.totalEvents = parseInt(gaEvents.getAggregate('COUNT')) || 0; }
        
        var gaTodayEvents = new GlideAggregate('x_1821654_kokoro_0_process_event');
        gaTodayEvents.addQuery('timestamp', '>=', todayPM);
        gaTodayEvents.addAggregate('COUNT'); gaTodayEvents.query();
        if (gaTodayEvents.next()) { data.processMiningStats.todayEvents = parseInt(gaTodayEvents.getAggregate('COUNT')) || 0; }
        
        var gaCases = new GlideAggregate('x_1821654_kokoro_0_process_event');
        gaCases.addAggregate('COUNT', 'DISTINCT', 'case_id'); gaCases.query();
        if (gaCases.next()) { data.processMiningStats.uniqueCases = parseInt(gaCases.getAggregate('COUNT', 'DISTINCT', 'case_id')) || 0; }
        
        var gaAct = new GlideAggregate('x_1821654_kokoro_0_process_event');
        gaAct.addAggregate('COUNT'); gaAct.groupBy('activity');
        gaAct.orderByAggregate('COUNT', 'DESC'); gaAct.setLimit(5); gaAct.query();
        while (gaAct.next()) {
            data.processMiningStats.topActivities.push({ name: gaAct.getValue('activity') || 'Unknown', count: parseInt(gaAct.getAggregate('COUNT')) || 0 });
        }
    } catch (e) { gs.debug('[Kokoro] Process Mining stats not available: ' + e.message); }

    data.systemMetrics = { healthScore: 100, lastCollected: '', alerts: { critical: 0, warning: 0 } };
    try {
        var grMetrics = new GlideRecord('x_1821654_kokoro_0_metrics');
        grMetrics.addQuery('metric_type', 'system_health');
        grMetrics.orderByDesc('timestamp'); grMetrics.setLimit(1); grMetrics.query();
        if (grMetrics.next()) {
            data.systemMetrics.healthScore = parseInt(grMetrics.getValue('health_score')) || 100;
            data.systemMetrics.lastCollected = grMetrics.getDisplayValue('timestamp');
            var metricData = grMetrics.getValue('metric_data');
            if (metricData) { try { var parsed = JSON.parse(metricData); if (parsed.alerts) { data.systemMetrics.alerts = parsed.alerts; } } catch (parseErr) {} }
        }
        var gaAlertsCrit = new GlideAggregate('x_1821654_kokoro_0_metrics');
        gaAlertsCrit.addQuery('metric_type', 'alert'); gaAlertsCrit.addQuery('health_score', '<', 50);
        gaAlertsCrit.addQuery('timestamp', '>=', todayPM);
        gaAlertsCrit.addAggregate('COUNT'); gaAlertsCrit.query();
        if (gaAlertsCrit.next()) { data.systemMetrics.alerts.critical = parseInt(gaAlertsCrit.getAggregate('COUNT')) || 0; }
    } catch (e) { gs.debug('[Kokoro] System metrics not available: ' + e.message); }

    data.auditStats = { todayLogs: 0, recentActions: [] };
    try {
        var gaAudit = new GlideAggregate('x_1821654_kokoro_0_audit_log');
        gaAudit.addQuery('timestamp', '>=', todayPM);
        gaAudit.addAggregate('COUNT'); gaAudit.query();
        if (gaAudit.next()) { data.auditStats.todayLogs = parseInt(gaAudit.getAggregate('COUNT')) || 0; }
        var grAudit = new GlideRecord('x_1821654_kokoro_0_audit_log');
        grAudit.orderByDesc('timestamp'); grAudit.setLimit(5); grAudit.query();
        while (grAudit.next()) {
            data.auditStats.recentActions.push({ action: grAudit.getValue('action') || 'Unknown', user: grAudit.getDisplayValue('user') || 'System', time: grAudit.getDisplayValue('timestamp') });
        }
    } catch (e) { gs.debug('[Kokoro] Audit stats not available: ' + e.message); }

    data.overallHealth = { score: 100, status: 'nominal', components: [] };
    try {
        var healthScores = [];
        var slaHealthScore = 100;
        if (data.slaStats && data.slaStats.breached > 0) { slaHealthScore = Math.max(0, 100 - (data.slaStats.breached * 10)); }
        healthScores.push({ name: 'SLA', score: slaHealthScore });
        var taskHealthScore = 100;
        if (data.openCount > 10) { taskHealthScore = Math.max(50, 100 - (data.openCount * 2)); }
        healthScores.push({ name: 'Tasks', score: taskHealthScore });
        healthScores.push({ name: 'System', score: data.systemMetrics.healthScore });
        var totalHealthScore = 0;
        for (var hi = 0; hi < healthScores.length; hi++) { totalHealthScore += healthScores[hi].score; }
        data.overallHealth.score = Math.round(totalHealthScore / healthScores.length);
        data.overallHealth.components = healthScores;
        if (data.overallHealth.score >= 90) { data.overallHealth.status = 'nominal'; }
        else if (data.overallHealth.score >= 70) { data.overallHealth.status = 'warning'; }
        else { data.overallHealth.status = 'critical'; }
    } catch (e) { gs.debug('[Kokoro] Health calculation error: ' + e.message); }

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-26 11:41:20</sys_created_on>
        <sys_id>f95e8ba383227210f6b1fb96feaad375</sys_id>
        <sys_mod_count>703</sys_mod_count>
        <sys_name>Kokoro Volunteer Dashboard</sys_name>
        <sys_package display_value="Kokoro Shelter" source="x_1821654_kokoro_0">80ba4d9583863210f6b1fb96feaad3b2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Kokoro Shelter">80ba4d9583863210f6b1fb96feaad3b2</sys_scope>
        <sys_update_name>sp_widget_f95e8ba383227210f6b1fb96feaad375</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-21 13:35:00</sys_updated_on>
        <template><![CDATA[<style>
/* ============================================================
   KOKORO DASHBOARD CSS v9.6 (ULTIMATE FUSED EDITION)
   适配：v4.0 Zenless Structure + v9.5 Visual Style (DEEP SHELTER PROTOCOL)
   ============================================================ */

/* 1. 基础隐藏 (原有) - [保留：未改动] */
nav, header, footer, .sp-page-header, .navbar, .polaris-header, 
.sn-polaris-nav, .sn-canvas-header, #sp-nav-bar, .sp-row-background,
.cms-header, .navpage-header {
  display: none !important;
}

/* 2. 针对性隐藏 - [保留：未改动] */
.sn-chat-overlay, .help-button-wrapper, .sp-ac-root, .sw-session-repro-button,
button.help-button, .sn-connect-floating-wrapper, #u_chat_button, .cm-help-button,
.sp-page-row-options, .theme-picker, .sp-debug-tool, div[ng-controller="spPageRowOptions"],
a[title="Toggle Layout"], .btn-floating, .sp-icon-edit,
.guided-tour-overlay, .code-editor-container, 
.icon-palette, .fa-cog, .sp-icon-color, .sp-preview-pill {
  display: none !important;
  visibility: hidden !important;
  width: 0 !important; height: 0 !important;
  pointer-events: none !important;
  opacity: 0 !important;
  z-index: -9999 !important;
}

/* 无差别打击固定定位元素 - [保留：未改动] */
body > div[style*="position: fixed"][style*="bottom"],
body > div[style*="position:fixed"][style*="bottom"],
body > button[style*="position: fixed"][style*="bottom"],
body > div[style*="position: fixed"][style*="left"], 
body > div[style*="position:fixed"][style*="left"] {
    display: none !important;
    opacity: 0 !important;
    pointer-events: none !important;
    z-index: -9999 !important;
}

/* 强制覆盖 ServiceNow 隐藏的白底容器 */
body, html, .sp-page-root, section.page, main, .sp-page {
    background-color: #090B10 !important;
}

/* ═══════════════════════════════════════════════════════════════
   END
   ═══════════════════════════════════════════════════════════════ */

/* 3. 容器样式 (修复版: 强制全屏覆盖，脱离SP容器限制) */
.kokoro-volunteer-container {
    display: flex;
    flex-direction: column;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden;
    background: var(--bg-color);
    /* 关键修改：使用 fixed 定位强行占满屏幕 */
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 1000; /* 提升层级，覆盖默认Portal元素 */
}
  
* {
  box-sizing: border-box;
}
  
/* 4. Modal 核心修复 (DEEP SHELTER 重构) */
.modal { z-index: 20000 !important; }
.modal-backdrop { 
  z-index: 19999 !important; 
  background-color: rgba(9, 11, 16, 0.85) !important; 
  backdrop-filter: blur(8px) saturate(150%); 
}
.modal-dialog { margin-top: 50px; z-index: 20001 !important; max-width: 900px; width: 90%; }
.modal-content {
  background: #1A1E27 !important; /* var(--bg-surface-elevated) */
  border: 1px solid rgba(255, 255, 255, 0.08) !important;
  border-radius: 0 !important;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.05) !important;
  color: #E2E8F0 !important; /* var(--text-primary) */
  font-family: var(--font-mono) !important;
  padding: 0 !important;
  overflow: visible !important;
}

/* 5. 模态框内部样式 (DEEP SHELTER 重构) */
.modal-header-clean { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  padding: 16px 24px; 
  background: transparent; 
  border-bottom: 1px solid rgba(255, 255, 255, 0.08); 
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-badge { 
  background: rgba(56, 189, 248, 0.1); 
  color: #38BDF8; /* var(--signal-info) */
  border: 1px solid rgba(56, 189, 248, 0.3);
  padding: 4px 10px; 
  font-weight: 700; 
  font-size: 0.8rem; 
}
.header-id { 
  font-family: var(--font-tech); 
  font-weight: 700; 
  font-size: 1.1rem; 
  color: #FFFFFF;
}
.header-close { 
  background: none; 
  border: 1px solid rgba(255, 255, 255, 0.15); 
  color: #94A3B8;
  width: 32px; 
  height: 32px; 
  cursor: pointer; 
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); 
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.header-close:hover { 
  background: rgba(225, 29, 72, 0.15); 
  color: #E11D48; /* var(--signal-critical) */
  border-color: #E11D48; 
}

.modal-body-grid { 
  display: grid; 
  grid-template-columns: 1fr 300px; 
  min-height: 500px; 
  max-height: 70vh;
  overflow: hidden;
}

.body-main { 
  padding: 24px; 
  border-right: 1px solid rgba(255, 255, 255, 0.08); 
  overflow-y: auto;
  max-height: 70vh;
}

.body-sidebar {
  background: #12151C; /* var(--bg-surface) */
  border-left: 1px solid rgba(255, 255, 255, 0.04);
  padding: 24px;
  overflow-y: auto;
  max-height: 70vh;
}

.ticket-title { 
  font-family: var(--font-header); 
  font-size: 1.5rem; 
  font-weight: 700; 
  color: #FFFFFF;
  margin: 0 0 20px 0; 
  border-bottom: 1px solid rgba(255, 255, 255, 0.08); 
  padding-bottom: 15px; 
}

.qty-badge-black { 
  background: rgba(255, 255, 255, 0.1); 
  color: #E2E8F0; 
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 2px 8px; 
  font-size: 0.8rem; 
  vertical-align: middle; 
  margin-left: 10px; 
}

.action-bar { 
  display: flex; 
  gap: 12px; 
  margin-bottom: 24px; 
  flex-wrap: wrap; 
}

.btn-purple-outline, .btn-normal { 
  background: transparent; 
  padding: 8px 16px; 
  font-weight: 700; 
  cursor: pointer; 
  text-transform: uppercase;
  font-family: var(--font-header);
  font-size: 12px;
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.btn-purple-outline {
  border: 1px solid rgba(56, 189, 248, 0.5);
  color: #38BDF8;
}

.btn-purple-outline:hover {
  background: rgba(56, 189, 248, 0.1);
  border-color: #38BDF8;
}

.btn-normal {
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: #94A3B8;
}

.btn-normal:hover {
  background: rgba(255, 255, 255, 0.05);
  color: #E2E8F0;
}

.action-btn { 
  background: rgba(56, 189, 248, 0.15); 
  color: #38BDF8; 
  border: 1px solid #38BDF8; 
  padding: 8px 16px; 
  font-weight: 700; 
  cursor: pointer; 
  text-transform: uppercase; 
  font-family: var(--font-header);
  font-size: 12px;
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.action-btn:hover { 
  background: rgba(56, 189, 248, 0.25); 
}

.desc-box { 
  background: rgba(255, 255, 255, 0.02); 
  border: 1px solid rgba(255, 255, 255, 0.08); 
  padding: 16px; 
  margin-bottom: 24px; 
}

.desc-section-title { 
  font-size: 0.8rem; 
  color: #475569; /* var(--text-muted) */
  margin-bottom: 12px; 
  font-weight: 700; 
  letter-spacing: 1px; 
}

.desc-grid { 
  display: grid; 
  gap: 12px; 
}

.desc-item { 
  display: flex; 
  gap: 10px; 
  align-items: flex-start; 
  font-size: 0.9rem; 
}

.desc-icon { 
  width: 24px; 
  text-align: center; 
  color: #94A3B8; 
  flex-shrink: 0;
}

.desc-label { 
  font-weight: 700; 
  color: #94A3B8; 
  margin-right: 6px; 
}

.activity-area { 
  margin-top: 20px; 
}

.note-input { 
  width: 100%; 
  background: #090B10; /* var(--bg-base) */
  border: 1px solid rgba(255, 255, 255, 0.15); 
  color: #E2E8F0;
  padding: 10px; 
  min-height: 60px; 
  margin-bottom: 10px; 
  font-family: var(--font-mono); 
  resize: vertical;
}

.note-input:focus {
  outline: none;
  border-color: #38BDF8;
}

.submit-btn { 
  background: rgba(255, 255, 255, 0.05); 
  color: #475569; 
  border: 1px solid rgba(255, 255, 255, 0.1); 
  padding: 8px 16px; 
  font-weight: 700; 
  cursor: not-allowed; 
  float: right;
  transition: all 0.2s;
}

.submit-btn.ready { 
  background: rgba(56, 189, 248, 0.15); 
  color: #38BDF8;
  border-color: #38BDF8;
  cursor: pointer; 
}

.submit-btn.ready:hover {
  background: rgba(56, 189, 248, 0.25);
}

.sidebar-block { 
  margin-bottom: 24px; 
  padding-bottom: 16px; 
  border-bottom: 1px solid rgba(255, 255, 255, 0.08); 
}

.sb-label { 
  font-size: 0.75rem; 
  color: #475569; 
  margin-bottom: 8px; 
  font-weight: 700; 
  letter-spacing: 1px; 
}

.user-row { 
  display: flex; 
  align-items: center; 
  gap: 10px; 
}

.avatar-box { 
  width: 32px; 
  height: 32px; 
  background: rgba(255, 255, 255, 0.1); 
  color: #E2E8F0; 
  border: 1px solid rgba(255, 255, 255, 0.2);
  display: flex; 
  align-items: center; 
  justify-content: center; 
  border-radius: 4px; 
  font-weight: 700;
  flex-shrink: 0;
}

.avatar-box.orange { 
  background: rgba(245, 158, 11, 0.15); 
  color: #F59E0B;
  border-color: rgba(245, 158, 11, 0.3);
}

.user-name-text {
  font-weight: 600;
  color: #E2E8F0;
}

.state-indicator { 
  padding: 4px 10px; 
  border-radius: 4px;
  color: #FFFFFF;
  font-weight: 700;
  font-size: 0.9rem;
  display: inline-block;
}

.priority-btn { 
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.08);
  color: #94A3B8; 
  padding: 10px 18px; 
  font-family: var(--font-header); 
  font-weight: 700; 
  font-size: 14px; 
  display: flex; 
  align-items: center; 
  gap: 10px;
}
  
.sla-progress { 
  height: 6px; 
  background: rgba(255, 255, 255, 0.05); 
  border: 1px solid rgba(255, 255, 255, 0.08);
  overflow: hidden; 
  margin-bottom: 12px;
  border-radius: 0;
}

.sla-fill { 
  height: 100%; 
  position: relative;
  border-radius: 0;
}

.sla-text { 
  display: flex; 
  justify-content: space-between; 
  font-family: var(--font-mono); 
  font-size: 12px; 
  color: #94A3B8; 
  margin-bottom: 12px;
}

.sla-badge { 
  background: rgba(255, 255, 255, 0.05);
  color: #94A3B8; 
  border: 1px solid rgba(255, 255, 255, 0.08);
  padding: 4px 12px; 
  font-family: var(--font-mono); 
  font-size: 11px; 
  font-weight: 800; 
  letter-spacing: 1px; 
  display: inline-flex; 
  align-items: center; 
  gap: 8px;
  border-radius: 0;
}

.sla-badge.sla-critical { 
  background: rgba(225, 29, 72, 0.1); 
  color: #E11D48;
  border-color: rgba(225, 29, 72, 0.3);
}

.sla-badge.sla-ok { 
  background: rgba(16, 185, 129, 0.1); 
  color: #10B981;
  border-color: rgba(16, 185, 129, 0.3);
}

.dropdown-wrapper { 
  position: relative; 
  display: inline-block; 
}

.status-menu { 
  position: absolute; 
  top: 100%; 
  left: 0; 
  background: #1A1E27; 
  border: 1px solid rgba(255, 255, 255, 0.15); 
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6); 
  z-index: 10; 
  min-width: 160px;
  margin-top: 4px;
}

.status-item { 
  padding: 10px 16px; 
  cursor: pointer; 
  font-size: 0.85rem; 
  color: #E2E8F0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  transition: all 0.2s;
}

.status-item:hover { 
  background: rgba(255, 255, 255, 0.05); 
}

.status-item.danger { 
  color: #E11D48; 
}

<style>
/* 6. Headers & Layout (Gotham / Deep Shelter Protocol) */
.command-header {
  padding: 6px 16px !important;
  gap: 12px !important;
  min-height: 0 !important;
  background: rgba(9, 11, 16, 0.85) !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
  box-shadow: none !important;
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  flex-shrink: 0;
}

.hamburger-btn {
  background: transparent !important;
  border: 1px solid rgba(255, 255, 255, 0.08) !important;
  width: 28px !important;
  height: 28px !important;
  margin-right: 8px !important;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
  border-radius: 4px;
}

.hamburger-btn:hover {
  background: rgba(255, 255, 255, 0.04) !important;
  border-color: rgba(255, 255, 255, 0.12) !important;
}

.hamburger-btn i {
  font-size: 13px !important;
  color: #94A3B8 !important; 
}

.hamburger-btn:hover i {
  color: #E2E8F0 !important; 
}

.command-logo { 
  display: flex; 
  align-items: center; 
  gap: 8px !important;
  flex: 1;
  min-width: 0;
}

.logo-icon { 
  width: 28px !important; 
  height: 28px !important; 
  font-size: 14px !important;
  clip-path: none !important;
  border-radius: 3px !important;
  background: rgba(56, 189, 248, 0.08) !important;
  border: 1px solid rgba(56, 189, 248, 0.2) !important;
  color: #38BDF8 !important;
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-weight: 900; 
  flex-shrink: 0;
}

.logo-text { 
  display: flex; 
  flex-direction: column; 
  line-height: 1.2;
  flex-shrink: 0;
}

.logo-title { 
  font-weight: 700 !important; 
  font-size: 14px !important; 
  letter-spacing: 2px !important;
  color: #FFFFFF;
}

.logo-subtitle { 
  display: none !important; /* Gotham 规范中隐藏副标题 */
}

.system-status { 
  display: flex; 
  align-items: center; 
  gap: 10px !important; 
  font-size: 11px !important; 
  font-family: var(--font-mono);
  margin-left: auto;
  flex-shrink: 0;
}

.status-indicator { 
  display: flex; 
  align-items: center; 
  gap: 6px; 
}

.status-dot { 
  width: 8px;
  height: 8px; 
  background: #10B981; 
  border-radius: 50%; 
  box-shadow: 0 0 6px #10B981; 
  animation: blink 2s infinite;
}

.status-text {
  color: #10B981;
  font-weight: 600;
  letter-spacing: 0.05em;
}

.version-tag { 
  padding: 1px 5px !important; 
  font-size: 9px !important;
  background: rgba(255, 255, 255, 0.02); 
  border: 1px solid rgba(255, 255, 255, 0.04);
  color: #475569; 
  border-radius: 2px;
}

.system-time {
  font-family: var(--font-mono);
  color: #E2E8F0;
  font-weight: 500 !important;
  font-size: 11px !important;
}

.scan-line-header {
  display: flex; 
  align-items: center; 
  gap: 16px; 
  padding: 10px 32px;
  background: transparent;
  border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  font-size: 10px; 
  color: #475569; 
  letter-spacing: 0.2em;
  text-transform: uppercase;
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}

.scan-line { 
  flex: 1;
  height: 1px; 
  background: linear-gradient(90deg, rgba(56, 189, 248, 0.15), transparent);
  position: relative;
  overflow: hidden;
}

.scan-line::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 15%;
  background: linear-gradient(90deg, transparent, #38BDF8, transparent);
  opacity: 0.4;
}

.nav-tabs-custom { 
  display: flex; 
  padding: 0 16px !important;
  background: #12151C !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.04) !important;
  gap: 4px;
  flex-shrink: 0;
  overflow-x: auto;
  overflow-y: hidden;
}

.tab { 
  padding: 8px 16px !important; 
  font-size: 11px !important;
  letter-spacing: 0.08em !important;
  font-weight: 500 !important;
  color: #94A3B8;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  text-transform: uppercase;
  cursor: pointer; 
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
  white-space: nowrap;
  flex-shrink: 0;
}

.tab:hover { 
  color: #E2E8F0;
  background: rgba(255, 255, 255, 0.02);
  border-bottom-color: rgba(255, 255, 255, 0.08);
}

.tab.active { 
  color: #38BDF8; 
  border-bottom-color: #38BDF8; 
  background: linear-gradient(0deg, rgba(56, 189, 248, 0.08) 0%, transparent 100%);
  text-shadow: 0 0 12px rgba(56, 189, 248, 0.4);
}

.tab-number { 
  font-family: var(--font-mono); 
  font-size: 9px !important;
  margin-right: 4px !important;
  color: #475569;
}

.tab.active .tab-number {
  color: #38BDF8;
  opacity: 0.8;
}

.board-container { 
  padding: 0 !important; 
  overflow-y: auto; 
  overflow-x: hidden;
  flex: 1;
  background: transparent;
  width: 100% !important; 
  max-width: none !important; 
  margin: 0 !important; 
  display: flex;
  flex-direction: column;
}

.two-column-layout { 
  display: grid; 
  grid-template-columns: 1fr 380px; 
  gap: 16px; 
  margin-top: 16px; 
  padding: 16px 32px 24px;
}

/* 7. Volunteers & Stats (Gotham Protocol) */
.volunteer-status-panel {
  padding: 5px 16px !important;
  margin-bottom: 0 !important;
  gap: 20px !important;
  border: none !important;
  border-left: none !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.04) !important;
  background: transparent !important;
  box-shadow: none !important;
  display: flex; 
  align-items: center; 
  flex-wrap: wrap;
}

.status-row { 
  display: flex; 
  align-items: center; 
  gap: 6px !important; 
  font-size: 11px !important;
  font-weight: 500;
  color: #E2E8F0;
}

.status-row i {
  color: #38BDF8;
  font-size: 11px !important;
  width: 14px !important;
  text-align: center;
}

.btn-online, .btn-offline { 
  padding: 2px 10px !important;
  font-size: 9px !important;
  clip-path: none !important;
  border-radius: 0;
  font-family: var(--font-mono);
  font-weight: 600;
  letter-spacing: 0.05em;
  cursor: pointer; 
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.btn-online { 
  background: rgba(16, 185, 129, 0.08);
  color: #10B981; 
  border: 1px solid #10B981;
}

.btn-online:hover {
  background: rgba(16, 185, 129, 0.15);
  box-shadow: inset 0 0 12px rgba(16, 185, 129, 0.1);
  color: #fff;
}

.btn-offline { 
  background: transparent;
  color: #475569; 
  border: 1px solid rgba(255, 255, 255, 0.15);
}

.btn-offline:hover {
  color: #94A3B8;
  border-color: #94A3B8;
}

.status-row select { 
  padding: 2px 6px !important;
  font-size: 10px !important;
  background: #090B10 !important;
  color: #E2E8F0 !important;
  border: 1px solid rgba(255, 255, 255, 0.08) !important;
  border-radius: 0;
  font-family: var(--font-mono);
  cursor: pointer;
  -webkit-appearance: none;
  appearance: none;
}

.stats-section .section-header { 
  display: flex; 
  align-items: center; 
  gap: 12px;
  padding-bottom: 8px;
  margin-bottom: 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.15);
  position: relative;
}

.stats-section .section-header::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 48px;
  height: 1px;
  background: #38BDF8;
  box-shadow: 0 0 8px rgba(56, 189, 248, 0.4);
}

.section-tag { 
  background: rgba(56, 189, 248, 0.05);
  color: #38BDF8;
  border: 1px solid rgba(56, 189, 248, 0.2);
  padding: 4px 12px;
  font-weight: 600;
  font-size: 11px;
  font-family: var(--font-mono);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  border-radius: 0;
  margin-right: 0;
}

.section-title { 
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 14px;
  color: #E2E8F0;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

.section-time { 
  margin-left: auto; 
  font-family: var(--font-mono);
  font-size: 11px;
  color: #475569;
}

.stats-row { 
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.stat-card { 
  background: #FFFFFF; /* 根据你的规范强制纯白底色 */
  border: 1px solid #D0D4D9;
  padding: 12px 16px;
  position: relative;
  transition: border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
  cursor: default;
  overflow: hidden;
}

.stat-card.clickable {
  cursor: pointer;
}

.stat-card.clickable:hover { 
  border-color: #1A1A1A;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.stat-label { 
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.stat-code {
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 13px;
  color: #1A1A1A;
  letter-spacing: 0.05em;
}

.stat-suffix {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #8C959F;
}

.stat-num { 
  font-family: var(--font-ui);
  font-size: 36px;
  font-weight: 700;
  color: #0F0F0F;
  line-height: 1;
  margin: 12px 0;
  font-variant-numeric: tabular-nums;
}

.stat-name { 
  font-family: var(--font-mono);
  font-size: 11px;
  color: #586069;
  letter-spacing: 0.1em;
  margin-bottom: 12px;
  text-transform: uppercase;
}

.stat-footer { 
  display: flex; 
  justify-content: space-between;
  align-items: center;
  padding-top: 12px;
  border-top: 1px solid #E5E8EB;
}

.stat-change { 
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

.stat-change.positive { color: #2E8B57; }
.stat-change.negative { color: #CF222E; }

.stat-status { 
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 4px 8px;
  letter-spacing: 0.05em;
  font-weight: 600;
  text-transform: uppercase;
  border: 1px solid transparent;
  border-radius: 0;
}

.stat-status.nominal { 
  background: #F2F3F5;
  color: #586069;
  border-color: #D0D4D9;
}

.stat-status.warning { 
  background: #FFF8C5;
  color: #9A6700;
  border-color: #E6CC7A;
}

.stat-status.critical { 
  background: #FFEBE9;
  color: #CF222E;
  border-color: #FF8182;
}

/* 8. Metal Dividers (Gotham Protocol) */
.metal-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
  margin: 24px 0;
  border: none;
  position: relative;
  overflow: hidden;
}

.metal-divider::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.1), transparent);
  background-size: 200% 100%;
}

.metal-divider-glow {
  height: 1px;
  background: #38BDF8; 
  margin: 24px 0;
  box-shadow: 0 0 8px rgba(56, 189, 248, 0.2);
  opacity: 0.6;
}
<style>
  
/* 9. Cards (Tactical & Alert - Gotham Protocol) */
.alert-section {
  background: #12151C; /* var(--bg-surface) */
  border: 1px solid rgba(255, 255, 255, 0.08);
  padding: 0;
  box-shadow: none;
  display: flex;
  flex-direction: column;
}

.alert-section .section-header {
  background: transparent;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  padding: 12px 16px;
  margin: 0;
}

.alert-list { 
  max-height: 500px;
  overflow-y: auto;
}

.alert-item { 
  background: transparent; 
  border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  padding: 12px 16px; 
  margin: 0;
  display: grid; 
  grid-template-columns: 80px 60px 100px 60px 1fr 20px; 
  align-items: center; 
  gap: 10px;
  transition: background 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); 
  cursor: pointer; 
  font-size: 0.85rem;
  position: relative;
}

.alert-item::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  background: transparent;
}

.alert-item:hover { 
  background: rgba(255, 255, 255, 0.02); 
}

.alert-item:hover::before {
  background: rgba(255, 255, 255, 0.15);
}

.alert-item.priority-Critical::before { 
  background: #E11D48; /* var(--signal-critical) */
}

.alert-item.priority-High::before { 
  background: #F59E0B; /* var(--signal-warning) */
}

.alert-priority { 
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 10px;
  text-align: center;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  padding: 2px 6px;
  border: 1px solid transparent;
}

.alert-priority.p-critical { 
  background: rgba(225, 29, 72, 0.1);
  color: #E11D48; 
  border-color: rgba(225, 29, 72, 0.3);
}

.alert-priority.p-high { 
  background: rgba(245, 158, 11, 0.1);
  color: #F59E0B; 
  border-color: rgba(245, 158, 11, 0.3);
}

.alert-id { 
  font-family: var(--font-mono); 
  color: #E2E8F0;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

.alert-zone {
  font-family: var(--font-mono);
  color: #94A3B8;
  font-weight: 500;
  font-size: 11px;
}

.alert-time { 
  font-family: var(--font-mono); 
  color: #475569; 
  font-size: 0.75rem;
  font-variant-numeric: tabular-nums;
}

.alert-content {
  font-family: var(--font-ui);
  color: #E2E8F0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 500;
}

.alert-arrow {
  color: #475569;
  text-align: right;
  transition: transform 0.2s;
}

.alert-item:hover .alert-arrow {
  color: #94A3B8;
  transform: translateX(4px);
}

.empty-board {
  padding: 60px 20px;
  text-align: center;
  color: #475569;
}

.empty-board i {
  font-size: 48px;
  color: rgba(255, 255, 255, 0.08);
  margin-bottom: 15px;
}

.empty-board h4 {
  font-size: 1.2rem;
  color: #94A3B8;
  margin: 10px 0;
  font-weight: 600;
}

.empty-board p {
  font-family: var(--font-mono);
  font-size: 0.9rem;
  color: #475569;
}

.card-grid, .task-grid { 
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
  gap: 16px; 
  margin-top: 20px; 
  width: 100% !important; 
  justify-content: start;
}

.jira-card { 
  background: #1A1E27; /* var(--bg-surface-elevated) */
  border: 1px solid rgba(255, 255, 255, 0.08); 
  padding: 16px; 
  transition: border-color 0.2s, box-shadow 0.2s; 
  position: relative; 
  cursor: pointer; 
  overflow: hidden;
}

.jira-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  background: transparent;
}

.jira-card:hover { 
  border-color: rgba(255, 255, 255, 0.2); 
  transform: none; /* 废除位移 */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); 
}

.jira-card:hover::before {
  background: rgba(255, 255, 255, 0.15);
}

.jira-card.priority-Critical::before { 
  background: #E11D48; 
}

.jira-card.priority-High::before { 
  background: #F59E0B; 
}

.card-top { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start;
  margin-bottom: 10px; 
}

.card-id { 
  font-family: var(--font-mono); 
  font-size: 11px; 
  color: #94A3B8;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

.status-tag { 
  font-family: var(--font-mono);
  font-size: 0.7rem; 
  font-weight: 600; 
  padding: 2px 6px; 
  background: rgba(255, 255, 255, 0.05); 
  color: #94A3B8;
  border: 1px solid rgba(255, 255, 255, 0.08);
  text-transform: uppercase;
  border-radius: 0;
}

.status-tag.status-4 {
  background: rgba(16, 185, 129, 0.1);
  color: #10B981;
  border-color: rgba(16, 185, 129, 0.3);
}

.status-tag.status-11 {
  background: rgba(56, 189, 248, 0.1);
  color: #38BDF8;
  border-color: rgba(56, 189, 248, 0.3);
}

.card-title { 
  font-weight: 700; 
  margin-bottom: 8px; 
  font-family: var(--font-ui); 
  font-size: 14px;
  color: #FFFFFF;
  line-height: 1.4;
}

.qty-badge { 
  background: rgba(255, 255, 255, 0.1); 
  color: #E2E8F0; 
  font-family: var(--font-mono);
  font-size: 0.7rem; 
  padding: 1px 5px; 
  margin-left: 6px; 
  vertical-align: middle;
  border-radius: 0;
  border: 1px solid rgba(255, 255, 255, 0.15);
}

.card-loc { 
  font-family: var(--font-ui);
  font-size: 0.85rem; 
  color: #94A3B8; 
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.card-loc i {
  color: #E11D48;
  font-size: 12px;
}

.card-detail { 
  font-family: var(--font-ui);
  font-size: 0.8rem; 
  color: #475569; 
  margin-bottom: 10px; 
  line-height: 1.5;
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
}

.card-sla { 
  margin: 10px 0 0 0; 
  padding-top: 10px; 
  border-top: 1px solid rgba(255, 255, 255, 0.08); 
  position: relative;
}

.sla-bar-container { 
  height: 4px; 
  background: rgba(255, 255, 255, 0.05); 
  overflow: hidden; 
  margin-bottom: 8px; 
  border-radius: 0;
}

.sla-bar { 
  height: 100%; 
  transition: width 0.3s ease;
  position: relative;
}

.sla-info { 
  display: flex; 
  justify-content: space-between; 
  font-size: 10px; 
  font-family: var(--font-mono); 
  color: #94A3B8; 
  font-weight: 600; 
  font-variant-numeric: tabular-nums;
}

.sla-critical { color: #E11D48 !important; }
.sla-warning { color: #F59E0B !important; }
.sla-ok { color: #10B981 !important; }

.sla-remaining {
  display: flex;
  align-items: center;
  gap: 4px;
}

.card-footer {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid rgba(255, 255, 255, 0.04);
}

.priority-badge {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  font-weight: 600;
  padding: 2px 6px;
  background: rgba(255, 255, 255, 0.05);
  color: #94A3B8;
  border: 1px solid rgba(255, 255, 255, 0.08);
  display: inline-block;
  text-transform: uppercase;
}

.btn-jira {
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: #94A3B8;
  padding: 8px 12px;
  font-weight: 600;
  font-size: 0.8rem;
  cursor: pointer;
  text-transform: uppercase;
  font-family: var(--font-ui);
  border-radius: 0;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  width: 100%;
  margin-top: 8px;
  justify-content: center;
}

.btn-jira:hover {
  border-color: rgba(255, 255, 255, 0.3);
  background: rgba(255, 255, 255, 0.05);
  color: #E2E8F0;
}

.btn-jira.progress {
  border-color: #38BDF8;
  color: #38BDF8;
}

.btn-jira.progress:hover {
  background: rgba(56, 189, 248, 0.1);
}

.btn-jira.success {
  border-color: #10B981;
  color: #10B981;
}

.btn-jira.success:hover {
  background: rgba(16, 185, 129, 0.1);
}

.completed-msg {
  text-align: center;
  padding: 10px;
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  color: #10B981;
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 13px;
  cursor: default;
  margin-top: 10px;
  transition: all 0.2s;
}

.completed-msg:hover {
  background: rgba(16, 185, 129, 0.15);
}

/* 10. Side Panel Enhanced & Widgets */
.side-panel-wrapper {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.side-panel-enhanced { 
  display: flex; 
  flex-direction: column; 
  gap: 16px; 
  background: #12151C;
  border: 1px solid rgba(255, 255, 255, 0.08);
  padding: 16px;
  box-shadow: none;
}

.data-stream-widget { 
  background: transparent; 
  margin-bottom: 16px;
}

.widget-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  border-bottom: 1px solid rgba(255, 255, 255, 0.08); 
  padding-bottom: 10px; 
  margin-bottom: 16px; 
}

.widget-title { 
  font-family: var(--font-mono); 
  font-weight: 600; 
  font-size: 11px; 
  color: #E2E8F0; 
  display: flex; 
  align-items: center; 
  gap: 8px; 
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

.widget-title i {
  color: #94A3B8;
}

.live-indicator { 
  width: 8px; 
  height: 8px; 
  background: #E11D48; 
  border-radius: 50%; 
  animation: data-stream 2s ease-in-out infinite; 
}

.live-metric-card { 
  background: rgba(255, 255, 255, 0.02); 
  border: 1px solid rgba(255, 255, 255, 0.04);
  border-left: 2px solid #475569; 
  padding: 12px; 
  margin-bottom: 12px; 
  transition: border-color 0.2s; 
}

.live-metric-card:hover { 
  border-color: rgba(255, 255, 255, 0.15);
  transform: none; 
}

.metric-row { 
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  margin-bottom: 8px; 
}

.metric-label { 
  font-size: 12px; 
  font-weight: 600; 
  color: #94A3B8; 
}

.metric-value { 
  font-family: var(--font-ui); 
  font-weight: 700; 
  font-size: 24px;
  color: #E2E8F0; 
  font-variant-numeric: tabular-nums;
}

.metric-mini-bar { 
  height: 4px; 
  background: rgba(255, 255, 255, 0.05); 
  width: 100%; 
  overflow: hidden;
  border-radius: 0;
}

.metric-mini-fill { 
  height: 100%; 
  background: #94A3B8;
  border-radius: 0;
  transition: width 0.3s ease;
}

.ai-insight-card { 
  background: rgba(56, 189, 248, 0.02); 
  border: 1px solid rgba(56, 189, 248, 0.15); 
  border-left: 2px solid #38BDF8;
  padding: 16px; 
  position: relative; 
  overflow: hidden; 
}

.ai-insight-card::before { 
  display: none; /* 剥离旧版流光 */
}

.ai-header { 
  font-family: var(--font-mono);
  color: #38BDF8; 
  font-weight: 600; 
  font-size: 11px; 
  margin-bottom: 8px;
  display: flex; 
  align-items: center; 
  gap: 8px; 
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

.ai-content { 
  font-family: var(--font-ui);
  font-size: 13px; 
  color: #E2E8F0; 
  line-height: 1.5; 
  margin-bottom: 12px;
}

.ai-tags { 
  display: flex; 
  gap: 8px; 
  flex-wrap: wrap; 
}

.ai-tag { 
  background: rgba(56, 189, 248, 0.1); 
  color: #38BDF8; 
  border: 1px solid rgba(56, 189, 248, 0.2);
  padding: 2px 8px; 
  font-family: var(--font-mono);
  font-size: 10px; 
  font-weight: 600; 
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

.resource-section-enhanced {
  background: transparent;
  border: none;
  padding: 0;
  box-shadow: none;
}

.resource-section-enhanced .section-header { 
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.resource-item { 
  margin-bottom: 16px; 
}

.resource-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 8px; 
}

.resource-header .label { 
  font-family: var(--font-ui);
  font-size: 13px; 
  font-weight: 600; 
  color: #E2E8F0; 
}

.resource-header .code { 
  font-family: var(--font-mono); 
  color: #475569; 
  font-size: 11px; 
  font-weight: 600;
  letter-spacing: 0.05em;
}

.resource-header .percent { 
  font-family: var(--font-ui); 
  font-weight: 700;
  font-size: 14px;
  color: #FFFFFF;
  font-variant-numeric: tabular-nums;
}

.resource-bar { 
  height: 6px; 
  background: rgba(255, 255, 255, 0.05); 
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 0; 
  overflow: hidden; 
  position: relative;
}

.resource-fill { 
  height: 100%;
  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 0;
  position: relative;
}

.resource-fill.low { background: #E11D48; }
.resource-fill.medium { background: #F59E0B; }
.resource-fill.high { background: #10B981; }

/* Safety Banner */
.safety-banner {
  background: rgba(225, 29, 72, 0.1); 
  color: #FFFFFF; 
  padding: 12px 32px; 
  font-family: var(--font-mono);
  font-weight: 500;
  font-size: 13px;
  letter-spacing: 0.05em;
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  border-top: 1px solid #E11D48;
  border-bottom: 1px solid rgba(225, 29, 72, 0.3); 
  animation: critical-flash 3s ease-in-out infinite;
  box-shadow: inset 0 0 24px rgba(225, 29, 72, 0.05);
  flex-shrink: 0;
}

.safety-banner button { 
  background: transparent; 
  color: #E11D48; 
  border: 1px solid rgba(225, 29, 72, 0.5); 
  padding: 6px 16px; 
  font-family: var(--font-mono); 
  cursor: pointer;
  font-weight: 600;
  font-size: 12px;
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
  text-transform: uppercase;
}

.safety-banner button:hover {
  background: rgba(225, 29, 72, 0.15);
  border-color: #E11D48;
  color: #FFFFFF;
  box-shadow: 0 0 12px rgba(225, 29, 72, 0.2);
}

.zen-sidebar.active {
  transform: translateX(0);
}

.zen-sidebar {
  background: #12151C !important;
  border-right: 1px solid rgba(255, 255, 255, 0.06) !important;
  box-shadow: 4px 0 30px rgba(0, 0, 0, 0.8) !important;
}

.sidebar-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: #090B10;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  flex-shrink: 0;
}

.sb-title {
  font-weight: 700;
  font-size: 14px;
  letter-spacing: 2px;
  color: #E2E8F0;
  text-transform: uppercase;
}

.sb-close {
  background: transparent;
  border: 1px solid transparent;
  font-size: 20px;
  font-weight: 400;
  cursor: pointer;
  color: #94A3B8;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  border-radius: 4px;
}

.sb-close:hover {
  background: rgba(255, 255, 255, 0.05);
  color: #FFFFFF;
}

.sb-profile {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  background: #1A1E27;
  flex-shrink: 0;
}

.sb-avatar {
  width: 48px;
  height: 48px;
  background: #38BDF8;
  color: #090B10;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  font-weight: 800;
  font-size: 18px;
  flex-shrink: 0;
}

.sb-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sb-name {
  font-family: var(--font-ui);
  font-weight: 700;
  font-size: 14px;
  color: #E2E8F0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sb-role {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #94A3B8;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

.sb-nav-list {
  list-style: none;
  padding: 0;
  margin: 0;
  flex: 1;
  overflow-y: auto;
}

.sb-nav-list li {
  padding: 16px 24px;
  cursor: pointer;
  font-family: var(--font-ui);
  font-weight: 600;
  font-size: 13px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.03);
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
  display: flex;
  align-items: center;
  color: #94A3B8;
}

.sb-nav-list li:hover {
  background: rgba(255, 255, 255, 0.02);
  color: #E2E8F0;
}

.sb-nav-list li.divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.08);
  cursor: default;
  padding: 0;
  border: none;
}

.nav-num {
  font-family: var(--font-mono);
  font-size: 11px;
  color: #475569;
  margin-right: 12px;
  font-weight: 600;
}

.sb-footer {
  padding: 16px 24px;
  font-size: 11px;
  color: #475569;
  text-align: center;
  border-top: 1px solid rgba(255, 255, 255, 0.08);
  background: #090B10;
  flex-shrink: 0;
  line-height: 1.5;
  font-family: var(--font-mono);
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

.zen-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(4px);
  z-index: 99998;
  display: none;
}

.zen-backdrop.active {
  display: block;
}
  
  <style>
/* ============================================================
   AI TACTICAL TERMINAL V3.0 (GOTHAM / DEEP SHELTER PROTOCOL)
   ============================================================ */

/* 1. 卡片容器：深空暗色底色 + 极细边框 */
.ai-card {
    background: #1A1E27; /* 深空悬浮面板底色 */
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-left: 3px solid #475569; /* 静默状态左侧切线 */
    clip-path: polygon(0 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%); /* 收敛切角尺寸，更精密 */
    
    padding: 12px 16px;
    margin-bottom: 12px;
    position: relative;
    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); /* 废除弹跳，使用干脆的战术缓动 */
    
    /* 强制撑满父容器 */
    width: 100%;
    box-sizing: border-box;
    display: block;
}

/* 2. 悬停交互：克制的亮起，废除位移与浮夸阴影 */
.ai-card:hover {
    background: rgba(255, 255, 255, 0.02);
    border-left-color: #38BDF8; /* 悬停触发终端信号蓝 */
    border-color: rgba(255, 255, 255, 0.15);
    box-shadow: none; /* 彻底废除硬阴影 */
    transform: none; /* 废除位移动画 */
}

/* 3. 标题区域：高精度对齐、冷峻大写 */
.ai-head {
    font-family: var(--font-ui), sans-serif; /* 统一终端系统字体 */
    font-size: 13px;
    color: #FFFFFF; /* 纯白高亮标题 */
    font-weight: 700;
    letter-spacing: 0.1em;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08); /* 极细分割线 */
    padding-bottom: 8px;
    text-transform: uppercase;
}

/* 4. 图标动画：改为冷色调的微弱闪烁 */
.ai-pulse {
    color: #38BDF8; /* 终端信号蓝 */
    margin-right: 8px;
    font-size: 12px;
    animation: data-stream 2s ease-in-out infinite; /* 沿用深层数据的微弱呼吸 */
}

/* 5. 内容文本：等宽、高辨识度灰银 */
.ai-text {
    font-family: var(--font-mono); /* 严格等宽 */
    font-size: 12px; /* 压缩字号，提升数据密度 */
    line-height: 1.5;
    color: #94A3B8; /* 降低内容对比度，不抢核心数据焦点 */
    font-weight: 500;
}

/* 6. 数据胶囊：低饱和度透光效果，硬切直角 */
.ai-tag {
    display: inline-block;
    background: rgba(255, 255, 255, 0.05);
    color: #94A3B8;
    padding: 2px 8px;
    font-size: 10px;
    font-weight: 600;
    border-radius: 0; /* 废除微圆角，保持工业切割 */
    margin-right: 6px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-family: var(--font-mono);
}

/* 警告级别标签 - 强提示覆盖 */
.ai-level-critical { 
    background: rgba(225, 29, 72, 0.1); 
    color: #E11D48; 
    border-color: rgba(225, 29, 72, 0.3); 
}

/* 7. 装饰性背景纹理：降噪，融入深空背景 */
.ai-card::before {
    content: "///";
    position: absolute;
    right: 8px;
    bottom: 2px;
    font-size: 16px;
    font-family: var(--font-mono);
    font-weight: 900;
    color: rgba(255, 255, 255, 0.04); /* 极低不透明度，不干扰正文 */
    pointer-events: none;
    letter-spacing: 2px;
}
</style>

<style>
/* ═════════════════════════════════════════════════════════════════════
   PART 24: KANBAN BOARD ARCHITECTURE (GOTHAM PROTOCOL) - INJECTED VIA HTML
   ═════════════════════════════════════════════════════════════════════ */
.kanban-board-wrapper {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 180px);
  overflow: hidden;
}

.kanban-controls {
  margin-bottom: 10px;
  display: flex;
  justify-content: flex-end;
}

.kanban-board {
  display: flex;
  gap: 16px;
  height: 100%;
  overflow-x: auto;
  padding-bottom: 10px;
  scroll-behavior: smooth;
  scroll-snap-type: x mandatory;
}

.kanban-column {
  flex: 1;
  min-width: 320px;
  max-width: 450px;
  display: flex;
  flex-direction: column;
  background: rgba(255, 255, 255, 0.02); /* 极低阻抗深色基底 */
  border: 1px solid rgba(255, 255, 255, 0.08); /* 锐利边缘 */
  border-top: 2px solid #475569; /* 默认顶部色条缩窄加硬 */
  border-radius: 0; /* 废除圆角 */
  scroll-snap-align: center;
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* 列状态色定义 (深空信号源) */
.col-todo { 
  border-top-color: #475569; 
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.03) 0%, transparent 100%); 
}
.col-active { 
  border-top-color: #38BDF8; /* 终端信号蓝 */
  background: linear-gradient(180deg, rgba(56, 189, 248, 0.05) 0%, transparent 100%); 
}
.col-done { 
  border-top-color: #10B981; /* 安全绿 */
  background: linear-gradient(180deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%); 
}
.col-cancelled { 
  border-top-color: #94A3B8; 
  opacity: 0.6; 
  background: rgba(255, 255, 255, 0.02); 
}

.kanban-header {
  padding: 12px 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: var(--font-ui);
  font-weight: 700;
  font-size: 13px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: #E2E8F0;
  background: transparent;
  flex-shrink: 0;
}

.kanban-count {
  background: rgba(255, 255, 255, 0.05);
  padding: 2px 8px;
  border-radius: 0; /* 废除胶囊圆角 */
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 11px;
  color: #94A3B8;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.kanban-body {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.kanban-body .jira-card {
  margin-bottom: 0;
  border-left-width: 3px; /* 匹配 jira-card 的硬切线宽度 */
}

@media (max-width: 768px) {
  .kanban-board {
    padding-right: 20px;
  }
  .kanban-column {
    min-width: 85vw;
  }
}
</style>

<style>
/* ═════════════════════════════════════════════════════════════════════
   PART 25: VISUAL ENHANCEMENT (HUD & RESOURCES FIX - GOTHAM PROTOCOL)
   ═════════════════════════════════════════════════════════════════════ */

/* 1. 修复 System Resources (强制 5 行垂直排列) */
.resource-list-vertical {
    display: flex;
    flex-direction: column;
    gap: 16px; 
}

.resource-item {
    margin: 0; 
}

.resource-bar-container {
    height: 4px; /* 压薄至 4px，体现战术精密度 */
    background: rgba(255, 255, 255, 0.05); /* 深空透贴底色 */
    border: 1px solid rgba(255, 255, 255, 0.08); /* 极细切割边框 */
    border-radius: 0; /* 绝对废除圆角 */
    overflow: hidden;
    margin-top: 6px;
    box-shadow: none; /* 彻底废除立体阴影 */
}

  @keyframes progress-stripes {
    from { background-position: 1rem 0; }
    to { background-position: 0 0; }
}

/* 2. Process Intelligence HUD (情报面板重构) */
.monitoring-panel {
    border: 1px solid rgba(255, 255, 255, 0.08); /* 硬切割边界 */
    background: #12151C; /* 深空数据板底色 (var(--bg-surface)) */
    box-shadow: none;
}

.hud-grid {
    display: grid;
    grid-template-columns: 140px 1fr 280px; /* 左仪表 | 中数据 | 右终端 */
    gap: 24px;
    align-items: stretch;
}

/* 左侧：仪表盘区域 */
.hud-gauge-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-right: 1px solid rgba(255, 255, 255, 0.08); /* 废除虚线，改用高精度实线 */
    padding-right: 20px;
}

/* 中间：核心指标 (卡片化) */
.hud-metrics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    align-content: start;
}

.hud-metric-card {
    background: rgba(255, 255, 255, 0.02); /* 极低阻抗底色 */
    border: 1px solid rgba(255, 255, 255, 0.04);
    border-left: 2px solid #475569; /* 战术侧边锚点（静默灰） */
    padding: 12px 16px;
    border-radius: 0;
    text-align: left; /* 战术UI通常采用左对齐以提升扫描效率，废除居中 */
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.hud-metric-card:hover {
    background: rgba(255, 255, 255, 0.05);
    box-shadow: none; /* 拒绝浮夸阴影 */
    transform: none; /* 拒绝弹跳位移 */
    border-color: rgba(255, 255, 255, 0.15);
    border-left-color: #38BDF8; /* 悬停激活终端信号蓝 */
}

.hud-label {
    font-family: var(--font-mono); /* 强制等宽字体 */
    font-size: 10px;
    color: #94A3B8; /* 降噪暗灰 */
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 4px;
}

.hud-value {
    font-size: 24px;
    font-family: var(--font-ui); /* 维持主界面字体 */
    font-weight: 700;
    color: #E2E8F0; /* 高对比度主文字 */
    margin-top: 0;
    font-variant-numeric: tabular-nums; /* 核心：数字强制等宽对齐，防止跳动 */
}

<style>
/* ═════════════════════════════════════════════════════════════════════
   PART 26 & 27: TACTICAL CONTROLS (GOTHAM PROTOCOL & TERMINAL REVISION)
   ═════════════════════════════════════════════════════════════════════ */

/* 看板宽度铺开 - [保留原有逻辑] */
.kanban-board-wrapper {
    flex: 1; 
    width: 100%; 
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.kanban-board {
    display: flex;
    gap: 16px;
    height: 100%;
    width: 100%; 
    overflow-x: auto;
    padding-bottom: 10px;
}

.kanban-column {
    flex: 1 0 300px; 
    max-width: none; 
    display: flex;
    flex-direction: column;
}
  
/* 容器：防止子元素溢出 */
.tactical-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-right: 15px;
    padding-right: 15px;
    border-right: 1px solid rgba(255, 255, 255, 0.08); /* 战术分割线 */
    height: 32px; 
}

/* --- 1. 搜索框修复 (暗黑战术重构) --- */
.tactical-search {
    position: relative;
    width: 160px; 
    height: 100%;
    transition: width 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.tactical-search:focus-within {
    width: 240px; 
}

.tactical-search i {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #94A3B8; /* 战术辅助灰 */
    font-size: 12px;
    z-index: 2;
    pointer-events: none;
    transition: color 0.2s;
}

.tactical-search:focus-within i {
    color: #38BDF8; /* 聚焦时图标亮起蓝光 */
}

.tactical-search input {
    width: 100%;
    height: 100%;
    padding: 0 10px 0 30px; 
    background: #090B10; /* 深空黑底色 */
    border: 1px solid rgba(255, 255, 255, 0.15); /* 极细白边框 */
    color: #E2E8F0;      /* 高对比白字 */
    border-radius: 0;    /* 强制直角 */
    font-size: 12px;
    font-family: var(--font-mono), sans-serif;
    outline: none;
    box-sizing: border-box; 
    transition: all 0.2s;
}

.tactical-search input:focus {
    border-color: #38BDF8;
    box-shadow: inset 0 0 0 1px #38BDF8; /* 内发光替代外阴影 */
}

.tactical-search input::placeholder {
    color: #475569; /* 降噪占位符 */
}

/* --- 2. 下拉菜单修复 (暗黑战术重构) --- */
.tactical-select {
    height: 100%;
    padding: 0 30px 0 10px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background-color: #090B10 !important;
    /* 注入重新编码的浅色箭头 (fill="#E2E8F0") */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23E2E8F0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 10px;
    border-radius: 0;
    font-size: 12px;
    color: #E2E8F0 !important; 
    font-weight: 600;
    font-family: var(--font-mono);
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    min-width: 120px;
    outline: none;
    transition: all 0.2s;
}

.tactical-select:focus {
    border-color: #38BDF8;
    box-shadow: inset 0 0 0 1px #38BDF8;
}

/* 覆盖之前可能遗留的强制白底代码 */
.section-tag {
    color: #38BDF8 !important;
    background: rgba(56, 189, 248, 0.05) !important;
    border: 1px solid rgba(56, 189, 248, 0.2) !important;
}
  
/* ═════════════════════════════════════════════════════════════════════
   TERMINAL STYLE REVISION (GOTHAM PROTOCOL)
   ═════════════════════════════════════════════════════════════════════ */

.hud-terminal {
    background: #000000; /* 绝对纯黑，终端的深渊感 */
    color: #E2E8F0;      
    font-family: var(--font-mono), "Consolas", monospace; 
    padding: 12px 16px;
    border-radius: 0;
    height: 100%;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    font-size: 12px; 
    border: 1px solid rgba(255, 255, 255, 0.08); 
    box-shadow: none; /* 剔除立体发光 */
}

.terminal-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.15); 
    padding-bottom: 8px;
    margin-bottom: 12px;
    color: #94A3B8;
    font-weight: 700;
    font-size: 11px;
    display: flex;
    justify-content: space-between;
    letter-spacing: 0.1em;
    text-transform: uppercase;
}

.terminal-body {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 6px; 
}

.term-line {
    display: flex;
    gap: 12px; 
    align-items: baseline;
}

.term-time { 
    color: #475569; /* 降低时间戳的干扰 */
    font-size: 11px;
    min-width: 55px; 
    font-variant-numeric: tabular-nums;
}

.term-cmd { 
    color: #FFFFFF; 
    font-weight: 700; 
    text-shadow: none; /* 废除发光，保持硬朗 */
}

.term-msg { 
    color: #94A3B8; 
}

/* 告警状态：使用规范色，剔除刺眼的纯黄/纯红 */
.term-line.warning .term-msg { color: #F59E0B; font-weight: 600; } 
.term-line.critical .term-msg { color: #E11D48; font-weight: 600; } 

/* 滚动条美化 */
.terminal-body::-webkit-scrollbar {
    width: 4px; /* 压薄滚动条 */
}
.terminal-body::-webkit-scrollbar-track {
    background: #090B10;
}
.terminal-body::-webkit-scrollbar-thumb {
    background: #475569;
    border-radius: 0;
}

/* 响应式调整 */
@media (max-width: 1100px) {
    .hud-grid {
        grid-template-columns: 1fr; 
        gap: 16px;
    }
    .hud-gauge-section {
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08); /* 虚线改实线 */
        padding-bottom: 16px;
        padding-right: 0;
        flex-direction: row; 
        gap: 20px;
    }
    .hud-terminal {
        min-height: 150px;
    }
}  
  /* ═════════════════════════════════════════════════════════════════════
   PART 28: RESTORE DYNAMIC FEEL (SMOOTH PULSE & GLOW)
   ═════════════════════════════════════════════════════════════════════ */

/* 1. 定义柔和的呼吸动画 (不再是剧烈的闪烁) */
@keyframes soft-pulse {
    0% { opacity: 1; text-shadow: 0 0 5px #4cd964; }
    50% { opacity: 0.4; text-shadow: 0 0 2px #4cd964; }
    100% { opacity: 1; text-shadow: 0 0 5px #4cd964; }
}

/* 2. 应用到 LIVE 指示器 */
.terminal-header .live-static {
    color: #4cd964 !important; /* 鲜艳的终端绿 */
    font-weight: 900;
    animation: soft-pulse 3s infinite ease-in-out; /* 3秒一次，非常平滑 */
    display: inline-block;
}

/* 3. 增强终端文字的“荧光感” (CRT 风格) */
.hud-terminal {
    /* 给整个黑底加上微弱的绿色泛光 */
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 50, 0, 0.1); 
    border: 1px solid #333;
}

.term-cmd {
    /* 命令部分加亮显示 */
    color: #fff;
    text-shadow: 0 0 3px rgba(255, 255, 255, 0.5);
}

.term-time {
    /* 时间戳微弱发光 */
    color: #888;
}

/* 4. 让滚动条看起来更像系统原生 */
.terminal-body::-webkit-scrollbar-thumb {
    background: #333;
    border: 1px solid #000;
}
</style>

<style>
/* ═════════════════════════════════════════════════════════════════════
   PART 99: ULTIMATE FIXES (V5.0)
   ═════════════════════════════════════════════════════════════════════ */

/* 1. 消除“黑框”/系统提示条 */
/* 隐藏所有 ServiceNow 原生的消息容器 */
.alert, 
.alert-info, 
.alert-success, 
.alert-warning,
.alert-danger,
.outputmsg_div, 
.outputmsg_container,
.notification-container,
.system-message-container,
#ui_notification {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    opacity: 0 !important;
    pointer-events: none !important;
}

/* 2. 修复任务数(Load)溢出问题 */
.dr-load-display {
    display: flex;
    align-items: flex-end;
    flex-wrap: wrap; /* 关键：允许换行，防止挤出容器 */
    overflow: hidden; /* 超出部分隐藏 */
    max-width: 100%;
}

.big-num {
    font-size: 28px !important; /*稍微调小一点字体 */
    line-height: 1;
    margin-right: 5px;
}

.sub-text {
    font-size: 10px !important;
    white-space: nowrap;
}

/* 3. 确保下拉菜单可见 */
.cap-select {
    width: 100%;
    max-width: 200px;
    background: #fff;
    color: #333;
    border: 1px solid #ccc;
    padding: 6px 10px;
    font-size: 14px;
    font-weight: 700;
    font-family: var(--font-mono);
    border-radius: 2px;
    cursor: pointer;
    appearance: auto;
    -webkit-appearance: auto;
}

.cap-select:focus {
    border-color: #000;
    outline: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.cap-select option {
    background: #fff;
    color: #333;
    padding: 8px;
}
/* ═══════════════════════════════════════════════════════════════
   PART: COMMS CENTER STYLES
   ═══════════════════════════════════════════════════════════════ */

/* --- Broadcast Composer --- */
.broadcast-composer {
    background: #fff;
    border: 1px solid #ddd;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

.broadcast-type-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.broadcast-type-btn {
    flex: 1;
    padding: 10px 16px;
    border: 2px solid #e0e0e0;
    background: #fff;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.broadcast-type-btn:hover { border-color: #999; }

.broadcast-type-btn.active {
    border-color: #000;
    background: #000;
    color: #fff;
}

.broadcast-type-btn:first-child.active {
    background: #cf222e;
    border-color: #cf222e;
}

.broadcast-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.broadcast-title-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #ddd;
    font-size: 16px;
    font-weight: 700;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.broadcast-title-input:focus { border-color: #000; }

.broadcast-body-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #ddd;
    font-size: 14px;
    resize: vertical;
    min-height: 80px;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.broadcast-body-input:focus { border-color: #000; }

.broadcast-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.broadcast-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: #999;
}

.broadcast-type-label {
    padding: 3px 8px;
    font-weight: 700;
    font-size: 11px;
    border-radius: 2px;
}

.broadcast-type-label.type-emergency { background: rgba(207,34,46,0.1); color: #cf222e; }
.broadcast-type-label.type-announcement { background: rgba(210,153,34,0.1); color: #d29922; }
.broadcast-type-label.type-internal { background: rgba(0,0,0,0.05); color: #666; }

.broadcast-send-btn {
    padding: 10px 24px;
    background: #e0e0e0;
    color: #999;
    border: none;
    font-weight: 800;
    font-size: 13px;
    letter-spacing: 1px;
    cursor: not-allowed;
    transition: all 0.2s;
}

.broadcast-send-btn.ready {
    background: #000;
    color: #fff;
    cursor: pointer;
}

.broadcast-send-btn.ready:hover {
    background: #333;
    transform: translateY(-1px);
}

/* --- Timeline --- */
.comms-timeline {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 600px;
    overflow-y: auto;
    padding-right: 8px;
}

.comm-item {
    background: #fff;
    border: 1px solid #e0e0e0;
    display: flex;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
}

.comm-item:hover {
    border-color: #999;
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.comm-priority-bar {
    width: 4px;
    flex-shrink: 0;
    background: #e0e0e0;
}

.comm-priority-bar.bar-emergency { background: #cf222e; }
.comm-priority-bar.bar-announcement { background: #d29922; }
.comm-priority-bar.bar-internal { background: #999; }

.comm-content {
    flex: 1;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.comm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comm-type-badge {
    font-size: 11px;
    font-weight: 800;
    padding: 2px 8px;
    border-radius: 2px;
    letter-spacing: 1px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.comm-type-badge.badge-emergency { background: rgba(207,34,46,0.1); color: #cf222e; }
.comm-type-badge.badge-announcement { background: rgba(210,153,34,0.1); color: #d29922; }
.comm-type-badge.badge-internal { background: rgba(0,0,0,0.05); color: #666; }

.comm-time { font-size: 11px; color: #999; }
.comm-title { font-weight: 800; font-size: 16px; color: #1a1a1a; }
.comm-body-preview { font-size: 13px; color: #666; line-height: 1.5; }

.comm-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #999;
    padding-top: 8px;
    border-top: 1px dashed #eee;
}

.comm-author { font-weight: 600; }

/* --- Detail Overlay --- */
.comm-detail-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 3000;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.comm-detail-panel {
    background: #fff;
    width: 100%;
    max-width: 640px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    position: relative;
}

.comm-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comm-detail-body {
    font-size: 15px;
    line-height: 1.8;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

/* --- Filter Button Active State --- */
.btn-jira.active {
    background: #000 !important;
    color: #fff !important;
    border-color: #000 !important;
}
  /* --- Delete Confirm Modal --- */
.delete-confirm-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 4000;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.15s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.delete-confirm-panel {
    background: #fff;
    width: 420px;
    max-width: 90vw;
    padding: 32px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.2s ease;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.delete-confirm-icon {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: rgba(207,34,46,0.1);
    color: #cf222e;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.delete-confirm-title {
    font-size: 18px;
    font-weight: 800;
    margin: 0 0 16px;
    color: #1a1a1a;
}

.delete-confirm-msg-info {
    background: #f8f8f8;
    padding: 12px 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    font-size: 14px;
}

.delete-confirm-warning {
    font-size: 12px;
    color: #999;
    margin-bottom: 24px;
}

.delete-confirm-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.delete-btn-cancel {
    padding: 10px 28px;
    background: #f0f0f0;
    border: 1px solid #ddd;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.delete-btn-cancel:hover {
    background: #e0e0e0;
}

.delete-btn-confirm {
    padding: 10px 28px;
    background: #cf222e;
    color: #fff;
    border: none;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.delete-btn-confirm:hover {
    background: #a71d2a;
    transform: translateY(-1px);
}

  /* --- 修复：干员列表卡片与弹窗的 LOAD 进度条样式 --- */
.stat-row {
    display: flex;
    align-items: center;
    width: 100%;
    margin-top: 8px;
    font-size: 11px;
    font-weight: 700;
    color: #666;
}

.stat-bar-track, .dossier-bar-track {
    flex-grow: 1;
    width: 100%;
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
}

.stat-bar-track {
    margin-left: 10px; /* 与左侧 LOAD 文字拉开间距 */
}

.dossier-bar-track {
    margin-top: 10px; /* 弹窗内的进度条间距 */
}

.stat-bar-fill, .dossier-bar-fill {
    height: 100%;
    background: #1a1a1a; /* 默认黑色填充 */
    border-radius: 3px;
    transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.stat-bar-fill.alert, .dossier-bar-fill.alert {
    background: #cf222e !important; /* 当任务数 >= 3 时，进度条变为红色警告 */
}
  /* ==========================================
   PART 30: Accessibility [V8]
   ========================================== */

/* --- スキップリンク --- */
.skip-link {
  position: absolute;
  top: -100px;
  left: 16px;
  z-index: 9999999;
  padding: 8px 16px;
  background: #1a1a2e;
  color: #fff;
  font-size: 14px;
  font-weight: 700;
  border-radius: 0 0 6px 6px;
  text-decoration: none;
  transition: top 0.2s;
}
.skip-link:focus {
  top: 0;
  outline: 3px solid #ffab00;
  outline-offset: 2px;
}

/* --- sr-only (スクリーンリーダー専用) --- */
.sr-only {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0, 0, 0, 0) !important;
  white-space: nowrap !important;
  border: 0 !important;
}

/* --- フォーカスインジケーター --- */
/* 全てのインタラクティブ要素に統一的なフォーカスリング */
.kanban-card:focus,
.vol-tab:focus,
.batch-btn:focus,
.modal-close-btn:focus,
button:focus,
a:focus,
select:focus,
input:focus,
textarea:focus {
  outline: 3px solid #ffab00 !important;
  outline-offset: 2px !important;
}

/* フォーカスが :focus-visible のみ（マウスクリック時は非表示） */
.kanban-card:focus:not(:focus-visible),
.vol-tab:focus:not(:focus-visible),
button:focus:not(:focus-visible),
a:focus:not(:focus-visible),
select:focus:not(:focus-visible) {
  outline: none !important;
}
.kanban-card:focus-visible,
.vol-tab:focus-visible,
button:focus-visible,
a:focus-visible,
select:focus-visible {
  outline: 3px solid #ffab00 !important;
  outline-offset: 2px !important;
}

/* --- コントラスト補正 (4.5:1 以上) --- */

/* 看板ヘッダーテキスト: #555 on #fafafa = 5.9:1 ✅ */

/* 看板カウント数字 */
.kanban-col-inprogress .kanban-count {
  color: #bf360c; /* #e65100 → #bf360c (on #fff3e0: 4.8:1) */
}

/* urgency ラベル */
.urgency-medium {
  color: #0d47a1; /* #1565c0 → #0d47a1 (on #e3f2fd: 7.5:1) */
}
.urgency-low {
  color: #1b5e20; /* #33691e → #1b5e20 (on #f1f8e9: 7.1:1) */
}

/* 時間テキスト */
.kanban-card-time {
  color: #666 !important; /* #999 → #666 (on #fff: 5.7:1) */
}

/* zone テキスト */
.kanban-card-zone {
  color: #555 !important; /* #777 → #555 (on #fff: 7.4:1) */
}

/* 空列テキスト */
.kanban-empty {
  color: #767676 !important; /* #bbb → #767676 (on #fafafa: 4.6:1) */
}

/* --- prefers-reduced-motion --- */
@media (prefers-reduced-motion: reduce) {
  .kanban-card,
  .kanban-col,
  .batch-action-bar,
  .toast-container .toast-item {
    transition: none !important;
    animation: none !important;
  }
  .kanban-card.dragging {
    transform: none !important;
  }
}
  
/* --- prefers-color-scheme: dark 準備 --- */
/* 将来のダークモード対応用プレースホルダー */
/* @media (prefers-color-scheme: dark) { ... } */

</style>
<!-- ============================================================
     主容器 — 单一顶层包裹 (FIX 1: 移除重复嵌套容器)
     ============================================================ -->
<div class="kokoro-volunteer-container">
<a class="skip-link" href="#main-content">メインコンテンツへスキップ</a>
<a class="skip-link" href="#tactical-board">タクティカルボードへスキップ</a>
  
<!-- Toast 通知コンテナ -->
<div class="toast-container" aria-live="polite" aria-atomic="true">
  <div ng-repeat="toast in c.toasts track by toast.id" 
       class="vol-toast" 
       ng-class="{'toast-success': toast.type==='success', 'toast-error': toast.type==='error', 'toast-warning': toast.type==='warning', 'toast-info': toast.type==='info', 'toast-exit': !toast.visible}"
       ng-click="c.dismissToast(toast)"
       role="alert">
    <span class="toast-icon">
      <i ng-if="toast.type==='success'" class="fa fa-check-circle"></i>
      <i ng-if="toast.type==='error'" class="fa fa-exclamation-circle"></i>
      <i ng-if="toast.type==='warning'" class="fa fa-exclamation-triangle"></i>
      <i ng-if="toast.type==='info'" class="fa fa-info-circle"></i>
    </span>
    <span class="toast-message">{{toast.message}}</span>
    <span class="toast-close"><i class="fa fa-times"></i></span>
  </div>
</div>


    

    <!-- 命令头 -->
    <div class="command-header">
        <button class="hamburger-btn" ng-click="c.toggleSidebar()">
            <i class="fa fa-bars"></i>
        </button>
        <div class="command-logo">
            <div class="logo-icon">K</div>
            <div class="logo-text">
                <span class="logo-title">KOKORO</span>
                <span class="logo-subtitle">VOLUNTEER_INTERFACE</span>
            </div>
        </div>
        <div class="system-status">
            <div class="status-indicator">              
              <span class="sys-status" ng-class="{'sys-offline': !c.isOnline}">
  <span class="sys-status-dot" ng-class="{'offline': !c.isOnline}"></span>
  {{c.isOnline ? 'SYS_ONLINE' : 'OFFLINE'}}
</span>
<span class="offline-queue-badge" ng-if="c.offlineQueueCount > 0"
      ng-click="c.retryOfflineQueue()"
      title="{{c.offlineQueueCount}}件の操作がキュー待ち（クリックで再送）">
  <i class="fa fa-cloud-upload" aria-hidden="true"></i> {{c.offlineQueueCount}}
</span>

            </div>
            <span class="version-tag">v4.1.0-zenless</span>
            <span class="system-time">{{c.currentTime}}</span>
        </div>
    </div>

    <!-- 导航标签 -->
    <div class="nav-tabs-custom" role="tablist" aria-label="メインナビゲーション">
        <button class="tab" role="tab"
                id="tab-dashboard"
                aria-selected="{{c.view === 'dashboard'}}"
                aria-controls="panel-dashboard"
                ng-class="{'active': c.view === 'dashboard'}" 
                ng-click="c.view = 'dashboard'"
                tabindex="{{c.view === 'dashboard' ? '0' : '-1'}}">
            <span class="tab-number">01</span> / OVERVIEW
        </button>
        <button class="tab" role="tab"
                id="tab-tactical"
                aria-selected="{{c.view === 'tactical'}}"
                aria-controls="panel-tactical"
                ng-class="{'active': c.view === 'tactical'}" 
                ng-click="c.view = 'tactical'"
                tabindex="{{c.view === 'tactical' ? '0' : '-1'}}">
            <span class="tab-number">02</span> / TACTICAL
        </button>
        <button class="tab" role="tab"
                id="tab-mine"
                aria-selected="{{c.view === 'mine'}}"
                aria-controls="panel-mine"
                ng-class="{'active': c.view === 'mine'}" 
                ng-click="c.view = 'mine'"
                tabindex="{{c.view === 'mine' ? '0' : '-1'}}">
            <span class="tab-number">03</span> / OPERATORS ({{c.data.volunteers.length || 0}})
        </button>
        <button class="tab" role="tab"
                id="tab-comms"
                aria-selected="{{c.view === 'comms'}}"
                aria-controls="panel-comms"
                ng-class="{'active': c.view === 'comms'}" 
                ng-click="c.view = 'comms'"
                tabindex="{{c.view === 'comms' ? '0' : '-1'}}">
            <span class="tab-number">04</span> / COMMS ({{c.data.announcements.length || 0}})
        </button>
    </div>
    
  
  <div class="board-container">
      
        <div class="view-dashboard" ng-if="c.view === 'dashboard'" role="tabpanel" id="panel-dashboard" aria-labelledby="tab-dashboard" style="height:100%; display:flex; flex-direction:column;">

           <div class="cad-status-strip" ng-if="c.view === 'dashboard'">
    <!-- 左侧：指标 -->
    <div class="cad-strip-item">
        <span class="cad-strip-dot" ng-class="{'red': c.data.overallHealth.score < 70, 'amber': c.data.overallHealth.score >= 70 && c.data.overallHealth.score < 90, 'green': c.data.overallHealth.score >= 90}"></span>
        <span class="cad-strip-label">HEALTH</span>
        <span class="cad-strip-value" ng-class="{'critical': c.data.overallHealth.score < 70, 'warning': c.data.overallHealth.score >= 70 && c.data.overallHealth.score < 90, 'nominal': c.data.overallHealth.score >= 90}">{{c.data.overallHealth.score}}</span>
    </div>
    <div class="cad-strip-item clickable" ng-click="c.filterByUrgency('Critical')">
        <span class="cad-strip-dot red" ng-if="c.data.sosCount > 0"></span>
        <span class="cad-strip-label">SOS</span>
        <span class="cad-strip-value" ng-class="{'critical': c.data.sosCount > 0}">{{c.data.sosCount || 0}}</span>
    </div>
    <div class="cad-strip-item">
        <span class="cad-strip-label">OPEN</span>
        <span class="cad-strip-value" ng-class="{'warning': c.data.openCount > 5}">{{c.data.openCount || 0}}</span>
    </div>
    <div class="cad-strip-item">
        <span class="cad-strip-label">TOTAL</span>
        <span class="cad-strip-value info">{{c.data.list.length || 0}}</span>
    </div>
    <div class="cad-strip-item">
        <span class="cad-strip-label">OPR</span>
        <span class="cad-strip-value nominal">{{c.data.volunteers.length || 0}}</span>
    </div>
    <div class="cad-strip-item" ng-if="c.data.slaStats.breached > 0">
        <span class="cad-strip-dot red"></span>
        <span class="cad-strip-label">SLA</span>
        <span class="cad-strip-value critical">{{c.data.slaStats.breached}}</span>
    </div>
    
    <!-- 分隔线 -->
    <div class="cad-strip-divider"></div>
    
    <!-- 右侧：操作员控制（原 volunteer-status-panel 的内容） -->
    <div class="cad-strip-item" ng-if="c.data.isVolunteer">
        <button ng-click="c.toggleAvailability()" 
                ng-class="{'btn-online': c.volunteerStatus.isOnline, 'btn-offline': !c.volunteerStatus.isOnline}"
                style="padding:2px 10px; font-size:10px; border-radius:3px;">
            {{c.volunteerStatus.isOnline ? 'ONLINE' : 'OFFLINE'}}
        </button>
    </div>
    <div class="cad-strip-item" ng-if="c.data.isVolunteer">
        <select ng-model="c.currentZone"
                ng-change="c.onZoneChange()"
                aria-label="現在地を選択"
                class="zone-select"
                style="padding:2px 8px; font-size:10px; max-width:140px;">
            <option value="">— 現在地 —</option>
            <option value="FAMILY_AREA">ファミリー</option>
            <option value="SINGLE_AREA">単身</option>
            <option value="MEDICAL_AREA">医療</option>
            <option value="STAFF_ROOM">スタッフ</option>
            <option value="FIELD">フィールド</option>
            <option value="HQ">本部</option>
        </select>
    </div>
</div>

            <!-- Three-Panel Dispatch Grid -->
            <div class="cad-dispatch-grid" id="main-content" style="flex:1; overflow:hidden;">

                <!-- LEFT: Alert Feed / Priority Queue -->
                <div class="cad-panel-left">
                    <div class="cad-panel-header">
                        <div class="cad-panel-title"><i class="fa fa-bolt"></i> PRIORITY_QUEUE</div>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span class="cad-panel-badge" ng-class="{'alert': c.data.sosCount > 0}">
                                {{c.data.openCount || c.data.list.length}} ACTIVE
                            </span>
                            <span class="cad-live-dot"></span>
                        </div>
                    </div>
                    <div class="cad-panel-body">
                        <div class="cad-alert-item" 
                             ng-repeat="item in c.data.list | orderBy:['-urgency', 'created_on'] track by item.sys_id"
                             ng-if="item.state != 4 && item.state != 5"
                             ng-click="c.openModal(item)">
                            <div class="cad-alert-priority-bar" 
                                 ng-class="{'p-critical': item.urgency==='Critical', 'p-high': item.urgency==='High', 'p-moderate': item.urgency==='Moderate' || item.urgency==='Medium', 'p-low': item.urgency==='Low'}"></div>
                            <div class="cad-alert-body">
                                <div class="cad-alert-row-top">
                                    <span class="cad-alert-id">{{item.number}}</span>
                                    <span class="cad-alert-urgency" 
                                          ng-class="{'u-critical': item.urgency==='Critical', 'u-high': item.urgency==='High', 'u-moderate': item.urgency==='Moderate' || item.urgency==='Medium', 'u-low': item.urgency==='Low'}">
                                        {{item.urgency === 'Critical' ? 'SOS' : item.urgency}}
                                    </span>
                                </div>
                                <div class="cad-alert-title">{{c.dict[item.category] || item.category}} <span style="opacity:0.5;">x{{item.quantity}}</span></div>
                                <div class="cad-alert-meta">
                                    <span><i class="fa fa-map-marker"></i> {{item.zone}}</span>
                                    <span>{{item.time_ago || item.created_on}}</span>
                                    <span ng-if="item.assigned_to_name"><i class="fa fa-user"></i> {{item.assigned_to_name}}</span>
                                </div>
                                <div class="cad-alert-sla" ng-if="item.sla && !item.sla.is_stopped">
                                    <div class="cad-alert-sla-fill" ng-style="{'width': item.sla.percentage + '%', 'background': c.getSLABarColor(item.sla)}"></div>
                                </div>
                            </div>
                            <div class="cad-alert-arrow"><i class="fa fa-chevron-right"></i></div>
                        </div>
                        <div class="cad-empty-state" ng-if="!c.data.list || c.data.list.length === 0">
                            <i class="fa fa-shield"></i>
                            <span>ALL_CLEAR — 未処理タスクなし</span>
                        </div>
                    </div>
                </div>

                <!-- CENTER: Resources + Intel + Activity -->
                <div class="cad-panel-center">
                    <div class="cad-center-top">
                        <div class="cad-resource-widget">
                            <div class="cad-widget-label"><i class="fa fa-database"></i> RESOURCES</div>
                            <div class="cad-res-item" ng-repeat="res in c.data.resourceStatus track by $index">
                                <span class="cad-res-name">{{res.name || res.category || res.label || (['食料','水','医療','衣類','衛生'][$index] || 'RES')}}</span>
                                <div class="cad-res-bar">
                                    <div class="cad-res-fill" 
                                         ng-class="{'low': res.percent < 30, 'medium': res.percent >= 30 && res.percent < 60, 'high': res.percent >= 60}" 
                                         ng-style="{width: res.percent + '%'}"></div>
                                </div>
                                <span class="cad-res-pct" ng-class="{'low': res.percent < 30}">{{res.percent}}%</span>
                            </div>
                        </div>
                        <div class="cad-intel-widget">
    <div class="cad-widget-label"><i class="fa fa-line-chart"></i> INTELLIGENCE</div>
    <div class="cad-intel-grid" style="display:flex; gap:12px; flex-wrap:wrap;">
        <div class="cad-intel-metric" style="flex:1; min-width:60px;">
            <div class="cad-intel-value">{{c.data.processMiningStats.totalEvents || 0}}</div>
            <div class="cad-intel-label">Events</div>
        </div>
        <div class="cad-intel-metric" style="flex:1; min-width:60px;">
            <div class="cad-intel-value">{{c.data.processMiningStats.uniqueCases || 0}}</div>
            <div class="cad-intel-label">Cases</div>
        </div>
        <div class="cad-intel-metric" style="flex:1; min-width:60px;">
            <div class="cad-intel-value" ng-style="{'color': c.data.slaStats.breached > 0 ? '#E11D48' : ''}">{{c.data.slaStats.breached || 0}}</div>
            <div class="cad-intel-label">Breaches</div>
        </div>
        <div class="cad-intel-metric" style="flex:1; min-width:60px;">
            <div class="cad-intel-value">{{c.data.processMiningStats.avgDuration || '—'}}</div>
            <div class="cad-intel-label">Avg Response</div>
        </div>
        <div class="cad-intel-metric" style="flex:1; min-width:60px;">
            <div class="cad-intel-value">{{c.data.processMiningStats.todayEvents || 0}}</div>
            <div class="cad-intel-label">Today</div>
        </div>
    </div>
</div>
                    </div>
                    <div class="cad-center-terminal">
                        <div class="cad-terminal-header">
                            <div class="cad-terminal-title"><i class="fa fa-terminal"></i> ACTIVITY_STREAM</div>
                            <span class="cad-terminal-live">● LIVE</span>
                        </div>
                        <div class="cad-terminal-body">
                            <div class="cad-term-line cad-crit" ng-if="c.data.slaStats.breached > 0">
                                <span class="cad-term-time">[ALERT]</span>
                                <span class="cad-term-user">SYSTEM</span>
                                <span class="cad-term-action">SLA BREACH DETECTED: {{c.data.slaStats.breached}} count</span>
                            </div>
                            <div class="cad-term-line" ng-repeat="audit in c.data.auditStats.recentActions | limitTo:12">
                                <span class="cad-term-time">{{audit.time.split(' ')[1] || '--:--'}}</span>
                                <span class="cad-term-user">{{audit.user}}</span>
                                <span class="cad-term-action">{{audit.action}}</span>
                            </div>
                            <div class="cad-term-line" ng-if="(!c.data.auditStats.recentActions || c.data.auditStats.recentActions.length === 0)">
                                <span class="cad-term-time">--:--</span>
                                <span class="cad-term-action" style="color:var(--text-tertiary);">Waiting for activity...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Operator Roster -->
                <div class="cad-panel-right">
                    <div class="cad-panel-header">
                        <div class="cad-panel-title"><i class="fa fa-users"></i> OPERATORS</div>
                        <span class="cad-panel-badge">{{c.data.volunteers.length || 0}}</span>
                    </div>
                    <div class="cad-deploy-summary">
                        <div class="cad-deploy-stat">
                            <div class="cad-deploy-num green">{{c.getOnlineCount()}}</div>
                            <div class="cad-deploy-label">ONLINE</div>
                        </div>
                        <div class="cad-deploy-stat">
                            <div class="cad-deploy-num amber">{{c.getBusyCount()}}</div>
                            <div class="cad-deploy-label">ENGAGED</div>
                        </div>
                        <div class="cad-deploy-stat">
                            <div class="cad-deploy-num dim">{{c.getOfflineCount()}}</div>
                            <div class="cad-deploy-label">OFFLINE</div>
                        </div>
                    </div>
                    <div class="cad-panel-body">
                        <div class="cad-operator-item" ng-repeat="vol in c.data.volunteers" ng-click="c.openUserModal(vol)">
                            <div class="cad-op-avatar">
                                {{vol.initial || vol.name.charAt(0)}}
                                <div class="cad-op-status-dot" ng-class="vol.status_class"></div>
                            </div>
                            <div class="cad-op-info">
                                <div class="cad-op-name">{{vol.name}}</div>
                                <div class="cad-op-role">{{vol.capability || 'SUPPORT'}}</div>
                            </div>
                            <div class="cad-op-load">
                                <div class="cad-op-load-bar">
                                    <div class="cad-op-load-fill" 
                                         ng-class="{'high': vol.current_load >= 3, 'medium': vol.current_load === 2}" 
                                         ng-style="{width: (vol.current_load * 20) + '%'}"></div>
                                </div>
                                <div class="cad-op-load-text">{{vol.current_load || 0}} tasks</div>
                            </div>
                        </div>
                      <div class="cad-empty-state" ng-if="!c.data.volunteers || c.data.volunteers.length === 0">
                            <i class="fa fa-user-times"></i>
                            <span>NO_OPERATORS</span>
                        </div> 
                    </div>
                </div>
            </div>
        </div>

        <div id="tactical-board" class="view-tactical" ng-if="c.view === 'tactical'" role="tabpanel" aria-labelledby="tab-tactical" style="height:100%; display:flex; flex-direction:column;">
                            
                      <div class="stats-section" style="margin-bottom: 20px;">
                <div class="section-header">
                    <span class="section-tag">01</span>
                    <span class="section-title">METRICS_OVERVIEW</span>
                    <span class="section-time">{{c.currentTime}}</span>
                </div>
                <div class="stats-row">
                    <div class="stat-card clickable" ng-click="c.filterByUrgency('Critical')">
                        <div class="stat-label"><span class="stat-code">REQ</span><span class="stat-suffix">_01</span></div>
                        <div class="stat-num">{{c.data.sosCount || 0}}</div>
                        <div class="stat-name">CRITICAL_SOS</div>
                        <div class="stat-footer">
                            <span class="stat-status" ng-class="{'critical': c.data.sosCount > 0, 'nominal': c.data.sosCount === 0}">{{c.data.sosCount > 0 ? 'ALERT' : 'NOMINAL'}}</span>
                        </div>
                    </div>
                    <div class="stat-card clickable" ng-click="c.filterByAssignment('unassigned')">
                        <div class="stat-label"><span class="stat-code">OPN</span><span class="stat-suffix">_02</span></div>
                        <div class="stat-num">{{c.data.openCount || 0}}</div>
                        <div class="stat-name">UNASSIGNED</div>
                        <div class="stat-footer">
                            <span class="stat-status" ng-class="{'warning': c.data.openCount > 5, 'nominal': c.data.openCount <= 5}">{{c.data.openCount > 5 ? 'BACKLOG' : 'NOMINAL'}}</span>
                        </div>
                    </div>
                    <div class="stat-card clickable" ng-click="c.clearFilters()">
                        <div class="stat-label"><span class="stat-code">TOT</span><span class="stat-suffix">_03</span></div>
                        <div class="stat-num">{{c.data.list.length || 0}}</div>
                        <div class="stat-name">TOTAL_ACTIVE</div>
                        <div class="stat-footer"><span class="stat-status nominal">TRACKING</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label"><span class="stat-code">OPR</span><span class="stat-suffix">_04</span></div>
                        <div class="stat-num">{{c.data.volunteers.length || '--'}}</div>
                        <div class="stat-name">OPERATORS</div>
                        <div class="stat-footer"><span class="stat-status nominal">ONLINE</span></div>
                    </div>
                </div>
            </div>

            <div class="card-section" ng-if="c.view === 'tactical'" style="height:100%; margin-bottom:0; margin-top:20px;">
                
                <div class="section-header">
                    <span class="section-tag">02</span>
                    <span class="section-title">TACTICAL_BOARD</span>
                  
                  
							<!-- バッチモード切替ボタン -->
							<button class="batch-toggle-btn" 
			        ng-click="c.toggleBatchMode()" 
        ng-class="{'active': c.batchMode}"
        title="一括操作モード">
						  <i class="fa" ng-class="c.batchMode ? 'fa-check-square-o' : 'fa-square-o'"></i>
				  <span ng-if="!c.batchMode">一括選択</span>
		  <span ng-if="c.batchMode">選択中 ({{c.getSelectedCount()}})</span>
					</button>

						<!-- バッチモード時: 全選択ボタン -->
						<button class="batch-select-all-btn" 
			        ng-if="c.batchMode"
			        ng-click="c.selectAll()">
			  <i class="fa fa-check-double"></i> 全選択
							</button>
                    <div class="tactical-controls" style="margin-left: auto;">
                        <div class="tactical-search">
                            <i class="fa fa-search" aria-hidden="true"></i>
                            <label for="tactical-search" class="sr-only">工単を検索</label>
                            <input id="tactical-search" type="text" 
                                   placeholder="SEARCH (ID, LOC, USER)..." 
                                   ng-model="c.tacticalSearchText" 
                                   aria-label="工単を検索"
                                   ng-change="c.organizeKanban()">
                        </div>
                        
                        <select class="tactical-select" 
                                 ng-model="c.tacticalFilterPriority" 
                                 aria-label="優先度でフィルタ"
                                 ng-change="c.organizeKanban()">
                            <option value="">ALL_PRIORITY</option>
                            <option value="Critical">CRITICAL</option>
                            <option value="High">HIGH</option>
                            <option value="Moderate">MODERATE</option>
                            <option value="Low">LOW</option>
                        </select>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center;">
                        <button class="btn-jira" 
                                style="margin:0; padding:6px 12px; font-size:11px; width:auto;"
                                ng-class="{'active': c.showCancelledCol}"
                                ng-click="c.toggleCancelledColumn()">
                            <i class="fa" ng-class="c.showCancelledCol ? 'fa-eye-slash' : 'fa-eye'"></i> 
                            {{c.showCancelledCol ? 'HIDE' : 'SHOW'}}
                        </button>
                        
                        <span class="section-tag" style="background:var(--border-mid); box-shadow:none;">
                            {{(c.kanbanData.todo.length + c.kanbanData.active.length + c.kanbanData.done.length)}} VISIBLE
                        </span>
                    </div>
                </div>
              

               <!-- ★★★ [V5] 4列看板 + ドラッグ＆ドロップ ★★★ -->
<div class="kanban-board-v5">

  <!-- ═══ COL 1: ASSIGNED ═══ -->
  <div class="kanban-col kanban-col-assigned"
       role="region"
       aria-label="ASSIGNED — {{c.kanbanData.assigned.length}} 件"
       ng-class="{'drag-over': c.isDropTarget('assigned')}"
       ondragover="event.preventDefault(); angular.element(this).scope().$apply(function(s){ s.c.onDragOver(event, 'assigned'); });"
       ondragleave="angular.element(this).scope().$apply(function(s){ s.c.onDragLeave('assigned'); });"
       ondrop="angular.element(this).scope().$apply(function(s){ s.c.onDrop(event, 'assigned'); });">
    <div class="kanban-header">
      <span class="kanban-header-icon"><i class="fa fa-inbox"></i></span>
      <span class="kanban-header-title">ASSIGNED</span>
      <span class="kanban-count">{{c.kanbanData.assigned.length}}</span>
    </div>
    <div class="kanban-body">
      <div class="kanban-card"
           role="article"
           tabindex="0"
           aria-label="{{item.number}} — {{item.urgency}} — {{item.assigned_to_name || '未割当'}}"
           ng-keydown="c.onCardKeydown($event, item)"
           ng-repeat="item in c.kanbanData.assigned track by item.sys_id"
           draggable="true"
           ng-class="{'dragging': c.isDragging(item), 'batch-selected': c.selectedItems[item.sys_id], 'urgency-critical': item.urgency==='Critical'}"
           ondragstart="angular.element(this).scope().$apply(function(s){ s.c.onDragStart(s.item); });"
           ondragend="angular.element(this).scope().$apply(function(s){ s.c.onDragEnd(); });"
           ng-click="c.batchMode ? c.toggleSelect(item, $event) : c.openModal(item)">
        <div class="batch-checkbox" ng-if="c.batchMode" ng-click="c.toggleSelect(item, $event)">
          <i class="fa" ng-class="c.selectedItems[item.sys_id] ? 'fa-check-square' : 'fa-square-o'"></i>
        </div>
        <div class="kanban-card-id">{{item.number}}</div>
        <div class="kanban-card-meta">
          <span class="kanban-card-urgency urgency-{{item.urgency | lowercase}}">{{item.urgency}}</span>
          <span class="kanban-card-time">{{item.time_ago || item.created_on}}</span>
        </div>
        <div class="kanban-card-zone" ng-if="item.zone">{{item.zone}}</div>
        <div class="kanban-card-assignee" ng-if="item.assigned_to_name">
          <i class="fa fa-user"></i> {{item.assigned_to_name}}
        </div>
      </div>
      <div class="kanban-empty" ng-if="c.kanbanData.assigned.length === 0">
        <i class="fa fa-check"></i><span>未処理なし</span>
      </div>
    </div>
  </div>

  <!-- ═══ COL 2: IN_PROGRESS ═══ -->
  <div class="kanban-col kanban-col-inprogress"
       role="region"
       aria-label="IN_PROGRESS — {{c.kanbanData.inprogress.length}} 件"
       ng-class="{'drag-over': c.isDropTarget('inprogress')}"
       ondragover="event.preventDefault(); angular.element(this).scope().$apply(function(s){ s.c.onDragOver(event, 'inprogress'); });"
       ondragleave="angular.element(this).scope().$apply(function(s){ s.c.onDragLeave('inprogress'); });"
       ondrop="angular.element(this).scope().$apply(function(s){ s.c.onDrop(event, 'inprogress'); });">
    <div class="kanban-header">
      <span class="kanban-header-icon"><i class="fa fa-bolt"></i></span>
      <span class="kanban-header-title">IN_PROGRESS</span>
      <span class="kanban-count">{{c.kanbanData.inprogress.length}}</span>
    </div>
    <div class="kanban-body">
      <div class="kanban-card"
           role="article"
           tabindex="0"
           aria-label="{{item.number}} — {{item.urgency}} — {{item.assigned_to_name || '未割当'}}"
           ng-keydown="c.onCardKeydown($event, item)"
           ng-repeat="item in c.kanbanData.inprogress track by item.sys_id"
           draggable="true"
           ng-class="{'dragging': c.isDragging(item), 'batch-selected': c.selectedItems[item.sys_id], 'urgency-critical': item.urgency==='Critical'}"
           ondragstart="angular.element(this).scope().$apply(function(s){ s.c.onDragStart(s.item); });"
           ondragend="angular.element(this).scope().$apply(function(s){ s.c.onDragEnd(); });"
           ng-click="c.batchMode ? c.toggleSelect(item, $event) : c.openModal(item)">
        <div class="batch-checkbox" ng-if="c.batchMode" ng-click="c.toggleSelect(item, $event)">
          <i class="fa" ng-class="c.selectedItems[item.sys_id] ? 'fa-check-square' : 'fa-square-o'"></i>
        </div>
        <div class="kanban-card-id">{{item.number}}</div>
        <div class="kanban-card-meta">
          <span class="kanban-card-urgency urgency-{{item.urgency | lowercase}}">{{item.urgency}}</span>
          <span class="kanban-card-time">{{item.time_ago || item.created_on}}</span>
        </div>
        <div class="kanban-card-zone" ng-if="item.zone">{{item.zone}}</div>
        <div class="kanban-card-assignee" ng-if="item.assigned_to_name">
          <i class="fa fa-user"></i> {{item.assigned_to_name}}
        </div>
        <div class="kanban-card-sla" ng-if="item.sla && !item.sla.is_stopped">
          <div class="sla-bar"><div class="sla-fill" ng-style="{'width': item.sla.percentage + '%'}"></div></div>
        </div>
      </div>
      <div class="kanban-empty" ng-if="c.kanbanData.inprogress.length === 0">
        <span>ここにドロップして開始</span>
      </div>
    </div>
  </div>

  <!-- ═══ COL 3: ON_HOLD ═══ -->
  <div class="kanban-col kanban-col-onhold"
       role="region"
       aria-label="ON_HOLD — {{c.kanbanData.onhold.length}} 件"
       ng-class="{'drag-over': c.isDropTarget('onhold')}"
       ondragover="event.preventDefault(); angular.element(this).scope().$apply(function(s){ s.c.onDragOver(event, 'onhold'); });"
       ondragleave="angular.element(this).scope().$apply(function(s){ s.c.onDragLeave('onhold'); });"
       ondrop="angular.element(this).scope().$apply(function(s){ s.c.onDrop(event, 'onhold'); });">
    <div class="kanban-header">
      <span class="kanban-header-icon"><i class="fa fa-pause-circle"></i></span>
      <span class="kanban-header-title">ON_HOLD</span>
      <span class="kanban-count">{{c.kanbanData.onhold.length}}</span>
    </div>
    <div class="kanban-body">
      <div class="kanban-card"
           role="article"
           tabindex="0"
           aria-label="{{item.number}} — {{item.urgency}} — {{item.assigned_to_name || '未割当'}}"
           ng-keydown="c.onCardKeydown($event, item)"
           ng-repeat="item in c.kanbanData.onhold track by item.sys_id"
           draggable="true"
           ng-class="{'dragging': c.isDragging(item), 'batch-selected': c.selectedItems[item.sys_id]}"
           ondragstart="angular.element(this).scope().$apply(function(s){ s.c.onDragStart(s.item); });"
           ondragend="angular.element(this).scope().$apply(function(s){ s.c.onDragEnd(); });"
           ng-click="c.batchMode ? c.toggleSelect(item, $event) : c.openModal(item)">
        <div class="batch-checkbox" ng-if="c.batchMode" ng-click="c.toggleSelect(item, $event)">
          <i class="fa" ng-class="c.selectedItems[item.sys_id] ? 'fa-check-square' : 'fa-square-o'"></i>
        </div>
        <div class="kanban-card-id">{{item.number}}</div>
        <div class="kanban-card-meta">
          <span class="kanban-card-urgency urgency-{{item.urgency | lowercase}}">{{item.urgency}}</span>
        </div>
        <div class="kanban-card-assignee" ng-if="item.assigned_to_name">
          <i class="fa fa-user"></i> {{item.assigned_to_name}}
        </div>
      </div>
      <div class="kanban-empty" ng-if="c.kanbanData.onhold.length === 0">
        <span>保留なし</span>
      </div>
    </div>
  </div>

  <!-- ═══ COL 4: COMPLETED ═══ -->
  <div class="kanban-col kanban-col-done"
       role="region"
       aria-label="COMPLETED — {{c.kanbanData.done.length}} 件"
       ng-class="{'drag-over': c.isDropTarget('done')}"
       ondragover="event.preventDefault(); angular.element(this).scope().$apply(function(s){ s.c.onDragOver(event, 'done'); });"
       ondragleave="angular.element(this).scope().$apply(function(s){ s.c.onDragLeave('done'); });"
       ondrop="angular.element(this).scope().$apply(function(s){ s.c.onDrop(event, 'done'); });">
    <div class="kanban-header">
      <span class="kanban-header-icon"><i class="fa fa-trophy"></i></span>
      <span class="kanban-header-title">COMPLETED</span>
      <span class="kanban-count">{{c.kanbanData.done.length}}</span>
    </div>
    <div class="kanban-body">
      <div class="kanban-card kanban-card-done"
           role="article"
           tabindex="0"
           aria-label="{{item.number}} — 完了"
           ng-keydown="c.onCardKeydown($event, item)"
           ng-repeat="item in c.kanbanData.done track by item.sys_id"
           draggable="false"
           ng-click="c.openModal(item)">
        <div class="kanban-card-id">{{item.number}}</div>
        <div class="kanban-card-meta">
          <span class="kanban-card-done-icon"><i class="fa fa-check-circle"></i></span>
          <span class="kanban-card-time">{{item.time_ago || item.created_on}}</span>
        </div>
      </div>
      <div class="kanban-empty" ng-if="c.kanbanData.done.length === 0">
        <span>完了なし</span>
      </div>
    </div>
  </div>

</div>
              </div> </div>
<!-- ★★★ [V5] 看板ここまで ★★★ -->
    
        <!-- END: view-dashboard -->
          
    <div class="view-mine" ng-if="c.view === 'mine'" role="tabpanel" id="panel-mine" aria-labelledby="tab-mine">
    <div class="card-section">
        <div class="section-header">
            <span class="section-tag">03</span>
            <span class="section-title">UNIT_ROSTER // 隊員編成</span>
            <span class="section-tag" style="margin-left:auto; background:var(--bg-tertiary);">
                {{c.data.volunteers.length}} UNITS
            </span>
        </div>

        <div class="roster-grid">
            <div class="tcg-card" 
                 ng-repeat="vol in c.data.volunteers"
                 ng-click="c.openUserModal(vol)">
                
                <div class="tcg-top">
                    <span class="tcg-type">{{vol.capability || 'SUPPORT'}}</span>
                    <div class="tcg-status-dot" ng-class="vol.status_class"></div>
                </div>

                <div class="tcg-image-box">
                    <div class="tcg-avatar" 
                         ng-style="vol.photo ? {'background-image': 'url(' + vol.photo + ')'} : {}">
                        {{vol.photo ? '' : vol.initial}}
                    </div>
                </div>

                <div class="tcg-info">
                    <div class="tcg-name">{{vol.name}}</div>
                    <div class="tcg-id">ID: {{vol.sys_id.substring(vol.sys_id.length-4).toUpperCase()}}</div>
                    
                    <div class="tcg-stats">
                        <div class="stat-row">
                            <span>LOAD</span>
                            <div class="stat-bar-track">
                                <div class="stat-bar-fill" ng-style="{width: (vol.current_load * 20) + '%'}" ng-class="{'alert': vol.current_load >= 3}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="empty-board" ng-if="!c.data.volunteers || c.data.volunteers.length === 0">
            <i class="fa fa-users"></i>
            <h4>NO DATA</h4>
        </div>
    </div>
</div>

<div class="operator-modal-overlay" ng-if="c.showUserModal" ng-click="c.closeUserModal()">
    
    <div class="operator-dossier" ng-click="$event.stopPropagation()">
        
        <div class="dossier-header">
            <div class="dh-title">OPERATOR_DETAIL</div>
            <div class="dh-close" ng-click="c.closeUserModal()"><i class="fa fa-times"></i></div>
        </div>

        <div class="dossier-content">
            <div class="dossier-left">
                <div class="dossier-photo" 
                     ng-style="c.selectedVol.photo ? {'background-image': 'url(' + c.selectedVol.photo + ')'} : {}">
                    {{c.selectedVol.photo ? '' : c.selectedVol.initial}}
                </div>
                <div class="dossier-status-badge" ng-class="c.selectedVol.status_class">
                    {{c.selectedVol.status}}
                </div>
            </div>

            <div class="dossier-right">
                <div class="dr-name">{{c.selectedVol.name}}</div>
                <div class="dr-role">{{c.selectedVol.title}}</div>
                
                <div class="dr-section">
                    <div class="dr-label">CAPABILITY (SPECIALTY)</div>
                   
                  <div class="dr-value-box">
                        <i class="fa fa-bolt"></i> 
                        
                        <span ng-if="!c.data.isAdmin">{{c.selectedVol.capability || 'General Support'}}</span>
                        
                        <select ng-if="c.data.isAdmin" 
        class="cap-select"
        ng-model="c.selectedVol.capability" 
        ng-options="opt for opt in c.data.capOptions"
        ng-change="c.updateCapability()">
    <option value="">-- SELECT --</option>
</select>
                        </div>
                </div>

                <div class="dr-section">
                    <div class="dr-label">CURRENT LOAD</div>
                    <div class="dr-load-display">
                        <span class="big-num">{{c.selectedVol.current_load}}</span>
                        <span class="sub-text">Active Tasks</span>
                    </div>
                     <div class="dossier-bar-track">
                        <div class="dossier-bar-fill" ng-style="{width: (c.selectedVol.current_load * 20) + '%'}"></div>
                    </div>
                </div>

                <div class="dr-section">
                    <div class="dr-label">ASSIGNMENT ZONE</div>
                    <div class="dr-value-text">{{c.selectedVol.zone}}</div>
                </div>

            </div>
        </div>

        <div class="dossier-actions" style="min-height: 10px; padding: 0;">
        </div>
    </div>
</div>
    
    <div class="view-comms" ng-if="c.view === 'comms'" role="tabpanel" id="panel-comms" aria-labelledby="tab-comms">

    <div class="card-section" ng-if="c.data.isVolunteer">
        <div class="section-header">
            <span class="section-tag">BROADCAST</span>
            <span class="section-title">緊急放送 // EMERGENCY_BROADCAST</span>
        </div>
        
        <div class="broadcast-composer">
            <div class="broadcast-type-selector">
                <button class="broadcast-type-btn" ng-class="{'active': c.broadcastType === 'emergency'}" ng-click="c.broadcastType = 'emergency'">
                    <i class="fa fa-exclamation-triangle"></i> 緊急
                </button>
                <button class="broadcast-type-btn" ng-class="{'active': c.broadcastType === 'announcement'}" ng-click="c.broadcastType = 'announcement'">
                    <i class="fa fa-bullhorn"></i> 告知
                </button>
                <button class="broadcast-type-btn" ng-class="{'active': c.broadcastType === 'internal'}" ng-click="c.broadcastType = 'internal'">
                    <i class="fa fa-lock"></i> 内部
                </button>
            </div>
            
            <div class="broadcast-form">
                <input type="text" class="broadcast-title-input" ng-model="c.broadcastTitle" placeholder="件名を入力 (Subject)..." maxlength="200">
                <textarea class="broadcast-body-input" ng-model="c.broadcastBody" placeholder="本文を入力してください (Message body)..." rows="4" maxlength="4000"></textarea>
                <div class="broadcast-actions">
                    <div class="broadcast-meta">
                        <span class="broadcast-sender"><i class="fa fa-user"></i> {{c.data.user_name}}</span>
                        <span class="broadcast-type-label" ng-class="'type-' + c.broadcastType">
                            {{c.broadcastType === 'emergency' ? '緊急放送' : c.broadcastType === 'announcement' ? '一般告知' : '内部連絡'}}
                        </span>
                    </div>
                    <button class="broadcast-send-btn" ng-class="{'ready': c.broadcastTitle && c.broadcastBody && !c._broadcastSending}" ng-disabled="!c.broadcastTitle || !c.broadcastBody || c._broadcastSending" ng-click="c.sendBroadcast()">
                        <i class="fa" ng-class="c._broadcastSending ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
                        {{c._broadcastSending ? 'SENDING...' : 'TRANSMIT'}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="metal-divider-glow" ng-if="c.data.isVolunteer"></div>

    <div class="card-section">
        <div class="section-header">
            <span class="section-tag">FEED</span>
            <span class="section-title">通信ログ // COMM_LOG</span>
            <div style="margin-left:auto; display:flex; gap:10px;">
                <button class="btn-jira" style="margin:0; width:auto; padding:6px 12px; font-size:11px;" ng-class="{'active': !c.commsFilter}" ng-click="c.commsFilter = ''">ALL</button>
                <button class="btn-jira" style="margin:0; width:auto; padding:6px 12px; font-size:11px;" ng-class="{'active': c.commsFilter === 'emergency'}" ng-click="c.commsFilter = 'emergency'"><i class="fa fa-exclamation-triangle"></i> 緊急</button>
                <button class="btn-jira" style="margin:0; width:auto; padding:6px 12px; font-size:11px;" ng-class="{'active': c.commsFilter === 'announcement'}" ng-click="c.commsFilter = 'announcement'"><i class="fa fa-bullhorn"></i> 告知</button>
                <button class="btn-jira" style="margin:0; width:auto; padding:6px 12px; font-size:11px;" ng-class="{'active': c.commsFilter === 'internal'}" ng-click="c.commsFilter = 'internal'" ng-if="c.data.isVolunteer"><i class="fa fa-lock"></i> 内部</button>
            </div>
        </div>

        <div class="comms-timeline">
            <div class="comm-item" ng-class="'comm-' + msg.type" ng-repeat="msg in c.getFilteredComms() track by msg.sys_id" ng-click="c.openCommDetail(msg)">
                
                <div class="comm-priority-bar" ng-class="'bar-' + msg.type"></div>
                
                <div class="comm-content">
                    <div class="comm-header">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div class="comm-type-badge" ng-class="'badge-' + msg.type">
                                <i class="fa" ng-class="{'fa-exclamation-triangle': msg.type === 'emergency', 'fa-bullhorn': msg.type === 'announcement', 'fa-lock': msg.type === 'internal'}"></i>
                                {{msg.type === 'emergency' ? '緊急' : msg.type === 'announcement' ? '告知' : '内部'}}
                            </div>
                            
                            <button class="btn-delete-comm" 
                                    ng-if="c.data.isAdmin" 
                                    ng-click="c.deleteComm(msg, $event)"
                                    title="削除 (Admin Only)">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                        <span class="comm-time"><i class="fa fa-clock-o"></i> {{msg.time_ago}}</span>
                    </div>
                    
                    <div class="comm-title">{{msg.title}}</div>
                    <div class="comm-body-preview">{{msg.body | limitTo:120}}{{msg.body.length > 120 ? '...' : ''}}</div>
                    
                    <div class="comm-footer">
                        <span class="comm-author"><i class="fa fa-user-circle"></i> {{msg.author}}</span>
                        <span class="comm-read-count" ng-if="msg.read_count > 0"><i class="fa fa-eye"></i> {{msg.read_count}}</span>
                    </div>
                </div>
            </div>
            <div class="empty-board" ng-if="c.getFilteredComms().length === 0">
                <i class="fa fa-feed" style="font-size:48px; color:#ccc; margin-bottom:16px;"></i>
                <h4>NO TRANSMISSIONS</h4>
                <p>通信記録がありません</p>
            </div>
        </div>
    </div>

    <div class="comm-detail-overlay" ng-if="c.showCommDetail && c.selectedComm" ng-click="c.closeCommDetail()">
        <div class="comm-detail-panel" ng-click="$event.stopPropagation()">
            <div class="comm-detail-header">
                <div class="comm-type-badge" ng-class="'badge-' + c.selectedComm.type" style="font-size:13px; padding:4px 12px;">
                    <i class="fa" ng-class="{'fa-exclamation-triangle': c.selectedComm.type === 'emergency', 'fa-bullhorn': c.selectedComm.type === 'announcement', 'fa-lock': c.selectedComm.type === 'internal'}"></i>
                    {{c.selectedComm.type === 'emergency' ? '緊急放送' : c.selectedComm.type === 'announcement' ? '一般告知' : '内部連絡'}}
                </div>
                <button class="btn-normal" ng-click="c.closeCommDetail()" style="background:none; border:none; font-size:20px; cursor:pointer;">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <h2 style="margin:16px 0 8px; font-size:22px; font-weight:800;">{{c.selectedComm.title}}</h2>
            <div style="display:flex; gap:16px; font-size:12px; color:#999; margin-bottom:20px;">
                <span><i class="fa fa-user-circle"></i> {{c.selectedComm.author}}</span>
                <span><i class="fa fa-clock-o"></i> {{c.selectedComm.time_ago}}</span>
            </div>
            <div class="comm-detail-body">{{c.selectedComm.body}}</div>
        </div>
    </div>

    <div class="delete-confirm-overlay" ng-if="c.showDeleteConfirm" ng-click="c.cancelDelete()">
        <div class="delete-confirm-panel" ng-click="$event.stopPropagation()">
            <div class="delete-confirm-icon">
                <i class="fa fa-exclamation-triangle"></i>
            </div>
            <h3 class="delete-confirm-title">メッセージを削除しますか？</h3>
            <div class="delete-confirm-msg-info">
                <span class="comm-type-badge" ng-class="'badge-' + c.deleteTarget.type" ng-if="c.deleteTarget">
                    {{c.deleteTarget.type === 'emergency' ? '緊急' : c.deleteTarget.type === 'announcement' ? '告知' : '内部'}}
                </span>
                <strong ng-if="c.deleteTarget">{{c.deleteTarget.title}}</strong>
            </div>
            <p class="delete-confirm-warning">※この操作は取り消せません</p>
            <div class="delete-confirm-actions">
                <button class="delete-btn-cancel" ng-click="c.cancelDelete()">キャンセル</button>
                <button class="delete-btn-confirm" ng-click="c.confirmDelete()"><i class="fa fa-trash"></i> 削除する</button>
            </div>
        </div>
    </div>

</div>
    
<!-- END: view-comms -->

<div class="zen-sidebar" ng-class="{'active': c.showSidebar}">
    <div class="sidebar-head">
        <span class="sb-title">SYSTEM_NAV</span>
        <button class="sb-close" ng-click="c.toggleSidebar()">×</button>
    </div>

    <div class="sb-profile">
        <div class="sb-avatar">{{c.data.user_name.charAt(0)}}</div>
        <div class="sb-info">
            <div class="sb-name">{{c.data.user_name}}</div>
            <div class="sb-role">VOLUNTEER_ID: {{c.data.user_id.substring(0,8)}}</div>
        </div>
    </div>

    <ul class="sb-nav-list">
            <li ng-click="c.view = 'dashboard'; c.toggleSidebar();">
                <span class="nav-num">01</span> OVERVIEW
            </li>
            <li ng-click="c.view = 'tactical'; c.toggleSidebar();">
                <span class="nav-num">02</span> TACTICAL BOARD
            </li>
            <li ng-click="c.view = 'mine'; c.toggleSidebar();">
                <span class="nav-num">03</span> OPERATORS
            </li>
            <li ng-click="c.view = 'comms'; c.toggleSidebar();">
                <span class="nav-num">04</span> COMMS CENTER
            </li>
            <li class="divider"></li>
            <li ng-click="c.refreshMonitoringData(); c.toggleSidebar();">
                <span class="nav-num">05</span> REFRESH DATA
            </li>
            <li ng-click="c.goToUserView()">
                <span class="nav-num">06</span> USER VIEW 
            </li>
        </ul>
        <div class="sb-footer">
            KOKORO SHELTER v5.0<br>
            VOLUNTEER COMMAND INTERFACE
        </div>
    </div>


<div class="zen-backdrop" ng-class="{'active': c.showSidebar}" ng-click="c.toggleSidebar()"></div>

<style>
/* --- 模态框修复样式 (解决变量失效/白底/头像丢失) --- */
.modal-content {
    --accent-primary: #6200ea;
    --text-primary: #1a1a1a;
    --text-secondary: #555555;
    --border-light: #eeeeee;
    --border-mid: #dddddd;
    --color-critical: #ff3b30;
    --color-warning: #ff9500;
    
    background: #fff !important;
    border: none !important;
    border-radius: 4px !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
    font-family: "Rajdhani", "JetBrains Mono", sans-serif !important;
    overflow: visible !important;
}
.modal-header-clean {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 20px 30px !important;
    background: #f8f9fa !important;
    border-bottom: 1px solid #e9ecef !important;
}
.header-badge { background: #000 !important; color: #fff !important; padding: 4px 12px; font-weight: 800; border-radius: 2px; }
.header-close { background: #fff !important; border: 1px solid #ddd !important; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
.header-close:hover { background: #ff3b30 !important; color: #fff !important; border-color: #ff3b30 !important; }
.avatar-box { width: 36px; height: 36px; background-color: #6200ea !important; color: #fff !important; display: flex !important; align-items: center; justify-content: center; border-radius: 4px; font-weight: 700; font-size: 16px; }
.avatar-box.orange { background-color: #ff9500 !important; }
.avatar-box.grey { background-color: #e0e0e0 !important; color: #999 !important; }
.body-sidebar { background: #fcfcfc !important; border-left: 1px solid #eee !important; padding: 25px !important; }
.sidebar-block { border-bottom: 1px dashed #e0e0e0; padding-bottom: 15px; margin-bottom: 20px; }
.sb-label { color: #999; font-weight: 700; font-size: 11px; margin-bottom: 8px; display: block; }
.activity-area { margin-top: 30px; padding-top: 20px; border-top: 2px solid #f0f0f0; display: flex; flex-direction: column; gap: 20px; }
.input-wrapper { display: flex; flex-direction: column !important; border: 1px solid #e0e0e0; background: #fff; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
.input-wrapper:focus-within { border-color: #000; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.note-input { width: 100%; min-height: 80px; padding: 15px; border: none !important; outline: none !important; font-family: "JetBrains Mono", sans-serif; font-size: 14px; color: #333; resize: vertical; background: transparent; }
.input-footer { display: flex; justify-content: flex-end; padding: 10px 15px; background: #f9f9f9; border-top: 1px solid #eee; }
.submit-btn { background: #e0e0e0; color: #999; padding: 8px 20px; font-family: "Rajdhani", sans-serif; font-weight: 700; font-size: 13px; border: none; cursor: not-allowed; border-radius: 2px; transition: all 0.2s; }
.submit-btn.ready { background: #1a1a1a; color: #fff; cursor: pointer; }
.submit-btn.ready:hover { background: #000; transform: translateY(-1px); }
.history-list { max-height: 400px; overflow-y: auto; padding-right: 8px; display: flex; flex-direction: column; gap: 15px; }
.log-item.type-user { background: #fff; padding: 0 0 15px 0; border-bottom: 1px solid #f5f5f5; }
.log-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; }
.log-user { font-weight: 800; color: #1a1a1a; }
.log-time { color: #999; font-family: monospace; }
.log-body { font-size: 14px; color: #444; line-height: 1.5; white-space: pre-wrap; }
.log-item.type-system { font-family: "JetBrains Mono", monospace; font-size: 12px; }
.sys-terminal-box { background: #f8f9fa; border-left: 3px solid #ccc; padding: 10px 14px; color: #555; border-radius: 0 4px 4px 0; }
.sys-terminal-box.sla-breach { border-left-color: #d93025; background: rgba(217, 48, 37, 0.03); }
.sys-terminal-box.sla-warning { border-left-color: #f9ab00; background: rgba(249, 171, 0, 0.03); }
.sys-meta-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #e0e0e0; padding-bottom: 5px; margin-bottom: 5px; font-size: 10px; color: #999; text-transform: uppercase; }
.tag-sla { display: inline-block; padding: 1px 6px; border-radius: 2px; font-weight: 700; font-size: 10px; margin-right: 6px; }
.tag-sla.violation { background: #d93025; color: #fff; }
.tag-sla.warning { background: #f9ab00; color: #fff; }
</style>

    <div id="sr-live-region"
     role="status"
     aria-live="polite"
     aria-atomic="true"
     class="sr-only">
</div>



<div style="display:none !important;" aria-hidden="true">
<script type="text/ng-template" id="volunteerModalTemplate">
<div class="modal-content kokoro-modal-window"
     role="dialog"
     aria-modal="true"
     aria-labelledby="modal-title"
     ng-keydown="c.onModalKeydown($event)">
     
  <h2 id="modal-title" class="sr-only">
    工単詳細: {{item.number}}
  </h2>

  <div class="modal-header-clean">
    <div class="header-left">
      <span class="header-badge"><i class="fa fa-truck" aria-hidden="true"></i> RESCUE_REQUEST</span>
      <span class="header-id">{{item.number}}</span>
    </div>
    <button class="header-close" aria-label="閉じる" ng-click="cancel()"><i class="fa fa-times" aria-hidden="true"></i></button>
  </div>

  <div class="modal-body-grid">
    <div class="body-main">
      <h2 class="ticket-title">
          {{c.dict[item.category] || item.category}}
          <span class="qty-badge-black">x{{item.quantity}}</span>
      </h2>
      
      <div class="action-bar">
        <div class="dropdown-wrapper">
          <button class="btn-purple-outline" ng-click="toggleStatusMenu($event)">
             {{c.statusNames[item.state] || 'OPEN'}} <i class="fa fa-chevron-down"></i>
          </button>
          <div class="status-menu" ng-show="statusMenuOpen">
            <div class="status-item" ng-click="changeStatus(item, '11')" ng-if="item.state != 11 && item.state != 4">ASSIGNED</div>
            <div class="status-item" ng-click="changeStatus(item, '2')" ng-if="item.state == 11">IN PROGRESS</div>
            <div class="status-item" ng-click="changeStatus(item, '4')" ng-if="item.state == 2">COMPLETED</div>
            <div class="status-item danger" ng-click="changeStatus(item, '5')">CANCELLED</div>
          </div>
        </div>
        
        <button class="btn-normal" ng-click="assignToMe(item)" ng-if="item.state != 4">
            <i class="fa fa-user"></i> ASSIGN TO ME
        </button>

        <div class="dropdown-wrapper" ng-if="item.state != 4">
            <button class="btn-normal" ng-click="showDispatchMenu = !showDispatchMenu">
                <i class="fa fa-paper-plane-o"></i> DISPATCH <i class="fa fa-chevron-down"></i>
            </button>
            <div class="status-menu" ng-show="showDispatchMenu" style="max-height:300px; overflow-y:auto;">
                <div class="status-item" style="padding:5px 15px; color:#999; font-size:10px; cursor:default; border-bottom:1px solid #eee;">
                    VOLUNTEERS
                </div>
                <div class="status-item" ng-repeat="vol in c.data.volunteers" 
                     ng-click="$event.stopPropagation(); c.assignTask(item.sys_id, vol.sys_id); showDispatchMenu=false; item.assigned_to_name=vol.name; item.assigned_to_id=vol.sys_id">
                    <span>{{vol.name}}</span>
                    <span style="float:right; font-size:10px; color:#999;">{{vol.load_percent}}%</span>
                </div>
            </div>
        </div>
        
        <button class="action-btn" ng-click="triggerAutoAssign(item)" ng-if="!item.assigned_to_id">
            <i class="fa fa-magic"></i> AUTO_ASSIGN
        </button>
      </div>

      <div class="desc-box">
        <div class="desc-section-title">DESCRIPTION</div>
        <div class="desc-grid">
          <div class="desc-item">
              <div class="desc-icon"><i class="fa fa-map-marker"></i></div>
              <div><span class="desc-label">LOCATION:</span> {{item.zone}} - {{item.detail_loc}}</div>
          </div>
          <div class="desc-item">
              <div class="desc-icon"><i class="fa fa-cube"></i></div>
              <div><span class="desc-label">TYPE:</span> {{c.dict[item.category] || item.category}}</div>
          </div>
          <div class="desc-item" ng-if="item.remarks">
              <div class="desc-icon"><i class="fa fa-sticky-note-o"></i></div>
              <div><span class="desc-label">NOTES:</span> {{item.remarks}}</div>
          </div>
        </div>
      </div>

      <div class="activity-area">
        <div class="desc-section-title">
            <i class="fa fa-history"></i> ACTIVITY_LOG / 履歴
        </div>
        <div class="input-wrapper">
            <label for="comment-input" class="sr-only">内部メモ</label>
            <textarea id="comment-input"
                      class="note-input" 
                      ng-model="newComment" 
                      placeholder="内部メモを入力してください... (Ctrl+Enter で送信)"
                      aria-label="内部メモを入力"
                      ng-keydown="$event.ctrlKey && $event.keyCode === 13 && postComment(item)"></textarea>
            <div class="input-footer">
                <button class="submit-btn" 
                        ng-class="{'ready': newComment && newComment.length > 0}" 
                        ng-disabled="!newComment || newComment.length === 0" 
                        ng-click="postComment(item)">
                    <i class="fa fa-paper-plane"></i> LOG_UPDATE
                </button>
            </div>
        </div>

        <div class="history-list">
            <div ng-repeat="h in item.history track by $index">
                <div class="log-item type-user" ng-if="!h.text.startsWith('[SLA')">
                    <div class="log-header">
                        <div class="log-user"><i class="fa fa-user-circle" style="color:#333; margin-right:6px;"></i> {{h.user}}</div>
                        <span class="log-time">{{h.date}}</span>
                    </div>
                    <div class="log-body">{{h.text}}</div>
                </div>

                <div class="log-item type-system" ng-if="h.text.startsWith('[SLA')">
                    <div class="sys-terminal-box" 
                         ng-class="{
                            'sla-breach': h.text.indexOf('違反') !== -1 || h.text.indexOf('breached') !== -1, 
                            'sla-warning': h.text.indexOf('警告') !== -1 || h.text.indexOf('risk') !== -1
                         }">
                        <div class="sys-meta-row">
                            <span><i class="fa fa-terminal"></i> システム監査 (SYSTEM_AUDIT)</span>
                            <span>{{h.date}}</span>
                        </div>
                        <div class="sys-content">
                            <span class="tag-sla violation" ng-if="h.text.indexOf('違反') !== -1 || h.text.indexOf('breached') !== -1">SLA違反</span>
                            <span class="tag-sla warning" ng-if="h.text.indexOf('警告') !== -1 || h.text.indexOf('risk') !== -1">SLA警告</span>
                            {{h.text.replace('[SLA違反]', '').replace('[SLA警告]', '').replace('[SLA违反]', '').replace('[WARNING_ALERT]', '').replace('[CRITICAL_FAILURE]', '')}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>

    <div class="body-sidebar">
      <div class="sidebar-block">
          <div class="sb-label">STATUS</div>
          <div class="state-indicator" style="background:#000; color:#fff;">{{c.getStateInfo(item.state).name}}</div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">ASSIGNEE</div>
          <div class="user-row" ng-if="item.assigned_to_name">
              <div class="avatar-box">{{item.assigned_to_name.charAt(0)}}</div>
              <div class="user-name-text">{{item.assigned_to_name}}</div>
          </div>
          <div class="user-row" ng-if="!item.assigned_to_name">
              <div class="avatar-box grey">?</div>
              <div class="user-name-text" style="color:#999;">UNASSIGNED</div>
          </div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">REPORTER</div>
          <div class="user-row">
              <div class="avatar-box orange">{{item.reporter_name.charAt(0) || '?'}}</div>
              <div class="user-name-text">{{item.reporter_name || 'System'}}</div>
          </div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">PRIORITY</div>
          <div class="priority-btn">{{c.dict[item.urgency] || item.urgency}}</div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">LOCATION</div>
          <div style="font-weight:800; color:#1a1a1a; font-size:16px;">
              <i class="fa fa-map-marker" style="color:#ff3b30; margin-right:10px;"></i>{{item.zone}}
          </div>
          <div style="font-size:14px; color:#999; margin-top:8px;">{{item.detail_loc}}</div>
      </div>

      <div class="ticket-card-body">
        <div class="ai-card">
             <div class="ai-head"><i class="fa fa-bolt ai-pulse"></i> TACTICAL_INSIGHT</div>
             <div class="ai-text" ng-bind-html="item.trusted_ai"></div>
        </div>
      </div>

      <div class="sidebar-block" ng-if="item.sla">
        <div class="sb-label">SLA TRACKING</div>
        <div class="sla-progress">
            <div class="sla-fill" ng-style="{width: item.sla.percentage + '%', background: c.getSLABarColor(item.sla)}"></div>
        </div>
        <div class="sla-badge" ng-class="{'sla-critical': item.sla.is_breached, 'sla-ok': !item.sla.is_breached}">
            {{item.sla.is_breached ? 'BREACHED' : 'WITHIN SLA'}}
        </div>
      </div>
    </div>
  </div>
</div>
</script>
</div>

</div> ]]></template>
    </sp_widget>
</record_update>
