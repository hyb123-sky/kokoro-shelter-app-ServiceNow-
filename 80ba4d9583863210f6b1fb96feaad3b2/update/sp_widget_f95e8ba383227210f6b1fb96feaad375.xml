<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, $uibModal, spUtil, $timeout, $window, $interval, $element, $sce) {
    var c = this;

    // ============================================================
    // 1. HTML信頼化 & 初期化 (Trust HTML & Init)
    // ============================================================
    
    // HTMLから呼び出せる安全変換関数
    $scope.trustHtml = function(html_code) {
        if (!html_code) return "";
        return $sce.trustAsHtml(html_code);
    };
    
    if (c.data && c.data.list) {
        c.data.list.forEach(function(item) {
            if (item.ai_analysis) {
                item.trusted_ai = $sce.trustAsHtml(item.ai_analysis);
            }
        });
    }

    // ============================================================
    // 2. セーフティネット初期化 (Data Safety Net)
    // ============================================================
    function initSafetyNet() {
        if (!c.data) c.data = {};
        
        // 基本配列
        c.data.resourceStatus = c.data.resourceStatus || [];
        for (var i = c.data.resourceStatus.length; i < 5; i++) {
            c.data.resourceStatus.push({ percent: 0, name: 'Resource_' + (i+1) });
        }
            
        c.data.list = c.data.list || [];
        c.data.myTasks = c.data.myTasks || [];
        c.data.myRequests = c.data.myRequests || [];
        c.data.volunteers = c.data.volunteers || [];
        c.data.announcements = c.data.announcements || [];
        
        // ユーザーとSLA
        if (!c.data.user_name) c.data.user_name = 'Operator';
        if (!c.data.user_id) c.data.user_id = 'VOL-000000';
        if (!c.data.slaStats) c.data.slaStats = { breached: 0, atRisk: 0, ok: 0 };
        if (c.data.isVolunteer === undefined) c.data.isVolunteer = true;
        if (!c.data.sosCount) c.data.sosCount = 0;
        if (!c.data.openCount) c.data.openCount = 0;

        // 統計データ
        if (!c.data.processMiningStats) c.data.processMiningStats = { totalEvents: 0, todayEvents: 0, uniqueCases: 0, topActivities: [] };
        if (!c.data.auditStats) c.data.auditStats = { todayLogs: 0, recentActions: [] };
        if (!c.data.overallHealth) c.data.overallHealth = { score: 100, status: 'nominal', components: [] };

        // 辞書設定
        c.statusNames = { '1': 'DRAFT', '10': 'SUBMITTED', '11': 'ASSIGNED', '2': 'IN_PROGRESS', '4': 'COMPLETED', '5': 'CANCELLED', '6': 'ON_HOLD' };
        c.dict = { 'Water': '飲料水', 'Food': '食料', 'Medical': '医療・薬', 'Baby': '乳幼児用品', 'Power': '電源・充電', 'Other': 'その他', 'Family Area': 'ファミリーエリア', 'Single Area': '単身エリア', 'Medical Area': '医療・ケアエリア', 'Critical': '限界 (SOS)', 'High': '困っている', 'Medium': '普通', 'Low': '急ぎません' };
        
        c.volunteerStatus = c.volunteerStatus || { isOnline: true, currentZone: '', taskCount: 0 };
        c.data.isAdmin = c.data.isAdmin || false; 
    }
    initSafetyNet(); // 実行

    // 通信センター初期化
    c.broadcastType = 'announcement';
    c.broadcastTitle = '';
    c.broadcastBody = '';
    c.commsFilter = '';
    
    // Capability オプション構築
    c.data.capOptions = [];
    if (c.data.capabilityOptions && c.data.capabilityOptions.length > 0) {
        for (var ci = 0; ci < c.data.capabilityOptions.length; ci++) {
            c.data.capOptions.push(c.data.capabilityOptions[ci].value || c.data.capabilityOptions[ci].label);
        }
    }
    if (c.data.capOptions.length === 0) {
        c.data.capOptions = ['General Support', 'Medical', 'Logistics', 'Translation', 'Childcare'];
    }

    // ============================================================
    // 3. カンバン・リストロジック (Kanban Logic)
    // ============================================================
    c.showCancelledCol = false;
    c.kanbanData = { todo: [], active: [], done: [], cancelled: [] };
    c.tacticalSearchText = '';
    c.tacticalFilterPriority = '';

    c.organizeKanban = function() {
        c.kanbanData = { todo: [], active: [], done: [], cancelled: [] };
        var sourceList = c.filteredList || c.data.list || [];
        var searchKey = c.tacticalSearchText ? c.tacticalSearchText.toLowerCase() : null;

        sourceList.forEach(function(item) {
            if (searchKey) {
                var itemText = (item.number + ' ' + item.category + ' ' + (item.assigned_to_name || '') + ' ' + item.zone).toLowerCase();
                if (itemText.indexOf(searchKey) === -1) return;
            }
            if (c.tacticalFilterPriority && item.urgency !== c.tacticalFilterPriority) return;

            var s = parseInt(item.state);
            if (s === 1 || s === 10) c.kanbanData.todo.push(item);
            else if (s === 11 || s === 2 || s === 6) c.kanbanData.active.push(item);
            else if (s === 4) c.kanbanData.done.push(item);
            else if (s === 5) c.kanbanData.cancelled.push(item);
        });
    };

    c.toggleCancelledColumn = function() { c.showCancelledCol = !c.showCancelledCol; };

    // 時間フォーマット
    c.formatTime24h = function(createdOn) {
        if (!createdOn) return '--:--';
        try {
            var date = new Date(createdOn);
            if (isNaN(date.getTime())) return '--:--';
            var now = new Date();
            var diffMs = now - date;
            var diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays > 0) {
                var h = ('0' + date.getHours()).slice(-2);
                var m = ('0' + date.getMinutes()).slice(-2);
                return diffDays + '日前 ' + h + ':' + m;
            } else {
                var diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours > 0) return diffHours + '時間前';
                var diffMinutes = Math.floor(diffMs / (1000 * 60));
                return diffMinutes + '分前';
            }
        } catch (e) { return '--:--'; }
    };

    // リスト処理（時間変換＋AI信頼化＋カンバン再構成）
    function processListItems() {
        var processItem = function(item) {
            item.time_24h = c.formatTime24h(item.created_on);
            if (item.ai_analysis) {
                item.trusted_ai = $sce.trustAsHtml(item.ai_analysis);
            }
        };

        if (c.data.list) c.data.list.forEach(processItem);
        if (c.data.myTasks) c.data.myTasks.forEach(processItem);
        if (c.data.myRequests) c.data.myRequests.forEach(processItem);
        c.organizeKanban();
    }
    processListItems(); // 初回実行

    // フィルタリング
    c.filterByUrgency = function(u) { 
        c.currentFilter = {type:'urgency', value:u}; 
        c.filteredList = c.data.list.filter(function(i){return i.urgency===u;}); 
        c.organizeKanban(); 
    };
    c.filterByAssignment = function(s) { 
        c.currentFilter = {type:'assignment', value:s}; 
        c.filteredList = c.data.list.filter(function(i){return s==='unassigned' ? !i.assigned_to_id : !!i.assigned_to_id;}); 
        c.organizeKanban(); 
    };
    c.clearFilters = function() { 
        c.currentFilter = null; 
        c.filteredList = null; 
        c.organizeKanban(); 
    };

    // ============================================================
    // 4. スタイル注入 (Style Injection)
    // ============================================================
    function injectStyles() {
        var styleId = 'kokoro-force-fix-v45'; 
        if (document.getElementById(styleId)) return;

        var css = '';
        css += 'nav, header, footer, .sp-page-header, .navbar { display: none !important; } ';
        css += '.sp-page-row-options, .u_p_floating_container, .sn-chat-overlay, .theme-picker, .icon-palette { display: none !important; opacity: 0 !important; pointer-events: none !important; }';
        css += '.kokoro-volunteer-container { position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 1000 !important; background: #f4f4f4 !important; overflow: hidden !important; padding: 0 !important; margin: 0 !important; display: flex !important; flex-direction: column !important; }';
        css += '.board-container { width: 100% !important; height: 100% !important; flex: 1 !important; padding: 20px !important; overflow-y: auto !important; box-sizing: border-box !important; max-width: none !important; margin: 0 !important; }';
        css += '.view-dashboard, .view-tactical, .view-mine, .view-requests, .card-section { width: 100% !important; max-width: none !important; }';
        css += '.card-grid, .task-grid { width: 100% !important; display: grid !important; justify-content: start !important; }';
        css += '.zen-sidebar { position: fixed !important; top: 0 !important; left: 0 !important; width: 280px !important; height: 100vh !important; background-color: #ffffff !important; background: #ffffff !important; z-index: 2000 !important; box-shadow: 5px 0 25px rgba(0,0,0,0.5) !important; }';
        css += '.dossier-bar-track { overflow: hidden !important; }';

        var style = document.createElement('style');
        style.id = styleId;
        style.appendChild(document.createTextNode(css));
        document.head.appendChild(style); 
    }

    function runSniper() {
        var windowHeight = $window.innerHeight;
        var allElements = document.body.getElementsByTagName('*');
        for (var i = 0; i < allElements.length; i++) {
            var el = allElements[i];
            if (el.tagName === 'SCRIPT' || el.tagName === 'STYLE' || el.tagName === 'LINK') continue;
            if (el.classList.contains('kokoro-volunteer-container') || el.closest('.kokoro-volunteer-container')) continue;
            if (el.classList.contains('modal') || el.closest('.modal') || el.classList.contains('modal-backdrop')) continue;
            if (el.classList.contains('zen-sidebar') || el.closest('.zen-sidebar')) continue;
            if (el.classList.contains('operator-modal-overlay') || el.closest('.operator-modal-overlay')) continue;
            if (el.getAttribute('ng-click')) continue; 
            if (el.classList.contains('fa-bars') || el.classList.contains('fa-times')) continue;

            var rect = el.getBoundingClientRect();
            if (rect.width > 0 && rect.height > 0 && rect.width < 100 && rect.height < 100) {
                var distBottom = windowHeight - rect.bottom;
                var distLeft = rect.left;
                if ((distBottom >= 0 && distBottom < 120) || (distLeft >= 0 && distLeft < 120)) {
                    if (getComputedStyle(el).position === 'fixed') {
                          el.style.setProperty('display', 'none', 'important');
                    }
                }
            }
        }
    }
    
    injectStyles();
    var sniperInterval = $interval(runSniper, 2000);

    // ============================================================
    // 5. インタラクション (Interaction)
    // ============================================================
    c.view = 'dashboard';
    c.showSidebar = false;
    c.toggleSidebar = function() { c.showSidebar = !c.showSidebar; };
    c.currentTime = '';

    function updateSystemTime() {
        var now = new Date();
        c.currentTime = ('0' + now.getHours()).slice(-2) + ':' + ('0' + now.getMinutes()).slice(-2) + ':' + ('0' + now.getSeconds()).slice(-2);
    }
    updateSystemTime();
    var timeInterval = $interval(updateSystemTime, 1000);
    
    c.goToUserView = function() {
        $window.location.href = '?id=kokoro_user_view'; 
    };

    // ============================================================
    // 6. タスク詳細・モダール (Task Modal)
    // ============================================================
    c.openModal = function(item) {
        if (!c.data.volunteers || c.data.volunteers.length === 0) {
            c.server.get({ action: 'get_volunteers' }).then(function(r) {
                if (r && r.data && r.data.volunteers) {
                    c.data.volunteers = r.data.volunteers;
                    angular.forEach(c.data.volunteers, function(vol) {
                        var rawLoad = (vol.open_tasks / 10) * 100;
                        vol.load = rawLoad.toFixed(1);
                    });
                }
            });
        }

        var modalInstance = $uibModal.open({
            templateUrl: 'volunteerModalTemplate',
            scope: $scope,
            size: 'lg',
            backdrop: 'static',
            windowClass: 'kokoro-modal-window'
        });

        $scope.item = angular.copy(item);
        $scope.c = c;
        $scope.newComment = '';
        $scope.statusMenuOpen = false;
        
        $scope.toggleStatusMenu = function($event) { if ($event) $event.stopPropagation(); $scope.statusMenuOpen = !$scope.statusMenuOpen; };
        $window.onclick = function() { if ($scope.statusMenuOpen) $timeout(function() { $scope.statusMenuOpen = false; }); };
        $scope.cancel = function() { modalInstance.dismiss('cancel'); };

        $scope.assignToMe = function(item) {
            c.server.get({ action: 'assign_to_me', sys_id: item.sys_id }).then(function(r) {
                handleServerResponse(r, function() {
                    item.assigned_to_id = c.data.user_id; item.assigned_to_name = c.data.user_name;
                    $scope.item.assigned_to_id = c.data.user_id; $scope.item.assigned_to_name = c.data.user_name;
                    if (item.state == 1 || item.state == 10) { item.state = 11; $scope.item.state = 11; }
                    showSuccess('担当者に設定しました');
                    c.server.update().then(processListItems);
                });
            });
        };

        $scope.changeStatus = function(item, newState) {
            var ns = parseInt(newState);
            if (ns === 11 && !item.assigned_to_id) { $scope.assignToMe(item); return; }
            if (ns === 2 && !item.assigned_to_id) { showError('先に担当者を設定してください'); return; }
            
            c.server.get({ action: 'change_status', sys_id: item.sys_id, new_state: newState }).then(function(r) {
                if (handleServerResponse(r, function() {
                    item.state = ns; $scope.item.state = ns; $scope.statusMenuOpen = false;
                    showSuccess('ステータスを更新しました');
                    c.server.update().then(processListItems);
                    if (ns === 4 || ns === 5) { $timeout(function() { modalInstance.close(); }, 1000); }
                }));
            });
        };

        $scope.postComment = function(item) {
            if (!$scope.newComment || !$scope.newComment.trim()) return;
            c.server.get({ action: 'add_comment', sys_id: item.sys_id, message: $scope.newComment }).then(function(r) {
                handleServerResponse(r, function() {
                    if (!item.history) item.history = [];
                    item.history.unshift({ user: c.data.user_name || 'Me', text: $scope.newComment, date: new Date().toLocaleString() });
                    $scope.item.history = item.history; $scope.newComment = '';
                    showSuccess('コメントを追加しました');
                });
            });
        };
        
        $scope.triggerAutoAssign = function(item) { c.triggerAutoAssign(item.sys_id, true); };
        modalInstance.result.finally(function() { c.server.update().then(processListItems); });
    };

    // ============================================================
    // 7. アクションロジック (Assign, Location, etc.)
    // ============================================================
    c.triggerAutoAssign = function(sysId, forceReassign) {
        if (!sysId) return;
        c.server.get({ action: 'trigger_auto_assign', sys_id: sysId, force_reassign: forceReassign || false })
        .then(function(response) {
            if (response.data.success) {
                spUtil.addInfoMessage('自動割当完了: ' + response.data.assigned_to);
                c.server.update().then(processListItems);
            } else {
                spUtil.addErrorMessage('自動割当失敗: ' + (response.data.error || '志願者が見つかりません'));
            }
        });
    };

    c.assignTask = function(ticketId, targetUserId) {
        if (!ticketId || !targetUserId) return;
        c.server.get({ action: 'assign_task', ticket_id: ticketId, target_user: targetUserId }).then(function(r) {
            if (r && r.data && r.data.error) {
                spUtil.addErrorMessage(r.data.error);
            } else {
                spUtil.addInfoMessage('タスクを分配しました');
                c.server.update().then(processListItems);
            }
        });
    };

    c.updateMyLocation = function(zone) {
        if (!zone) return;
        c.server.get({ action: 'update_location', zone: zone }).then(function(response) {
            if (response.data.success) {
                c.volunteerStatus.currentZone = zone;
                spUtil.addInfoMessage(response.data.message || '現在地を更新しました');
            }
        });
    };

    c.toggleAvailability = function() {
        var newStatus = !c.volunteerStatus.isOnline;
        c.server.get({ action: 'set_availability', available: newStatus }).then(function(response) {
            if (response.data.success) {
                c.volunteerStatus.isOnline = newStatus;
                spUtil.addInfoMessage(response.data.message);
            }
        });
    };
    
    c.refreshMonitoringData = function() {
        c.server.update().then(function() { 
            // データ更新時にもHTMLを信頼化
            if (c.data.global_ai_analysis) c.trusted_global_ai = $sce.trustAsHtml(c.data.global_ai_analysis);
            processListItems();
            spUtil.addInfoMessage('監視データを更新しました'); 
        });
    };

    // ============================================================
    // 8. オペレーター管理 (Operator Modal)
    // ============================================================
    c.showUserModal = false;
    c.selectedVol = {};

    c.openUserModal = function(vol) {
        if (!vol) return;
        c.selectedVol = vol;
        c.showUserModal = true;
    };

    c.closeUserModal = function() {
        c.showUserModal = false;
        c.selectedVol = {}; 
    };

    c.updateCapability = function() {
        if (!c.data.isAdmin) return;
        var newCap = c.selectedVol.capability;
        var targetId = c.selectedVol.sys_id;

        c.server.get({ action: 'specialty', target_id: targetId, new_cap: newCap }).then(function(response) {
            spUtil.addInfoMessage('能力情報を更新しました');
        });
    };

    // ============================================================
    // 9. 通信センター (Comms Center)
    // ============================================================
    c.sendBroadcast = function() {
        if (!c.broadcastTitle || !c.broadcastBody) return;
        if (c._broadcastSending) return;
        c._broadcastSending = true;
        
        c.server.get({ 
            action: 'send_broadcast', 
            msg_type: c.broadcastType || 'announcement', 
            title: c.broadcastTitle, 
            body: c.broadcastBody 
        }).then(function(r) {
            c._broadcastSending = false;
            if (r.data.success) {
                spUtil.addInfoMessage('放送を送信しました');
                c.data.announcements.unshift({
                    sys_id: r.data.new_id || 'temp_' + Date.now(),
                    type: c.broadcastType,
                    title: c.broadcastTitle,
                    body: c.broadcastBody,
                    author: c.data.user_name,
                    time_ago: '今',
                    read_count: 0
                });
                c.broadcastTitle = '';
                c.broadcastBody = '';
            } else {
                spUtil.addErrorMessage(r.data.error || '送信失敗');
            }
        }, function() {
            c._broadcastSending = false;
            spUtil.addErrorMessage('通信エラーが発生しました');
        });
    };

    c.getFilteredComms = function() {
        if (!c.data.announcements) return [];
        if (!c.commsFilter) return c.data.announcements;
        return c.data.announcements.filter(function(msg) { return msg.type === c.commsFilter; });
    };

    c.openCommDetail = function(msg) {
        if (!msg) return;
        c.selectedComm = msg;
        c.showCommDetail = true;
    };
    
    c.closeCommDetail = function() {
        c.showCommDetail = false;
        c.selectedComm = null;
    };

    // 削除機能
    c.deleteComm = function(msg, $event) {
        if ($event) $event.stopPropagation();
        c.deleteTarget = msg;
        c.showDeleteConfirm = true;
    };

    c.confirmDelete = function() {
        var msg = c.deleteTarget;
        if (!msg) return;
        c.server.get({ action: 'delete_broadcast', sys_id: msg.sys_id }).then(function(r) {
            if (r.data.success) {
                var index = c.data.announcements.indexOf(msg);
                if (index > -1) c.data.announcements.splice(index, 1);
                spUtil.addInfoMessage('メッセージを削除しました');
                if (c.selectedComm && c.selectedComm.sys_id === msg.sys_id) c.closeCommDetail();
            } else {
                spUtil.addErrorMessage(r.data.error || '削除失敗');
            }
        });
        c.cancelDelete();
    };

    c.cancelDelete = function() {
        c.showDeleteConfirm = false;
        c.deleteTarget = null;
    };

    // ============================================================
    // 10. 共通ヘルパー (Helpers)
    // ============================================================
    function showSuccess(msg) { spUtil.addInfoMessage(msg); }
    function showError(msg) { spUtil.addErrorMessage(msg || 'エラーが発生しました'); }
    function handleServerResponse(response, successCallback) {
        if (!response || !response.data) { showError('サーバーエラー'); return false; }
        if (response.data.error) { showError(response.data.error); return false; }
        if (successCallback) successCallback(response.data);
        return true;
    }

    c.getHealthStatusDisplay = function() {
        var score = c.data.overallHealth.score;
        if (score >= 90) return { text: 'NOMINAL', class: 'nominal', color: '#34c759' };
        if (score >= 70) return { text: 'WARNING', class: 'warning', color: '#ff9500' };
        return { text: 'CRITICAL', class: 'critical', color: '#ff3b30' };
    };

    c.getActivityIcon = function(activityName) {
        var iconMap = { 'Wish_Created': 'fa-plus-circle', 'Wish_Submitted': 'fa-paper-plane', 'Wish_Assigned': 'fa-user-plus', 'Wish_Completed': 'fa-check-circle', 'SLA_Breached': 'fa-exclamation-triangle' };
        return iconMap[activityName] || 'fa-circle';
    };
    c.formatActivityName = function(name) { return name ? name.replace(/_/g, ' ') : 'Unknown'; };
    c.getSLABarColor = function(sla) {
        if (!sla) return '#888';
        if (sla.is_breached || sla.status === 'critical') return '#ff3b30';
        if (sla.status === 'warning') return '#ff9500';
        return '#34c759';
    };

    // ============================================================
    // 11. リアルタイム監視 (Watchers)
    // ============================================================
    spUtil.recordWatch($scope, 'x_1821654_kokoro_0_silent_wish', '', function(name, data) {
        c.server.update().then(function() { 
            // アップデート時にAI分析を再信頼化
            if (c.data.global_ai_analysis) c.trusted_global_ai = $sce.trustAsHtml(c.data.global_ai_analysis);
            processListItems(); 
        });
    });
    
    spUtil.recordWatch($scope, 'x_1821654_kokoro_0_kokoro_inventory', '', function() {
        c.server.update();
    });

    var slaUpdateInterval = $interval(function() {
        updateSLAForList(c.data.list);
        updateSLAForList(c.data.myTasks);
        updateSLAForList(c.data.myRequests);
    }, 30000);

    function updateSLAForList(list) {
        if (!list) return;
        angular.forEach(list, function(item) {
            if (!item.sla || item.sla.is_stopped || item.state == 4 || item.state == 5) return;
            item.sla.elapsed = (item.sla.elapsed || 0) + 0.5;
            item.sla.remaining = Math.max(0, item.sla.target - item.sla.elapsed);
            item.sla.percentage = Math.min(100, Math.round((item.sla.elapsed / item.sla.target) * 100));
            if (item.sla.elapsed > item.sla.target) {
                item.sla.status = 'critical';
                item.sla.is_breached = true;
            }
        });
    }

    $scope.$on('$destroy', function() {
        if (timeInterval) $interval.cancel(timeInterval);
        if (slaUpdateInterval) $interval.cancel(slaUpdateInterval);
        if (sniperInterval) $interval.cancel(sniperInterval);
    });

    // 詳細表示トグル
    c.toggleDetail = function(item) {
        c.selectedTask = (c.selectedTask === item) ? null : item;
    };
};]]></client_script>
        <controller_as>c</controller_as>
        <css>/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 0: SERVICENOW ELIMINATION - 绝对不可删除
   ═══════════════════════════════════════════════════════════════════════════════════════ */
nav, header, footer, .sp-page-header, .navbar, .polaris-header, 
.sn-polaris-nav, .sn-canvas-header, #sp-nav-bar, .sp-row-background,
.cms-header, .navpage-header, .navpage-footer {
  display: none !important;
  height: 0 !important;
  visibility: hidden !important;
}

.sn-chat-overlay, .help-button-wrapper, .sp-ac-root, .sw-session-repro-button,
button.help-button, .sn-connect-floating-wrapper, #u_chat_button, .cm-help-button,
.sp-page-row-options, .theme-picker, .sp-debug-tool, div[ng-controller="spPageRowOptions"],
a[title="Toggle Layout"], .btn-floating, .sp-icon-edit,
.guided-tour-overlay, .code-editor-container, .icon-palette, .fa-cog, 
.sp-icon-color, .sp-preview-pill, .u_p_floating_container,
[class*="intercom"], [class*="chat-widget"], [id*="chat"],
div[style*="position: fixed"][style*="bottom"][style*="right"] {
  display: none !important;
  visibility: hidden !important;
  width: 0 !important; 
  height: 0 !important;
  pointer-events: none !important;
  opacity: 0 !important;
  z-index: -9999 !important;
  position: absolute !important;
  left: -9999px !important;
}

body &gt; div[style*="position: fixed"][style*="bottom"],
body &gt; div[style*="position:fixed"][style*="bottom"],
body &gt; button[style*="position: fixed"][style*="bottom"],
body &gt; div[style*="position: fixed"][style*="left"], 
body &gt; div[style*="position:fixed"][style*="left"],
body &gt; div[style*="position: fixed"][style*="right"],
body &gt; iframe[style*="position: fixed"] {
  display: none !important;
  opacity: 0 !important;
  pointer-events: none !important;
  z-index: -9999 !important;
}

html, body {
  height: 100% !important;
  width: 100% !important;
  overflow: hidden !important;
  position: fixed !important;
  background: #0a0a0a !important;
  margin: 0 !important;
  padding: 0 !important;
  font-size: 14px !important;
}

.modal { z-index: 1050000 !important; position: fixed !important; }
.modal-backdrop { z-index: 1049999 !important; background-color: rgba(0,0,0,0.95) !important; }
.modal-dialog { z-index: 1050001 !important; }

/* Monitoring Panel Container */
.monitoring-panel {
    background: #fff;
    border: 1px solid #ddd;
    padding: 16px;
    margin-top: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

/* Health Gauge */
.health-gauge {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 15px 0;
}

.gauge-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 4px solid #ddd;
    background: #f8f8f8;
    transition: all 0.3s;
    flex-shrink: 0;
}

.gauge-circle.nominal {
    border-color: var(--color-success);
    background: rgba(52, 199, 89, 0.1);
}

.gauge-circle.warning {
    border-color: var(--color-warning);
    background: rgba(255, 149, 0, 0.1);
}

.gauge-circle.critical {
    border-color: var(--color-critical);
    background: rgba(255, 59, 48, 0.1);
    animation: pulse-critical 1s ease-in-out infinite;
}

@keyframes pulse-critical {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.gauge-value {
    font-family: var(--font-tech);
    font-size: 28px;
    font-weight: 900;
    color: var(--text-primary);
}

.gauge-label {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-tertiary);
    letter-spacing: 1px;
}

.gauge-info {
    flex: 1;
}

.gauge-status {
    font-family: var(--font-header);
    font-size: 16px;
    font-weight: 800;
    letter-spacing: 2px;
    margin-bottom: 8px;
}

.gauge-components {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-family: var(--font-mono);
    font-size: 11px;
}

.gauge-components span {
    font-weight: 600;
}

/* PM Metrics Grid */
.pm-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.pm-metric-item {
    text-align: center;
    padding: 12px 8px;
    background: #f8f8f8;
    border-left: 3px solid #000;
}

.pm-metric-label {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-tertiary);
    letter-spacing: 1px;
    margin-bottom: 6px;
}

.pm-metric-value {
    font-family: var(--font-tech);
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
}

/* Activity Distribution */
.activity-distribution {
    margin: 15px 0;
}

.dist-title {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-tertiary);
    letter-spacing: 1px;
    margin-bottom: 10px;
}

.dist-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    font-size: 13px;
}

.dist-item:last-child {
    border-bottom: none;
}

.dist-item i {
    color: var(--accent-primary);
    width: 20px;
    text-align: center;
}

.dist-name {
    flex: 1;
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dist-count {
    font-family: var(--font-tech);
    font-weight: 700;
    color: var(--text-primary);
}

/* No Data Hint */
.no-data-hint {
    text-align: center;
    padding: 20px;
    color: var(--text-tertiary);
    font-size: 13px;
}

.no-data-hint i {
    margin-right: 8px;
}

/* Alert Summary (Day5 monitoring rows — scoped to avoid clash with main .alert-row) */
.alert-summary {
    margin: 15px 0;
}

.alert-summary .alert-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: #f8f8f8;
    margin-bottom: 8px;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
}

.alert-summary .alert-row:last-child {
    margin-bottom: 0;
}

.alert-summary .alert-row i {
    color: var(--text-tertiary);
    width: 18px;
    text-align: center;
}

.alert-summary .alert-row span:first-of-type {
    flex: 1;
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 1px;
}

.alert-count {
    font-family: var(--font-tech);
    font-weight: 800;
    font-size: 16px;
}

.alert-summary .alert-row.critical {
    background: rgba(255, 59, 48, 0.1);
    border-left: 3px solid var(--color-critical);
}

.alert-summary .alert-row.critical i,
.alert-summary .alert-row.critical .alert-count {
    color: var(--color-critical);
}

.alert-summary .alert-row.warning {
    background: rgba(255, 149, 0, 0.1);
    border-left: 3px solid var(--color-warning);
}

.alert-summary .alert-row.warning i,
.alert-summary .alert-row.warning .alert-count {
    color: var(--color-warning);
}

/* Recent Audit */
.recent-audit {
    margin: 15px 0;
}

.audit-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px dashed #eee;
    font-size: 12px;
}

.audit-item:last-child {
    border-bottom: none;
}

.audit-action {
    color: var(--text-secondary);
    font-weight: 600;
}

.audit-user {
    color: var(--text-tertiary);
    font-family: var(--font-mono);
    font-size: 11px;
}

/* Refresh Button */
.refresh-btn {
    width: 100%;
    padding: 12px;
    background: #000;
    color: #fff;
    border: none;
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 15px;
}

.refresh-btn:hover {
    background: #333;
}

.refresh-btn i {
    margin-right: 8px;
}

/* Day5 Responsive */
@media (max-width: 400px) {
    .pm-metrics {
        grid-template-columns: 1fr;
    }
    
    .health-gauge {
        flex-direction: column;
        text-align: center;
    }
    
    .gauge-components {
        justify-content: center;
    }
}
/* ============================================================
   [END OF DAY 5 CSS]
   ============================================================ */
/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 1: KOKORO OS // VISUAL CORE [REFACTORED: ENDFIELD_PROTOCOL]
   ═══════════════════════════════════════════════════════════════════════════════════════ */
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&amp;family=Rajdhani:wght@400;500;600;700&amp;family=JetBrains+Mono:wght@400;700&amp;display=swap');

.kokoro-volunteer-container {
  /* ─── BASE: 工业灰度 (Industrial Grayscale) ─── */
  --bg-core: #F2F3F5;       /* 类似终末地的工业混凝土白 */
  --bg-primary: #FFFFFF;    /* 纯净操作层 */
  --bg-secondary: #E5E8EB;  /* 次级面板灰 */
  --bg-tertiary: #D3D7DB;   /* 装饰性深灰 */
  --bg-panel: rgba(255, 255, 255, 0.85); /* 磨砂玻璃基底 */
  
  /* ─── DECORATION: 科技纹理 ─── */
  --tech-grid: radial-gradient(#BDC3C7 1px, transparent 1px); /* 点阵网格 */
  --tech-grid-size: 20px 20px;

  /* ─── BORDERS: 构成主义线条 ─── */
  --border-hairline: 1px solid rgba(0, 0, 0, 0.1);  /* 隐形分割线 */
  --border-main: 1px solid #1A1A1A;                 /* 主结构线（绝对黑） */
  --border-bold: 2px solid #000000;                 /* 强调边框 */
  --border-tech: 1px solid rgba(0, 0, 0, 0.2);      /* 装饰性科技线 */
  
  /* ─── TEXT: 终端显示风格 ─── */
  --text-primary: #0F0F0F;      /* 接近纯黑 */
  --text-secondary: #586069;    /* 工业灰字 */
  --text-tertiary: #8C959F;     /* 禁用/注释态 */
  --text-code: #24292E;         /* 代码/数据 */
  --text-inverse: #FFFFFF;      /* 反色文本（用于黑色块上） */

  /* ─── ACCENTS: 战术信号色 (Tactical Signals) ─── */
  /* 这里的黑色不再是普通的黑，而是带有光泽的“黑曜石”感 */
  --accent-primary: #000000; 
  --accent-secondary: #2C2C2C;
  
  /* 辅助信号色：高饱和度，用于模拟HUD警告灯 */
  --signal-cyan: #005cc5;   /* 终端指令蓝 */
  --signal-amber: #d29922;  /* 警告/注意 */
  --signal-crimson: #cf222e;/* 致命错误 */
  --signal-teal: #2E8B57;   /* 生命体征/正常 */

  /* ─── FUNCTIONAL: 语义映射 ─── */
  --color-success: var(--signal-teal);
  --color-warning: var(--signal-amber);
  --color-critical: var(--signal-crimson);
  --color-info: var(--signal-cyan);
  
  /* ─── EFFECTS: 视觉特效 ─── */
  --glass-blur: blur(12px);
  --shadow-flat: 4px 4px 0px rgba(0,0,0,0.1); /* 硬阴影，非弥散阴影 */
  --shadow-float: 0 8px 24px rgba(0,0,0,0.08);

  /* ─── TYPOGRAPHY: 字体栈 ─── */
  --font-display: 'Orbitron', sans-serif;       /* 用于大标题/数字 */
  --font-ui: 'Rajdhani', sans-serif;            /* 核心UI字体，极具科技感 */
  --font-mono: 'JetBrains Mono', monospace;     /* 数据/ID */
  
  /* ─── ANIMATION ─── */
  --ease-tech: cubic-bezier(0.22, 1, 0.36, 1);  /* 机械回弹感 */
}

/* ═════════════════════════════════════════════════════════════════════
   GLOBAL OVERRIDES (强制应用风格)
   ═════════════════════════════════════════════════════════════════════ */

/* 全局背景增加点阵纹理 */
.kokoro-volunteer-container {
    background-color: var(--bg-core);
    background-image: var(--tech-grid);
    background-size: var(--tech-grid-size);
    font-family: var(--font-ui); /* 默认使用 Rajdhani */
    letter-spacing: 0.02em;      /* 稍微增加字间距，增加通透感 */
}

/* 强调文字变为等宽或者是机能字体 */
.kokoro-volunteer-container h1, 
.kokoro-volunteer-container h2, 
.kokoro-volunteer-container .ticket-title {
    font-family: var(--font-ui);
    font-weight: 700;
    text-transform: uppercase; /* 强制大写，更像军用终端 */
}

/* 数字强制使用等宽字体 */
.kokoro-volunteer-container .sb-role,
.kokoro-volunteer-container .nav-num,
.kokoro-volunteer-container .header-id {
    font-family: var(--font-mono);
    letter-spacing: -0.05em;
}

/* ═════════════════════════════════════════════════════════════════════
   COMPONENT FIXES (样式修正)
   ═════════════════════════════════════════════════════════════════════ */
.kokoro-volunteer-container .wish-card, 
.kokoro-volunteer-container .sidebar-block,  {
    background-color: var(--bg-card);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border: 1px solid var(--border-mid);
    color: var(--text-primary);
}

.kokoro-volunteer-container h1,
.kokoro-volunteer-container h2, 
.kokoro-volunteer-container h3, 
.kokoro-volunteer-container .logo-text,
.kokoro-volunteer-container .stat-value {
    color: var(--text-primary) !important;
}

.kokoro-volunteer-container .sb-label,
.kokoro-volunteer-container .ai-head {
    color: var(--text-secondary);
    font-weight: 700;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 2: ANIMATIONS
   ═══════════════════════════════════════════════════════════════════════════════════════ */
@keyframes pulse-glow {
  0%, 100% { 
    box-shadow: 0 0 5px var(--accent-glow), 0 0 10px var(--accent-glow);
    opacity: 1;
  }
  50% { 
    box-shadow: 0 0 15px var(--accent-glow), 0 0 25px var(--accent-glow);
    opacity: 0.85;
  }
}

@keyframes scanline {
  0% { transform: translateY(-100%); opacity: 0; }
  10% { opacity: 0.6; }
  90% { opacity: 0.6; }
  100% { transform: translateY(100vh); opacity: 0; }
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

@keyframes data-stream {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

@keyframes slide-in {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes border-pulse {
  0%, 100% { border-color: var(--border-mid); }
  50% { border-color: var(--accent-primary); }
}

@keyframes critical-flash {
  0%, 100% { background-color: var(--color-critical); }
  50% { background-color: #ff6666; }
}

@keyframes bar-fill {
  from { width: 0; }
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 3: MAIN CONTAINER
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.kokoro-volunteer-container {
  font-family: var(--font-body);
  font-size: 15px !important;
  line-height: 1.5;
  position: fixed !important;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 100 !important;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow-y: auto;
  overflow-x: hidden;
}

.kokoro-volunteer-container::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-image: 
    linear-gradient(rgba(0,255,136,0.02) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,136,0.02) 1px, transparent 1px);
  background-size: 60px 60px;
  pointer-events: none;
  z-index: -1;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 4: METAL DIVIDERS - 金属分割线
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.metal-divider {
  height: 2px;
  background: var(--metal-gradient);
  margin: 24px 0;
  position: relative;
  overflow: hidden;
}

.metal-divider::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  background-size: 200% 100%;
  animation: shimmer 3s ease-in-out infinite;
}

.metal-divider-glow {
  height: 2px;
  background: var(--metal-glow);
  margin: 24px 0;
  box-shadow: 0 0 10px var(--accent-glow), 0 0 20px var(--accent-glow);
}

.metal-divider-thick {
  height: 4px;
  background: linear-gradient(180deg, #3a3a3a, #1a1a1a, #3a3a3a);
  border-top: 1px solid #4a4a4a;
  border-bottom: 1px solid #0a0a0a;
  margin: 28px 0;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 5: SAFETY BANNER
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.safety-banner {
  background: linear-gradient(90deg, var(--color-critical), #cc2222);
  color: #fff;
  padding: 14px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 1px;
  animation: critical-flash 2s ease-in-out infinite;
  border-bottom: 2px solid rgba(255,255,255,0.3);
}

.safety-banner button {
  background: rgba(0,0,0,0.5);
  border: 2px solid rgba(255,255,255,0.5);
  color: #fff;
  padding: 8px 20px;
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.safety-banner button:hover {
  background: #fff;
  color: var(--color-critical);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 6: COMMAND HEADER - 修复布局
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.command-header {
  background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
  border-bottom: 2px solid var(--border-mid);
  padding: 20px 40px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 500;
  gap: 20px;
  flex-wrap: nowrap;
}

.command-logo {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-shrink: 0;
  min-width: 0;
}

.logo-icon {
  width: 56px;
  height: 56px;
  background: var(--accent-primary);
  color: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-weight: 900;
  font-size: 28px;
  clip-path: polygon(0 10px, 10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
  animation: pulse-glow 3s ease-in-out infinite;
  flex-shrink: 0;
}

.logo-text {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex-shrink: 0;
  min-width: 0;
}

.logo-title {
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 800;
  color: var(--text-primary);
  letter-spacing: 6px;
  text-shadow: 0 0 20px var(--accent-glow);
  white-space: nowrap;
}

.logo-subtitle {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-tertiary);
  letter-spacing: 3px;
  white-space: nowrap;
}

.system-status {
  display: flex;
  align-items: center;
  gap: 24px;
  font-family: var(--font-mono);
  font-size: 13px;
  flex-shrink: 0;
  margin-left: auto;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 10px;
}

.status-dot {
  width: 10px;
  height: 10px;
  background: var(--accent-primary);
  border-radius: 2px;
  animation: pulse-glow 2s ease-in-out infinite;
  flex-shrink: 0;
}

.status-text {
  color: var(--accent-primary);
  font-weight: 700;
  white-space: nowrap;
}

.version-tag {
  color: var(--text-muted);
  padding: 4px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-mid);
  white-space: nowrap;
}

.system-time {
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 16px;
  white-space: nowrap;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 7: NAVIGATION TABS
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.nav-tabs-custom {
  background: var(--bg-tertiary);
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--border-mid);
  padding: 0 40px;
}

.nav-tabs-custom .tab {
  padding: 18px 36px;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--text-tertiary);
  font-family: var(--font-body);
  font-weight: 700;
  font-size: 15px;
  letter-spacing: 2px;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  white-space: nowrap;
}

.nav-tabs-custom .tab:hover {
  color: var(--text-secondary);
  background: rgba(0,255,136,0.05);
}

.nav-tabs-custom .tab.active {
  color: var(--accent-primary);
  border-bottom-color: var(--accent-primary);
  text-shadow: 0 0 15px var(--accent-glow);
}

.tab-number {
  font-family: var(--font-display);
  font-weight: 800;
  margin-right: 8px;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 8: SCAN LINE HEADER
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.scan-line-header {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 14px 40px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-dark);
}

.scan-line {
  flex: 1;
  height: 2px;
  background: var(--metal-gradient);
}

.scan-label {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 4px;
  animation: data-stream 2s ease-in-out infinite;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 9: BOARD CONTAINER
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.board-container {
  padding: 24px 32px 120px; /* 调整内边距以适应全屏 */
  max-width: none !important; /* 核心修复：移除最大宽度限制 */
  width: 100% !important;     /* 核心修复：强制占满父容器 */
  margin: 0 !important;       /* 核心修复：移除居中 Margin */
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 10: VOLUNTEER STATUS PANEL
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.volunteer-status-panel {
  background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
  border: 2px solid var(--border-mid);
  border-left: 4px solid var(--accent-primary);
  padding: 20px 32px;
  margin-bottom: 28px;
  display: flex;
  align-items: center;
  gap: 48px;
  position: relative;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.volunteer-status-panel::before {
  content: 'OPERATOR_STATUS';
  position: absolute;
  top: 8px;
  right: 20px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--accent-primary);
  letter-spacing: 2px;
  animation: data-stream 2s ease-in-out infinite;
}

.status-row {
  display: flex;
  align-items: center;
  gap: 14px;
  font-weight: 700;
  color: var(--text-secondary);
  font-size: 15px;
}

.status-row i {
  color: var(--accent-primary);
  width: 24px;
  font-size: 18px;
}

.btn-online {
  background: var(--accent-primary);
  color: var(--bg-primary);
  border: none;
  padding: 10px 24px;
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 1px;
  cursor: pointer;
  clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
  animation: pulse-glow 2s ease-in-out infinite;
  transition: transform 0.2s;
}

.btn-online:hover {
  transform: scale(1.05);
}

.btn-offline {
  background: var(--border-light);
  color: var(--text-tertiary);
  border: none;
  padding: 10px 24px;
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 1px;
  cursor: pointer;
  clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
}

.status-row select {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 2px solid var(--border-light);
  padding: 10px 16px;
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

.status-row select:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 15px var(--accent-glow);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 11: SECTION HEADERS
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.stats-section, .alert-section, .card-section {
  margin-bottom: 36px;
}

.section-header {
  display: flex;
  align-items: center;
  gap: 20px;
  padding-bottom: 18px;
  margin-bottom: 24px;
  border-bottom: 2px solid var(--border-mid);
  position: relative;
}

.section-header::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--metal-gradient);
}

.section-tag {
  background: var(--accent-primary);
  color: var(--bg-primary);
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 12px;
  padding: 6px 16px;
  letter-spacing: 2px;
  clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 6px 100%, 0 calc(100% - 6px));
  box-shadow: 0 0 15px var(--accent-glow);
}

.section-title {
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 18px;
  color: var(--text-primary);
  letter-spacing: 4px;
}

.section-time {
  margin-left: auto;
  font-family: var(--font-mono);
  font-size: 14px;
  color: var(--text-tertiary);
  animation: data-stream 2s ease-in-out infinite;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 12: STAT CARDS - KPI METRICS
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.stat-card {
  background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
  border: 2px solid var(--border-mid);
  padding: 24px;
  position: relative;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  overflow: hidden;
  animation: slide-in 0.5s ease-out;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0; right: 0;
  width: 20px; height: 20px;
  background: linear-gradient(135deg, var(--bg-primary) 50%, transparent 50%);
}

.stat-card::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0;
  width: 20px; height: 20px;
  background: linear-gradient(-45deg, var(--bg-primary) 50%, transparent 50%);
}

.stat-card:hover {
  border-color: var(--accent-primary);
  transform: translateY(-4px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 30px var(--accent-glow);
}

.stat-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
}

.stat-code {
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 16px;
  color: var(--accent-primary);
  letter-spacing: 2px;
}

.stat-suffix {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
}

.stat-num {
  font-family: var(--font-display);
  font-size: 48px;
  font-weight: 900;
  color: var(--text-primary);
  line-height: 1;
  margin: 12px 0;
  text-shadow: 0 0 30px rgba(255,255,255,0.1);
}

.stat-name {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-tertiary);
  letter-spacing: 2px;
  margin-bottom: 16px;
}

.stat-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 16px;
  border-top: 2px solid var(--border-mid);
  position: relative;
}

.stat-footer::before {
  content: '';
  position: absolute;
  top: -2px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--metal-gradient);
}

.stat-change {
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 700;
}

.stat-change.positive {
  color: var(--accent-primary);
  text-shadow: 0 0 10px var(--accent-glow);
}

.stat-change.negative {
  color: var(--color-critical);
  text-shadow: 0 0 10px var(--color-critical-glow);
}

.stat-status {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 4px 12px;
  letter-spacing: 1px;
  font-weight: 700;
}

.stat-status.nominal {
  background: var(--border-mid);
  color: var(--text-secondary);
}

.stat-status.warning {
  background: rgba(255,170,0,0.2);
  color: var(--color-warning);
  box-shadow: 0 0 10px var(--color-warning-glow);
}

.stat-status.critical {
  background: rgba(255,68,68,0.2);
  color: var(--color-critical);
  box-shadow: 0 0 10px var(--color-critical-glow);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 13: TWO COLUMN LAYOUT
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.two-column-layout {
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 28px;
  margin-top: 28px;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 14: ALERT FEED
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.alert-section {
  background: var(--bg-card);
  border: 2px solid var(--border-mid);
  overflow: hidden;
  box-shadow: 0 4px 24px rgba(0,0,0,0.4);
}

.alert-section .section-header {
  padding: 18px 24px;
  margin: 0;
  background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-card) 100%);
  border-bottom: 2px solid var(--border-mid);
}

.alert-list {
  max-height: 520px;
  overflow-y: auto;
}

.alert-item {
  display: grid;
  grid-template-columns: 110px 70px 80px 70px 1fr 36px;
  gap: 14px;
  padding: 16px 24px;
  border-bottom: 1px solid var(--border-dark);
  align-items: center;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.alert-item::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
  background: var(--border-light);
  transition: all 0.3s;
}

.alert-item:hover {
  background: rgba(0,255,136,0.03);
}

.alert-item:hover::before {
  background: var(--accent-primary);
  box-shadow: 0 0 15px var(--accent-glow);
}

.alert-item.priority-Critical::before {
  background: var(--color-critical);
  box-shadow: 0 0 10px var(--color-critical-glow);
}

.alert-item.priority-High::before {
  background: var(--color-warning);
  box-shadow: 0 0 10px var(--color-warning-glow);
}

.alert-id {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 700;
}

.alert-priority {
  font-family: var(--font-display);
  font-size: 11px;
  padding: 5px 10px;
  font-weight: 800;
  text-align: center;
  letter-spacing: 1px;
  clip-path: polygon(0 0, calc(100% - 5px) 0, 100% 5px, 100% 100%, 5px 100%, 0 calc(100% - 5px));
}

.alert-priority.p-critical {
  background: var(--color-critical);
  color: #fff;
  box-shadow: 0 0 10px var(--color-critical-glow);
}

.alert-priority.p-high {
  background: var(--color-warning);
  color: var(--bg-primary);
}

.alert-priority.p-medium {
  background: var(--border-highlight);
  color: var(--text-primary);
}

.alert-priority.p-low {
  background: var(--border-light);
  color: var(--text-secondary);
}

.alert-zone {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-tertiary);
  font-weight: 600;
}

.alert-time {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
}

.alert-content {
  font-size: 14px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 600;
}

.alert-arrow {
  color: var(--text-muted);
  font-family: var(--font-display);
  font-size: 18px;
  transition: all 0.3s;
}

.alert-item:hover .alert-arrow {
  color: var(--accent-primary);
  transform: translateX(4px);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 15: SIDE PANEL
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.side-panel-wrapper {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.side-panel-enhanced {
  background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
  border: 2px solid var(--border-mid);
  padding: 24px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.4);
}

.data-stream-widget {
  margin-bottom: 20px;
}

.widget-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 16px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--border-mid);
  position: relative;
}

.widget-header::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--metal-gradient);
}

.widget-title {
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 14px;
  color: var(--text-secondary);
  letter-spacing: 2px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.widget-title i {
  color: var(--accent-primary);
  font-size: 16px;
}

.live-indicator {
  width: 10px;
  height: 10px;
  background: var(--accent-primary);
  border-radius: 2px;
  animation: pulse-glow 1.5s ease-in-out infinite;
}

.live-metric-card {
  background: var(--bg-tertiary);
  border-left: 4px solid var(--accent-primary);
  padding: 18px;
  margin-bottom: 14px;
  transition: all 0.3s;
}

.live-metric-card:hover {
  background: var(--bg-elevated);
  transform: translateX(4px);
  box-shadow: 0 0 20px var(--accent-glow);
}

.metric-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.metric-label {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-secondary);
}

.metric-value {
  font-family: var(--font-display);
  font-weight: 900;
  font-size: 28px;
  color: var(--accent-primary);
  text-shadow: 0 0 15px var(--accent-glow);
}

.metric-mini-bar {
  height: 6px;
  background: var(--border-mid);
  overflow: hidden;
  border-radius: 3px;
}

.metric-mini-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
  background-size: 200% 100%;
  animation: shimmer 2s ease-in-out infinite, bar-fill 1s ease-out;
  border-radius: 3px;
}

.ai-insight-card {
  background: linear-gradient(135deg, rgba(68,170,255,0.08) 0%, var(--bg-card) 100%);
  border: 2px solid var(--border-mid);
  border-left: 4px solid var(--color-info);
  padding: 20px;
}

.ai-header {
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 13px;
  color: var(--color-info);
  letter-spacing: 2px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.ai-content {
  font-size: 14px;
  color: var(--text-secondary);
  line-height: 1.7;
  margin-bottom: 14px;
}

.ai-content strong {
  color: var(--accent-primary);
  font-weight: 700;
}

.ai-tags {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.ai-tag {
  background: var(--border-mid);
  color: var(--text-secondary);
  padding: 4px 12px;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1px;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 16: RESOURCE SECTION
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.resource-section-enhanced {
  background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
  border: 2px solid var(--border-mid);
  padding: 24px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.4);
}

.resource-section-enhanced .section-header {
  padding: 0 0 18px 0;
  margin-bottom: 24px;
}

.resource-item {
  margin-bottom: 20px;
}

.resource-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.resource-header .label {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  font-weight: 700;
  color: var(--text-secondary);
}

.resource-header .code {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent-primary);
  font-weight: 700;
}

.resource-header .percent {
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 18px;
  color: var(--text-primary);
}

.resource-bar {
  height: 10px;
  background: var(--border-mid);
  border: 1px solid var(--border-light);
  overflow: hidden;
  position: relative;
}

.resource-fill {
  height: 100%;
  position: relative;
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.resource-fill::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  background-size: 200% 100%;
  animation: shimmer 2s ease-in-out infinite;
}

.resource-fill.low {
  background: linear-gradient(90deg, var(--color-critical), #ff6666);
  box-shadow: inset 0 0 10px var(--color-critical-glow);
}

.resource-fill.medium {
  background: linear-gradient(90deg, var(--color-warning), #ffcc44);
  box-shadow: inset 0 0 10px var(--color-warning-glow);
}

.resource-fill.high {
  background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
  box-shadow: inset 0 0 10px var(--accent-glow);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 17: TASK CARDS
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.card-grid, .task-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 24px;
}

.jira-card {
  background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
  border: 2px solid var(--border-mid);
  padding: 24px;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  animation: slide-in 0.5s ease-out;
}

.jira-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
  background: var(--border-light);
  transition: all 0.3s;
}

.jira-card:hover {
  border-color: var(--accent-primary);
  transform: translateY(-4px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 30px var(--accent-glow);
}

.jira-card:hover::before {
  background: var(--accent-primary);
  box-shadow: 0 0 15px var(--accent-glow);
}

.jira-card.priority-Critical::before {
  background: var(--color-critical);
  box-shadow: 0 0 10px var(--color-critical-glow);
}

.jira-card.priority-High::before {
  background: var(--color-warning);
  box-shadow: 0 0 10px var(--color-warning-glow);
}

.card-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
}

.card-id {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-tertiary);
  font-weight: 700;
}

.status-tag {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 5px 14px;
  font-weight: 800;
  letter-spacing: 1px;
  background: var(--border-mid);
  color: var(--text-secondary);
}

.status-tag.status-4 {
  background: rgba(0,255,136,0.15) !important;
  color: var(--accent-primary) !important;
  box-shadow: 0 0 10px var(--accent-glow);
}

.status-tag.status-2 {
  background: rgba(255,170,0,0.15);
  color: var(--color-warning);
}

.status-tag.status-11 {
  background: rgba(68,170,255,0.15);
  color: var(--color-info);
}

.card-title {
  font-size: 17px;
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: 12px;
  line-height: 1.4;
}

.qty-badge {
  background: var(--accent-primary);
  color: var(--bg-primary);
  padding: 3px 10px;
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 800;
  margin-left: 10px;
}

.card-loc {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-loc i {
  color: var(--color-critical);
  font-size: 14px;
}

.card-detail {
  font-size: 13px;
  color: var(--text-tertiary);
  line-height: 1.5;
}

.card-sla {
  margin: 18px 0;
  padding-top: 18px;
  border-top: 2px solid var(--border-mid);
  position: relative;
}

.card-sla::before {
  content: '';
  position: absolute;
  top: -2px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--metal-gradient);
}

.sla-bar-container {
  height: 8px;
  background: var(--border-mid);
  overflow: hidden;
  margin-bottom: 10px;
}

.sla-bar {
  height: 100%;
  position: relative;
  transition: width 0.5s ease-out;
}

.sla-bar::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  background-size: 200% 100%;
  animation: shimmer 2s ease-in-out infinite;
}

.sla-info {
  display: flex;
  justify-content: space-between;
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-tertiary);
  font-weight: 700;
}

.sla-info.sla-critical {
  color: var(--color-critical) !important;
  text-shadow: 0 0 10px var(--color-critical-glow);
}

.sla-info.sla-warning {
  color: var(--color-warning) !important;
}

.sla-info.sla-ok {
  color: var(--accent-primary) !important;
}

.sla-remaining {
  display: flex;
  align-items: center;
  gap: 6px;
}

.card-footer {
  padding-top: 18px;
  border-top: 2px solid var(--border-mid);
  position: relative;
}

.card-footer::before {
  content: '';
  position: absolute;
  top: -2px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--metal-gradient);
}

.priority-badge {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 5px 14px;
  font-weight: 800;
  background: var(--border-mid);
  color: var(--text-secondary);
}

.priority-badge.priority-Critical {
  background: rgba(255,68,68,0.2);
  color: var(--color-critical);
  box-shadow: 0 0 10px var(--color-critical-glow);
}

.priority-badge.priority-High {
  background: rgba(255,170,0,0.2);
  color: var(--color-warning);
}

.btn-jira {
  background: transparent;
  border: 2px solid var(--border-light);
  color: var(--text-secondary);
  padding: 12px 20px;
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 1px;
  cursor: pointer;
  width: 100%;
  margin-top: 14px;
  transition: all 0.3s;
}

.btn-jira:hover {
  background: var(--bg-elevated);
  border-color: var(--border-highlight);
  transform: scale(1.02);
}

.btn-jira.progress {
  border-color: var(--color-info);
  color: var(--color-info);
}

.btn-jira.progress:hover {
  background: rgba(68,170,255,0.1);
  box-shadow: 0 0 20px rgba(68,170,255,0.3);
}

.btn-jira.success {
  border-color: var(--accent-primary);
  color: var(--accent-primary);
}

.btn-jira.success:hover {
  background: rgba(0,255,136,0.1);
  box-shadow: 0 0 20px var(--accent-glow);
}

.completed-msg {
  text-align: center;
  padding: 14px;
  background: rgba(0,255,136,0.08) !important;
  border: 2px solid var(--accent-primary) !important;
  color: var(--accent-primary) !important;
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 14px;
  transition: all 0.3s;
}

.completed-msg:hover {
  background: rgba(0,255,136,0.15) !important;
  box-shadow: 0 0 20px var(--accent-glow);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 18: EMPTY STATE
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.empty-board {
  padding: 80px 30px;
  text-align: center;
  color: var(--text-muted);
}

.empty-board i {
  font-size: 64px;
  margin-bottom: 24px;
  color: var(--border-light);
}

.empty-board h4 {
  font-family: var(--font-display);
  font-size: 24px;
  color: var(--text-tertiary);
  letter-spacing: 4px;
  margin: 16px 0;
}

.empty-board p {
  font-size: 15px;
  color: var(--text-muted);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 19: MODAL
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.modal-content {
  background: var(--bg-secondary) !important;
  border: 2px solid var(--border-light) !important;
  border-radius: 0 !important;
  box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 80px var(--accent-glow) !important;
  color: var(--text-primary) !important;
  font-family: var(--font-body) !important;
  overflow: visible !important;
  max-width: 980px;
  margin: 30px auto;
}

.modal-header-clean {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 22px 32px;
  background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
  border-bottom: 2px solid var(--border-mid);
}

.header-badge {
  background: var(--accent-primary);
  color: var(--bg-primary);
  padding: 7px 18px;
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 1px;
  clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
  box-shadow: 0 0 20px var(--accent-glow);
}

.header-id {
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 18px;
  color: var(--text-primary);
  margin-left: 18px;
}

.header-close {
  background: transparent;
  border: 2px solid var(--border-light);
  color: var(--text-tertiary);
  width: 44px;
  height: 44px;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.header-close:hover {
  background: var(--color-critical);
  border-color: var(--color-critical);
  color: #fff;
}

.modal-body-grid {
  display: grid;
  grid-template-columns: 1fr 360px;
  max-height: 72vh;
  overflow: hidden;
}

.body-main {
  padding: 32px;
  border-right: 2px solid var(--border-mid);
  overflow-y: auto;
  max-height: 72vh;
  position: relative;
}

.body-main::after {
  content: '';
  position: absolute;
  top: 0; right: -2px;
  width: 2px; height: 100%;
  background: var(--metal-gradient);
  transform: rotate(90deg);
}

.body-sidebar {
  background: var(--bg-tertiary);
  padding: 32px;
  overflow-y: auto;
  max-height: 72vh;
}

.ticket-title {
  font-family: var(--font-display);
  font-size: 24px;
  font-weight: 800;
  color: var(--text-primary);
  margin: 0 0 28px 0;
  padding-bottom: 20px;
  border-bottom: 2px solid var(--border-mid);
  letter-spacing: 1px;
  position: relative;
}

.ticket-title::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--metal-gradient);
}

.qty-badge-black {
  background: var(--accent-primary);
  color: var(--bg-primary);
  padding: 4px 14px;
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 800;
  margin-left: 14px;
}

.action-bar {
  display: flex;
  gap: 14px;
  margin-bottom: 28px;
  flex-wrap: wrap;
}

.btn-purple-outline, .btn-normal {
  background: transparent;
  border: 2px solid var(--border-light);
  color: var(--text-secondary);
  padding: 12px 22px;
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 1px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-purple-outline:hover, .btn-normal:hover {
  background: var(--bg-elevated);
  border-color: var(--border-highlight);
}

.action-btn {
  background: var(--accent-primary) !important;
  color: var(--bg-primary) !important;
  border: none !important;
  padding: 12px 22px;
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 1px;
  cursor: pointer;
  clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
  transition: all 0.3s;
}

.action-btn:hover {
  background: var(--accent-secondary) !important;
  transform: scale(1.03);
}

.desc-box {
  background: var(--bg-tertiary);
  border: 2px solid var(--border-mid);
  border-left: 4px solid var(--accent-primary);
  padding: 24px;
  margin-bottom: 28px;
}

.desc-section-title {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-tertiary);
  margin-bottom: 18px;
  letter-spacing: 2px;
}

.desc-grid {
  display: grid;
  gap: 16px;
}

.desc-item {
  display: flex;
  gap: 16px;
  align-items: flex-start;
  font-size: 15px;
  color: var(--text-secondary);
}

.desc-icon {
  width: 28px;
  text-align: center;
  color: var(--accent-primary);
  font-size: 18px;
}

.desc-label {
  font-weight: 800;
  color: var(--text-tertiary);
  margin-right: 10px;
}

.activity-area {
  margin-top: 28px;
}

.note-input {
  width: 100%;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-light);
  color: var(--text-primary);
  padding: 16px;
  min-height: 100px;
  margin-bottom: 14px;
  font-family: var(--font-body);
  font-size: 15px;
  resize: vertical;
}

.note-input:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 20px var(--accent-glow);
}

.submit-btn {
  background: var(--border-light);
  color: var(--text-muted);
  border: none;
  padding: 12px 24px;
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 1px;
  cursor: not-allowed;
  float: right;
}

.submit-btn.ready {
  background: var(--accent-primary);
  color: var(--bg-primary);
  cursor: pointer;
}

.submit-btn.ready:hover {
  background: var(--accent-secondary);
}

.sidebar-block {
  margin-bottom: 26px;
  padding-bottom: 22px;
  border-bottom: 2px solid var(--border-mid);
  position: relative;
}

.sidebar-block::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--metal-gradient);
}

.sb-label {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 2px;
  margin-bottom: 12px;
}

.user-row {
  display: flex;
  align-items: center;
  gap: 14px;
}

.avatar-box {
  width: 44px;
  height: 44px;
  background: var(--accent-primary);
  color: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-weight: 900;
  font-size: 20px;
  flex-shrink: 0;
}

.avatar-box.orange {
  background: var(--color-warning);
}

.user-name-text {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
}

.state-indicator {
  padding: 10px 20px;
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 1px;
  display: inline-block;
  color: #fff;
}

.priority-btn {
  background: var(--border-mid);
  color: var(--text-secondary);
  padding: 10px 18px;
  font-family: var(--font-mono);
  font-weight: 700;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.sla-progress {
  height: 10px;
  background: var(--border-mid);
  overflow: hidden;
  margin-bottom: 12px;
}

.sla-fill {
  height: 100%;
  position: relative;
}

.sla-fill::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  background-size: 200% 100%;
  animation: shimmer 2s ease-in-out infinite;
}

.sla-text {
  display: flex;
  justify-content: space-between;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-tertiary);
  margin-bottom: 12px;
}

.sla-badge {
  background: var(--border-mid);
  color: var(--text-secondary);
  padding: 8px 16px;
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 800;
  letter-spacing: 1px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.sla-badge.sla-critical {
  background: rgba(255,68,68,0.2);
  color: var(--color-critical);
  box-shadow: 0 0 10px var(--color-critical-glow);
}

.sla-badge.sla-ok {
  background: rgba(0,255,136,0.15);
  color: var(--accent-primary);
  box-shadow: 0 0 10px var(--accent-glow);
}

.dropdown-wrapper {
  position: relative;
  display: inline-block;
}

.status-menu {
  position: absolute;
  top: 100%;
  left: 0;
  background: var(--bg-secondary);
  border: 2px solid var(--border-light);
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  z-index: 100;
  min-width: 200px;
}

.status-item {
  padding: 14px 22px;
  cursor: pointer;
  font-size: 14px;
  border-bottom: 1px solid var(--border-dark);
  color: var(--text-secondary);
  font-weight: 700;
  transition: all 0.2s;
}

.status-item:hover {
  background: var(--bg-elevated);
  color: var(--text-primary);
}

.status-item.danger {
  color: var(--color-critical);
}

.status-item.danger:hover {
  background: rgba(255,68,68,0.15);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 20: SCROLLBAR
   ═══════════════════════════════════════════════════════════════════════════════════════ */
.kokoro-volunteer-container::-webkit-scrollbar,
.alert-list::-webkit-scrollbar,
.body-main::-webkit-scrollbar,
.body-sidebar::-webkit-scrollbar {
  width: 8px;
}

.kokoro-volunteer-container::-webkit-scrollbar-track,
.alert-list::-webkit-scrollbar-track,
.body-main::-webkit-scrollbar-track,
.body-sidebar::-webkit-scrollbar-track {
  background: var(--bg-primary);
}

.kokoro-volunteer-container::-webkit-scrollbar-thumb,
.alert-list::-webkit-scrollbar-thumb,
.body-main::-webkit-scrollbar-thumb,
.body-sidebar::-webkit-scrollbar-thumb {
  background: var(--border-light);
  border-radius: 4px;
}

.kokoro-volunteer-container::-webkit-scrollbar-thumb:hover,
.alert-list::-webkit-scrollbar-thumb:hover,
.body-main::-webkit-scrollbar-thumb:hover,
.body-sidebar::-webkit-scrollbar-thumb:hover {
  background: var(--accent-primary);
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 21: HAMBURGER MENU &amp; SIDEBAR - 完整集成
   ═══════════════════════════════════════════════════════════════════════════════════════ */

/* 1. Hamburger Button */
.hamburger-btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border-mid);
  margin-right: 15px;
  cursor: pointer;
  background: var(--bg-primary);
  transition: all 0.2s;
  flex-shrink: 0;
}

.hamburger-btn:hover {
  background: var(--text-primary);
  border-color: var(--text-primary);
}

.hamburger-btn:hover i {
  color: var(--bg-primary);
}

.hamburger-btn i {
  font-size: 18px;
  color: var(--text-primary);
  transition: color 0.2s;
}

/* Sidebar (修复版: 修复透明度与层级) */
.zen-sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 280px;
  height: 100vh;
  /* 强制白色背景，防止透明 */
  background-color: #ffffff !important; 
  background: #ffffff !important;
  border-right: 2px solid var(--border-dark);
  /* 提高 z-index 确保在遮罩层之上 (遮罩层通常是 99998) */
  z-index: 100000 !important; 
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  /* 增加阴影以区分层级 */
  box-shadow: 2px 0 15px rgba(0,0,0,0.2); 
}

.zen-sidebar.active {
  transform: translateX(0);
}

.zen-sidebar.active {
  transform: translateX(0);
}

/* 3. Sidebar Header */
.sidebar-head {
  height: 60px;
  border-bottom: 2px solid var(--text-primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 20px;
  background: var(--bg-tertiary);
}

.sb-title {
  font-family: var(--font-display);
  font-weight: 900;
  font-size: 18px;
  letter-spacing: 2px;
  color: var(--text-primary);
}

.sb-close {
  background: none;
  border: none;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  color: var(--text-primary);
  transition: all 0.2s;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sb-close:hover {
  background: var(--text-primary);
  color: var(--bg-primary);
}

/* 4. Sidebar Profile */
.sb-profile {
  padding: 30px 20px;
  border-bottom: 1px solid var(--border-mid);
  display: flex;
  align-items: center;
  gap: 15px;
  background: var(--bg-secondary);
}

.sb-avatar {
  width: 48px;
  height: 48px;
  background: var(--text-primary);
  color: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 20px;
  font-family: var(--font-display);
  flex-shrink: 0;
}

.sb-name {
  font-weight: 800;
  font-size: 16px;
  margin-bottom: 4px;
  color: var(--text-primary);
}

.sb-role {
  font-size: 10px;
  font-family: var(--font-mono);
  color: var(--text-tertiary);
}

/* 5. Navigation List */
.sb-nav-list {
  list-style: none;
  padding: 0;
  margin: 0;
  flex: 1;
  overflow-y: auto;
}

.sb-nav-list li {
  padding: 18px 24px;
  border-bottom: 1px solid var(--border-light);
  cursor: pointer;
  font-family: var(--font-body);
  font-weight: 700;
  font-size: 16px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  color: var(--text-secondary);
}

.sb-nav-list li:hover {
  background: var(--text-primary);
  color: var(--bg-primary);
}

.sb-nav-list li:hover .nav-num {
  color: var(--text-tertiary);
}

.nav-num {
  font-family: var(--font-display);
  font-size: 11px;
  color: var(--text-tertiary);
  margin-right: 12px;
  width: 20px;
  font-weight: 800;
}

.sb-nav-list li.divider {
  height: 20px;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border-light);
  padding: 0;
  cursor: default;
}

/* 6. Sidebar Footer */
.sb-footer {
  padding: 20px;
  font-size: 11px;
  color: var(--text-tertiary);
  text-align: center;
  border-top: 2px solid var(--text-primary);
  background: var(--bg-tertiary);
  font-family: var(--font-mono);
  letter-spacing: 1px;
}

/* 7. Backdrop */
.zen-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(2px);
  z-index: 99998;
  display: none;
}

.zen-backdrop.active {
  display: block;
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 22: RESPONSIVE
   ═══════════════════════════════════════════════════════════════════════════════════════ */
@media (max-width: 1200px) {
  .two-column-layout {
    grid-template-columns: 1fr;
  }
  
  .modal-body-grid {
    grid-template-columns: 1fr;
  }
  
  .body-sidebar {
    border-right: none;
    border-top: 2px solid var(--border-mid);
  }
  
  .board-container {
    padding: 20px;
    width: 100% !important; /* 确保移动端也铺满 */
  }
}

@media (max-width: 768px) {
  .command-header {
    padding: 16px 20px;
    flex-wrap: nowrap;
    gap: 12px;
  }
  
  .logo-text {
    display: none;
  }
  
  .system-status {
    margin-left: auto;
    gap: 12px;
  }
  
  .nav-tabs-custom {
    padding: 0 20px;
    overflow-x: auto;
  }
  
  .board-container {
    padding: 20px;
  }
  
  .volunteer-status-panel {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }
  
  .stats-row {
    grid-template-columns: 1fr 1fr;
  }
  
  .alert-item {
    grid-template-columns: auto 1fr auto;
  }
  
  .alert-zone, .alert-time {
    display: none;
  }
}

/* ═══════════════════════════════════════════════════════════════════════════════════════
   PART 23: INTERACTIONS
   ═══════════════════════════════════════════════════════════════════════════════════════ */
button, .btn-jira, .btn-online, .btn-offline, .tab, .alert-item, .jira-card, .stat-card {
  pointer-events: auto !important;
  cursor: pointer !important;
}

.clickable {
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

.kokoro-volunteer-container * {
  box-sizing: border-box;
}

/* ═════════════════════════════════════════════════════════════════════
   COMPONENT: SYSTEM ALERT STRIP (终末地风格 - 战术警示带)
   ═════════════════════════════════════════════════════════════════════ */

.sys-alert-strip {
    /* 布局定位 */
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    height: 48px;
    padding: 0 24px;
    gap: 16px;

    /* 视觉风格：白底红线，而非红底白字 */
    background-color: var(--bg-primary); /* 纯白底 */
    border-bottom: 2px solid var(--signal-crimson); /* 底部加上红色信号线 */
    
    /* 装饰性背景：淡红色斜纹 (Hatched Pattern) */
    background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(207, 34, 46, 0.03) 10px,
        rgba(207, 34, 46, 0.03) 20px
    );
    
    /* 字体设置 */
    font-family: var(--font-mono);
    font-size: 13px;
    color: var(--signal-crimson); /* 警示红字 */
    z-index: 1000;
}

/* 左侧装饰块：/// SYSTEM_OVERRIDE /// */
.alert-deco {
    font-weight: 800;
    letter-spacing: 0.1em;
    opacity: 0.5;
    white-space: nowrap;
    display: none; /* 移动端隐藏 */
}
/* 桌面端显示装饰块 */
@media (min-width: 992px) {
    .alert-deco { display: block; }
}

/* 中间消息主体 */
.alert-body {
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center; /* 居中对齐 */
    gap: 12px;
}

.alert-body i {
    font-size: 16px;
    animation: blink-red 2s infinite; /* 呼吸灯动画 */
}

.alert-text {
    font-family: var(--font-ui); /* 使用 Rajdhani 字体 */
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* 右侧按钮：幽灵按钮风格 */
.sys-btn-ghost {
    background: transparent;
    border: 1px solid var(--signal-crimson);
    color: var(--signal-crimson);
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 700;
    padding: 6px 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
}

.sys-btn-ghost:hover {
    background: var(--signal-crimson);
    color: #FFFFFF;
    box-shadow: 0 0 10px var(--color-critical-glow);
}

/* 呼吸灯动画定义 */
@keyframes blink-red {
    0% { opacity: 1; text-shadow: 0 0 0px var(--signal-crimson); }
    50% { opacity: 0.4; text-shadow: 0 0 10px var(--signal-crimson); }
    100% { opacity: 1; text-shadow: 0 0 0px var(--signal-crimson); }
}

/* ═════════════════════════════════════════════════════════════════════
   PART 28: TACTICAL ROSTER STYLES (NEW)
   ═════════════════════════════════════════════════════════════════════ */

.roster-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 20px;
    padding-bottom: 40px;
}

.roster-card {
    background: #fff;
    border: 1px solid #ccc;
    position: relative;
    padding: 16px;
    transition: all 0.2s;
    /* 装饰性切角 */
    clip-path: polygon(
        0 0, 
        100% 0, 
        100% calc(100% - 10px), 
        calc(100% - 10px) 100%, 
        0 100%
    );
}

.roster-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-color: #000;
}

.roster-card.is-self {
    border: 2px solid #000;
    background: #fafafa;
}

/* Head */
.roster-head {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 1px dashed #eee;
}

.roster-avatar {
    width: 42px; 
    height: 42px;
    background: #eee;
    color: #666;
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 18px;
    border-radius: 2px;
}
.roster-avatar.online { background: #000; color: #fff; }
.roster-avatar.busy { background: var(--color-warning); color: #fff; }

.roster-identity {
    flex: 1;
    overflow: hidden;
}

.roster-name {
    font-weight: 800;
    font-size: 14px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    font-family: var(--font-ui);
}

.roster-id {
    font-family: var(--font-mono);
    font-size: 10px; color: #999;
    letter-spacing: 1px;
}

.roster-status-light {
    width: 8px; height: 8px; border-radius: 50%;
    background: #ccc;
    box-shadow: 0 0 5px #ccc;
}
.roster-status-light.online { background: var(--color-success); box-shadow: 0 0 5px var(--color-success); }
.roster-status-light.busy { background: var(--color-warning); box-shadow: 0 0 5px var(--color-warning); }

/* Body */
.roster-body {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 15px;
}

.roster-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
}

.r-label { font-family: var(--font-mono); color: #999; }
.r-val { font-weight: 700; color: #333; }

.r-badge {
    padding: 2px 6px;
    border-radius: 2px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
}
.r-badge.online { background: rgba(52, 199, 89, 0.1); color: var(--color-success); }
.r-badge.busy { background: rgba(255, 149, 0, 0.1); color: var(--color-warning); }
.r-badge.offline { background: #eee; color: #999; }

/* Footer / Load */
.roster-footer {
    background: #f9f9f9;
    padding: 8px;
    border-radius: 2px;
}

.load-meta {
    display: flex; justify-content: space-between;
    font-size: 9px; font-weight: 700; color: #666;
    margin-bottom: 4px;
    font-family: var(--font-mono);
}

.load-track {
    height: 4px;
    background: #e0e0e0;
    overflow: hidden;
    border-radius: 2px;
}

.load-bar {
    height: 100%;
    background: var(--color-success);
    transition: width 0.3s;
}
.load-bar.overload { background: var(--color-warning); }

/* Decor */
.corner-decor {
    position: absolute;
    width: 6px; height: 6px;
    border: 1px solid #999;
}
.corner-decor.top-right { top: 4px; right: 4px; border-left: none; border-bottom: none; }
.corner-decor.bottom-left { bottom: 4px; left: 4px; border-right: none; border-top: none; }

/* ═════════════════════════════════════════════════════════════════════
   PART 30: TCG CARDS &amp; MODAL (POKEMON STYLE)
   ═════════════════════════════════════════════════════════════════════ */

/* --- 卡牌容器 --- */
.roster-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* 更窄一点，像卡牌 */
    gap: 20px;
    padding-bottom: 40px;
}

/* --- 单张卡牌 (TCG Style) --- */
.tcg-card {
    background: #fff;
    border: 4px solid #e0e0e0; /* 厚边框 */
    border-radius: 8px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.tcg-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    border-color: var(--accent-primary); /* 悬停变色 */
    z-index: 10;
}

/* 顶部标签 */
.tcg-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    font-size: 10px;
    font-weight: 800;
    color: #666;
}
.tcg-status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: #ccc;
}
.tcg-status-dot.online { background: var(--color-success); box-shadow: 0 0 4px var(--color-success); }
.tcg-status-dot.busy { background: var(--color-warning); }

/* 图片区域 */
.tcg-image-box {
    width: 100%;
    aspect-ratio: 1 / 1; /* 正方形 */
    background: #f0f0f0;
    border: 1px solid #ccc;
    margin-bottom: 8px;
    overflow: hidden;
    position: relative;
}

.tcg-avatar {
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    display: flex; align-items: center; justify-content: center;
    font-size: 40px; font-weight: 900; color: rgba(0,0,0,0.1);
}

/* 信息区域 */
.tcg-info {
    text-align: center;
}
.tcg-name {
    font-weight: 800; font-size: 13px; color: #000;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.tcg-id {
    font-size: 9px; color: #999; margin-bottom: 6px;
    font-family: var(--font-mono);
}

/* 属性条 */
.tcg-stats {
    background: #f9f9f9;
    padding: 4px;
    border-radius: 4px;
}
.stat-row {
    display: flex; align-items: center; justify-content: space-between;
    font-size: 9px;
}
.stat-bar-track {
    width: 60px; height: 4px; background: #ddd; border-radius: 2px;
}
.stat-bar-fill {
    height: 100%; background: var(--accent-primary);
}
.stat-bar-fill.alert { background: var(--color-warning); }


/* --- MODAL / DOSSIER (弹窗样式) --- */
.operator-modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6); /* 黑色半透明遮罩 */
    backdrop-filter: blur(4px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
}

.operator-dossier {
    width: 600px;
    max-width: 90%;
    background: #fff;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    border: 1px solid #000;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.dossier-header {
    background: #000;
    color: #fff;
    padding: 10px 15px;
    display: flex; justify-content: space-between; align-items: center;
    font-family: var(--font-mono);
    letter-spacing: 1px;
}
.dh-close { cursor: pointer; opacity: 0.7; }
.dh-close:hover { opacity: 1; }

.dossier-content {
    display: flex;
    padding: 20px;
    gap: 20px;
}

/* 弹窗左侧 */
.dossier-left {
    width: 180px;
    text-align: center;
}
.dossier-photo {
    width: 100%; aspect-ratio: 3/4;
    background: #eee;
    background-size: cover; background-position: center;
    border: 2px solid #000;
    margin-bottom: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 60px; color: #ccc; font-weight: 800;
}
.dossier-status-badge {
    padding: 4px 0;
    background: #eee; color: #999;
    font-weight: 800; font-size: 12px;
    text-transform: uppercase;
}
.dossier-status-badge.online { background: var(--color-success); color: #fff; }
.dossier-status-badge.busy { background: var(--color-warning); color: #fff; }

/* 弹窗右侧 */
.dossier-right {
    flex: 1;
}
.dr-name { font-size: 24px; font-weight: 900; line-height: 1; text-transform: uppercase; }
.dr-role { font-size: 14px; color: #666; margin-bottom: 20px; font-family: var(--font-mono); }

.dr-section { margin-bottom: 15px; }
.dr-label { font-size: 10px; color: #999; font-weight: 700; margin-bottom: 4px; letter-spacing: 1px;}
.dr-value-box { 
    font-size: 16px; font-weight: 800; 
    border-left: 3px solid var(--accent-primary); 
    padding-left: 10px; 
}

.dr-load-display { display: flex; align-items: baseline; gap: 8px; }
.big-num { font-size: 32px; font-weight: 900; line-height: 1; }
.sub-text { font-size: 12px; color: #666; }

.dossier-bar-track { height: 6px; background: #eee; margin-top: 5px; width: 100%; }
.dossier-bar-fill { height: 100%; background: #000; width: 0; transition: width 0.5s; }

/* 底部按钮 */
.dossier-actions {
    padding: 15px 20px;
    border-top: 1px solid #eee;
    display: flex; justify-content: flex-end; gap: 10px;
    background: #fafafa;
}
.dossier-btn {
    border: none; padding: 8px 16px; font-weight: 700; font-size: 12px; cursor: pointer;
}
.dossier-btn.ghost { background: transparent; border: 1px solid #ccc; color: #333; }
.dossier-btn.ghost:hover { border-color: #000; }
.dossier-btn.primary { background: #000; color: #fff; }
.dossier-btn.primary:hover { background: var(--accent-primary); }

@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* 进度条轨道 */
.dossier-bar-track {
    position: relative;
    width: 100%;
    height: 6px;       /* 根据你的设计调整高度 */
    background-color: #eee; /* 灰色底色 */
    border-radius: 3px;
    margin-top: 5px;
    
    /* ★★★ 必须添加这一行：溢出隐藏 ★★★ */
    overflow: hidden; 
}

/* 进度条填充 */
.dossier-bar-fill {
    height: 100%;
    background-color: #000; /* 黑色填充，根据你的截图 */
    border-radius: 3px;
    transition: width 0.3s ease; /* 增加平滑动画 */
}

/* ═══════════════════════════════════════════════════════════════
   PART: COMMS CENTER STYLES
   ═══════════════════════════════════════════════════════════════ */

/* --- Broadcast Composer --- */
.broadcast-composer {
    background: #fff;
    border: 1px solid #ddd;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

.broadcast-type-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.broadcast-type-btn {
    flex: 1;
    padding: 10px 16px;
    border: 2px solid #e0e0e0;
    background: #fff;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.broadcast-type-btn:hover { border-color: #999; }

.broadcast-type-btn.active {
    border-color: #000;
    background: #000;
    color: #fff;
}

.broadcast-type-btn:first-child.active {
    background: #cf222e;
    border-color: #cf222e;
}

.broadcast-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.broadcast-title-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #ddd;
    font-size: 16px;
    font-weight: 700;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.broadcast-title-input:focus { border-color: #000; }

.broadcast-body-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #ddd;
    font-size: 14px;
    resize: vertical;
    min-height: 80px;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.broadcast-body-input:focus { border-color: #000; }

.broadcast-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.broadcast-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: #999;
}

.broadcast-type-label {
    padding: 3px 8px;
    font-weight: 700;
    font-size: 11px;
    border-radius: 2px;
}

.broadcast-type-label.type-emergency { background: rgba(207,34,46,0.1); color: #cf222e; }
.broadcast-type-label.type-announcement { background: rgba(210,153,34,0.1); color: #d29922; }
.broadcast-type-label.type-internal { background: rgba(0,0,0,0.05); color: #666; }

.broadcast-send-btn {
    padding: 10px 24px;
    background: #e0e0e0;
    color: #999;
    border: none;
    font-weight: 800;
    font-size: 13px;
    letter-spacing: 1px;
    cursor: not-allowed;
    transition: all 0.2s;
}

.broadcast-send-btn.ready {
    background: #000;
    color: #fff;
    cursor: pointer;
}

.broadcast-send-btn.ready:hover {
    background: #333;
    transform: translateY(-1px);
}

/* --- Timeline --- */
.comms-timeline {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 600px;
    overflow-y: auto;
    padding-right: 8px;
}

.comm-item {
    background: #fff;
    border: 1px solid #e0e0e0;
    display: flex;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
}

.comm-item:hover {
    border-color: #999;
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.comm-priority-bar {
    width: 4px;
    flex-shrink: 0;
    background: #e0e0e0;
}

.comm-priority-bar.bar-emergency { background: #cf222e; }
.comm-priority-bar.bar-announcement { background: #d29922; }
.comm-priority-bar.bar-internal { background: #999; }

.comm-content {
    flex: 1;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.comm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comm-type-badge {
    font-size: 11px;
    font-weight: 800;
    padding: 2px 8px;
    border-radius: 2px;
    letter-spacing: 1px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.comm-type-badge.badge-emergency { background: rgba(207,34,46,0.1); color: #cf222e; }
.comm-type-badge.badge-announcement { background: rgba(210,153,34,0.1); color: #d29922; }
.comm-type-badge.badge-internal { background: rgba(0,0,0,0.05); color: #666; }

.comm-time { font-size: 11px; color: #999; }
.comm-title { font-weight: 800; font-size: 16px; color: #1a1a1a; }
.comm-body-preview { font-size: 13px; color: #666; line-height: 1.5; }

.comm-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #999;
    padding-top: 8px;
    border-top: 1px dashed #eee;
}

.comm-author { font-weight: 600; }

/* --- Detail Overlay --- */
.comm-detail-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 3000;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.comm-detail-panel {
    background: #fff;
    width: 100%;
    max-width: 640px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    position: relative;
}

.comm-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comm-detail-body {
    font-size: 15px;
    line-height: 1.8;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

/* --- Filter Button Active State --- */
.btn-jira.active {
    background: #000 !important;
    color: #fff !important;
    border-color: #000 !important;
}
/* --- Delete Confirm Modal --- */
.delete-confirm-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 4000;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.15s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.delete-confirm-panel {
    background: #fff;
    width: 420px;
    max-width: 90vw;
    padding: 32px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.2s ease;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.delete-confirm-icon {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: rgba(207,34,46,0.1);
    color: #cf222e;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.delete-confirm-title {
    font-size: 18px;
    font-weight: 800;
    margin: 0 0 16px;
    color: #1a1a1a;
}

.delete-confirm-msg-info {
    background: #f8f8f8;
    padding: 12px 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    font-size: 14px;
}

.delete-confirm-warning {
    font-size: 12px;
    color: #999;
    margin-bottom: 24px;
}

.delete-confirm-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.delete-btn-cancel {
    padding: 10px 28px;
    background: #f0f0f0;
    border: 1px solid #ddd;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.delete-btn-cancel:hover {
    background: #e0e0e0;
}

.delete-btn-confirm {
    padding: 10px 28px;
    background: #cf222e;
    color: #fff;
    border: none;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.delete-btn-confirm:hover {
    background: #a71d2a;
    transform: translateY(-1px);
}  

</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>kokoro_volunteer</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Kokoro Volunteer Dashboard</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    // ==========================================
    // MODULE 1: 处理前端动作 (Action Handling)
    // ==========================================
    
    // 1.1 [FIX] 处理 Capability 保存
    if (input && input.action === 'specialty') {
        var capGr = new GlideRecord('x_1821654_kokoro_0_volunteer_capability');
        capGr.addQuery('volunteer', input.target_id); 
        capGr.query();
        
        if (capGr.next()) {
            capGr.setValue('specialty', input.new_cap); 
            capGr.update();
        } else {
            capGr.initialize();
            capGr.setValue('volunteer', input.target_id);
            capGr.setValue('specialty', input.new_cap); 
            capGr.insert();
        }
        gs.addInfoMessage('Capability Saved: ' + input.new_cap);
        return; 
    }
    
    // 1.2 [FIX] 处理任务分配
    if (input && input.action === 'assign_task') {
    var taskGr = new GlideRecord('x_1821654_kokoro_0_silent_wish');
    if (taskGr.get(input.ticket_id)) {
        taskGr.setValue('assigned_to', input.target_user);
        // 如果是 DRAFT(1) 或 SUBMITTED(10)，自动变为 ASSIGNED(11)
        var currentState = taskGr.getValue('state');
        if (currentState == '1' || currentState == '10') {
            taskGr.setValue('state', '11');
        }
        taskGr.update();
        data.success = true;
    } else {
        data.error = 'タスクが見つかりません';
    }
    return;
}
	
	// ============================================================
    // 1.3 [COMMS] 处理广播发送
    // ============================================================
    if (input && input.action === 'send_broadcast') {
        try {
            // 权限检查
            if (!gs.hasRole('x_1821654_kokoro_0.volunteer') && !gs.hasRole('admin')) {
                data.error = '権限がありません';
                return;
            }
            
            // 输入验证
            var bcTitle = sanitizeInput(input.title, 200);
            var bcBody = sanitizeInput(input.body, 4000);
            var bcType = input.msg_type || 'announcement';
            
            if (!bcTitle || !bcBody) {
                data.error = '件名と本文は必須です';
                return;
            }
            
            // 验证消息类型
            var validTypes = ['emergency', 'announcement', 'internal'];
            if (validTypes.indexOf(bcType) === -1) {
                bcType = 'announcement';
            }
            
            // 写入 emergency_message 表
            var bcGr = new GlideRecord('x_1821654_kokoro_0_emergency_message');
            bcGr.initialize();
            bcGr.setValue('user', gs.getUserID());
            bcGr.setValue('message_type', bcType);
            // 用分隔符合并标题和正文，读取时再拆分
            bcGr.setValue('message_encrypted', bcTitle + '\n---\n' + bcBody);
            bcGr.setValue('is_active', true);
            bcGr.setValue('created_at', new GlideDateTime());
            
            var newId = bcGr.insert();
            
            if (newId) {
                data.success = true;
                data.new_id = newId;
                
                // 记录流程事件
                logProcessEvent(newId, 'Broadcast sent: [' + bcType.toUpperCase() + '] ' + bcTitle, gs.getUserID());
            } else {
                data.error = '保存に失敗しました';
            }
        } catch (e) {
            data.error = '送信エラー: ' + e.message;
            gs.error('[Kokoro] Broadcast error: ' + e.message);
        }
        return;
    }
	
	// ============================================================
    // 1.4 [COMMS] 处理广播删除 (仅限 Admin)
    // ============================================================
    if (input && input.action === 'delete_broadcast') {
        try {
            // 严厉的权限检查：仅 admin 可操作
            if (!gs.hasRole('admin')) {
                data.error = 'Security Alert: Admin privilege required.';
                return;
            }

            var delSysId = input.sys_id;
            if (delSysId) {
                var delGr = new GlideRecord('x_1821654_kokoro_0_emergency_message');
                if (delGr.get(delSysId)) {
                    // 软删除：只标记为不活跃，不物理删除
                    delGr.setValue('is_active', false);
                    delGr.update();
                    
                    data.success = true;
                    data.deleted_id = delSysId;
                    gs.info('[Kokoro] Broadcast deactivated by Admin: ' + delSysId);
                }
            }
        } catch (e) {
            data.error = 'Delete failed: ' + e.message;
        }
        return;
    }

    // ==========================================
    // MODULE 2: 初始化环境 (Initialization)
    // ★★★ 必须放在数据加载之前，防止 push 报错 ★★★
    // ==========================================
    data.myTasks = [];
    data.list = [];
    data.volunteers = []; // [CRITICAL] 必须在此处初始化
    data.capabilityOptions = [];
    
    data.user_id = gs.getUserID();
    data.user_name = gs.getUserDisplayName();
    
    // 权限判断
    var isVolunteer = gs.hasRole('x_1821654_kokoro_0.volunteer') || gs.hasRole('admin');
    data.isVolunteer = isVolunteer;
	  data.isAdmin = gs.hasRole('admin');

    // ★★★ [FIX] 将 todayPM 提升到全局作用域 ★★★
    var todayPM = new GlideDateTime();
    todayPM.setDisplayValue(todayPM.getDate().toString());

    // ==========================================
    // MODULE 3: 数据加载 (Data Fetching)
    // ==========================================

    // 3.1 [FIX] 加载志愿者列表 (带异常捕获 + 正确的状态码)
    try {
        var volGr = new GlideRecord('sys_user');
        volGr.addQuery('active', true);
        // 如果需要过滤角色，请取消下一行的注释
        // volGr.addQuery('roles', 'x_1821654_kokoro_0.volunteer'); 
        volGr.setLimit(20); 
        volGr.query();
        
        while (volGr.next()) {
            var openTaskCount = 0;
            var volID = volGr.getUniqueValue();
            
            // 计算负载
            var taskAg = new GlideAggregate('x_1821654_kokoro_0_silent_wish');
            taskAg.addQuery('assigned_to', volID);
            
            // ★★★ 核心修复：排除已完成(4)和已取消(7)的任务 ★★★
            // 之前的代码排除的是 3 (通常是 Closed Complete 的旧标准)，但你的系统用的是 4
            taskAg.addQuery('state', '!=', '4'); // Exclude Closed Complete
            taskAg.addQuery('state', '!=', '7'); // Exclude Cancelled
            
            taskAg.addAggregate('COUNT');
            taskAg.query();
            
            if (taskAg.next()) {
                var count = taskAg.getAggregate('COUNT');
                openTaskCount = parseInt(count) || 0;
            }
            
            // 格式化负载显示 (保留1位小数)
            var rawLoad = (openTaskCount / 10) * 100;
            var finalLoad = isNaN(rawLoad) ? "0.0" : rawLoad.toFixed(1);

            data.volunteers.push({
                sys_id: volID,
                name: volGr.getValue('name') || 'Unknown',
                load: finalLoad
            });
        }
    } catch (e) {
        gs.error("[Dashboard Error] Loading volunteers failed: " + e.message);
    }

    // 3.2 [FIX] 获取 Capability 选项
    var choiceGr = new GlideRecord('sys_choice');
    choiceGr.addQuery('name', 'x_1821654_kokoro_0_volunteer_capability'); 
    choiceGr.addQuery('element', 'specialty'); 
    choiceGr.addQuery('language', gs.getSession().getLanguage()); 
    choiceGr.addQuery('inactive', false);
    choiceGr.orderBy('sequence');
    choiceGr.query();
    while (choiceGr.next()) {
        data.capabilityOptions.push({
            label: choiceGr.getValue('label'),
            value: choiceGr.getValue('value')
        });
    }
    // ==========================================
    // MODULE 4: 系统配置 (Configuration)
    // ==========================================
    var CONFIG = {
        tables: {
            SILENT_WISH: 'x_1821654_kokoro_0_silent_wish',
            INVENTORY: 'x_1821654_kokoro_0_kokoro_inventory',
            INVENTORY_TX: 'x_1821654_kokoro_0_kokoro_inventory_transact',
            PROCESS_EVENT: 'x_1821654_kokoro_0_process_event',
            USER_PROFILE: 'x_1821654_kokoro_0_user_profile', 
            EMERGENCY_MESSAGE: 'x_1821654_kokoro_0_emergency_message', 
            HEARTBEAT: 'x_1821654_kokoro_0_x_1821654_kokoro_0_heartbeat', // ★ 已确认保留原名，严禁修改
            VOL_CAPABILITY: 'x_1821654_kokoro_0_volunteer_capability' // [新增] 集中管理 Capability 表
        },
        // [架构师修正] 请确保这里的状态码与你的 ServiceNow 字典定义一致
        wishStates: {
            NEW: '1',          // Open/New
            IN_PROGRESS: '2',  // Work in Progress
            COMPLETED: '4',    // Closed Complete (HTML中使用的是4，这里必须统一)
            CANCELLED: '7'     // Cancelled
        },
        resourceKeys: ['food', 'water', 'medical', 'clothing', 'hygiene'],
        thresholds: {
            CRITICAL: 15, 
            WARNING: 35   
        }
    };
	
    // ==========================================
    // 2. 核心监察函数: 获取资源状态
    // ==========================================
function getResourceStatus() {
        // 1. 初始化固定顺序的空模板，确保索引 0-4 对应 HTML 的顺序
        // Order matches HTML: [0]Food, [1]Water, [2]Medical, [3]Clothing, [4]Hygiene
        var map = {
            'FOOD': 0,
            'WATR': 1,
            'MEDI': 2,
            'CLTH': 3,
            'HYGN': 4
        };
        
        var status = [
            { percent: 0, code: 'FOOD', label: '食料 (No Data)', status_color: 'danger' },
            { percent: 0, code: 'WATR', label: '飲料水 (No Data)', status_color: 'danger' },
            { percent: 0, code: 'MEDI', label: '医療品 (No Data)', status_color: 'danger' },
            { percent: 0, code: 'CLTH', label: '衣類 (No Data)', status_color: 'danger' },
            { percent: 0, code: 'HYGN', label: '衛生用品 (No Data)', status_color: 'danger' }
        ];

        var grInv = new GlideRecord(CONFIG.tables.INVENTORY);
        grInv.addActiveQuery();
        grInv.query();

        while (grInv.next()) {
            var code = grInv.getValue('item_code');
            var idx = map[code]; // 根据 Code 找到对应索引
            
            if (idx !== undefined) {
                var current = parseFloat(grInv.getValue('current_quantity')) || 0;
                var max = parseFloat(grInv.getValue('max_capacity')) || 100;
                var percentage = Math.round((current / max) * 100);

                status[idx] = {
                    label: grInv.getDisplayValue('item_name'),
                    code: code,
                    percent: percentage,
                    status_color: percentage < CONFIG.thresholds.CRITICAL ? 'danger' : 
                                 (percentage < CONFIG.thresholds.WARNING ? 'warning' : 'success')
                };
            }
        }
        return status;
    }
    data.resourceStatus = getResourceStatus();

    // ==========================================
    // 3. 企业级库存扣减逻辑 (事务性处理)
    // ==========================================
    function updateInventory(itemCode, quantity, wishId) {
        var grInv = new GlideRecord(CONFIG.tables.INVENTORY);
        grInv.addQuery('item_code', itemCode);
        grInv.query();

        if (grInv.next()) {
            var oldQty = parseFloat(grInv.getValue('current_quantity'));
            var newQty = oldQty - quantity;

            if (newQty < 0) return { success: false, message: '在庫不足' };

            // 1. 更新主表
            grInv.setValue('current_quantity', newQty);
            grInv.update();

            // 2. 插入交易表 (Audit Trail)
            var grTx = new GlideRecord(CONFIG.tables.INVENTORY_TX);
            grTx.initialize();
            grTx.setValue('inventory_item', grInv.getUniqueValue());
            grTx.setValue('type', 'disbursement');
            grTx.setValue('quantity', quantity);
            grTx.setValue('related_wish', wishId);
            grTx.insert();

            // 3. 记录流程事件
            logProcessEvent(wishId, 'Inventory Decr: ' + itemCode + ' (' + quantity + ')', gs.getUserID());
            return { success: true };
        }
        return { success: false, message: '物品コードが見つかりません' };
    }

    // ==========================================
    // 4. 输入处理: 当 Wish 状态变为 "In Progress" 时尝试锁定/扣减库存
    // ==========================================
    if (input && input.action === 'change_status' && input.new_state === '2') {
        var wishGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
        if (wishGr.get(input.sys_id)) {
            var category = wishGr.getValue('request_category'); 
            var qty = parseInt(wishGr.getValue('u_quantity')) || 1;
            
            if (category) {
                var invResult = updateInventory(category.toUpperCase(), qty, input.sys_id);
                if (!invResult.success) {
                    data.error = "在庫チェック失敗: " + invResult.message;
                    return;
                }
            }
        }
    }

    // === SLA统计 ===
    data.slaStats = {
        breached: 0,
        atRisk: 0,
        ok: 0
    };
    try {
        if (typeof x_1821654_kokoro_0.KokoroSLAEngine !== 'undefined') {
            var slaEngine = new x_1821654_kokoro_0.KokoroSLAEngine();
            
            var breachedWishes = slaEngine.getBreachedWishes();
            data.slaStats.breached = breachedWishes.length;
            
            var atRiskWishes = slaEngine.getAtRiskWishes(80);
            data.slaStats.atRisk = atRiskWishes.length;
        }
        
        var gaSLA = new GlideAggregate('x_1821654_kokoro_0_sla_task');
        gaSLA.addQuery('status', 'in_progress');
        gaSLA.addQuery('percentage', '<', 80);
        gaSLA.addAggregate('COUNT');
        gaSLA.query();
        if (gaSLA.next()) {
            data.slaStats.ok = parseInt(gaSLA.getAggregate('COUNT')) || 0;
        }
    } catch (e) {
        gs.debug('[Kokoro] SLA stats not available: ' + e.message);
    }

    // ==========================================
    // 工具函数
    // ==========================================
    function sanitizeInput(inputVal, maxLength) {
        if (!inputVal) return '';
        var cleaned = String(inputVal)
            .replace(/[<>\"'&]/g, '')
            .replace(/[\r\n]+/g, ' ')
            .trim();
        if (maxLength && cleaned.length > maxLength) {
            cleaned = cleaned.substring(0, maxLength);
        }
        return cleaned;
    }

    function validateSysId(sysId) {
        if (!sysId) return false;
        return /^[a-f0-9]{32}$/.test(String(sysId));
    }

    function logProcessEvent(caseId, activity, userId) {
        try {
            var pe = new GlideRecord(CONFIG.tables.PROCESS_EVENT);
            pe.initialize();
            pe.setValue('case_id', caseId || '');
            pe.setValue('activity', sanitizeInput(activity, 200));
            pe.setValue('timestamp', new GlideDateTime());
            pe.setValue('user', userId || gs.getUserID());
            pe.insert();
        } catch (e) {
            gs.error('[Kokoro] Process event log error: ' + e.message);
        }
    }

    // ==========================================
    // 状态验证器
    // ==========================================
    var StateValidator = {
        allowedTransitions: {
            '1':  ['10', '11', '5'],
            '10': ['1', '11', '5'],
            '11': ['10', '2', '5', '6'],
            '2':  ['4', '5', '6'],
            '4':  [],
            '5':  [],
            '6':  ['11', '2', '5']
        },
        
        validateTransition: function(fromState, toState) {
            fromState = String(fromState);
            toState = String(toState);
            
            if (!fromState || fromState === '' || fromState === 'undefined' || fromState === 'null') {
                return { valid: true };
            }
            
            if (!this.allowedTransitions.hasOwnProperty(fromState)) {
                return { valid: false, message: '無効な現在状態: ' + fromState };
            }
            
            var allowed = this.allowedTransitions[fromState];
            if (allowed.indexOf(toState) === -1) {
                return { 
                    valid: false, 
                    message: fromState + ' から ' + toState + ' への遷移は許可されていません' 
                };
            }
            
            return { valid: true };
        }
    };

    // ==========================================
    // 加载用户资料
    // ==========================================
    function loadUserProfile() {
        try {
            var grProfile = new GlideRecord(CONFIG.tables.USER_PROFILE);
            grProfile.addQuery('user', data.user_id);
            grProfile.setLimit(1);
            grProfile.query();

            if (grProfile.next()) {
                data.emergency_email = grProfile.getValue('emergency_conact_email') || "";
                data.medical_info = grProfile.getValue('medical_conditions') || "";
                data.blood_type = grProfile.getValue('blood_type') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Profile load error: " + e.message);
        }
    }

    function loadDigitalWill() {
        try {
            var grWill = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
            grWill.addQuery('user', data.user_id);
            grWill.addQuery('is_active', true);
            grWill.addQuery('message_type', 'Last_Will');
            grWill.orderByDesc('sys_created_on');
            grWill.setLimit(1);
            grWill.query();

            if (grWill.next()) {
                data.saved_will = grWill.getValue('message_encrypted') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Will load error: " + e.message);
        }
    }

    loadUserProfile();
    loadDigitalWill();

	// ==========================================
// [HELPER] AI Insight Generator (Light Mode)
// ==========================================
function generateAiInsight(urgency, category) {
    // 1. 模拟 AI 计算指标 (随机生成)
    var confidence = Math.floor(Math.random() * (99 - 85) + 85);
    var processingTime = (Math.random() * (0.8 - 0.1) + 0.1).toFixed(3);
    
    var html = "";

    // Line 1: 头部元数据 (Head Metadata)
    // 注意：这里移除了白色文字样式，改用深灰色 (#5f6368)
    html += "<div style='margin-bottom: 4px; font-size: 10px; color: #5f6368; font-family: sans-serif;'>";
    html += "<span class='ai-tag'>CONFIDENCE: " + confidence + "%</span> ";
    html += "<span class='ai-tag'>TIME: " + processingTime + "s</span>";
    html += "</div>";
    
    // Line 2: 核心分析 (Core Analysis)
    // 容器使用深色字体 (#202124)，行高稍微增加以提高可读性
    html += "<div style='margin-top:2px; font-family: \"Roboto Mono\", \"Courier New\", monospace; font-size: 11px; line-height: 1.5;'>";
    
    if (urgency == 'Critical' || urgency == '1') {
        // [CRITICAL] 使用深红色 (#d93025) 适配白底
        html += "<span style='color:#d93025; font-weight:800;'>[CRITICAL PATTERN]</span> ";
        html += "<span style='color:#202124;'>High-priority keyword cluster detected. </span>";
        html += "<span style='color:#d93025; font-weight:500;'>Action: Immediate escalation to Tier 2 required.</span>";
        
    } else if (category && category.toLowerCase().indexOf('food') > -1) {
        // [LOGISTICS] 使用深绿色 (#188038) 适配白底
        html += "<span style='color:#188038; font-weight:800;'>[LOGISTICS]</span> ";
        html += "<span style='color:#202124;'>Supply request identified. Inventory: Auto-verified. </span>";
        html += "<span style='color:#137333; font-weight:500;'>Optimization: Combine with Route #42 to save fuel.</span>";
        
    } else {
        // [STANDARD] 使用深科技蓝 (#1a73e8) 适配白底
        html += "<span style='color:#1a73e8; font-weight:800;'>[STANDARD]</span> ";
        html += "<span style='color:#202124;'>Routine request signature. NLP Sentiment: Neutral. </span>";
        html += "<span style='color:#5f6368;'>Rec: Standard fulfillment procedure (SOP-01).</span>";
    }
    
    html += "</div>";

    return html;
}
	
    // ==========================================
    // 构建任务项 (Integrated SLA & AI)
    // ==========================================
    function buildTaskItem(gr) {
        // [优化] 提前提取变量，供后续逻辑复用
        var urgencyVal = gr.getValue('urgency') || 'Medium'; 
        var categoryVal = gr.getValue('request_category') || '';
        
        var taskItem = {
            sys_id: gr.getUniqueValue(),
            number: gr.getValue('number') || '',
            
            // 使用提取的变量
            category: categoryVal, 
            category_display: gr.getDisplayValue('request_category') || '未分類',
            
            zone: gr.getDisplayValue('shelter_zone') || '',
            detail_loc: gr.getValue('precise_location') || gr.getValue('wish_content') || '',
            desc: gr.getValue('wish_content') || '',
            
            // 使用提取的变量
            urgency: urgencyVal, 
            
            contact: gr.getValue('u_contact_info') || '',
            reporter_name: gr.getDisplayValue('sys_created_by') || '一般ユーザー',
            assigned_to_name: gr.getDisplayValue('assigned_to') || '',
            assigned_to_id: gr.getValue('assigned_to') || '',
            state: parseInt(gr.getValue('state')) || 10,
            state_label: gr.getDisplayValue('state') || '',
            quantity: parseInt(gr.getValue('qty')) || 1,
            remarks: gr.getValue('wish_content') || '',
            affected_count: gr.getValue('u_affected_count') || '不明',
            history: [],
            attachments: [],
            sla: null,
            
            // === [新增] AI_INSIGHT 注入 ===
            // 这里调用上面的 helper 函数动态生成内容
            ai_analysis: generateAiInsight(
                urgencyVal, 
                categoryVal, 
                gr.getValue('state'), 
                gr.getValue('wish_content')
            )
            // ============================
        };
			
			// 时间计算
        var created = new GlideDateTime(gr.sys_created_on);
        var endTime = new GlideDateTime(); // 默认为当前时间
        var isCompleted = (taskItem.state == 4 || taskItem.state == 5); // 4:Completed, 5:Cancelled

        // 如果已完成，使用完成时间；如果没有完成时间字段，则回退到更新时间
        if (isCompleted) {
            var completedAtStr = gr.getValue('u_completed_at');
            if (completedAtStr) {
                endTime = new GlideDateTime(completedAtStr);
            } else {
                endTime = new GlideDateTime(gr.sys_updated_on);
            }
        }

        var diffMs = GlideDateTime.subtract(created, endTime).getNumericValue(); 
        var minutes = Math.floor(diffMs / 1000 / 60);
        
        // 显示用的"xx前"逻辑保持根据当前时间计算
        var nowForDisplay = new GlideDateTime();
        var diffDisplay = GlideDateTime.subtract(created, nowForDisplay).getNumericValue();
        var minutesDisplay = Math.floor(diffDisplay / 1000 / 60);

        if (minutesDisplay < 60) {
            taskItem.time_ago = minutesDisplay + "分前";
        } else if (minutesDisplay < 1440) {
            taskItem.time_ago = Math.floor(minutesDisplay / 60) + "時間前";
        } else {
            taskItem.time_ago = Math.floor(minutesDisplay / 1440) + "日前";
        }

        taskItem.created_on = gr.getDisplayValue('sys_created_on');

        // 默认 SLA 计算 (Fallback)
        if (!taskItem.sla) {
            var defaultTargets = {
                'Critical': 30, 'High': 60, 'Medium': 120, 'Low': 240
            };
            var target = defaultTargets[taskItem.urgency] || 120;
            
            // 如果已完成，状态强制修正
            var slaStatus = 'ok';
            var isBreached = minutes > target;
            
            if (isCompleted) {
                // 已完成的任务，即使超时，UI上也显示为特定的完成状态，或者保留超时记录但不再变色
                slaStatus = isBreached ? 'critical' : 'success'; 
            } else {
                slaStatus = minutes > target ? 'critical' : (minutes > target * 0.8 ? 'warning' : 'ok');
            }

            taskItem.sla = {
                elapsed: minutes,
                target: target,
                remaining: Math.max(0, target - minutes),
                percentage: Math.min(100, Math.round((minutes / target) * 100)),
                status: slaStatus,
                is_breached: isBreached,
                is_stopped: isCompleted // 标记为停止计时
            };
        }


        // 附件
        try {
            var att = new GlideRecord('sys_attachment');
            att.addQuery('table_sys_id', taskItem.sys_id);
            att.setLimit(1);
            att.orderByDesc('sys_created_on');
            att.query();
            if (att.next()) {
                taskItem.image_url = '/' + att.sys_id + '.iix';
            }
        } catch (e) {}

        // 活动历史
        try {
            var journal = new GlideRecord('sys_journal_field');
            journal.addQuery('element_id', taskItem.sys_id);
            journal.addQuery('element', 'work_notes');
            journal.orderByDesc('sys_created_on');
            journal.setLimit(10);
            journal.query();
            while (journal.next()) {
                taskItem.history.push({
                    user: journal.getDisplayValue('sys_created_by') || 'System',
                    text: journal.getValue('value') || '',
                    date: journal.getDisplayValue('sys_created_on')
                });
            }
        } catch (e) {}

        return taskItem;
    }
	
	// ==========================================
// V3.1 FINAL: 加载干员 (已根据 Volunteer Capability 表结构修复)
// ==========================================
function loadVolunteerList() {
    var volunteerList = [];
    var userIds = [];

    // 1. 【严谨筛选】只查询明确拥有 'volunteer' 角色的用户
    var roleGr = new GlideRecord('sys_user_has_role');
    roleGr.addQuery('role.name', 'x_1821654_kokoro_0.volunter'); // 请确保此处 role name 与系统设置完全一致
    roleGr.query();
    while (roleGr.next()) {
        var u = roleGr.getValue('user');
        if (userIds.indexOf(u) === -1) userIds.push(u);
    }

    // 防呆：如果列表为空，添加当前用户进行测试
    if (userIds.length === 0 || userIds.indexOf(gs.getUserID()) === -1) {
        userIds.push(gs.getUserID());
    }

    // 2. 查询用户基础信息
    var userGr = new GlideRecord('sys_user');
    userGr.addQuery('sys_id', 'IN', userIds);
    userGr.addQuery('active', true);
    userGr.query();

    while (userGr.next()) {
        var uid = userGr.getUniqueValue();
        
        // 3. 【精准查询】查询 Volunteer Capability 扩展表
        // 根据 image_2ef521.png，关联字段名为 'volunteer'
        var capStr = "General Support";
        var currentLoad = 0;
        var maxLoad = 5;
        var isAvailable = false;
        
        var capGr = new GlideRecord('x_1821654_kokoro_0_volunteer_capability');
        capGr.addQuery('volunteer', uid); 
        capGr.query();
        
        if (capGr.next()) {
            // 获取技能与专长 
            var specialty = capGr.getDisplayValue('specialty');
            var skills = capGr.getValue('skills');
            capStr = specialty || skills || "General Support";
            
            // 获取任务负载数据 
            currentLoad = parseInt(capGr.getValue('current_task_count')) || 0;
            maxLoad = parseInt(capGr.getValue('max_concurrent_tasks')) || 5;
            
            // 获取实时状态
            isAvailable = (capGr.getValue('is_available') === '1' || capGr.getValue('is_available') === 'true');
        }

        // 4. 状态逻辑判定
        var status = 'OFFLINE';
        var statusClass = 'offline';

        if (isAvailable) {
            if (currentLoad >= maxLoad) {
                status = 'OVERLOADED'; 
                statusClass = 'busy';
            } else if (currentLoad > 0) {
                status = 'ENGAGED'; 
                statusClass = 'busy';
            } else {
                status = 'STANDBY'; 
                statusClass = 'online';
            }
        }

        // 5. 头像处理
        var photoUrl = "";
        if (userGr.photo.getDisplayValue()) {
            photoUrl = userGr.photo.getDisplayValue();
        }

        // 6. 数据封装
        volunteerList.push({
            sys_id: uid,
            name: userGr.getDisplayValue('name'),
            initial: (userGr.getDisplayValue('name') || '?').charAt(0).toUpperCase(),
            photo: photoUrl,
            title: userGr.getValue('title') || 'Operator',
            status: status,
            status_class: statusClass,
            current_load: currentLoad,
            max_load: maxLoad,
            load_percent: Math.round((currentLoad / maxLoad) * 100),
            capability: capStr
        });
    }
    
    return volunteerList;
}
	
	
    // ==========================================
    // 处理输入
    // ==========================================
    if (input) {

        // === 位置更新 ===
        if (input.action === 'update_location' && input.zone) {
            try {
                var assignEngine = new x_1821654_kokoro_0.KokoroAutoAssignment();
                assignEngine.updateVolunteerLocation(data.user_id, input.zone);
                data.success = true;
                data.message = '位置を更新しました';
            } catch (e) {
                data.error = '位置更新に失敗しました: ' + e.message;
            }
            return;
        }

        // === 可用性更新 ===
        if (input.action === 'set_availability') {
            try {
                var assignEngine2 = new x_1821654_kokoro_0.KokoroAutoAssignment();
                assignEngine2.setVolunteerAvailability(data.user_id, input.available);
                data.success = true;
                data.message = input.available ? 'オンラインになりました' : 'オフラインになりました';
            } catch (e) {
                data.error = '状態更新に失敗しました: ' + e.message;
            }
            return;
        }

        // === 手动触发自动分配 ===
        if (input.action === 'trigger_auto_assign' && input.sys_id) {
            if (!isVolunteer) {
                data.error = '権限がありません';
                return;
            }
            
            try {
                var assignEngine3 = new x_1821654_kokoro_0.KokoroAutoAssignment();
                var result = assignEngine3.autoAssign(input.sys_id, { forceReassign: input.force_reassign });
                
                if (result.success) {
                    data.success = true;
                    data.assigned_to = result.volunteer_name;
                    data.score = result.score;
                } else {
                    data.error = result.reason;
                }
            } catch (e) {
                data.error = '自動分配に失敗しました: ' + e.message;
            }
            return;
        }

        // === 获取SLA详情 ===
        if (input.action === 'get_sla_info' && input.sys_id) {
            try {
                var slaEngine2 = new x_1821654_kokoro_0.KokoroSLAEngine();
                data.sla_info = slaEngine2.getSLAInfo(input.sys_id);
                data.success = true;
            } catch (e) {
                data.error = 'SLA情報の取得に失敗しました';
            }
            return;
        }

        if (input.action === 'get_volunteers') {
            data.volunteers = loadVolunteerList();
            data.success = true;
            return;
        }

        if (input.action === 'save_settings') {
            try {
                var successProfile = false;
                var successWill = true;

                var grUp = new GlideRecord(CONFIG.tables.USER_PROFILE);
                grUp.addQuery('user', data.user_id);
                grUp.query();

                if (grUp.next()) {
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.update() != null);
                } else {
                    grUp.initialize();
                    grUp.setValue('user', data.user_id);
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.insert() != null);
                }

                if (input.will && String(input.will).trim() !== '') {
                    var oldMsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldMsg.addQuery('user', data.user_id);
                    oldMsg.addQuery('is_active', true);
                    oldMsg.addQuery('message_type', 'Last_Will');
                    oldMsg.query();
                    while (oldMsg.next()) {
                        oldMsg.setValue('is_active', false);
                        oldMsg.update();
                    }

                    var emsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsg.initialize();
                    emsg.setValue('user', data.user_id);
                    emsg.setValue('message_encrypted', sanitizeInput(input.will, 4000));
                    emsg.setValue('message_type', 'Last_Will');
                    emsg.setValue('is_active', true);
                    emsg.setValue('created_at', new GlideDateTime());
                    successWill = (emsg.insert() != null);
                }

                if (successProfile && successWill) {
                    data.success = true;
                    logProcessEvent(data.user_id, 'User settings updated', data.user_id);
                } else {
                    data.error = "保存失敗";
                }

            } catch (e) {
                gs.error("[Kokoro] Save error: " + e.message);
                data.error = "保存エラー";
            }
            return;
        }

        if (input.action === 'submit_record' || input.action === 'update_record') {
            if (!input.location || !input.category || !input.urgency) {
                data.error = "必須項目が不足";
                return;
            }

            try {
                var gr = new GlideRecord(CONFIG.tables.SILENT_WISH);

                if (input.action === 'update_record' && input.sys_id) {
                    if (!validateSysId(input.sys_id)) {
                        data.error = "無効なID";
                        return;
                    }
                    if (!gr.get(input.sys_id)) {
                        data.error = "レコードが見つかりません";
                        return;
                    }
                } else {
                    gr.initialize();
                    gr.setValue('state', CONFIG.wishStates.SUBMITTED);
                }

                gr.setValue('shelter_zone', sanitizeInput(input.location, 100));
                gr.setValue('request_category', sanitizeInput(input.category, 50));
                gr.setValue('qty', parseInt(input.quantity) || 1);
                gr.setValue('urgency', sanitizeInput(input.urgency, 20));
                gr.setValue('u_affected_count', sanitizeInput(input.affected_count, 10));
                gr.setValue('wish_content', sanitizeInput(input.remarks, 1000));
                gr.setValue('u_contact_info', sanitizeInput(input.contact, 200));
                gr.setValue('precise_location', sanitizeInput(input.detail_loc, 200));

                var fullDescription =
                    "【詳細場所】: " + sanitizeInput(input.detail_loc, 200) + "\n" +
                    "【支援種別】: " + input.category + " x " + (input.quantity || 1) + "\n" +
                    "【緊急度】: " + input.urgency + "\n" +
                    "【対象人数】: " + (input.affected_count || '1') + "\n" +
                    "【備考】: " + (input.remarks || 'なし');

                gr.setValue('wish_content', fullDescription);

                if (input.action === 'submit_record') {
                    var sysId = gr.insert();
                    if (sysId) {
                        data.ticketNumber = gr.getValue('number');
                        data.newRecordID = sysId;
                        data.success = true;
                        logProcessEvent(sysId, 'Wish submitted: ' + input.category, data.user_id);
                    } else {
                        data.error = "作成失敗";
                    }
                } else {
                    if (gr.update()) {
                        data.ticketNumber = gr.getValue('number');
                        data.success = true;
                        logProcessEvent(input.sys_id, 'Wish updated', data.user_id);
                    } else {
                        data.error = "更新失敗";
                    }
                }
            } catch (e) {
                gs.error("[Kokoro] Submit error: " + e.message);
                data.error = "エラーが発生しました: " + e.message;
            }
            return;
        }

        if (input.action === 'upload_attachment' && input.sys_id) {
            try {
                if (!validateSysId(input.sys_id)) {
                    data.error = "無効なID";
                    return;
                }
                var attachment = new GlideSysAttachment();
                if (input.file_data) {
                    var cleanBase64 = input.file_data.split(',')[1] || input.file_data;
                    attachment.writeBase64(
                        input.table || CONFIG.tables.SILENT_WISH,
                        input.sys_id,
                        sanitizeInput(input.file_name, 100),
                        input.content_type,
                        cleanBase64
                    );
                    data.success = true;
                }
            } catch (e) {
                gs.error("[Kokoro] Attachment error: " + e.message);
            }
            return;
        }

        if (input.action === 'register_heartbeat') {
            try {
                var hb = new GlideRecord(CONFIG.tables.HEARTBEAT);
                hb.initialize();
                hb.setValue('u_user', data.user_id);
                hb.setValue('u_timestamp', new GlideDateTime());
                hb.setValue('u_status', 'Safe');

                var hbId = hb.insert();
                data.heartbeat_id = hbId;
                data.success = true;
                logProcessEvent(hbId, 'Heartbeat registered', data.user_id);
            } catch (e) {
                gs.error("[Kokoro] Heartbeat error: " + e.message);
                data.error = "心跳注册失败";
            }
            return;
        }

        if (input.action === 'update_will') {
            try {
                if (input.message) {
                    var oldQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldQuick.addQuery('user', data.user_id);
                    oldQuick.addQuery('is_active', true);
                    oldQuick.addQuery('message_type', 'Quick_Will');
                    oldQuick.query();
                    while (oldQuick.next()) {
                        oldQuick.setValue('is_active', false);
                        oldQuick.update();
                    }

                    var emsgQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsgQuick.initialize();
                    emsgQuick.setValue('user', data.user_id);
                    emsgQuick.setValue('message_encrypted', sanitizeInput(input.message, 4000));
                    emsgQuick.setValue('message_type', 'Quick_Will');
                    emsgQuick.setValue('is_active', true);
                    emsgQuick.setValue('created_at', new GlideDateTime());

                    if (emsgQuick.insert()) {
                        data.success = true;
                    }
                }
            } catch (e) {
                gs.error("[Kokoro] Quick will error: " + e.message);
            }
            return;
        }

        // ★★★ [FIX] 志愿者操作 - 重命名变量避免冲突 ★★★
        if (input.sys_id) {
            if (!validateSysId(input.sys_id)) {
                data.error = "無効なID";
                return;
            }

            var volTaskGr = new GlideRecord(CONFIG.tables.SILENT_WISH);  // 改名为 volTaskGr
            if (!volTaskGr.get(input.sys_id)) {
                data.error = "タスクが見つかりません";
                return;
            }

            var currentState = String(volTaskGr.getValue('state') || '10');

            if (input.action === 'assign_to_me') {
                if (!isVolunteer) {
                    data.error = "ボランティア権限が必要です";
                    return;
                }

                volTaskGr.setValue('assigned_to', data.user_id);
                
                if (currentState === '1' || currentState === '10') {
                    var validationAssign = StateValidator.validateTransition(currentState, '11');
                    if (validationAssign.valid) {
                        volTaskGr.setValue('state', '11');
                    }
                }
                
                if (volTaskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + data.user_name, data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'assign_to' && input.assignee_id) {
                if (!isVolunteer) {
                    data.error = "ボランティア権限が必要です";
                    return;
                }

                volTaskGr.setValue('assigned_to', input.assignee_id);
                
                if (currentState === '1' || currentState === '10') {
                    var validationAssignTo = StateValidator.validateTransition(currentState, '11');
                    if (validationAssignTo.valid) {
                        volTaskGr.setValue('state', '11');
                    }
                }
                
                if (volTaskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + input.assignee_id, data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'change_status' && input.new_state) {
                var newState = String(input.new_state);
                var validationChange = StateValidator.validateTransition(currentState, newState);
                
                if (!validationChange.valid) {
                    data.error = validationChange.message;
                    return;
                }

                if ((newState === '2' || newState === '4') && volTaskGr.assigned_to.nil()) {
                    data.error = "先に担当者を設定してください";
                    return;
                }

                volTaskGr.setValue('state', newState);
                
                if (newState === '4') {
                    volTaskGr.setValue('u_completed_at', new GlideDateTime());
                }
                
                if (volTaskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Status changed to ' + newState, data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'start') {
                var validationStart = StateValidator.validateTransition(currentState, '2');
                if (!validationStart.valid) {
                    data.error = validationStart.message;
                    return;
                }

                if (volTaskGr.getValue('assigned_to') != data.user_id && !gs.hasRole('admin')) {
                    data.error = "自分に担当されたタスクのみ開始できます";
                    return;
                }

                volTaskGr.setValue('state', '2');
                
                if (volTaskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task started', data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'complete') {
                var validationComplete = StateValidator.validateTransition(currentState, '4');
                if (!validationComplete.valid) {
                    data.error = validationComplete.message;
                    return;
                }

                volTaskGr.setValue('state', '4');
                volTaskGr.setValue('u_completed_at', new GlideDateTime());
                
                if (volTaskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task completed', data.user_id);
                } else {
                    data.error = "更新失敗";
                }
                return;
            }

            if (input.action === 'add_comment' && input.message) {
                try {
                    volTaskGr.work_notes = sanitizeInput(input.message, 1000);
                    volTaskGr.update();
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Comment added', data.user_id);
                } catch (e) {
                    data.error = "コメント追加失敗";
                }
                return;
            }
        }
    }

    // ==========================================
    // 5. 加载数据列表 (修复版: 增加 myRequests)
    // ==========================================
    
    // helper: 构建查询
    function fetchWishes(queryType) {
        var results = [];
        var gr = new GlideRecord(CONFIG.tables.SILENT_WISH);
        
        if (queryType === 'mine_assigned') {
            gr.addQuery('assigned_to', data.user_id);
        } else if (queryType === 'mine_created') {
            gr.addQuery('sys_created_by', gs.getUserName());
        } else if (queryType === 'all') {
            // No filter
        }
        
        gr.orderByDesc('sys_created_on');
        gr.setLimit(queryType === 'all' ? 100 : 50);
        gr.query();
        
        while (gr.next()) {
            results.push(buildTaskItem(gr));
        }
        return results;
    }

    // 无论身份如何，都加载"我提交的"工单
    data.myRequests = fetchWishes('mine_created');
	
	// ============================================================
    // [COMMS] 加载通信记录
    // ============================================================
    data.announcements = [];
    try {
        var commGr = new GlideRecord('x_1821654_kokoro_0_emergency_message');
        commGr.addQuery('is_active', true);
        commGr.addQuery('message_type', 'IN', 'emergency,announcement,internal');
        commGr.orderByDesc('created_at');
        commGr.setLimit(50);
        commGr.query();
        
        while (commGr.next()) {
            // 拆分标题和正文
            var rawMsg = commGr.getValue('message_encrypted') || '';
            var parts = rawMsg.split('\n---\n');
            var msgTitle = parts[0] || '(無題)';
            var msgBody = parts.length > 1 ? parts.slice(1).join('\n---\n') : rawMsg;
            
            // 计算相对时间
            var createdAt = new GlideDateTime(
                commGr.getValue('created_at') || commGr.getValue('sys_created_on')
            );
            var nowComm = new GlideDateTime();
            var diffComm = GlideDateTime.subtract(createdAt, nowComm).getNumericValue();
            var minsComm = Math.floor(diffComm / 1000 / 60);
            
            var timeAgo = '';
            if (minsComm < 1) timeAgo = '今';
            else if (minsComm < 60) timeAgo = minsComm + '分前';
            else if (minsComm < 1440) timeAgo = Math.floor(minsComm / 60) + '時間前';
            else timeAgo = Math.floor(minsComm / 1440) + '日前';
            
            data.announcements.push({
                sys_id: commGr.getUniqueValue(),
                type: commGr.getValue('message_type') || 'announcement',
                title: msgTitle,
                body: msgBody,
                author: commGr.getDisplayValue('user') || 'System',
                time_ago: timeAgo,
                read_count: 0
            });
        }
    } catch (e) {
        gs.debug('[Kokoro] Comms load error: ' + e.message);
    }

    if (isVolunteer) {
        // 志愿者额外加载: 分配给我的 + 所有工单
        data.myTasks = fetchWishes('mine_assigned');
        data.list = fetchWishes('all');
        
        // 加载统计
        try {
            var gaOpen = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaOpen.addNullQuery('assigned_to');
            gaOpen.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaOpen.addAggregate('COUNT');
            gaOpen.query();
            if (gaOpen.next()) data.openCount = parseInt(gaOpen.getAggregate('COUNT')) || 0;

            var gaSOS = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaSOS.addQuery('u_urgency', 'Critical');
            gaSOS.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaSOS.addAggregate('COUNT');
            gaSOS.query();
            if (gaSOS.next()) data.sosCount = parseInt(gaSOS.getAggregate('COUNT')) || 0;
        } catch (e) {}
        
        data.volunteers = loadVolunteerList();
    } else {
        // 普通用户: 主列表就是我提交的
        data.list = data.myRequests; 
    }

    // ==========================================
    // [DAY 5 INTEGRATION] Process Mining & Monitoring Data
    // 插入位置: Server Script 最后部分, })(); 之前
    // ==========================================

    // === 1. 获取Process Mining统计 ===
    data.processMiningStats = {
        totalEvents: 0,
        todayEvents: 0,
        uniqueCases: 0,
        topActivities: []
    };

    try {
        // 总事件数
        var gaEvents = new GlideAggregate('x_1821654_kokoro_0_process_event');
        gaEvents.addAggregate('COUNT');
        gaEvents.query();
        if (gaEvents.next()) {
            data.processMiningStats.totalEvents = parseInt(gaEvents.getAggregate('COUNT')) || 0;
        }
        
        // ★★★ [FIX] todayPM 已在全局定义，此处直接使用 ★★★
        var gaTodayEvents = new GlideAggregate('x_1821654_kokoro_0_process_event');
        gaTodayEvents.addQuery('timestamp', '>=', todayPM);
        gaTodayEvents.addAggregate('COUNT');
        gaTodayEvents.query();
        if (gaTodayEvents.next()) {
            data.processMiningStats.todayEvents = parseInt(gaTodayEvents.getAggregate('COUNT')) || 0;
        }
        
        // 唯一案例数
        var gaCases = new GlideAggregate('x_1821654_kokoro_0_process_event');
        gaCases.addAggregate('COUNT', 'DISTINCT', 'case_id');
        gaCases.query();
        if (gaCases.next()) {
            data.processMiningStats.uniqueCases = parseInt(gaCases.getAggregate('COUNT', 'DISTINCT', 'case_id')) || 0;
        }
        
        // 活动分布 (Top 5)
        var gaAct = new GlideAggregate('x_1821654_kokoro_0_process_event');
        gaAct.addAggregate('COUNT');
        gaAct.groupBy('activity');
        gaAct.orderByAggregate('COUNT', 'DESC');
        gaAct.setLimit(5);
        gaAct.query();
        
        while (gaAct.next()) {
            data.processMiningStats.topActivities.push({
                name: gaAct.getValue('activity') || 'Unknown',
                count: parseInt(gaAct.getAggregate('COUNT')) || 0
            });
        }
    } catch (e) {
        gs.debug('[Kokoro] Process Mining stats not available: ' + e.message);
    }

    // === 2. 获取系统监控指标 ===
    data.systemMetrics = {
        healthScore: 100,
        lastCollected: '',
        alerts: {
            critical: 0,
            warning: 0
        }
    };

    try {
        var grMetrics = new GlideRecord('x_1821654_kokoro_0_metrics');
        grMetrics.addQuery('metric_type', 'system_health');
        grMetrics.orderByDesc('timestamp');
        grMetrics.setLimit(1);
        grMetrics.query();
        
        if (grMetrics.next()) {
            data.systemMetrics.healthScore = parseInt(grMetrics.getValue('health_score')) || 100;
            data.systemMetrics.lastCollected = grMetrics.getDisplayValue('timestamp');
            
            var metricData = grMetrics.getValue('metric_data');
            if (metricData) {
                try {
                    var parsed = JSON.parse(metricData);
                    if (parsed.alerts) {
                        data.systemMetrics.alerts = parsed.alerts;
                    }
                } catch (parseErr) {}
            }
        }
        
        // ★★★ [FIX] todayPM 已在全局定义，此处直接使用 ★★★
        var gaAlertsCrit = new GlideAggregate('x_1821654_kokoro_0_metrics');
        gaAlertsCrit.addQuery('metric_type', 'alert');
        gaAlertsCrit.addQuery('health_score', '<', 50);
        gaAlertsCrit.addQuery('timestamp', '>=', todayPM);
        gaAlertsCrit.addAggregate('COUNT');
        gaAlertsCrit.query();
        if (gaAlertsCrit.next()) {
            data.systemMetrics.alerts.critical = parseInt(gaAlertsCrit.getAggregate('COUNT')) || 0;
        }
        
    } catch (e) {
        gs.debug('[Kokoro] System metrics not available: ' + e.message);
    }

    // === 3. 获取审计日志统计 ===
    data.auditStats = {
        todayLogs: 0,
        recentActions: []
    };

    try {
        // ★★★ [FIX] todayPM 已在全局定义，此处直接使用 ★★★
        var gaAudit = new GlideAggregate('x_1821654_kokoro_0_audit_log');
        gaAudit.addQuery('timestamp', '>=', todayPM);
        gaAudit.addAggregate('COUNT');
        gaAudit.query();
        if (gaAudit.next()) {
            data.auditStats.todayLogs = parseInt(gaAudit.getAggregate('COUNT')) || 0;
        }
        
        // 最近5个操作
        var grAudit = new GlideRecord('x_1821654_kokoro_0_audit_log');
        grAudit.orderByDesc('timestamp');
        grAudit.setLimit(5);
        grAudit.query();
        
        while (grAudit.next()) {
            data.auditStats.recentActions.push({
                action: grAudit.getValue('action') || 'Unknown',
                user: grAudit.getDisplayValue('user') || 'System',
                time: grAudit.getDisplayValue('timestamp')
            });
        }
    } catch (e) {
        gs.debug('[Kokoro] Audit stats not available: ' + e.message);
    }

    // === 4. 计算综合健康评分 ===
    data.overallHealth = {
        score: 100,
        status: 'nominal',
        components: []
    };

    try {
        var healthScores = [];
        
        // SLA健康度
        var slaHealthScore = 100;
        if (data.slaStats && data.slaStats.breached > 0) {
            slaHealthScore = Math.max(0, 100 - (data.slaStats.breached * 10));
        }
        healthScores.push({ name: 'SLA', score: slaHealthScore });
        
        // 任务处理健康度
        var taskHealthScore = 100;
        if (data.openCount > 10) {
            taskHealthScore = Math.max(50, 100 - (data.openCount * 2));
        }
        healthScores.push({ name: 'Tasks', score: taskHealthScore });
        
        // 系统健康度
        healthScores.push({ name: 'System', score: data.systemMetrics.healthScore });
        
        // 计算平均分
        var totalHealthScore = 0;
        for (var hi = 0; hi < healthScores.length; hi++) {
            totalHealthScore += healthScores[hi].score;
        }
        data.overallHealth.score = Math.round(totalHealthScore / healthScores.length);
        data.overallHealth.components = healthScores;
        
        // 确定状态
        if (data.overallHealth.score >= 90) {
            data.overallHealth.status = 'nominal';
        } else if (data.overallHealth.score >= 70) {
            data.overallHealth.status = 'warning';
        } else {
            data.overallHealth.status = 'critical';
        }
        
    } catch (e) {
        gs.debug('[Kokoro] Health calculation error: ' + e.message);
    }

    // ==========================================
    // [END OF DAY 5 INTEGRATION]
    // ==========================================
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-26 11:41:20</sys_created_on>
        <sys_id>f95e8ba383227210f6b1fb96feaad375</sys_id>
        <sys_mod_count>403</sys_mod_count>
        <sys_name>Kokoro Volunteer Dashboard</sys_name>
        <sys_package display_value="Kokoro Shelter" source="x_1821654_kokoro_0">80ba4d9583863210f6b1fb96feaad3b2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Kokoro Shelter">80ba4d9583863210f6b1fb96feaad3b2</sys_scope>
        <sys_update_name>sp_widget_f95e8ba383227210f6b1fb96feaad375</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-10 07:53:47</sys_updated_on>
        <template><![CDATA[<style>
/* ============================================================
   KOKORO DASHBOARD CSS v9.6 (ULTIMATE FUSED EDITION)
   适配：v4.0 Zenless Structure + v9.5 Visual Style
   ============================================================ */

  /* 1. 基础隐藏 (原有) */
nav, header, footer, .sp-page-header, .navbar, .polaris-header, 
.sn-polaris-nav, .sn-canvas-header, #sp-nav-bar, .sp-row-background,
.cms-header, .navpage-header {
  display: none !important;
}

/* 2. 针对性隐藏 */
.sn-chat-overlay, .help-button-wrapper, .sp-ac-root, .sw-session-repro-button,
button.help-button, .sn-connect-floating-wrapper, #u_chat_button, .cm-help-button,
.sp-page-row-options, .theme-picker, .sp-debug-tool, div[ng-controller="spPageRowOptions"],
a[title="Toggle Layout"], .btn-floating, .sp-icon-edit,
.guided-tour-overlay, .code-editor-container, 
.icon-palette, .fa-cog, .sp-icon-color, .sp-preview-pill {
  display: none !important;
  visibility: hidden !important;
  width: 0 !important; height: 0 !important;
  pointer-events: none !important;
  opacity: 0 !important;
  z-index: -9999 !important;
}

/* 无差别打击固定定位元素 */
body > div[style*="position: fixed"][style*="bottom"],
body > div[style*="position:fixed"][style*="bottom"],
body > button[style*="position: fixed"][style*="bottom"],
body > div[style*="position: fixed"][style*="left"], 
body > div[style*="position:fixed"][style*="left"] {
    display: none !important;
    opacity: 0 !important;
    pointer-events: none !important;
    z-index: -9999 !important;
}

/* 3. 容器样式 (修复版: 强制全屏覆盖，脱离SP容器限制) */
.kokoro-volunteer-container {
    display: flex;
    flex-direction: column;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden;
    background: var(--bg-color);
    /* 关键修改：使用 fixed 定位强行占满屏幕 */
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 1000; /* 提升层级，覆盖默认Portal元素 */
}
  
* {
  box-sizing: border-box;
}

/* 4. Modal 核心修复 */
.modal { z-index: 20000 !important; }
.modal-backdrop { z-index: 19999 !important; background-color: rgba(0,0,0,0.9) !important; backdrop-filter: blur(2px); }
.modal-dialog { margin-top: 50px; z-index: 20001 !important; max-width: 900px; width: 90%; }
.modal-content {
  background: #fdfdfd !important;
  border: 2px solid var(--border-dark) !important;
  border-radius: 0 !important;
  box-shadow: 0 30px 60px rgba(0,0,0,0.8) !important;
  color: var(--text-primary) !important;
  font-family: var(--font-mono) !important;
  padding: 0 !important;
  overflow: visible !important;
}

/* 5. 模态框内部样式 */
.modal-header-clean { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  padding: 16px 24px; 
  background: #f0f0f0; 
  border-bottom: 2px solid var(--border-dark); 
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-badge { 
  background: var(--border-dark); 
  color: #fff; 
  padding: 4px 10px; 
  font-weight: 700; 
  font-size: 0.8rem; 
}
.header-id { 
  font-family: var(--font-tech); 
  font-weight: 700; 
  font-size: 1.1rem; 
}
.header-close { 
  background: none; 
  border: 1px solid #ccc; 
  width: 32px; 
  height: 32px; 
  cursor: pointer; 
  transition: all 0.2s; 
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.header-close:hover { 
  background: var(--color-critical); 
  color: #fff; 
  border-color: var(--color-critical); 
}

.modal-body-grid { 
  display: grid; 
  grid-template-columns: 1fr 300px; 
  min-height: 500px; 
  max-height: 70vh;
  overflow: hidden;
}

.body-main { 
  padding: 24px; 
  border-right: 1px solid var(--border-light); 
  overflow-y: auto;
  max-height: 70vh;
}

.body-sidebar {
  background: #fcfcfc;
  padding: 24px;
  overflow-y: auto;
  max-height: 70vh;
}

.ticket-title { 
  font-family: var(--font-header); 
  font-size: 1.5rem; 
  font-weight: 700; 
  margin: 0 0 20px 0; 
  border-bottom: 1px solid var(--border-light); 
  padding-bottom: 15px; 
}

.qty-badge-black { 
  background: #000; 
  color: #fff; 
  padding: 2px 8px; 
  font-size: 0.8rem; 
  vertical-align: middle; 
  margin-left: 10px; 
}

.action-bar { 
  display: flex; 
  gap: 12px; 
  margin-bottom: 24px; 
  flex-wrap: wrap; 
}

.btn-purple-outline, .btn-normal { 
  border: 1px solid #ccc; 
  background: #fff; 
  padding: 8px 16px; 
  font-weight: 700; 
  cursor: pointer; 
  text-transform: uppercase;
  font-family: var(--font-header);
  font-size: 12px;
  transition: all 0.2s;
}

.btn-purple-outline {
  border-color: var(--accent-primary);
  color: var(--accent-primary);
}

.btn-purple-outline:hover {
  background: var(--accent-primary);
  color: #fff;
}

.btn-normal:hover {
  background: #f0f0f0;
}

.action-btn { 
  background: var(--border-dark); 
  color: #fff; 
  border: none; 
  padding: 8px 16px; 
  font-weight: 700; 
  cursor: pointer; 
  text-transform: uppercase; 
  font-family: var(--font-header);
  font-size: 12px;
  transition: all 0.2s;
}

.action-btn:hover { 
  background: #333; 
}

.desc-box { 
  background: #fafafa; 
  border: 1px solid var(--border-light); 
  padding: 16px; 
  margin-bottom: 24px; 
}

.desc-section-title { 
  font-size: 0.8rem; 
  color: var(--text-tertiary); 
  margin-bottom: 12px; 
  font-weight: 700; 
  letter-spacing: 1px; 
}

.desc-grid { 
  display: grid; 
  gap: 12px; 
}

.desc-item { 
  display: flex; 
  gap: 10px; 
  align-items: flex-start; 
  font-size: 0.9rem; 
}

.desc-icon { 
  width: 24px; 
  text-align: center; 
  color: #666; 
  flex-shrink: 0;
}

.desc-label { 
  font-weight: 700; 
  color: var(--text-secondary); 
  margin-right: 6px; 
}

.activity-area { 
  margin-top: 20px; 
}

.note-input { 
  width: 100%; 
  border: 1px solid #ccc; 
  padding: 10px; 
  min-height: 60px; 
  margin-bottom: 10px; 
  font-family: var(--font-mono); 
  resize: vertical;
}

.submit-btn { 
  background: #ccc; 
  color: #fff; 
  border: none; 
  padding: 8px 16px; 
  font-weight: 700; 
  cursor: not-allowed; 
  float: right;
  transition: all 0.2s;
}

.submit-btn.ready { 
  background: var(--border-dark); 
  cursor: pointer; 
}

.submit-btn.ready:hover {
  background: #333;
}

.sidebar-block { 
  margin-bottom: 24px; 
  padding-bottom: 16px; 
  border-bottom: 1px solid var(--border-light); 
}

.sb-label { 
  font-size: 0.75rem; 
  color: var(--text-tertiary); 
  margin-bottom: 8px; 
  font-weight: 700; 
  letter-spacing: 1px; 
}

.user-row { 
  display: flex; 
  align-items: center; 
  gap: 10px; 
}

.avatar-box { 
  width: 32px; 
  height: 32px; 
  background: var(--border-dark); 
  color: #fff; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  border-radius: 4px; 
  font-weight: 700;
  flex-shrink: 0;
}

.avatar-box.orange { 
  background: var(--color-warning); 
}

.user-name-text {
  font-weight: 600;
  color: var(--text-primary);
}

.state-indicator { 
  padding: 4px 10px; 
  border-radius: 4px;
  color: #fff;
  font-weight: 700;
  font-size: 0.9rem;
  display: inline-block;
}

.priority-btn { 
  background: var(--border-mid);
  color: var(--text-secondary); 
  padding: 10px 18px; 
  font-family: var(--font-header); 
  font-weight: 700; 
  font-size: 14px; 
  display: flex; 
  align-items: center; 
  gap: 10px;
}
  
.sla-progress { 
  height: 10px; 
  background: #eee; 
  overflow: hidden; 
  margin-bottom: 12px;
  border-radius: 4px;
}

.sla-fill { 
  height: 100%; 
  position: relative;
  border-radius: 4px;
}

.sla-text { 
  display: flex; 
  justify-content: space-between; 
  font-family: var(--font-mono); 
  font-size: 12px; 
  color: var(--text-tertiary); 
  margin-bottom: 12px;
}

.sla-badge { 
  background: var(--border-mid);
  color: var(--text-secondary); 
  padding: 8px 16px; 
  font-family: var(--font-mono); 
  font-size: 12px; 
  font-weight: 800; 
  letter-spacing: 1px; 
  display: inline-flex; 
  align-items: center; 
  gap: 8px;
  border-radius: 4px;
}

.sla-badge.sla-critical { 
  background: rgba(255, 59, 48, 0.2); 
  color: var(--color-critical);
}

.sla-badge.sla-ok { 
  background: rgba(52, 199, 89, 0.2); 
  color: var(--color-success);
}

.dropdown-wrapper { 
  position: relative; 
  display: inline-block; 
}

.status-menu { 
  position: absolute; 
  top: 100%; 
  left: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
  z-index: 10; 
  min-width: 160px;
  margin-top: 2px;
}

.status-item { 
  padding: 10px 16px; 
  cursor: pointer; 
  font-size: 0.85rem; 
  border-bottom: 1px solid var(--border-light);
  transition: all 0.2s;
}

.status-item:hover { 
  background: #f5f5f5; 
}

.status-item.danger { 
  color: var(--color-critical); 
}

/* 6. Headers & Layout (v4.0 Support) */
.command-header {
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    padding: 15px 20px; 
    background: #fff; 
    border-bottom: 2px solid var(--border-dark);
    flex-shrink: 0;
    height: 70px;
}

.hamburger-btn {
  background: none;
  border: 1px solid var(--border-mid);
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin-right: 10px;
  transition: all 0.2s;
}

.hamburger-btn:hover {
  background: #f0f0f0;
  border-color: var(--border-dark);
}

.hamburger-btn i {
  font-size: 18px;
  color: var(--text-primary);
}

.command-logo { 
  display: flex; 
  align-items: center; 
  gap: 10px;
  flex: 1;
  min-width: 0;
}

.logo-icon { 
    background: #000; 
    color: #fff; 
    width: 36px; 
    height: 36px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-weight: 900; 
    font-family: var(--font-header); 
    font-size: 1.2rem;
    flex-shrink: 0;
}

.logo-text { 
  display: flex; 
  flex-direction: column; 
  line-height: 1.2;
  flex-shrink: 0;
}

.logo-title { 
  font-weight: 900; 
  font-size: 1.2rem; 
  letter-spacing: -1px;
  color: var(--text-primary);
}

.logo-subtitle { 
  font-size: 0.65rem; 
  color: #666; 
  letter-spacing: 1px;
}

.system-status { 
  display: flex; 
  align-items: center; 
  gap: 15px; 
  font-size: 0.8rem; 
  font-family: var(--font-mono);
  margin-left: auto;
  flex-shrink: 0;
}

.status-indicator { 
  display: flex; 
  align-items: center; 
  gap: 6px; 
  color: var(--color-success); 
  font-weight: bold; 
}

.status-dot { 
  width: 8px; 
  height: 8px; 
  background: var(--color-success); 
  border-radius: 50%; 
  box-shadow: 0 0 5px var(--color-success); 
  animation: blink 2s infinite;
}

.status-text {
  color: var(--text-primary);
  font-weight: 700;
}

.version-tag { 
  background: #eee; 
  padding: 2px 6px; 
  color: #666; 
  font-size: 0.7rem;
  border-radius: 2px;
}

.system-time {
  font-family: var(--font-mono);
  color: var(--text-secondary);
  font-weight: 600;
}

.scan-line-header {
    display: flex; 
    align-items: center; 
    gap: 10px; 
    padding: 10px 20px;
    font-size: 0.7rem; 
    color: #999; 
    letter-spacing: 2px;
    flex-shrink: 0;
    background: #fff;
    border-bottom: 1px solid var(--border-light);
}

.scan-line { 
  height: 1px; 
  background: #ddd; 
  flex-grow: 1; 
}

.nav-tabs-custom { 
  display: flex; 
  background: #fff; 
  border-bottom: 1px solid #ddd; 
  padding: 0 20px; 
  gap: 20px;
  flex-shrink: 0;
  overflow-x: auto;
  overflow-y: hidden;
}

.tab { 
  padding: 15px 0; 
  cursor: pointer; 
  border-bottom: 3px solid transparent; 
  font-weight: 700; 
  color: #999; 
  font-size: 0.9rem; 
  font-family: var(--font-header); 
  transition: all 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}

.tab:hover { 
  color: #333; 
}

.tab.active { 
  border-bottom-color: var(--accent-primary); 
  color: #000; 
}

.tab-number { 
  font-family: var(--font-mono); 
  font-size: 0.8rem; 
  color: #ccc;
  margin-right: 4px;
}

.board-container { 
  padding: 20px; 
  overflow-y: auto; 
  overflow-x: hidden;
  flex: 1;
  background: var(--bg-color);
  width: 100% !important;      /* 新增 */
  max-width: none !important;  /* 新增 */
  margin: 0 !important;        /* 新增 */
}

.two-column-layout { 
  display: grid; 
  grid-template-columns: 1fr 320px; 
  gap: 20px; 
  margin-top: 20px; 
}

/* 7. Volunteers & Stats */
.volunteer-status-panel {
  background: #fff; 
  border: 1px solid #ddd; 
  border-left: 4px solid #000;
  padding: 12px 20px; 
  margin-bottom: 20px;
  display: flex; 
  align-items: center; 
  gap: 30px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  flex-wrap: wrap;
}

.status-row { 
  display: flex; 
  align-items: center; 
  gap: 10px; 
  font-family: var(--font-header); 
  font-weight: 700; 
  color: #333;
}

.status-row i {
  color: var(--text-secondary);
}

.btn-online, .btn-offline { 
  border: none; 
  padding: 6px 16px; 
  border-radius: 20px; 
  font-weight: bold; 
  cursor: pointer; 
  transition: all 0.2s;
  font-family: var(--font-header);
}

.btn-online { 
  background: var(--color-success); 
  color: white; 
}

.btn-online:hover {
  opacity: 0.8;
}

.btn-offline { 
  background: #888; 
  color: #fff; 
}

.btn-offline:hover {
  opacity: 0.8;
}

.status-row select { 
  padding: 5px 10px; 
  border: 1px solid #ccc; 
  border-radius: 4px; 
  font-family: var(--font-mono);
  background: white;
  cursor: pointer;
}

.stats-section .section-header { 
  display: flex; 
  align-items: center; 
  margin-bottom: 15px; 
  border-bottom: 1px solid #eee; 
  padding-bottom: 10px; 
}

.section-tag { 
  background: #000; 
  color: #fff; 
  padding: 2px 8px; 
  font-weight: 700; 
  font-size: 0.8rem; 
  margin-right: 10px;
  border-radius: 2px;
}

.section-title { 
  font-weight: 700; 
  font-family: var(--font-header); 
  font-size: 1.1rem; 
  letter-spacing: 1px;
  color: var(--text-primary);
}

.section-time { 
  margin-left: auto; 
  font-family: var(--font-mono); 
  font-size: 0.8rem; 
  color: #999;
}

.stats-row { 
  display: flex; 
  gap: 15px; 
  flex-wrap: wrap; 
}

.stat-card { 
  background: #fff; 
  border: 1px solid #ddd; 
  padding: 15px; 
  flex: 1; 
  min-width: 140px; 
  position: relative; 
  transition: all 0.2s;
  cursor: default;
}

.stat-card.clickable {
  cursor: pointer;
}

.stat-card.clickable:hover { 
  border-color: var(--accent-primary); 
  transform: translateY(-2px); 
  box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
}

.stat-label { 
  font-size: 0.7rem; 
  color: #999; 
  margin-bottom: 5px; 
  font-weight: 700;
}

.stat-code {
  font-family: var(--font-tech);
  font-weight: 700;
}

.stat-suffix {
  font-size: 0.6rem;
  margin-left: 2px;
}

.stat-num { 
  font-size: 2.2rem; 
  font-weight: 700; 
  font-family: var(--font-tech); 
  line-height: 1; 
  margin-bottom: 5px; 
  color: #1a1a1a; 
}

.stat-name { 
  font-size: 0.8rem; 
  font-weight: 700; 
  color: #555; 
  margin-bottom: 10px; 
}

.stat-footer { 
  display: flex; 
  justify-content: space-between;
  align-items: center;
  font-size: 0.7rem; 
  font-weight: 700; 
  border-top: 1px solid #eee; 
  padding-top: 6px;
}

.stat-change { 
  display: inline-block;
}

.stat-change.positive { 
  color: var(--color-success); 
}

.stat-change.negative { 
  color: var(--color-critical); 
}

.stat-status { 
  display: inline-block;
  padding: 1px 4px;
  border-radius: 2px;
}

.stat-status.nominal { 
  color: var(--color-success); 
  background: #e8f5e9; 
}

.stat-status.critical { 
  color: white; 
  background: var(--color-critical); 
}

.stat-status.warning { 
  color: white; 
  background: var(--color-warning); 
}

/* 8. Metal Dividers */
.metal-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #ccc, transparent);
    margin: 15px 0;
}

.metal-divider-glow {
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
    margin: 20px 0;
    box-shadow: 0 0 5px rgba(98, 0, 234, 0.3);
}

/* 9. Cards (Tactical & Alert) */
.alert-section {
  background: #fff;
  border: 1px solid #ddd;
  padding: 0;
  box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

.alert-section .section-header {
  background: #f8f8f8;
  border-bottom: 1px solid #ddd;
  padding: 15px 20px;
  margin: 0;
}

.alert-list { 
  max-height: 500px;
  overflow-y: auto;
}

.alert-item { 
    background: #fff; 
    border-bottom: 1px solid #eee;
    padding: 12px 16px; 
    margin: 0;
    display: grid; 
    grid-template-columns: 80px 60px 100px 60px 1fr 20px; 
    align-items: center; 
    gap: 10px;
    transition: all 0.2s; 
    cursor: pointer; 
    font-size: 0.85rem;
}

.alert-item:hover { 
  border-left: 4px solid var(--accent-primary);
  background: #fafafa; 
}

.alert-item.priority-Critical { 
  border-left: 4px solid var(--color-critical);
}

.alert-item.priority-High { 
  border-left: 4px solid var(--color-warning);
}

.alert-priority { 
  font-weight: 700;
  text-align: center;
}

.alert-priority.p-critical { 
  color: var(--color-critical); 
  font-weight: 900; 
}

.alert-priority.p-high { 
  color: var(--color-warning); 
  font-weight: 700; 
}

.alert-id { 
  font-family: var(--font-mono); 
  color: #666;
  font-weight: 700;
}

.alert-zone {
  color: var(--text-secondary);
  font-weight: 600;
}

.alert-time { 
  font-family: var(--font-mono); 
  color: #999; 
  font-size: 0.75rem;
}

.alert-content {
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.alert-arrow {
  color: var(--text-tertiary);
  text-align: right;
}

.empty-board {
  padding: 60px 20px;
  text-align: center;
  color: var(--text-tertiary);
}

.empty-board i {
  font-size: 48px;
  color: var(--border-light);
  margin-bottom: 15px;
}

.empty-board h4 {
  font-size: 1.2rem;
  color: var(--text-secondary);
  margin: 10px 0;
}

.empty-board p {
  font-size: 0.9rem;
  color: var(--text-tertiary);
}

.card-grid, .task-grid { 
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
  gap: 20px; 
  margin-top: 20px; 
  width: 100% !important; /* 强制 Grid 容器占满全宽 */
  justify-content: start; /* 防止 Grid 项目在数量少时居中导致的视觉变窄 */
}

.jira-card { 
  background: #fff; 
  border: 1px solid #ddd; 
  padding: 16px; 
  transition: all 0.2s; 
  position: relative; 
  cursor: pointer; 
}

.jira-card:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
  border-color: #bbb; 
}

.jira-card.priority-Critical { 
  border-top: 3px solid var(--color-critical); 
}

.jira-card.priority-High { 
  border-top: 3px solid var(--color-warning); 
}

.card-top { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start;
  margin-bottom: 10px; 
}

.card-id { 
  font-family: var(--font-mono); 
  font-size: 0.8rem; 
  color: #999;
  font-weight: 700;
}

.status-tag { 
  font-size: 0.7rem; 
  font-weight: 700; 
  padding: 2px 6px; 
  border-radius: 4px; 
  background: #eee; 
  color: #555;
}

.status-tag.status-4 {
  background: #e8f5e9;
  color: var(--color-success);
}

.status-tag.status-11 {
  background: #e3f2fd;
  color: var(--color-info);
}

.card-title { 
  font-weight: 700; 
  margin-bottom: 8px; 
  font-family: var(--font-header); 
  font-size: 1.1rem;
  color: var(--text-primary);
}

.qty-badge { 
  background: #000; 
  color: #fff; 
  font-size: 0.7rem; 
  padding: 1px 5px; 
  margin-left: 6px; 
  vertical-align: middle;
  border-radius: 2px;
}

.card-loc { 
  font-size: 0.85rem; 
  color: #555; 
  margin-bottom: 5px;
}

.card-loc i {
  color: var(--color-critical);
  margin-right: 4px;
}

.card-detail { 
  font-size: 0.8rem; 
  color: #999; 
  margin-bottom: 10px; 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
}

.card-sla { 
  margin: 10px 0; 
  padding-top: 8px; 
  border-top: 1px dashed #eee; 
}

.sla-bar-container { 
  height: 4px; 
  background: #eee; 
  border-radius: 2px; 
  overflow: hidden; 
  margin-bottom: 4px; 
}

.sla-bar { 
  height: 100%; 
  transition: width 0.3s ease;
  border-radius: 2px;
}

.sla-info { 
  display: flex; 
  justify-content: space-between; 
  font-size: 10px; 
  font-family: var(--font-tech); 
  color: #666; 
  font-weight: 700; 
}

.sla-critical { 
  color: var(--color-critical) !important; 
}

.sla-warning { 
  color: var(--color-warning) !important; 
}

.sla-ok { 
  color: var(--color-success) !important; 
}

.sla-remaining {
  display: flex;
  align-items: center;
  gap: 4px;
}

.card-footer{
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #eee;
}

.priority-badge {
  font-size: 0.8rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 2px;
  background: #eee;
  color: #666;
  display: inline-block;
}

.btn-jira {
  background: transparent;
  border: 1px solid #ddd;
  color: var(--text-secondary);
  padding: 6px 12px;
  font-weight: 700;
  font-size: 0.8rem;
  cursor: pointer;
  text-transform: uppercase;
  font-family: var(--font-header);
  border-radius: 2px;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  width: 100%;
  margin-top: 8px;
  justify-content: center;
}

.btn-jira:hover {
  border-color: var(--border-dark);
  background: #f8f8f8;
}

.btn-jira.progress {
  border-color: var(--color-info);
  color: var(--color-info);
}

.btn-jira.progress:hover {
  background: rgba(0, 122, 255, 0.05);
}

.btn-jira.success {
  border-color: var(--color-success);
  color: var(--color-success);
}

.btn-jira.success:hover {
  background: rgba(52, 199, 89, 0.05);
}

.completed-msg {
  text-align: center;
  padding: 12px;
  background: rgba(52, 199, 89, 0.1);
  border: 1px solid var(--color-success);
  color: var(--color-success);
  font-weight: 700;
  cursor: pointer;
  margin-top: 8px;
  border-radius: 2px;
  transition: all 0.2s;
}

.completed-msg:hover {
  background: rgba(52, 199, 89, 0.2);
}

/* 10. Side Panel Enhanced & Widgets */
.side-panel-wrapper {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.side-panel-enhanced { 
  display: flex; 
  flex-direction: column; 
  gap: 20px; 
  margin-bottom: 20px; 
}

.data-stream-widget { 
  background: #fff; 
  border: 1px solid #ddd; 
  padding: 16px; 
  box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
}

.widget-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  border-bottom: 2px solid var(--border-dark); 
  padding-bottom: 10px; 
  margin-bottom: 15px; 
}

.widget-title { 
  font-family: var(--font-header); 
  font-weight: 700; 
  font-size: 1rem; 
  color: var(--border-dark); 
  display: flex; 
  align-items: center; 
  gap: 8px; 
}

.live-indicator { 
  width: 8px; 
  height: 8px; 
  background: var(--color-success); 
  border-radius: 50%; 
  box-shadow: 0 0 5px var(--color-success); 
  animation: blink 2s infinite; 
}

.live-metric-card { 
  background: #fafafa; 
  border-left: 4px solid #333; 
  padding: 12px; 
  margin-bottom: 10px; 
  transition: transform 0.2s; 
}

.live-metric-card:hover { 
  transform: translateX(2px); 
}

.metric-row { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 6px; 
}

.metric-label { 
  font-size: 0.8rem; 
  font-weight: 700; 
  color: #555; 
}

.metric-value { 
  font-family: var(--font-tech); 
  font-weight: 700; 
  color: var(--border-dark); 
}

.metric-mini-bar { 
  height: 3px; 
  background: #eee; 
  width: 100%; 
  overflow: hidden;
  border-radius: 2px;
}

.metric-mini-fill { 
  height: 100%; 
  background: #666;
  border-radius: 2px;
}

.ai-insight-card { 
  background: #fdfbff; 
  border: 1px solid #d1c4e9; 
  padding: 16px; 
  position: relative; 
  overflow: hidden; 
}

.ai-insight-card::before { 
  content: ''; 
  position: absolute; 
  top: 0; 
  left: 0; 
  width: 4px; 
  height: 100%; 
  background: linear-gradient(to bottom, #7b1fa2, #ba68c8); 
}

.ai-header { 
  color: #6a1b9a; 
  font-weight: 700; 
  font-size: 0.9rem; 
  margin-bottom: 10px; 
  display: flex; 
  align-items: center; 
  gap: 8px; 
}

.ai-content { 
  font-size: 0.85rem; 
  color: #4a148c; 
  line-height: 1.5; 
  margin-bottom: 12px; 
}

.ai-tags { 
  display: flex; 
  gap: 6px; 
  flex-wrap: wrap; 
}

.ai-tag { 
  background: rgba(123, 31, 162, 0.1); 
  color: #7b1fa2; 
  padding: 2px 8px; 
  border-radius: 10px; 
  font-size: 0.7rem; 
  font-weight: 700; 
}

.resource-section-enhanced {
  background: #fff;
  border: 1px solid #ddd;
  padding: 16px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

.resource-section-enhanced .section-header { 
  margin-bottom: 15px;
  padding-bottom: 0;
  border-bottom: none;
}

.resource-item { 
  margin-bottom: 15px; 
}

.resource-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-end; 
  margin-bottom: 6px; 
}

.resource-header .label { 
  font-size: 0.85rem; 
  font-weight: 700; 
  color: #333; 
}

.resource-header .code { 
  font-family: var(--font-mono); 
  color: #999; 
  font-size: 0.75rem; 
  margin-right: 5px; 
}

.resource-header .percent { 
  font-family: var(--font-tech); 
  font-weight: 700;
  color: var(--text-primary);
}

.resource-bar { 
  height: 6px; 
  background: #eee; 
  border-radius: 3px; 
  overflow: hidden; 
}

.resource-fill { 
  height: 100%; 
  transition: width 0.5s ease;
  border-radius: 3px;
}

.resource-fill.low { 
  background: var(--color-critical); 
}

.resource-fill.medium { 
  background: var(--color-warning); 
}

.resource-fill.high { 
  background: var(--color-success); 
}

/* Safety Banner */
.safety-banner {
    background: #ffcc00; 
    color: #000; 
    padding: 10px 20px; 
    font-weight: bold;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    border-bottom: 2px solid #000; 
    animation: slideDown 0.5s ease;
    flex-shrink: 0;
}

.safety-banner button { 
  background: #000; 
  color: #fff; 
  border: none; 
  padding: 5px 15px; 
  font-family: var(--font-mono); 
  cursor: pointer;
  font-weight: 700;
  transition: all 0.2s;
}

.safety-banner button:hover {
  opacity: 0.8;
}


.zen-sidebar.active {
  transform: translateX(0);
}

.sidebar-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: #f0f0f0;
  border-bottom: 2px solid var(--border-dark);
  flex-shrink: 0;
}

.sb-title {
  font-weight: 900;
  font-size: 1.1rem;
  letter-spacing: 2px;
  color: var(--text-primary);
}

.sb-close {
  background: none;
  border: none;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  color: var(--text-primary);
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.sb-close:hover {
  background: var(--text-primary);
  color: #fff;
}

.sb-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 20px;
  border-bottom: 1px solid var(--border-light);
  background: #f8f8f8;
  flex-shrink: 0;
}

.sb-avatar {
  width: 40px;
  height: 40px;
  background: var(--text-primary);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  font-weight: 700;
  font-size: 1.1rem;
  flex-shrink: 0;
}

.sb-info {
  flex: 1;
  min-width: 0;
}

.sb-name {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sb-role {
  font-size: 0.75rem;
  color: var(--text-tertiary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sb-nav-list {
  list-style: none;
  padding: 0;
  margin: 0;
  flex: 1;
  overflow-y: auto;
}

.sb-nav-list li {
  padding: 16px 20px;
  cursor: pointer;
  font-family: var(--font-header);
  font-weight: 700;
  font-size: 0.95rem;
  border-bottom: 1px solid var(--border-light);
  transition: all 0.2s;
  display: flex;
  align-items: center;
  color: var(--text-secondary);
}

.sb-nav-list li:hover {
  background: var(--text-primary);
  color: #fff;
}

.sb-nav-list li.divider {
  height: 1px;
  background: var(--border-light);
  cursor: default;
  padding: 0;
  border: none;
}

.nav-num {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  color: var(--text-tertiary);
  margin-right: 10px;
  font-weight: 700;
}

.sb-footer {
  padding: 16px 20px;
  font-size: 0.75rem;
  color: var(--text-tertiary);
  text-align: center;
  border-top: 1px solid var(--border-light);
  background: #f8f8f8;
  flex-shrink: 0;
  line-height: 1.5;
  font-family: var(--font-mono);
  letter-spacing: 1px;
}

.zen-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(2px);
  z-index: 99998;
  display: none;
}

.zen-backdrop.active {
  display: block;
}

/* Animations */
@keyframes blink { 
  0% { opacity: 1; } 
  50% { opacity: 0.4; } 
  100% { opacity: 1; } 
}

@keyframes slideDown { 
  from { transform: translateY(-100%); } 
  to { transform: translateY(0); } 
}

/* 响应式 */
@media (max-width: 900px) { 
  .two-column-layout { 
    grid-template-columns: 1fr; 
  }
  
  .modal-body-grid { 
    grid-template-columns: 1fr; 
  } 
  
  .body-sidebar { 
    border-top: 1px solid #eee;
    border-right: none;
  } 
  
  .volunteer-status-panel { 
    flex-direction: column; 
    align-items: flex-start; 
    gap: 10px; 
  }

  .alert-item {
    grid-template-columns: 60px 50px 1fr 20px;
  }

  .alert-zone, .alert-time {
    display: none;
  }
}

@media (max-width: 600px) {
  .command-header {
    height: auto;
    flex-wrap: wrap;
    gap: 10px;
  }

  .logo-text {
    display: none;
  }

  .system-status {
    width: 100%;
    justify-content: flex-end;
  }

  .stats-row {
    grid-template-columns: 1fr 1fr;
  }

  .card-grid, .task-grid {
    grid-template-columns: 1fr;
  }

  .alert-item {
    grid-template-columns: 50px 1fr 20px;
  }

  .alert-priority, .alert-zone, .alert-time {
    display: none;
  }
}

 
  
  /* ============================================================
   AI TACTICAL TERMINAL V3.0 (ZZZ / ENDFIELD STYLE)
   ============================================================ */

/* 1. 卡片容器：工业白/灰底色 + 强硬边框 */
.ai-card {
    /* 背景：改为高亮的工业灰白，类似 ZZZ 的菜单背景 */
    background: #f7f8fa; 
    /* 边框：极细的灰色边框，显得精致 */
    border: 1px solid #dcdfe6;
    /* 左侧装饰线：加粗的科技蓝/黑条，增加层级感 */
    border-left: 4px solid #333; 
    /* 倒角：右上角切角效果 (模拟 CSS clip-path) */
    clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
    
    padding: 12px 16px;
    margin-bottom: 12px; /* 增加间距 */
    position: relative;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* 修复对齐问题：强制撑满父容器 */
    width: 100%;
    box-sizing: border-box;
    display: block;
}

/* 2. 悬停交互：微妙的位移和投影，不再大幅变色 */
.ai-card:hover {
    background: #ffffff;
    border-left-color: #0052cc; /* 鼠标放上去左侧变蓝 */
    box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.1); /* 硬阴影，类似漫画/二游风格 */
    transform: translate(-2px, -2px);
}

/* 3. 标题区域：加粗、大写、工业风 */
.ai-head {
    font-family: 'Impact', 'Arial Black', sans-serif; /* 硬朗字体 */
    font-size: 14px;
    color: #1a1a1a; /* 深黑色标题 */
    letter-spacing: 1px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    border-bottom: 2px solid #eaeaea; /* 分割线 */
    padding-bottom: 6px;
}

/* 4. 图标动画：改为更利落的闪烁 */
.ai-pulse {
    color: #ff6600; /* 终末地风格的橙色点缀 */
    margin-right: 8px;
    font-size: 12px;
}

/* 5. 内容文本：高清晰度深灰 */
.ai-text {
    font-family: 'Roboto Mono', 'Consolas', monospace; /* 等宽字体 */
    font-size: 13px;
    line-height: 1.5;
    color: #4a4a4a; /* 深灰，保证在白底上看不清 */
    font-weight: 500;
}

/* 6. 数据胶囊 (Server端生成的标签) 的样式适配 */
/* 需要配合 Server Script 生成的 class='ai-tag' */
.ai-tag {
    display: inline-block;
    background: #ebeef5; /* 浅灰底 */
    color: #606266;      /* 深灰字 */
    padding: 2px 6px;
    font-size: 11px;
    font-weight: bold;
    border-radius: 2px;  /* 微圆角 */
    margin-right: 6px;
    border: 1px solid #dcdfe6;
    text-transform: uppercase;
}

/* 警告级别 - 覆盖上面的默认色 */
.ai-level-critical { 
    background: #fef0f0; 
    color: #f56c6c; 
    border-color: #fde2e2; 
}

/* 7. 装饰性背景纹理 (可选，增加科技感) */
.ai-card::before {
    content: "///";
    position: absolute;
    right: 5px;
    bottom: 0px;
    font-size: 20px;
    font-weight: 900;
    color: rgba(0,0,0,0.05);
    pointer-events: none;
}
</style>

<style>
/* ═════════════════════════════════════════════════════════════════════
   PART 24: KANBAN BOARD ARCHITECTURE (NEW) - INJECTED VIA HTML
   ═════════════════════════════════════════════════════════════════════ */
.kanban-board-wrapper {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 180px); /* 减去头部高度，强制占据剩余屏高 */
  overflow: hidden;
}

.kanban-controls {
  margin-bottom: 10px;
  display: flex;
  justify-content: flex-end;
}

.kanban-board {
  display: flex;
  gap: 16px;
  height: 100%;
  overflow-x: auto; /* 允许横向滚动 */
  padding-bottom: 10px;
  scroll-behavior: smooth;
  scroll-snap-type: x mandatory; /* 移动端捕捉体验 */
}

.kanban-column {
  flex: 1;
  min-width: 320px; /* 保证卡片最小宽度 */
  max-width: 450px;
  display: flex;
  flex-direction: column;
  background: rgba(255, 255, 255, 0.5);
  border: 1px solid var(--border-mid);
  border-top: 4px solid var(--text-tertiary); /* 默认顶部色条 */
  border-radius: 4px;
  scroll-snap-align: center; /* 滚动捕捉点 */
  transition: all 0.3s;
}

/* 列状态色定义 */
.col-todo { border-top-color: var(--text-secondary); background: linear-gradient(180deg, rgba(0,0,0,0.02) 0%, transparent 100%); }
.col-active { border-top-color: var(--color-info); background: linear-gradient(180deg, rgba(68,170,255,0.05) 0%, transparent 100%); }
.col-done { border-top-color: var(--color-success); background: linear-gradient(180deg, rgba(0,255,136,0.05) 0%, transparent 100%); }
.col-cancelled { border-top-color: var(--text-tertiary); opacity: 0.8; background: #f0f0f0; }

.kanban-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-mid);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 1px;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  flex-shrink: 0; /* 防止头被压缩 */
}

.kanban-count {
  background: var(--bg-primary);
  padding: 2px 8px;
  border-radius: 10px;
  font-family: var(--font-mono);
  font-size: 11px;
  border: 1px solid var(--border-mid);
}

.kanban-body {
  flex: 1;
  overflow-y: auto; /* 列内部垂直滚动 */
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* 针对看板内部卡片的微调 */
.kanban-body .jira-card {
  margin-bottom: 0; /* 移除原有margin，由gap控制 */
  border-left-width: 4px; /* 加强左侧优先级指示 */
}

/* 移动端优化 */
@media (max-width: 768px) {
  .kanban-board {
    padding-right: 20px; /* 右侧留白 */
  }
  .kanban-column {
    min-width: 85vw; /* 手机上几乎占满全屏 */
  }
}
</style>

<style>
/* ═════════════════════════════════════════════════════════════════════
   PART 25: VISUAL ENHANCEMENT (HUD & RESOURCES FIX)
   ═════════════════════════════════════════════════════════════════════ */

/* 1. 修复 System Resources (强制 5 行垂直排列) */
.resource-list-vertical {
    display: flex;
    flex-direction: column;
    gap: 16px; /* 增加间距 */
}

.resource-item {
    margin: 0; /* 重置 */
}

.resource-bar-container {
    height: 8px;
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 6px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
}

  @keyframes progress-stripes {
    from { background-position: 1rem 0; }
    to { background-position: 0 0; }
}

/* 2. Process Intelligence HUD (情报面板美化) */
.monitoring-panel {
    border: 1px solid #ccc;
    background: #fff;
    /* 移除之前的 grid/flex 设置，改为内部布局 */
}

.hud-grid {
    display: grid;
    grid-template-columns: 140px 1fr 280px; /* 左仪表 | 中数据 | 右终端 */
    gap: 24px;
    align-items: stretch;
}

/* 左侧：仪表盘区域 */
.hud-gauge-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-right: 1px dashed #ddd;
    padding-right: 20px;
}

/* 中间：核心指标 (卡片化) */
.hud-metrics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    align-content: start;
}

.hud-metric-card {
    background: #f9f9f9;
    border: 1px solid #eee;
    padding: 12px;
    border-radius: 4px;
    text-align: center;
    transition: all 0.2s;
}

.hud-metric-card:hover {
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    transform: translateY(-2px);
    border-color: var(--accent-primary);
}

.hud-label {
    font-size: 10px;
    color: #999;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.hud-value {
    font-size: 24px;
    font-family: var(--font-tech);
    font-weight: 800;
    color: #333;
    margin-top: 4px;
}
  
  /* ═════════════════════════════════════════════════════════════════════
   PART 26 & 27: TACTICAL CONTROLS (FIXED: PUSH LAYOUT & CONTRAST)
   ═════════════════════════════════════════════════════════════════════ */

  /* [修复3] 看板宽度铺开 */
.kanban-board-wrapper {
    flex: 1; /* 占据剩余高度 */
    width: 100%; /* 强制全宽 */
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.kanban-board {
    display: flex;
    gap: 16px;
    height: 100%;
    width: 100%; /* 关键：强制占满容器 */
    overflow-x: auto;
    padding-bottom: 10px;
}

.kanban-column {
    flex: 1 0 300px; /* flex-grow: 1 (铺开), flex-shrink: 0 (不挤压), basis: 300px */
    max-width: none; /* 移除最大宽度限制，允许铺满 */
    display: flex;
    flex-direction: column;
}
  
/* 容器：防止子元素溢出 */
.tactical-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-right: 15px;
    padding-right: 15px;
    border-right: 1px solid rgba(0,0,0,0.1);
    height: 32px; /* 固定高度，防止抖动 */
}

/* --- 1. 搜索框修复 (使用推挤动画) --- */
.tactical-search {
    position: relative;
    width: 160px; /* 默认宽度 */
    height: 100%;
    /* 关键：当内部元素聚焦时，容器变宽，推开右侧元素 */
    transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.tactical-search:focus-within {
    width: 240px; /* 展开后的宽度 */
}

.tactical-search i {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #666; /* 强制深灰图标 */
    font-size: 12px;
    z-index: 2;
    pointer-events: none;
}

.tactical-search input {
    width: 100%;
    height: 100%;
    padding: 0 10px 0 30px; /* 左侧留出图标位置 */
    border: 1px solid #ccc; /* 加深边框 */
    background: #fff; /* 强制纯白背景 */
    color: #333;      /* 强制深灰文字 */
    border-radius: 4px;
    font-size: 12px;
    font-family: sans-serif;
    outline: none;
    box-sizing: border-box; /* 确保padding不撑大 */
}

.tactical-search input:focus {
    border-color: #333;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* 占位符颜色 */
.tactical-search input::placeholder {
    color: #999;
}

/* --- 2. 下拉菜单修复 (强制可见性) --- */
.tactical-select {
    height: 100%;
    padding: 0 30px 0 10px;
    border: 1px solid #ccc;
    /* 强制纯白背景 + 深色箭头 */
    background-color: #fff !important;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 10px;
    border-radius: 4px;
    font-size: 12px;
    color: #333 !important; /* 强制深黑文字 */
    font-weight: 600;
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    min-width: 120px;
    outline: none;
}

.tactical-select:focus {
    border-color: #333;
}

/* 修复右侧文字看不清的问题 */
.section-tag {
    color: #333 !important;
    background: #e0e0e0 !important;
    border: 1px solid #ccc !important;
}
  
/* ═════════════════════════════════════════════════════════════════════
   TERMINAL STYLE REVISION (HIGH CONTRAST B&W)
   ═════════════════════════════════════════════════════════════════════ */

/* 右侧：虚拟终端 (Terminal) - 改为纯黑白高对比模式 */
.hud-terminal {
    background: #000000; /* 纯黑背景，对比度最高 */
    color: #ffffff;      /* 纯白文字 */
    /* 使用系统自带的等宽字体，确保清晰度，不再依赖外部字体 */
    font-family: "Consolas", "Monaco", "Courier New", monospace; 
    padding: 12px;
    border-radius: 4px;
    height: 100%;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    font-size: 12px; /* 稍微调大字号 */
    border: 1px solid #444; /* 边框稍微亮一点 */
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.terminal-header {
    border-bottom: 1px solid #666; /* 分割线加亮 */
    padding-bottom: 8px;
    margin-bottom: 8px;
    color: #ffffff;
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    letter-spacing: 1px;
}

.terminal-body {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px; /* 增加行间距，防止拥挤 */
}

.term-line {
    display: flex;
    gap: 10px; /* 拉开时间与内容的距离 */
    align-items: baseline;
}

/* 时间戳：灰色，作为辅助信息 */
.term-time { 
    color: #888888; 
    font-size: 11px;
    min-width: 45px; /* 对齐 */
}

/* 命令/用户：高亮白色，加粗 */
.term-cmd { 
    color: #ffffff; 
    font-weight: 800; 
    text-shadow: 0 0 1px rgba(255,255,255,0.8); /* 微发光增强清晰度 */
}

/* 消息内容：亮银色 */
.term-msg { 
    color: #e0e0e0; 
}

/* 告警状态保持彩色以便区分，但调亮亮度 */
.term-line.warning .term-msg { color: #ffff00; font-weight:bold; } /* 亮黄 */
.term-line.critical .term-msg { color: #ff3333; font-weight:bold; } /* 亮红 */

/* 滚动条美化 (针对 Chrome/Safari) */
.terminal-body::-webkit-scrollbar {
    width: 6px;
}
.terminal-body::-webkit-scrollbar-track {
    background: #111;
}
.terminal-body::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
}

.term-line.warning .term-msg { color: #ff9500; }
.term-line.critical .term-msg { color: #ff3b30; }

/* 响应式调整 */
@media (max-width: 1100px) {
    .hud-grid {
        grid-template-columns: 1fr; /* 变为单列堆叠 */
        gap: 20px;
    }
    .hud-gauge-section {
        border-right: none;
        border-bottom: 1px dashed #ddd;
        padding-bottom: 20px;
        padding-right: 0;
        flex-direction: row; /* 横向排列仪表 */
        gap: 20px;
    }
    .hud-terminal {
        min-height: 150px;
    }
}
  
  /* ═════════════════════════════════════════════════════════════════════
   PART 28: RESTORE DYNAMIC FEEL (SMOOTH PULSE & GLOW)
   ═════════════════════════════════════════════════════════════════════ */

/* 1. 定义柔和的呼吸动画 (不再是剧烈的闪烁) */
@keyframes soft-pulse {
    0% { opacity: 1; text-shadow: 0 0 5px #4cd964; }
    50% { opacity: 0.4; text-shadow: 0 0 2px #4cd964; }
    100% { opacity: 1; text-shadow: 0 0 5px #4cd964; }
}

/* 2. 应用到 LIVE 指示器 */
.terminal-header .live-static {
    color: #4cd964 !important; /* 鲜艳的终端绿 */
    font-weight: 900;
    animation: soft-pulse 3s infinite ease-in-out; /* 3秒一次，非常平滑 */
    display: inline-block;
}

/* 3. 增强终端文字的“荧光感” (CRT 风格) */
.hud-terminal {
    /* 给整个黑底加上微弱的绿色泛光 */
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 50, 0, 0.1); 
    border: 1px solid #333;
}

.term-cmd {
    /* 命令部分加亮显示 */
    color: #fff;
    text-shadow: 0 0 3px rgba(255, 255, 255, 0.5);
}

.term-time {
    /* 时间戳微弱发光 */
    color: #888;
}

/* 4. 让滚动条看起来更像系统原生 */
.terminal-body::-webkit-scrollbar-thumb {
    background: #333;
    border: 1px solid #000;
}
</style>

<style>
/* ═════════════════════════════════════════════════════════════════════
   PART 99: ULTIMATE FIXES (V5.0)
   ═════════════════════════════════════════════════════════════════════ */

/* 1. 消除“黑框”/系统提示条 */
/* 隐藏所有 ServiceNow 原生的消息容器 */
.alert, 
.alert-info, 
.alert-success, 
.alert-warning,
.alert-danger,
.outputmsg_div, 
.outputmsg_container,
.notification-container,
.system-message-container,
#ui_notification {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    opacity: 0 !important;
    pointer-events: none !important;
}

/* 2. 修复任务数(Load)溢出问题 */
.dr-load-display {
    display: flex;
    align-items: flex-end;
    flex-wrap: wrap; /* 关键：允许换行，防止挤出容器 */
    overflow: hidden; /* 超出部分隐藏 */
    max-width: 100%;
}

.big-num {
    font-size: 28px !important; /*稍微调小一点字体 */
    line-height: 1;
    margin-right: 5px;
}

.sub-text {
    font-size: 10px !important;
    white-space: nowrap;
}

/* 3. 确保下拉菜单可见 */
.cap-select {
    width: 100%;
    max-width: 200px;
    background: #fff;
    color: #333;
    border: 1px solid #ccc;
    padding: 6px 10px;
    font-size: 14px;
    font-weight: 700;
    font-family: var(--font-mono);
    border-radius: 2px;
    cursor: pointer;
    appearance: auto;
    -webkit-appearance: auto;
}

.cap-select:focus {
    border-color: #000;
    outline: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.cap-select option {
    background: #fff;
    color: #333;
    padding: 8px;
}
/* ═══════════════════════════════════════════════════════════════
   PART: COMMS CENTER STYLES
   ═══════════════════════════════════════════════════════════════ */

/* --- Broadcast Composer --- */
.broadcast-composer {
    background: #fff;
    border: 1px solid #ddd;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

.broadcast-type-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.broadcast-type-btn {
    flex: 1;
    padding: 10px 16px;
    border: 2px solid #e0e0e0;
    background: #fff;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.broadcast-type-btn:hover { border-color: #999; }

.broadcast-type-btn.active {
    border-color: #000;
    background: #000;
    color: #fff;
}

.broadcast-type-btn:first-child.active {
    background: #cf222e;
    border-color: #cf222e;
}

.broadcast-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.broadcast-title-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #ddd;
    font-size: 16px;
    font-weight: 700;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.broadcast-title-input:focus { border-color: #000; }

.broadcast-body-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #ddd;
    font-size: 14px;
    resize: vertical;
    min-height: 80px;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.broadcast-body-input:focus { border-color: #000; }

.broadcast-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.broadcast-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: #999;
}

.broadcast-type-label {
    padding: 3px 8px;
    font-weight: 700;
    font-size: 11px;
    border-radius: 2px;
}

.broadcast-type-label.type-emergency { background: rgba(207,34,46,0.1); color: #cf222e; }
.broadcast-type-label.type-announcement { background: rgba(210,153,34,0.1); color: #d29922; }
.broadcast-type-label.type-internal { background: rgba(0,0,0,0.05); color: #666; }

.broadcast-send-btn {
    padding: 10px 24px;
    background: #e0e0e0;
    color: #999;
    border: none;
    font-weight: 800;
    font-size: 13px;
    letter-spacing: 1px;
    cursor: not-allowed;
    transition: all 0.2s;
}

.broadcast-send-btn.ready {
    background: #000;
    color: #fff;
    cursor: pointer;
}

.broadcast-send-btn.ready:hover {
    background: #333;
    transform: translateY(-1px);
}

/* --- Timeline --- */
.comms-timeline {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 600px;
    overflow-y: auto;
    padding-right: 8px;
}

.comm-item {
    background: #fff;
    border: 1px solid #e0e0e0;
    display: flex;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
}

.comm-item:hover {
    border-color: #999;
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.comm-priority-bar {
    width: 4px;
    flex-shrink: 0;
    background: #e0e0e0;
}

.comm-priority-bar.bar-emergency { background: #cf222e; }
.comm-priority-bar.bar-announcement { background: #d29922; }
.comm-priority-bar.bar-internal { background: #999; }

.comm-content {
    flex: 1;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.comm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comm-type-badge {
    font-size: 11px;
    font-weight: 800;
    padding: 2px 8px;
    border-radius: 2px;
    letter-spacing: 1px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.comm-type-badge.badge-emergency { background: rgba(207,34,46,0.1); color: #cf222e; }
.comm-type-badge.badge-announcement { background: rgba(210,153,34,0.1); color: #d29922; }
.comm-type-badge.badge-internal { background: rgba(0,0,0,0.05); color: #666; }

.comm-time { font-size: 11px; color: #999; }
.comm-title { font-weight: 800; font-size: 16px; color: #1a1a1a; }
.comm-body-preview { font-size: 13px; color: #666; line-height: 1.5; }

.comm-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #999;
    padding-top: 8px;
    border-top: 1px dashed #eee;
}

.comm-author { font-weight: 600; }

/* --- Detail Overlay --- */
.comm-detail-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 3000;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.comm-detail-panel {
    background: #fff;
    width: 100%;
    max-width: 640px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    position: relative;
}

.comm-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comm-detail-body {
    font-size: 15px;
    line-height: 1.8;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

/* --- Filter Button Active State --- */
.btn-jira.active {
    background: #000 !important;
    color: #fff !important;
    border-color: #000 !important;
}
  /* --- Delete Confirm Modal --- */
.delete-confirm-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 4000;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.15s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.delete-confirm-panel {
    background: #fff;
    width: 420px;
    max-width: 90vw;
    padding: 32px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.2s ease;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.delete-confirm-icon {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: rgba(207,34,46,0.1);
    color: #cf222e;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.delete-confirm-title {
    font-size: 18px;
    font-weight: 800;
    margin: 0 0 16px;
    color: #1a1a1a;
}

.delete-confirm-msg-info {
    background: #f8f8f8;
    padding: 12px 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    font-size: 14px;
}

.delete-confirm-warning {
    font-size: 12px;
    color: #999;
    margin-bottom: 24px;
}

.delete-confirm-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.delete-btn-cancel {
    padding: 10px 28px;
    background: #f0f0f0;
    border: 1px solid #ddd;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.delete-btn-cancel:hover {
    background: #e0e0e0;
}

.delete-btn-confirm {
    padding: 10px 28px;
    background: #cf222e;
    color: #fff;
    border: none;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.delete-btn-confirm:hover {
    background: #a71d2a;
    transform: translateY(-1px);
}
</style>

<!-- ============================================================
     主容器 — 单一顶层包裹 (FIX 1: 移除重复嵌套容器)
     ============================================================ -->
<div class="kokoro-volunteer-container">

    <!-- 安全横幅 (FIX 2: 合并为一个，使用 ng-if 条件 + 默认消息) -->
<div class="sys-alert-strip" ng-if="true"> <div class="alert-deco">/// SYSTEM_OVERRIDE ///</div>
    
    <div class="alert-body">
        <i class="fa fa-exclamation-triangle"></i> 
        <span class="alert-text">
            {{c.data.emergencyAlert || '現在、余震警報発令中。安全を確保してください。'}}
        </span>
    </div>

    <button class="sys-btn-ghost" ng-click="c.goToUserView()">
        [ USER_VIEW ]
    </button>
</div>

    <!-- 命令头 -->
    <div class="command-header">
        <button class="hamburger-btn" ng-click="c.toggleSidebar()">
            <i class="fa fa-bars"></i>
        </button>
        <div class="command-logo">
            <div class="logo-icon">K</div>
            <div class="logo-text">
                <span class="logo-title">KOKORO</span>
                <span class="logo-subtitle">VOLUNTEER_INTERFACE</span>
            </div>
        </div>
        <div class="system-status">
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span class="status-text">SYS_ONLINE</span>
            </div>
            <span class="version-tag">v4.1.0-zenless</span>
            <span class="system-time">{{c.currentTime}}</span>
        </div>
    </div>

    <!-- 导航标签 -->
    <div class="nav-tabs-custom">
        <div class="tab" ng-class="{'active': c.view === 'dashboard'}" ng-click="c.view = 'dashboard'">
            <span class="tab-number">01</span> / OVERVIEW
        </div>
        <div class="tab" ng-class="{'active': c.view === 'tactical'}" ng-click="c.view = 'tactical'">
            <span class="tab-number">02</span> / TACTICAL
        </div>
        <div class="tab" ng-class="{'active': c.view === 'mine'}" ng-click="c.view = 'mine'">
    <span class="tab-number">03</span> / OPERATORS ({{c.data.volunteers.length || 0}})
</div>
        <div class="tab" ng-class="{'active': c.view === 'comms'}" ng-click="c.view = 'comms'">
    <span class="tab-number">04</span> / COMMS ({{c.data.announcements.length || 0}})
</div>
    </div>
  
  <div class="board-container">
      
        <div class="view-dashboard" ng-if="c.view === 'dashboard'" style="height:100%; display:flex; flex-direction:column;">

            <div class="volunteer-status-panel" ng-if="c.data.isVolunteer">
                <div class="status-row">
                    <i class="fa fa-power-off"></i>
                    <span>状態:</span>
                    <button ng-click="c.toggleAvailability()" 
                            ng-class="{'btn-online': c.volunteerStatus.isOnline, 'btn-offline': !c.volunteerStatus.isOnline}">
                        {{c.volunteerStatus.isOnline ? 'ONLINE' : 'OFFLINE'}}
                    </button>
                </div>
                <div class="status-row">
                    <i class="fa fa-map-pin"></i>
                    <span>現在地:</span>
                    <select ng-model="c.volunteerStatus.currentZone" ng-change="c.updateMyLocation(c.volunteerStatus.currentZone)">
                        <option value="">-- SELECT ZONE --</option>
                        <option value="Family Area">FAMILY_AREA</option>
                        <option value="Single Area">SINGLE_AREA</option>
                        <option value="Medical Area">MEDICAL_AREA</option>
                        <option value="Staff Room">STAFF_ROOM</option>
                    </select>
                </div>
            </div>

            <div class="metal-divider-glow" style="margin-bottom:20px;"></div>

            <div class="two-column-layout">
                <div class="main-system-panel" style="display:flex; flex-direction:column; gap:20px;">
                    <div class="resource-section-enhanced">
                        <div class="section-header">
                            <span class="section-tag">01</span>
                            <span class="section-title">SYSTEM_RESOURCES</span>
                            <span class="section-time" style="color:#666; font-weight:700;">
                                STOCK_LEVEL: {{c.data.resourceStatus[0].percent}}% AVG
                            </span>
                        </div>
                      
                        <div class="resource-list-vertical">
                            <div class="resource-item" ng-repeat="res in c.data.resourceStatus track by $index">
                                <div class="resource-header">
                                 <div class="label">
    {{ res.name || res.category || res.label }}
</div>   
                                    <span class="percent" ng-class="{'text-danger': res.percent < 30}">{{res.percent}}%</span>
                                </div>
                                <div class="resource-bar-container">
                                    <div class="resource-fill" 
                                         ng-class="{'low': res.percent < 30, 'medium': res.percent >= 30 && res.percent < 60, 'high': res.percent >= 60}" 
                                         ng-style="{width: res.percent + '%'}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                   
                 
										
                    <div class="monitoring-panel" ng-if="c.data.processMiningStats">
                        <div class="section-header" style="padding: 0 0 15px 0; margin-bottom: 15px;">
                            <span class="section-tag">02</span>
                            <span class="section-title">PROCESS_INTELLIGENCE</span>
                        </div>
                        <div class="hud-grid">
                            <div class="hud-gauge-section">
                                <div class="gauge-circle" ng-class="c.getHealthStatusDisplay().class" style="width:100px; height:100px; border-width:6px;">
                                    <div class="gauge-value" style="font-size:32px;">{{c.data.overallHealth.score}}</div>
                                    <div class="gauge-label">SYS_HEALTH</div>
                                </div>
                                <div class="gauge-status" ng-style="{color: c.getHealthStatusDisplay().color}" style="margin-top:10px; font-size:14px; font-weight:bold;">
                                    {{c.getHealthStatusDisplay().text}}
                                </div>
                            </div>
                            <div class="hud-metrics-grid">
                                <div class="hud-metric-card">
                                    <div class="hud-label">TOTAL EVENTS</div>
                                    <div class="hud-value">{{c.data.processMiningStats.totalEvents}}</div>
                                </div>
                                <div class="hud-metric-card">
                                    <div class="hud-label">TODAY</div>
                                    <div class="hud-value">{{c.data.processMiningStats.todayEvents}}</div>
                                </div>
                                <div class="hud-metric-card">
                                    <div class="hud-label">CASES</div>
                                    <div class="hud-value">{{c.data.processMiningStats.uniqueCases}}</div>
                                </div>
                                <div class="hud-metric-card" ng-class="{'alert-bg': c.data.slaStats.breached > 0}" style="grid-column: span 3; display:flex; justify-content:space-between; align-items:center; padding:10px 20px;">
                                    <div style="text-align:left;">
                                        <div class="hud-label" style="color:var(--color-critical);">SLA VIOLATIONS</div>
                                        <div class="hud-value" style="font-size:18px; color:var(--color-critical);">{{c.data.slaStats.breached || 0}}</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div class="hud-label">AUDIT LOGS (24H)</div>
                                        <div class="hud-value" style="font-size:18px;">{{c.data.auditStats.todayLogs || 0}}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="hud-terminal">
                                <div class="terminal-header">
                                    <span>>_ SYSTEM_LOG</span>
                                    <span class="live-static">● LIVE</span>
                                </div>
                                <div class="terminal-body">
                                    <div class="term-line" ng-if="c.data.slaStats.breached > 0">
                                        <span class="term-time">[ALERT]</span>
                                        <span class="term-msg critical">SLA BREACH DETECTED: {{c.data.slaStats.breached}} count</span>
                                    </div>
                                    <div class="term-line" ng-repeat="act in c.data.processMiningStats.topActivities | limitTo:3">
                                        <span class="term-time">ACTv</span>
                                        <span class="term-cmd">{{act.name}}</span>
                                        <span class="term-msg">x{{act.count}}</span>
                                    </div>
                                    <div class="term-line" ng-repeat="audit in c.data.auditStats.recentActions | limitTo:4">
                                        <span class="term-time">{{audit.time.split(' ')[1] || '00:00'}}</span>
                                        <span class="term-cmd">{{audit.user}}</span>
                                        <span class="term-msg">{{audit.action}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="refresh-btn" ng-click="c.refreshMonitoringData()" style="margin-top:15px;">
                            <i class="fa fa-refresh"></i> REFRESH INTELLIGENCE
                        </button>
                    </div>
                </div>

                <div class="side-panel-wrapper">
                    <div class="data-stream-widget">
                        <div class="widget-header">
                            <div class="widget-title"><i class="fa fa-chart-line"></i> REALTIME</div>
                            <div class="live-indicator"></div>
                        </div>
                        <div class="live-metric-card">
                            <div class="metric-row"><span class="metric-label">応答率</span><span class="metric-value">94%</span></div>
                            <div class="metric-mini-bar"><div class="metric-mini-fill" style="width: 94%"></div></div>
                        </div>
                        <div class="live-metric-card">
                            <div class="metric-row"><span class="metric-label">待機タスク</span><span class="metric-value">{{c.data.openCount || 0}}</span></div>
                            <div class="metric-mini-bar"><div class="metric-mini-fill" style="width: 78%"></div></div>
                        </div>
                    </div>
                   <div class="ticket-card-body" style="flex-grow:1;"></div>
    </div> 
</div>
</div>

        <div class="view-tactical" ng-if="c.view === 'tactical'" style="height:100%; display:flex; flex-direction:column;">
            
            <div class="stats-section" style="margin-bottom: 20px;">
                <div class="section-header">
                    <span class="section-tag">01</span>
                    <span class="section-title">METRICS_OVERVIEW</span>
                    <span class="section-time">{{c.currentTime}}</span>
                </div>
                <div class="stats-row">
                    <div class="stat-card clickable" ng-click="c.filterByUrgency('Critical')">
                        <div class="stat-label"><span class="stat-code">REQ</span><span class="stat-suffix">_01</span></div>
                        <div class="stat-num">{{c.data.sosCount || 0}}</div>
                        <div class="stat-name">CRITICAL_SOS</div>
                        <div class="stat-footer">
                            <span class="stat-status" ng-class="{'critical': c.data.sosCount > 0, 'nominal': c.data.sosCount === 0}">{{c.data.sosCount > 0 ? 'ALERT' : 'NOMINAL'}}</span>
                        </div>
                    </div>
                    <div class="stat-card clickable" ng-click="c.filterByAssignment('unassigned')">
                        <div class="stat-label"><span class="stat-code">OPN</span><span class="stat-suffix">_02</span></div>
                        <div class="stat-num">{{c.data.openCount || 0}}</div>
                        <div class="stat-name">UNASSIGNED</div>
                        <div class="stat-footer">
                            <span class="stat-status" ng-class="{'warning': c.data.openCount > 5, 'nominal': c.data.openCount <= 5}">{{c.data.openCount > 5 ? 'BACKLOG' : 'NOMINAL'}}</span>
                        </div>
                    </div>
                    <div class="stat-card clickable" ng-click="c.clearFilters()">
                        <div class="stat-label"><span class="stat-code">TOT</span><span class="stat-suffix">_03</span></div>
                        <div class="stat-num">{{c.data.list.length || 0}}</div>
                        <div class="stat-name">TOTAL_ACTIVE</div>
                        <div class="stat-footer"><span class="stat-status nominal">TRACKING</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label"><span class="stat-code">OPR</span><span class="stat-suffix">_04</span></div>
                        <div class="stat-num">{{c.data.volunteers.length || '--'}}</div>
                        <div class="stat-name">OPERATORS</div>
                        <div class="stat-footer"><span class="stat-status nominal">ONLINE</span></div>
                    </div>
                </div>
            </div>

            <div class="card-section" ng-if="c.view === 'tactical'" style="height:100%; margin-bottom:0; margin-top:20px;">
                
                <div class="section-header">
                    <span class="section-tag">02</span>
                    <span class="section-title">TACTICAL_BOARD</span>
                    
                    <div class="tactical-controls" style="margin-left: auto;">
                        <div class="tactical-search">
                            <i class="fa fa-search"></i>
                            <input type="text" 
                                   placeholder="SEARCH (ID, LOC, USER)..." 
                                   ng-model="c.tacticalSearchText" 
                                   ng-change="c.organizeKanban()">
                        </div>
                        
                        <select class="tactical-select" 
                                ng-model="c.tacticalFilterPriority" 
                                ng-change="c.organizeKanban()">
                            <option value="">ALL_PRIORITY</option>
                            <option value="Critical">CRITICAL</option>
                            <option value="High">HIGH</option>
                            <option value="Moderate">MODERATE</option>
                            <option value="Low">LOW</option>
                        </select>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center;">
                        <button class="btn-jira" 
                                style="margin:0; padding:6px 12px; font-size:11px; width:auto;"
                                ng-class="{'active': c.showCancelledCol}"
                                ng-click="c.toggleCancelledColumn()">
                            <i class="fa" ng-class="c.showCancelledCol ? 'fa-eye-slash' : 'fa-eye'"></i> 
                            {{c.showCancelledCol ? 'HIDE' : 'SHOW'}}
                        </button>
                        
                        <span class="section-tag" style="background:var(--border-mid); box-shadow:none;">
                            {{(c.kanbanData.todo.length + c.kanbanData.active.length + c.kanbanData.done.length)}} VISIBLE
                        </span>
                    </div>
                </div>

                <div class="kanban-board-wrapper">
                    <div class="kanban-board">
                        
                        <div class="kanban-column col-todo">
                            <div class="kanban-header">
                                <span><i class="fa fa-inbox"></i> BACKLOG</span>
                                <span class="kanban-count">{{c.kanbanData.todo.length}}</span>
                            </div>
                            <div class="kanban-body">
                                <div class="jira-card" 
                                     ng-class="'priority-' + item.urgency" 
                                     ng-repeat="item in c.kanbanData.todo" 
                                     ng-click="c.openModal(item)">
                                    <div class="card-top">
                                        <span class="card-id">{{item.number}}</span>
                                        <span class="priority-badge" ng-class="'priority-' + item.urgency" style="padding:2px 6px; font-size:10px;">{{item.urgency}}</span>
                                    </div>
                                    <div class="card-title" style="font-size:14px;">
                                        {{c.dict[item.category] || item.category}} <span class="qty-badge">x{{item.quantity}}</span>
                                    </div>
                                    <div class="card-loc"><i class="fa fa-map-marker"></i> {{item.zone}}</div>
                                    <div class="metal-divider" style="margin:8px 0;"></div>
                                    <div style="font-size:11px; color:#999;">{{item.time_24h}}</div>
                                </div>
                                <div class="empty-board" ng-if="c.kanbanData.todo.length === 0" style="padding:20px;">
                                    <i class="fa fa-check" style="font-size:24px;"></i>
                                    <p style="font-size:12px;">NO TASKS</p>
                                </div>
                            </div>
                        </div>

                        <div class="kanban-column col-active">
                            <div class="kanban-header">
                                <span><i class="fa fa-spinner fa-spin"></i> ACTIVE OPS</span>
                                <span class="kanban-count">{{c.kanbanData.active.length}}</span>
                            </div>
                            <div class="kanban-body">
                                <div class="jira-card" 
                                     ng-class="'priority-' + item.urgency" 
                                     ng-repeat="item in c.kanbanData.active" 
                                     ng-click="c.openModal(item)">
                                    <div class="card-top">
                                        <span class="card-id">{{item.number}}</span>
                                        <span class="status-tag status-11">{{c.statusNames[item.state]}}</span>
                                    </div>
                                    <div class="card-title" style="font-size:14px;">
                                        {{c.dict[item.category] || item.category}} <span class="qty-badge">x{{item.quantity}}</span>
                                    </div>
                                    <div style="background:rgba(0,0,0,0.05); padding:6px; border-radius:4px; margin-bottom:8px; font-size:12px; display:flex; align-items:center; gap:6px;">
                                        <div class="avatar-box" style="width:20px; height:20px; font-size:10px;">{{item.assigned_to_name.charAt(0)}}</div>
                                        <strong>{{item.assigned_to_name}}</strong>
                                    </div>
                                    <div class="card-sla" ng-if="item.sla" style="margin:8px 0; padding-top:8px;">
                                        <div class="sla-bar-container" style="height:4px;">
                                            <div class="sla-bar" ng-style="{width: item.sla.percentage + '%', background: c.getSLABarColor(item.sla)}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="kanban-column col-done">
                            <div class="kanban-header">
                                <span><i class="fa fa-trophy"></i> COMPLETED</span>
                                <span class="kanban-count">{{c.kanbanData.done.length}}</span>
                            </div>
                            <div class="kanban-body">
                                <div class="jira-card" 
                                     ng-repeat="item in c.kanbanData.done" 
                                     ng-click="c.openModal(item)"
                                     style="opacity:0.8; border-left-color:var(--color-success);">
                                    <div class="card-top">
                                        <span class="card-id" style="text-decoration:line-through;">{{item.number}}</span>
                                        <i class="fa fa-check-circle" style="color:var(--color-success);"></i>
                                    </div>
                                    <div class="card-title" style="font-size:14px; color:#666;">
                                        {{c.dict[item.category] || item.category}}
                                    </div>
                                    <div style="font-size:11px; color:#999;">
                                        Resolved by: {{item.assigned_to_name}}<br>
                                        {{item.time_ago}}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="kanban-column col-cancelled" ng-if="c.showCancelledCol">
                            <div class="kanban-header">
                                <span><i class="fa fa-ban"></i> CANCELLED</span>
                                <span class="kanban-count">{{c.kanbanData.cancelled.length}}</span>
                            </div>
                            <div class="kanban-body">
                                <div class="jira-card" 
                                     ng-repeat="item in c.kanbanData.cancelled" 
                                     ng-click="c.openModal(item)"
                                     style="opacity:0.6; filter:grayscale(100%);">
                                    <div class="card-top">
                                        <span class="card-id">{{item.number}}</span>
                                        <span class="status-tag" style="background:#333; color:#fff;">VOID</span>
                                    </div>
                                    <div class="card-title" style="font-size:14px; text-decoration:line-through;">
                                        {{c.dict[item.category] || item.category}}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    
        <!-- END: view-dashboard -->
          
    <div class="view-mine" ng-if="c.view === 'mine'">
    <div class="card-section">
        <div class="section-header">
            <span class="section-tag">03</span>
            <span class="section-title">UNIT_ROSTER // 隊員編成</span>
            <span class="section-tag" style="margin-left:auto; background:var(--bg-tertiary);">
                {{c.data.volunteers.length}} UNITS
            </span>
        </div>

        <div class="roster-grid">
            <div class="tcg-card" 
                 ng-repeat="vol in c.data.volunteers"
                 ng-click="c.openUserModal(vol)">
                
                <div class="tcg-top">
                    <span class="tcg-type">{{vol.capability || 'SUPPORT'}}</span>
                    <div class="tcg-status-dot" ng-class="vol.status_class"></div>
                </div>

                <div class="tcg-image-box">
                    <div class="tcg-avatar" 
                         ng-style="vol.photo ? {'background-image': 'url(' + vol.photo + ')'} : {}">
                        {{vol.photo ? '' : vol.initial}}
                    </div>
                </div>

                <div class="tcg-info">
                    <div class="tcg-name">{{vol.name}}</div>
                    <div class="tcg-id">ID: {{vol.sys_id.substring(vol.sys_id.length-4).toUpperCase()}}</div>
                    
                    <div class="tcg-stats">
                        <div class="stat-row">
                            <span>LOAD</span>
                            <div class="stat-bar-track">
                                <div class="stat-bar-fill" ng-style="{width: (vol.current_load * 20) + '%'}" ng-class="{'alert': vol.current_load >= 3}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="empty-board" ng-if="!c.data.volunteers || c.data.volunteers.length === 0">
            <i class="fa fa-users"></i>
            <h4>NO DATA</h4>
        </div>
    </div>
</div>

<div class="operator-modal-overlay" ng-if="c.showUserModal" ng-click="c.closeUserModal()">
    
    <div class="operator-dossier" ng-click="$event.stopPropagation()">
        
        <div class="dossier-header">
            <div class="dh-title">OPERATOR_DETAIL</div>
            <div class="dh-close" ng-click="c.closeUserModal()"><i class="fa fa-times"></i></div>
        </div>

        <div class="dossier-content">
            <div class="dossier-left">
                <div class="dossier-photo" 
                     ng-style="c.selectedVol.photo ? {'background-image': 'url(' + c.selectedVol.photo + ')'} : {}">
                    {{c.selectedVol.photo ? '' : c.selectedVol.initial}}
                </div>
                <div class="dossier-status-badge" ng-class="c.selectedVol.status_class">
                    {{c.selectedVol.status}}
                </div>
            </div>

            <div class="dossier-right">
                <div class="dr-name">{{c.selectedVol.name}}</div>
                <div class="dr-role">{{c.selectedVol.title}}</div>
                
                <div class="dr-section">
                    <div class="dr-label">CAPABILITY (SPECIALTY)</div>
                   
                  <div class="dr-value-box">
                        <i class="fa fa-bolt"></i> 
                        
                        <span ng-if="!c.data.isAdmin">{{c.selectedVol.capability || 'General Support'}}</span>
                        
                        <select ng-if="c.data.isAdmin" 
        class="cap-select"
        ng-model="c.selectedVol.capability" 
        ng-options="opt for opt in c.data.capOptions"
        ng-change="c.updateCapability()">
    <option value="">-- SELECT --</option>
</select>
                        </div>
                </div>

                <div class="dr-section">
                    <div class="dr-label">CURRENT LOAD</div>
                    <div class="dr-load-display">
                        <span class="big-num">{{c.selectedVol.current_load}}</span>
                        <span class="sub-text">Active Tasks</span>
                    </div>
                     <div class="dossier-bar-track">
                        <div class="dossier-bar-fill" ng-style="{width: (c.selectedVol.current_load * 20) + '%'}"></div>
                    </div>
                </div>

                <div class="dr-section">
                    <div class="dr-label">ASSIGNMENT ZONE</div>
                    <div class="dr-value-text">{{c.selectedVol.zone}}</div>
                </div>

            </div>
        </div>

        <div class="dossier-actions" style="min-height: 10px; padding: 0;">
        </div>
    </div>
</div>
    
    <div class="view-comms" ng-if="c.view === 'comms'">

    <div class="card-section" ng-if="c.data.isVolunteer">
        <div class="section-header">
            <span class="section-tag">BROADCAST</span>
            <span class="section-title">緊急放送 // EMERGENCY_BROADCAST</span>
        </div>
        
        <div class="broadcast-composer">
            <div class="broadcast-type-selector">
                <button class="broadcast-type-btn" ng-class="{'active': c.broadcastType === 'emergency'}" ng-click="c.broadcastType = 'emergency'">
                    <i class="fa fa-exclamation-triangle"></i> 緊急
                </button>
                <button class="broadcast-type-btn" ng-class="{'active': c.broadcastType === 'announcement'}" ng-click="c.broadcastType = 'announcement'">
                    <i class="fa fa-bullhorn"></i> 告知
                </button>
                <button class="broadcast-type-btn" ng-class="{'active': c.broadcastType === 'internal'}" ng-click="c.broadcastType = 'internal'">
                    <i class="fa fa-lock"></i> 内部
                </button>
            </div>
            
            <div class="broadcast-form">
                <input type="text" class="broadcast-title-input" ng-model="c.broadcastTitle" placeholder="件名を入力 (Subject)..." maxlength="200">
                <textarea class="broadcast-body-input" ng-model="c.broadcastBody" placeholder="本文を入力してください (Message body)..." rows="4" maxlength="4000"></textarea>
                <div class="broadcast-actions">
                    <div class="broadcast-meta">
                        <span class="broadcast-sender"><i class="fa fa-user"></i> {{c.data.user_name}}</span>
                        <span class="broadcast-type-label" ng-class="'type-' + c.broadcastType">
                            {{c.broadcastType === 'emergency' ? '緊急放送' : c.broadcastType === 'announcement' ? '一般告知' : '内部連絡'}}
                        </span>
                    </div>
                    <button class="broadcast-send-btn" ng-class="{'ready': c.broadcastTitle && c.broadcastBody && !c._broadcastSending}" ng-disabled="!c.broadcastTitle || !c.broadcastBody || c._broadcastSending" ng-click="c.sendBroadcast()">
                        <i class="fa" ng-class="c._broadcastSending ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
                        {{c._broadcastSending ? 'SENDING...' : 'TRANSMIT'}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="metal-divider-glow" ng-if="c.data.isVolunteer"></div>

    <div class="card-section">
        <div class="section-header">
            <span class="section-tag">FEED</span>
            <span class="section-title">通信ログ // COMM_LOG</span>
            <div style="margin-left:auto; display:flex; gap:10px;">
                <button class="btn-jira" style="margin:0; width:auto; padding:6px 12px; font-size:11px;" ng-class="{'active': !c.commsFilter}" ng-click="c.commsFilter = ''">ALL</button>
                <button class="btn-jira" style="margin:0; width:auto; padding:6px 12px; font-size:11px;" ng-class="{'active': c.commsFilter === 'emergency'}" ng-click="c.commsFilter = 'emergency'"><i class="fa fa-exclamation-triangle"></i> 緊急</button>
                <button class="btn-jira" style="margin:0; width:auto; padding:6px 12px; font-size:11px;" ng-class="{'active': c.commsFilter === 'announcement'}" ng-click="c.commsFilter = 'announcement'"><i class="fa fa-bullhorn"></i> 告知</button>
                <button class="btn-jira" style="margin:0; width:auto; padding:6px 12px; font-size:11px;" ng-class="{'active': c.commsFilter === 'internal'}" ng-click="c.commsFilter = 'internal'" ng-if="c.data.isVolunteer"><i class="fa fa-lock"></i> 内部</button>
            </div>
        </div>

        <div class="comms-timeline">
            <div class="comm-item" ng-class="'comm-' + msg.type" ng-repeat="msg in c.getFilteredComms() track by msg.sys_id" ng-click="c.openCommDetail(msg)">
                
                <div class="comm-priority-bar" ng-class="'bar-' + msg.type"></div>
                
                <div class="comm-content">
                    <div class="comm-header">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div class="comm-type-badge" ng-class="'badge-' + msg.type">
                                <i class="fa" ng-class="{'fa-exclamation-triangle': msg.type === 'emergency', 'fa-bullhorn': msg.type === 'announcement', 'fa-lock': msg.type === 'internal'}"></i>
                                {{msg.type === 'emergency' ? '緊急' : msg.type === 'announcement' ? '告知' : '内部'}}
                            </div>
                            
                            <button class="btn-delete-comm" 
                                    ng-if="c.data.isAdmin" 
                                    ng-click="c.deleteComm(msg, $event)"
                                    title="削除 (Admin Only)">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                        <span class="comm-time"><i class="fa fa-clock-o"></i> {{msg.time_ago}}</span>
                    </div>
                    
                    <div class="comm-title">{{msg.title}}</div>
                    <div class="comm-body-preview">{{msg.body | limitTo:120}}{{msg.body.length > 120 ? '...' : ''}}</div>
                    
                    <div class="comm-footer">
                        <span class="comm-author"><i class="fa fa-user-circle"></i> {{msg.author}}</span>
                        <span class="comm-read-count" ng-if="msg.read_count > 0"><i class="fa fa-eye"></i> {{msg.read_count}}</span>
                    </div>
                </div>
            </div>
            <div class="empty-board" ng-if="c.getFilteredComms().length === 0">
                <i class="fa fa-feed" style="font-size:48px; color:#ccc; margin-bottom:16px;"></i>
                <h4>NO TRANSMISSIONS</h4>
                <p>通信記録がありません</p>
            </div>
        </div>
    </div>

    <div class="comm-detail-overlay" ng-if="c.showCommDetail && c.selectedComm" ng-click="c.closeCommDetail()">
        <div class="comm-detail-panel" ng-click="$event.stopPropagation()">
            <div class="comm-detail-header">
                <div class="comm-type-badge" ng-class="'badge-' + c.selectedComm.type" style="font-size:13px; padding:4px 12px;">
                    <i class="fa" ng-class="{'fa-exclamation-triangle': c.selectedComm.type === 'emergency', 'fa-bullhorn': c.selectedComm.type === 'announcement', 'fa-lock': c.selectedComm.type === 'internal'}"></i>
                    {{c.selectedComm.type === 'emergency' ? '緊急放送' : c.selectedComm.type === 'announcement' ? '一般告知' : '内部連絡'}}
                </div>
                <button class="btn-normal" ng-click="c.closeCommDetail()" style="background:none; border:none; font-size:20px; cursor:pointer;">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <h2 style="margin:16px 0 8px; font-size:22px; font-weight:800;">{{c.selectedComm.title}}</h2>
            <div style="display:flex; gap:16px; font-size:12px; color:#999; margin-bottom:20px;">
                <span><i class="fa fa-user-circle"></i> {{c.selectedComm.author}}</span>
                <span><i class="fa fa-clock-o"></i> {{c.selectedComm.time_ago}}</span>
            </div>
            <div class="comm-detail-body">{{c.selectedComm.body}}</div>
        </div>
    </div>

    <div class="delete-confirm-overlay" ng-if="c.showDeleteConfirm" ng-click="c.cancelDelete()">
        <div class="delete-confirm-panel" ng-click="$event.stopPropagation()">
            <div class="delete-confirm-icon">
                <i class="fa fa-exclamation-triangle"></i>
            </div>
            <h3 class="delete-confirm-title">メッセージを削除しますか？</h3>
            <div class="delete-confirm-msg-info">
                <span class="comm-type-badge" ng-class="'badge-' + c.deleteTarget.type" ng-if="c.deleteTarget">
                    {{c.deleteTarget.type === 'emergency' ? '緊急' : c.deleteTarget.type === 'announcement' ? '告知' : '内部'}}
                </span>
                <strong ng-if="c.deleteTarget">{{c.deleteTarget.title}}</strong>
            </div>
            <p class="delete-confirm-warning">※この操作は取り消せません</p>
            <div class="delete-confirm-actions">
                <button class="delete-btn-cancel" ng-click="c.cancelDelete()">キャンセル</button>
                <button class="delete-btn-confirm" ng-click="c.confirmDelete()"><i class="fa fa-trash"></i> 削除する</button>
            </div>
        </div>
    </div>

</div>
    
<!-- END: view-comms -->

<div class="zen-sidebar" ng-class="{'active': c.showSidebar}">
    <div class="sidebar-head">
        <span class="sb-title">SYSTEM_NAV</span>
        <button class="sb-close" ng-click="c.toggleSidebar()">×</button>
    </div>

    <div class="sb-profile">
        <div class="sb-avatar">{{c.data.user_name.charAt(0)}}</div>
        <div class="sb-info">
            <div class="sb-name">{{c.data.user_name}}</div>
            <div class="sb-role">VOLUNTEER_ID: {{c.data.user_id.substring(0,8)}}</div>
        </div>
    </div>

    <ul class="sb-nav-list">
        <li ng-click="c.view = 'dashboard'; c.toggleSidebar()">
            <span class="nav-num">01</span> OVERVIEW
        </li>
        <li ng-click="c.view = 'tactical'; c.toggleSidebar()">
            <span class="nav-num">02</span> TACTICAL GRID
        </li>
        <li ng-click="c.view = 'mine'; c.toggleSidebar()">
            <span class="nav-num">03</span> MY OPERATIONS
        </li>
        <li ng-click="c.view = 'comms'; c.toggleSidebar()">
    <span class="nav-num">04</span> COMMS CENTER
</li>
        <li class="divider"></li>
        <li><span class="nav-num">05</span> SYSTEM SETTINGS</li>
        <li><span class="nav-num">06</span> LOGOUT</li>
    </ul>

    <div class="sb-footer">
        KOKORO OS v4.1 <br> AUTHORIZED ACCESS ONLY
    </div>
</div>

<div class="zen-backdrop" ng-class="{'active': c.showSidebar}" ng-click="c.toggleSidebar()"></div>

<script type="text/ng-template" id="volunteerModalTemplate">
<div class="modal-content kokoro-modal-window">
  
  <div class="modal-header-clean">
    <div class="header-left">
      <span class="header-badge"><i class="fa fa-truck"></i> RESCUE_REQUEST</span>
      <span class="header-id">{{item.number}}</span>
    </div>
    <button class="header-close" ng-click="cancel()"><i class="fa fa-times"></i></button>
  </div>

  <div class="modal-body-grid">
    
    <div class="body-main">
      <h2 class="ticket-title">
          {{c.dict[item.category] || item.category}} - 救援要請
          <span class="qty-badge-black">x{{item.quantity}}</span>
      </h2>
      
      <div class="action-bar">
        <div class="dropdown-wrapper">
          <button class="btn-purple-outline" ng-click="toggleStatusMenu($event)">
             {{c.statusNames[item.state] || 'OPEN'}} <i class="fa fa-chevron-down"></i>
          </button>
          <div class="status-menu" ng-show="statusMenuOpen">
            <div class="status-item" ng-click="changeStatus(item, '11')" ng-if="item.state != 11 && item.state != 4"><i class="fa fa-user-plus"></i> ASSIGNED</div>
            <div class="status-item" ng-click="changeStatus(item, '2')" ng-if="item.state == 11"><i class="fa fa-bicycle"></i> IN_PROGRESS</div>
            <div class="status-item" ng-click="changeStatus(item, '4')" ng-if="item.state == 2"><i class="fa fa-check"></i> COMPLETED</div>
            <div class="status-item danger" ng-click="changeStatus(item, '5')"><i class="fa fa-ban"></i> CANCELLED</div>
          </div>
        </div>
        
        <div class="dropdown-wrapper" uib-dropdown dropdown-append-to-body="true">
    <button type="button" class="btn-normal" uib-dropdown-toggle ng-if="item.state != 4">
         <i class="fa fa-paper-plane-o"></i> DISPATCH <span class="caret"></span>
    </button>
    
    <ul class="dropdown-menu dropdown-menu-right" uib-dropdown-menu role="menu" 
        style="background: #1e1e1e; border: 1px solid #444; min-width: 200px; z-index: 10000;">
        
        <li role="menuitem">
            <a href="javascript:void(0)" ng-click="c.assignTask(item.sys_id, c.data.user_id)" 
               style="color: #fff; padding: 8px 15px; border-bottom: 1px solid #333;">
               <i class="fa fa-user"></i> Assign to Myself
            </a>
        </li>
        
        <li class="divider" style="margin: 0; background: #333;"></li>
        <li role="menuitem" style="padding: 5px 15px; color: #666; font-size: 10px; text-transform:uppercase;">
            Volunteers
        </li>

        <li role="menuitem" ng-repeat="vol in c.data.volunteers">
            <a href="javascript:void(0)" ng-click="c.assignTask(item.sys_id, vol.sys_id)" 
               style="color: #bbb; padding: 8px 15px; display: flex; justify-content: space-between;">
               <span>{{vol.name}}</span>
               <span style="font-size: 10px; background: #333; padding: 1px 4px; border-radius: 3px;">
                   {{vol.load}}%
               </span>
            </a>
        </li>
    </ul>
</div>
        
        <button class="action-btn" ng-click="triggerAutoAssign(item)" ng-if="!item.assigned_to_id">
            <i class="fa fa-magic"></i> AUTO_ASSIGN
        </button>
        <button class="action-btn" ng-click="triggerAutoAssign(item)" ng-if="item.assigned_to_id">
            <i class="fa fa-refresh"></i> REASSIGN
        </button>
      </div>

      <div class="desc-box">
        <div class="desc-section-title"><i class="fa fa-align-left"></i> DESCRIPTION</div>
        <div class="desc-grid">
          <div class="desc-item">
              <div class="desc-icon"><i class="fa fa-map-marker"></i></div>
              <div><span class="desc-label">LOCATION:</span> {{item.zone}} - {{item.detail_loc}}</div>
          </div>
          <div class="desc-item">
              <div class="desc-icon"><i class="fa fa-cube"></i></div>
              <div><span class="desc-label">TYPE:</span> {{c.dict[item.category] || item.category}} x {{item.quantity}}</div>
          </div>
          <div class="desc-item">
              <div class="desc-icon"><i class="fa fa-users"></i></div>
              <div><span class="desc-label">AFFECTED:</span> {{item.affected_count || '不明'}}</div>
          </div>
          <div class="desc-item" ng-if="item.remarks">
              <div class="desc-icon"><i class="fa fa-info-circle"></i></div>
              <div><span class="desc-label">NOTES:</span> {{item.remarks}}</div>
          </div>
        </div>
      </div>

      <div class="metal-divider"></div>

      <div class="activity-area">
        <div class="desc-section-title"><i class="fa fa-comments-o"></i> ACTIVITY_LOG</div>
        
        <div class="input-wrapper">
            <textarea class="note-input" 
                      ng-model="newComment" 
                      placeholder="Type an internal note..."
                      ng-keydown="$event.ctrlKey && $event.keyCode === 13 && postComment(item)"></textarea>
            <div class="input-footer">
                <button class="submit-btn" 
                        ng-class="{'ready': newComment}" 
                        ng-click="postComment(item)">
                    <i class="fa fa-paper-plane"></i> SUBMIT_LOG
                </button>
            </div>
        </div>

        <div class="history-list">
            <div ng-repeat="h in item.history track by $index">
                <div class="log-item type-user" ng-if="!h.text.startsWith('[SLA')">
                    <div class="log-header">
                        <div class="log-user"><i class="fa fa-user-circle-o" style="color:var(--accent-primary);"></i> {{h.user}}</div>
                        <span class="log-time">{{h.date}}</span>
                    </div>
                    <div class="log-body">{{h.text}}</div>
                </div>
                <div class="log-item type-system" ng-if="h.text.startsWith('[SLA')">
                    <div class="sys-terminal-box" 
                         ng-class="{'sla-breach': h.text.indexOf('違反') !== -1 || h.text.indexOf('breached') !== -1, 'sla-warning': h.text.indexOf('警告') !== -1 || h.text.indexOf('risk') !== -1}">
                        <div class="sys-meta-row"><span><i class="fa fa-terminal"></i> SYSTEM_KERNEL</span><span>{{h.date}}</span></div>
                        <div class="sys-content">
                            <span ng-if="h.text.indexOf('違反') !== -1 || h.text.indexOf('breached') !== -1"><strong>[CRITICAL_FAILURE]</strong> </span>
                            <span ng-if="h.text.indexOf('警告') !== -1 || h.text.indexOf('risk') !== -1"><strong>[WARNING_ALERT]</strong> </span>
                            {{h.text}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>

    </div>

    <div class="body-sidebar">
      
      <div class="sidebar-block">
          <div class="sb-label">STATUS</div>
          <div class="state-indicator" style="background:#000; color:#fff;">{{c.getStateInfo(item.state).name}}</div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">ASSIGNEE</div>
          <div class="user-row" ng-if="item.assigned_to_name">
              <div class="avatar-box">{{item.assigned_to_name.charAt(0)}}</div>
              <div class="user-name-text">{{item.assigned_to_name}}</div>
          </div>
          <div class="user-row" ng-if="!item.assigned_to_name">
              <div class="avatar-box grey">?</div>
              <div class="user-name-text" style="color:#999;">UNASSIGNED</div>
          </div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">REPORTER</div>
          <div class="user-row">
              <div class="avatar-box orange">{{item.reporter_name.charAt(0) || '?'}}</div>
              <div class="user-name-text">{{item.reporter_name || 'System'}}</div>
          </div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">PRIORITY</div>
          <div class="priority-btn"><i class="fa fa-arrow-right"></i> {{c.dict[item.urgency] || item.urgency}}</div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">LOCATION</div>
          <div style="font-weight:800; color:var(--text-primary); font-size:16px;">
              <i class="fa fa-map-marker" style="color:var(--color-critical); margin-right:10px;"></i>{{item.zone}}
          </div>
          <div style="font-size:14px; color:var(--text-tertiary); margin-top:8px;">{{item.detail_loc}}</div>
      </div>

     <div class="ticket-card-body">
    <div class="ai-card">
         <div class="ai-head"><i class="fa fa-bolt ai-pulse"></i> TACTICAL_INSIGHT</div>
         <div class="ai-text" ng-bind-html="item.trusted_ai"></div>
    </div>
</div>

      <div class="sidebar-block" ng-if="item.sla && item.state != 4 && item.state != 5">
        <div class="sb-label">SLA_TRACKING</div>
        <div class="sla-progress">
            <div class="sla-fill" ng-style="{width: item.sla.percentage + '%', background: c.getSLABarColor(item.sla)}"></div>
        </div>
        <div class="sla-text">
            <span>ELAPSED: {{c.formatHours(item.sla.elapsed)}}</span>
            <span>REMAIN: {{c.formatSLARemaining(item.sla.remaining)}}</span>
        </div>
        <div class="sla-badge" ng-class="{'sla-critical': item.sla.is_breached, 'sla-ok': !item.sla.is_breached}">
            <i class="fa" ng-class="{'fa-check': !item.sla.is_breached, 'fa-exclamation': item.sla.is_breached}"></i> 
            {{item.sla.is_breached ? 'BREACHED' : 'WITHIN SLA'}}
        </div>
      </div>

      <div class="sidebar-block" ng-if="item.state == 4">
        <div class="sb-label">FINAL_STATUS</div>
        <div style="background: rgba(52, 199, 89, 0.1); border: 2px solid #34c759; color: #34c759; padding: 12px; text-align: center; border-radius: 4px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i class="fa fa-trophy"></i> MISSION COMPLETE
        </div>
        <div style="text-align: center; font-size: 10px; color: #999; margin-top: 6px; font-family: monospace;">
            SLA TIMER STOPPED
        </div>
      </div>

      <div class="sidebar-block" ng-if="item.state == 5">
        <div class="sb-label">FINAL_STATUS</div>
        <div style="background: #f5f5f5; border: 2px solid #ccc; color: #666; padding: 12px; text-align: center; border-radius: 4px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i class="fa fa-ban"></i> OPERATION CANCELLED
        </div>
      </div>
      </div>
  </div>
</div>
</script>

<style>
/* --- 1. 模态框 "离家出走" 修复 (解决变量失效/白底/头像丢失) --- */
.modal-content {
    /* 强制重新定义变量，防止读取不到 */
    --accent-primary: #6200ea;
    --text-primary: #1a1a1a;
    --text-secondary: #555555;
    --border-light: #eeeeee;
    --border-mid: #dddddd;
    --color-critical: #ff3b30;
    --color-warning: #ff9500;
    
    background: #fff !important;
    border: none !important;
    border-radius: 4px !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
    font-family: "Rajdhani", "JetBrains Mono", sans-serif !important;
    overflow: visible !important;
}

/* 修复头部 */
.modal-header-clean {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 20px 30px !important;
    background: #f8f9fa !important;
    border-bottom: 1px solid #e9ecef !important;
}
.header-badge {
    background: #000 !important;
    color: #fff !important;
    padding: 4px 12px;
    font-weight: 800;
    border-radius: 2px;
}
.header-close {
    background: #fff !important;
    border: 1px solid #ddd !important;
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
}
.header-close:hover {
    background: #ff3b30 !important;
    color: #fff !important;
    border-color: #ff3b30 !important;
}

/* 修复头像 (Avatar) - 强制上色 */
.avatar-box {
    width: 36px; height: 36px;
    background-color: #6200ea !important; /* 兜底紫色 */
    color: #fff !important;
    display: flex !important;
    align-items: center; justify-content: center;
    border-radius: 4px;
    font-weight: 700;
    font-size: 16px;
}
.avatar-box.orange { background-color: #ff9500 !important; }
.avatar-box.grey { background-color: #e0e0e0 !important; color: #999 !important; }

/* 修复侧边栏 */
.body-sidebar {
    background: #fcfcfc !important;
    border-left: 1px solid #eee !important;
    padding: 25px !important;
}
.sidebar-block {
    border-bottom: 1px dashed #e0e0e0;
    padding-bottom: 15px;
    margin-bottom: 20px;
}
.sb-label {
    color: #999;
    font-weight: 700;
    font-size: 11px;
    margin-bottom: 8px;
    display: block;
}

/* --- 2. 评论区美化 (Timeline Data Stream) --- */
.activity-area {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #f0f0f0;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* 输入框容器：垂直布局，杜绝重叠 */
.input-wrapper {
    display: flex;
    flex-direction: column !important; /* 关键 */
    border: 1px solid #e0e0e0;
    background: #fff;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}
.input-wrapper:focus-within {
    border-color: #000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.note-input {
    width: 100%;
    min-height: 80px;
    padding: 15px;
    border: none !important;
    outline: none !important;
    font-family: "JetBrains Mono", sans-serif;
    font-size: 14px;
    color: #333;
    resize: vertical;
    background: transparent;
}

.input-footer {
    display: flex;
    justify-content: flex-end;
    padding: 10px 15px;
    background: #f9f9f9;
    border-top: 1px solid #eee;
}

.submit-btn {
    background: #e0e0e0;
    color: #999;
    padding: 8px 20px;
    font-family: "Rajdhani", sans-serif;
    font-weight: 700;
    font-size: 13px;
    border: none;
    cursor: not-allowed;
    border-radius: 2px;
    transition: all 0.2s;
}
.submit-btn.ready {
    background: #1a1a1a;
    color: #fff;
    cursor: pointer;
}
.submit-btn.ready:hover {
    background: #000;
    transform: translateY(-1px);
}

/* 历史列表 */
.history-list {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 8px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* 用户留言气泡 */
.log-item.type-user {
    background: #fff;
    padding: 0 0 15px 0;
    border-bottom: 1px solid #f5f5f5;
}
.log-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 12px;
}
.log-user { font-weight: 800; color: #1a1a1a; }
.log-time { color: #999; font-family: monospace; }
.log-body { font-size: 14px; color: #444; line-height: 1.5; white-space: pre-wrap; }

/* 系统日志 (冷淡风) */
.log-item.type-system {
    font-family: "JetBrains Mono", monospace;
    font-size: 12px;
}
.sys-terminal-box {
    background: #f8f9fa; /* 浅灰底 */
    border-left: 3px solid #ccc;
    padding: 10px 14px;
    color: #555;
    border-radius: 0 4px 4px 0;
}
/* 警告级别线条颜色 */
.sys-terminal-box.sla-breach { border-left-color: #d93025; background: rgba(217, 48, 37, 0.03); }
.sys-terminal-box.sla-warning { border-left-color: #f9ab00; background: rgba(249, 171, 0, 0.03); }

.sys-meta-row {
    display: flex; justify-content: space-between;
    border-bottom: 1px dashed #e0e0e0;
    padding-bottom: 5px; margin-bottom: 5px;
    font-size: 10px; color: #999; text-transform: uppercase;
}
.tag-sla {
    display: inline-block; padding: 1px 6px; border-radius: 2px;
    font-weight: 700; font-size: 10px; margin-right: 6px;
}
.tag-sla.violation { background: #d93025; color: #fff; }
.tag-sla.warning { background: #f9ab00; color: #fff; }
</style>

<script type="text/ng-template" id="volunteerModalTemplate">
<div class="modal-content kokoro-modal-window">
  
  <div class="modal-header-clean">
    <div class="header-left">
      <span class="header-badge"><i class="fa fa-truck"></i> RESCUE_REQUEST</span>
      <span class="header-id">{{item.number}}</span>
    </div>
    <button class="header-close" ng-click="cancel()"><i class="fa fa-times"></i></button>
  </div>

  <div class="modal-body-grid">
    
    <div class="body-main">
      <h2 class="ticket-title">
          {{c.dict[item.category] || item.category}}
          <span class="qty-badge-black">x{{item.quantity}}</span>
      </h2>
      
      <div class="action-bar">
        <div class="dropdown-wrapper">
          <button class="btn-purple-outline" ng-click="toggleStatusMenu($event)">
             {{c.statusNames[item.state] || 'OPEN'}} <i class="fa fa-chevron-down"></i>
          </button>
          <div class="status-menu" ng-show="statusMenuOpen">
            <div class="status-item" ng-click="changeStatus(item, '11')" ng-if="item.state != 11 && item.state != 4">ASSIGNED</div>
            <div class="status-item" ng-click="changeStatus(item, '2')" ng-if="item.state == 11">IN PROGRESS</div>
            <div class="status-item" ng-click="changeStatus(item, '4')" ng-if="item.state == 2">COMPLETED</div>
            <div class="status-item danger" ng-click="changeStatus(item, '5')">CANCELLED</div>
          </div>
        </div>
        
        <button class="btn-normal" ng-click="assignToMe(item)" ng-if="item.state != 4">
    <i class="fa fa-user"></i> ASSIGN TO ME
</button>

<div class="dropdown-wrapper" ng-if="item.state != 4">
    <button class="btn-normal" ng-click="showDispatchMenu = !showDispatchMenu">
    <i class="fa fa-paper-plane-o"></i> DISPATCH <i class="fa fa-chevron-down"></i>
</button>
    <div class="status-menu" ng-show="showDispatchMenu" style="max-height:300px; overflow-y:auto;">
        <div class="status-item" style="padding:5px 15px; color:#999; font-size:10px; cursor:default; border-bottom:1px solid #eee;">
            VOLUNTEERS
        </div>
        <div class="status-item" ng-repeat="vol in c.data.volunteers" 
     ng-click="$event.stopPropagation(); c.assignTask(item.sys_id, vol.sys_id); showDispatchMenu=false; item.assigned_to_name=vol.name; item.assigned_to_id=vol.sys_id">
    <span>{{vol.name}}</span>
    <span style="float:right; font-size:10px; color:#999;">{{vol.load}}%</span>
</div>
    </div>
</div>
        
        <button class="action-btn" ng-click="triggerAutoAssign(item)" ng-if="!item.assigned_to_id">
            <i class="fa fa-magic"></i> AUTO_ASSIGN
        </button>
      </div>

      <div class="desc-box">
        <div class="desc-section-title">DESCRIPTION</div>
        <div class="desc-grid">
          <div class="desc-item">
              <div class="desc-icon"><i class="fa fa-map-marker"></i></div>
              <div><span class="desc-label">LOCATION:</span> {{item.zone}} - {{item.detail_loc}}</div>
          </div>
          <div class="desc-item">
              <div class="desc-icon"><i class="fa fa-cube"></i></div>
              <div><span class="desc-label">TYPE:</span> {{c.dict[item.category] || item.category}}</div>
          </div>
          <div class="desc-item" ng-if="item.remarks">
              <div class="desc-icon"><i class="fa fa-sticky-note-o"></i></div>
              <div><span class="desc-label">NOTES:</span> {{item.remarks}}</div>
          </div>
        </div>
      </div>

      <div class="activity-area">
        <div class="desc-section-title">
            <i class="fa fa-history"></i> ACTIVITY_LOG / 履歴
        </div>
        
        <div class="input-wrapper">
            <textarea class="note-input" 
                      ng-model="newComment" 
                      placeholder="内部メモを入力してください... (Ctrl+Enter で送信)"
                      ng-keydown="$event.ctrlKey && $event.keyCode === 13 && postComment(item)"></textarea>
            <div class="input-footer">
                <button class="submit-btn" 
                        ng-class="{'ready': newComment && newComment.length > 0}" 
                        ng-disabled="!newComment || newComment.length === 0" 
                        ng-click="postComment(item)">
                    <i class="fa fa-paper-plane"></i> LOG_UPDATE
                </button>
            </div>
        </div>

        <div class="history-list">
            <div ng-repeat="h in item.history track by $index">
                
                <div class="log-item type-user" ng-if="!h.text.startsWith('[SLA')">
                    <div class="log-header">
                        <div class="log-user">
                            <i class="fa fa-user-circle" style="color:#333; margin-right:6px;"></i> 
                            {{h.user}}
                        </div>
                        <span class="log-time">{{h.date}}</span>
                    </div>
                    <div class="log-body">{{h.text}}</div>
                </div>

                <div class="log-item type-system" ng-if="h.text.startsWith('[SLA')">
                    <div class="sys-terminal-box" 
                         ng-class="{
                            'sla-breach': h.text.indexOf('違反') !== -1 || h.text.indexOf('breached') !== -1, 
                            'sla-warning': h.text.indexOf('警告') !== -1 || h.text.indexOf('risk') !== -1
                         }">
                        <div class="sys-meta-row">
                            <span><i class="fa fa-terminal"></i> システム監査 (SYSTEM_AUDIT)</span>
                            <span>{{h.date}}</span>
                        </div>
                        <div class="sys-content">
                            <span class="tag-sla violation" ng-if="h.text.indexOf('違反') !== -1 || h.text.indexOf('breached') !== -1">SLA違反</span>
                            <span class="tag-sla warning" ng-if="h.text.indexOf('警告') !== -1 || h.text.indexOf('risk') !== -1">SLA警告</span>
                            
                            {{h.text.replace('[SLA違反]', '').replace('[SLA警告]', '').replace('[SLA违反]', '').replace('[WARNING_ALERT]', '').replace('[CRITICAL_FAILURE]', '')}}
                        </div>
                    </div>
                </div>

            </div>
        </div>
      </div>
      </div>

    <div class="body-sidebar">
      
      <div class="sidebar-block">
          <div class="sb-label">STATUS</div>
          <div class="state-indicator" style="background:#000; color:#fff;">{{c.getStateInfo(item.state).name}}</div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">ASSIGNEE</div>
          <div class="user-row" ng-if="item.assigned_to_name">
              <div class="avatar-box">{{item.assigned_to_name.charAt(0)}}</div>
              <div class="user-name-text">{{item.assigned_to_name}}</div>
          </div>
          <div class="user-row" ng-if="!item.assigned_to_name">
              <div class="avatar-box grey">?</div>
              <div class="user-name-text" style="color:#999;">UNASSIGNED</div>
          </div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">REPORTER</div>
          <div class="user-row">
              <div class="avatar-box orange">{{item.reporter_name.charAt(0) || '?'}}</div>
              <div class="user-name-text">{{item.reporter_name || 'System'}}</div>
          </div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">PRIORITY</div>
          <div class="priority-btn">{{c.dict[item.urgency] || item.urgency}}</div>
      </div>

      <div class="sidebar-block">
          <div class="sb-label">LOCATION</div>
          <div style="font-weight:800; color:#1a1a1a; font-size:16px;">
              <i class="fa fa-map-marker" style="color:#ff3b30; margin-right:10px;"></i>{{item.zone}}
          </div>
          <div style="font-size:14px; color:#999; margin-top:8px;">{{item.detail_loc}}</div>
      </div>

      <div class="ticket-card-body">
    <div class="ai-card">
         <div class="ai-head"><i class="fa fa-bolt ai-pulse"></i> TACTICAL_INSIGHT</div>
         <div class="ai-text" ng-bind-html="item.trusted_ai"></div>
    </div>
</div>

      <div class="sidebar-block" ng-if="item.sla">
        <div class="sb-label">SLA TRACKING</div>
        <div class="sla-progress">
            <div class="sla-fill" ng-style="{width: item.sla.percentage + '%', background: c.getSLABarColor(item.sla)}"></div>
        </div>
        <div class="sla-badge" ng-class="{'sla-critical': item.sla.is_breached, 'sla-ok': !item.sla.is_breached}">
            {{item.sla.is_breached ? 'BREACHED' : 'WITHIN SLA'}}
        </div>
      </div>

    </div>
  </div>
</div>
</script>
]]></template>
    </sp_widget>
</record_update>
