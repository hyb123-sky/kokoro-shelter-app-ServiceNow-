<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $timeout, $interval, spUtil) {
  var c = this;
  
  // ========================================
  // åˆå§‹åŒ–é…ç½®
  // ========================================
  c.loading = true;
  c.isDarkMode = true;
  c.is3D = false;
  c.autoRefresh = true;
  c.urgencyFilter = '';
  c.selectedRequest = null;
  c.map = null;
  c.markers = {};
  
  // ç¿»è¯‘å­—å…¸
  c.dict = {
    'Water': ']]>ğŸ’§<![CDATA[ é£²æ–™æ°´',
    'Food': ']]>ğŸ<![CDATA[ é£Ÿæ–™',
    'Medical': ']]>ğŸ’Š<![CDATA[ åŒ»ç™‚ãƒ»è–¬',
    'Baby': ']]>ğŸ‘¶<![CDATA[ ä¹³å¹¼å…ç”¨å“',
    'Power': ']]>ğŸ”‹<![CDATA[ é›»æºãƒ»å……é›»',
    'Other': ']]>ğŸ“¦<![CDATA[ ãã®ä»–',
    'Critical': ']]>ğŸ”´<![CDATA[ é™ç•Œ',
    'High': ']]>ğŸŸ <![CDATA[ å›°ã£ã¦ã„ã‚‹',
    'Medium': ']]>ğŸŸ¡<![CDATA[ æ™®é€š',
    'Low': ']]>ğŸŸ¢<![CDATA[ æ€¥ãã¾ã›ã‚“',
    'Family Area': 'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚¨ãƒªã‚¢',
    'Single Area': 'å˜èº«ã‚¨ãƒªã‚¢',
    'Medical Area': 'åŒ»ç™‚ãƒ»ã‚±ã‚¢ã‚¨ãƒªã‚¢'
  };
  
  // ç»Ÿè®¡æ•°æ®
  c.stats = {
    critical: 0,
    pending: 0,
    inProgress: 0
  };
  
  // ========================================
  // åœ°å›¾åˆå§‹åŒ–
  // ========================================
  function initMap() {
    console.log(']]>ğŸš€<![CDATA[ Initializing map...');
    
    // æ£€æŸ¥ Mapbox æ˜¯å¦å·²åŠ è½½
    if (typeof mapboxgl === 'undefined') {
      console.log('â³ Mapbox GL JS not loaded, loading now...');
      loadMapboxLibrary();
      return;
    }
    
    console.log('âœ… Mapbox GL JS already loaded');
    
    // ä»æœåŠ¡å™¨è·å– Token
    c.server.get().then(function(response) {
      console.log(']]>ğŸ“¡<![CDATA[ Server response:', response.data);
      
      if (response.data.error) {
        console.error('âŒ Server error:', response.data.error);
        c.loading = false;
        spUtil.addErrorMessage(response.data.error);
        return;
      }
      
      if (response.data.mapbox_token) {
        console.log('âœ… Token received (length: ' + response.data.mapbox_token.length + ')');
        createMap(response.data.mapbox_token);
      } else {
        console.error('âŒ No Mapbox token in response');
        c.loading = false;
        spUtil.addErrorMessage('Mapbox Token ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚System Property ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
    }).catch(function(error) {
      console.error('âŒ Server request failed:', error);
      c.loading = false;
      spUtil.addErrorMessage('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
  }
  
  function loadMapboxLibrary() {
    // åŠ¨æ€åŠ è½½ Mapbox GL JS
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css';
    document.head.appendChild(link);
    
    var script = document.createElement('script');
    script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js';
    script.onload = function() {
      console.log('âœ… Mapbox GL JS loaded dynamically');
      $timeout(initMap, 500);
    };
    script.onerror = function() {
      console.error('âŒ Failed to load Mapbox GL JS');
      c.loading = false;
      spUtil.addErrorMessage('Mapbox ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      $scope.$apply();
    };
    document.head.appendChild(script);
  }
  
  function createMap(token) {
    console.log(']]>ğŸ—º<![CDATA[ï¸ Creating map with token...');
    
    try {
      mapboxgl.accessToken = token;
      
      c.map = new mapboxgl.Map({
        container: 'kokoro-map',
        style: c.isDarkMode ? 
          'mapbox://styles/mapbox/dark-v10' : 
          'mapbox://styles/mapbox/streets-v11',
        center: [139.6917, 35.6895], // ä¸œäº¬ä¸­å¿ƒ
        zoom: 11,
        pitch: c.is3D ? 60 : 0,
        bearing: c.is3D ? -17.6 : 0
      });
      
      console.log('âœ… Map instance created');
      
      // æ·»åŠ å¯¼èˆªæ§åˆ¶
      c.map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      
      // æ·»åŠ å…¨å±æ§åˆ¶
      c.map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
      
      // æ·»åŠ å®šä½æ§åˆ¶
      c.map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: {
          enableHighAccuracy: true
        },
        trackUserLocation: true,
        showUserHeading: true
      }), 'top-right');
      
      // åœ°å›¾åŠ è½½å®Œæˆ
      c.map.on('load', function() {
        console.log('âœ… Map loaded successfully');
        c.loading = false;
        $scope.$apply();
        
        // åŠ è½½è¯·æ±‚æ•°æ®
        loadRequests();
        
        // æ·»åŠ å‘å…‰æ•ˆæœå±‚
        addGlowLayer();
      });
      
      // åœ°å›¾é”™è¯¯å¤„ç†
      c.map.on('error', function(e) {
        console.error('âŒ Map error:', e);
        c.loading = false;
        spUtil.addErrorMessage('åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.error ? e.error.message : ''));
        $scope.$apply();
      });
      
    } catch (error) {
      console.error('âŒ Exception creating map:', error);
      c.loading = false;
      spUtil.addErrorMessage('åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      $scope.$apply();
    }
  }
  
  // ========================================
  // åŠ è½½è¯·æ±‚æ•°æ®
  // ========================================
  function loadRequests() {
    console.log(']]>ğŸ“¡<![CDATA[ Loading requests...');
    
    c.server.get({
      action: 'get_map_requests',
      urgency_filter: c.urgencyFilter
    }).then(function(response) {
      console.log(']]>ğŸ“¦<![CDATA[ Received data:', response.data);
      
      if (response.data && response.data.requests) {
        console.log('âœ… Found ' + response.data.requests.length + ' requests');
        updateMarkers(response.data.requests);
        updateStats(response.data.stats);
      } else {
        console.warn('âš ï¸ No requests data in response');
      }
    }).catch(function(error) {
      console.error('âŒ Failed to load requests:', error);
    });
  }
  
  // ========================================
  // æ›´æ–°åœ°å›¾æ ‡è®°
  // ========================================
  function updateMarkers(requests) {
    console.log(']]>ğŸ¯<![CDATA[ Updating markers for ' + requests.length + ' requests');
    
    // æ¸…é™¤ä¸å­˜åœ¨çš„æ—§æ ‡è®°
    Object.keys(c.markers).forEach(function(id) {
      if (!requests.find(function(r) { return r.sys_id === id; })) {
        console.log(']]>ğŸ—‘<![CDATA[ï¸ Removing old marker:', id);
        c.markers[id].remove();
        delete c.markers[id];
      }
    });
    
    // æ·»åŠ /æ›´æ–°æ ‡è®°
    var addedCount = 0;
    requests.forEach(function(req) {
      if (req.latitude && req.longitude) {
        if (c.markers[req.sys_id]) {
          // æ›´æ–°ç°æœ‰æ ‡è®°
          c.markers[req.sys_id].request = req;
        } else {
          // åˆ›å»ºæ–°æ ‡è®°
          createMarker(req);
          addedCount++;
        }
      } else {
        console.warn('âš ï¸ Request ' + req.number + ' has no coordinates');
      }
    });
    
    console.log('âœ… Added ' + addedCount + ' new markers');
    console.log(']]>ğŸ“<![CDATA[ Total markers on map: ' + Object.keys(c.markers).length);
  }
  
  function createMarker(req) {
    // ]]>ğŸ”§<![CDATA[ å¢å¼ºé”™è¯¯å¤„ç†
    if (!c.map) {
      console.error('âŒ Cannot create marker: map is null');
      return;
    }
    
    console.log(']]>ğŸ“<![CDATA[ Creating marker for ' + req.number + ' at [' + req.latitude + ', ' + req.longitude + ']');
    
    try {
      // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°å…ƒç´ 
      var el = document.createElement('div');
      el.className = 'custom-marker';
      
      // æ·»åŠ è„‰å†²åŠ¨ç”»ï¼ˆCriticalçº§åˆ«ï¼‰
      if (req.urgency === 'Critical') {
        el.classList.add('marker-pulse');
      }
      
      el.innerHTML = getMarkerHTML(req);
      
      // åˆ›å»ºæ ‡è®°
      var marker = new mapboxgl.Marker({
        element: el,
        anchor: 'bottom'
      })
        .setLngLat([req.longitude, req.latitude])
        .addTo(c.map);
      
      // ç‚¹å‡»äº‹ä»¶
      el.addEventListener('click', function() {
        console.log(']]>ğŸ‘†<![CDATA[ Marker clicked:', req.number);
        selectRequest(req);
      });
      
      // ä¿å­˜å¼•ç”¨
      c.markers[req.sys_id] = marker;
      c.markers[req.sys_id].request = req;
      
      console.log('âœ… Marker created successfully for ' + req.number);
      
    } catch (error) {
      console.error('âŒ Error creating marker for ' + req.number + ':', error);
    }
  }
  
  function getMarkerHTML(req) {
    var icons = {
      'Water': ']]>ğŸ’§<![CDATA[',
      'Food': ']]>ğŸ<![CDATA[',
      'Medical': ']]>ğŸ’Š<![CDATA[',
      'Baby': ']]>ğŸ‘¶<![CDATA[',
      'Power': ']]>ğŸ”‹<![CDATA[',
      'Other': ']]>ğŸ“¦<![CDATA['
    };
    
    var urgencyColors = {
      'Critical': '#ff1744',
      'High': '#ff9800',
      'Medium': '#ffc107',
      'Low': '#4caf50'
    };
    
    return '<div class="marker-icon" style="background: ' + 
           urgencyColors[req.urgency] + '">' +
           icons[req.category] +
           '</div>';
  }
  
  // ========================================
  // é€‰æ‹©è¯·æ±‚
  // ========================================
  function selectRequest(req) {
    c.selectedRequest = req;
    console.log(']]>ğŸ¯<![CDATA[ Selected request:', req.number);
    
    // ]]>ğŸ”§<![CDATA[ å¢å¼ºé”™è¯¯å¤„ç†
    if (!c.map) {
      console.error('âŒ Cannot fly to location: map is null');
      return;
    }
    
    // é£è¡Œåˆ°é€‰ä¸­ä½ç½®
    c.map.flyTo({
      center: [req.longitude, req.latitude],
      zoom: 15,
      pitch: 60,
      bearing: -17.6,
      duration: 2000,
      essential: true
    });
    
    $scope.$apply();
  }
  
  c.closeDetails = function() {
    console.log(']]>ğŸšª<![CDATA[ Closing details panel');
    c.selectedRequest = null;
    
    // ]]>ğŸ”§<![CDATA[ å¢å¼ºé”™è¯¯å¤„ç†
    if (!c.map) {
      console.error('âŒ Cannot reset view: map is null');
      return;
    }
    
    // æ¢å¤è§†è§’
    c.map.flyTo({
      center: [139.6917, 35.6895],
      zoom: 11,
      pitch: c.is3D ? 60 : 0,
      bearing: c.is3D ? -17.6 : 0,
      duration: 1500
    });
  };
  
  // ========================================
  // æ§åˆ¶æŒ‰é’®åŠŸèƒ½
  // ========================================
  c.toggleMapStyle = function() {
    if (!c.map) {
      console.error('âŒ Cannot toggle style: map is null');
      return;
    }
    
    c.isDarkMode = !c.isDarkMode;
    console.log(']]>ğŸ¨<![CDATA[ Switching to ' + (c.isDarkMode ? 'dark' : 'light') + ' mode');
    
    c.map.setStyle(c.isDarkMode ? 
      'mapbox://styles/mapbox/dark-v10' :
      'mapbox://styles/mapbox/streets-v11'
    );
    
    // æ ·å¼åˆ‡æ¢åé‡æ–°æ·»åŠ æ ‡è®°
    c.map.once('styledata', function() {
      console.log('âœ… Style changed, re-adding glow layer');
      addGlowLayer();
    });
  };
  
  c.toggle3D = function() {
    if (!c.map) {
      console.error('âŒ Cannot toggle 3D: map is null');
      return;
    }
    
    c.is3D = !c.is3D;
    console.log(']]>ğŸ¬<![CDATA[ Switching to ' + (c.is3D ? '3D' : '2D') + ' view');
    
    c.map.easeTo({
      pitch: c.is3D ? 60 : 0,
      bearing: c.is3D ? -17.6 : 0,
      duration: 1000
    });
  };
  
  c.toggleAutoRefresh = function() {
    c.autoRefresh = !c.autoRefresh;
    console.log(']]>ğŸ”„<![CDATA[ Auto-refresh ' + (c.autoRefresh ? 'enabled' : 'disabled'));
    
    if (c.autoRefresh) {
      startAutoRefresh();
    } else {
      stopAutoRefresh();
    }
  };
  
  function startAutoRefresh() {
    c.refreshInterval = $interval(function() {
      console.log(']]>ğŸ”„<![CDATA[ Auto-refreshing data...');
      loadRequests();
    }, 10000);
  }
  
  function stopAutoRefresh() {
    if (c.refreshInterval) {
      $interval.cancel(c.refreshInterval);
      c.refreshInterval = null;
    }
  }
  
  c.applyFilter = function() {
    console.log(']]>ğŸ”<![CDATA[ Applying filter:', c.urgencyFilter);
    loadRequests();
  };
  
  // ========================================
  // æ“ä½œæŒ‰é’®
  // ========================================
  c.assignToMe = function(req) {
    if (!confirm('ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹…å½“ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    
    console.log('âœ‹ Assigning request:', req.number);
    
    c.server.get({
      action: 'assign_to_me',
      sys_id: req.sys_id
    }).then(function(response) {
      if (response.data.success) {
        console.log('âœ… Assignment successful');
        spUtil.addInfoMessage('ä»»å‹™ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼');
        c.closeDetails();
        loadRequests();
      } else {
        console.error('âŒ Assignment failed:', response.data.error);
        spUtil.addErrorMessage(response.data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }).catch(function(error) {
      console.error('âŒ Assignment request failed:', error);
      spUtil.addErrorMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    });
  };
  
  c.openDirections = function(req) {
    console.log(']]>ğŸ§­<![CDATA[ Opening directions to:', req.number);
    var url = 'https://www.google.com/maps/dir/?api=1&destination=' +
              req.latitude + ',' + req.longitude;
    window.open(url, '_blank');
  };
  
  // ========================================
  // å‘å…‰æ•ˆæœå±‚
  // ========================================
  function addGlowLayer() {
    if (!c.map) {
      console.error('âŒ Cannot add glow layer: map is null');
      return;
    }
    
    try {
      // æ£€æŸ¥å›¾å±‚æ˜¯å¦å·²å­˜åœ¨
      if (c.map.getLayer('glow-layer')) {
        console.log('â„¹ï¸ Glow layer already exists');
        return;
      }
      
      console.log('âœ¨ Adding glow layer');
      
      // æ·»åŠ ç©ºçš„æ•°æ®æº
      c.map.addSource('glow-points', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });
      
      // æ·»åŠ å‘å…‰åœ†åœˆå±‚
      c.map.addLayer({
        id: 'glow-layer',
        type: 'circle',
        source: 'glow-points',
        paint: {
          'circle-radius': 40,
          'circle-color': '#00ffff',
          'circle-opacity': 0.2,
          'circle-blur': 1
        }
      });
      
      console.log('âœ… Glow layer added');
      
    } catch (error) {
      console.error('âŒ Error adding glow layer:', error);
    }
  }
  
  // ========================================
  // æ›´æ–°ç»Ÿè®¡æ•°æ®
  // ========================================
  function updateStats(stats) {
    if (stats) {
      c.stats = stats;
      console.log(']]>ğŸ“Š<![CDATA[ Stats updated:', stats);
    }
  }
  
  // ========================================
  // åˆå§‹åŒ–æ‰§è¡Œ
  // ========================================
  console.log(']]>ğŸš€<![CDATA[ Starting Kokoro Live Map initialization');
  
  $timeout(function() {
    initMap();
    
    // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
    if (c.autoRefresh) {
      startAutoRefresh();
    }
  }, 500);
  
  // ========================================
  // æ¸…ç†
  // ========================================
  $scope.$on('$destroy', function() {
    console.log(']]>ğŸ§¹<![CDATA[ Cleaning up...');
    stopAutoRefresh();
    
    if (c.map) {
      c.map.remove();
      c.map = null;
    }
  });
}]]></client_script>
        <controller_as>c</controller_as>
        <css>/* ========================================
   KOKORO LIVE MAP - INDUSTRIAL MINIMALISM
   ç™½è‰²é‡‘å±è´¨æ„Ÿ Â· å·¥ä¸šæç®€ä¸»ä¹‰
   ======================================== */

.kokoro-map-container {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #f8f9fa;
  font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
  overflow: hidden;
  z-index: 1000;
  
  /* é‡‘å±è´¨æ„Ÿå™ªç‚¹çº¹ç† */
  background-image: 
    repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.008) 2px, rgba(0,0,0,0.008) 4px),
    repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.008) 2px, rgba(0,0,0,0.008) 4px);
}

/* ========================================
   é¡¶éƒ¨æ§åˆ¶æ  - HUD é£æ ¼
   ======================================== */
.map-controls {
  position: absolute;
  top: 0; left: 0; right: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
  backdrop-filter: blur(20px) saturate(180%);
  padding: 20px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
  border-bottom: 1px solid rgba(0,0,0,0.12);
  box-shadow: 
    0 1px 0 0 rgba(255,255,255,0.8) inset,
    0 4px 20px -2px rgba(0,0,0,0.08);
  
  /* åˆ‡è§’æ•ˆæœ */
  clip-path: polygon(
    0 0,
    calc(100% - 20px) 0,
    100% 20px,
    100% 100%,
    0 100%
  );
}

.map-title {
  color: #1a1a1a;
  font-size: 1.4rem;
  font-weight: 700;
  letter-spacing: 0.5px;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 16px;
  text-transform: uppercase;
  
  /* è£…é¥°æ€§ç¼–å· */
  position: relative;
}

.map-title::before {
  content: '//';
  color: #666;
  font-size: 0.9rem;
  font-weight: 400;
  margin-right: -8px;
}

.map-title i {
  color: #333;
  font-size: 1.2rem;
}

.live-indicator {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.65rem;
  color: #1a1a1a;
  font-weight: 700;
  padding: 6px 14px;
  background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
  border: 1px solid rgba(0,0,0,0.15);
  letter-spacing: 1.5px;
  
  /* åˆ‡è§’ */
  clip-path: polygon(
    6px 0,
    100% 0,
    100% calc(100% - 6px),
    calc(100% - 6px) 100%,
    0 100%,
    0 6px
  );
  
  box-shadow: 
    0 1px 3px rgba(0,0,0,0.08),
    0 0 0 1px rgba(255,255,255,0.5) inset;
}

.pulse-dot {
  width: 6px;
  height: 6px;
  background: #1a1a1a;
  border-radius: 50%;
  animation: pulseMetal 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
}

@keyframes pulseMetal {
  0%, 100% { 
    transform: scale(1); 
    opacity: 1;
  }
  50% { 
    transform: scale(1.2); 
    opacity: 0.6;
  }
}

.control-buttons {
  display: flex;
  gap: 10px;
  align-items: center;
}

.map-btn {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 1px solid rgba(0,0,0,0.15);
  color: #1a1a1a;
  padding: 10px 20px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  font-weight: 600;
  font-size: 0.85rem;
  letter-spacing: 0.3px;
  display: flex;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
  
  /* çŸ©å½¢åˆ‡è§’ */
  clip-path: polygon(
    4px 0,
    100% 0,
    100% calc(100% - 4px),
    calc(100% - 4px) 100%,
    0 100%,
    0 4px
  );
  
  box-shadow: 
    0 1px 2px rgba(0,0,0,0.08),
    0 0 0 1px rgba(255,255,255,0.5) inset;
}

.map-btn:hover {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  transform: translateY(-1px);
  box-shadow: 
    0 2px 4px rgba(0,0,0,0.12),
    0 0 0 1px rgba(255,255,255,0.5) inset;
}

.map-btn:active {
  transform: translateY(0);
}

.map-btn.active {
  background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
  color: #fff;
  border-color: #1a1a1a;
  box-shadow: 
    0 2px 6px rgba(0,0,0,0.25),
    0 0 0 1px rgba(255,255,255,0.1) inset;
}

.map-btn i {
  font-size: 1rem;
}

.map-select {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 1px solid rgba(0,0,0,0.15);
  color: #1a1a1a;
  padding: 10px 18px;
  font-size: 0.85rem;
  font-weight: 600;
  letter-spacing: 0.3px;
  cursor: pointer;
  outline: none;
  text-transform: uppercase;
  
  /* åˆ‡è§’ */
  clip-path: polygon(
    4px 0,
    100% 0,
    100% calc(100% - 4px),
    calc(100% - 4px) 100%,
    0 100%,
    0 4px
  );
  
  box-shadow: 
    0 1px 2px rgba(0,0,0,0.08),
    0 0 0 1px rgba(255,255,255,0.5) inset;
}

.map-select:hover {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.map-select option {
  background: #fff;
  color: #1a1a1a;
}

/* ========================================
   åœ°å›¾ç”»å¸ƒ
   ======================================== */
.map-canvas {
  position: absolute;
  top: 80px;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1;
}

/* ========================================
   ä¾§è¾¹æ  - æ•°æ®é¢æ¿
   ======================================== */
.map-sidebar {
  position: absolute;
  top: 100px;
  right: 30px;
  width: 420px;
  max-height: calc(100vh - 140px);
  background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(248,249,250,0.98) 100%);
  backdrop-filter: blur(30px) saturate(180%);
  border: 1px solid rgba(0,0,0,0.15);
  box-shadow: 
    0 20px 60px rgba(0,0,0,0.15),
    0 0 0 1px rgba(255,255,255,0.5) inset,
    0 1px 0 0 rgba(255,255,255,0.8) inset;
  z-index: 50;
  overflow: hidden;
  
  /* åˆ‡è§’ */
  clip-path: polygon(
    0 0,
    calc(100% - 30px) 0,
    100% 30px,
    100% 100%,
    30px 100%,
    0 calc(100% - 30px)
  );
}

.map-sidebar.slide-in {
  animation: slideInMetal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideInMetal {
  from {
    transform: translateX(480px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.sidebar-header {
  background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
  padding: 20px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  position: relative;
}

/* è£…é¥°æ€§æ¡çº¹ */
.sidebar-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: repeating-linear-gradient(
    90deg,
    rgba(255,255,255,0.1) 0px,
    rgba(255,255,255,0.1) 10px,
    transparent 10px,
    transparent 20px
  );
}

.sidebar-header h3 {
  color: #fff;
  font-size: 1.1rem;
  font-weight: 700;
  margin: 0;
  letter-spacing: 1px;
  text-transform: uppercase;
  font-family: 'Courier New', monospace;
}

.close-btn {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff;
  width: 32px;
  height: 32px;
  font-size: 1.2rem;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  
  /* åˆ‡è§’ */
  clip-path: polygon(
    4px 0,
    100% 0,
    100% calc(100% - 4px),
    calc(100% - 4px) 100%,
    0 100%,
    0 4px
  );
}

.close-btn:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.1);
}

.sidebar-content {
  padding: 30px;
  overflow-y: auto;
  max-height: calc(100vh - 300px);
}

/* ç²¾ç»†æ»šåŠ¨æ¡ */
.sidebar-content::-webkit-scrollbar {
  width: 4px;
}

.sidebar-content::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.03);
}

.sidebar-content::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 2px;
}

.sidebar-content::-webkit-scrollbar-thumb:hover {
  background: rgba(0,0,0,0.3);
}

/* ========================================
   ç´§æ€¥åº¦æ ‡è¯† - æç®€è®¾è®¡
   ======================================== */
.urgency-badge {
  display: inline-block;
  padding: 12px 24px;
  font-weight: 700;
  font-size: 0.8rem;
  margin-bottom: 24px;
  width: 100%;
  text-align: left;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  position: relative;
  
  /* åˆ‡è§’ */
  clip-path: polygon(
    8px 0,
    100% 0,
    100% calc(100% - 8px),
    calc(100% - 8px) 100%,
    0 100%,
    0 8px
  );
}

/* è£…é¥°æ€§ç¼–å· */
.urgency-badge::before {
  content: '//';
  position: absolute;
  left: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.7rem;
  opacity: 0.4;
}

.urgency-Critical {
  background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
  color: #fff;
  border: 2px solid #d32f2f;
  box-shadow: 
    0 0 20px rgba(211, 47, 47, 0.3),
    0 4px 12px rgba(0,0,0,0.2);
  animation: urgencyPulseMetal 3s ease-in-out infinite;
}

.urgency-High {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  color: #1a1a1a;
  border: 2px solid #f57c00;
  box-shadow: 0 2px 8px rgba(245, 124, 0, 0.15);
}

.urgency-Medium {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  color: #1a1a1a;
  border: 2px solid #fbc02d;
  box-shadow: 0 2px 8px rgba(251, 192, 45, 0.15);
}

.urgency-Low {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  color: #1a1a1a;
  border: 2px solid #689f38;
  box-shadow: 0 2px 8px rgba(104, 159, 56, 0.15);
}

@keyframes urgencyPulseMetal {
  0%, 100% { 
    border-color: #d32f2f;
    box-shadow: 
      0 0 20px rgba(211, 47, 47, 0.3),
      0 4px 12px rgba(0,0,0,0.2);
  }
  50% { 
    border-color: #ff5252;
    box-shadow: 
      0 0 30px rgba(255, 82, 82, 0.5),
      0 4px 12px rgba(0,0,0,0.2);
  }
}

/* ========================================
   ä¿¡æ¯åŒºåŸŸ - HUD æ•°æ®æ˜¾ç¤º
   ======================================== */
.info-section {
  background: linear-gradient(135deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.01) 100%);
  border: 1px solid rgba(0,0,0,0.08);
  padding: 20px;
  margin-bottom: 24px;
  position: relative;
  
  /* åˆ‡è§’ */
  clip-path: polygon(
    12px 0,
    100% 0,
    100% calc(100% - 12px),
    calc(100% - 12px) 100%,
    0 100%,
    0 12px
  );
}

/* è£…é¥°æ€§ç½‘æ ¼ */
.info-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    repeating-linear-gradient(0deg, transparent, transparent 10px, rgba(0,0,0,0.01) 10px, rgba(0,0,0,0.01) 11px),
    repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0,0,0,0.01) 10px, rgba(0,0,0,0.01) 11px);
  pointer-events: none;
}

.info-row {
  display: flex;
  align-items: flex-start;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  color: #1a1a1a;
  font-size: 0.95rem;
  position: relative;
  font-weight: 500;
}

.info-row:last-child {
  border-bottom: none;
}

.info-row i {
  color: #333;
  width: 20px;
  text-align: center;
  margin-top: 2px;
  flex-shrink: 0;
  font-size: 0.9rem;
}

.info-row strong {
  font-weight: 700;
  color: #000;
}

.info-row.coordinates {
  font-family: 'SF Mono', 'Courier New', monospace;
  font-size: 0.85rem;
  color: #555;
  background: rgba(0,0,0,0.03);
  padding: 12px 14px;
  margin: 8px -20px;
  border-bottom: none;
}

.info-row .remarks {
  font-style: normal;
  color: #555;
  line-height: 1.6;
  background: rgba(251, 192, 45, 0.08);
  padding: 8px 12px;
  margin: 4px -4px;
  border-left: 3px solid #fbc02d;
}

/* ========================================
   æ“ä½œæŒ‰é’® - å·¥ä¸šè®¾è®¡
   ======================================== */
.sidebar-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.action-btn {
  flex: 1;
  padding: 14px;
  border: none;
  font-weight: 700;
  font-size: 0.85rem;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  
  /* åˆ‡è§’ */
  clip-path: polygon(
    8px 0,
    100% 0,
    100% calc(100% - 8px),
    calc(100% - 8px) 100%,
    0 100%,
    0 8px
  );
}

.action-btn.primary {
  background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
  color: #fff;
  box-shadow: 
    0 4px 12px rgba(0,0,0,0.25),
    0 0 0 1px rgba(255,255,255,0.1) inset;
}

.action-btn.primary:hover {
  background: linear-gradient(135deg, #333 0%, #444 100%);
  transform: translateY(-2px);
  box-shadow: 
    0 6px 16px rgba(0,0,0,0.3),
    0 0 0 1px rgba(255,255,255,0.1) inset;
}

.action-btn.primary:active {
  transform: translateY(0);
}

.action-btn.secondary {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  border: 2px solid #1a1a1a;
  color: #1a1a1a;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.action-btn.secondary:hover {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

/* ========================================
   ç»Ÿè®¡é¢æ¿ - æ•°æ® HUD (å¢å¼ºå¯è§æ€§)
   ======================================== */
.stats-panel {
  position: absolute;
  bottom: 30px;
  left: 30px;
  display: flex;
  gap: 16px;
  z-index: 50;
}

.stat-item {
  background: linear-gradient(135deg, rgba(0,0,0,0.95) 0%, rgba(26,26,26,0.95) 100%);
  backdrop-filter: blur(30px) saturate(180%);
  border: 2px solid rgba(255,255,255,0.2);
  padding: 20px 28px;
  min-width: 140px;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  
  /* åˆ‡è§’ */
  clip-path: polygon(
    12px 0,
    100% 0,
    100% calc(100% - 12px),
    calc(100% - 12px) 100%,
    0 100%,
    0 12px
  );
  
  box-shadow: 
    0 8px 32px rgba(0,0,0,0.8),
    0 0 0 1px rgba(255,255,255,0.1) inset,
    0 1px 0 0 rgba(255,255,255,0.15) inset;
}

.stat-item:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 12px 40px rgba(0,0,0,0.9),
    0 0 0 1px rgba(255,255,255,0.15) inset;
  border-color: rgba(255,255,255,0.3);
  background: linear-gradient(135deg, rgba(0,0,0,0.98) 0%, rgba(26,26,26,0.98) 100%);
}

/* å·¦ä¾§è£…é¥°æ¡ */
.stat-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  width: 4px;
}

.stat-item.critical::before {
  background: linear-gradient(180deg, #ff5252 0%, #d32f2f 100%);
  box-shadow: 0 0 16px rgba(255, 82, 82, 0.8);
}

.stat-item.pending::before {
  background: linear-gradient(180deg, #ffeb3b 0%, #fbc02d 100%);
  box-shadow: 0 0 16px rgba(255, 235, 59, 0.8);
}

.stat-item.active::before {
  background: linear-gradient(180deg, #ffffff 0%, #e0e0e0 100%);
  box-shadow: 0 0 16px rgba(255, 255, 255, 0.8);
}

/* å‡ ä½•å›¾æ ‡ - ä»£æ›¿ emoji */
.stat-icon {
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  flex-shrink: 0;
}

/* Critical å›¾æ ‡ - å…­è¾¹å½¢è­¦å‘Š */
.stat-item.critical .stat-icon::before {
  content: '';
  width: 32px;
  height: 32px;
  background: #d32f2f;
  clip-path: polygon(
    50% 0%,
    100% 25%,
    100% 75%,
    50% 100%,
    0% 75%,
    0% 25%
  );
  box-shadow: 0 0 20px rgba(211, 47, 47, 1);
}

.stat-item.critical .stat-icon::after {
  content: '!';
  position: absolute;
  color: #fff;
  font-size: 1.4rem;
  font-weight: 900;
  text-shadow: 0 0 8px rgba(255,255,255,0.8);
}

/* Pending å›¾æ ‡ - æ—‹è½¬æ–¹å— */
.stat-item.pending .stat-icon::before {
  content: '';
  width: 28px;
  height: 28px;
  background: #fbc02d;
  clip-path: polygon(
    8px 0,
    100% 0,
    100% calc(100% - 8px),
    calc(100% - 8px) 100%,
    0 100%,
    0 8px
  );
  transform: rotate(45deg);
  box-shadow: 0 0 20px rgba(251, 192, 45, 1);
}

/* Active å›¾æ ‡ - ç®­å¤´ */
.stat-item.active .stat-icon::before {
  content: '';
  width: 0;
  height: 0;
  border-left: 18px solid transparent;
  border-right: 18px solid transparent;
  border-bottom: 28px solid #ffffff;
  transform: rotate(45deg);
  box-shadow: 0 0 20px rgba(255, 255, 255, 1);
  filter: drop-shadow(0 0 8px rgba(255,255,255,0.8));
}

.stat-info {
  display: flex;
  flex-direction: column;
}

.stat-number {
  font-size: 2.2rem;
  font-weight: 800;
  color: #ffffff;
  line-height: 1;
  font-family: 'SF Mono', 'Courier New', monospace;
  text-shadow: 
    0 2px 8px rgba(0,0,0,0.5),
    0 0 12px rgba(255,255,255,0.3);
}

.stat-label {
  font-size: 0.75rem;
  color: rgba(255,255,255,0.85);
  font-weight: 700;
  margin-top: 6px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  text-shadow: 0 1px 4px rgba(0,0,0,0.5);
}

/* ========================================
   åŠ è½½çŠ¶æ€
   ======================================== */
.loading-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 200;
  color: #1a1a1a;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 3px solid rgba(0,0,0,0.1);
  border-top-color: #1a1a1a;
  border-radius: 0;
  animation: spinMetal 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
  margin-bottom: 24px;
  
  /* åˆ‡è§’ */
  clip-path: polygon(
    6px 0,
    100% 0,
    100% calc(100% - 6px),
    calc(100% - 6px) 100%,
    0 100%,
    0 6px
  );
}

@keyframes spinMetal {
  to { transform: rotate(360deg); }
}

.loading-overlay p {
  font-size: 1.1rem;
  font-weight: 600;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #666;
}

/* ========================================
   å“åº”å¼è®¾è®¡
   ======================================== */
@media (max-width: 768px) {
  .map-controls {
    flex-direction: column;
    gap: 12px;
    padding: 16px 20px;
  }
  
  .map-title {
    font-size: 1.1rem;
  }
  
  .control-buttons {
    width: 100%;
    justify-content: space-between;
    flex-wrap: wrap;
  }
  
  .map-sidebar {
    width: calc(100% - 40px);
    right: 20px;
    left: 20px;
  }
  
  .stats-panel {
    bottom: 20px;
    left: 20px;
    right: 20px;
    flex-direction: row;
    gap: 12px;
  }
  
  .stat-item {
    flex: 1;
    min-width: 0;
    padding: 16px 20px;
  }
}

/* ========================================
   è‡ªå®šä¹‰åœ°å›¾æ ‡è®° - é—ªçƒå…‰ç‚¹ç³»ç»Ÿ
   ======================================== */
.custom-marker {
  cursor: pointer;
  transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  z-index: 10;
}

.custom-marker:hover {
  transform: scale(1.3);
  z-index: 100;
}

/* å…‰ç‚¹æ ·å¼ - ç®€æ´çš„åœ†å½¢å‘å…‰ç‚¹ */
.marker-icon {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  position: relative;
  box-shadow: 
    0 0 0 2px rgba(255,255,255,0.4),
    0 0 12px currentColor,
    0 0 24px currentColor;
  animation: markerPulse 2s ease-in-out infinite;
}

/* æ ¹æ®ç±»åˆ«è®¾ç½®é¢œè‰² */
.marker-icon[data-category="Water"] {
  background: #1976d2;
  color: #1976d2;
}

.marker-icon[data-category="Food"] {
  background: #f57c00;
  color: #f57c00;
}

.marker-icon[data-category="Medical"] {
  background: #d32f2f;
  color: #d32f2f;
}

.marker-icon[data-category="Baby"] {
  background: #7b1fa2;
  color: #7b1fa2;
}

.marker-icon[data-category="Power"] {
  background: #fbc02d;
  color: #fbc02d;
}

.marker-icon[data-category="Other"] {
  background: #616161;
  color: #616161;
}

/* å¤–åœˆå…‰ç¯ */
.marker-icon::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid currentColor;
  opacity: 0.4;
  animation: ringPulse 2s ease-in-out infinite;
}

/* å†…æ ¸å…‰ç‚¹ */
.marker-icon::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255,255,255,0.9);
  box-shadow: 0 0 8px rgba(255,255,255,0.8);
}

/* Critical æ ‡è®°ç‰¹æ®Šæ ·å¼ - å¿«é€Ÿé—ªçƒ */
.marker-pulse .marker-icon {
  animation: markerPulseCritical 1s ease-in-out infinite;
  box-shadow: 
    0 0 0 3px rgba(255,255,255,0.6),
    0 0 20px #d32f2f,
    0 0 40px #d32f2f;
}

.marker-pulse .marker-icon::before {
  animation: ringPulseCritical 1s ease-in-out infinite;
  border-width: 3px;
}

/* è„‰å†²åŠ¨ç”» */
@keyframes markerPulse {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.8;
  }
}

@keyframes markerPulseCritical {
  0%, 100% {
    transform: scale(1);
    box-shadow: 
      0 0 0 3px rgba(255,255,255,0.6),
      0 0 20px #d32f2f,
      0 0 40px #d32f2f;
  }
  50% {
    transform: scale(1.2);
    box-shadow: 
      0 0 0 5px rgba(255,255,255,0.8),
      0 0 30px #ff5252,
      0 0 60px #ff5252;
  }
}

@keyframes ringPulse {
  0%, 100% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 0.4;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.5);
    opacity: 0;
  }
}

@keyframes ringPulseCritical {
  0%, 100% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 0.6;
  }
  50% {
    transform: translate(-50%, -50%) scale(2);
    opacity: 0;
  }
}

/* ========================================
   æ¡å½¢ç è£…é¥°å…ƒç´ ï¼ˆå¯é€‰ï¼‰
   ======================================== */
.barcode-decoration {
  display: inline-block;
  height: 20px;
  background: repeating-linear-gradient(
    90deg,
    #1a1a1a 0px,
    #1a1a1a 2px,
    transparent 2px,
    transparent 4px,
    #1a1a1a 4px,
    #1a1a1a 5px,
    transparent 5px,
    transparent 8px
  );
  opacity: 0.3;
  width: 60px;
}

/* ========================================
   åœ°å›¾å·¥å…·é¢æ¿ - å³ä¾§å·¥å…·æ 
   ======================================== */
.map-tools-panel {
  position: absolute;
  top: 100px;
  right: 30px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 60;
}

.tool-group {
  background: linear-gradient(135deg, rgba(0,0,0,0.95) 0%, rgba(26,26,26,0.95) 100%);
  backdrop-filter: blur(30px) saturate(180%);
  border: 2px solid rgba(255,255,255,0.2);
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  
  clip-path: polygon(
    8px 0,
    100% 0,
    100% calc(100% - 8px),
    calc(100% - 8px) 100%,
    0 100%,
    0 8px
  );
  
  box-shadow: 
    0 8px 32px rgba(0,0,0,0.8),
    0 0 0 1px rgba(255,255,255,0.1) inset;
}

.tool-btn {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.05) 100%);
  border: 1px solid rgba(255,255,255,0.15);
  color: rgba(255,255,255,0.8);
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  
  clip-path: polygon(
    4px 0,
    100% 0,
    100% calc(100% - 4px),
    calc(100% - 4px) 100%,
    0 100%,
    0 4px
  );
}

.tool-btn:hover {
  background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.1) 100%);
  border-color: rgba(255,255,255,0.3);
  color: #fff;
  transform: translateX(-4px);
  box-shadow: 0 0 16px rgba(255,255,255,0.2);
}

.tool-btn.active {
  background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
  border-color: #fff;
  color: #1a1a1a;
  box-shadow: 0 0 20px rgba(255,255,255,0.6);
}

/* ========================================
   å›¾ä¾‹é¢æ¿
   ======================================== */
.legend-panel {
  position: absolute;
  top: 100px;
  left: 30px;
  width: 280px;
  background: linear-gradient(135deg, rgba(0,0,0,0.95) 0%, rgba(26,26,26,0.95) 100%);
  backdrop-filter: blur(30px) saturate(180%);
  border: 2px solid rgba(255,255,255,0.2);
  padding: 20px;
  z-index: 55;
  
  clip-path: polygon(
    12px 0,
    100% 0,
    100% calc(100% - 12px),
    calc(100% - 12px) 100%,
    0 100%,
    0 12px
  );
  
  box-shadow: 
    0 8px 32px rgba(0,0,0,0.8),
    0 0 0 1px rgba(255,255,255,0.1) inset;
  
  animation: fadeInLeft 0.3s ease-out;
}

@keyframes fadeInLeft {
  from {
    transform: translateX(-30px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.legend-title {
  color: rgba(255,255,255,0.9);
  font-size: 0.75rem;
  font-weight: 800;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin: 0 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.15);
}

.legend-items {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 12px;
  color: rgba(255,255,255,0.8);
  font-size: 0.85rem;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.legend-marker {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  flex-shrink: 0;
  box-shadow: 
    0 0 0 2px rgba(255,255,255,0.3),
    0 0 8px currentColor;
  animation: legendPulse 2s ease-in-out infinite;
}

@keyframes legendPulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

.legend-priority {
  width: 40px;
  height: 12px;
  flex-shrink: 0;
  position: relative;
}

.legend-priority.critical {
  background: #d32f2f;
  box-shadow: 0 0 12px rgba(211, 47, 47, 0.6);
  animation: priorityPulseCritical 1s ease-in-out infinite;
}

.legend-priority.high {
  background: #f57c00;
  box-shadow: 0 0 8px rgba(245, 124, 0, 0.4);
}

.legend-priority.medium {
  background: #fbc02d;
  box-shadow: 0 0 8px rgba(251, 192, 45, 0.4);
}

.legend-priority.low {
  background: #689f38;
  box-shadow: 0 0 8px rgba(104, 159, 56, 0.4);
}

@keyframes priorityPulseCritical {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ========================================
   å“åº”å¼ - ç§»åŠ¨ç«¯ä¼˜åŒ–
   ======================================== */
@media (max-width: 768px) {
  /* å·¥å…·é¢æ¿ç§»åˆ°åº•éƒ¨ */
  .map-tools-panel {
    top: auto;
    bottom: 120px;
    right: 20px;
  }
  
  .tool-group {
    flex-direction: row;
    padding: 8px;
  }
  
  .tool-btn {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }
  
  /* å›¾ä¾‹é¢æ¿è‡ªåŠ¨éšè— */
  .legend-panel {
    width: calc(100% - 40px);
    left: 20px;
    max-height: 50vh;
    overflow-y: auto;
  }
  
  /* ç»Ÿè®¡é¢æ¿é€‚é… */
  .stats-panel {
    bottom: 20px;
    left: 20px;
    right: 20px;
    gap: 8px;
  }
  
  .stat-item {
    flex: 1;
    min-width: 0;
    padding: 16px 20px;
  }
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>kokoro_live_map</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Kokoro Live Map</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  
  // 1. è·å– Token
  data.mapbox_token = gs.getProperty('x_1821654_kokoro_0.kokoro.mapbox.api_key', '');
  
  // 2. å¤„ç†è¯·æ±‚
  if (input && input.action) {
    
    if (input.action === 'get_map_requests') {
      data.requests = [];
      data.stats = { critical: 0, pending: 0, inProgress: 0 };
      
      var gr = new GlideRecord('x_1821654_kokoro_0_silent_wish');
      
      // --- 1. ç­›é€‰é€»è¾‘ ---
      // æ•°æ®åº“çœŸåæ˜¯ latitude å’Œ longitude (æ—  u_)
      gr.addNotNullQuery('latitude');
      gr.addNotNullQuery('longitude');
      
      // å¯é€‰ï¼šåªçœ‹ Open(1) å’Œ In Progress(2) çš„å·¥å•ï¼Œè¿‡æ»¤æ‰å·²å®Œæˆçš„
      // gr.addQuery('state', 'IN', '1,2'); 
      
      gr.orderByDesc('sys_created_on');
      gr.setLimit(50); 
      gr.query();
      
      // gs.info('[Kokoro Map] Found ' + gr.getRowCount() + ' records.');
      
      while (gr.next()) {
        // è·å–åæ ‡ (ä½¿ç”¨çœŸå)
        var lat = gr.getValue('latitude');
        var lng = gr.getValue('longitude');
        
        if (lat && lng) {
            var req = {
              sys_id: gr.getUniqueValue(),
              number: gr.getValue('number'),

              // --- âœ… æ ¸å¿ƒå­—æ®µä¿®æ­£ (ä¸æ•°æ®åº“ä¸€è‡´) ---
              category: gr.getValue('request_category') || 'Other',
              urgency: gr.getValue('urgency') || 'Medium',
              quantity: parseInt(gr.getValue('qty')) || 1,
              remarks: gr.getValue('wish_content') || '',
              
              // åœ°ç‚¹ä¿¡æ¯
              zone: gr.getDisplayValue('shelter_zone') || '',
              detail_loc: gr.getValue('precise_location') || '', // å¯¹åº” precise_location
              
              // åæ ‡
              latitude: parseFloat(lat),
              longitude: parseFloat(lng),
              
              // çŠ¶æ€ä¸äººå‘˜
              assigned_to: gr.getDisplayValue('assigned_to'),
              assigned_to_id: gr.getValue('assigned_to'),
              state: gr.getValue('state'),
              
              // æ–°å¢å­—æ®µ (ä¿æŒä¸å…¶ä»– Widget ä¸€è‡´)
              contact: gr.getValue('u_contact_info') || '',
              affected_count: gr.getValue('u_affected_count') || 'ä¸æ˜',
              
              time_ago: gr.getDisplayValue('sys_created_on')
            };
            
            data.requests.push(req);
            
            // --- ç»Ÿè®¡é€»è¾‘ ---
            var state = gr.getValue('state');
            var urg = gr.getValue('urgency');
            
            if (urg === 'Critical') data.stats.critical++;
            if (state == '1') data.stats.pending++;
            if (state == '2') data.stats.inProgress++;
        }
      }
    }
  }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-23 05:50:12</sys_created_on>
        <sys_id>28e1ee66832af210f6b1fb96feaad3fb</sys_id>
        <sys_mod_count>16</sys_mod_count>
        <sys_name>Kokoro Live Map</sys_name>
        <sys_package display_value="Kokoro Shelter" source="x_1821654_kokoro_0">80ba4d9583863210f6b1fb96feaad3b2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Kokoro Shelter">80ba4d9583863210f6b1fb96feaad3b2</sys_scope>
        <sys_update_name>sp_widget_28e1ee66832af210f6b1fb96feaad3fb</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-10 01:04:35</sys_updated_on>
        <template><![CDATA[<div class="kokoro-map-container">
  
  <!-- é¡¶éƒ¨æ§åˆ¶æ  - HUD é£æ ¼ -->
  <div class="map-controls">
    <h2 class="map-title">
      <i class="fa fa-globe"></i>
      <span>KOKORO LIVE MAP</span>
      <span class="live-indicator" ng-if="c.autoRefresh">
        <span class="pulse-dot"></span>
        <span>LIVE</span>
      </span>
    </h2>
    
    <div class="control-buttons">
      <!-- åœ°å›¾æ ·å¼åˆ‡æ¢ -->
      <button class="map-btn" ng-click="c.toggleMapStyle()" 
              ng-class="{'active': c.isDarkMode}">
        <i class="fa fa-moon-o"></i>
        <span>{{c.isDarkMode ? 'SATELLITE' : 'STANDARD'}}</span>
      </button>
      
      <!-- 3Dè§†è§’åˆ‡æ¢ -->
      <button class="map-btn" ng-click="c.toggle3D()"
              ng-class="{'active': c.is3D}">
        <i class="fa fa-cube"></i>
        <span>{{c.is3D ? '3D' : '2D'}}</span>
      </button>
      
      <!-- å®æ—¶æ›´æ–°å¼€å…³ -->
      <button class="map-btn" ng-click="c.toggleAutoRefresh()"
              ng-class="{'active': c.autoRefresh}">
        <i class="fa fa-refresh" ng-class="{'fa-spin': c.autoRefresh}"></i>
        <span>REALTIME</span>
      </button>
      
      <!-- ]]>ğŸ†•<![CDATA[ èšç±»å¼€å…³ -->
      <button class="map-btn" ng-click="c.toggleClustering()"
              ng-class="{'active': c.clustering}">
        <i class="fa fa-object-group"></i>
        <span>CLUSTER</span>
      </button>
      
      <!-- ]]>ğŸ†•<![CDATA[ çƒ­åŠ›å›¾ -->
      <button class="map-btn" ng-click="c.toggleHeatmap()"
              ng-class="{'active': c.heatmapVisible}">
        <i class="fa fa-fire"></i>
        <span>HEATMAP</span>
      </button>
      
      <!-- ]]>ğŸ†•<![CDATA[ è·¯å¾„è§„åˆ’ -->
      <button class="map-btn" ng-click="c.toggleRouting()"
              ng-class="{'active': c.routingMode}">
        <i class="fa fa-route"></i>
        <span>ROUTE</span>
      </button>
      
      <!-- è¿‡æ»¤å™¨ -->
      <select class="map-select" ng-model="c.urgencyFilter" 
              ng-change="c.applyFilter()">
        <option value="">ALL PRIORITY</option>
        <option value="Critical">CRITICAL</option>
        <option value="High">HIGH</option>
        <option value="Medium">MEDIUM</option>
        <option value="Low">LOW</option>
      </select>
      
      <!-- ]]>ğŸ†•<![CDATA[ ç±»åˆ«è¿‡æ»¤ -->
      <select class="map-select" ng-model="c.categoryFilter" 
              ng-change="c.applyFilter()">
        <option value="">ALL TYPES</option>
        <option value="Water">WATER</option>
        <option value="Food">FOOD</option>
        <option value="Medical">MEDICAL</option>
        <option value="Baby">BABY</option>
        <option value="Power">POWER</option>
        <option value="Other">OTHER</option>
      </select>
    </div>
  </div>
  
  <!-- åœ°å›¾å®¹å™¨ -->
  <div id="kokoro-map" class="map-canvas"></div>
  
  <!-- ä¾§è¾¹æ ï¼šè¯·æ±‚è¯¦æƒ… -->
  <div class="map-sidebar" ng-if="c.selectedRequest" ng-class="{'slide-in': c.selectedRequest}">
    
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="sidebar-header">
      <h3>{{c.selectedRequest.number}}</h3>
      <button class="close-btn" ng-click="c.closeDetails()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="sidebar-content">
      
      <!-- ç´§æ€¥åº¦æ ‡è¯† -->
      <div class="urgency-badge urgency-{{c.selectedRequest.urgency}}">
        <span>{{c.dict[c.selectedRequest.urgency]}} PRIORITY</span>
      </div>
      
      <!-- éœ€æ±‚ä¿¡æ¯ -->
      <div class="info-section">
        
        <!-- ç‰©èµ„ç±»åˆ« -->
        <div class="info-row">
          <i class="fa fa-box"></i>
          <span>{{c.dict[c.selectedRequest.category]}} <strong>x{{c.selectedRequest.quantity}}</strong></span>
        </div>
        
        <!-- ä½ç½®ä¿¡æ¯ -->
        <div class="info-row">
          <i class="fa fa-map-marker"></i>
          <span><strong>{{c.selectedRequest.zone}}</strong></span>
        </div>
        
        <div class="info-row">
          <i class="fa fa-home"></i>
          <span>{{c.selectedRequest.detail_loc}}</span>
        </div>
        
        <!-- åæ ‡ä¿¡æ¯ -->
        <div class="info-row coordinates">
          <i class="fa fa-location-arrow"></i>
          <span>{{c.selectedRequest.latitude | number:6}}, {{c.selectedRequest.longitude | number:6}}</span>
        </div>
        
        <!-- æ—¶é—´ä¿¡æ¯ -->
        <div class="info-row">
          <i class="fa fa-clock-o"></i>
          <span>{{c.selectedRequest.time_ago}}</span>
        </div>
        
        <!-- æ‹…å½“è€… -->
        <div class="info-row" ng-if="c.selectedRequest.assigned_to">
          <i class="fa fa-user"></i>
          <span>ASSIGNED: <strong>{{c.selectedRequest.assigned_to}}</strong></span>
        </div>
        
        <!-- å¤‡æ³¨ -->
        <div class="info-row" ng-if="c.selectedRequest.remarks">
          <i class="fa fa-sticky-note-o"></i>
          <span class="remarks">{{c.selectedRequest.remarks}}</span>
        </div>
        
      </div>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <div class="sidebar-actions">
        <button class="action-btn primary" ng-click="c.assignToMe(c.selectedRequest)"
                ng-if="!c.selectedRequest.assigned_to_id">
          <i class="fa fa-hand-paper-o"></i>
          <span>ASSIGN</span>
        </button>
        
        <button class="action-btn secondary" ng-click="c.openDirections(c.selectedRequest)">
          <i class="fa fa-location-arrow"></i>
          <span>NAVIGATE</span>
        </button>
      </div>
      
    </div>
  </div>
  
  <!-- ]]>ğŸ†•<![CDATA[ åœ°å›¾åŠŸèƒ½å·¥å…·é¢æ¿ -->
  <div class="map-tools-panel">
    <div class="tool-group">
      <button class="tool-btn" ng-click="c.fitBounds()" title="View All Markers">
        <i class="fa fa-expand"></i>
      </button>
      <button class="tool-btn" ng-click="c.centerOnUser()" title="My Location">
        <i class="fa fa-crosshairs"></i>
      </button>
      <button class="tool-btn" ng-click="c.toggleMeasure()" 
              ng-class="{'active': c.measureMode}" title="Measure Distance">
        <i class="fa fa-ruler"></i>
      </button>
      <button class="tool-btn" ng-click="c.exportData()" title="Export CSV">
        <i class="fa fa-download"></i>
      </button>
      <button class="tool-btn" ng-click="c.shareMap()" title="Share Map">
        <i class="fa fa-share-alt"></i>
      </button>
      <button class="tool-btn" ng-click="c.toggleLegend()"
              ng-class="{'active': c.legendVisible}" title="Legend">
        <i class="fa fa-info-circle"></i>
      </button>
    </div>
  </div>
  
  <!-- ]]>ğŸ†•<![CDATA[ å›¾ä¾‹é¢æ¿ -->
  <div class="legend-panel" ng-if="c.legendVisible">
    <h4 class="legend-title">MARKER LEGEND</h4>
    <div class="legend-items">
      <div class="legend-item">
        <div class="legend-marker" style="background: #1976d2;"></div>
        <span>WATER</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker" style="background: #f57c00;"></div>
        <span>FOOD</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker" style="background: #d32f2f;"></div>
        <span>MEDICAL</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker" style="background: #7b1fa2;"></div>
        <span>BABY</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker" style="background: #fbc02d;"></div>
        <span>POWER</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker" style="background: #616161;"></div>
        <span>OTHER</span>
      </div>
    </div>
    
    <h4 class="legend-title" style="margin-top: 16px;">PRIORITY</h4>
    <div class="legend-items">
      <div class="legend-item">
        <div class="legend-priority critical"></div>
        <span>CRITICAL (Fast Pulse)</span>
      </div>
      <div class="legend-item">
        <div class="legend-priority high"></div>
        <span>HIGH</span>
      </div>
      <div class="legend-item">
        <div class="legend-priority medium"></div>
        <span>MEDIUM</span>
      </div>
      <div class="legend-item">
        <div class="legend-priority low"></div>
        <span>LOW</span>
      </div>
    </div>
  </div>
  
  <!-- ç»Ÿè®¡é¢æ¿ - æ•°æ® HUD (å‡ ä½•å›¾æ ‡) -->
  <div class="stats-panel">
    
    <div class="stat-item critical">
      <div class="stat-icon"></div>
      <div class="stat-info">
        <span class="stat-number">{{c.stats.critical}}</span>
        <span class="stat-label">CRITICAL</span>
      </div>
    </div>
    
    <div class="stat-item pending">
      <div class="stat-icon"></div>
      <div class="stat-info">
        <span class="stat-number">{{c.stats.pending}}</span>
        <span class="stat-label">PENDING</span>
      </div>
    </div>
    
    <div class="stat-item active">
      <div class="stat-icon"></div>
      <div class="stat-info">
        <span class="stat-number">{{c.stats.inProgress}}</span>
        <span class="stat-label">ACTIVE</span>
      </div>
    </div>
    
  </div>
  
  <!-- åŠ è½½æç¤º -->
  <div class="loading-overlay" ng-if="c.loading">
    <div class="loading-spinner"></div>
    <p>INITIALIZING MAP SYSTEM...</p>
  </div>
  
</div>]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>28e1ee66832af210f6b1fb96feaad3fb</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-23 05:50:12</sys_created_on>
        <sys_id>ece1ee66832af210f6b1fb96feaad3fe</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-23 05:50:12</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
