<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_1821654_kokoro_0.MapboxGeocoder</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <mobile_callable>false</mobile_callable>
        <name>MapboxGeocoder</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var MapboxGeocoder = Class.create();
   MapboxGeocoder.prototype = {
       
       initialize: function() {
           this.apiKey = gs.getProperty('x_1821654_kokoro_0.kokoro.mapbox.api_key', '');
        
        this.baseUrl = 'https://api.mapbox.com/geocoding/v5/mapbox.places/';
    },
       
       /**
        * 地址 → 坐标
        * @param {String} address - 地址
        * @return {Object} - {success, lat, lng, error}
        */
       geocode: function(address) {
           var result = {
               success: false,
               lat: null,
               lng: null,
               error: ''
           };
           
           if (!this.apiKey) {
               result.error = 'Mapbox API key not configured';
               return result;
           }
           
           try {
               var url = this.baseUrl + 
                        encodeURIComponent(address) + 
                        '.json?access_token=' + this.apiKey + 
                        '&limit=1';
               
               var request = new sn_ws.RESTMessageV2();
               request.setEndpoint(url);
               request.setHttpMethod('GET');
               request.setRequestHeader('Accept', 'application/json');
               
               var response = request.execute();
               var status = response.getStatusCode();
               
               if (status == 200) {
                   var body = response.getBody();
                   var data = JSON.parse(body);
                   
                   if (data.features && data.features.length > 0) {
                       var coords = data.features[0].geometry.coordinates;
                       result.success = true;
                       result.lng = coords[0]; // 经度
                       result.lat = coords[1]; // 纬度
                       result.place_name = data.features[0].place_name;
                   } else {
                       result.error = 'No results found for: ' + address;
                   }
               } else {
                   result.error = 'API returned status: ' + status;
               }
               
           } catch (e) {
               result.error = 'Exception: ' + e.message;
               gs.error('MapboxGeocoder error: ' + e.message);
           }
           
           return result;
       },
       
       /**
        * 坐标 → 地址（反向地理编码）
        */
       reverseGeocode: function(lng, lat) {
           var result = {
               success: false,
               address: '',
               error: ''
           };
           
           try {
               var url = this.baseUrl + lng + ',' + lat + 
                        '.json?access_token=' + this.apiKey;
               
               var request = new sn_ws.RESTMessageV2();
               request.setEndpoint(url);
               request.setHttpMethod('GET');
               
               var response = request.execute();
               
               if (response.getStatusCode() == 200) {
                   var data = JSON.parse(response.getBody());
                   if (data.features && data.features.length > 0) {
                       result.success = true;
                       result.address = data.features[0].place_name;
                   }
               }
               
           } catch (e) {
               result.error = e.message;
           }
           
           return result;
       },
       
       type: 'MapboxGeocoder'
   };]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-23 04:31:49</sys_created_on>
        <sys_id>fe2fc62a83a6f210f6b1fb96feaad394</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>MapboxGeocoder</sys_name>
        <sys_package display_value="Kokoro Shelter" source="x_1821654_kokoro_0">80ba4d9583863210f6b1fb96feaad3b2</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Kokoro Shelter">80ba4d9583863210f6b1fb96feaad3b2</sys_scope>
        <sys_update_name>sys_script_include_fe2fc62a83a6f210f6b1fb96feaad394</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-23 04:40:02</sys_updated_on>
    </sys_script_include>
</record_update>
