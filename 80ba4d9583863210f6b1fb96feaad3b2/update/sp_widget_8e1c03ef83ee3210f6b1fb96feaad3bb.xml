<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, spUtil, $timeout, $window, $interval) {
    var c = this;

    // ============================================================
    // KOKORO USER - Client Script (Refugee Mode)
    // Version: 3.0 (Split Version)
    // ä¿®å¤: å²è±å§†hoverå˜è‰², çœ¼ç›è·Ÿéš
    // ============================================================

    // çŠ¶æ€åˆå§‹åŒ–
    var CONFIG = {
        states: { DRAFT: 1, SUBMITTED: 10, ASSIGNED: 11, IN_PROGRESS: 2, COMPLETED: 4, CANCELLED: 5, ON_HOLD: 6 },
        debounceDelay: 300
    };

    c.step = 0;
    c.is_poked = false;
    c.show_will_input = false;
    c.digital_will = "";
    c.current_state_val = 0;
    c.is_editing = false;
    c.submitting = false;
    c.saving = false;
    c.status_message = "å¾…æ©Ÿä¸­...";
    c.showSettings = false;
    c.current_heartbeat_id = null;
    c.ticket_number = "";
    c.ticket_sys_id = null;
    c.files = null;
    c.fileData = null;

    c.data.user_name = c.data.user_name || "ãŠå®¢æ§˜";

    c.temp_settings = {
        email: c.data.emergency_email || "",
        medical_info: c.data.medical_info || "",
        blood_type: c.data.blood_type || "",
        will: c.data.saved_will || ""
    };

    // å­—å…¸æ˜ å°„
    c.dict = {
        'Water': 'é£²æ–™æ°´', 'Food': 'é£Ÿæ–™', 'Medical': 'åŒ»ç™‚ãƒ»è–¬',
        'Baby': 'ä¹³å¹¼å…ç”¨å“', 'Power': 'é›»æºãƒ»å……é›»', 'Other': 'ãã®ä»–',
        'Family Area': 'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚¨ãƒªã‚¢', 'Single Area': 'å˜èº«ã‚¨ãƒªã‚¢', 'Medical Area': 'åŒ»ç™‚ãƒ»ã‚±ã‚¢ã‚¨ãƒªã‚¢',
        'Critical': 'é™ç•Œ (SOS)', 'High': 'å›°ã£ã¦ã„ã‚‹', 'Medium': 'æ™®é€š', 'Low': 'æ€¥ãã¾ã›ã‚“'
    };

    c.statusDetails = {
        1: { icon: ']]>ğŸ“<![CDATA[', title: 'DRAFT', desc: 'é€ä¿¡å‰ã®çŠ¶æ…‹', nextStep: 'é€ä¿¡ã—ã¦ãã ã•ã„' },
        10: { icon: ']]>ğŸ“¨<![CDATA[', title: 'SUBMITTED', desc: 'ã‚·ã‚¹ãƒ†ãƒ ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡', nextStep: 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ç¢ºèªå¾…ã¡' },
        11: { icon: ']]>ğŸ™‹<![CDATA[', title: 'ASSIGNED', desc: 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ãŒæ‹…å½“', nextStep: 'é…é€æº–å‚™ä¸­' },
        2: { icon: ']]>ğŸƒ<![CDATA[', title: 'IN_PROGRESS', desc: 'æ•‘æ´ç‰©è³‡ã‚’æŒã£ã¦ç§»å‹•ä¸­', nextStep: 'ã¾ã‚‚ãªãåˆ°ç€' },
        4: { icon: 'âœ…', title: 'COMPLETED', desc: 'ãŠå±Šã‘å®Œäº†', nextStep: 'ãŠå¤§äº‹ã«' },
        5: { icon: 'âŒ', title: 'CANCELLED', desc: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', nextStep: '' },
        6: { icon: 'â¸ï¸', title: 'ON_HOLD', desc: 'ä¸€æ™‚åœæ­¢', nextStep: 'å†é–‹å¾…ã¡' }
    };

    // å·¥å…·å‡½æ•°
    function showSuccess(msg) { spUtil.addInfoMessage(msg); }
    function showError(msg) { spUtil.addErrorMessage(msg || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }

    function handleServerResponse(response, successCallback) {
        if (!response || !response.data) { showError('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼'); return false; }
        if (response.data.error) { showError(response.data.error); return false; }
        if (successCallback) successCallback(response.data);
        return true;
    }

    // è·³è½¬åˆ°å¿—æ„¿è€…è§†å›¾
    c.goToVolunteerView = function() {
        $window.location.href = '?id=kokoro_volunteer';
    };

    // ==========================================
    // çœ¼ç›è·Ÿéšé¼ æ ‡
    // ==========================================
    $scope.eyeX = 0;
    $scope.eyeY = 0;
    var targetEyeX = 0, targetEyeY = 0, eyeAnimationFrame = null;

    function animateEyes() {
        $scope.eyeX += (targetEyeX - $scope.eyeX) * 0.15;
        $scope.eyeY += (targetEyeY - $scope.eyeY) * 0.15;
        
        if (Math.abs(targetEyeX - $scope.eyeX) > 0.01 || Math.abs(targetEyeY - $scope.eyeY) > 0.01) {
            eyeAnimationFrame = requestAnimationFrame(function() {
                $scope.$apply();
                animateEyes();
            });
        } else {
            eyeAnimationFrame = null;
        }
    }

    function handleMouseMove(e) {
        var cx = $window.innerWidth / 2;
        var cy = $window.innerHeight / 2;
        var range = 8;
        
        targetEyeX = Math.max(Math.min((e.clientX - cx) / cx * range, range), -range);
        targetEyeY = Math.max(Math.min((e.clientY - cy) / cy * range, range * 0.5), -range * 0.5);
        
        if (!eyeAnimationFrame) {
            animateEyes();
        }
    }

    $window.addEventListener('mousemove', handleMouseMove);

    // ==========================================
    // å²è±å§†äº¤äº’
    // ==========================================
    c.pokeSlime = function() {
        if (c.step > 0 || c.show_will_input || c.is_poked) return;
        
        c.is_poked = true;
        
        c.server.get({ action: 'register_heartbeat' }).then(function(r) {
            handleServerResponse(r, function(data) {
                c.current_heartbeat_id = data.heartbeat_id;
                $timeout(function() {
                    c.show_will_input = true;
                    c.is_poked = false;
                }, 800);
            });
        }).catch(function() {
            c.is_poked = false;
            showError('æ¥ç¶šã‚¨ãƒ©ãƒ¼');
        });
    };

    c.finishHeartbeat = function(save) {
        if (save && c.digital_will && c.digital_will.trim()) {
            c.server.get({
                action: 'update_will',
                heartbeat_id: c.current_heartbeat_id,
                message: c.digital_will
            }).then(function(r) {
                if (r && r.data && r.data.success) {
                    showSuccess("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
                }
            });
        }
        c.show_will_input = false;
        c.digital_will = "";
        c.step = 1;
    };

    // ==========================================
    // è¡¨å•æ­¥éª¤æ§åˆ¶
    // ==========================================
    c.onLocationChange = function() {
        if (c.step === 1 && !c.is_editing && c.data.location) {
            $timeout(function() { c.step = 2; }, CONFIG.debounceDelay);
        }
    };

    var detailCheckTimer = null;
    c.checkDetail = function() {
        if (detailCheckTimer) $timeout.cancel(detailCheckTimer);
        detailCheckTimer = $timeout(function() {
            if (c.data.detail_loc && c.data.detail_loc.trim().length > 0 && c.step < 3) {
                c.step = 3;
            }
        }, CONFIG.debounceDelay);
    };

    c.checkInput = function() {
        if (c.data.category && c.data.quantity && c.data.urgency) {
            if (c.step < 4) c.step = 4;
        }
    };

    c.editMode = function() {
        c.step = 4;
        c.is_editing = true;
        c.status_message = "å†…å®¹ä¿®æ­£ä¸­...";
    };

    // ==========================================
    // æäº¤è¡¨å•
    // ==========================================
    c.submitWish = function() {
        if (!c.data.location) {
            showError("ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }
        if (!c.data.detail_loc || c.data.detail_loc.trim() === '') {
            showError("è©³ç´°ãªå ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }
        if (!c.data.category) {
            showError("æ”¯æ´å†…å®¹ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }
        if (!c.data.quantity || parseInt(c.data.quantity) < 1) {
            showError("æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }
        if (!c.data.urgency) {
            showError("ç·Šæ€¥åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }

        c.submitting = true;

        var inputData = {
            action: c.is_editing ? 'update_record' : 'submit_record',
            sys_id: c.ticket_sys_id,
            location: c.data.location,
            detail_loc: c.data.detail_loc,
            category: c.data.category,
            quantity: c.data.quantity,
            affected_count: c.data.affected_count,
            urgency: c.data.urgency,
            remarks: c.data.remarks,
            contact: c.data.contact
        };

        c.server.get(inputData).then(function(response) {
            if (!handleServerResponse(response, function(data) {
                if (data.ticketNumber) {
                    c.ticket_number = data.ticketNumber;
                    c.ticket_sys_id = data.newRecordID || c.ticket_sys_id;
                }

                if (c.fileData && c.ticket_sys_id) {
                    uploadFile(c.ticket_sys_id);
                } else {
                    finishSubmit(c.ticket_sys_id);
                }
            })) {
                c.submitting = false;
            }
        }).catch(function() {
            c.submitting = false;
            showError('é€ä¿¡å¤±æ•—');
        });
    };

    function uploadFile(sysId) {
        c.server.get({
            action: 'upload_attachment',
            sys_id: sysId,
            table: 'x_1821654_kokoro_0_silent_wish',
            file_name: c.files.name,
            file_data: c.fileData,
            content_type: c.files.type
        }).then(function() {
            finishSubmit(sysId);
        }).catch(function() {
            showError('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—');
            finishSubmit(sysId);
        });
    }

    function finishSubmit(sysId) {
        c.submitting = false;
        c.is_editing = false;
        c.step = 5;
        c.current_state_val = CONFIG.states.SUBMITTED;
        c.status_message = c.statusDetails[CONFIG.states.SUBMITTED].desc;
        
        var slime = document.getElementById('the-slime');
        if (slime) slime.classList.add('happy-slime');
        
        if (sysId) initRecordWatcher(sysId);
        
        showSuccess('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼');
    }

    // ==========================================
    // æ–‡ä»¶ä¸Šä¼ 
    // ==========================================
    c.uploadFiles = function(files) {
        if (!files || !files.length) return;
        
        var file = files[0];
        var allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (allowedTypes.indexOf(file.type) === -1) {
            showError('JPEGã€PNGã€GIFã€WebPå½¢å¼ã®ç”»åƒã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™');
            return;
        }
        
        var maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            showError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
            return;
        }
        
        c.files = file;
        var reader = new FileReader();
        
        reader.onload = function(e) {
            $scope.$apply(function() {
                c.fileData = e.target.result;
            });
        };
        
        reader.readAsDataURL(file);
    };

    c.clearFile = function() {
        c.files = null;
        c.fileData = null;
        var input = document.querySelector('input[type="file"]');
        if (input) input.value = '';
    };

    // ==========================================
    // å®æ—¶ç›‘å¬
    // ==========================================
    function initRecordWatcher(sysId) {
        spUtil.recordWatch($scope, 'x_1821654_kokoro_0_silent_wish', "sys_id=" + sysId, function(name, data) {
            if (!data || !data.record) return;
            
            $timeout(function() {
                if (data.record.state) {
                    var stateVal = parseInt(data.record.state.value);
                    c.current_state_val = stateVal;
                    
                    if (c.statusDetails[stateVal]) {
                        c.status_message = c.statusDetails[stateVal].desc;
                    }
                }

                if (data.record.assigned_to) {
                    c.assigned_to = data.record.assigned_to.display_value;
                }
            });
        });
    }

    // ==========================================
    // é‡ç½®
    // ==========================================
    c.reset = function() {
        c.step = 0;
        c.data.category = "";
        c.data.remarks = "";
        c.data.quantity = "";
        c.data.urgency = "";
        c.data.detail_loc = "";
        c.data.location = "";
        c.data.affected_count = "";
        c.is_editing = false;
        c.ticket_number = "";
        c.assigned_to = null;
        c.ticket_sys_id = null;
        c.files = null;
        c.fileData = null;
        c.show_will_input = false;
        c.digital_will = "";
        c.current_state_val = 0;
        c.status_message = "å¾…æ©Ÿä¸­...";
        
        var slime = document.getElementById('the-slime');
        if (slime) slime.classList.remove('happy-slime');
    };

    // ==========================================
    // è®¾ç½®é¢æ¿
    // ==========================================
    c.toggleSettings = function() {
        c.showSettings = !c.showSettings;
        
        if (c.showSettings) {
            c.temp_settings = {
                email: c.data.emergency_email || "",
                medical_info: c.data.medical_info || "",
                blood_type: c.data.blood_type || "",
                will: c.data.saved_will || ""
            };
        }
    };

    c.saveSettings = function() {
        if (!c.temp_settings.email || c.temp_settings.email.trim() === '') {
            showError('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(c.temp_settings.email)) {
            showError('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        c.saving = true;
        
        c.server.get({
            action: 'save_settings',
            email: c.temp_settings.email,
            medical_info: c.temp_settings.medical_info,
            blood_type: c.temp_settings.blood_type,
            will: c.temp_settings.will
        }).then(function(response) {
            c.saving = false;
            
            if (handleServerResponse(response, function() {
                c.data.emergency_email = c.temp_settings.email;
                c.data.medical_info = c.temp_settings.medical_info;
                c.data.blood_type = c.temp_settings.blood_type;
                c.data.saved_will = c.temp_settings.will;
                
                c.showSettings = false;
                showSuccess('å®‰å…¨è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            }));
        }).catch(function() {
            c.saving = false;
            showError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    };

    // ==========================================
    // æ¸…ç†
    // ==========================================
    $scope.$on('$destroy', function() {
        $window.removeEventListener('mousemove', handleMouseMove);
        if (eyeAnimationFrame) {
            cancelAnimationFrame(eyeAnimationFrame);
        }
    });
};]]></client_script>
        <controller_as>c</controller_as>
        <css>@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&amp;family=M+PLUS+Rounded+1c:wght@400;500;700;800&amp;display=swap');

/* ============================================================
   KOKORO USER - Widget CSS (Refugee Mode)
   Version: 3.4 (Heartbeat &amp; Texture Fix)
   ä¿®å¤æ—¥å¿—:
   1. å²è±å§†åˆå§‹çŠ¶æ€æ”¹ä¸ºç°è‰²è´¨æ„Ÿï¼ˆæ¨¡ä»¿è¿ªå£«å°¼åæ‰çš„å¿ƒï¼‰ã€‚
   2. é¼ æ ‡æ‚¬åœæ—¶æ¢å¤åŸæœ‰çš„ç²‰è‰²å²è±å§†ã€‚
   3. è°ƒæ•´äº†â€œæˆ³ä¸€æˆ³â€åçš„é¢œè‰²åé¦ˆï¼Œå‡å°‘æ³›ç™½ï¼Œå¢åŠ ä¸€ç‚¹ç‚¹æ·±ç²‰è‰²ã€‚
   4. å°†â€œå¼€å¿ƒâ€çŠ¶æ€çš„è·³è·ƒåŠ¨ç”»æ”¹ä¸ºè½»æŸ”çš„å¿ƒè·³å¾‹åŠ¨ã€‚
   ============================================================ */

/* ==========================================
   1. å¼ºåˆ¶éšè—ServiceNowæ‰€æœ‰å…ƒç´  (ä¿æŒä¸å˜)
   ========================================== */
html body nav.navbar,
html body .navbar,
html body .navbar-inverse,
html body .navbar-default,
html body .navbar-header,
html body .sp-page-header,
html body header,
html body footer,
html body .sp-footer,
html body .footer,
html body .row.marketing-header,
html body #survey_plugin_container,
html body .navpage-header,
html body .navpage-header-content,
html body .sn-widget-textblock-body,
html body .breadcrumb-container,
html body [role="banner"],
html body .navbar-fixed-top,
html body .sp-row-background,
html body #gsft_main ~ header,
html body .polaris-navigation,
body &gt; nav,
body &gt; header,
body &gt; footer,
#gsft_main &gt; nav,
.sp-page-root &gt; nav,
.sp-page-root &gt; header {
  display: none !important;
  visibility: hidden !important;
  height: 0 !important;
  min-height: 0 !important;
  max-height: 0 !important;
  overflow: hidden !important;
  opacity: 0 !important;
  pointer-events: none !important;
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
  position: absolute !important;
  top: -9999px !important;
  left: -9999px !important;
}

html body,
html body .sp-page-root,
html body #sp-nav-bar {
  padding-top: 0 !important;
  margin-top: 0 !important;
}

/* ==========================================
   2. ä¸»å®¹å™¨ - èƒŒæ™¯ (ä¿æŒä¸å˜)
   ========================================== */
.kokoro-user-container {
  font-family: "M PLUS Rounded 1c", sans-serif;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 999999 !important;
  overflow: hidden;
  background: linear-gradient(180deg, #ffe4e1 0%, #fff0f0 40%, #fdf8f8 100%) !important;
}

/* ==========================================
   3. å²è±å§†èˆå° (ä¿æŒä¸å˜)
   ========================================== */
.slime-stage {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  pointer-events: none;
  z-index: 1;
}

/* ==========================================
   4. å²è±å§† - é¢œè‰²ä¸åŠ¨ç”» (ä¿®æ”¹åŒºåŸŸ)
   ========================================== */
.kokoro-slime {
  width: 260px; /* ä½¿ç”¨ä½ æä¾›çš„å®½åº¦ */
  height: 240px; /* ä½¿ç”¨ä½ æä¾›çš„é«˜åº¦ */
  
/* [ä¿®æ”¹ç‚¹] åŠ é‡äº†è¤è‰²è°ƒï¼Œå‡å°‘äº†æ³›ç™½ï¼Œå‘ˆç°å‡ºâ€œåšæ—§/è¤è‰²ç°â€çš„è´¨æ„Ÿ */
  background: radial-gradient(circle at 30% 30%, #f5f0ef 0%, #d6c4bf 50%, #9e8982 100%);
  
  /* [ä¿®æ”¹ç‚¹] é˜´å½±ä¹ŸåŒæ­¥åŠ æ·±ä¸ºæš–è¤è‰²ï¼Œå¢åŠ ä½“ç§¯æ„Ÿ */
  box-shadow: 
    0 20px 50px rgba(120, 100, 95, 0.4),
    inset 5px 5px 30px rgba(255, 255, 255, 0.6);
    
  border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
  animation: slimeMorph 8s ease-in-out infinite;
  
  position: relative;
  margin-bottom: 280px;
  transform-origin: center bottom;
  cursor: pointer;
  pointer-events: auto !important;
  z-index: 100;
  
  transition: all 0.5s ease;
}
  
  /* é¢œè‰²è¿‡æ¸¡ */
  transition: all 0.5s ease;
}

/* çœ¼ç› */
.slime-eyes {
  position: absolute;
  top: 40%;
  left: 50%;
  margin-left: -35px; /* ä½¿ç”¨ä½ æä¾›çš„åç§» */
  width: 70px; /* ä½¿ç”¨ä½ æä¾›çš„å®½åº¦ */
  height: 15px; /* ä½¿ç”¨ä½ æä¾›çš„é«˜åº¦ */
  transition: transform 0.15s ease-out;
}

.slime-eyes::before,
.slime-eyes::after {
  content: '';
  position: absolute;
  top: 0;
  width: 14px; /* ä½¿ç”¨ä½ æä¾›çš„å°ºå¯¸ */
  height: 14px; /* ä½¿ç”¨ä½ æä¾›çš„å°ºå¯¸ */
  background: #5d4037;
  border-radius: 50%;
  animation: blink 4s infinite;
}

.slime-eyes::before { left: 0; }
.slime-eyes::after { right: 0; }

/* éšè—å˜´å·´ (æ ¹æ®ä½ æä¾›çš„ä»£ç ) */
.slime-mouth { display: none !important; }

/* äº¤äº’çŠ¶æ€ï¼šHover (æ¢å¤ç²‰è‰²) */
.kokoro-slime:hover {
  /* æ¢å¤åŸæœ¬çš„ç²‰è‰²æ¸å˜ (æ ¹æ®ä½ æä¾›çš„ä»£ç ) */
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), #ff9a9e);
  
  /* æ¢å¤åŸæœ¬çš„é²œäº®é˜´å½± (æ ¹æ®ä½ æä¾›çš„ä»£ç ) */
  box-shadow: 
    0 15px 50px rgba(255, 150, 150, 0.4),
    inset 5px 5px 30px rgba(255, 255, 255, 0.8);
    
  filter: saturate(1.1);
  transform: scale(1.02);
}

/* äº¤äº’çŠ¶æ€ï¼šè¢«æˆ³ä¸­ (Poked) */
.kokoro-slime.poked {
  animation: gentleHeartbeat 0.6s ease-in-out forwards !important;
  
  /* ç¡®ä¿è¢«æˆ³ä¸­æ—¶ä¹Ÿæ˜¯ç²‰è‰² */
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), #ff9a9e);
  box-shadow: 
    0 15px 50px rgba(255, 150, 150, 0.4),
    inset 5px 5px 30px rgba(255, 255, 255, 0.8);

  /* ç¨å¾®åŠ æ·±ç²‰è‰²ï¼Œé¿å…æ³›ç™½ */
  filter: saturate(1.35) contrast(1.05);
}

/* çŠ¶æ€ï¼šé¥¥é¥¿/ä¼‘çœ  (ä¿æŒç°è¤è‰²è´¨æ„Ÿ) */
.kokoro-slime.hungry-slime {
  /* ä½¿ç”¨å¸¦æœ‰è¤è‰²/æ£•è‰²è°ƒçš„æµ…ç°è¤è‰² */
  background: radial-gradient(circle at 30% 30%, #f8f6f4 0%, #e8e0da 50%, #c8b8b0 100%);
  box-shadow: 0 20px 50px rgba(160, 140, 130, 0.35), inset 5px 5px 30px rgba(255, 255, 255, 0.7);
  
  filter: saturate(0.4) brightness(0.95);
  transform: scale(0.9);
  animation: slimeMorph 10s ease-in-out infinite;
}

/* çŠ¶æ€ï¼šå¼€å¿ƒ (æäº¤å) */
.kokoro-slime.happy-slime {
  /* å¼€å¿ƒæ—¶å˜ä¸ºç²‰è‰² */
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), #ff9a9e);
  box-shadow: 0 15px 50px rgba(255, 150, 150, 0.4), inset 5px 5px 30px rgba(255, 255, 255, 0.8);
  
  /* å¿ƒè·³åŠ¨ç”» */
  animation: happyJump 1.5s ease-in-out infinite;
  filter: saturate(1.2) brightness(1.05);
}

/* ==========================================
   5. åŠ¨ç”»å…³é”®å¸§ (ä¿æŒä¸å˜ï¼Œä½¿ç”¨æ–°çš„happyJump)
   ========================================== */
@keyframes slimeMorph {
  0%, 100% {
    border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
    transform: translate(0, 0) scale(1);
  }
  33% {
    border-radius: 50% 60% 40% 70% / 50% 60% 40% 60%;
    transform: translate(8px, -5px) scale(1.02, 0.98);
  }
  66% {
    border-radius: 70% 40% 60% 30% / 70% 40% 60% 30%;
    transform: translate(-8px, 5px) scale(0.98, 1.02);
  }
}

@keyframes gentleHeartbeat {
  0% { transform: scale(1); }
  15% { transform: scale(1.08); }
  30% { transform: scale(1); }
  45% { transform: scale(1.08); }
  60% { transform: scale(1); }
  100% { transform: scale(1); }
}

@keyframes happyJump {
  0%, 100% { 
    transform: scale(1); 
  }
  50% { 
    transform: scale(1.06); 
  }
}

@keyframes blink {
  0%, 96%, 100% { transform: scaleY(1); }
  98% { transform: scaleY(0.1); }
}

@keyframes popIn {
  from { opacity: 0; transform: scale(0.5); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(0.9); }
}

/* ==========================================
   6. UIç»„ä»¶ (ä¿æŒåŸå¸ƒå±€ï¼Œé€‚é…æ–°é…è‰²) - ä»¥ä¸‹éƒ¨åˆ†å‡æ— ä¿®æ”¹
   ========================================== */

/* è®¾ç½®æŒ‰é’® */
.safety-settings-btn {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(4px);
  padding: 10px 16px;
  border-radius: 22px;
  border: 1px solid rgba(255, 255, 255, 0.9);
  color: #5d4037;
  font-weight: 700;
  font-size: 0.9rem;
  cursor: pointer;
  z-index: 200;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.safety-settings-btn:hover {
  background: #fff;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.safety-settings-btn i { color: #ec407a; }

/* ç®¡ç†è€…åˆ‡æ¢æŒ‰é’® */
.admin-switch {
  position: absolute;
  top: 20px;
  right: 20px;
  opacity: 0.5;
  cursor: pointer;
  font-size: 2rem;
  z-index: 200;
  color: #5d4037;
  transition: all 0.2s ease;
}

.admin-switch:hover { opacity: 1; }

/* æç¤ºæ–‡å­— */
.pulse-overlay {
  position: absolute;
  top: 15%;
  width: 100%;
  text-align: center;
  z-index: 5;
  animation: fadeIn 1.5s ease;
  pointer-events: none;
}

.pulse-title {
  font-size: 2.2rem;
  color: #5d4037;
  font-weight: 800;
  text-shadow: 0 4px 15px rgba(255, 255, 255, 0.9);
  letter-spacing: 2px;
}

.sub-text {
  font-size: 0.9rem;
  opacity: 0.7;
  font-weight: 600;
}

/* è¡¨å•å®¹å™¨ */
.form-stage {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10;
  overflow-y: auto;
  scroll-behavior: smooth;
  padding: 80px 20px 60px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.floating-header {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(12px);
  padding: 22px 28px;
  border-radius: 26px;
  margin-bottom: 24px;
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
  z-index: 5;
}

.form-title {
  font-size: 1.5rem;
  color: #ec407a;
  margin: 0 0 16px 0;
  text-align: center;
  font-weight: 800;
}

/* è¿›åº¦æŒ‡ç¤ºå™¨ */
.progress-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.progress-step {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #eceff1;
  color: #90a4ae;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.progress-step.active {
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  color: white;
  transform: scale(1.15);
  box-shadow: 0 6px 18px rgba(233, 30, 99, 0.4);
}

.progress-line {
  width: 40px;
  height: 5px;
  background: #eceff1;
  border-radius: 3px;
  transition: all 0.3s ease;
}

.progress-line.active {
  background: linear-gradient(90deg, #ec407a, #f48fb1);
}

/* è¡¨å•åŒ…è£… */
.form-wrapper {
  width: 100%;
  max-width: 520px;
}

.step-card {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(12px);
  border-radius: 30px;
  padding: 26px;
  margin-bottom: 22px;
  box-shadow: 0 10px 40px -10px rgba(255, 180, 180, 0.3);
  border: 2px solid rgba(255, 255, 255, 0.8);
  animation: slideUp 0.4s ease;
}

.big-label {
  display: block;
  font-size: 1.15rem;
  font-weight: 800;
  color: #4e342e;
  margin-bottom: 12px;
  margin-left: 4px;
}

.input-wrapper {
  position: relative;
  width: 100%;
}

.input-wrapper i.select-arrow {
  position: absolute;
  right: 22px;
  top: 50%;
  transform: translateY(-50%);
  color: #ff80ab;
  pointer-events: none;
  font-size: 1.2rem;
}

.big-input {
  width: 100%;
  height: 64px;
  background: #fff;
  border: 3px solid #fce4ec;
  border-radius: 32px;
  font-size: 1.15rem;
  font-weight: 500;
  color: #333;
  padding: 0 26px;
  outline: none;
  transition: all 0.25s ease;
  box-sizing: border-box;
  font-family: inherit;
}

.big-input:focus {
  border-color: #ff80ab;
  box-shadow: 0 0 0 5px rgba(255, 128, 171, 0.15);
}

select.big-input {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  padding-right: 55px;
  cursor: pointer;
}

.glass-textarea {
  width: 100%;
  min-height: 110px;
  background: #fff;
  border: 3px solid #fce4ec;
  border-radius: 22px;
  padding: 18px;
  font-size: 1.05rem;
  font-weight: 500;
  color: #333;
  outline: none;
  resize: vertical;
  font-family: inherit;
  transition: all 0.25s ease;
  box-sizing: border-box;
}

.glass-textarea:focus {
  border-color: #ff80ab;
  box-shadow: 0 0 0 5px rgba(255, 128, 171, 0.15);
}

.action-row {
  display: flex;
  gap: 16px;
  margin-top: 18px;
}

.flex-row {
  display: flex;
  gap: 16px;
  margin-bottom: 18px;
}

.half-col { flex: 1; }
.mb-3 { margin-bottom: 22px; }

.critical-bg {
  background-color: #ffebee !important;
  color: #c62828 !important;
  border-color: #ffcdd2 !important;
}

/* é™„ä»¶æŒ‰é’® */
.big-attach-btn {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: #fff;
  border: 3px solid #ff80ab;
  color: #ff80ab;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.25s ease;
  flex-shrink: 0;
}

.big-attach-btn:hover {
  background: #ff80ab;
  color: white;
  transform: scale(1.08);
}

/* æäº¤æŒ‰é’® */
.big-submit-btn {
  flex: 1;
  height: 64px;
  border-radius: 32px;
  background: linear-gradient(135deg, #ff80ab, #f8bbd0);
  color: #fff;
  font-size: 1.25rem;
  font-weight: 800;
  border: none;
  box-shadow: 0 12px 36px rgba(255, 150, 150, 0.35);
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  transition: all 0.25s ease;
  font-family: inherit;
}

.big-submit-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 16px 44px rgba(255, 150, 150, 0.45);
}

/* æˆåŠŸå¡ç‰‡ */
.success-card {
  width: 100%;
  max-width: 520px;
  background: rgba(255, 255, 255, 0.96);
  border-radius: 34px;
  padding: 32px;
  text-align: center;
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.1);
  border: 3px solid #fce4ec;
}

.success-title {
  font-size: 1.6rem;
  color: #ec407a;
  font-weight: 800;
  margin-bottom: 6px;
}

.ticket-id {
  font-family: 'Orbitron', monospace;
  color: #90a4ae;
  margin-bottom: 22px;
  font-weight: 600;
  font-size: 1rem;
}

/* çŠ¶æ€è¿½è¸ªå™¨ */
.status-tracker {
  display: flex;
  justify-content: space-between;
  margin: 26px 0;
  padding: 0 10px;
}

.status-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  opacity: 0.3;
  transition: all 0.35s ease;
}

.status-step .icon { font-size: 2rem; margin-bottom: 8px; }
.status-step .text { font-size: 0.75rem; font-weight: 800; }
.status-step.active { opacity: 1; transform: scale(1.12); }
.status-step.active .text { color: #d81b60; }

.status-tracker .line {
  flex-grow: 1;
  height: 5px;
  background: #eee;
  margin: 18px 8px 0;
  border-radius: 3px;
  transition: all 0.35s ease;
}

.status-tracker .line.active {
  background: linear-gradient(90deg, #ff9a9e, #f48fb1);
}

/* æ‘˜è¦å¡ç‰‡ */
.summary-card {
  background: #fafafa;
  border-radius: 22px;
  padding: 22px;
  text-align: left;
  margin-bottom: 22px;
}

.summary-card .row-item {
  margin-bottom: 12px;
  color: #37474f;
  font-size: 1rem;
  font-weight: 500;
  border-bottom: 1px dashed #e0e0e0;
  padding-bottom: 12px;
}

.summary-card .row-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.summary-card strong {
  font-weight: 800;
  margin-right: 8px;
  color: #5d4037;
}

.summary-card .badge {
  background: #e3f2fd;
  color: #1e88e5;
  padding: 4px 12px;
  border-radius: 10px;
  font-size: 0.9rem;
  font-weight: 700;
}

.summary-card .text-crit {
  color: #c62828;
  font-weight: 800;
}

/* å®æ—¶çŠ¶æ€ */
.live-status-pill {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  background: #e0f7fa;
  color: #006064;
  height: 60px;
  border-radius: 30px;
  font-weight: 800;
  font-size: 1.05rem;
  margin-bottom: 22px;
}

.pulse-dot {
  width: 12px;
  height: 12px;
  background: #00bcd4;
  border-radius: 50%;
  animation: pulse 1.5s infinite;
}

/* è¯¦æƒ…å¡ç‰‡ */
.status-detail-card {
  background: linear-gradient(135deg, #7c4dff 0%, #b388ff 100%);
  color: white;
  padding: 22px;
  border-radius: 22px;
  margin: 22px 0;
  text-align: center;
}

.status-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 10px;
}

.status-icon { font-size: 2.2rem; }

.status-detail-card .status-title {
  font-size: 1.4rem;
  font-weight: 800;
  margin: 0;
}

.status-desc {
  font-size: 1rem;
  opacity: 0.92;
  margin: 12px 0;
}

.status-next {
  font-size: 0.9rem;
  opacity: 0.8;
  font-style: italic;
}

/* æŒ‰é’®ç»„ */
.btn-group {
  display: flex;
  gap: 16px;
  justify-content: center;
}

.edit-btn, .big-reset-btn {
  flex: 1;
  height: 58px;
  border-radius: 29px;
  border: none;
  font-weight: 800;
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.25s ease;
  font-family: inherit;
}

.edit-btn {
  background: #fff;
  border: 2px solid #ff80ab;
  color: #ff80ab;
}

.edit-btn:hover {
  background: #ff80ab;
  color: white;
}

.big-reset-btn {
  background: #eceff1;
  color: #546e7a;
}

.big-reset-btn:hover {
  background: #cfd8dc;
}

/* é—è¨€è¦†ç›–å±‚ */
.will-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 240, 245, 0.85);
  backdrop-filter: blur(10px);
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.will-card {
  width: 92%;
  max-width: 420px;
  background: rgba(255, 255, 255, 0.98);
  border: 2px solid #f8bbd9;
  border-radius: 30px;
  padding: 30px 26px;
  text-align: center;
  box-shadow: 0 24px 70px rgba(248, 187, 217, 0.4);
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.will-title {
  font-size: 1.4rem;
  color: #ec407a;
  font-weight: 800;
  margin-bottom: 10px;
}

.will-desc {
  font-size: 0.95rem;
  color: #5d4037;
  margin-bottom: 22px;
  line-height: 1.7;
}

.will-textarea {
  width: 100%;
  height: 110px;
  border: 2px solid #f8bbd0;
  border-radius: 18px;
  padding: 16px;
  font-size: 1.05rem;
  color: #333;
  outline: none;
  resize: none;
  background: #fff;
  font-family: inherit;
  transition: all 0.25s ease;
  box-sizing: border-box;
}

.will-textarea:focus {
  border-color: #ec407a;
  background: #fff9fb;
}

.will-actions {
  display: flex;
  gap: 14px;
  margin-top: 22px;
}

.btn-will-skip, .btn-will-save {
  flex: 1;
  padding: 16px;
  border-radius: 24px;
  border: none;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.25s ease;
  font-family: inherit;
}

.btn-will-skip {
  background: #f5f5f5;
  color: #757575;
}

.btn-will-skip:hover {
  background: #e0e0e0;
}

.btn-will-save {
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  color: white;
  box-shadow: 0 8px 22px rgba(233, 30, 99, 0.35);
}

.btn-will-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 28px rgba(233, 30, 99, 0.45);
}

/* è®¾ç½®è¦†ç›–å±‚ */
.settings-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(93, 64, 55, 0.45);
  backdrop-filter: blur(6px);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.settings-card {
  width: 92%;
  max-width: 500px;
  background: #fff;
  border-radius: 26px;
  padding: 30px;
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease;
  max-height: 88vh;
  overflow-y: auto;
}

.settings-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 22px;
  padding-bottom: 18px;
  border-bottom: 2px solid #fce4ec;
}

.settings-card .card-header h3 {
  margin: 0;
  color: #ec407a;
  font-weight: 800;
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  gap: 12px;
}

.settings-card .close-btn {
  font-size: 1.8rem;
  color: #999;
  cursor: pointer;
  transition: all 0.2s ease;
  line-height: 1;
  padding: 4px;
  border: none;
  background: none;
}

.settings-card .close-btn:hover {
  color: #ec407a;
  transform: scale(1.1);
}

.settings-desc {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 26px;
  line-height: 1.7;
  background: #fff5f8;
  padding: 16px 18px;
  border-radius: 14px;
  border-left: 4px solid #ec407a;
}

.input-group {
  margin-bottom: 22px;
  text-align: left;
}

.input-group label {
  display: block;
  font-weight: 700;
  color: #5d4037;
  margin-bottom: 10px;
  font-size: 1rem;
}

.glass-input {
  width: 100%;
  background: #fff;
  border: 2px solid #e0e0e0;
  border-radius: 14px;
  padding: 16px 18px;
  font-size: 1.05rem;
  color: #333;
  outline: none;
  font-family: inherit;
  transition: all 0.2s ease;
  box-sizing: border-box;
}

.glass-input:focus {
  border-color: #ec407a;
  box-shadow: 0 0 0 4px rgba(236, 64, 122, 0.12);
}

select.glass-input {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ec407a' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 18px;
  padding-right: 44px;
}

textarea.glass-input {
  min-height: 90px;
  resize: vertical;
}

.save-settings-btn {
  width: 100%;
  height: 56px;
  margin-top: 10px;
  background: linear-gradient(135deg, #ec407a, #c2185b);
  color: white;
  border: none;
  border-radius: 28px;
  font-size: 1.1rem;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 10px 28px rgba(233, 30, 99, 0.35);
  transition: all 0.2s ease;
  font-family: inherit;
}

.save-settings-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 34px rgba(233, 30, 99, 0.45);
}

/* åŠ è½½è¦†ç›–å±‚ */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.92);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(6px);
}

.loading-content {
  text-align: center;
  color: #ff80ab;
}

.loading-content p {
  margin-top: 18px;
  font-size: 1.5rem;
  font-weight: 700;
  color: #333;
}

.loading-content small {
  color: #666;
  font-size: 0.95rem;
}

/* å“åº”å¼ */
@media (max-width: 480px) {
  .pulse-title { font-size: 1.8rem; }
  .kokoro-slime { width: 220px; height: 200px; margin-bottom: 250px; }
  .form-stage { padding: 60px 16px 40px 16px; }
  .step-card { padding: 20px; }
  .big-input { height: 56px; font-size: 1rem; }
  .big-submit-btn { height: 56px; font-size: 1.1rem; }
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>kokoro_user</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Kokoro User</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
    // ============================================================
    // KOKORO SHELTER - Server Script (Shared)
    // Version: 3.0 (Split Version)
    // ç”¨äº: kokoro_user å’Œ kokoro_volunteer ä¸¤ä¸ªWidget
    // ============================================================

    var CONFIG = {
        tables: {
            SILENT_WISH: 'x_1821654_kokoro_0_silent_wish',
            USER_PROFILE: 'x_1821654_kokoro_0_x_kokoro_user_profile',
            HEARTBEAT: 'x_1821654_kokoro_0_x_1821654_kokoro_0_heartbeat',
            EMERGENCY_MESSAGE: 'x_1821654_kokoro_0_emergency_message',
            PROCESS_EVENT: 'x_1821654_kokoro_0_process_event'
        },
        wishStates: {
            DRAFT: '1',
            SUBMITTED: '10',
            ASSIGNED: '11',
            IN_PROGRESS: '2',
            COMPLETED: '4',
            CANCELLED: '5',
            ON_HOLD: '6'
        },
        slaTargets: {
            'Critical': 30,
            'High': 60,
            'Medium': 120,
            'Low': 240
        }
    };

    data.user_id = gs.getUserID();
    data.user_name = gs.getUserDisplayName();
    
    var isVolunteer = gs.hasRole('admin') || gs.hasRole('x_1821654_kokoro_0.volunteer');
    data.is_volunteer = isVolunteer;

    data.emergency_email = "";
    data.medical_info = "";
    data.blood_type = "";
    data.saved_will = "";
    data.list = [];
    data.myTasks = [];
    data.volunteers = [];
    data.openCount = 0;
    data.sosCount = 0;

    // ==========================================
    // å·¥å…·å‡½æ•°
    // ==========================================
    function sanitizeInput(inputVal, maxLength) {
        if (!inputVal) return '';
        var cleaned = String(inputVal)
            .replace(/[<>\"'&]/g, '')
            .replace(/[\r\n]+/g, ' ')
            .trim();
        if (maxLength && cleaned.length > maxLength) {
            cleaned = cleaned.substring(0, maxLength);
        }
        return cleaned;
    }

    function validateSysId(sysId) {
        if (!sysId) return false;
        return /^[a-f0-9]{32}$/.test(String(sysId));
    }

    function logProcessEvent(caseId, activity, userId) {
        try {
            var pe = new GlideRecord(CONFIG.tables.PROCESS_EVENT);
            pe.initialize();
            pe.setValue('case_id', caseId || '');
            pe.setValue('activity', sanitizeInput(activity, 200));
            pe.setValue('timestamp', new GlideDateTime());
            pe.setValue('user', userId || gs.getUserID());
            pe.insert();
        } catch (e) {
            gs.error('[Kokoro] Process event log error: ' + e.message);
        }
    }

    // ==========================================
    // çŠ¶æ€éªŒè¯å™¨
    // ==========================================
    var StateValidator = {
        allowedTransitions: {
            '1':  ['10', '11', '5'],
            '10': ['1', '11', '5'],
            '11': ['10', '2', '5', '6'],
            '2':  ['4', '5', '6'],
            '4':  [],
            '5':  [],
            '6':  ['11', '2', '5']
        },
        
        validateTransition: function(fromState, toState) {
            fromState = String(fromState);
            toState = String(toState);
            
            if (!fromState || fromState === '' || fromState === 'undefined' || fromState === 'null') {
                return { valid: true };
            }
            
            if (!this.allowedTransitions.hasOwnProperty(fromState)) {
                return { valid: false, message: 'ç„¡åŠ¹ãªç¾åœ¨çŠ¶æ…‹: ' + fromState };
            }
            
            var allowed = this.allowedTransitions[fromState];
            if (allowed.indexOf(toState) === -1) {
                return { 
                    valid: false, 
                    message: fromState + ' ã‹ã‚‰ ' + toState + ' ã¸ã®é·ç§»ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“' 
                };
            }
            
            return { valid: true };
        }
    };

    // ==========================================
    // åŠ è½½ç”¨æˆ·èµ„æ–™
    // ==========================================
    function loadUserProfile() {
        try {
            var grProfile = new GlideRecord(CONFIG.tables.USER_PROFILE);
            grProfile.addQuery('user', data.user_id);
            grProfile.setLimit(1);
            grProfile.query();

            if (grProfile.next()) {
                data.emergency_email = grProfile.getValue('emergency_conact_email') || "";
                data.medical_info = grProfile.getValue('medical_conditions') || "";
                data.blood_type = grProfile.getValue('blood_type') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Profile load error: " + e.message);
        }
    }

    function loadDigitalWill() {
        try {
            var grWill = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
            grWill.addQuery('user', data.user_id);
            grWill.addQuery('is_active', true);
            grWill.addQuery('message_type', 'Last_Will');
            grWill.orderByDesc('sys_created_on');
            grWill.setLimit(1);
            grWill.query();

            if (grWill.next()) {
                data.saved_will = grWill.getValue('message_encrypted') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Will load error: " + e.message);
        }
    }

    loadUserProfile();
    loadDigitalWill();

    // ==========================================
    // æ„å»ºä»»åŠ¡é¡¹
    // ==========================================
    function buildTaskItem(gr) {
        var taskItem = {
            sys_id: gr.getUniqueValue(),
            number: gr.getValue('number') || '',
            category: gr.getValue('u_category') || '',
            category_display: gr.getDisplayValue('u_category') || 'æœªåˆ†é¡',
            zone: gr.getDisplayValue('shelter_zone') || '',
            detail_loc: gr.getValue('detail_loc') || gr.getValue('wish_content') || '',
            desc: gr.getValue('u_remarks') || '',
            urgency: gr.getValue('u_urgency') || 'Medium',
            contact: gr.getValue('u_contact_info') || '',
            reporter_name: gr.getDisplayValue('opened_by') || 'ã‚²ã‚¹ãƒˆ',
            assigned_to_name: gr.getDisplayValue('assigned_to') || '',
            assigned_to_id: gr.getValue('assigned_to') || '',
            state: parseInt(gr.getValue('state')) || 10,
            state_label: gr.getDisplayValue('state') || '',
            quantity: parseInt(gr.getValue('u_quantity')) || 1,
            location: gr.getValue('shelter_zone') || '',
            remarks: gr.getValue('u_remarks') || '',
            affected_count: gr.getValue('u_affected_count') || 'ä¸æ˜',
            history: [],
            attachments: []
        };

        // æ—¶é—´è®¡ç®—
        var created = new GlideDateTime(gr.sys_created_on);
        var now = new GlideDateTime();
        var diffMs = GlideDateTime.subtract(now, created).getNumericValue();
        var minutes = Math.floor(diffMs / 1000 / 60);

        if (minutes < 60) {
            taskItem.time_ago = minutes + "åˆ†å‰";
        } else if (minutes < 1440) {
            taskItem.time_ago = Math.floor(minutes / 60) + "æ™‚é–“å‰";
        } else {
            taskItem.time_ago = Math.floor(minutes / 1440) + "æ—¥å‰";
        }

        taskItem.created_on = gr.getDisplayValue('sys_created_on');

        // SLAè®¡ç®—
        var slaTarget = CONFIG.slaTargets[taskItem.urgency] || 180;
        var slaPercentage = Math.min((minutes / slaTarget) * 100, 100);
        var remainingMinutes = slaTarget - minutes;

        taskItem.sla = {
            elapsed: Math.floor(minutes),
            target: slaTarget,
            percentage: Math.round(slaPercentage),
            remaining: Math.floor(remainingMinutes),
            status: slaPercentage > 100 ? 'critical' : (slaPercentage > 80 ? 'warning' : 'ok')
        };

        // é™„ä»¶
        try {
            var att = new GlideRecord('sys_attachment');
            att.addQuery('table_sys_id', taskItem.sys_id);
            att.setLimit(1);
            att.orderByDesc('sys_created_on');
            att.query();
            if (att.next()) {
                taskItem.image_url = '/' + att.sys_id + '.iix';
            }
        } catch (e) {}

        // æ´»åŠ¨å†å²
        try {
            var journal = new GlideRecord('sys_journal_field');
            journal.addQuery('element_id', taskItem.sys_id);
            journal.addQuery('element', 'work_notes');
            journal.orderByDesc('sys_created_on');
            journal.setLimit(10);
            journal.query();
            while (journal.next()) {
                taskItem.history.push({
                    user: journal.getDisplayValue('sys_created_by') || 'System',
                    text: journal.getValue('value') || '',
                    date: journal.getDisplayValue('sys_created_on')
                });
            }
        } catch (e) {}

        return taskItem;
    }

    // ==========================================
    // åŠ è½½å¿—æ„¿è€…åˆ—è¡¨
    // ==========================================
    function loadVolunteerList() {
        var volunteerList = [];
        try {
            var roleGr = new GlideRecord('sys_user_has_role');
            roleGr.addQuery('role.name', 'x_1821654_kokoro_0.volunteer');
            roleGr.query();
            var volIds = [];
            while (roleGr.next()) {
                volIds.push(roleGr.getValue('user'));
            }
            
            if (volIds.length > 0) {
                var userGr = new GlideRecord('sys_user');
                userGr.addQuery('sys_id', 'IN', volIds.join(','));
                userGr.addQuery('active', true);
                userGr.query();
                while (userGr.next()) {
                    volunteerList.push({
                        sys_id: userGr.getUniqueValue(),
                        name: userGr.getDisplayValue('name') || userGr.getValue('user_name')
                    });
                }
            }
            
            // æ·»åŠ ç®¡ç†å‘˜
            var adminGr = new GlideRecord('sys_user');
            adminGr.addQuery('active', true);
            adminGr.addQuery('roles', 'CONTAINS', 'admin');
            adminGr.setLimit(10);
            adminGr.query();
            while (adminGr.next()) {
                var alreadyExists = volunteerList.some(function(v) { 
                    return v.sys_id === adminGr.getUniqueValue(); 
                });
                if (!alreadyExists) {
                    volunteerList.push({
                        sys_id: adminGr.getUniqueValue(),
                        name: adminGr.getDisplayValue('name') || adminGr.getValue('user_name')
                    });
                }
            }
        } catch (e) {
            gs.error("[Kokoro] Load volunteer list error: " + e.message);
        }
        return volunteerList;
    }

    // ==========================================
    // å¤„ç†è¾“å…¥
    // ==========================================
    if (input) {

        if (input.action === 'get_volunteers') {
            data.volunteers = loadVolunteerList();
            data.success = true;
            return;
        }

        if (input.action === 'save_settings') {
            try {
                var successProfile = false;
                var successWill = true;

                var grUp = new GlideRecord(CONFIG.tables.USER_PROFILE);
                grUp.addQuery('user', data.user_id);
                grUp.query();

                if (grUp.next()) {
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.update() != null);
                } else {
                    grUp.initialize();
                    grUp.setValue('user', data.user_id);
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.insert() != null);
                }

                if (input.will && String(input.will).trim() !== '') {
                    var oldMsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldMsg.addQuery('user', data.user_id);
                    oldMsg.addQuery('is_active', true);
                    oldMsg.addQuery('message_type', 'Last_Will');
                    oldMsg.query();
                    while (oldMsg.next()) {
                        oldMsg.setValue('is_active', false);
                        oldMsg.update();
                    }

                    var emsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsg.initialize();
                    emsg.setValue('user', data.user_id);
                    emsg.setValue('message_encrypted', sanitizeInput(input.will, 4000));
                    emsg.setValue('message_type', 'Last_Will');
                    emsg.setValue('is_active', true);
                    emsg.setValue('created_at', new GlideDateTime());
                    successWill = (emsg.insert() != null);
                }

                if (successProfile && successWill) {
                    data.success = true;
                    logProcessEvent(data.user_id, 'User settings updated', data.user_id);
                } else {
                    data.error = "ä¿å­˜å¤±æ•—";
                }

            } catch (e) {
                gs.error("[Kokoro] Save error: " + e.message);
                data.error = "ä¿å­˜ã‚¨ãƒ©ãƒ¼";
            }
            return;
        }

        if (input.action === 'submit_record' || input.action === 'update_record') {
            if (!input.location || !input.category || !input.urgency) {
                data.error = "å¿…é ˆé …ç›®ãŒä¸è¶³";
                return;
            }

            try {
                var gr = new GlideRecord(CONFIG.tables.SILENT_WISH);

                if (input.action === 'update_record' && input.sys_id) {
                    if (!validateSysId(input.sys_id)) {
                        data.error = "ç„¡åŠ¹ãªID";
                        return;
                    }
                    if (!gr.get(input.sys_id)) {
                        data.error = "ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                        return;
                    }
                } else {
                    gr.initialize();
                    gr.setValue('opened_by', data.user_id);
                    gr.setValue('state', CONFIG.wishStates.SUBMITTED);
                }

                gr.setValue('shelter_zone', sanitizeInput(input.location, 100));
                gr.setValue('u_category', sanitizeInput(input.category, 50));
                gr.setValue('u_quantity', parseInt(input.quantity) || 1);
                gr.setValue('u_urgency', sanitizeInput(input.urgency, 20));
                gr.setValue('u_affected_count', sanitizeInput(input.affected_count, 10));
                gr.setValue('u_remarks', sanitizeInput(input.remarks, 1000));
                gr.setValue('u_contact_info', sanitizeInput(input.contact, 200));
                gr.setValue('detail_loc', sanitizeInput(input.detail_loc, 200));

                var fullDescription =
                    "ã€è©³ç´°å ´æ‰€ã€‘: " + sanitizeInput(input.detail_loc, 200) + "\n" +
                    "ã€æ”¯æ´ç¨®åˆ¥ã€‘: " + input.category + " x " + (input.quantity || 1) + "\n" +
                    "ã€ç·Šæ€¥åº¦ã€‘: " + input.urgency + "\n" +
                    "ã€å¯¾è±¡äººæ•°ã€‘: " + (input.affected_count || '1') + "\n" +
                    "ã€å‚™è€ƒã€‘: " + (input.remarks || 'ãªã—');

                gr.setValue('wish_content', fullDescription);

                if (input.action === 'submit_record') {
                    var sysId = gr.insert();
                    if (sysId) {
                        data.ticketNumber = gr.getValue('number');
                        data.newRecordID = sysId;
                        data.success = true;
                        logProcessEvent(sysId, 'Wish submitted: ' + input.category, data.user_id);
                    } else {
                        data.error = "ä½œæˆå¤±æ•—";
                    }
                } else {
                    if (gr.update()) {
                        data.ticketNumber = gr.getValue('number');
                        data.success = true;
                        logProcessEvent(input.sys_id, 'Wish updated', data.user_id);
                    } else {
                        data.error = "æ›´æ–°å¤±æ•—";
                    }
                }
            } catch (e) {
                gs.error("[Kokoro] Submit error: " + e.message);
                data.error = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            }
            return;
        }

        if (input.action === 'upload_attachment' && input.sys_id) {
            try {
                if (!validateSysId(input.sys_id)) {
                    data.error = "ç„¡åŠ¹ãªID";
                    return;
                }
                var attachment = new GlideSysAttachment();
                if (input.file_data) {
                    var cleanBase64 = input.file_data.split(',')[1] || input.file_data;
                    attachment.writeBase64(
                        input.table || CONFIG.tables.SILENT_WISH,
                        input.sys_id,
                        sanitizeInput(input.file_name, 100),
                        input.content_type,
                        cleanBase64
                    );
                    data.success = true;
                }
            } catch (e) {
                gs.error("[Kokoro] Attachment error: " + e.message);
            }
            return;
        }

        if (input.action === 'register_heartbeat') {
            try {
                var hb = new GlideRecord(CONFIG.tables.HEARTBEAT);
                hb.initialize();
                hb.setValue('u_user', data.user_id);
                hb.setValue('u_timestamp', new GlideDateTime());
                hb.setValue('u_status', 'Safe');

                var hbId = hb.insert();
                data.heartbeat_id = hbId;
                data.success = true;
                logProcessEvent(hbId, 'Heartbeat registered', data.user_id);
            } catch (e) {
                gs.error("[Kokoro] Heartbeat error: " + e.message);
                data.error = "å¿ƒè·³æ³¨å†Œå¤±è´¥";
            }
            return;
        }

        if (input.action === 'update_will') {
            try {
                if (input.message) {
                    var oldQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldQuick.addQuery('user', data.user_id);
                    oldQuick.addQuery('is_active', true);
                    oldQuick.addQuery('message_type', 'Quick_Will');
                    oldQuick.query();
                    while (oldQuick.next()) {
                        oldQuick.setValue('is_active', false);
                        oldQuick.update();
                    }

                    var emsgQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsgQuick.initialize();
                    emsgQuick.setValue('user', data.user_id);
                    emsgQuick.setValue('message_encrypted', sanitizeInput(input.message, 4000));
                    emsgQuick.setValue('message_type', 'Quick_Will');
                    emsgQuick.setValue('is_active', true);
                    emsgQuick.setValue('created_at', new GlideDateTime());

                    if (emsgQuick.insert()) {
                        data.success = true;
                    }
                }
            } catch (e) {
                gs.error("[Kokoro] Quick will error: " + e.message);
            }
            return;
        }

        // å¿—æ„¿è€…æ“ä½œ
        if (input.sys_id) {
            if (!validateSysId(input.sys_id)) {
                data.error = "ç„¡åŠ¹ãªID";
                return;
            }

            var taskGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            if (!taskGr.get(input.sys_id)) {
                data.error = "ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                return;
            }

            var currentState = String(taskGr.getValue('state') || '10');

            if (input.action === 'assign_to_me') {
                if (!isVolunteer) {
                    data.error = "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ¨©é™ãŒå¿…è¦ã§ã™";
                    return;
                }

                taskGr.setValue('assigned_to', data.user_id);
                
                if (currentState === '1' || currentState === '10') {
                    var validationAssign = StateValidator.validateTransition(currentState, '11');
                    if (validationAssign.valid) {
                        taskGr.setValue('state', '11');
                    }
                }
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + data.user_name, data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'assign_to' && input.assignee_id) {
                if (!isVolunteer) {
                    data.error = "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ¨©é™ãŒå¿…è¦ã§ã™";
                    return;
                }

                taskGr.setValue('assigned_to', input.assignee_id);
                
                if (currentState === '1' || currentState === '10') {
                    var validationAssignTo = StateValidator.validateTransition(currentState, '11');
                    if (validationAssignTo.valid) {
                        taskGr.setValue('state', '11');
                    }
                }
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + input.assignee_id, data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'change_status' && input.new_state) {
                var newState = String(input.new_state);
                var validationChange = StateValidator.validateTransition(currentState, newState);
                
                if (!validationChange.valid) {
                    data.error = validationChange.message;
                    return;
                }

                if ((newState === '2' || newState === '4') && taskGr.assigned_to.nil()) {
                    data.error = "å…ˆã«æ‹…å½“è€…ã‚’è¨­å®šã—ã¦ãã ã•ã„";
                    return;
                }

                taskGr.setValue('state', newState);
                
                if (newState === '4') {
                    taskGr.setValue('u_completed_at', new GlideDateTime());
                }
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Status changed to ' + newState, data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'start') {
                var validationStart = StateValidator.validateTransition(currentState, '2');
                if (!validationStart.valid) {
                    data.error = validationStart.message;
                    return;
                }

                if (taskGr.getValue('assigned_to') != data.user_id && !gs.hasRole('admin')) {
                    data.error = "è‡ªåˆ†ã«æ‹…å½“ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®ã¿é–‹å§‹ã§ãã¾ã™";
                    return;
                }

                taskGr.setValue('state', '2');
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task started', data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'complete') {
                var validationComplete = StateValidator.validateTransition(currentState, '4');
                if (!validationComplete.valid) {
                    data.error = validationComplete.message;
                    return;
                }

                taskGr.setValue('state', '4');
                taskGr.setValue('u_completed_at', new GlideDateTime());
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task completed', data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'add_comment' && input.message) {
                try {
                    taskGr.work_notes = sanitizeInput(input.message, 1000);
                    taskGr.update();
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Comment added', data.user_id);
                } catch (e) {
                    data.error = "ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ å¤±æ•—";
                }
                return;
            }
        }
    }

    // ==========================================
    // åŠ è½½å¿—æ„¿è€…æ•°æ®
    // ==========================================
    if (isVolunteer) {
        try {
            var myGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            myGr.addQuery('assigned_to', data.user_id);
            myGr.orderByDesc('sys_updated_on');
            myGr.setLimit(50);
            myGr.query();
            while (myGr.next()) {
                data.myTasks.push(buildTaskItem(myGr));
            }
        } catch (e) {
            gs.error("[Kokoro] My tasks load error: " + e.message);
        }

        try {
            var allGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            allGr.orderByDesc('sys_created_on');
            allGr.setLimit(100);
            allGr.query();
            while (allGr.next()) {
                data.list.push(buildTaskItem(allGr));
            }
        } catch (e) {
            gs.error("[Kokoro] All tasks load error: " + e.message);
        }

        try {
            var gaOpen = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaOpen.addNullQuery('assigned_to');
            gaOpen.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaOpen.addAggregate('COUNT');
            gaOpen.query();
            if (gaOpen.next()) {
                data.openCount = parseInt(gaOpen.getAggregate('COUNT')) || 0;
            }

            var gaSOS = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaSOS.addQuery('u_urgency', 'Critical');
            gaSOS.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaSOS.addAggregate('COUNT');
            gaSOS.query();
            if (gaSOS.next()) {
                data.sosCount = parseInt(gaSOS.getAggregate('COUNT')) || 0;
            }
        } catch (e) {
            gs.error("[Kokoro] Stats error: " + e.message);
        }

        data.volunteers = loadVolunteerList();
    }

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-26 11:35:13</sys_created_on>
        <sys_id>8e1c03ef83ee3210f6b1fb96feaad3bb</sys_id>
        <sys_mod_count>38</sys_mod_count>
        <sys_name>Kokoro User</sys_name>
        <sys_package display_value="Kokoro Shelter" source="x_1821654_kokoro_0">80ba4d9583863210f6b1fb96feaad3b2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Kokoro Shelter">80ba4d9583863210f6b1fb96feaad3b2</sys_scope>
        <sys_update_name>sp_widget_8e1c03ef83ee3210f6b1fb96feaad3bb</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-27 05:33:47</sys_updated_on>
        <template><![CDATA[<div class="kokoro-user-container">
  
  <!-- è®¾ç½®æŒ‰é’® -->
  <div class="safety-settings-btn" ng-click="c.toggleSettings()">
    <i class="fa fa-cog"></i> è¨­å®š
  </div>
  
  <!-- ç®¡ç†è€…åˆ‡æ¢ -->
  <div class="admin-switch" ng-if="c.data.is_volunteer" ng-click="c.goToVolunteerView()">
    <i class="fa fa-user-md"></i>
  </div>

  <!-- è®¾ç½®è¦†ç›–å±‚ -->
  <div class="settings-overlay" ng-if="c.showSettings">
    <div class="settings-card">
      <div class="card-header">
        <h3><i class="fa fa-cog"></i> å®‰å…¨è¨­å®š</h3>
        <button class="close-btn" ng-click="c.toggleSettings()">&times;</button>
      </div>
      
      <div class="settings-desc">
        ã“ã“ã¯ã‚ãªãŸã®ã€Œå‘½ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€ã§ã™ã€‚<br>
        ä¸‡ä¸€ã®éš›ï¼ˆ24æ™‚é–“å¿œç­”ãªã—ï¼‰ã€ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«ä½¿ç”¨ã™ã‚‹æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
      </div>

      <div class="input-group">
        <label><i class="fa fa-envelope" style="color:#e91e63;"></i> ç·Šæ€¥é€£çµ¡å…ˆ (Email)</label>
        <input type="email" class="glass-input" ng-model="c.temp_settings.email" placeholder="ä¾‹ï¼špartner@example.com">
      </div>

      <div class="input-group">
        <label><i class="fa fa-tint" style="color:#e53935;"></i> è¡€æ¶²å‹ (Blood Type)</label>
        <select class="glass-input" ng-model="c.temp_settings.blood_type">
          <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
          <option value="A+">Aå‹ (+)</option>
          <option value="A-">Aå‹ (-)</option>
          <option value="B+">Bå‹ (+)</option>
          <option value="B-">Bå‹ (-)</option>
          <option value="O+">Oå‹ (+)</option>
          <option value="O-">Oå‹ (-)</option>
          <option value="AB+">ABå‹ (+)</option>
          <option value="AB-">ABå‹ (-)</option>
        </select>
      </div>

      <div class="input-group">
        <label><i class="fa fa-medkit" style="color:#43a047;"></i> æŒç—…ãƒ»åŒ»ç™‚æƒ…å ± (Medical Info)</label>
        <textarea class="glass-input" ng-model="c.temp_settings.medical_info" placeholder="ä¾‹ï¼šç³–å°¿ç—…ã€é«˜è¡€åœ§ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãªã©..." rows="3"></textarea>
      </div>
      
      <div class="input-group">
        <label><i class="fa fa-pencil" style="color:#5c6bc0;"></i> ãã®ä»–ã®ä¼è¨€ (Digital Will)</label>
        <textarea class="glass-input" ng-model="c.temp_settings.will" placeholder="ãã®ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆé¿é›£å ´æ‰€ã®å¸Œæœ›ãªã©ï¼‰..." rows="3"></textarea>
      </div>

      <button class="save-settings-btn" ng-click="c.saveSettings()">
        <span ng-if="!c.saving">è¨­å®šã‚’ä¿å­˜ (Save)</span>
        <span ng-if="c.saving"><i class="fa fa-spinner fa-spin"></i> Saving...</span>
      </button>
    </div>
  </div>
  
  <!-- åˆå§‹ç•Œé¢ - å²è±å§† -->
  <div ng-if="c.step === 0 && !c.show_will_input">
    <!-- æç¤ºæ–‡å­— -->
    <div class="pulse-overlay">
      <h2 class="pulse-title">
        ä»Šæ—¥ã€ç„¡äº‹ã§ã™ã‹ï¼Ÿ
        <span class="sub-text"><br>(å¤§ä¸ˆå¤«ï¼Ÿã“ã“ã‚ã‚’ç¹‹ã„ã§ã€ç„¡äº‹ã‚’ç¢ºèªã€‚)</span>
      </h2>
    </div>

    <!-- å²è±å§†èˆå° -->
    <div class="slime-stage">
      <div id="the-slime" class="kokoro-slime" 
           ng-class="{'happy-slime': c.step >= 1, 'poked': c.is_poked}"
           ng-click="c.pokeSlime()">
        <div class="slime-eyes" ng-style="{'transform': 'translate(' + eyeX + 'px, ' + eyeY + 'px)'}"></div>
      </div>
    </div>
  </div>

  <!-- é—è¨€è¾“å…¥ -->
  <div class="will-overlay" ng-if="c.show_will_input">
    <div class="will-card">
      <h3 class="will-title"><i class="fa fa-heartbeat"></i> ç”Ÿå­˜ç¢ºèªå®Œäº†</h3>
      <p class="will-desc">KokoroãŒã‚ãªãŸã®è„ˆå‹•ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚<br>ä¸‡ä¸€ã«å‚™ãˆã€æ•‘åŠ©éšŠã¸ã®ä¼è¨€ã‚’æ®‹ã—ã¾ã™ã‹ï¼Ÿ</p>
      <textarea class="will-textarea" ng-model="c.digital_will" placeholder="ä¾‹ï¼šä½“è‚²é¤¨ã®2éšå€‰åº«ã«ã„ã¾ã™ã€‚ç³–å°¿ç—…ã®è–¬ãŒå¿…è¦ã§ã™..."></textarea>
      <div class="will-actions">
        <button class="btn-will-skip" ng-click="c.finishHeartbeat(false)">ä»Šã¯ã—ãªã„</button>
        <button class="btn-will-save" ng-click="c.finishHeartbeat(true)">ä¿å­˜ã—ã¦é€²ã‚€</button>
      </div>
    </div>
  </div>

  <!-- è¡¨å•å®¹å™¨ -->
  <div class="form-stage" ng-if="c.step > 0">
    <div class="floating-header" ng-if="c.step < 5">
      <h2 class="form-title"><i class="fa fa-heartbeat"></i> æ”¯æ´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h2>
      <div class="progress-indicator">
        <span class="progress-step" ng-class="{'active': c.step >= 1}">1</span>
        <span class="progress-line" ng-class="{'active': c.step >= 2}"></span>
        <span class="progress-step" ng-class="{'active': c.step >= 2}">2</span>
        <span class="progress-line" ng-class="{'active': c.step >= 3}"></span>
        <span class="progress-step" ng-class="{'active': c.step >= 3}">3</span>
        <span class="progress-line" ng-class="{'active': c.step >= 4}"></span>
        <span class="progress-step" ng-class="{'active': c.step >= 4}">4</span>
      </div>
    </div>
    
    <div class="form-wrapper" ng-if="c.step < 5">
      <div class="step-card" ng-if="c.step >= 1">
        <label class="big-label">1. ã„ã‚‰ã£ã—ã‚ƒã‚‹ã‚¨ãƒªã‚¢</label>
        <div class="input-wrapper">
          <select class="big-input" ng-model="c.data.location" ng-change="c.onLocationChange()">
            <option value="" disabled selected>ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ...</option>
            <option value="Family Area">]]>ğŸ§¸<![CDATA[ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚¨ãƒªã‚¢ (å®¶æ—)</option>
            <option value="Single Area">]]>ğŸ”‘<![CDATA[å˜èº«ã‚¨ãƒªã‚¢ (ä¸€äºº)</option>
            <option value="Medical Area">]]>ğŸ©º<![CDATA[åŒ»ç™‚ãƒ»ã‚±ã‚¢ã‚¨ãƒªã‚¢</option>
          </select>
          <i class="fa fa-chevron-down select-arrow"></i>
        </div>
      </div>

      <div class="step-card" ng-if="c.step >= 2">
        <label class="big-label">2. è©³ç´°ãªå ´æ‰€ (éƒ¨å±‹ç•ªå·ãªã©)</label>
        <input type="text" class="big-input" ng-model="c.data.detail_loc" placeholder="ä¾‹ï¼š101å·å®¤ã€ä½“è‚²é¤¨ã®å³å´..." ng-change="c.checkDetail()">
      </div>

      <div class="step-card" ng-if="c.step >= 3">
        <label class="big-label">3. å¿…è¦ãªæ”¯æ´</label>
        <div class="input-wrapper mb-3">
          <select class="big-input" ng-model="c.data.category" ng-change="c.checkInput()">
            <option value="" disabled selected>ä½•ãŒå¿…è¦ã§ã™ã‹ï¼Ÿ</option>
            <option value="Water">]]>ğŸ’§<![CDATA[é£²æ–™æ°´ (Water)</option>
            <option value="Food">]]>ğŸ±<![CDATA[é£Ÿæ–™ (Food)</option>
            <option value="Medical">]]>ğŸ’Š<![CDATA[åŒ»ç™‚ãƒ»è–¬ (Medical)</option>
            <option value="Baby">]]>ğŸ‘¶<![CDATA[ä¹³å¹¼å…ç”¨å“ (Baby)</option>
            <option value="Power">]]>ğŸ”‹<![CDATA[é›»æºãƒ»å……é›» (Power)</option>
            <option value="Other">]]>ğŸ“¦<![CDATA[ãã®ä»– (Other)</option>
          </select>
          <i class="fa fa-chevron-down select-arrow"></i>
        </div>
        <div class="flex-row">
          <div class="half-col">
            <input type="number" class="big-input" ng-model="c.data.quantity" placeholder="æ•°é‡" ng-change="c.checkInput()" style="text-align:center;">
          </div>
          <div class="half-col input-wrapper">
            <select class="big-input" ng-model="c.data.affected_count" ng-change="c.checkInput()" style="text-align:center;">
              <option value="" disabled selected>äººæ•°</option>
              <option value="1">1äºº</option>
              <option value="2-4">2-4äºº</option>
              <option value="5+">5äºº+</option>
            </select>
          </div>
        </div>
        <div class="input-wrapper mb-3">
          <select class="big-input" ng-model="c.data.urgency" ng-change="c.checkInput()" ng-class="{'critical-bg': c.data.urgency === 'Critical'}">
            <option value="" disabled selected>ç·Šæ€¥åº¦ã¯ï¼Ÿ</option>
            <option value="Low">]]>ğŸ¢<![CDATA[æ€¥ãã¾ã›ã‚“</option>
            <option value="Medium">]]>ğŸš¶<![CDATA[æ™®é€š (ãªã‚‹ã¹ãæ—©ã)</option>
            <option value="High">]]>ğŸƒ<![CDATA[å›°ã£ã¦ã„ã¾ã™ (æ—©æ€¥ã«)</option>
            <option value="Critical">]]>ğŸ†˜<![CDATA[é™ç•Œã§ã™/ä»Šã™ã</option>
          </select>
          <i class="fa fa-chevron-down select-arrow"></i>
        </div>
        <textarea class="glass-textarea" ng-model="c.data.remarks" placeholder="å‚™è€ƒ (ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãªã©)..."></textarea>
      </div>
      
      <div ng-if="c.fileData" style="text-align: center; margin-bottom: 26px;">
        <div style="position: relative; display: inline-block;">
          <img ng-src="{{c.fileData}}" style="height: 170px; border-radius: 18px; border: 4px solid #fff; box-shadow: 0 10px 28px rgba(0,0,0,0.15);" />
          <div ng-click="c.clearFile()" style="position: absolute; top: -14px; right: -14px; background: #ff5252; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; border: 3px solid #fff;">
            <i class="fa fa-times" style="font-size:18px;"></i>
          </div>
        </div>
        <div style="color: #43a047; font-weight: 800; font-size: 0.95rem; margin-top: 12px;">å†™çœŸãŒæ·»ä»˜ã•ã‚Œã¾ã—ãŸ</div>
      </div>
      <div class="action-row" ng-if="c.step >= 4">
        <label class="big-attach-btn">
          <input type="file" style="display: none;" onchange="angular.element(this).scope().c.uploadFiles(this.files)"/>
          <i class="fa fa-camera"></i>
        </label>
        <button class="big-submit-btn" ng-click="c.submitWish()">
          <span ng-if="!c.is_editing && !c.submitting">é¡˜ã„ã‚’é€ã‚‹</span>
          <span ng-if="c.is_editing && !c.submitting">å†…å®¹ã‚’æ›´æ–°</span>
          <span ng-if="c.submitting"><i class="fa fa-spinner fa-spin"></i> é€ä¿¡ä¸­...</span>
        </button>
      </div>
    </div>

    <!-- æˆåŠŸå¡ç‰‡ -->
    <div class="success-card" ng-if="c.step === 5">
      <div class="status-tracker">
        <div class="status-step" ng-class="{'active': c.current_state_val >= 1}"><div class="icon">]]>ğŸ“¨<![CDATA[</div><div class="text">æå‡º</div></div>
        <div class="line" ng-class="{'active': c.current_state_val >= 10}"></div>
        <div class="status-step" ng-class="{'active': c.current_state_val >= 10}"><div class="icon">]]>ğŸ‘€<![CDATA[</div><div class="text">ç¢ºèª</div></div>
        <div class="line" ng-class="{'active': c.current_state_val >= 11}"></div>
        <div class="status-step" ng-class="{'active': c.current_state_val >= 11}"><div class="icon">]]>ğŸ™‹<![CDATA[</div><div class="text">æ‹…å½“</div></div>
        <div class="line" ng-class="{'active': c.current_state_val >= 2}"></div>
        <div class="status-step" ng-class="{'active': c.current_state_val >= 2}"><div class="icon">]]>ğŸƒ<![CDATA[</div><div class="text">é…é€</div></div>
        <div class="line" ng-class="{'active': c.current_state_val >= 4}"></div>
        <div class="status-step" ng-class="{'active': c.current_state_val >= 4}"><div class="icon">âœ…</div><div class="text">å®Œäº†</div></div>
      </div>
      
      <h2 class="success-title">æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸ</h2>
      <p class="ticket-id">ID: {{c.ticket_number}}</p>
      
      <div class="summary-card">
        <div class="row-item"><strong>å ´æ‰€:</strong> {{c.dict[c.data.location]}} - {{c.data.detail_loc}}</div>
        <div class="row-item"><strong>å†…å®¹:</strong> {{c.dict[c.data.category]}} <span class="badge">x{{c.data.quantity}}</span></div>
        <div class="row-item"><strong>ç·Šæ€¥åº¦:</strong> <span ng-class="{'text-crit': c.data.urgency==='Critical'}">{{c.dict[c.data.urgency]}}</span></div>
        <div class="row-item" ng-if="c.data.remarks"><small style="color:#888;">{{c.data.remarks}}</small></div>
      </div>

      <div class="live-status-pill"><span class="pulse-dot"></span> {{c.status_message}}</div>

      <div class="status-detail-card" ng-if="c.statusDetails[c.current_state_val]">
        <div class="status-header">
          <span class="status-icon">{{c.statusDetails[c.current_state_val].icon}}</span>
          <h3 class="status-title">{{c.statusDetails[c.current_state_val].title}}</h3>
        </div>
        <p class="status-desc">{{c.statusDetails[c.current_state_val].desc}}</p>
        <p class="status-next">æ¬¡: {{c.statusDetails[c.current_state_val].nextStep}}</p>
      </div>

      <div class="btn-group">
        <button class="edit-btn" ng-click="c.editMode()" ng-if="c.current_state_val === 1 || c.current_state_val === 10">ä¿®æ­£ã™ã‚‹</button>
        <button class="big-reset-btn" ng-click="c.reset()">æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
      </div>
    </div>
  </div>

  <!-- åŠ è½½è¦†ç›–å±‚ -->
  <div ng-if="c.submitting" class="loading-overlay">
    <div class="loading-content">
      <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
      <p>é€ä¿¡ä¸­...</p>
      <small>ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã—ã¦è»¢é€ã—ã¦ã„ã¾ã™</small>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
