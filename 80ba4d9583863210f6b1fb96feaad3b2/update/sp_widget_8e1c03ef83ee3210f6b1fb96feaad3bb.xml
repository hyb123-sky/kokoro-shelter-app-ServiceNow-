<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, spUtil, $timeout, $window, $interval) {
    var c = this;
	
	// ==========================================
// åŒæ¨¡å¼åˆå§‹åŒ–
// ==========================================
c.is_guest = c.data.is_guest || false;
c.auth_mode = c.data.auth_mode || 'authenticated';
c.guest_token = '';

// æ¸¸å®¢åˆå§‹åŒ–
function initGuestMode() {
    // 1. å…ˆå°è¯•ä» localStorage æ¢å¤ token
    var savedToken = '';
    try {
        savedToken = $window.localStorage.getItem('kokoro_guest_token') || '';
    } catch (e) {}
    
    console.log(']]>ğŸ“<![CDATA[ æ¸¸å®¢æ¨¡å¼åˆå§‹åŒ–ï¼ŒlocalStorageä¸­çš„token:', savedToken);
    
    // 2. è°ƒç”¨æœåŠ¡ç«¯éªŒè¯æˆ–ç”Ÿæˆæ–° token
    c.server.get({
        action: 'guest_init',  // âœ… æ­£ç¡®çš„ action
        guest_token: savedToken
    }).then(function(r) {
        if (r && r.data && r.data.success) {
            c.guest_token = r.data.guest_token;
            c.auth_mode = r.data.auth_mode;
            
            console.log('âœ… æœåŠ¡ç«¯è¿”å›çš„ guest_token:', c.guest_token);
            
            // 3. æŒä¹…åŒ–åˆ° localStorage
            try {
                $window.localStorage.setItem('kokoro_guest_token', c.guest_token);
                console.log('âœ… guest_token å·²ä¿å­˜åˆ° localStorage');
            } catch (e) {
                console.error('âŒ æ— æ³•ä¿å­˜åˆ° localStorage:', e);
            }
            
            if (r.data.upgrade_hint) {
                showSuccess('ä»¥å‰ã®ã‚²ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ç§»è¡Œã§ãã¾ã™ã€‚');
            }
            
            // 4. åˆå§‹åŒ–åç«‹å³åŠ è½½å†å²è®°å½•
            $timeout(function() {
                c.server.get({
                    action: 'get_my_history',
                    guest_token: c.guest_token
                }).then(function(historyR) {
                    if (historyR && historyR.data && historyR.data.my_requests) {
                        c.data.my_requests = historyR.data.my_requests;
                        console.log('âœ… æ¸¸å®¢å†å²è®°å½•å·²åŠ è½½:', c.data.my_requests.length);
                    }
                });
            }, 500);
            
        } else {
            console.error('âŒ guest_init å¤±è´¥');
        }
    }).catch(function(error) {
        console.error('âŒ guest_init è¯·æ±‚å¤±è´¥:', error);
    });
}

// å¦‚æœæ˜¯æ¸¸å®¢æ¨¡å¼ï¼Œç«‹å³åˆå§‹åŒ–
if (c.is_guest) {
    initGuestMode();
}

    // ==========================================
    // [æ–°å¢] å¥½å‹å®ˆæŠ¤ç³»ç»Ÿ
    // ==========================================

    c.show_guardian = false;
    c.guardian_tab = 'friends'; // friends / requests / search
    c.selected_friend = null;
    c.search_query = "";
    c.search_results = [];
    c.recommended_friends = [];

    c.toggleGuardianCircle = function() {
    c.showMenu = false;
    
    if (c.is_guest) {
        c.show_login_prompt = true;
        c.login_prompt_feature = 'guardian';
        return;
    }
    
    c.show_guardian = !c.show_guardian;

    if (c.show_guardian) {
        c.loadGuardianData();
    }
};

// æ–°å¢: ç™»å½•æç¤º
c.show_login_prompt = false;
c.login_prompt_feature = '';

c.dismissLoginPrompt = function() {
    c.show_login_prompt = false;
};

c.goToLogin = function() {
    $window.location.href = '/login.do?sysparm_goto_url=' + 
        encodeURIComponent($window.location.href);
};

    // åŠ è½½å®ˆæŠ¤åœˆæ•°æ®
    c.loadGuardianData = function() {
        c.server.get({
            action: 'get_guardian_data'
        }).then(function(r) {
            if (handleServerResponse(r, function(data) {
                    c.data.friends = data.friends || [];
                    c.data.friend_requests = data.friend_requests || [];
                    c.data.friend_notifications = data.notification_count || 0;
                    c.recommended_friends = data.recommended || [];
                }));
        });
    };

    // æœç´¢ç”¨æˆ·
    var searchTimer = null;
    c.searchUsers = function() {
        if (searchTimer) $timeout.cancel(searchTimer);

        if (!c.search_query || c.search_query.trim().length < 2) {
            c.search_results = [];
            return;
        }

        searchTimer = $timeout(function() {
            c.server.get({
                action: 'search_users',
                query: c.search_query
            }).then(function(r) {
                if (handleServerResponse(r, function(data) {
                        c.search_results = data.results || [];
                    }));
            });
        }, 500);
    };

    // å‘é€å¥½å‹è¯·æ±‚
    c.sendFriendRequest = function(user) {
        if (user.already_friend || user.request_sent) return;

        safeServerGet({
    action: 'send_friend_request',
            friend_id: user.sys_id
        }).then(function(r) {
            if (handleServerResponse(r, function() {
                    user.request_sent = true;
                    showSuccess('å‹é”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ');
                }));
        });
    };

    // æ¥å—å¥½å‹è¯·æ±‚
    c.acceptFriendRequest = function(req) {
        safeServerGet({
    action: 'accept_friend_request',
            request_id: req.sys_id
        }).then(function(r) {
            if (handleServerResponse(r, function() {
                    var index = c.data.friend_requests.indexOf(req);
                    if (index !== -1) {
                        c.data.friend_requests.splice(index, 1);
                    }
                    c.loadGuardianData();
                    showSuccess(req.from_user_name + ' ã¨å‹é”ã«ãªã‚Šã¾ã—ãŸ');
                }));
        });
    };

    // æ‹’ç»å¥½å‹è¯·æ±‚
    c.rejectFriendRequest = function(req) {
        safeServerGet({
    action: 'reject_friend_request',
            request_id: req.sys_id
        }).then(function(r) {
            if (handleServerResponse(r, function() {
                    var index = c.data.friend_requests.indexOf(req);
                    if (index !== -1) {
                        c.data.friend_requests.splice(index, 1);
                    }
                    showSuccess('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ã—ã¾ã—ãŸ');
                }));
        });
    };

    // æ˜¾ç¤ºå¥½å‹è¯¦æƒ…
    c.showFriendDetail = function(friend) {
        c.selected_friend = friend;
    };

    // ç´§æ€¥å‘¼å«
    c.emergencyCall = function(friend, $event) {
        if ($event) $event.stopPropagation();

        if (confirm(friend.display_name + ' ã«ç·Šæ€¥å‘¼ã³å‡ºã—ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
            safeServerGet({
    action: 'send_emergency_call',
                friend_id: friend.user_id
            }).then(function(r) {
                if (handleServerResponse(r, function() {
                        showSuccess('ç·Šæ€¥å‘¼ã³å‡ºã—ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
                    }));
            });
        }
    };

    // å‘é€æ¶ˆæ¯
    c.sendMessage = function(friend, $event) {
        if ($event) $event.stopPropagation();

        var message = prompt(friend.display_name + ' ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:');
        if (message && message.trim()) {
            safeServerGet({
    action: 'send_friend_message',
                friend_id: friend.user_id,
                message: message
            }).then(function(r) {
                if (handleServerResponse(r, function() {
                        showSuccess('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
                    }));
            });
        }
    };

    // æŸ¥çœ‹å¥½å‹å†å²
    c.viewFriendHistory = function(friend) {
        showSuccess('ã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™');
    };

    // ç§»é™¤å¥½å‹
    c.removeFriend = function(friend) {
        if (confirm(friend.display_name + ' ã‚’å‹é”ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            safeServerGet({
    action: 'remove_friend',
                friend_id: friend.user_id
            }).then(function(r) {
                if (handleServerResponse(r, function() {
                        c.selected_friend = null;
                        c.loadGuardianData();
                        showSuccess('å‹é”ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    }));
            });
        }
    };

    // å®æ—¶æ›´æ–°å¥½å‹çŠ¶æ€
    var friendStatusInterval = null;

    function startFriendStatusPolling() {
        if (friendStatusInterval) return;

        friendStatusInterval = $interval(function() {
            if (c.show_guardian && c.data.friends && c.data.friends.length > 0) {
                c.server.get({
                    action: 'get_friend_status_updates'
                }).then(function(r) {
                    if (r && r.data && r.data.updates) {
                        r.data.updates.forEach(function(update) {
                            var friend = c.data.friends.find(function(f) {
                                return f.user_id === update.user_id;
                            });
                            if (friend) {
    var prevStatus = friend.heartbeat_status;
    friend.heartbeat_status = update.status;
    friend.last_heartbeat_time = update.time_ago;
    friend.current_zone = update.zone;
    
    // çŠ¶æ€æ¶åŒ–æ—¶é€šçŸ¥
    if (prevStatus !== 'critical' && update.status === 'critical') {
        NotificationManager.show(
            'âš ï¸ ' + friend.display_name,
            'é•·æ™‚é–“å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å®‰å¦ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
            'critical'
        );
    }
}
                        });
                    }
                });
            }
        }, 30000);
    }

    function stopFriendStatusPolling() {
        if (friendStatusInterval) {
            $interval.cancel(friendStatusInterval);
            friendStatusInterval = null;
        }
    }

    $scope.$watch('c.show_guardian', function(newVal) {
        if (newVal) {
            startFriendStatusPolling();
        } else {
            stopFriendStatusPolling();
        }
    });

    $scope.$on('$destroy', function() {
        stopFriendStatusPolling();
    });

    // [æ–°å¢] æ±‰å ¡èœå•æ§åˆ¶
    c.showMenu = false;
    c.toggleMenu = function() {
        c.showMenu = !c.showMenu;
    };

    // çŠ¶æ€åˆå§‹åŒ–
    var CONFIG = {
        states: {
            DRAFT: 1,
            SUBMITTED: 10,
            ASSIGNED: 11,
            IN_PROGRESS: 2,
            COMPLETED: 4,
            CANCELLED: 5,
            ON_HOLD: 6
        },
        debounceDelay: 300
    };

    c.step = 0;
    c.is_poked = false;
    c.show_will_input = false;
    c.digital_will = "";
    c.current_state_val = 0;
    c.is_editing = false;
    c.submitting = false;
    c.saving = false;
    c.status_message = "å¾…æ©Ÿä¸­...";
    c.showSettings = false;
    c.current_heartbeat_id = null;
    c.ticket_number = "";
    c.ticket_sys_id = null;
    c.files = null;
    c.fileData = null;

    c.data.user_name = c.data.user_name || "ãŠå®¢æ§˜";

    c.temp_settings = {
        email: c.data.emergency_email || "",
        medical_info: c.data.medical_info || "",
        blood_type: c.data.blood_type || "",
        will: c.data.saved_will || ""
    };

    c.dict = {
    'Water': 'é£²æ–™æ°´',
    'Food': 'é£Ÿæ–™',
    'Medical': 'åŒ»ç™‚ãƒ»è–¬',
    'Baby': 'ä¹³å¹¼å…ç”¨å“',
    'Power': 'é›»æºãƒ»å……é›»',
    'Other': 'ãã®ä»–',
    'Family Area': 'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚¨ãƒªã‚¢',
    'Single Area': 'å˜èº«ã‚¨ãƒªã‚¢',
    'Medical Area': 'åŒ»ç™‚ãƒ»ã‚±ã‚¢ã‚¨ãƒªã‚¢',
    'Critical': 'é™ç•Œ (SOS)',
    'High': 'å›°ã£ã¦ã„ã‚‹',
    'Medium': 'æ™®é€š',
    'Low': 'æ€¥ãã¾ã›ã‚“',
    // å¢åŠ ä¸€ä¸ªå…œåº•ï¼Œå¤„ç†ç©ºåˆ†ç±»çš„æƒ…å†µ
    '': 'ä¸€èˆ¬ãƒªã‚¯ã‚¨ã‚¹ãƒˆ' 
};

    c.statusDetails = {
        1: {
            icon: ']]>ğŸ“<![CDATA[',
            title: 'DRAFT',
            desc: 'é€ä¿¡å‰ã®çŠ¶æ…‹',
            nextStep: 'é€ä¿¡ã—ã¦ãã ã•ã„'
        },
        10: {
            icon: ']]>ğŸ“¨<![CDATA[',
            title: 'SUBMITTED',
            desc: 'ã‚·ã‚¹ãƒ†ãƒ ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡',
            nextStep: 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ç¢ºèªå¾…ã¡'
        },
        11: {
            icon: ']]>ğŸ™‹<![CDATA[',
            title: 'ASSIGNED',
            desc: 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ãŒæ‹…å½“',
            nextStep: 'é…é€æº–å‚™ä¸­'
        },
        2: {
            icon: ']]>ğŸƒ<![CDATA[',
            title: 'IN_PROGRESS',
            desc: 'æ•‘æ´ç‰©è³‡ã‚’æŒã£ã¦ç§»å‹•ä¸­',
            nextStep: 'ã¾ã‚‚ãªãåˆ°ç€'
        },
        4: {
            icon: 'âœ…',
            title: 'COMPLETED',
            desc: 'ãŠå±Šã‘å®Œäº†',
            nextStep: 'ãŠå¤§äº‹ã«'
        },
        5: {
            icon: 'âŒ',
            title: 'CANCELLED',
            desc: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ',
            nextStep: ''
        },
        6: {
            icon: 'â¸ï¸',
            title: 'ON_HOLD',
            desc: 'ä¸€æ™‚åœæ­¢',
            nextStep: 'å†é–‹å¾…ã¡'
        }
    };

    function showSuccess(msg) {
        spUtil.addInfoMessage(msg);
    }

    function showError(msg) {
        spUtil.addErrorMessage(msg || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }

    function handleServerResponse(response, successCallback) {
        if (!response || !response.data) {
            showError('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼');
            return false;
        }
        if (response.data.error) {
            showError(response.data.error);
            return false;
        }
        if (successCallback) successCallback(response.data);
        return true;
    }

    c.goToVolunteerView = function() {
        $window.location.href = '?id=kokoro_volunteer';
    };

    // ==========================================
    // çœ¼ç›è·Ÿéšé¼ æ ‡
    // ==========================================
    $scope.eyeX = 0;
    $scope.eyeY = 0;
    var targetEyeX = 0,
        targetEyeY = 0,
        eyeAnimationFrame = null;

    function animateEyes() {
        $scope.eyeX += (targetEyeX - $scope.eyeX) * 0.15;
        $scope.eyeY += (targetEyeY - $scope.eyeY) * 0.15;

        if (Math.abs(targetEyeX - $scope.eyeX) > 0.01 || Math.abs(targetEyeY - $scope.eyeY) > 0.01) {
            eyeAnimationFrame = requestAnimationFrame(function() {
                $scope.$apply();
                animateEyes();
            });
        } else {
            eyeAnimationFrame = null;
        }
    }

    function handleMouseMove(e) {
        var cx = $window.innerWidth / 2;
        var cy = $window.innerHeight / 2;
        var range = 8;
        targetEyeX = Math.max(Math.min((e.clientX - cx) / cx * range, range), -range);
        targetEyeY = Math.max(Math.min((e.clientY - cy) / cy * range, range * 0.5), -range * 0.5);
        if (!eyeAnimationFrame) {
            animateEyes();
        }
    }

    $window.addEventListener('mousemove', handleMouseMove);
	
	// ==========================================
// åº”ç”¨å†…é€šçŸ¥ç³»ç»Ÿ (In-App Notification)
// ==========================================
c.notifications = [];
c.notification_count = 0;

var NotificationManager = {
    
    // æ˜¾ç¤ºé€šçŸ¥
    show: function(title, message, type, duration) {
        var notif = {
            id: Date.now(),
            title: title,
            message: message,
            type: type || 'info',  // info / success / warning / critical
            timestamp: new Date(),
            visible: true
        };
        
        $scope.$evalAsync(function() {
            c.notifications.unshift(notif);
            c.notification_count = c.notifications.length;
            
            // æœ€å¤šä¿ç•™5æ¡
            if (c.notifications.length > 5) {
                c.notifications.pop();
            }
        });
        
        // è‡ªåŠ¨æ¶ˆå¤±
        var autoDismiss = duration || 6000;
        if (type === 'critical') autoDismiss = 12000;
        
        $timeout(function() {
            NotificationManager.dismiss(notif.id);
        }, autoDismiss);
        
        return notif.id;
    },
    
    // å…³é—­é€šçŸ¥
    dismiss: function(notifId) {
        $scope.$evalAsync(function() {
            for (var i = 0; i < c.notifications.length; i++) {
                if (c.notifications[i].id === notifId) {
                    c.notifications[i].visible = false;
                    break;
                }
            }
            
            // å»¶è¿Ÿç§»é™¤ï¼ˆç­‰åŠ¨ç”»ç»“æŸï¼‰
            $timeout(function() {
                c.notifications = c.notifications.filter(function(n) {
                    return n.visible;
                });
                c.notification_count = c.notifications.length;
            }, 400);
        });
    },
    
    // æ¸…ç©ºæ‰€æœ‰
    clearAll: function() {
        $scope.$evalAsync(function() {
            c.notifications = [];
            c.notification_count = 0;
        });
    }
};

c.dismissNotification = function(notifId) {
    NotificationManager.dismiss(notifId);
};
	
	// ==========================================
// Offline Queueï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ï¼‰
// ==========================================
c.network_status = 'online';  // online / offline / syncing
c.offline_queue_count = 0;
c.sync_progress = '';

var OfflineQueue = {
    STORAGE_KEY: 'kokoro_offline_queue',
    
    // è·å–é˜Ÿåˆ—
    getQueue: function() {
        try {
            var raw = $window.localStorage.getItem(this.STORAGE_KEY);
            return raw ? JSON.parse(raw) : [];
        } catch (e) {
            return [];
        }
    },
    
    // ä¿å­˜é˜Ÿåˆ—
    saveQueue: function(queue) {
        try {
            $window.localStorage.setItem(this.STORAGE_KEY, JSON.stringify(queue));
        } catch (e) {
            console.error('[Kokoro] Queue save error:', e);
        }
    },
    
    // æ·»åŠ åˆ°é˜Ÿåˆ—
    enqueue: function(params) {
        var queue = this.getQueue();
        var item = {
            id: Date.now() + '_' + Math.random().toString(36).substr(2, 6),
            params: params,
            timestamp: new Date().toISOString(),
            retries: 0
        };
        queue.push(item);
        this.saveQueue(queue);
        this.updateCount();
        return item.id;
    },
    
    // ä»é˜Ÿåˆ—ç§»é™¤
    dequeue: function(itemId) {
        var queue = this.getQueue();
        var filtered = [];
        for (var i = 0; i < queue.length; i++) {
            if (queue[i].id !== itemId) {
                filtered.push(queue[i]);
            }
        }
        this.saveQueue(filtered);
        this.updateCount();
    },
    
    // æ›´æ–°è®¡æ•°
    updateCount: function() {
        $scope.$evalAsync(function() {
            c.offline_queue_count = OfflineQueue.getQueue().length;
        });
    },
    
    // åŒæ­¥æ‰€æœ‰é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
    syncAll: function() {
        var queue = this.getQueue();
        if (queue.length === 0) return;
        
        $scope.$evalAsync(function() {
            c.network_status = 'syncing';
            c.sync_progress = '0/' + queue.length;
        });
        
        var completed = 0;
        var total = queue.length;
        var self = this;
        
        function processNext(index) {
            if (index >= total) {
                $scope.$evalAsync(function() {
                    c.network_status = 'online';
                    c.sync_progress = '';
                    self.updateCount();
                    if (completed > 0) {
                        showSuccess(completed + 'ä»¶ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŒæœŸã—ã¾ã—ãŸ');
											NotificationManager.show(
    ']]>ğŸ“¡<![CDATA[ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸå®Œäº†',
    completed + 'ä»¶ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¾ã—ãŸ',
    'success'
);
                    }
                });
                
                // åŒæ­¥ååˆ·æ–°å†å²è®°å½•
                $timeout(function() {
                    c.server.get({
                        action: 'get_my_history',
                        guest_token: c.guest_token || ''
                    }).then(function(r) {
                        if (r && r.data && r.data.my_requests) {
                            c.data.my_requests = r.data.my_requests;
                        }
                    });
                }, 1000);
                
                return;
            }
            
            var item = queue[index];
            
            // é‡æ–°é™„åŠ CSRF token
            item.params.csrf_token = csrfToken;
            
            c.server.get(item.params).then(function(response) {
                if (response && response.data && !response.data.error) {
                    self.dequeue(item.id);
                    completed++;
                }
                
                $scope.$evalAsync(function() {
                    c.sync_progress = (index + 1) + '/' + total;
                });
                
                // é—´éš”500mså‘ä¸‹ä¸€ä¸ªï¼Œé¿å…æœåŠ¡å™¨è¿‡è½½
                $timeout(function() {
                    processNext(index + 1);
                }, 500);
                
            }).catch(function() {
                // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå¢åŠ é‡è¯•æ¬¡æ•°
                item.retries = (item.retries || 0) + 1;
                
                // è¶…è¿‡3æ¬¡æ”¾å¼ƒ
                if (item.retries >= 3) {
                    self.dequeue(item.id);
                }
                
                $scope.$evalAsync(function() {
                    c.sync_progress = (index + 1) + '/' + total;
                });
                
                $timeout(function() {
                    processNext(index + 1);
                }, 1000);
            });
        }
        
        processNext(0);
    }
};

// ç½‘ç»œçŠ¶æ€ç›‘å¬
function updateNetworkStatus() {
    $scope.$evalAsync(function() {
        if (navigator.onLine) {
            if (c.network_status === 'offline') {
                // ä¿®å¤ï¼šå…ˆæ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
                var queue = OfflineQueue.getQueue();
                
                if (queue.length > 0) {
                    // æœ‰æ•°æ®æ‰æ˜¾ç¤ºåŒæ­¥ä¸­
                    c.network_status = 'syncing';
                    $timeout(function() {
                        OfflineQueue.syncAll();
                    }, 1500);
                } else {
                    // æ²¡æ•°æ®ç›´æ¥å˜å›åœ¨çº¿
                    c.network_status = 'online';
                }
            } else if (c.network_status !== 'syncing') {
                c.network_status = 'online';
            }
        } else {
            c.network_status = 'offline';
        }
    });
}

$window.addEventListener('online', updateNetworkStatus);
$window.addEventListener('offline', updateNetworkStatus);

// åˆå§‹åŒ–æ—¶æ£€æŸ¥é˜Ÿåˆ—
$timeout(function() {
    OfflineQueue.updateCount();
    if (navigator.onLine && OfflineQueue.getQueue().length > 0) {
        OfflineQueue.syncAll();
    }
}, 2000);
	
	// ==========================================
// CSRF å®‰å…¨è¯·æ±‚åŒ…è£…
// ==========================================
var csrfToken = c.data.csrf_token || '';

function safeServerGet(params) {
    params.csrf_token = csrfToken;
    
    // ç¦»çº¿æ—¶ï¼šå…³é”®æ“ä½œå­˜å…¥é˜Ÿåˆ—
    if (!navigator.onLine) {
        var queueableActions = [
            'submit_record', 'submit_sos', 'register_heartbeat', 'update_will'
        ];
        
        if (params.action && queueableActions.indexOf(params.action) !== -1) {
            var queueId = OfflineQueue.enqueue(params);
            
            $scope.$evalAsync(function() {
                c.network_status = 'offline';
            });
            
            // è¿”å›ä¸€ä¸ªæ¨¡æ‹Ÿçš„æˆåŠŸå“åº”
            var deferred = {
                then: function(successCb) {
                    $timeout(function() {
                        successCb({
                            data: {
                                success: true,
                                offline_queued: true,
                                ticketNumber: 'OFFLINE-' + queueId.substr(0, 8),
                                newRecordID: queueId,
                                message: 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ'
                            }
                        });
                    }, 300);
                    return deferred;
                },
                catch: function() { return deferred; }
            };
            
            showSuccess(']]>ğŸ“¡<![CDATA[ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ - ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©å¸°å¾Œã«è‡ªå‹•é€ä¿¡ï¼‰');
            return deferred;
        }
    }
    
    // åœ¨çº¿æ—¶ï¼šæ­£å¸¸å‘é€
    return c.server.get(params);
}
	
	// ==========================================
// ä¸€é”®SOSç´§æ€¥åŠŸèƒ½
// ==========================================
c.sos_sending = false;
c.sos_location = null;

// è·å–GPSä½ç½®ï¼ˆé™é»˜è·å–ï¼Œä¸é˜»å¡æµç¨‹ï¼‰
function getGPSLocation() {
    return new Promise(function(resolve) {
        if (!navigator.geolocation) {
            resolve(null);
            return;
        }
        
        var timeoutId = setTimeout(function() {
            resolve(null);
        }, 5000); // 5ç§’è¶…æ—¶ï¼Œç¾åŒºç½‘ç»œæ…¢
        
        navigator.geolocation.getCurrentPosition(
            function(pos) {
                clearTimeout(timeoutId);
                resolve({
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    accuracy: Math.round(pos.coords.accuracy)
                });
            },
            function() {
                clearTimeout(timeoutId);
                resolve(null);
            },
            {
                enableHighAccuracy: false, // çœç”µä¼˜å…ˆ
                timeout: 5000,
                maximumAge: 300000 // 5åˆ†é’Ÿç¼“å­˜ï¼Œå‡å°‘GPSè°ƒç”¨
            }
        );
    });
}

c.triggerSOS = function() {
    if (c.sos_sending) return;
    
    c.sos_sending = true;
    
    // ç¬¬1æ­¥ï¼šå°è¯•è·å–GPSï¼ˆä¸é˜»å¡ï¼‰
    getGPSLocation().then(function(location) {
        c.sos_location = location;
        
        // ç¬¬2æ­¥ï¼šæ„å»ºSOSæ•°æ®
        var sosData = {
            action: 'submit_sos',
            urgency: 'Critical',
            category: 'Other',
            quantity: 1,
            affected_count: '1',
            remarks: 'ã€ä¸€é”®SOSã€‘ç·Šæ€¥æ•‘åŠ©è¦è«‹',
            guest_token: c.guest_token || ''
        };
        
        // GPSæˆåŠŸæ—¶é™„åŠ ä½ç½®
        if (location) {
            sosData.detail_loc = 'GPS: ' + location.lat.toFixed(6) + ', ' + location.lng.toFixed(6) + 
                                 ' (ç²¾åº¦' + location.accuracy + 'm)';
            sosData.gps_lat = location.lat;
            sosData.gps_lng = location.lng;
        } else {
            sosData.detail_loc = 'ä½ç½®ä¸æ˜ - è‡ªå‹•å–å¾—å¤±æ•—';
        }
        
        // å®‰å…¨è¨­å®šã‹ã‚‰æƒ…å ±ã‚’è‡ªå‹•ä»˜ä¸
        if (c.data.emergency_email) {
            sosData.contact = c.data.emergency_email;
        }
        if (c.data.medical_info) {
            sosData.remarks += '\nã€åŒ»ç™‚æƒ…å ±ã€‘' + c.data.medical_info;
        }
        if (c.data.blood_type) {
            sosData.remarks += '\nã€è¡€æ¶²å‹ã€‘' + c.data.blood_type;
        }
        
        // ç¬¬3æ­¥ï¼šé€ä¿¡
        safeServerGet(sosData).then(function(response) {
            $scope.$evalAsync(function() {
                c.sos_sending = false;
                
                if (response && response.data && response.data.success) {
                    c.ticket_number = response.data.ticketNumber;
                    c.ticket_sys_id = response.data.newRecordID;
                    c.data.location = 'SOS';
                    c.data.detail_loc = sosData.detail_loc;
                    c.data.category = 'Other';
                    c.data.quantity = 1;
                    c.data.urgency = 'Critical';
                    c.data.remarks = sosData.remarks;
                    
                    if (response.data.my_requests) {
                        c.data.my_requests = response.data.my_requests;
                    }
                    
                    // ç›´æ¥è·³åˆ°ç»“æœé¡µ
                    c.step = 5;
                    updateVisualState(CONFIG.states.SUBMITTED);
                    
                    if (c.ticket_sys_id) {
                        initRecordWatcher(c.ticket_sys_id);
                    }
                    
                    showSuccess(']]>ğŸ†˜<![CDATA[ SOSã‚’é€ä¿¡ã—ã¾ã—ãŸï¼æ•‘æ´ãƒãƒ¼ãƒ ã«é€šçŸ¥ã•ã‚Œã¾ã—ãŸã€‚');
									NotificationManager.show(
    ']]>ğŸ†˜<![CDATA[ SOSé€ä¿¡å®Œäº†',
    'ãƒªã‚¯ã‚¨ã‚¹ãƒˆID: ' + c.ticket_number + ' - æ•‘æ´ãƒãƒ¼ãƒ ã«é€šçŸ¥æ¸ˆã¿',
    'critical'
);
                } else {
                    showError('SOSé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šå¸¸ã®æ‰‹é †ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚');
                }
            });
        }).catch(function() {
            $scope.$evalAsync(function() {
                c.sos_sending = false;
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            });
        });
    });
};

    // ==========================================
    // å²è±å§†äº¤äº’
    // ==========================================
    c.pokeSlime = function() {
        if (c.step > 0 || c.show_will_input || c.is_poked) return;
        c.is_poked = true;
        safeServerGet({
    action: 'register_heartbeat'
}).then(function(r) {
            handleServerResponse(r, function(data) {
                c.current_heartbeat_id = data.heartbeat_id;
                $timeout(function() {
                    c.show_will_input = true;
                    c.is_poked = false;
                }, 800);
            });
        }).catch(function() {
            c.is_poked = false;
            showError('æ¥ç¶šã‚¨ãƒ©ãƒ¼');
        });
    };

    c.finishHeartbeat = function(save) {
        if (save && c.digital_will && c.digital_will.trim()) {
            safeServerGet({
    action: 'update_will',
                heartbeat_id: c.current_heartbeat_id,
                message: c.digital_will
            }).then(function(r) {
                if (r && r.data && r.data.success) {
                    showSuccess("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
                }
            });
        }
        c.show_will_input = false;
        c.digital_will = "";
        c.step = 1;
    };

    // ==========================================
    // è¡¨å•æ­¥éª¤æ§åˆ¶
    // ==========================================
    c.onLocationChange = function() {
        if (c.step === 1 && !c.is_editing && c.data.location) {
            $timeout(function() {
                c.step = 2;
            }, CONFIG.debounceDelay);
        }
    };

    var detailCheckTimer = null;
    c.checkDetail = function() {
        if (detailCheckTimer) $timeout.cancel(detailCheckTimer);
        detailCheckTimer = $timeout(function() {
            if (c.data.detail_loc && c.data.detail_loc.trim().length > 0 && c.step < 3) {
                c.step = 3;
            }
        }, CONFIG.debounceDelay);
    };

    c.checkInput = function() {
        if (c.data.category && c.data.quantity && c.data.urgency) {
            if (c.step < 4) c.step = 4;
        }
    };

    c.editMode = function() {
        c.step = 4;
        c.is_editing = true;
        c.status_message = "å†…å®¹ä¿®æ­£ä¸­...";
    };

    // ==========================================
    // æäº¤è¡¨å• (ä¿®æ­£ç‰ˆ)
    // ==========================================
    c.submitWish = function() {
        if (!c.data.location) {
            showError("ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }
        if (!c.data.detail_loc || c.data.detail_loc.trim() === '') {
            showError("è©³ç´°ãªå ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }
        if (!c.data.category) {
            showError("æ”¯æ´å†…å®¹ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }
        if (!c.data.quantity || parseInt(c.data.quantity) < 1) {
            showError("æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }
        if (!c.data.urgency) {
            showError("ç·Šæ€¥åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }

        c.submitting = true;

        var inputData = {
    action: c.is_editing ? 'update_record' : 'submit_record',
    sys_id: c.ticket_sys_id,
    location: c.data.location,
    detail_loc: c.data.detail_loc,
    category: c.data.category,
    quantity: c.data.quantity,
    affected_count: c.data.affected_count,
    urgency: c.data.urgency,
    remarks: c.data.remarks,
    contact: c.data.contact,
    guest_token: c.guest_token || ''  // [æ–°å¢] æ¸¸å®¢token
};
			console.log(']]>ğŸ“¤<![CDATA[ æäº¤æ•°æ®ï¼Œguest_token:', inputData.guest_token); // æ·»åŠ è°ƒè¯•æ—¥å¿—


        safeServerGet(inputData).then(function(response) {
            if (!handleServerResponse(response, function(data) {
                    if (data.ticketNumber) {
                        c.ticket_number = data.ticketNumber;
                        c.ticket_sys_id = data.newRecordID || c.ticket_sys_id;
                    }

                    // [é‡è¦] ç¡®ä¿å®¢æˆ·ç«¯æ›´æ–°å†å²è®°å½•åˆ—è¡¨
                    if (data.my_requests) {
                        c.data.my_requests = data.my_requests;
                    }

                    if (c.fileData && c.ticket_sys_id) {
                        uploadFile(c.ticket_sys_id);
                    } else {
                        finishSubmit(c.ticket_sys_id);
                    }
                })) {
                c.submitting = false;
            }
        }).catch(function() {
            c.submitting = false;
            showError('é€ä¿¡å¤±æ•—');
        });
    };
	
	function finishSubmit(sysId) {
        c.submitting = false;
        c.is_editing = false;
        c.step = 5;

        updateVisualState(CONFIG.states.SUBMITTED);
        
        c.server.get({
    action: 'get_my_history',
    guest_token: c.guest_token // <--- æ·»åŠ è¿™ä¸€è¡Œ
}).then(function(r) {
            if (r && r.data && r.data.my_requests) {
                // ã€ä¿®å¤ã€‘ä½¿ç”¨ evalAsync å®‰å…¨æ›´æ–°
                $scope.$evalAsync(function() {
                    c.data.my_requests = r.data.my_requests;
                    console.log("å‰ç«¯å·²æ”¶åˆ°å†å²è®°å½•:", c.data.my_requests.length);
                });
            }
        });

        if (sysId) initRecordWatcher(sysId);
        showSuccess('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼');
		NotificationManager.show(
    ']]>ğŸ“¨<![CDATA[ ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å®Œäº†',
    'ID: ' + c.ticket_number + ' - ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã®ç¢ºèªã‚’ãŠå¾…ã¡ãã ã•ã„',
    'success'
);
    }

    

    // ==========================================
    // æ–‡ä»¶ä¸Šä¼ 
    // ==========================================
    c.uploadFiles = function(files) {
        if (!files || !files.length) return;
        var file = files[0];
        var allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (allowedTypes.indexOf(file.type) === -1) {
            showError('JPEGã€PNGã€GIFã€WebPå½¢å¼ã®ç”»åƒã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™');
            return;
        }
        var maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            showError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
            return;
        }
        c.files = file;
        var reader = new FileReader();
        reader.onload = function(e) {
            $scope.$apply(function() {
                c.fileData = e.target.result;
            });
        };
        reader.readAsDataURL(file);
    };

    c.clearFile = function() {
        c.files = null;
        c.fileData = null;
        var input = document.querySelector('input[type="file"]');
        if (input) input.value = '';
    };

    function uploadFile(sysId) {
        c.server.get({
            action: 'upload_attachment',
            sys_id: sysId,
            table: 'x_1821654_kokoro_0_silent_wish',
            file_name: c.files.name,
            file_data: c.fileData,
            content_type: c.files.type
        }).then(function() {
            finishSubmit(sysId);
        }).catch(function() {
            showError('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—');
            finishSubmit(sysId);
        });
    }

    // ==========================================
    // çŠ¶æ€æ˜ å°„ä¸æ›´æ–°é€»è¾‘
    // ==========================================
    var PROGRESS_MAP = {
        1: 0,
        10: 1,
        11: 2,
        2: 3,
        4: 4,
        5: -1,
        6: 1
    };

    c.visual_step = 0;

    function updateVisualState(stateVal) {
        stateVal = parseInt(stateVal);
        c.current_state_val = stateVal;
        if (PROGRESS_MAP.hasOwnProperty(stateVal)) {
            c.visual_step = PROGRESS_MAP[stateVal];
        } else {
            c.visual_step = 0;
        }
        if (c.statusDetails[stateVal]) {
            c.status_message = c.statusDetails[stateVal].desc;
        }
    }

    // ==========================================
    // å®æ—¶ç›‘å¬
    // ==========================================
    function initRecordWatcher(sysId) {
        spUtil.recordWatch($scope, 'x_1821654_kokoro_0_silent_wish', "sys_id=" + sysId, function(name, data) {
            if (!data || !data.record) return;
            $timeout(function() {
                if (data.record.state) {
                    updateVisualState(data.record.state.value);
									var newState = parseInt(data.record.state.value);
var stateInfo = c.statusDetails[newState];
if (stateInfo) {
    var notifType = 'info';
    if (newState === 4) notifType = 'success';
    if (newState === 2) notifType = 'warning';
    
    NotificationManager.show(
        stateInfo.icon + ' ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°',
        stateInfo.title + ' - ' + stateInfo.desc,
        notifType
    );
}
                }
                if (data.record.assigned_to) {
                    c.assigned_to = data.record.assigned_to.display_value;
                }
            });
        });
    }

    // ==========================================
    // é‡ç½®
    // ==========================================
    c.reset = function() {
        c.step = 0;
        c.data.category = "";
        c.data.remarks = "";
        c.data.quantity = "";
        c.data.urgency = "";
        c.data.detail_loc = "";
        c.data.location = "";
        c.data.affected_count = "";
        c.is_editing = false;
        c.ticket_number = "";
        c.assigned_to = null;
        c.ticket_sys_id = null;
        c.files = null;
        c.fileData = null;
        c.show_will_input = false;
        c.digital_will = "";
        c.current_state_val = 0;
        c.status_message = "å¾…æ©Ÿä¸­...";

        var slime = document.getElementById('the-slime');
        if (slime) slime.classList.remove('happy-slime');
    };

    // ==========================================
    // è®¾ç½®é¢æ¿
    // ==========================================
    c.toggleSettings = function() {
    c.showMenu = false;  // å…³é—­æ±‰å ¡èœå•
    c.showSettings = !c.showSettings;
    if (c.showSettings) {
        c.temp_settings = {
            email: c.data.emergency_email || "",
            medical_info: c.data.medical_info || "",
            blood_type: c.data.blood_type || "",
            will: c.data.saved_will || ""
        };
    }
};

    c.saveSettings = function() {
        if (!c.temp_settings.email || c.temp_settings.email.trim() === '') {
            showError('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(c.temp_settings.email)) {
            showError('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        c.saving = true;
        safeServerGet({
    action: 'save_settings',
            email: c.temp_settings.email,
            medical_info: c.temp_settings.medical_info,
            blood_type: c.temp_settings.blood_type,
            will: c.temp_settings.will
        }).then(function(response) {
            c.saving = false;
            if (handleServerResponse(response, function() {
                    c.data.emergency_email = c.temp_settings.email;
                    c.data.medical_info = c.temp_settings.medical_info;
                    c.data.blood_type = c.temp_settings.blood_type;
                    c.data.saved_will = c.temp_settings.will;
                    c.showSettings = false;
                    showSuccess('å®‰å…¨è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                }));
        }).catch(function() {
            c.saving = false;
            showError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    };
	 // ==========================================
// å†å²è®°å½•é€»è¾‘ (å®Œæ•´ä¿®å¤ç‰ˆ - é¿å… digest cycle é”™è¯¯)
// ==========================================
c.show_history = false;

c.toggleHistory = function() {
    c.showMenu = false;  // å…³é—­æ±‰å ¡èœå•
    c.show_history = !c.show_history;
    
    if (c.show_history) {
        // ]]>ğŸ”§<![CDATA[ ä½¿ç”¨ $timeout é¿å… $digest cycle å†²çª
        $timeout(function() {
            c.server.get({
                action: 'get_my_history',
                guest_token: c.guest_token || ''
            }).then(function(r) {
                if (r && r.data && r.data.my_requests) {
                    // ç›´æ¥èµ‹å€¼ï¼ŒAngularä¼šè‡ªåŠ¨æ£€æµ‹
                    c.data.my_requests = r.data.my_requests;
                    console.log('âœ… å†å²è®°å½•å·²åŠ è½½ï¼Œæ•°é‡:', c.data.my_requests.length);
                } else {
                    console.warn('âš ï¸ æœªæ”¶åˆ°å†å²è®°å½•æ•°æ®');
                }
            }).catch(function(error) {
                console.error('âŒ åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
            });
        }, 0);
    }
};

c.loadTicket = function(item) {
    c.show_history = false;
    c.ticket_sys_id = item.sys_id;
    c.ticket_number = item.number;
    c.data.location = item.location;
    c.data.detail_loc = item.detail_loc;
    c.data.category = item.category;
    c.data.quantity = item.quantity;
    c.data.urgency = item.urgency;
    c.data.remarks = item.remarks;

    updateVisualState(item.state);
    initRecordWatcher(c.ticket_sys_id);
    c.step = 5;
    
    var slime = document.getElementById('the-slime');
    if (slime) slime.classList.add('happy-slime');
};

    
	// ==========================================
// è´¦æˆ·å‡çº§ (æ¸¸å®¢ â†’ æ³¨å†Œç”¨æˆ·)
// ==========================================
c.upgradeAccount = function() {
    if (!c.guest_token) {
        showError('ã‚²ã‚¹ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    c.server.get({
        action: 'upgrade_guest_account',
        guest_token: c.guest_token
    }).then(function(r) {
        if (handleServerResponse(r, function(data) {
            c.is_guest = false;
            c.auth_mode = 'authenticated';
            c.guest_token = '';
            
            try {
                $window.localStorage.removeItem('kokoro_guest_token');
            } catch (e) {}
            
            showSuccess(data.message || 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç§»è¡Œã—ã¾ã—ãŸ');
            
            // åˆ·æ–°æ•°æ®
            c.server.get({
                action: 'get_my_history'
            }).then(function(historyR) {
                if (historyR && historyR.data && historyR.data.my_requests) {
                    c.data.my_requests = historyR.data.my_requests;
                }
            });
        }));
    });
};

// ==========================================
// å¥½å‹éªŒè¯ç  (ç¾åé¢å¯¹é¢)
// ==========================================
c.show_friend_code = false;
c.my_friend_code = '';
c.friend_code_input = '';

c.generateFriendCode = function() {
    safeServerGet({
    action: 'generate_friend_code'
    }).then(function(r) {
        if (handleServerResponse(r, function(data) {
            c.my_friend_code = data.friend_code;
            c.show_friend_code = true;
        }));
    });
};

c.verifyFriendCode = function() {
    if (!c.friend_code_input || c.friend_code_input.length !== 6) {
        showError('6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    safeServerGet({
    action: 'verify_friend_code',
        code: c.friend_code_input
    }).then(function(r) {
        if (handleServerResponse(r, function(data) {
            c.friend_code_input = '';
            c.show_friend_code = false;
            showSuccess(data.message);
            c.loadGuardianData();
        }));
    });
};
	
$scope.$on('$destroy', function() {
    $window.removeEventListener('mousemove', handleMouseMove);
    $window.removeEventListener('online', updateNetworkStatus);
    $window.removeEventListener('offline', updateNetworkStatus);
    if (eyeAnimationFrame) {
        cancelAnimationFrame(eyeAnimationFrame);
    }
});
 
};]]></client_script>
        <controller_as>c</controller_as>
        <css>@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&amp;family=M+PLUS+Rounded+1c:wght@400;500;700;800&amp;display=swap');

/* ============================================================
   KOKORO USER - Widget CSS (Refugee Mode)
   Version: 3.4 (Heartbeat &amp; Texture Fix)
   ============================================================ */

/* ==========================================
   1. å¼ºåˆ¶éšè—ServiceNowæ‰€æœ‰å…ƒç´  (ä¿æŒä¸å˜)
   ========================================== */
html body nav.navbar,
html body .navbar,
html body .navbar-inverse,
html body .navbar-default,
html body .navbar-header,
html body .sp-page-header,
html body header,
html body footer,
html body .sp-footer,
html body .footer,
html body .row.marketing-header,
html body #survey_plugin_container,
html body .navpage-header,
html body .navpage-header-content,
html body .sn-widget-textblock-body,
html body .breadcrumb-container,
html body [role="banner"],
html body .navbar-fixed-top,
html body .sp-row-background,
html body #gsft_main ~ header,
html body .polaris-navigation,
body &gt; nav,
body &gt; header,
body &gt; footer,
#gsft_main &gt; nav,
.sp-page-root &gt; nav,
.sp-page-root &gt; header {
  display: none !important;
  visibility: hidden !important;
  height: 0 !important;
  min-height: 0 !important;
  max-height: 0 !important;
  overflow: hidden !important;
  opacity: 0 !important;
  pointer-events: none !important;
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
  position: absolute !important;
  top: -9999px !important;
  left: -9999px !important;
}

html body,
html body .sp-page-root,
html body #sp-nav-bar {
  padding-top: 0 !important;
  margin-top: 0 !important;
}

/* ==========================================
   2. ä¸»å®¹å™¨ - èƒŒæ™¯ (ä¿æŒä¸å˜)
   ========================================== */
.kokoro-user-container {
  font-family: "M PLUS Rounded 1c", sans-serif;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 999999 !important;
  overflow: hidden;
  background: linear-gradient(180deg, #ffe4e1 0%, #fff0f0 40%, #fdf8f8 100%) !important;
}

/* ==========================================
   3. å²è±å§†èˆå° (ä¿æŒä¸å˜)
   ========================================== */
.slime-stage {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  pointer-events: none;
  z-index: 1;
}

/* ==========================================
   4. å²è±å§† - é¢œè‰²ä¸åŠ¨ç”» (ä¿®æ”¹åŒºåŸŸ)
   ========================================== */
.kokoro-slime {
  width: 260px; /* ä½¿ç”¨ä½ æä¾›çš„å®½åº¦ */
  height: 240px; /* ä½¿ç”¨ä½ æä¾›çš„é«˜åº¦ */
  
/* [ä¿®æ”¹ç‚¹] åŠ é‡äº†è¤è‰²è°ƒï¼Œå‡å°‘äº†æ³›ç™½ï¼Œå‘ˆç°å‡ºâ€œåšæ—§/è¤è‰²ç°â€çš„è´¨æ„Ÿ */
  background: radial-gradient(circle at 30% 30%, #f5f0ef 0%, #d6c4bf 50%, #9e8982 100%);
  
  /* [ä¿®æ”¹ç‚¹] é˜´å½±ä¹ŸåŒæ­¥åŠ æ·±ä¸ºæš–è¤è‰²ï¼Œå¢åŠ ä½“ç§¯æ„Ÿ */
  box-shadow: 
    0 20px 50px rgba(120, 100, 95, 0.4),
    inset 5px 5px 30px rgba(255, 255, 255, 0.6);
    
  border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
  animation: slimeMorph 8s ease-in-out infinite;
  
  position: relative;
  margin-bottom: 280px;
  transform-origin: center bottom;
  cursor: pointer;
  pointer-events: auto !important;
  z-index: 100;
  
  transition: all 0.5s ease;
}
  
  /* é¢œè‰²è¿‡æ¸¡ */
  transition: all 0.5s ease;
}

/* ==========================================
   [æ–°å¢] æ±‰å ¡èœå•æ ·å¼
   ========================================== */

/* 1. æ‚¬æµ®æŒ‰é’® (å·¦ä¸Šè§’) */
.kokoro-menu-btn {
  position: absolute;
  top: 20px;
  left: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  box-shadow: 0 8px 20px rgba(93, 64, 55, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1.4rem;
  color: #880e4f;
  cursor: pointer;
  z-index: 2001; /* å¿…é¡»æ¯”é®ç½©å±‚é«˜ */
  transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.kokoro-menu-btn:hover {
  background: #fff;
  transform: scale(1.1);
  box-shadow: 0 10px 25px rgba(233, 30, 99, 0.25);
}

.kokoro-menu-btn.active {
  background: #fff;
  color: #ec407a;
  transform: rotate(90deg);
}

/* 2. ä¸‹æ‹‰èœå•å®¹å™¨ */
.kokoro-menu-dropdown {
  position: absolute;
  top: 85px; /* åœ¨æŒ‰é’®ä¸‹æ–¹ */
  left: 20px;
  width: 260px;
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 24px;
  padding: 12px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
  z-index: 2000;
  animation: menuSlideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  transform-origin: top left;
}

/* 3. èœå•é¡¹ */
.menu-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  margin-bottom: 6px;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.menu-item:last-child {
  margin-bottom: 0;
}

.menu-item:hover {
  background: rgba(255, 240, 245, 0.8); /* æµ…ç²‰è‰²èƒŒæ™¯ */
}

/* å›¾æ ‡ */
.icon-box {
  width: 36px;
  height: 36px;
  background: #fff;
  border-radius: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #ec407a;
  font-size: 1.1rem;
  margin-right: 14px;
  box-shadow: 0 4px 10px rgba(233, 30, 99, 0.1);
}

/* æ–‡å­— */
.text-box {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.menu-title {
  font-weight: 800;
  color: #5d4037;
  font-size: 0.95rem;
}

.menu-sub {
  font-size: 0.7rem;
  color: #90a4ae;
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* æ•°å­—è§’æ ‡ */
.badge-pill {
  background: #ff80ab;
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: 700;
}

/* ç®¡ç†è€…é«˜äº®æ ·å¼ */
.menu-item.highlight {
  background: linear-gradient(135deg, #fff3e0, #ffe0b2);
}
.menu-item.highlight .icon-box {
  color: #ff6f00;
}

/* 4. ç‚¹å‡»ç©ºç™½å…³é—­èœå•çš„é®ç½© */
.menu-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: transparent; /* é€æ˜ï¼Œä¸å¦¨ç¢è§†è§‰ï¼Œåªæ‹¦æˆªç‚¹å‡» */
  z-index: 1999;
}

/* ==========================================
   å®ˆæŠ¤åœˆ (Guardian Circle) æ ·å¼
   ========================================== */

/* é€šçŸ¥è§’æ ‡ - çº¢è‰²è­¦å‘Š */
.badge-alert {
  background: #ff5252 !important;
  animation: badgePulse 2s infinite;
}

@keyframes badgePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.15); }
}

/* ä¸»å¼¹çª—å®¹å™¨ */
.guardian-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(93, 64, 55, 0.35);
  backdrop-filter: blur(6px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 3000;
  animation: fadeIn 0.3s ease;
}

.guardian-card {
  background: #ffffff;
  width: 92%;
  max-width: 440px;
  max-height: 85vh;
  border-radius: 28px;
  box-shadow: 0 25px 60px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* æ¸å˜å¤´éƒ¨ */
.gradient-header {
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  padding: 22px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: white;
}

.gradient-header h3 {
  margin: 0;
  font-size: 1.3rem;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 10px;
}

.gradient-header .close-btn {
  background: rgba(255,255,255,0.2);
  color: white;
  border: none;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  font-size: 1.3rem;
  cursor: pointer;
  transition: all 0.2s;
}

.gradient-header .close-btn:hover {
  background: rgba(255,255,255,0.35);
  transform: rotate(90deg);
}

/* æ ‡ç­¾æ  */
.tab-bar {
  display: flex;
  background: #fafafa;
  border-bottom: 2px solid #f0f0f0;
}

.tab-item {
  flex: 1;
  padding: 14px 10px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 600;
  color: #757575;
  font-size: 0.9rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  border-bottom: 3px solid transparent;
}

.tab-item i {
  font-size: 1.1rem;
}

.tab-item.active {
  color: #ec407a;
  background: white;
  border-bottom-color: #ec407a;
}

.tab-item:hover:not(.active) {
  background: #fff;
  color: #ec407a;
}

/* å†…å®¹åŒºåŸŸ */
.tab-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px 0;
  background: #fff;
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-state i {
  color: #e0e0e0;
  margin-bottom: 20px;
}

.empty-state p {
  font-size: 1rem;
  margin-bottom: 20px;
}

/* å¥½å‹åˆ—è¡¨ */
.friend-list {
  padding: 0 16px;
}

.friend-card {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  margin-bottom: 10px;
  background: #fafafa;
  border-radius: 18px;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
  position: relative;
}

.friend-card:hover {
  background: #fff5f8;
  border-color: #f8bbd0;
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(236, 64, 122, 0.1);
}

/* å¤´åƒå®¹å™¨ */
.friend-avatar-wrapper {
  position: relative;
  margin-right: 14px;
  flex-shrink: 0;
}

.friend-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ff9a9e, #fad0c4);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.3rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* çŠ¶æ€ç‚¹ */
.status-dot {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 3px solid #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.status-dot.online {
  background: #4caf50;
}

.status-dot.warning {
  background: #ff9800;
  animation: warningPulse 2s infinite;
}

.status-dot.critical {
  background: #f44336;
  animation: criticalPulse 1s infinite;
}

.status-dot.offline {
  background: #9e9e9e;
}

/* è„‰å†²åŠ¨ç”» */
.pulse-ring {
  position: absolute;
  top: -3px;
  left: -3px;
  right: -3px;
  bottom: -3px;
  border-radius: 50%;
  border: 2px solid currentColor;
  animation: ringPulse 2s infinite;
  opacity: 0;
}

.status-dot.critical .pulse-ring {
  border-color: #f44336;
}

@keyframes ringPulse {
  0% { transform: scale(0.8); opacity: 0.8; }
  100% { transform: scale(1.5); opacity: 0; }
}

@keyframes warningPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.15); }
}

@keyframes criticalPulse {
  0%, 100% { transform: scale(1); box-shadow: 0 2px 6px rgba(244,67,54,0.3); }
  50% { transform: scale(1.2); box-shadow: 0 4px 12px rgba(244,67,54,0.6); }
}

/* å¥½å‹ä¿¡æ¯ */
.friend-info {
  flex: 1;
  min-width: 0;
}

.friend-name {
  font-weight: 800;
  color: #333;
  font-size: 1.05rem;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.friend-badge {
  background: #fff3e0;
  color: #f57c00;
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 0.7rem;
  font-weight: 700;
}

.friend-status-text,
.friend-location {
  font-size: 0.85rem;
  color: #757575;
  margin-top: 3px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.friend-location {
  color: #ec407a;
  font-weight: 600;
}

/* å¿«æ·æŒ‰é’® */
.friend-actions {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

.icon-btn {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: none;
  background: #fff;
  color: #757575;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 1.1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.icon-btn:hover {
  transform: scale(1.1);
}

.message-btn:hover {
  background: #e1f5fe;
  color: #0288d1;
}

.emergency-btn {
  background: #ffebee;
  color: #f44336;
  animation: emergencyShake 2s infinite;
}

.emergency-btn:hover {
  background: #f44336;
  color: white;
}

@keyframes emergencyShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  75% { transform: translateX(3px); }
}

/* å¥½å‹è¯·æ±‚å¡ç‰‡ */
.request-list {
  padding: 0 16px;
}

.request-card {
  display: flex;
  align-items: center;
  padding: 16px;
  margin-bottom: 12px;
  background: #fff5f8;
  border-radius: 18px;
  border: 2px solid #fce4ec;
  animation: slideIn 0.3s ease;
}

.request-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.3rem;
  margin-right: 14px;
  flex-shrink: 0;
}

.request-info {
  flex: 1;
  min-width: 0;
}

.request-name {
  font-weight: 800;
  color: #333;
  font-size: 1rem;
  margin-bottom: 4px;
}

.request-time {
  font-size: 0.8rem;
  color: #999;
  margin-bottom: 6px;
}

.request-message {
  font-size: 0.9rem;
  color: #666;
  font-style: italic;
  padding: 8px 12px;
  background: rgba(255,255,255,0.6);
  border-radius: 10px;
  margin-top: 6px;
}

.request-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex-shrink: 0;
}

.btn-accept,
.btn-reject {
  padding: 8px 16px;
  border-radius: 16px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.btn-accept {
  background: #4caf50;
  color: white;
}

.btn-accept:hover {
  background: #45a049;
  transform: scale(1.05);
}

.btn-reject {
  background: #fff;
  color: #f44336;
  border: 2px solid #ffcdd2;
}

.btn-reject:hover {
  background: #ffebee;
}

/* æœç´¢æ¡† */
.search-box {
  margin: 16px;
  position: relative;
}

.search-box i {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  color: #999;
  font-size: 1.1rem;
}

.search-input {
  width: 100%;
  padding: 14px 20px 14px 50px;
  border: 2px solid #f0f0f0;
  border-radius: 24px;
  font-size: 1rem;
  outline: none;
  transition: all 0.2s;
  font-family: inherit;
}

.search-input:focus {
  border-color: #ec407a;
  box-shadow: 0 0 0 4px rgba(236,64,122,0.1);
}

/* æœç´¢ç»“æœ */
.search-results {
  padding: 0 16px;
  margin-top: 10px;
}

.search-item {
  display: flex;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  background: #fafafa;
  border-radius: 16px;
  transition: all 0.2s;
}

.search-item:hover {
  background: #f5f5f5;
}

.search-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: linear-gradient(135deg, #90caf9, #64b5f6);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.2rem;
  margin-right: 12px;
  flex-shrink: 0;
}

.search-info {
  flex: 1;
  min-width: 0;
}

.search-name {
  font-weight: 700;
  color: #333;
  font-size: 0.95rem;
}

.search-email,
.search-hint {
  font-size: 0.8rem;
  color: #999;
  margin-top: 2px;
}

.btn-add-friend {
  padding: 8px 18px;
  border-radius: 18px;
  border: none;
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  color: white;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}

.btn-add-friend:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(236,64,122,0.3);
}

.btn-add-friend:disabled {
  background: #e0e0e0;
  color: #999;
  cursor: not-allowed;
}

/* æ¨èåŒºåŸŸ */
.recommended-section {
  margin-top: 24px;
  padding: 0 16px;
}

.section-title {
  font-size: 0.9rem;
  font-weight: 800;
  color: #757575;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* å¥½å‹è¯¦æƒ…å¼¹çª— */
.friend-detail-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(93, 64, 55, 0.45);
  backdrop-filter: blur(8px);
  z-index: 3100;
  animation: fadeIn 0.3s ease;
  display: flex;
  justify-content: center;
  align-items: center;
}

.friend-detail-card {
  background: white;
  width: 90%;
  max-width: 400px;
  max-height: 85vh;
  border-radius: 28px;
  padding: 24px;
  overflow-y: auto;
  box-shadow: 0 30px 70px rgba(0,0,0,0.2);
  animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
}

.back-btn {
  position: absolute;
  top: 20px;
  left: 20px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.9);
  border: 2px solid #f0f0f0;
  color: #333;
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  z-index: 10;
}

.back-btn:hover {
  background: #f5f5f5;
  transform: scale(1.1);
}

.detail-header {
  text-align: center;
  padding-top: 20px;
  margin-bottom: 24px;
}

.detail-avatar-large {
  width: 90px;
  height: 90px;
  margin: 0 auto 16px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ff9a9e, #fad0c4);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 2.5rem;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  position: relative;
}

.status-indicator {
  position: absolute;
  bottom: 5px;
  right: 5px;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 4px solid white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.status-indicator.online { background: #4caf50; }
.status-indicator.warning { background: #ff9800; }
.status-indicator.critical { background: #f44336; }
.status-indicator.offline { background: #9e9e9e; }

.detail-header h3 {
  font-size: 1.4rem;
  margin: 0 0 8px 0;
  color: #333;
}

.detail-status-text {
  color: #757575;
  font-size: 0.95rem;
}

/* ç»Ÿè®¡ä¿¡æ¯ */
.detail-stats {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
}

.stat-item {
  flex: 1;
  background: #fafafa;
  padding: 14px;
  border-radius: 16px;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.stat-item i {
  font-size: 1.3rem;
  color: #ec407a;
  margin-bottom: 4px;
}

.stat-item span {
  font-size: 0.75rem;
  color: #999;
  text-transform: uppercase;
}

.stat-item strong {
  font-size: 0.9rem;
  color: #333;
  font-weight: 700;
}

/* è¯¦æƒ…æ“ä½œæŒ‰é’® */
.detail-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 24px;
}

.btn-action-large {
  width: 100%;
  padding: 14px 20px;
  border-radius: 20px;
  border: none;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-family: inherit;
}

.btn-action-large.primary {
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  color: white;
  box-shadow: 0 6px 16px rgba(236,64,122,0.3);
}

.btn-action-large.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(236,64,122,0.4);
}

.btn-action-large.emergency {
  background: linear-gradient(135deg, #f44336, #e57373);
  color: white;
  box-shadow: 0 6px 16px rgba(244,67,54,0.3);
}

.btn-action-large.emergency:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(244,67,54,0.4);
}

.btn-action-large:not(.primary):not(.emergency) {
  background: #fafafa;
  color: #333;
  border: 2px solid #f0f0f0;
}

.btn-action-large:not(.primary):not(.emergency):hover {
  background: #f5f5f5;
}

/* è®¾ç½®é¡¹ */
.detail-settings {
  background: #fafafa;
  border-radius: 18px;
  padding: 16px;
  margin-bottom: 16px;
}

.setting-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #f0f0f0;
}

.setting-item:last-child {
  border-bottom: none;
}

.setting-item span {
  font-weight: 600;
  color: #333;
  font-size: 0.95rem;
}

/* Toggleå¼€å…³ */
.toggle-switch {
  position: relative;
  width: 48px;
  height: 26px;
  display: inline-block;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 26px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #ec407a;
}

input:checked + .slider:before {
  transform: translateX(22px);
}

/* åˆ é™¤æŒ‰é’® */
.btn-danger-outline {
  width: 100%;
  padding: 12px;
  border-radius: 18px;
  border: 2px solid #ffcdd2;
  background: white;
  color: #f44336;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-family: inherit;
}

.btn-danger-outline:hover {
  background: #ffebee;
  border-color: #f44336;
}

/* ä¸»è¦æŒ‰é’®ï¼ˆç©ºçŠ¶æ€ï¼‰ */
.btn-primary-small {
  padding: 10px 24px;
  border-radius: 20px;
  border: none;
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  color: white;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
}

.btn-primary-small:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(236,64,122,0.3);
}

/* å“åº”å¼ */
@media (max-width: 480px) {
  .guardian-card {
    width: 96%;
    max-height: 90vh;
  }
  
  .friend-card {
    padding: 12px;
  }
  
  .friend-avatar {
    width: 44px;
    height: 44px;
    font-size: 1.1rem;
  }
  
  .status-dot {
    width: 14px;
    height: 14px;
  }
}

/* åŠ¨ç”» */
@keyframes menuSlideIn {
  from { opacity: 0; transform: scale(0.8) translateY(-20px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

/* ==========================================
   KOKORO CSS ä¿®å¤æ•´åˆç‰ˆ
   ========================================== */

/* ------------------------------------------
   1. æ±‰å ¡èœå•æ ·å¼ (Menu)
   ------------------------------------------ */
.kokoro-menu-btn {
  position: absolute;
  top: 20px;
  left: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  box-shadow: 0 8px 20px rgba(93, 64, 55, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1.4rem;
  color: #880e4f;
  cursor: pointer;
  z-index: 2001; /* å¿…é¡»æ¯”é®ç½©é«˜ */
  transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.kokoro-menu-btn:hover {
  background: #fff;
  transform: scale(1.1);
  box-shadow: 0 10px 25px rgba(233, 30, 99, 0.25);
}

.kokoro-menu-btn.active {
  background: #fff;
  color: #ec407a;
  transform: rotate(90deg);
}

/* ä¸‹æ‹‰èœå•å®¹å™¨ */
.kokoro-menu-dropdown {
  position: absolute;
  top: 85px;
  left: 20px;
  width: 260px;
  background: rgba(255, 255, 255, 0.95); /* ç¨å¾®ä¸é€æ˜ä¸€ç‚¹ï¼Œé˜²å¹²æ‰° */
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 24px;
  padding: 12px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.6);
  z-index: 2000;
  animation: menuSlideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  transform-origin: top left;
}

/* èœå•é¡¹ */
.menu-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  margin-bottom: 6px;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.menu-item:last-child { margin-bottom: 0; }
.menu-item:hover { background: rgba(255, 240, 245, 0.8); }

.icon-box {
  width: 36px;
  height: 36px;
  background: #fff;
  border-radius: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #ec407a;
  font-size: 1.1rem;
  margin-right: 14px;
  box-shadow: 0 4px 10px rgba(233, 30, 99, 0.1);
}

.text-box { flex: 1; display: flex; flex-direction: column; }
.menu-title { font-weight: 800; color: #5d4037; font-size: 0.95rem; }
.menu-sub { font-size: 0.7rem; color: #90a4ae; text-transform: uppercase; font-weight: 600; }
.badge-pill { background: #ff80ab; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; }
.menu-item.highlight { background: linear-gradient(135deg, #fff3e0, #ffe0b2); }
.menu-item.highlight .icon-box { color: #ff6f00; }

.menu-backdrop {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: transparent; z-index: 1999;
}

@keyframes menuSlideIn {
  from { opacity: 0; transform: scale(0.8) translateY(-20px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}


/* ------------------------------------------
   2. ç”³è¯·å±¥å†å¼¹çª—æ ·å¼ (History Overlay)
   è¿™æ˜¯ä½ ä¹‹å‰ç¼ºå¤±çš„éƒ¨åˆ†ï¼ä¸€å®šè¦åŠ ä¸Šï¼
   ------------------------------------------ */
.history-overlay {
  position: fixed; /* å…³é”®ï¼šå›ºå®šå®šä½ */
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(93, 64, 55, 0.3); /* é®ç½©å±‚èƒŒæ™¯ */
  backdrop-filter: blur(4px);
  display: flex; 
  justify-content: center; 
  align-items: center;
  z-index: 3000; /* å…³é”®ï¼šå±‚çº§å¿…é¡»æ¯”èœå•(2000)é«˜ */
  animation: fadeIn 0.3s ease;
}

.history-card {
  background: #ffffff;
  width: 90%;
  max-width: 420px;
  border-radius: 24px;
  box-shadow: 0 25px 50px rgba(0,0,0,0.2);
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border: 2px solid #fff0f5;
  animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.history-card .card-header {
  background: linear-gradient(to right, #fff0f5, #fff);
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #fce4ec;
}

.history-card .card-header h3 {
  margin: 0;
  color: #880e4f;
  font-size: 1.2rem;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 10px;
}

.history-card .close-btn {
  background: #f8bbd0;
  color: #880e4f;
  border: none;
  width: 32px; height: 32px;
  border-radius: 50%;
  font-size: 1.2rem;
  line-height: 1;
  cursor: pointer;
  display: flex; justify-content: center; align-items: center;
  transition: all 0.2s;
}
.history-card .close-btn:hover { background: #ec407a; color: white; transform: rotate(90deg); }

.history-list { overflow-y: auto; padding: 10px 0; background: #fff; }

.history-item {
  display: flex; align-items: center;
  padding: 16px 24px;
  border-bottom: 1px dashed #fce4ec;
  cursor: pointer; transition: 0.2s;
}
.history-item:last-child { border-bottom: none; }
.history-item:hover { background: #fff5f8; padding-left: 28px; }

.item-icon {
  font-size: 1.4rem; margin-right: 15px;
  width: 40px; height: 40px;
  background: #fce4ec; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: #ec407a;
}
.item-info { flex: 1; display: flex; flex-direction: column; }
.item-cat { font-weight: 700; color: #5d4037; font-size: 1rem; }
.item-date { font-size: 0.75rem; color: #90a4ae; margin-top: 4px; }

.item-status { 
  font-size: 0.75rem; font-weight: 700;
  padding: 4px 10px; border-radius: 12px; 
  background: #eceff1; color: #546e7a;
}
.status-1 { background: #e3f2fd; color: #1976d2; }
.status-10 { background: #e8f5e9; color: #2e7d32; }
.status-4 { background: #fff3e0; color: #f57c00; }

/* çœ¼ç› */
.slime-eyes {
  position: absolute;
  top: 40%;
  left: 50%;
  margin-left: -35px; /* ä½¿ç”¨ä½ æä¾›çš„åç§» */
  width: 70px; /* ä½¿ç”¨ä½ æä¾›çš„å®½åº¦ */
  height: 15px; /* ä½¿ç”¨ä½ æä¾›çš„é«˜åº¦ */
  transition: transform 0.15s ease-out;
}

.slime-eyes::before,
.slime-eyes::after {
  content: '';
  position: absolute;
  top: 0;
  width: 14px; /* ä½¿ç”¨ä½ æä¾›çš„å°ºå¯¸ */
  height: 14px; /* ä½¿ç”¨ä½ æä¾›çš„å°ºå¯¸ */
  background: #5d4037;
  border-radius: 50%;
  animation: blink 4s infinite;
}

.slime-eyes::before { left: 0; }
.slime-eyes::after { right: 0; }

/* éšè—å˜´å·´ (æ ¹æ®ä½ æä¾›çš„ä»£ç ) */
.slime-mouth { display: none !important; }

/* äº¤äº’çŠ¶æ€ï¼šHover (æ¢å¤ç²‰è‰²) */
.kokoro-slime:hover {
  /* æ¢å¤åŸæœ¬çš„ç²‰è‰²æ¸å˜ (æ ¹æ®ä½ æä¾›çš„ä»£ç ) */
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), #ff9a9e);
  
  /* æ¢å¤åŸæœ¬çš„é²œäº®é˜´å½± (æ ¹æ®ä½ æä¾›çš„ä»£ç ) */
  box-shadow: 
    0 15px 50px rgba(255, 150, 150, 0.4),
    inset 5px 5px 30px rgba(255, 255, 255, 0.8);
    
  filter: saturate(1.1);
  transform: scale(1.02);
}

/* äº¤äº’çŠ¶æ€ï¼šè¢«æˆ³ä¸­ (Poked) */
.kokoro-slime.poked {
  animation: gentleHeartbeat 0.6s ease-in-out forwards !important;
  
  /* ç¡®ä¿è¢«æˆ³ä¸­æ—¶ä¹Ÿæ˜¯ç²‰è‰² */
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), #ff9a9e);
  box-shadow: 
    0 15px 50px rgba(255, 150, 150, 0.4),
    inset 5px 5px 30px rgba(255, 255, 255, 0.8);

  /* ç¨å¾®åŠ æ·±ç²‰è‰²ï¼Œé¿å…æ³›ç™½ */
  filter: saturate(1.35) contrast(1.05);
}

/* çŠ¶æ€ï¼šé¥¥é¥¿/ä¼‘çœ  (ä¿æŒç°è¤è‰²è´¨æ„Ÿ) */
.kokoro-slime.hungry-slime {
  /* ä½¿ç”¨å¸¦æœ‰è¤è‰²/æ£•è‰²è°ƒçš„æµ…ç°è¤è‰² */
  background: radial-gradient(circle at 30% 30%, #f8f6f4 0%, #e8e0da 50%, #c8b8b0 100%);
  box-shadow: 0 20px 50px rgba(160, 140, 130, 0.35), inset 5px 5px 30px rgba(255, 255, 255, 0.7);
  
  filter: saturate(0.4) brightness(0.95);
  transform: scale(0.9);
  animation: slimeMorph 10s ease-in-out infinite;
}

/* çŠ¶æ€ï¼šå¼€å¿ƒ (æäº¤å) */
.kokoro-slime.happy-slime {
  /* å¼€å¿ƒæ—¶å˜ä¸ºç²‰è‰² */
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), #ff9a9e);
  box-shadow: 0 15px 50px rgba(255, 150, 150, 0.4), inset 5px 5px 30px rgba(255, 255, 255, 0.8);
  
  /* å¿ƒè·³åŠ¨ç”» */
  animation: happyJump 1.5s ease-in-out infinite;
  filter: saturate(1.2) brightness(1.05);
}

/* ==========================================
   5. åŠ¨ç”»å…³é”®å¸§ (ä¿æŒä¸å˜ï¼Œä½¿ç”¨æ–°çš„happyJump)
   ========================================== */
@keyframes slimeMorph {
  0%, 100% {
    border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
    transform: translate(0, 0) scale(1);
  }
  33% {
    border-radius: 50% 60% 40% 70% / 50% 60% 40% 60%;
    transform: translate(8px, -5px) scale(1.02, 0.98);
  }
  66% {
    border-radius: 70% 40% 60% 30% / 70% 40% 60% 30%;
    transform: translate(-8px, 5px) scale(0.98, 1.02);
  }
}

@keyframes gentleHeartbeat {
  0% { transform: scale(1); }
  15% { transform: scale(1.08); }
  30% { transform: scale(1); }
  45% { transform: scale(1.08); }
  60% { transform: scale(1); }
  100% { transform: scale(1); }
}

@keyframes happyJump {
  0%, 100% { 
    transform: scale(1); 
  }
  50% { 
    transform: scale(1.06); 
  }
}

@keyframes blink {
  0%, 96%, 100% { transform: scaleY(1); }
  98% { transform: scaleY(0.1); }
}

@keyframes popIn {
  from { opacity: 0; transform: scale(0.5); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(0.9); }
}

/* ==========================================
   6. UIç»„ä»¶ (ä¿æŒåŸå¸ƒå±€ï¼Œé€‚é…æ–°é…è‰²) - ä»¥ä¸‹éƒ¨åˆ†å‡æ— ä¿®æ”¹
   ========================================== */

/* è®¾ç½®æŒ‰é’® */
.safety-settings-btn {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(4px);
  padding: 10px 16px;
  border-radius: 22px;
  border: 1px solid rgba(255, 255, 255, 0.9);
  color: #5d4037;
  font-weight: 700;
  font-size: 0.9rem;
  cursor: pointer;
  z-index: 200;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.safety-settings-btn:hover {
  background: #fff;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.safety-settings-btn i { color: #ec407a; }

/* ç®¡ç†è€…åˆ‡æ¢æŒ‰é’® */
.admin-switch {
  position: absolute;
  top: 20px;
  right: 20px;
  opacity: 0.5;
  cursor: pointer;
  font-size: 2rem;
  z-index: 200;
  color: #5d4037;
  transition: all 0.2s ease;
}

.admin-switch:hover { opacity: 1; }

/* æç¤ºæ–‡å­— */
.pulse-overlay {
  position: absolute;
  top: 15%;
  width: 100%;
  text-align: center;
  z-index: 5;
  animation: fadeIn 1.5s ease;
  pointer-events: none;
}

.pulse-title {
  font-size: 2.2rem;
  color: #5d4037;
  font-weight: 800;
  text-shadow: 0 4px 15px rgba(255, 255, 255, 0.9);
  letter-spacing: 2px;
}

.sub-text {
  font-size: 0.9rem;
  opacity: 0.7;
  font-weight: 600;
}

/* è¡¨å•å®¹å™¨ */
.form-stage {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10;
  overflow-y: auto;
  scroll-behavior: smooth;
  padding: 80px 20px 60px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.floating-header {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(12px);
  padding: 22px 28px;
  border-radius: 26px;
  margin-bottom: 24px;
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
  z-index: 5;
}

.form-title {
  font-size: 1.5rem;
  color: #ec407a;
  margin: 0 0 16px 0;
  text-align: center;
  font-weight: 800;
}

/* è¿›åº¦æŒ‡ç¤ºå™¨ */
.progress-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.progress-step {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #eceff1;
  color: #90a4ae;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.progress-step.active {
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  color: white;
  transform: scale(1.15);
  box-shadow: 0 6px 18px rgba(233, 30, 99, 0.4);
}

.progress-line {
  width: 40px;
  height: 5px;
  background: #eceff1;
  border-radius: 3px;
  transition: all 0.3s ease;
}

.progress-line.active {
  background: linear-gradient(90deg, #ec407a, #f48fb1);
}

/* è¡¨å•åŒ…è£… */
.form-wrapper {
  width: 100%;
  max-width: 520px;
}

.step-card {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(12px);
  border-radius: 30px;
  padding: 26px;
  margin-bottom: 22px;
  box-shadow: 0 10px 40px -10px rgba(255, 180, 180, 0.3);
  border: 2px solid rgba(255, 255, 255, 0.8);
  animation: slideUp 0.4s ease;
}

.big-label {
  display: block;
  font-size: 1.15rem;
  font-weight: 800;
  color: #4e342e;
  margin-bottom: 12px;
  margin-left: 4px;
}

.input-wrapper {
  position: relative;
  width: 100%;
}

.input-wrapper i.select-arrow {
  position: absolute;
  right: 22px;
  top: 50%;
  transform: translateY(-50%);
  color: #ff80ab;
  pointer-events: none;
  font-size: 1.2rem;
}

.big-input {
  width: 100%;
  height: 64px;
  background: #fff;
  border: 3px solid #fce4ec;
  border-radius: 32px;
  font-size: 1.15rem;
  font-weight: 500;
  color: #333;
  padding: 0 26px;
  outline: none;
  transition: all 0.25s ease;
  box-sizing: border-box;
  font-family: inherit;
}

.big-input:focus {
  border-color: #ff80ab;
  box-shadow: 0 0 0 5px rgba(255, 128, 171, 0.15);
}

select.big-input {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  padding-right: 55px;
  cursor: pointer;
}

.glass-textarea {
  width: 100%;
  min-height: 110px;
  background: #fff;
  border: 3px solid #fce4ec;
  border-radius: 22px;
  padding: 18px;
  font-size: 1.05rem;
  font-weight: 500;
  color: #333;
  outline: none;
  resize: vertical;
  font-family: inherit;
  transition: all 0.25s ease;
  box-sizing: border-box;
}

.glass-textarea:focus {
  border-color: #ff80ab;
  box-shadow: 0 0 0 5px rgba(255, 128, 171, 0.15);
}

.action-row {
  display: flex;
  gap: 16px;
  margin-top: 18px;
}

.flex-row {
  display: flex;
  gap: 16px;
  margin-bottom: 18px;
}

.half-col { flex: 1; }
.mb-3 { margin-bottom: 22px; }

.critical-bg {
  background-color: #ffebee !important;
  color: #c62828 !important;
  border-color: #ffcdd2 !important;
}

/* é™„ä»¶æŒ‰é’® */
.big-attach-btn {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: #fff;
  border: 3px solid #ff80ab;
  color: #ff80ab;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.25s ease;
  flex-shrink: 0;
}

.big-attach-btn:hover {
  background: #ff80ab;
  color: white;
  transform: scale(1.08);
}

/* æäº¤æŒ‰é’® */
.big-submit-btn {
  flex: 1;
  height: 64px;
  border-radius: 32px;
  background: linear-gradient(135deg, #ff80ab, #f8bbd0);
  color: #fff;
  font-size: 1.25rem;
  font-weight: 800;
  border: none;
  box-shadow: 0 12px 36px rgba(255, 150, 150, 0.35);
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  transition: all 0.25s ease;
  font-family: inherit;
}

.big-submit-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 16px 44px rgba(255, 150, 150, 0.45);
}

/* æˆåŠŸå¡ç‰‡ */
.success-card {
  width: 100%;
  max-width: 520px;
  background: rgba(255, 255, 255, 0.96);
  border-radius: 34px;
  padding: 32px;
  text-align: center;
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.1);
  border: 3px solid #fce4ec;
}

.success-title {
  font-size: 1.6rem;
  color: #ec407a;
  font-weight: 800;
  margin-bottom: 6px;
}

.ticket-id {
  font-family: 'Orbitron', monospace;
  color: #90a4ae;
  margin-bottom: 22px;
  font-weight: 600;
  font-size: 1rem;
}

/* çŠ¶æ€è¿½è¸ªå™¨ */
.status-tracker {
  display: flex;
  justify-content: space-between;
  margin: 26px 0;
  padding: 0 10px;
}

.status-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  opacity: 0.3;
  transition: all 0.35s ease;
}

.status-step .icon { font-size: 2rem; margin-bottom: 8px; }
.status-step .text { font-size: 0.75rem; font-weight: 800; }
.status-step.active { opacity: 1; transform: scale(1.12); }
.status-step.active .text { color: #d81b60; }

.status-tracker .line {
  flex-grow: 1;
  height: 5px;
  background: #eee;
  margin: 18px 8px 0;
  border-radius: 3px;
  transition: all 0.35s ease;
}

.status-tracker .line.active {
  background: linear-gradient(90deg, #ff9a9e, #f48fb1);
}

/* æ‘˜è¦å¡ç‰‡ */
.summary-card {
  background: #fafafa;
  border-radius: 22px;
  padding: 22px;
  text-align: left;
  margin-bottom: 22px;
}

.summary-card .row-item {
  margin-bottom: 12px;
  color: #37474f;
  font-size: 1rem;
  font-weight: 500;
  border-bottom: 1px dashed #e0e0e0;
  padding-bottom: 12px;
}

.summary-card .row-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.summary-card strong {
  font-weight: 800;
  margin-right: 8px;
  color: #5d4037;
}

.summary-card .badge {
  background: #e3f2fd;
  color: #1e88e5;
  padding: 4px 12px;
  border-radius: 10px;
  font-size: 0.9rem;
  font-weight: 700;
}

.summary-card .text-crit {
  color: #c62828;
  font-weight: 800;
}

/* å®æ—¶çŠ¶æ€ */
.live-status-pill {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  background: #e0f7fa;
  color: #006064;
  height: 60px;
  border-radius: 30px;
  font-weight: 800;
  font-size: 1.05rem;
  margin-bottom: 22px;
}

.pulse-dot {
  width: 12px;
  height: 12px;
  background: #00bcd4;
  border-radius: 50%;
  animation: pulse 1.5s infinite;
}

/* è¯¦æƒ…å¡ç‰‡ */
.status-detail-card {
  background: linear-gradient(135deg, #7c4dff 0%, #b388ff 100%);
  color: white;
  padding: 22px;
  border-radius: 22px;
  margin: 22px 0;
  text-align: center;
}

.status-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 10px;
}

.status-icon { font-size: 2.2rem; }

.status-detail-card .status-title {
  font-size: 1.4rem;
  font-weight: 800;
  margin: 0;
}

.status-desc {
  font-size: 1rem;
  opacity: 0.92;
  margin: 12px 0;
}

.status-next {
  font-size: 0.9rem;
  opacity: 0.8;
  font-style: italic;
}

/* æŒ‰é’®ç»„ */
.btn-group {
  display: flex;
  gap: 16px;
  justify-content: center;
}

.edit-btn, .big-reset-btn {
  flex: 1;
  height: 58px;
  border-radius: 29px;
  border: none;
  font-weight: 800;
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.25s ease;
  font-family: inherit;
}

.edit-btn {
  background: #fff;
  border: 2px solid #ff80ab;
  color: #ff80ab;
}

.edit-btn:hover {
  background: #ff80ab;
  color: white;
}

.big-reset-btn {
  background: #eceff1;
  color: #546e7a;
}

.big-reset-btn:hover {
  background: #cfd8dc;
}

/* é—è¨€è¦†ç›–å±‚ */
.will-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 240, 245, 0.85);
  backdrop-filter: blur(10px);
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.will-card {
  width: 92%;
  max-width: 420px;
  background: rgba(255, 255, 255, 0.98);
  border: 2px solid #f8bbd9;
  border-radius: 30px;
  padding: 30px 26px;
  text-align: center;
  box-shadow: 0 24px 70px rgba(248, 187, 217, 0.4);
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.will-title {
  font-size: 1.4rem;
  color: #ec407a;
  font-weight: 800;
  margin-bottom: 10px;
}

.will-desc {
  font-size: 0.95rem;
  color: #5d4037;
  margin-bottom: 22px;
  line-height: 1.7;
}

.will-textarea {
  width: 100%;
  height: 110px;
  border: 2px solid #f8bbd0;
  border-radius: 18px;
  padding: 16px;
  font-size: 1.05rem;
  color: #333;
  outline: none;
  resize: none;
  background: #fff;
  font-family: inherit;
  transition: all 0.25s ease;
  box-sizing: border-box;
}

.will-textarea:focus {
  border-color: #ec407a;
  background: #fff9fb;
}

.will-actions {
  display: flex;
  gap: 14px;
  margin-top: 22px;
}

.btn-will-skip, .btn-will-save {
  flex: 1;
  padding: 16px;
  border-radius: 24px;
  border: none;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.25s ease;
  font-family: inherit;
}

.btn-will-skip {
  background: #f5f5f5;
  color: #757575;
}

.btn-will-skip:hover {
  background: #e0e0e0;
}

.btn-will-save {
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  color: white;
  box-shadow: 0 8px 22px rgba(233, 30, 99, 0.35);
}

.btn-will-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 28px rgba(233, 30, 99, 0.45);
}

/* è®¾ç½®è¦†ç›–å±‚ */
.settings-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(93, 64, 55, 0.45);
  backdrop-filter: blur(6px);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.settings-card {
  width: 92%;
  max-width: 500px;
  background: #fff;
  border-radius: 26px;
  padding: 30px;
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease;
  max-height: 88vh;
  overflow-y: auto;
}

.settings-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 22px;
  padding-bottom: 18px;
  border-bottom: 2px solid #fce4ec;
}

.settings-card .card-header h3 {
  margin: 0;
  color: #ec407a;
  font-weight: 800;
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  gap: 12px;
}

.settings-card .close-btn {
  font-size: 1.8rem;
  color: #999;
  cursor: pointer;
  transition: all 0.2s ease;
  line-height: 1;
  padding: 4px;
  border: none;
  background: none;
}

.settings-card .close-btn:hover {
  color: #ec407a;
  transform: scale(1.1);
}

.settings-desc {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 26px;
  line-height: 1.7;
  background: #fff5f8;
  padding: 16px 18px;
  border-radius: 14px;
  border-left: 4px solid #ec407a;
}

.input-group {
  margin-bottom: 22px;
  text-align: left;
}

.input-group label {
  display: block;
  font-weight: 700;
  color: #5d4037;
  margin-bottom: 10px;
  font-size: 1rem;
}

.glass-input {
  width: 100%;
  background: #fff;
  border: 2px solid #e0e0e0;
  border-radius: 14px;
  padding: 16px 18px;
  font-size: 1.05rem;
  color: #333;
  outline: none;
  font-family: inherit;
  transition: all 0.2s ease;
  box-sizing: border-box;
}

.glass-input:focus {
  border-color: #ec407a;
  box-shadow: 0 0 0 4px rgba(236, 64, 122, 0.12);
}

select.glass-input {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ec407a' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 18px;
  padding-right: 44px;
}

textarea.glass-input {
  min-height: 90px;
  resize: vertical;
}

.save-settings-btn {
  width: 100%;
  height: 56px;
  margin-top: 10px;
  background: linear-gradient(135deg, #ec407a, #c2185b);
  color: white;
  border: none;
  border-radius: 28px;
  font-size: 1.1rem;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 10px 28px rgba(233, 30, 99, 0.35);
  transition: all 0.2s ease;
  font-family: inherit;
}

.save-settings-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 34px rgba(233, 30, 99, 0.45);
}

/* åŠ è½½è¦†ç›–å±‚ */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.92);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(6px);
}

.loading-content {
  text-align: center;
  color: #ff80ab;
}

.loading-content p {
  margin-top: 18px;
  font-size: 1.5rem;
  font-weight: 700;
  color: #333;
}

.loading-content small {
  color: #666;
  font-size: 0.95rem;
}

/* å“åº”å¼ */
@media (max-width: 480px) {
  .pulse-title { font-size: 1.8rem; }
  .kokoro-slime { width: 220px; height: 200px; margin-bottom: 250px; }
  .form-stage { padding: 60px 16px 40px 16px; }
  .step-card { padding: 20px; }
  .big-input { height: 56px; font-size: 1rem; }
  .big-submit-btn { height: 56px; font-size: 1.1rem; }
}

/* ==========================================
   æ¸¸å®¢æ¨¡å¼æ ·å¼
   ========================================== */
.guest-banner {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
    padding: 8px 16px;
    text-align: center;
    font-size: 0.85rem;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.guest-banner-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-guest-login {
    background: rgba(255,255,255,0.25);
    color: white;
    border: 1px solid rgba(255,255,255,0.5);
    border-radius: 20px;
    padding: 4px 16px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-guest-login:hover {
    background: rgba(255,255,255,0.4);
}

.locked-item {
    opacity: 0.6;
}

/* ç™»å½•æç¤ºå¼¹çª— */
.login-prompt-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.login-prompt-card {
    background: white;
    border-radius: 20px;
    padding: 32px;
    max-width: 380px;
    width: 100%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.prompt-icon {
    color: #5c6bc0;
    margin-bottom: 16px;
}

.login-prompt-card h3 {
    margin: 0 0 12px;
    font-size: 1.2rem;
}

.login-prompt-card p {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.6;
    margin-bottom: 24px;
}

.prompt-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.btn-login-primary {
    background: linear-gradient(135deg, #5c6bc0, #3f51b5);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 14px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
}

.btn-login-skip {
    background: none;
    border: none;
    color: #999;
    font-size: 0.9rem;
    cursor: pointer;
    padding: 8px;
}

/* å¯¹é¢è®¤è¯ */
.verify-section {
    padding: 16px;
}

.verify-instruction {
    display: flex;
    gap: 8px;
    background: #e8eaf6;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 20px;
    font-size: 0.85rem;
    color: #3f51b5;
}

.verify-instruction i {
    flex-shrink: 0;
    margin-top: 2px;
}

.verify-generate, .verify-input {
    text-align: center;
    padding: 16px 0;
}

.verify-generate h4, .verify-input h4 {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 12px;
}

.code-display {
    margin: 16px 0;
}

.big-code {
    display: block;
    font-size: 2.5rem;
    font-weight: 900;
    letter-spacing: 12px;
    color: #3f51b5;
    font-family: 'Courier New', monospace;
}

.code-display small {
    display: block;
    color: #999;
    font-size: 0.8rem;
    margin-top: 4px;
}

.btn-generate-code {
    background: linear-gradient(135deg, #5c6bc0, #3f51b5);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-size: 0.9rem;
    cursor: pointer;
    margin-top: 8px;
}

.verify-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    color: #ccc;
    font-size: 0.85rem;
}

.verify-divider::before,
.verify-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #e0e0e0;
}

.code-input {
    display: block;
    width: 100%;
    max-width: 200px;
    margin: 12px auto;
    text-align: center;
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: 8px;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-family: 'Courier New', monospace;
}

.code-input:focus {
    border-color: #5c6bc0;
    outline: none;
}

.btn-verify-code {
    background: linear-gradient(135deg, #43a047, #2e7d32);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-size: 0.9rem;
    cursor: pointer;
    margin-top: 8px;
}

.btn-verify-code:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.guest-heartbeat-hint {
    background: #fff3e0;
    border-radius: 8px;
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: #e65100;
    margin: 12px 0;
}

/* ==========================================
   ä¸­åœŸæ£®æ—ãƒ»å¤æ—¥æš–é˜³ SOS ç¬¦çŸ³
   ========================================== */

/* 1. å®¹å™¨è°ƒæ•´ï¼šè´´è¿‘åœ°é¢ï¼Œå…è®¸è—¤è”“è”“å»¶ */
.sos-container {
  position: absolute;
  bottom: 6%; /* æ›´è´´è¿‘é¡µé¢åº•éƒ¨åœ°é¢ */
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
  z-index: 150;
  width: auto;
  min-width: 180px; /* ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´å±•ç¤ºå‘å¤–å»¶ä¼¸çš„è—¤è”“é˜´å½± */
  /* ç»™æ•´ä½“åŠ ä¸€ä¸ªæ¥è§¦åœ°é¢çš„æ·±æ²‰æŠ•å½±ï¼Œå¢åŠ æ‰æ ¹æ„Ÿ */
  filter: drop-shadow(0 15px 20px rgba(20, 45, 10, 0.7));
  animation: fadeIn 1s ease 0.5s both;
}

/* 2. æŒ‰é’®ä¸»ä½“ï¼šè¢«é’è‹”è¦†ç›–çš„å¤ç‰© */
.sos-btn {
  width: 125px;
  height: 125px;
  /* æ ¸å¿ƒï¼šä¸è§„åˆ™çš„æœ‰æœºå½¢çŠ¶ï¼Œåƒå—å¤©ç„¶æ ‘ç˜¤æˆ–é­”æ³•çŸ³ */
  border-radius: 64% 36% 70% 30% / 50% 60% 40% 50%;
  
  /* æè´¨ï¼šå¤æ‚çš„è‹”è—“å…‰å½± */
  background: radial-gradient(
    circle at 35% 35%,
    #c9e88d 0%, /* é«˜å…‰ï¼šå«©ç»¿ */
    #8eba43 40%, /* ä¸»ä½“ï¼šè‹”è—“ç»¿ */
    #2d4a1d 80%, /* é˜´å½±ï¼šæ£®æ—æ·±ç»¿ */
    #1a2e0a 100% /* è¾¹ç¼˜ï¼šå¢¨ç»¿ */
  );
  
  /* è¾¹æ¡†ï¼šåƒæ˜¥å¤©æ–°å‘çš„å«©æè—¤æ¡ */
  border: 3px solid #a8d65e;
  
  /* æ ¸å¿ƒéš¾ç‚¹ï¼šåˆ©ç”¨å¤šå±‚ç¡¬é˜´å½±æ¨¡æ‹Ÿç¼ ç»•çš„è—¤è”“å’Œæ ¹ç³» */
  box-shadow: 
    /* æœ€å†…å±‚ï¼šç´§è´´çš„æ·±è‰²é˜´å½±ï¼Œå¢åŠ åšåº¦æ„Ÿ */
    inset 0 0 20px rgba(0,0,0,0.3),
    0 0 0 1px #1a2e0a, 
    /* ç¬¬ä¸€å±‚è—¤è”“ï¼šç²—å£®çš„ä¸»èŒ */
    4px 5px 0 #2d4a1d,
    -3px -4px 0 #3e6b29,
    /* ç¬¬äºŒå±‚è—¤è”“ï¼šå‘å¤–å»¶ä¼¸çš„çˆ¬å±±è™ç»†æ (é”™ä½ã€ç¡¬è¾¹) */
    7px 10px 0 -2px #5a8c3e,
    -8px 6px 0 -3px #6b9e4f,
    0 14px 0 -4px #4a7c32,
    /* ç¯å¢ƒå…‰ï¼šæ•´ä½“æ•£å‘çš„ç»¿è‰²ç”Ÿæœºè¾‰å…‰ */
    0 10px 40px rgba(142, 186, 67, 0.4);

  /* æ–‡å­—é¢œè‰²ï¼šæ¸…æ™°å¯è§çš„æ·¡é»„ç»¿è‰²ï¼Œå¸¦æœ‰æ·±è‰²æè¾¹ä»¥å¢åŠ å¯¹æ¯” */
  color: #f0ffd6;
  text-shadow: 0 2px 4px rgba(0, 30, 0, 0.8);
  
  font-family: inherit;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  
  position: relative; /* ä¸ºä¼ªå…ƒç´ å®šä½ */
  overflow: hidden;   /* é™åˆ¶å…‰æ–‘åœ¨æŒ‰é’®å†…éƒ¨ */
  transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* ç¼“æ…¢ã€æœ‰æœºçš„è¿‡æ¸¡ */
  -webkit-tap-highlight-color: transparent;
}

/* ==========================================
   è½»ç›ˆæœå†»æ„Ÿ - ç¼“æ…¢æ°´æµ SOS æŒ‰é’®
   ========================================== */

.sos-container {
  position: absolute;
  bottom: 12%;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
  z-index: 150;
  animation: fadeIn 0.8s ease both;
}

.sos-btn {
  /* ä¿æŒ iOS èƒ¶å›Šé•¿æ¡å½¢ */
  width: 200px; 
  height: 52px;
  border-radius: 26px; 
  border: none;
  
  /* é¢œè‰²è°ƒæµ…ï¼šä½¿ç”¨æ›´è½»ç›ˆçš„çŠç‘šç²‰çº¢ï¼Œå¢åŠ é€šé€æ„Ÿ */
  background: linear-gradient(
    135deg, 
    #ff9a9e 0%, 
    #ff6a88 50%, 
    #ff5252 100%
  );
  background-size: 200% 200%; /* ä¸ºæµåŠ¨åŠ¨ç”»åšå‡†å¤‡ */
  
  color: white;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  
  /* æŸ”å’Œçš„æµ…ç²‰è‰²æŠ•å½±ï¼Œä¸å†æ·±æ²‰ */
  box-shadow: 0 8px 20px rgba(255, 106, 136, 0.25);
  
  /* å¹³æ»‘çš„ç‰©ç†è¿‡æ¸¡ */
  transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
  -webkit-tap-highlight-color: transparent;
  outline: none;
  overflow: hidden; /* ç¡®ä¿å†…éƒ¨â€œæ¶²ä½“â€ä¸æº¢å‡º */
  position: relative;
}

/* æ ¸å¿ƒï¼šæ¨¡æ‹Ÿæ°´æµåŠ¨çš„å¹³æ»‘åŠ¨ç”» */
@keyframes waterFlow {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

/* é¼ æ ‡ç§»åŠ¨ä¸Šå»ï¼šè§¦å‘ç¼“æ…¢æµåŠ¨æ•ˆæœ */
.sos-btn:hover:not(:disabled) {
  /* è§¦æ„Ÿåé¦ˆï¼šè½»å¾®æ¼‚æµ®æ„Ÿ */
  transform: translateY(-2px);
  box-shadow: 0 12px 25px rgba(255, 106, 136, 0.35);
  
  /* åƒæ°´ä¸€æ ·ç¼“æ…¢æµåŠ¨ï¼Œè€Œä¸æ˜¯æ”¾å°„ */
  animation: waterFlow 4s ease-in-out infinite;
  
  /* å¢åŠ ä¸€ä¸ªå†…éƒ¨çš„é«˜å…‰æµè½¬ï¼Œæ¨¡ä»¿æ¶²ä½“è´¨æ„Ÿ */
  filter: brightness(1.05);
}

/* ç‚¹å‡»æ—¶çš„å‹æ‰æ„Ÿï¼Œä¿æŒæœå†»å¼¹æ€§ */
.sos-btn:active:not(:disabled) {
  transform: scale(0.96) translateY(0);
  filter: brightness(0.95);
  transition: all 0.1s;
}

.sos-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: #f0f0f0;
  box-shadow: none;
}

.sos-icon {
  font-size: 1.4rem;
  line-height: 1;
  /* ç¨å¾®åŠ ä¸€ç‚¹å‘å…‰æ„Ÿ */
  filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
}

.sos-text {
  font-size: 1rem;
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* åº•éƒ¨æç¤ºæ–‡å­—è°ƒæµ… */
.sos-hint {
  margin-top: 12px;
  font-size: 0.75rem;
  color: #cbbabc; /* è´´åˆæ‚¨èƒŒæ™¯çš„æ·¡è‰² */
  font-weight: 400;
}

/* æ‰‹æœºé€‚é… */
@media (max-width: 480px) {
  .sos-container {
    bottom: 8%;
  }
  .sos-btn {
    width: 180px;
    height: 48px;
  }
}

/* ==========================================
   Accessibility (a11y) - ç„¡éšœå£ã‚¢ã‚¯ã‚»ã‚¹
   ========================================== */

/* é”®ç›˜ç„¦ç‚¹å¯è§ç¯ */
*:focus-visible {
  outline: 3px solid #ec407a;
  outline-offset: 2px;
  box-shadow: 0 0 0 6px rgba(236, 64, 122, 0.2);
}

/* èœå•é¡¹é”®ç›˜ç„¦ç‚¹ */
.menu-item:focus-visible,
.friend-card:focus-visible,
.history-item:focus-visible {
  outline: 3px solid #ec407a;
  outline-offset: -2px;
  background: rgba(255, 240, 245, 0.9);
}

/* å²è±å§†é”®ç›˜ç„¦ç‚¹ */
.kokoro-slime:focus-visible {
  outline: 4px dashed #ec407a;
  outline-offset: 8px;
}

/* SOSæŒ‰é’®é”®ç›˜ç„¦ç‚¹ - æ›´é†’ç›® */
.sos-btn:focus-visible {
  outline: 4px solid #fff;
  outline-offset: 4px;
  box-shadow: 
    0 0 0 8px rgba(211, 47, 47, 0.6),
    0 8px 32px rgba(211, 47, 47, 0.45);
}

/* ç´§æ€¥åº¦é€‰é¡¹ï¼šå›¾æ ‡+è‰²å½©åŒé‡æ ‡è¯† */
.status-dot.online::after { content: 'â—'; }
.status-dot.warning::after { content: 'â–²'; }
.status-dot.critical::after { content: 'âœ•'; }

.status-dot::after {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 7px;
  color: white;
  font-weight: 900;
}

/* Screen Reader å°‚ç”¨ãƒ†ã‚­ã‚¹ãƒˆ */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* é«˜å¯¹æ¯”åº¦æ¨¡å¼ */
@media (prefers-contrast: high) {
  .kokoro-user-container {
    background: #fff !important;
  }
  
  .big-input,
  .glass-input,
  .glass-textarea,
  .will-textarea {
    border-width: 3px !important;
    border-color: #333 !important;
    color: #000 !important;
  }
  
  .big-label {
    color: #000 !important;
  }
  
  .sos-btn {
    background: #d32f2f !important;
    border: 4px solid #000 !important;
  }
  
  .big-submit-btn {
    background: #c2185b !important;
    border: 3px solid #000 !important;
  }
  
  .step-card {
    border: 3px solid #333 !important;
    background: #fff !important;
  }
}

/* åŠ¨ç”»å‰Šå‡ï¼ˆå‰åº­éšœç¢ç”¨æˆ·ï¼‰ */
@media (prefers-reduced-motion: reduce) {
  .kokoro-slime,
  .sos-btn,
  .status-dot,
  .pulse-ring,
  .emergency-btn {
    animation: none !important;
  }
  
  * {
    transition-duration: 0.01ms !important;
  }
}

/* ==========================================
   Offline Queue - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹è¡¨ç¤º
   ========================================== */
.network-status-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 10000;
  text-align: center;
  font-size: 0.85rem;
  font-weight: 700;
  font-family: inherit;
  animation: slideDown 0.3s ease;
}

.network-offline {
  background: linear-gradient(135deg, #616161, #424242);
  color: #fff;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.network-offline i {
  font-size: 1.1rem;
  opacity: 0.7;
}

.network-offline small {
  opacity: 0.8;
  font-weight: 500;
}

.network-syncing {
  background: linear-gradient(135deg, #1565c0, #1976d2);
  color: #fff;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.network-syncing i {
  font-size: 1.1rem;
}

@keyframes slideDown {
  from { transform: translateY(-100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* ç¦»çº¿æ—¶SOSæŒ‰é’®æ ·å¼å˜åŒ– */
.network-offline ~ .sos-container .sos-btn,
.sos-btn[aria-busy="false"]:not(:disabled) {
  /* ä¿æŒå¯ç”¨ */
}

@media (max-width: 480px) {
  .network-status-bar {
    font-size: 0.78rem;
  }
  
  .network-offline,
  .network-syncing {
    padding: 8px 12px;
  }
}

/* ==========================================
   In-App Notification Toast
   ========================================== */
.notification-stack {
  position: fixed;
  top: 16px;
  right: 16px;
  z-index: 10001;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 360px;
  width: calc(100% - 100px);
  pointer-events: none;
}

.notification-toast {
  display: flex;
  align-items: flex-start;
  padding: 14px 16px;
  border-radius: 16px;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  animation: toastSlideIn 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  pointer-events: auto;
  border-left: 4px solid;
}

/* ç±»å‹é¢œè‰² */
.toast-info {
  background: rgba(255, 255, 255, 0.95);
  border-left-color: #2196f3;
}

.toast-success {
  background: rgba(232, 245, 233, 0.95);
  border-left-color: #4caf50;
}

.toast-warning {
  background: rgba(255, 243, 224, 0.95);
  border-left-color: #ff9800;
}

.toast-critical {
  background: rgba(255, 235, 238, 0.95);
  border-left-color: #f44336;
  animation: toastSlideIn 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275),
             toastUrgent 2s ease-in-out 3;
}

.toast-content {
  flex: 1;
  min-width: 0;
}

.toast-title {
  font-weight: 800;
  font-size: 0.9rem;
  color: #333;
  margin-bottom: 4px;
}

.toast-message {
  font-size: 0.82rem;
  color: #666;
  line-height: 1.4;
  word-break: break-word;
}

.toast-close {
  background: none;
  border: none;
  color: #999;
  font-size: 1.3rem;
  cursor: pointer;
  padding: 0 0 0 10px;
  line-height: 1;
  flex-shrink: 0;
  transition: color 0.2s;
}

.toast-close:hover {
  color: #333;
}

/* é€€å‡ºåŠ¨ç”» */
.toast-exit {
  animation: toastSlideOut 0.35s ease forwards;
}

@keyframes toastSlideIn {
  from { opacity: 0; transform: translateX(60px) scale(0.9); }
  to { opacity: 1; transform: translateX(0) scale(1); }
}

@keyframes toastSlideOut {
  from { opacity: 1; transform: translateX(0); max-height: 120px; }
  to { opacity: 0; transform: translateX(60px); max-height: 0; padding: 0; margin: 0; }
}

@keyframes toastUrgent {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-4px); }
  40% { transform: translateX(4px); }
  60% { transform: translateX(-2px); }
  80% { transform: translateX(2px); }
}

/* æ‰‹æœºé€‚é… */
@media (max-width: 480px) {
  .notification-stack {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
    width: auto;
  }
  
  .notification-toast {
    padding: 12px 14px;
    border-radius: 14px;
  }
  
  .toast-title {
    font-size: 0.85rem;
  }
  
  .toast-message {
    font-size: 0.78rem;
  }
}

/* åŠ¨ç”»å‰Šå‡æ¨¡å¼ */
@media (prefers-reduced-motion: reduce) {
  .notification-toast {
    animation: none !important;
  }
  
  .toast-exit {
    animation: none !important;
    display: none;
  }
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>kokoro_user</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Kokoro User</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
    // ============================================================
    // KOKORO SHELTER - Server Script (Final Fixed Version)
    // åŒ…å«: åŸºç¡€é¿éš¾æ‰€ç®¡ç† + å¥½å‹ç³»ç»Ÿ(å®ˆæŠ¤åœˆ) + æ¸¸å®¢æ¨¡å¼
    // ============================================================

    var CONFIG = {
        tables: {
            SILENT_WISH: 'x_1821654_kokoro_0_silent_wish',
            USER_PROFILE: 'x_1821654_kokoro_0_x_kokoro_user_profile',
            HEARTBEAT: 'x_1821654_kokoro_0_x_1821654_kokoro_0_heartbeat',
            EMERGENCY_MESSAGE: 'x_1821654_kokoro_0_emergency_message',
            PROCESS_EVENT: 'x_1821654_kokoro_0_process_event',
            FRIEND_RELATION: 'x_1821654_kokoro_0_friend_relation',
            FRIEND_NOTIFICATION: 'x_1821654_kokoro_0_friend_notification',
            GUEST_TOKEN: 'x_1821654_kokoro_0_guest_token',
            HEARTBEAT_TOKEN: 'x_1821654_kokoro_0_heartbeat_token',
            FRIEND_VERIFICATION: 'x_1821654_kokoro_0_friend_verification'
        },
        wishStates: {
            DRAFT: '1',
            SUBMITTED: '10',
            ASSIGNED: '11',
            IN_PROGRESS: '2',
            COMPLETED: '4',
            CANCELLED: '5',
            ON_HOLD: '6'
        },
        slaTargets: {
            'Critical': 30,
            'High': 60,
            'Medium': 120,
            'Low': 240
        }
    };

    // ==========================================
    // åŒæ¨¡å¼èº«ä»½è¯†åˆ« (Guest / Authenticated)
    // ==========================================
    data.user_id = gs.getUserID();
    data.user_name = gs.getUserDisplayName();
    data.is_guest = false;
    data.guest_token = '';
    data.auth_mode = 'authenticated';

    var isGuestSession = !gs.isLoggedIn() || gs.getUserName() === 'guest' || data.user_id === '5136503cc611227c00566377a6ee91f3';

    if (isGuestSession) {
        data.is_guest = true;
        data.auth_mode = 'guest';
        data.user_name = 'ã‚²ã‚¹ãƒˆ';
        
        if (input && input.guest_token) {
            data.guest_token = input.guest_token;
        }
        
        data.guest_features_locked = true;
    } else {
        data.guest_features_locked = false;
    }

    var isVolunteer = !isGuestSession && (gs.hasRole('admin') || gs.hasRole('x_1821654_kokoro_0.volunteer'));
    data.is_volunteer = isVolunteer;

    data.emergency_email = "";
    data.medical_info = "";
    data.blood_type = "";
    data.saved_will = "";
    data.list = [];
    data.myTasks = [];
    data.volunteers = [];
    data.openCount = 0;
    data.sosCount = 0;
    data.my_requests = [];
    data.friends = [];
    data.friend_requests = [];
    data.friend_notifications = 0;
    data.recommended = [];
    data.results = [];

	// ==========================================
// CSRF Tokenï¼ˆäºŒé‡é˜²è­·ï¼‰
// ==========================================
if (!input) {
    // é¡µé¢åˆæ¬¡åŠ è½½æ—¶ç”Ÿæˆ token
    data.csrf_token = gs.generateGUID();
    
    // å­˜å…¥ sessionï¼Œä¾›åç»­éªŒè¯
    var session = gs.getSession();
    session.putClientData('kokoro_csrf', data.csrf_token);
}
	
	// ==========================================
// CSRF éªŒè¯
// ==========================================
function validateCSRF(inputToken) {
    try {
        var session = gs.getSession();
        var storedToken = session.getClientData('kokoro_csrf');
        
        if (!storedToken || !inputToken) {
            return false;
        }
        
        return String(storedToken) === String(inputToken);
    } catch (e) {
        gs.error('[Kokoro] CSRF validation error: ' + e.message);
        // å‡ºé”™æ—¶æ”¾è¡Œï¼ˆå¯ç”¨æ€§ä¼˜å…ˆï¼‰
        return true;
    }
}
	
	// ==========================================
// Rate Limiterï¼ˆé¢‘ç‡åˆ¶é™ï¼‰
// ==========================================
var RateLimiter = {
    /**
     * æ£€æŸ¥æ˜¯å¦è¶…è¿‡é¢‘ç‡é™åˆ¶
     * @param {string} identifier - ç”¨æˆ·IDæˆ–guest_token
     * @param {string} actionType - æ“ä½œç±»å‹æ ‡è¯†
     * @param {number} windowMinutes - æ—¶é—´çª—å£ï¼ˆåˆ†é’Ÿï¼‰
     * @param {number} maxCount - æœ€å¤§å…è®¸æ¬¡æ•°
     * @returns {object} {allowed: boolean, remaining: number, message: string}
     */
    check: function(identifier, actionType, windowMinutes, maxCount) {
        if (!identifier) {
            return { allowed: true, remaining: maxCount };
        }
        
        try {
            var windowStart = new GlideDateTime();
            windowStart.addSeconds(-windowMinutes * 60);
            
            var ga = new GlideAggregate(CONFIG.tables.PROCESS_EVENT);
            ga.addQuery('user', identifier);
            ga.addQuery('activity', 'STARTSWITH', 'RATE:' + actionType);
            ga.addQuery('timestamp', '>=', windowStart);
            ga.addAggregate('COUNT');
            ga.query();
            
            var count = 0;
            if (ga.next()) {
                count = parseInt(ga.getAggregate('COUNT')) || 0;
            }
            
            if (count >= maxCount) {
                return {
                    allowed: false,
                    remaining: 0,
                    message: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚' + windowMinutes + 'åˆ†å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
                };
            }
            
            return {
                allowed: true,
                remaining: maxCount - count
            };
            
        } catch (e) {
            gs.error('[Kokoro] RateLimiter error: ' + e.message);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯é€šã™ï¼ˆå¯ç”¨æ€§å„ªå…ˆï¼‰
            return { allowed: true, remaining: maxCount };
        }
    },
    
    /**
     * è®°å½•ä¸€æ¬¡æ“ä½œï¼ˆç”¨äºè®¡æ•°ï¼‰
     * @param {string} identifier - ç”¨æˆ·IDæˆ–guest_token
     * @param {string} actionType - æ“ä½œç±»å‹æ ‡è¯†
     */
    record: function(identifier, actionType) {
        try {
            var pe = new GlideRecord(CONFIG.tables.PROCESS_EVENT);
            pe.initialize();
            pe.setValue('user', identifier);
            pe.setValue('activity', 'RATE:' + actionType);
            pe.setValue('timestamp', new GlideDateTime());
            pe.insert();
        } catch (e) {
            gs.error('[Kokoro] RateLimiter record error: ' + e.message);
        }
    }
};
    // ==========================================
    // å·¥å…·å‡½æ•°
    // ==========================================
    function sanitizeInput(inputVal, maxLength) {
        if (!inputVal) return '';
        var cleaned = String(inputVal)
            .replace(/[<>\"'&]/g, '')
            .replace(/[\r\n]+/g, ' ')
            .trim();
        if (maxLength && cleaned.length > maxLength) {
            cleaned = cleaned.substring(0, maxLength);
        }
        return cleaned;
    }

    function validateSysId(sysId) {
        if (!sysId) return false;
        return /^[a-f0-9]{32}$/.test(String(sysId));
    }

    function logProcessEvent(caseId, activity, userId) {
        try {
            var pe = new GlideRecord(CONFIG.tables.PROCESS_EVENT);
            pe.initialize();
            pe.setValue('case_id', caseId || '');
            pe.setValue('activity', sanitizeInput(activity, 200));
            pe.setValue('timestamp', new GlideDateTime());
            pe.setValue('user', userId || gs.getUserID());
            pe.insert();
        } catch (e) {
            gs.error('[Kokoro] Process event log error: ' + e.message);
        }
    }

    // ==========================================
    // æ¸¸å®¢Tokenç®¡ç†
    // ==========================================
    function generateGuestToken() {
        var token = gs.generateGUID();
        try {
            var gt = new GlideRecord(CONFIG.tables.GUEST_TOKEN);
            gt.initialize();
            gt.setValue('token', token);
            gt.setValue('guest_identifier', '');
            gt.setValue('created_at', new GlideDateTime());
            
            var expires = new GlideDateTime();
            expires.addSeconds(72 * 3600);
            gt.setValue('expires_at', expires);
            gt.setValue('is_active', true);
            
            if (gt.insert()) {
                return token;
            }
        } catch (e) {
            gs.error('[Kokoro] Guest token generation error: ' + e.message);
        }
        return null;
    }

    function validateGuestToken(token) {
        if (!token) return { valid: false };
        try {
            var gt = new GlideRecord(CONFIG.tables.GUEST_TOKEN);
            gt.addQuery('token', token);
            gt.addQuery('is_active', true);
            gt.addQuery('expires_at', '>', new GlideDateTime());
            gt.setLimit(1);
            gt.query();
            
            if (gt.next()) {
                return {
                    valid: true,
                    sys_id: gt.getUniqueValue(),
                    token: token,
                    linked_user: gt.getValue('linked_user') || null
                };
            }
        } catch (e) {
            gs.error('[Kokoro] Guest token validation error: ' + e.message);
        }
        return { valid: false };
    }

    function generateHeartbeatToken(targetIdentifier, isGuest) {
        var token = gs.generateGUID();
        try {
            var ht = new GlideRecord(CONFIG.tables.HEARTBEAT_TOKEN);
            ht.initialize();
            ht.setValue('token', token);
            
            if (isGuest) {
                ht.setValue('guest_token', targetIdentifier);
            } else {
                ht.setValue('target_user', targetIdentifier);
            }
            
            ht.setValue('created_at', new GlideDateTime());
            
            var expires = new GlideDateTime();
            expires.addSeconds(24 * 3600);
            ht.setValue('expires_at', expires);
            ht.setValue('is_used', false);
            
            if (ht.insert()) {
                return token;
            }
        } catch (e) {
            gs.error('[Kokoro] Heartbeat token generation error: ' + e.message);
        }
        return null;
    }

    function consumeHeartbeatToken(token) {
        if (!token) return { valid: false };
        try {
            var ht = new GlideRecord(CONFIG.tables.HEARTBEAT_TOKEN);
            ht.addQuery('token', token);
            ht.addQuery('is_used', false);
            ht.addQuery('expires_at', '>', new GlideDateTime());
            ht.setLimit(1);
            ht.query();
            
            if (ht.next()) {
                ht.setValue('is_used', true);
                ht.setValue('used_at', new GlideDateTime());
                ht.update();
                
                return {
                    valid: true,
                    target_user: ht.getValue('target_user'),
                    guest_token: ht.getValue('guest_token')
                };
            }
        } catch (e) {
            gs.error('[Kokoro] Heartbeat token consume error: ' + e.message);
        }
        return { valid: false };
    }

    // ==========================================
    // çŠ¶æ€éªŒè¯å™¨
    // ==========================================
    var StateValidator = {
        allowedTransitions: {
            '1':  ['10', '11', '5'],
            '10': ['1', '11', '5'],
            '11': ['10', '2', '5', '6'],
            '2':  ['4', '5', '6'],
            '4':  [],
            '5':  [],
            '6':  ['11', '2', '5']
        },

        validateTransition: function(fromState, toState) {
            fromState = String(fromState);
            toState = String(toState);

            if (!fromState || fromState === '' || fromState === 'undefined' || fromState === 'null') {
                return { valid: true };
            }

            if (!this.allowedTransitions.hasOwnProperty(fromState)) {
                return { valid: false, message: 'ç„¡åŠ¹ãªç¾åœ¨çŠ¶æ…‹: ' + fromState };
            }

            var allowed = this.allowedTransitions[fromState];
            if (allowed.indexOf(toState) === -1) {
                return {
                    valid: false,
                    message: fromState + ' ã‹ã‚‰ ' + toState + ' ã¸ã®é·ç§»ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“'
                };
            }

            return { valid: true };
        }
    };

    // ==========================================
    // åŠ è½½ç”¨æˆ·èµ„æ–™
    // ==========================================
    function loadUserProfile() {
        try {
            var grProfile = new GlideRecord(CONFIG.tables.USER_PROFILE);
            grProfile.addQuery('user', data.user_id);
            grProfile.setLimit(1);
            grProfile.query();

            if (grProfile.next()) {
                data.emergency_email = grProfile.getValue('emergency_contact_email') || "";
                data.medical_info = grProfile.getValue('medical_conditions') || "";
                data.blood_type = grProfile.getValue('blood_type') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Profile load error: " + e.message);
        }
    }

    function loadDigitalWill() {
        try {
            var grWill = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
            grWill.addQuery('user', data.user_id);
            grWill.addQuery('is_active', true);
            grWill.addQuery('message_type', 'Last_Will');
            grWill.orderByDesc('sys_created_on');
            grWill.setLimit(1);
            grWill.query();

            if (grWill.next()) {
                data.saved_will = grWill.getValue('message_encrypted') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Will load error: " + e.message);
        }
    }

    if (!isGuestSession) {
        loadUserProfile();
        loadDigitalWill();
    }

    // ==========================================
    // æ„å»ºä»»åŠ¡é¡¹
    // ==========================================
    function buildTaskItem(gr) {
        var taskItem = {
            sys_id: gr.getUniqueValue(),
            number: gr.getValue('number') || '',
            category: gr.getValue('request_category') || '',
            category_display: gr.getDisplayValue('request_category') || '',
            zone: gr.getDisplayValue('shelter_zone') || '',
            detail_loc: gr.getValue('precise_location') || gr.getValue('wish_content') || '',
            desc: gr.getValue('wish_content') || '',
            urgency: gr.getValue('urgency') || 'Medium',
            contact: gr.getValue('u_contact_info') || '',
            reporter_name: gr.getDisplayValue('opened_by') || 'ã‚²ã‚¹ãƒˆ',
            assigned_to_name: gr.getDisplayValue('assigned_to') || '',
            assigned_to_id: gr.getValue('assigned_to') || '',
            state: parseInt(gr.getValue('state')) || 10,
            state_label: gr.getDisplayValue('state') || '',
            quantity: parseInt(gr.getValue('qty')) || 1,
            location: gr.getValue('shelter_zone') || '',
            remarks: gr.getValue('wish_content') || '',
            affected_count: gr.getValue('u_affected_count') || 'ä¸æ˜',
            history: [],
            attachments: []
        };

        var created = new GlideDateTime(gr.sys_created_on);
        var now = new GlideDateTime();
        var diffMs = Math.abs(now.getNumericValue() - created.getNumericValue());
        var minutes = Math.floor(diffMs / 1000 / 60);

        if (minutes < 60) {
            taskItem.time_ago = minutes + "åˆ†å‰";
        } else if (minutes < 1440) {
            taskItem.time_ago = Math.floor(minutes / 60) + "æ™‚é–“å‰";
        } else {
            taskItem.time_ago = Math.floor(minutes / 1440) + "æ—¥å‰";
        }

        taskItem.created_on = gr.getDisplayValue('sys_created_on');

        var slaTarget = CONFIG.slaTargets[taskItem.urgency] || 180;
        var slaPercentage = Math.min((minutes / slaTarget) * 100, 100);
        var remainingMinutes = slaTarget - minutes;

        taskItem.sla = {
            elapsed: Math.floor(minutes),
            target: slaTarget,
            percentage: Math.round(slaPercentage),
            remaining: Math.floor(remainingMinutes),
            status: slaPercentage > 100 ? 'critical' : (slaPercentage > 80 ? 'warning' : 'ok')
        };

        try {
            var att = new GlideRecord('sys_attachment');
            att.addQuery('table_sys_id', taskItem.sys_id);
            att.setLimit(1);
            att.orderByDesc('sys_created_on');
            att.query();
            if (att.next()) {
                taskItem.image_url = '/' + att.sys_id + '.iix';
            }
        } catch (e) {}

        return taskItem;
    }

    // ==========================================
    // åŠ è½½å¿—æ„¿è€…åˆ—è¡¨
    // ==========================================
    function loadVolunteerList() {
        var volunteerList = [];
        try {
            var roleGr = new GlideRecord('sys_user_has_role');
            roleGr.addQuery('role.name', 'x_1821654_kokoro_0.volunteer');
            roleGr.query();
            var volIds = [];
            while (roleGr.next()) {
                volIds.push(roleGr.getValue('user'));
            }

            if (volIds.length > 0) {
                var userGr = new GlideRecord('sys_user');
                userGr.addQuery('sys_id', 'IN', volIds.join(','));
                userGr.addQuery('active', true);
                userGr.query();
                while (userGr.next()) {
                    volunteerList.push({
                        sys_id: userGr.getUniqueValue(),
                        name: userGr.getDisplayValue('name') || userGr.getValue('user_name')
                    });
                }
            }

            var adminGr = new GlideRecord('sys_user');
            adminGr.addQuery('active', true);
            adminGr.addJoinQuery('sys_user_has_role', 'sys_id', 'user');
            adminGr.addQuery('sys_user_has_role.role.name', 'admin');
            adminGr.setLimit(10);
            adminGr.query();
            
            while (adminGr.next()) {
                var adminId = adminGr.getUniqueValue();
                var alreadyExists = false;
                for (var i = 0; i < volunteerList.length; i++) {
                    if (volunteerList[i].sys_id === adminId) {
                        alreadyExists = true;
                        break;
                    }
                }
                if (!alreadyExists) {
                    volunteerList.push({
                        sys_id: adminId,
                        name: adminGr.getDisplayValue('name') || adminGr.getValue('user_name')
                    });
                }
            }
        } catch (e) {
            gs.error("[Kokoro] Load volunteer list error: " + e.message);
        }
        return volunteerList;
    }

    // ==========================================
    // å¥½å‹ç³»ç»Ÿ - å·¥å…·å‡½æ•°
    // ==========================================
    function getLatestHeartbeat(userId) {
        try {
            var hbGr = new GlideRecord(CONFIG.tables.HEARTBEAT);
            hbGr.addQuery('u_user', userId);
            hbGr.orderByDesc('u_timestamp');
            hbGr.setLimit(1);
            hbGr.query();

            if (hbGr.next()) {
                var hbTime = new GlideDateTime(hbGr.u_timestamp);
                var now = new GlideDateTime();
                var diffMs = GlideDateTime.subtract(now, hbTime).getNumericValue();
                var minutes = Math.floor(diffMs / 1000 / 60);

                var status = 'offline';
                var message = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';

                if (minutes < 5) {
                    status = 'online';
                    message = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
                } else if (minutes < 60) {
                    status = 'online';
                    message = minutes + 'åˆ†å‰';
                } else if (minutes < 360) {
                    status = 'warning';
                    message = Math.floor(minutes / 60) + 'æ™‚é–“å‰';
                } else if (minutes < 1440) {
                    status = 'critical';
                    message = 'âš ï¸ ' + Math.floor(minutes / 60) + 'æ™‚é–“å¿œç­”ãªã—';
                } else {
                    status = 'critical';
                    message = ']]>ğŸ†˜<![CDATA[ ' + Math.floor(minutes / 1440) + 'æ—¥é–“é€£çµ¡ãªã—';
                }

                var zone = getUserCurrentZone(userId);

                return {
                    status: status,
                    time_ago: message,
                    zone: zone,
                    message: message
                };
            }
        } catch (e) {
            gs.error('[Kokoro] Get heartbeat error: ' + e.message);
        }

        return {
            status: 'offline',
            time_ago: 'æœªçŸ¥',
            zone: '',
            message: 'ãƒ‡ãƒ¼ã‚¿ãªã—'
        };
    }

    function getUserCurrentZone(userId) {
        try {
            var wishGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            wishGr.addQuery('opened_by', userId);
            wishGr.orderByDesc('sys_created_on');
            wishGr.setLimit(1);
            wishGr.query();

            if (wishGr.next() && wishGr.getValue('shelter_zone')) {
                return wishGr.getDisplayValue('shelter_zone');
            }

            var profileGr = new GlideRecord(CONFIG.tables.USER_PROFILE);
            profileGr.addQuery('user', userId);
            profileGr.setLimit(1);
            profileGr.query();

            if (profileGr.next() && profileGr.getValue('current_zone')) {
                return profileGr.getValue('current_zone');
            }
        } catch (e) {}

        return '';
    }

    function checkFriendStatus(userId, friendId) {
        try {
            var gr = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
            gr.addQuery('user', userId);
            gr.addQuery('friend', friendId);
            gr.addQuery('status', 'accepted');
            gr.setLimit(1);
            gr.query();

            return gr.hasNext();
        } catch (e) {
            return false;
        }
    }

    function checkPendingRequest(fromUser, toUser) {
        try {
            var gr = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
            gr.addQuery('user', fromUser);
            gr.addQuery('friend', toUser);
            gr.addQuery('status', 'pending');
            gr.setLimit(1);
            gr.query();

            return gr.hasNext();
        } catch (e) {
            return false;
        }
    }

    function createFriendNotification(fromUser, toUser, type, message, relatedRecord) {
        try {
            var notif = new GlideRecord(CONFIG.tables.FRIEND_NOTIFICATION);
            notif.initialize();
            notif.setValue('from_user', fromUser);
            notif.setValue('to_user', toUser);
            notif.setValue('type', type);
            notif.setValue('message', sanitizeInput(message, 500));
            notif.setValue('is_read', false);
            notif.setValue('created_at', new GlideDateTime());

            if (relatedRecord) {
                notif.setValue('related_record', relatedRecord);
            }

            return notif.insert();
        } catch (e) {
            gs.error('[Kokoro] Create notification error: ' + e.message);
            return null;
        }
    }

    function getRecommendedFriends(userId) {
        var recommended = [];

        try {
            var userZone = getUserCurrentZone(userId);
            if (!userZone) return recommended;

            var wishGr = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            wishGr.addQuery('shelter_zone', userZone);
            wishGr.addQuery('opened_by', '!=', userId);
            wishGr.groupBy('opened_by');
            wishGr.orderByDesc('COUNT');
            wishGr.setLimit(5);
            wishGr.query();

            while (wishGr.next()) {
                var candidateId = wishGr.getValue('opened_by');

                if (checkFriendStatus(userId, candidateId)) continue;
                if (checkPendingRequest(userId, candidateId)) continue;

                var userGr = new GlideRecord('sys_user');
                if (userGr.get(candidateId)) {
                    recommended.push({
                        sys_id: candidateId,
                        name: userGr.getDisplayValue('name'),
                        email: userGr.getValue('email'),
                        hint: 'åŒã˜ã‚¨ãƒªã‚¢'
                    });
                }
            }
        } catch (e) {
            gs.error('[Kokoro] Get recommended friends error: ' + e.message);
        }

        return recommended;
    }

    // ==========================================
    // è·å–ç”¨æˆ·å†å²è®°å½• (æ ¸å¿ƒå‡½æ•°)
    // ==========================================
    function getMyRequests(userId, guestToken) {
    var requests = [];
    
    // ]]>ğŸ”<![CDATA[ è°ƒè¯•æ—¥å¿— - è®°å½•è¾“å…¥å‚æ•°
    gs.info("=== getMyRequests è°ƒè¯• ===");
    gs.info("userId: " + userId);
    gs.info("guestToken: " + guestToken);
    
    try {
        var myReq = new GlideRecord(CONFIG.tables.SILENT_WISH);
        
        if (guestToken) {
            gs.info("ä½¿ç”¨ guest_token æŸ¥è¯¢: " + guestToken);
            myReq.addQuery('guest_token', guestToken);
        } else if (userId) {
            gs.info("ä½¿ç”¨ opened_by æŸ¥è¯¢: " + userId);
            myReq.addQuery('opened_by', userId);
        } else {
            gs.warn("[Kokoro] getMyRequests: æ— æœ‰æ•ˆçš„userIdæˆ–guestToken");
            return requests;
        }
        
        myReq.orderByDesc('sys_created_on');
        myReq.setLimit(20);
        myReq.query();
        
        // ]]>ğŸ”<![CDATA[ è°ƒè¯•æ—¥å¿— - è®°å½•æŸ¥è¯¢ç»“æœ
        gs.info("æŸ¥è¯¢è¿”å›çš„è®°å½•æ•°: " + myReq.getRowCount());
        
        // ]]>ğŸ”<![CDATA[ å¦‚æœæ²¡æœ‰è®°å½•ï¼Œæ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰ä»»ä½•è®°å½•
        if (myReq.getRowCount() === 0) {
            var checkGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            checkGr.setLimit(5);
            checkGr.orderByDesc('sys_created_on');
            checkGr.query();
            
            gs.info("=== æ•°æ®åº“ä¸­æœ€æ–°çš„ 5 æ¡è®°å½• ===");
            while (checkGr.next()) {
                gs.info("Record: " + checkGr.getValue('number') + 
                       " | guest_token: " + checkGr.getValue('guest_token') + 
                       " | opened_by: " + checkGr.getValue('opened_by'));
            }
        }
        
        while (myReq.next()) {
            var taskItem = buildTaskItem(myReq);
            requests.push(taskItem);
            gs.info("æ·»åŠ è®°å½•: " + taskItem.number);
        }
        
        gs.info("æœ€ç»ˆè¿”å›çš„è®°å½•æ•°é‡: " + requests.length);
        gs.info("=== getMyRequests è°ƒè¯•ç»“æŸ ===");
        
    } catch (e) {
        gs.error("[Kokoro] getMyRequests error: " + e.message);
    }
    return requests;
}

    // ==========================================
    // åŠ è½½å¿—æ„¿è€…æ•°æ®
    // ==========================================
    if (isVolunteer) {
        try {
            var myGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            myGr.addQuery('assigned_to', data.user_id);
            myGr.orderByDesc('sys_updated_on');
            myGr.setLimit(50);
            myGr.query();
            while (myGr.next()) {
                data.myTasks.push(buildTaskItem(myGr));
            }
        } catch (e) {
            gs.error("[Kokoro] My tasks load error: " + e.message);
        }

        try {
            var allGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            allGr.orderByDesc('sys_created_on');
            allGr.setLimit(100);
            allGr.query();
            while (allGr.next()) {
                data.list.push(buildTaskItem(allGr));
            }
        } catch (e) {
            gs.error("[Kokoro] All tasks load error: " + e.message);
        }

        try {
            var gaOpen = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaOpen.addNullQuery('assigned_to');
            gaOpen.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaOpen.addAggregate('COUNT');
            gaOpen.query();
            if (gaOpen.next()) {
                data.openCount = parseInt(gaOpen.getAggregate('COUNT')) || 0;
            }

            var gaSOS = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaSOS.addQuery('urgency', 'Critical');
            gaSOS.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaSOS.addAggregate('COUNT');
            gaSOS.query();
            if (gaSOS.next()) {
                data.sosCount = parseInt(gaSOS.getAggregate('COUNT')) || 0;
            }
        } catch (e) {
            gs.error("[Kokoro] Stats error: " + e.message);
        }

        data.volunteers = loadVolunteerList();
    }

    // ==========================================
// ]]>ğŸ”¥<![CDATA[ INPUT å¤„ç†é€»è¾‘ (å·²ä¿®å¤ä½œç”¨åŸŸä¸æ‰§è¡Œæµ)
// ==========================================
if (input) {
	
	// CSRF Token éªŒè¯ï¼ˆå†™å…¥æ“ä½œå¿…é¡»éªŒè¯ï¼‰
    var writeActions = [
        'submit_record', 'update_record', 'submit_sos',
        'save_settings', 'register_heartbeat',
        'send_friend_request', 'accept_friend_request',
        'reject_friend_request', 'remove_friend',
        'send_emergency_call', 'send_friend_message',
        'generate_friend_code', 'verify_friend_code'
    ];
    
    if (input.action && writeActions.indexOf(input.action) !== -1) {
        if (!validateCSRF(input.csrf_token)) {
            data.error = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
            data.csrf_failed = true;
            return;
        }
    }

    // --- 1. å¥½å‹éªŒè¯ç  - ç”Ÿæˆ ---
    if (input.action === 'generate_friend_code') {
        try {
            if (data.is_guest) {
                data.error = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
            } else {
                // å®šä¹‰é™æµæ ‡è¯†ç¬¦ (ä¿®å¤ used out of scope æŠ¥é”™)
                var hbIdentifier = data.is_guest ? input.guest_token : data.user_id;

                // é¢‘ç‡æ£€æŸ¥ï¼š5åˆ†é’Ÿå†…æœ€å¤š3æ¬¡
                var hbRateCheck = RateLimiter.check(hbIdentifier, 'HEARTBEAT', 5, 3);
                if (!hbRateCheck.allowed) {
                    data.error = hbRateCheck.message;
                } else {
                    // é€»è¾‘ï¼šä½¿è¯¥ç”¨æˆ·ä¹‹å‰ç”Ÿæˆçš„æœªä½¿ç”¨ä»£ç å¤±æ•ˆ
                    var oldCode = new GlideRecord(CONFIG.tables.FRIEND_VERIFICATION);
                    oldCode.addQuery('initiator', data.user_id);
                    oldCode.addQuery('is_used', false);
                    oldCode.query();
                    while (oldCode.next()) {
                        oldCode.setValue('is_used', true);
                        oldCode.update();
                    }

                    // ç”Ÿæˆéšæœº 6 ä½éªŒè¯ç 
                    var code = String(Math.floor(100000 + Math.random() * 900000));

                    var fv = new GlideRecord(CONFIG.tables.FRIEND_VERIFICATION);
                    fv.initialize();
                    fv.setValue('verification_code', code);
                    fv.setValue('initiator', data.user_id);
                    fv.setValue('created_at', new GlideDateTime());

                    var expires = new GlideDateTime();
                    expires.addSeconds(15 * 60); // 15åˆ†é’Ÿæœ‰æ•ˆæœŸ
                    fv.setValue('expires_at', expires);
                    fv.setValue('is_used', false);

                    if (fv.insert()) {
                        data.friend_code = code;
                        data.code_expires_in = 15;
                        data.success = true;

                        // åªæœ‰æ•°æ®åº“æ’å…¥æˆåŠŸï¼Œæ‰è®°å½•ä¸€æ¬¡æœ‰æ•ˆé¢‘ç‡
                        RateLimiter.record(hbIdentifier, 'HEARTBEAT');
                    }
                }
            }
        } catch (e) {
            gs.error('[Kokoro] Generate friend code error: ' + e.message);
            data.error = 'ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼';
        }
        // æ³¨æ„ï¼šæ­¤å¤„å·²åˆ é™¤åŸæœ‰çš„å­¤ç«‹ returnï¼Œä»¥ç¡®ä¿ä¸‹æ–¹ verify_friend_code èƒ½è¢«æ‰§è¡Œ
    }

    // --- 2. å¥½å‹éªŒè¯ç  - éªŒè¯ ---
    if (input.action === 'verify_friend_code') {
        try {
            if (data.is_guest) {
                data.error = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
            } else {
                var inputCode = sanitizeInput(input.code, 6);
                if (!inputCode || inputCode.length !== 6) {
                    data.error = '6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                } else {
                    var fvGr = new GlideRecord(CONFIG.tables.FRIEND_VERIFICATION);
                    fvGr.addQuery('verification_code', inputCode);
                    fvGr.addQuery('is_used', false);
                    fvGr.addQuery('expires_at', '>', new GlideDateTime());
                    fvGr.addQuery('initiator', '!=', data.user_id);
                    fvGr.setLimit(1);
                    fvGr.query();

                    if (!fvGr.next()) {
                        data.error = 'ã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™';
                    } else {
                        var initiatorId = fvGr.getValue('initiator');

                        if (checkFriendStatus(data.user_id, initiatorId)) {
                            data.error = 'ã™ã§ã«å‹é”ã§ã™';
                            fvGr.setValue('is_used', true);
                            fvGr.update();
                        } else {
                            // å»ºç«‹åŒå‘å¥½å‹å…³ç³»
                            var delRel1 = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                            delRel1.initialize();
                            delRel1.setValue('user', data.user_id);
                            delRel1.setValue('friend', initiatorId);
                            delRel1.setValue('status', 'accepted');
                            delRel1.setValue('created_at', new GlideDateTime());
                            delRel1.setValue('accepted_at', new GlideDateTime());
                            delRel1.setValue('alert_enabled', true);
                            delRel1.insert();

                            var delRel2 = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                            delRel2.initialize();
                            delRel2.setValue('user', initiatorId);
                            delRel2.setValue('friend', data.user_id);
                            delRel2.setValue('status', 'accepted');
                            delRel2.setValue('created_at', new GlideDateTime());
                            delRel2.setValue('accepted_at', new GlideDateTime());
                            delRel2.setValue('alert_enabled', true);
                            delRel2.insert();

                            // æ ‡è®°éªŒè¯ç å·²ä½¿ç”¨
                            fvGr.setValue('is_used', true);
                            fvGr.setValue('matched_user', data.user_id);
                            fvGr.update();

                            // è·å–å¯¹æ–¹å§“åç”¨äºåé¦ˆ
                            var initiatorUser = new GlideRecord('sys_user');
                            var friendName = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                            if (initiatorUser.get(initiatorId)) {
                                friendName = initiatorUser.getDisplayValue('name');
                            }

                            // å‘é€ç³»ç»Ÿé€šçŸ¥
                            createFriendNotification(data.user_id, initiatorId, 
                                'friend_verified', 
                                data.user_name + ' ã¨ç›´æ¥è®¤è¯ã§å‹é”ã«ãªã‚Šã¾ã—ãŸ', null);

                            data.success = true;
                            data.new_friend_name = friendName;
                            data.message = friendName + ' ã¨å‹é”ã«ãªã‚Šã¾ã—ãŸ';

                            logProcessEvent(data.user_id, 
                                'Friend verified face-to-face with ' + initiatorId, data.user_id);
                        }
                    }
                }
            }
        } catch (e) {
            gs.error('[Kokoro] Verify friend code error: ' + e.message);
            data.error = 'èªè¨¼ã‚¨ãƒ©ãƒ¼';
        }
    }


        // æ¸¸å®¢ç³»ç»Ÿ - åˆå§‹åŒ–
        if (input.action === 'guest_init') {
            try {
                if (input.guest_token) {
                    var validation = validateGuestToken(input.guest_token);
                    if (validation.valid) {
                        data.guest_token = input.guest_token;
                        data.auth_mode = 'guest';
                        data.success = true;
                        
                        if (validation.linked_user) {
                            data.upgrade_hint = true;
                        }
                    } else {
                        var newToken = generateGuestToken();
                        data.guest_token = newToken;
                        data.auth_mode = 'guest';
                        data.success = true;
                        data.token_refreshed = true;
                    }
                } else {
                    var freshToken = generateGuestToken();
                    data.guest_token = freshToken;
                    data.auth_mode = 'guest';
                    data.success = true;
                }
            } catch (e) {
                gs.error('[Kokoro] Guest init error: ' + e.message);
                data.error = 'ã‚²ã‚¹ãƒˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // ä¸€æ¬¡æ€§é“¾æ¥å¿ƒè·³
        if (input.action === 'heartbeat_by_token') {
            try {
                var hbToken = input.heartbeat_token;
                var result = consumeHeartbeatToken(hbToken);
                
                if (!result.valid) {
                    data.error = 'ãƒªãƒ³ã‚¯ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™';
                    return;
                }
                
                var hb = new GlideRecord(CONFIG.tables.HEARTBEAT);
                hb.initialize();
                
                if (result.target_user) {
                    hb.setValue('u_user', result.target_user);
                }
                hb.setValue('u_timestamp', new GlideDateTime());
                hb.setValue('u_status', 'Safe');
                hb.setValue('u_source', 'one_time_link');
                
                if (result.guest_token) {
                    hb.setValue('guest_token', result.guest_token);
                }
                
                var hbId = hb.insert();
                data.heartbeat_id = hbId;
                data.success = true;
                data.message = 'ç”Ÿå­˜ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ';
                
            } catch (e) {
                gs.error('[Kokoro] Token heartbeat error: ' + e.message);
                data.error = 'ç”Ÿå­˜ç¢ºèªã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // è·å–å¿—æ„¿è€…åˆ—è¡¨
        if (input.action === 'get_volunteers') {
            data.volunteers = loadVolunteerList();
            data.success = true;
            return;
        }

        // ä¿å­˜è®¾ç½®
        if (input.action === 'save_settings') {
            try {
                var successProfile = false;
                var successWill = true;

                var grUp = new GlideRecord(CONFIG.tables.USER_PROFILE);
                grUp.addQuery('user', data.user_id);
                grUp.query();

                if (grUp.next()) {
                    grUp.setValue('emergency_contact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.update() != null);
                } else {
                    grUp.initialize();
                    grUp.setValue('user', data.user_id);
                    grUp.setValue('emergency_contact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.insert() != null);
                }

                if (input.will && String(input.will).trim() !== '') {
                    var oldMsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldMsg.addQuery('user', data.user_id);
                    oldMsg.addQuery('is_active', true);
                    oldMsg.addQuery('message_type', 'Last_Will');
                    oldMsg.query();
                    while (oldMsg.next()) {
                        oldMsg.setValue('is_active', false);
                        oldMsg.update();
                    }

                    var emsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsg.initialize();
                    emsg.setValue('user', data.user_id);
                    emsg.setValue('message_encrypted', sanitizeInput(input.will, 4000));
                    emsg.setValue('message_type', 'Last_Will');
                    emsg.setValue('is_active', true);
                    emsg.setValue('created_at', new GlideDateTime());
                    successWill = (emsg.insert() != null);
                }

                if (successProfile && successWill) {
                    data.success = true;
                    logProcessEvent(data.user_id, 'User settings updated', data.user_id);
                } else {
                    data.error = "ä¿å­˜å¤±æ•—";
                }

            } catch (e) {
                gs.error("[Kokoro] Save error: " + e.message);
                data.error = "ä¿å­˜ã‚¨ãƒ©ãƒ¼";
            }
            return;
        }
			
			// ä¸€é”®SOSç´§æ€¥æäº¤
if (input.action === 'submit_sos') {
    try {
        // --- ä¿®æ­£1ï¼šç»Ÿä¸€æ ‡è¯†ç¬¦å£°æ˜ (è§£å†³ already defined) ---
        var sosIdentifier = data.is_guest ? (input.guest_token || 'guest') : data.user_id;
        
        // Rate Limit: 5åˆ†é’Ÿå†…æœ€å¤š3æ¬¡
        var sosRateCheck = RateLimiter.check(sosIdentifier, 'SUBMIT', 5, 3);
        if (!sosRateCheck.allowed) {
            data.error = sosRateCheck.message;
        } else {
            var sosGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            sosGr.initialize();
            
            // --- ä¿®æ­£2ï¼šä¿®å¤å˜é‡åé”™è¯¯ (å°† gr æ”¹ä¸º sosGrï¼Œè§£å†³ out of scope) ---
            var submitUserId = gs.getUserID();
            sosGr.setValue('opened_by', submitUserId);
            
            if (data.is_guest && input.guest_token) {
                sosGr.setValue('guest_token', input.guest_token);
            }
            
            sosGr.setValue('state', CONFIG.wishStates.SUBMITTED);
            sosGr.setValue('shelter_zone', 'SOS');
            sosGr.setValue('precise_location', sanitizeInput(input.detail_loc, 500));
            sosGr.setValue('request_category', 'Other');
            sosGr.setValue('qty', 1);
            sosGr.setValue('urgency', 'Critical');
            sosGr.setValue('u_affected_count', sanitizeInput(input.affected_count, 10));
            sosGr.setValue('u_contact_info', sanitizeInput(input.contact, 200));
            
            // GPSåæ ‡ä¿å­˜
            if (input.gps_lat && input.gps_lng) {
                sosGr.setValue('gps_latitude', String(input.gps_lat));
                sosGr.setValue('gps_longitude', String(input.gps_lng));
            }
            
            var sosDescription = 
                ']]>ğŸ†˜<![CDATA[ã€ç·Šæ€¥SOS - ãƒ¯ãƒ³ã‚¿ãƒƒãƒé€ä¿¡ã€‘\n' +
                'ã€ä½ç½®ã€‘: ' + sanitizeInput(input.detail_loc, 500) + '\n' +
                'ã€å‚™è€ƒã€‘: ' + sanitizeInput(input.remarks, 1000) + '\n' +
                'ã€é€ä¿¡æ–¹å¼ã€‘: ä¸€é”®SOS (' + (data.is_guest ? 'ã‚²ã‚¹ãƒˆ' : 'èªè¨¼æ¸ˆ') + ')';
            
            sosGr.setValue('wish_content', sosDescription);
            sosGr.setValue('additional_comments', sanitizeInput(input.remarks, 1000));
            
            var sosSysId = sosGr.insert();
            
            if (sosSysId) {
                data.ticketNumber = sosGr.getValue('number');
                data.newRecordID = sosSysId;
                data.success = true;
                data.my_requests = getMyRequests(data.user_id, data.guest_token);
                
                logProcessEvent(sosSysId, 
                    'SOS submitted (one-touch) GPS:' + 
                    (input.gps_lat ? input.gps_lat + ',' + input.gps_lng : 'N/A'), 
                    data.user_id);
                
                // è®°å½•æœ‰æ•ˆé¢‘ç‡
                RateLimiter.record(sosIdentifier, 'SUBMIT');
                
                // è§¦å‘ç´§æ€¥äº‹ä»¶
                try {
                    gs.eventQueue('kokoro.sos.emergency', sosGr, data.user_id, 
                        sanitizeInput(input.detail_loc, 200));
                } catch (eventErr) {
                    gs.warn('[Kokoro] SOS event queue error: ' + eventErr.message);
                }
            } else {
                data.error = 'SOSä½œæˆå¤±æ•—';
            }
        }
    } catch (e) {
        gs.error('[Kokoro] SOS submit error: ' + e.message);
        data.error = 'SOSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    }
    // ä¿®æ­£3ï¼šç¡®ä¿ return åæ²¡æœ‰ç´§è·Ÿé€»è¾‘ï¼Œæˆ–ä½¿ç”¨ else if ç»“æ„
}

        // ]]>ğŸ”¥<![CDATA[ æäº¤/æ›´æ–°è®°å½• (ä¿®æ­£æ•°æ®ä¿å­˜é€»è¾‘)
        if (input.action === 'submit_record' || input.action === 'update_record') {
            // ... (å‰é¢çš„éªŒè¯ä»£ç ä¿æŒä¸å˜) ...

            try {
							// Rate Limit: 5åˆ†é’Ÿå†…æœ€å¤š3æ¬¡ï¼ˆä¸SOSå…±äº«é¢åº¦ï¼‰
        var submitIdentifier = data.is_guest ? input.guest_token : data.user_id;
        var submitRateCheck = RateLimiter.check(submitIdentifier, 'SUBMIT', 5, 3);
        if (!submitRateCheck.allowed) {
            data.error = submitRateCheck.message;
            return;
        }
                var gr = new GlideRecord(CONFIG.tables.SILENT_WISH);
                
                // ç¡®å®šæ˜¯æ›´æ–°è¿˜æ˜¯æ–°å»º
                if (input.action === 'update_record' && input.sys_id) {
                    if (!gr.get(input.sys_id)) {
                        data.error = "ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                        return;
                    }
                } else {
                    gr.initialize();
                    
                    // ]]>ğŸ”¥<![CDATA[ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶è·å–å½“å‰ç”¨æˆ·IDï¼Œé˜²æ­¢ä¸º null
                    var currentUserId = gs.getUserID(); 
                    gr.setValue('opened_by', currentUserId);
                    
                    // å¦‚æœæ˜¯æ¸¸å®¢ï¼Œé¢å¤–ä¿å­˜ token
                    if (data.is_guest && input.guest_token) {
                        gr.setValue('guest_token', input.guest_token);
                    }
                    
                    gr.setValue('state', CONFIG.wishStates.SUBMITTED);
                }

                gr.setValue('shelter_zone', sanitizeInput(input.location, 100));
								gr.setValue('request_category', sanitizeInput(input.category, 50));
								gr.setValue('qty', parseInt(input.quantity) || 1);
								gr.setValue('urgency', sanitizeInput(input.urgency, 20));
								gr.setValue('u_affected_count', sanitizeInput(input.affected_count, 10));
								gr.setValue('additional_comments', sanitizeInput(input.remarks, 1000));
								gr.setValue('u_contact_info', sanitizeInput(input.contact, 200));
								gr.setValue('precise_location', sanitizeInput(input.detail_loc, 200));

                var fullDescription =
                    "ã€è©³ç´°å ´æ‰€ã€‘: " + sanitizeInput(input.detail_loc, 200) + "\n" +
                    "ã€æ”¯æ´ç¨®åˆ¥ã€‘: " + input.category + " x " + (input.quantity || 1) + "\n" +
                    "ã€ç·Šæ€¥åº¦ã€‘: " + input.urgency + "\n" +
                    "ã€å¯¾è±¡äººæ•°ã€‘: " + (input.affected_count || '1') + "\n" +
                    "ã€å‚™è€ƒã€‘: " + (input.remarks || 'ãªã—');

                gr.setValue('wish_content', fullDescription);
                
                if (input.action === 'submit_record') {
                    var sysId = gr.insert();
                    if (sysId) {
                        data.ticketNumber = gr.getValue('number');
                        data.newRecordID = sysId;
                        data.success = true;
											
											RateLimiter.record(submitIdentifier, 'SUBMIT');

                        // âœ… ã€å…³é”®ä¿®å¤ã€‘ç«‹å³åˆ·æ–°å†å²è®°å½•
                        data.my_requests = getMyRequests(data.user_id, data.guest_token);
                        gs.info("[Kokoro] æäº¤æˆåŠŸï¼Œå†å²è®°å½•æ•°é‡: " + data.my_requests.length);

                        logProcessEvent(sysId, 'Wish submitted: ' + input.category, data.user_id);
											// é€šçŸ¥ï¼šCriticalè¯·æ±‚è§¦å‘ç´§æ€¥äº‹ä»¶
if (input.urgency === 'Critical') {
    try {
        gs.eventQueue('kokoro.wish.critical', gr, data.user_id, 
            sanitizeInput(input.category, 50) + ' - ' + sanitizeInput(input.detail_loc, 100));
    } catch (evtErr) {
        gs.warn('[Kokoro] Critical event error: ' + evtErr.message);
    }
}
                    } else {
                        data.error = "ä½œæˆå¤±æ•—";
                    }
                } else {
                    if (gr.update()) {
                        data.ticketNumber = gr.getValue('number');
                        data.success = true;

                        // âœ… ã€å…³é”®ä¿®å¤ã€‘æ›´æ–°æˆåŠŸåä¹Ÿåˆ·æ–°
                        data.my_requests = getMyRequests(data.user_id, data.guest_token);
                        gs.info("[Kokoro] æ›´æ–°æˆåŠŸï¼Œå†å²è®°å½•æ•°é‡: " + data.my_requests.length);

                        logProcessEvent(input.sys_id, 'Wish updated', data.user_id);
                    } else {
                        data.error = "æ›´æ–°å¤±æ•—";
                    }
                }

            } catch (e) {
                gs.error("[Kokoro] Submit error: " + e.message);
                data.error = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            }
            return;
        }

        // è´¦æˆ·å‡çº§
        if (input.action === 'upgrade_guest_account') {
            try {
                if (!input.guest_token) {
                    data.error = 'ã‚²ã‚¹ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™';
                    return;
                }
                
                if (data.is_guest) {
                    data.error = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„';
                    return;
                }
                
                var guestValidation = validateGuestToken(input.guest_token);
                if (!guestValidation.valid) {
                    data.error = 'ã‚²ã‚¹ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™';
                    return;
                }
                
                var wishGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
                wishGr.addQuery('guest_token', input.guest_token);
                wishGr.query();
                var migratedCount = 0;
                
                while (wishGr.next()) {
                    wishGr.setValue('opened_by', data.user_id);
                    wishGr.update();
                    migratedCount++;
                }
                
                var hbGr = new GlideRecord(CONFIG.tables.HEARTBEAT);
                hbGr.addQuery('guest_token', input.guest_token);
                hbGr.query();
                
                while (hbGr.next()) {
                    hbGr.setValue('u_user', data.user_id);
                    hbGr.update();
                }
                
                var emGr = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                emGr.addQuery('guest_token', input.guest_token);
                emGr.query();
                
                while (emGr.next()) {
                    emGr.setValue('user', data.user_id);
                    emGr.update();
                }
                
                var tokenGr = new GlideRecord(CONFIG.tables.GUEST_TOKEN);
                tokenGr.addQuery('token', input.guest_token);
                tokenGr.setLimit(1);
                tokenGr.query();
                
                if (tokenGr.next()) {
                    tokenGr.setValue('linked_user', data.user_id);
                    tokenGr.update();
                }
                
                data.success = true;
                data.migrated_wishes = migratedCount;
                data.message = migratedCount + 'ä»¶ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç§»è¡Œã—ã¾ã—ãŸ';
                
                logProcessEvent(data.user_id, 
                    'Guest account upgraded. Token: ' + input.guest_token + 
                    ', Migrated: ' + migratedCount, data.user_id);
                
            } catch (e) {
                gs.error('[Kokoro] Account upgrade error: ' + e.message);
                data.error = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // è·å–å†å²è®°å½•
        if (input.action === 'get_my_history') {
            try {
                data.my_requests = getMyRequests(data.user_id, data.guest_token);
                data.success = true;
            } catch (e) {
                gs.error("[Kokoro] Get history error: " + e.message);
                data.error = "å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼";
            }
            return;
        }

        // ä¸Šä¼ é™„ä»¶
        if (input.action === 'upload_attachment' && input.sys_id) {
            try {
                if (!validateSysId(input.sys_id)) {
                    data.error = "ç„¡åŠ¹ãªID";
                    return;
                }
                var attachment = new GlideSysAttachment();
                if (input.file_data) {
                    var cleanBase64 = input.file_data.split(',')[1] || input.file_data;
                    attachment.writeBase64(
                        input.table || CONFIG.tables.SILENT_WISH,
                        input.sys_id,
                        sanitizeInput(input.file_name, 100),
                        input.content_type,
                        cleanBase64
                    );
                    data.success = true;
                }
            } catch (e) {
                gs.error("[Kokoro] Attachment error: " + e.message);
            }
            return;
        }

        // æ³¨å†Œå¿ƒè·³
        if (input.action === 'register_heartbeat') {
            try {
							// Rate Limit: 1åˆ†é’Ÿå†…æœ€å¤š2æ¬¡
        var regHbIdentifier = data.is_guest ? (input.guest_token || 'guest') : data.user_id;
var regHbRateCheck = RateLimiter.check(regHbIdentifier, 'HEARTBEAT', 1, 2);
        if (!regHbRateCheck.allowed) {
    data.error = regHbRateCheck.message;
            return;
        }
                var hbReg = new GlideRecord(CONFIG.tables.HEARTBEAT);
                hbReg.initialize();
                hbReg.setValue('u_timestamp', new GlideDateTime());
                hbReg.setValue('u_status', 'Safe');

                if (data.is_guest && input.guest_token) {
                    hbReg.setValue('guest_token', input.guest_token);
                    hbReg.setValue('u_source', 'guest_portal');
                } else {
                    hbReg.setValue('u_user', data.user_id);
                    hbReg.setValue('u_source', 'authenticated_portal');
                }

                var hbRegId = hbReg.insert();
                data.heartbeat_id = hbRegId;
                data.success = true;

                if (data.is_guest && input.guest_token) {
                    var nextHbToken = generateHeartbeatToken(input.guest_token, true);
                    data.next_heartbeat_link = '?id=kokoro_heartbeat&token=' + nextHbToken;
                }
                
                logProcessEvent(hbRegId, 'Heartbeat registered (' + 
                    (data.is_guest ? 'guest' : 'auth') + ')', 
                    data.user_id);
            } catch (e) {
                gs.error("[Kokoro] Heartbeat error: " + e.message);
                data.error = "ç”Ÿå­˜ç¢ºèªã‚¨ãƒ©ãƒ¼";
            }
            return;
        }

        // æ›´æ–°é—å˜±
        if (input.action === 'update_will') {
            try {
                if (input.message) {
                    var oldQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldQuick.addQuery('user', data.user_id);
                    oldQuick.addQuery('is_active', true);
                    oldQuick.addQuery('message_type', 'Quick_Will');
                    oldQuick.query();
                    while (oldQuick.next()) {
                        oldQuick.setValue('is_active', false);
                        oldQuick.update();
                    }

                    var emsgQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsgQuick.initialize();
                    emsgQuick.setValue('user', data.user_id);
                    emsgQuick.setValue('message_encrypted', sanitizeInput(input.message, 4000));
                    emsgQuick.setValue('message_type', 'Quick_Will');
                    emsgQuick.setValue('is_active', true);
                    emsgQuick.setValue('created_at', new GlideDateTime());

                    if (emsgQuick.insert()) {
                        data.success = true;
                    }
                }
            } catch (e) {
                gs.error("[Kokoro] Quick will error: " + e.message);
            }
            return;
        }

        // è·å–å®ˆæŠ¤åœˆæ•°æ®
        if (input.action === 'get_guardian_data') {
            try {
                if (data.is_guest) {
                    data.error = 'ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                    data.require_login = true;
                    return;
                }

                var guardianData = {
                    friends: [],
                    friend_requests: [],
                    notification_count: 0,
                    recommended: []
                };

                var friendGr = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                friendGr.addQuery('user', data.user_id);
                friendGr.addQuery('status', 'accepted');
                friendGr.orderByDesc('last_interact');
                friendGr.query();

                while (friendGr.next()) {
                    var friendId = friendGr.getValue('friend');
                    var friendUser = new GlideRecord('sys_user');

                    if (friendUser.get(friendId)) {
                        var heartbeat = getLatestHeartbeat(friendId);

                        var friendItem = {
                            relation_id: friendGr.getUniqueValue(),
                            user_id: friendId,
                            display_name: friendGr.getValue('nickname') || friendUser.getDisplayValue('name'),
                            email: friendUser.getValue('email'),
                            is_family: false,
                            heartbeat_status: heartbeat.status,
                            last_heartbeat_time: heartbeat.time_ago,
                            current_zone: heartbeat.zone,
                            status_message: heartbeat.message,
                            share_location: friendGr.getValue('share_loc') == 'true',
                            alert_enabled: friendGr.getValue('alert_enabled') == 'true'
                        };

                        guardianData.friends.push(friendItem);
                    }
                }

                var requestGr = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                requestGr.addQuery('friend', data.user_id);
                requestGr.addQuery('status', 'pending');
                requestGr.orderByDesc('sys_created_on');
                requestGr.query();

                while (requestGr.next()) {
                    var fromUserId = requestGr.getValue('user');
                    var fromUser = new GlideRecord('sys_user');

                    if (fromUser.get(fromUserId)) {
                        var created = new GlideDateTime(requestGr.sys_created_on);
                        var now = new GlideDateTime();
                        var diffMs = GlideDateTime.subtract(now, created).getNumericValue();
                        var minutes = Math.floor(diffMs / 1000 / 60);

                        var timeAgo = '';
                        if (minutes < 60) {
                            timeAgo = minutes + "åˆ†å‰";
                        } else if (minutes < 1440) {
                            timeAgo = Math.floor(minutes / 60) + "æ™‚é–“å‰";
                        } else {
                            timeAgo = Math.floor(minutes / 1440) + "æ—¥å‰";
                        }

                        guardianData.friend_requests.push({
                            sys_id: requestGr.getUniqueValue(),
                            from_user_id: fromUserId,
                            from_user_name: fromUser.getDisplayValue('name'),
                            from_user_email: fromUser.getValue('email'),
                            message: '',
                            time_ago: timeAgo,
                            created_at: requestGr.getDisplayValue('sys_created_on')
                        });
                    }
                }

                var notifGa = new GlideAggregate(CONFIG.tables.FRIEND_NOTIFICATION);
                notifGa.addQuery('to_user', data.user_id);
                notifGa.addQuery('is_read', false);
                notifGa.addAggregate('COUNT');
                notifGa.query();

                if (notifGa.next()) {
                    guardianData.notification_count = parseInt(notifGa.getAggregate('COUNT')) || 0;
                }

                guardianData.recommended = getRecommendedFriends(data.user_id);

                data.friends = guardianData.friends;
                data.friend_requests = guardianData.friend_requests;
                data.friend_notifications = guardianData.notification_count;
                data.recommended = guardianData.recommended;
                data.success = true;

            } catch (e) {
                gs.error('[Kokoro Guardian] Get data error: ' + e.message);
                data.error = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // æœç´¢ç”¨æˆ·
        if (input.action === 'search_users' && input.query) {
            try {
                if (data.is_guest) {
                    data.error = 'ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                    data.require_login = true;
                    return;
                }

                var query = sanitizeInput(input.query, 100).toLowerCase();
                var results = [];

                var userGr = new GlideRecord('sys_user');
                userGr.addQuery('active', true);
                userGr.addQuery('sys_id', '!=', data.user_id);

                var qc = userGr.addQuery('name', 'CONTAINS', query);
                qc.addOrCondition('email', 'CONTAINS', query);
                qc.addOrCondition('user_name', 'CONTAINS', query);

                userGr.setLimit(20);
                userGr.query();

                while (userGr.next()) {
                    var userId = userGr.getUniqueValue();

                    var isAlreadyFriend = checkFriendStatus(data.user_id, userId);
                    var requestSent = checkPendingRequest(data.user_id, userId);

                    results.push({
                        sys_id: userId,
                        name: userGr.getDisplayValue('name'),
                        email: userGr.getValue('email'),
                        user_name: userGr.getValue('user_name'),
                        already_friend: isAlreadyFriend,
                        request_sent: requestSent
                    });
                }

                data.results = results;
                data.success = true;

            } catch (e) {
                gs.error('[Kokoro Guardian] Search error: ' + e.message);
                data.error = 'æ¤œç´¢ã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // å‘é€å¥½å‹è¯·æ±‚
if (input.action === 'send_friend_request' && input.friend_id) {
    try {
        if (data.is_guest) {
            data.error = 'ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
            data.require_login = true;
            return;
        }
        
        // 1. é¢‘ç‡æ£€æŸ¥ï¼š10åˆ†é’Ÿå†…æœ€å¤š5æ¬¡
        var friendRateCheck = RateLimiter.check(data.user_id, 'FRIEND_REQ', 10, 5);
        if (!friendRateCheck.allowed) {
            data.error = friendRateCheck.message;
            return;
        }

        if (!validateSysId(input.friend_id)) {
            data.error = 'ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ID';
            return;
        }

        if (checkFriendStatus(data.user_id, input.friend_id)) {
            data.error = 'ã™ã§ã«å‹é”ã§ã™';
            return;
        }

        if (checkPendingRequest(data.user_id, input.friend_id)) {
            data.error = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ—¢ã«é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™';
            return;
        }

        var friendRel = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
        friendRel.initialize();
        friendRel.setValue('user', data.user_id);
        friendRel.setValue('friend', input.friend_id);
        friendRel.setValue('status', 'pending');
        friendRel.setValue('created_at', new GlideDateTime());
        friendRel.setValue('alert_enabled', true);

        // 2. æ‰§è¡Œæ•°æ®åº“æ’å…¥
        var relId = friendRel.insert();

        if (relId) {
            createFriendNotification(
                data.user_id,
                input.friend_id,
                'friend_request',
                data.user_name + ' ãŒã‚ãªãŸã«å‹é”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ',
                relId
            );

            data.success = true;
            logProcessEvent(relId, 'Friend request sent to ' + input.friend_id, data.user_id);

            
            RateLimiter.record(data.user_id, 'FRIEND_REQ');

        } else {
            data.error = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å¤±æ•—';
        }

    } catch (e) {
        gs.error('[Kokoro Guardian] Send request error: ' + e.message);
        data.error = 'é€ä¿¡ã‚¨ãƒ©ãƒ¼';
    }
    return;
}

        // æ¥å—å¥½å‹è¯·æ±‚
        if (input.action === 'accept_friend_request' && input.request_id) {
            try {
                if (data.is_guest) {
                    data.error = 'ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                    data.require_login = true;
                    return;
                }

                if (!validateSysId(input.request_id)) {
                    data.error = 'ç„¡åŠ¹ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆID';
                    return;
                }

                var acceptGr = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                if (!acceptGr.get(input.request_id)) {
                    data.error = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    return;
                }

                if (acceptGr.getValue('friend') != data.user_id) {
                    data.error = 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                    return;
                }

                acceptGr.setValue('status', 'accepted');
                acceptGr.setValue('accepted_at', new GlideDateTime());
                acceptGr.update();

                var reverseRel = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                reverseRel.initialize();
                reverseRel.setValue('user', data.user_id);
                reverseRel.setValue('friend', acceptGr.getValue('user'));
                reverseRel.setValue('status', 'accepted');
                reverseRel.setValue('created_at', new GlideDateTime());
                reverseRel.setValue('accepted_at', new GlideDateTime());
                reverseRel.setValue('alert_enabled', true);
                reverseRel.insert();

                createFriendNotification(
                    data.user_id,
                    acceptGr.getValue('user'),
                    'friend_request_accepted',
                    data.user_name + ' ãŒã‚ãªãŸã®å‹é”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èªã—ã¾ã—ãŸ',
                    acceptGr.getUniqueValue()
                );

                data.success = true;
                logProcessEvent(input.request_id, 'Friend request accepted', data.user_id);

            } catch (e) {
                gs.error('[Kokoro Guardian] Accept request error: ' + e.message);
                data.error = 'æ‰¿èªã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // æ‹’ç»å¥½å‹è¯·æ±‚
        if (input.action === 'reject_friend_request' && input.request_id) {
            try {
                if (data.is_guest) {
                    data.error = 'ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                    data.require_login = true;
                    return;
                }

                if (!validateSysId(input.request_id)) {
                    data.error = 'ç„¡åŠ¹ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆID';
                    return;
                }

                var rejectGr = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                if (!rejectGr.get(input.request_id)) {
                    data.error = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    return;
                }

                if (rejectGr.getValue('friend') != data.user_id) {
                    data.error = 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                    return;
                }

                rejectGr.setValue('status', 'rejected');
                rejectGr.update();

                data.success = true;
                logProcessEvent(input.request_id, 'Friend request rejected', data.user_id);

            } catch (e) {
                gs.error('[Kokoro Guardian] Reject request error: ' + e.message);
                data.error = 'æ‹’å¦ã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // å‘é€ç´§æ€¥å‘¼å«
        if (input.action === 'send_emergency_call' && input.friend_id) {
            try {
                if (data.is_guest) {
                    data.error = 'ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                    data.require_login = true;
                    return;
                }

                if (!validateSysId(input.friend_id)) {
                    data.error = 'ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ID';
                    return;
                }

                if (!checkFriendStatus(data.user_id, input.friend_id)) {
                    data.error = 'å‹é”ã§ã¯ã‚ã‚Šã¾ã›ã‚“';
                    return;
                }

                createFriendNotification(
                    data.user_id,
                    input.friend_id,
                    'emergency_alert',
                    ']]>ğŸ†˜<![CDATA[ ' + data.user_name + ' ãŒç·Šæ€¥å‘¼ã³å‡ºã—ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼',
                    null
                );

                gs.eventQueue('kokoro.friend.emergency_call', null, input.friend_id, data.user_name);

                data.success = true;
                logProcessEvent(input.friend_id, 'Emergency call sent', data.user_id);

            } catch (e) {
                gs.error('[Kokoro Guardian] Emergency call error: ' + e.message);
                data.error = 'é€ä¿¡ã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // å‘é€å¥½å‹æ¶ˆæ¯
        if (input.action === 'send_friend_message' && input.friend_id && input.message) {
            try {
                if (!validateSysId(input.friend_id)) {
                    data.error = 'ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ID';
                    return;
                }

                if (!checkFriendStatus(data.user_id, input.friend_id)) {
                    data.error = 'å‹é”ã§ã¯ã‚ã‚Šã¾ã›ã‚“';
                    return;
                }

                var message = sanitizeInput(input.message, 500);

                createFriendNotification(
                    data.user_id,
                    input.friend_id,
                    'message',
                    data.user_name + ': ' + message,
                    null
                );

                data.success = true;

            } catch (e) {
                gs.error('[Kokoro Guardian] Send message error: ' + e.message);
                data.error = 'é€ä¿¡ã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // ç§»é™¤å¥½å‹
        if (input.action === 'remove_friend' && input.friend_id) {
            try {
                if (data.is_guest) {
                    data.error = 'ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                    data.require_login = true;
                    return;
                }

                if (!validateSysId(input.friend_id)) {
                    data.error = 'ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ID';
                    return;
                }

                var rel1 = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                rel1.addQuery('user', data.user_id);
                rel1.addQuery('friend', input.friend_id);
                rel1.query();
                if (rel1.next()) {
                    rel1.deleteRecord();
                }

                var rel2 = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                rel2.addQuery('user', input.friend_id);
                rel2.addQuery('friend', data.user_id);
                rel2.query();
                if (rel2.next()) {
                    rel2.deleteRecord();
                }

                data.success = true;
                logProcessEvent(input.friend_id, 'Friend removed', data.user_id);

            } catch (e) {
                gs.error('[Kokoro Guardian] Remove friend error: ' + e.message);
                data.error = 'å‰Šé™¤ã‚¨ãƒ©ãƒ¼';
            }
            return;
        }

        // è·å–å¥½å‹çŠ¶æ€æ›´æ–°
        if (input.action === 'get_friend_status_updates') {
            try {
                if (data.is_guest) {
                    data.error = 'ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                    data.require_login = true;
                    return;
                }

                var updates = [];

                var statusGr = new GlideRecord(CONFIG.tables.FRIEND_RELATION);
                statusGr.addQuery('user', data.user_id);
                statusGr.addQuery('status', 'accepted');
                statusGr.query();

                while (statusGr.next()) {
                    var targetId = statusGr.getValue('friend');
                    var targetHb = getLatestHeartbeat(targetId);

                    updates.push({
                        user_id: targetId,
                        status: targetHb.status,
                        time_ago: targetHb.time_ago,
                        zone: targetHb.zone
                    });
                }

                data.updates = updates;
                data.success = true;

            } catch (e) {
                gs.error('[Kokoro Guardian] Status update error: ' + e.message);
            }
            return;
        }

        // å¿—æ„¿è€…æ“ä½œ - ä»»åŠ¡ç®¡ç†
        if (input.sys_id) {
            if (!validateSysId(input.sys_id)) {
                data.error = "ç„¡åŠ¹ãªID";
                return;
            }

            var taskGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            if (!taskGr.get(input.sys_id)) {
                data.error = "ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                return;
            }

            var currentState = String(taskGr.getValue('state') || '10');

            if (input.action === 'assign_to_me') {
                if (!isVolunteer) {
                    data.error = "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ¨©é™ãŒå¿…è¦ã§ã™";
                    return;
                }
                taskGr.setValue('assigned_to', data.user_id);
                if (currentState === '1' || currentState === '10') {
                    var validationAssign = StateValidator.validateTransition(currentState, '11');
                    if (validationAssign.valid) {
                        taskGr.setValue('state', '11');
                    }
                }
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + data.user_name, data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'assign_to' && input.assignee_id) {
                if (!isVolunteer) {
                    data.error = "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ¨©é™ãŒå¿…è¦ã§ã™";
                    return;
                }
                taskGr.setValue('assigned_to', input.assignee_id);
                if (currentState === '1' || currentState === '10') {
                    var validationAssignTo = StateValidator.validateTransition(currentState, '11');
                    if (validationAssignTo.valid) {
                        taskGr.setValue('state', '11');
                    }
                }
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + input.assignee_id, data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'change_status' && input.new_state) {
                var newState = String(input.new_state);
                var validationChange = StateValidator.validateTransition(currentState, newState);
                if (!validationChange.valid) {
                    data.error = validationChange.message;
                    return;
                }
                if ((newState === '2' || newState === '4') && taskGr.assigned_to.nil()) {
                    data.error = "å…ˆã«æ‹…å½“è€…ã‚’è¨­å®šã—ã¦ãã ã•ã„";
                    return;
                }
                taskGr.setValue('state', newState);
                if (newState === '4') {
                    taskGr.setValue('u_completed_at', new GlideDateTime());
                }
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Status changed to ' + newState, data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'start') {
                var validationStart = StateValidator.validateTransition(currentState, '2');
                if (!validationStart.valid) {
                    data.error = validationStart.message;
                    return;
                }
                if (taskGr.getValue('assigned_to') != data.user_id && !gs.hasRole('admin')) {
                    data.error = "è‡ªåˆ†ã«æ‹…å½“ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®ã¿é–‹å§‹ã§ãã¾ã™";
                    return;
                }
                taskGr.setValue('state', '2');
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task started', data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'complete') {
                var validationComplete = StateValidator.validateTransition(currentState, '4');
                if (!validationComplete.valid) {
                    data.error = validationComplete.message;
                    return;
                }
                taskGr.setValue('state', '4');
                taskGr.setValue('u_completed_at', new GlideDateTime());
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task completed', data.user_id);
                } else {
                    data.error = "æ›´æ–°å¤±æ•—";
                }
                return;
            }

            if (input.action === 'add_comment' && input.message) {
                try {
                    taskGr.work_notes = sanitizeInput(input.message, 1000);
                    taskGr.update();
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Comment added', data.user_id);
                } catch (e) {
                    data.error = "ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ å¤±æ•—";
                }
                return;
            }
        }
    } // if (input) ç»“æŸ

    // ==========================================
    // é»˜è®¤åŠ è½½é€»è¾‘ (é¡µé¢åˆå§‹åŒ–)
    // ==========================================
    if (data.user_id || data.guest_token) {
        if (!data.my_requests || data.my_requests.length === 0) {
            data.my_requests = getMyRequests(data.user_id, data.guest_token);
        }

        if (!isGuestSession) {
            loadUserProfile();
            loadDigitalWill();
        }

        if (isVolunteer) {
            data.volunteers = loadVolunteerList();
        }
    }

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-26 11:35:13</sys_created_on>
        <sys_id>8e1c03ef83ee3210f6b1fb96feaad3bb</sys_id>
        <sys_mod_count>177</sys_mod_count>
        <sys_name>Kokoro User</sys_name>
        <sys_package display_value="Kokoro Shelter" source="x_1821654_kokoro_0">80ba4d9583863210f6b1fb96feaad3b2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Kokoro Shelter">80ba4d9583863210f6b1fb96feaad3b2</sys_scope>
        <sys_update_name>sp_widget_8e1c03ef83ee3210f6b1fb96feaad3bb</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-13 08:39:40</sys_updated_on>
        <template><![CDATA[<div class="kokoro-user-container" role="application" aria-label="Kokoroé¿é›£æ‰€æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ " lang="ja">
  <!-- åº”ç”¨å†…é€šçŸ¥ -->
  <div class="notification-stack" aria-live="polite" role="log">
    <div class="notification-toast" 
         ng-repeat="notif in c.notifications track by notif.id"
         ng-class="['toast-' + notif.type, {'toast-exit': !notif.visible}]"
         role="alert">
      <div class="toast-content">
        <div class="toast-title">{{notif.title}}</div>
        <div class="toast-message">{{notif.message}}</div>
      </div>
      <button class="toast-close" 
              ng-click="c.dismissNotification(notif.id)"
              aria-label="é€šçŸ¥ã‚’é–‰ã˜ã‚‹">&times;</button>
    </div>
  </div>
  <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºæ¡ -->
  <div class="network-status-bar" 
       ng-if="c.network_status !== 'online'"
       role="alert"
       aria-live="assertive">
    
    <div class="network-offline" ng-if="c.network_status === 'offline'">
      <i class="fa fa-wifi"></i>
      <span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰</span>
      <small ng-if="c.offline_queue_count > 0">
        ï¼ˆ{{c.offline_queue_count}}ä»¶ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¾…æ©Ÿä¸­ï¼‰
      </small>
    </div>
    
    <div class="network-syncing" ng-if="c.network_status === 'syncing'">
      <i class="fa fa-refresh fa-spin"></i>
      <span>åŒæœŸä¸­... {{c.sync_progress}}</span>
    </div>
  </div>
  <div class="guest-banner" ng-if="c.is_guest">
    <div class="guest-banner-content">
      <i class="fa fa-user-secret"></i>
      <span>ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§åˆ©ç”¨ä¸­</span>
      <button class="btn-guest-login" ng-click="c.goToLogin()">
        ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å…¨æ©Ÿèƒ½ã‚’è§£æ”¾
      </button>
    </div>
  </div>

  <div class="login-prompt-overlay" ng-if="c.show_login_prompt" role="alertdialog" aria-modal="true" aria-label="ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™">
    <div class="login-prompt-card">
      <div class="prompt-icon">
        <i class="fa fa-lock fa-3x"></i>
      </div>
      <h3>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h3>
      <p ng-if="c.login_prompt_feature === 'guardian'">
        ã€Œå®ˆè­·ã®è¼ªã€æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚<br>
        ã‚²ã‚¹ãƒˆã¨ã—ã¦æå‡ºã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è‡ªå‹•çš„ã«ç§»è¡Œã•ã‚Œã¾ã™ã€‚
      </p>
      <div class="prompt-actions">
        <button class="btn-login-primary" ng-click="c.goToLogin()">
          <i class="fa fa-sign-in"></i> ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²
        </button>
        <button class="btn-login-skip" ng-click="c.dismissLoginPrompt()">
          å¾Œã§
        </button>
      </div>
    </div>
  </div>
  
  <div class="kokoro-menu-btn" ng-click="c.toggleMenu()" ng-class="{'active': c.showMenu}"
     role="button"
     tabindex="0"
     aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã"
     aria-expanded="{{c.showMenu}}"
     ng-keydown="($event.keyCode === 13 || $event.keyCode === 32) && c.toggleMenu()">
    <i class="fa fa-bars" ng-if="!c.showMenu"></i>
    <i class="fa fa-times" ng-if="c.showMenu"></i>
  </div>

  <div class="kokoro-menu-dropdown" ng-if="c.showMenu">
    
    <div class="menu-item" ng-click="c.toggleHistory()"
     role="menuitem" tabindex="0"
     aria-label="ç”³è«‹å±¥æ­´ã‚’è¡¨ç¤º"
     ng-keydown="($event.keyCode === 13 || $event.keyCode === 32) && c.toggleHistory()">
      <div class="icon-box"><i class="fa fa-history"></i></div>
      <div class="text-box">
        <span class="menu-title">ç”³è«‹å±¥æ­´</span>
        <span class="menu-sub">History</span>
      </div>
      <span class="badge-pill" ng-if="c.data.my_requests.length > 0">{{c.data.my_requests.length}}</span>
    </div>

    <div class="menu-item" ng-click="c.toggleGuardianCircle()" 
     ng-class="{'locked-item': c.is_guest}"
     role="menuitem" tabindex="0"
     aria-label="å®ˆè­·ã®è¼ª - å‹é”ã®å®‰å¦ç¢ºèª"
     ng-keydown="($event.keyCode === 13 || $event.keyCode === 32) && c.toggleGuardianCircle()">
      <div class="icon-box">
        <i class="fa fa-users" ng-if="!c.is_guest"></i>
        <i class="fa fa-lock" ng-if="c.is_guest" style="color:#999;"></i>
      </div>
      <div class="text-box">
        <span class="menu-title">å®ˆè­·ã®è¼ª</span>
        <span class="menu-sub" ng-if="!c.is_guest">Guardian Circle</span>
        <span class="menu-sub" ng-if="c.is_guest" style="color:#999;">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦</span>
      </div>
      <span class="badge-pill badge-alert" ng-if="c.data.friend_notifications > 0 && !c.is_guest">
        {{c.data.friend_notifications}}
      </span>
    </div>

    <div class="menu-item" ng-click="c.toggleSettings()"
     role="menuitem" tabindex="0"
     aria-label="å®‰å…¨è¨­å®šã‚’é–‹ã"
     ng-keydown="($event.keyCode === 13 || $event.keyCode === 32) && c.toggleSettings()">
      <div class="icon-box"><i class="fa fa-cog"></i></div>
      <div class="text-box">
        <span class="menu-title">å®‰å…¨è¨­å®š</span>
        <span class="menu-sub">Settings</span>
      </div>
    </div>

    <div class="menu-item highlight" ng-if="c.data.is_volunteer" ng-click="c.goToVolunteerView()"
     role="menuitem" tabindex="0"
     aria-label="ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿"
     ng-keydown="($event.keyCode === 13 || $event.keyCode === 32) && c.goToVolunteerView()">
      <div class="icon-box"><i class="fa fa-user-md"></i></div>
      <div class="text-box">
        <span class="menu-title">ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</span>
        <span class="menu-sub">Volunteer</span>
      </div>
    </div>
    
  </div>
  
  <div class="menu-backdrop" ng-if="c.showMenu" ng-click="c.toggleMenu()"></div>

  <div class="settings-overlay" ng-if="c.showSettings" role="dialog" aria-modal="true" aria-label="å®‰å…¨è¨­å®š">
    <div class="settings-card">
      <div class="card-header">
        <h3><i class="fa fa-cog"></i> å®‰å…¨è¨­å®š</h3>
        <button class="close-btn" ng-click="c.toggleSettings()">&times;</button>
      </div>
      
      <div class="settings-desc">
        ã“ã“ã¯ã‚ãªãŸã®ã€Œå‘½ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€ã§ã™ã€‚<br>
        ä¸‡ä¸€ã®éš›ï¼ˆ24æ™‚é–“å¿œç­”ãªã—ï¼‰ã€ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«ä½¿ç”¨ã™ã‚‹æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
      </div>

      <div class="input-group">
        <label><i class="fa fa-envelope" style="color:#e91e63;"></i> ç·Šæ€¥é€£çµ¡å…ˆ (Email)</label>
        <input type="email" class="glass-input" ng-model="c.temp_settings.email" placeholder="ä¾‹ï¼špartner@example.com">
      </div>

      <div class="input-group">
        <label><i class="fa fa-tint" style="color:#e53935;"></i> è¡€æ¶²å‹ (Blood Type)</label>
        <select class="glass-input" ng-model="c.temp_settings.blood_type">
          <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
          <option value="A+">Aå‹ (+)</option>
          <option value="A-">Aå‹ (-)</option>
          <option value="B+">Bå‹ (+)</option>
          <option value="B-">Bå‹ (-)</option>
          <option value="O+">Oå‹ (+)</option>
          <option value="O-">Oå‹ (-)</option>
          <option value="AB+">ABå‹ (+)</option>
          <option value="AB-">ABå‹ (-)</option>
        </select>
      </div>

      <div class="input-group">
        <label><i class="fa fa-medkit" style="color:#43a047;"></i> æŒç—…ãƒ»åŒ»ç™‚æƒ…å ± (Medical Info)</label>
        <textarea class="glass-input" ng-model="c.temp_settings.medical_info" placeholder="ä¾‹ï¼šç³–å°¿ç—…ã€é«˜è¡€åœ§ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãªã©..." rows="3"></textarea>
      </div>
      
      <div class="input-group">
        <label><i class="fa fa-pencil" style="color:#5c6bc0;"></i> ãã®ä»–ã®ä¼è¨€ (Digital Will)</label>
        <textarea class="glass-input" ng-model="c.temp_settings.will" placeholder="ãã®ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆé¿é›£å ´æ‰€ã®å¸Œæœ›ãªã©ï¼‰..." rows="3"></textarea>
      </div>

      <button class="save-settings-btn" ng-click="c.saveSettings()">
        <span ng-if="!c.saving">è¨­å®šã‚’ä¿å­˜ (Save)</span>
        <span ng-if="c.saving"><i class="fa fa-spinner fa-spin"></i> Saving...</span>
      </button>
    </div>
  </div>

  <div class="guardian-overlay" ng-if="c.show_guardian" role="dialog" aria-modal="true" aria-label="å®ˆè­·ã®è¼ª">
    <div class="guardian-card">
      
      <div class="card-header gradient-header">
        <h3>
          <i class="fa fa-shield"></i> 
          å®ˆè­·ã®è¼ª
        </h3>
        <button class="close-btn" ng-click="c.toggleGuardianCircle()">&times;</button>
      </div>

      <div class="tab-bar">
        <div class="tab-item" 
             ng-class="{'active': c.guardian_tab === 'friends'}"
             ng-click="c.guardian_tab = 'friends'">
            <i class="fa fa-users"></i>
            <span>å‹é” ({{c.data.friends.length}})</span>
        </div>
        <div class="tab-item" 
             ng-class="{'active': c.guardian_tab === 'requests'}"
             ng-click="c.guardian_tab = 'requests'">
            <i class="fa fa-bell"></i>
            <span>ç”³è«‹ ({{c.data.friend_requests.length}})</span>
        </div>
        <div class="tab-item" 
             ng-class="{'active': c.guardian_tab === 'verify'}"
             ng-click="c.guardian_tab = 'verify'">
            <i class="fa fa-qrcode"></i>
            <span>å¯¾é¢èªè¨¼</span>
        </div>
        <div class="tab-item" 
             ng-class="{'active': c.guardian_tab === 'search'}"
             ng-click="c.guardian_tab = 'search'">
            <i class="fa fa-search"></i>
            <span>æ¤œç´¢</span>
        </div>
      </div>
      
      <div class="tab-content" ng-if="c.guardian_tab === 'verify'">
        <div class="verify-section">
            <div class="verify-instruction">
                <i class="fa fa-info-circle"></i>
                <p>è¿‘ãã«ã„ã‚‹äººã¨ç›´æ¥å‹é”ã«ãªã‚Œã¾ã™ã€‚<br>
                ä¸€æ–¹ãŒã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€ã‚‚ã†ä¸€æ–¹ãŒå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            
            <div class="verify-generate">
                <h4>è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</h4>
                <div class="code-display" ng-if="c.my_friend_code">
                    <span class="big-code">{{c.my_friend_code}}</span>
                    <small>15åˆ†é–“æœ‰åŠ¹</small>
                </div>
                <button class="btn-generate-code" ng-click="c.generateFriendCode()">
                    <i class="fa fa-refresh"></i>
                    <span ng-if="!c.my_friend_code">ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</span>
                    <span ng-if="c.my_friend_code">æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</span>
                </button>
            </div>
            
            <div class="verify-divider">
                <span>ã¾ãŸã¯</span>
            </div>
            
            <div class="verify-input">
                <h4>ç›¸æ‰‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</h4>
                <input type="text" 
                       class="code-input" 
                       ng-model="c.friend_code_input"
                       placeholder="6æ¡ã®ã‚³ãƒ¼ãƒ‰"
                       maxlength="6"
                       pattern="[0-9]*">
                <button class="btn-verify-code" 
                        ng-click="c.verifyFriendCode()"
                        ng-disabled="!c.friend_code_input || c.friend_code_input.length !== 6">
                    <i class="fa fa-check-circle"></i>
                    èªè¨¼ã™ã‚‹
                </button>
            </div>
        </div>
      </div>

      <div class="tab-content" ng-if="c.guardian_tab === 'friends'">
        
        <div ng-if="!c.data.friends || c.data.friends.length === 0" 
             class="empty-state">
          <i class="fa fa-user-plus fa-3x"></i>
          <p>ã¾ã å‹é”ãŒã„ã¾ã›ã‚“</p>
          <button class="btn-primary-small" ng-click="c.guardian_tab = 'search'">
            å‹é”ã‚’è¿½åŠ 
          </button>
        </div>

        <div class="friend-list">
          <div class="friend-card" 
               ng-repeat="friend in c.data.friends"
               ng-click="c.showFriendDetail(friend)">
            
            <div class="friend-avatar-wrapper">
              <div class="friend-avatar">
                <i class="fa fa-user"></i>
              </div>
              <div class="status-dot" ng-class="friend.heartbeat_status">
                <span class="pulse-ring"></span>
              </div>
            </div>

            <div class="friend-info">
              <div class="friend-name">
                {{friend.display_name}}
                <span class="friend-badge" ng-if="friend.is_family">å®¶æ—</span>
              </div>
              <div class="friend-status-text">
                <i class="fa fa-clock-o"></i>
                {{friend.last_heartbeat_time}}
              </div>
              <div class="friend-location" ng-if="friend.current_zone">
                <i class="fa fa-map-marker"></i>
                {{friend.current_zone}}
              </div>
            </div>

            <div class="friend-actions">
              <button class="icon-btn emergency-btn" 
                      ng-click="c.emergencyCall(friend, $event)"
                      ng-if="friend.heartbeat_status === 'critical'">
                <i class="fa fa-exclamation-triangle"></i>
              </button>
              
              <button class="icon-btn message-btn" 
                      ng-click="c.sendMessage(friend, $event)">
                <i class="fa fa-comment"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" ng-if="c.guardian_tab === 'requests'">
        
        <div ng-if="!c.data.friend_requests || c.data.friend_requests.length === 0" 
             class="empty-state">
          <i class="fa fa-inbox fa-3x"></i>
          <p>æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
        </div>

        <div class="request-list">
          <div class="request-card" ng-repeat="req in c.data.friend_requests">
            
            <div class="request-avatar">
              <i class="fa fa-user"></i>
            </div>

            <div class="request-info">
              <div class="request-name">{{req.from_user_name}}</div>
              <div class="request-time">
                <i class="fa fa-clock-o"></i>
                {{req.time_ago}}
              </div>
              <div class="request-message" ng-if="req.message">
                "{{req.message}}"
              </div>
            </div>

            <div class="request-actions">
              <button class="btn-accept" ng-click="c.acceptFriendRequest(req)">
                <i class="fa fa-check"></i>
                æ‰¿èª
              </button>
              <button class="btn-reject" ng-click="c.rejectFriendRequest(req)">
                <i class="fa fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" ng-if="c.guardian_tab === 'search'">
        
        <div class="search-box">
          <i class="fa fa-search"></i>
          <input type="text" 
                 class="search-input" 
                 ng-model="c.search_query"
                 placeholder="åå‰ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢..."
                 ng-change="c.searchUsers()">
        </div>

        <div class="search-results" ng-if="c.search_results.length > 0">
          <div class="search-item" ng-repeat="user in c.search_results">
            
            <div class="search-avatar">
              <i class="fa fa-user"></i>
            </div>

            <div class="search-info">
              <div class="search-name">{{user.name}}</div>
              <div class="search-email">{{user.email}}</div>
            </div>

            <button class="btn-add-friend" 
                    ng-click="c.sendFriendRequest(user)"
                    ng-disabled="user.already_friend || user.request_sent">
              <i class="fa fa-user-plus"></i>
              <span ng-if="!user.already_friend && !user.request_sent">è¿½åŠ </span>
              <span ng-if="user.request_sent">é€ä¿¡æ¸ˆ</span>
              <span ng-if="user.already_friend">å‹é”</span>
            </button>
          </div>
        </div>

        <div class="recommended-section" ng-if="c.recommended_friends.length > 0">
          <h4 class="section-title">ãŠã™ã™ã‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</h4>
          <div class="search-item" ng-repeat="user in c.recommended_friends">
            <div class="search-avatar"><i class="fa fa-user"></i></div>
            <div class="search-info">
              <div class="search-name">{{user.name}}</div>
              <div class="search-hint">åŒã˜ã‚¨ãƒªã‚¢</div>
            </div>
            <button class="btn-add-friend" ng-click="c.sendFriendRequest(user)">
              <i class="fa fa-user-plus"></i>
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

 <div class="friend-detail-overlay" ng-if="c.selected_friend" role="dialog" aria-modal="true" aria-label="å‹é”è©³ç´°">
    <div class="friend-detail-card">
      
      <button class="back-btn" ng-click="c.selected_friend = null">
        <i class="fa fa-arrow-left"></i>
      </button>

      <div class="detail-header">
        <div class="detail-avatar-large">
          <i class="fa fa-user"></i>
          <div class="status-indicator" ng-class="c.selected_friend.heartbeat_status"></div>
        </div>
        <h3>{{c.selected_friend.display_name}}</h3>
        <p class="detail-status-text">{{c.selected_friend.status_message}}</p>
      </div>

      <div class="detail-stats">
        <div class="stat-item">
          <i class="fa fa-heartbeat"></i>
          <span>æœ€å¾Œã®å¿ƒæ‹</span>
          <strong>{{c.selected_friend.last_heartbeat_time}}</strong>
        </div>
        <div class="stat-item" ng-if="c.selected_friend.current_zone">
          <i class="fa fa-map-marker"></i>
          <span>ç¾åœ¨åœ°</span>
          <strong>{{c.selected_friend.current_zone}}</strong>
        </div>
      </div>

      <div class="detail-actions">
        <button class="btn-action-large emergency" 
                ng-if="c.selected_friend.heartbeat_status === 'critical'"
                ng-click="c.emergencyCall(c.selected_friend)">
          <i class="fa fa-exclamation-triangle"></i>
          ç·Šæ€¥å‘¼ã³å‡ºã—
        </button>
        <button class="btn-action-large primary" 
                ng-click="c.sendMessage(c.selected_friend)">
          <i class="fa fa-comment"></i>
          ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
        </button>
        <button class="btn-action-large" 
                ng-click="c.viewFriendHistory(c.selected_friend)">
          <i class="fa fa-history"></i>
          å¿ƒæ‹å±¥æ­´ã‚’è¦‹ã‚‹
        </button>
      </div>

      <div class="detail-settings">
        <div class="setting-item">
          <span>ä½ç½®æƒ…å ±å…±æœ‰</span>
          <label class="toggle-switch">
            <input type="checkbox" ng-model="c.selected_friend.share_location">
            <span class="slider"></span>
          </label>
        </div>
        <div class="setting-item">
          <span>ç·Šæ€¥æ™‚ã«é€šçŸ¥</span>
          <label class="toggle-switch">
            <input type="checkbox" ng-model="c.selected_friend.alert_enabled">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <button class="btn-danger-outline" ng-click="c.removeFriend(c.selected_friend)">
        <i class="fa fa-trash"></i>
        å‹é”ã‚’å‰Šé™¤
      </button>
    </div>
  </div>
  
  <div ng-if="c.step === 0 && !c.show_will_input">
    <div class="pulse-overlay">
      <h2 class="pulse-title">
        ä»Šæ—¥ã€ç„¡äº‹ã§ã™ã‹ï¼Ÿ
        <span class="sub-text"><br>(å¤§ä¸ˆå¤«ï¼Ÿã“ã“ã‚ã‚’ç¹‹ã„ã§ã€ç„¡äº‹ã‚’ç¢ºèªã€‚)</span>
      </h2>
    </div>

    <div class="slime-stage">
      <div id="the-slime" class="kokoro-slime" 
     ng-class="{'happy-slime': c.step >= 1, 'poked': c.is_poked}"
     ng-click="c.pokeSlime()"
     role="button"
     tabindex="0"
     aria-label="ç”Ÿå­˜ç¢ºèªãƒœã‚¿ãƒ³ - ã‚¿ãƒƒãƒã—ã¦ç„¡äº‹ã‚’å ±å‘Š"
     ng-keydown="($event.keyCode === 13 || $event.keyCode === 32) && c.pokeSlime()">
        <div class="slime-eyes" ng-style="{'transform': 'translate(' + eyeX + 'px, ' + eyeY + 'px)'}"></div>
      </div>
    </div>

    <!-- ä¸€é”®SOSæŒ‰é’® -->
    <div class="sos-container">
      <button class="sos-btn" 
        ng-click="c.triggerSOS()"
        ng-disabled="c.sos_sending"
        aria-label="ç·Šæ€¥SOS - ãƒ¯ãƒ³ã‚¿ãƒƒãƒã§æ•‘åŠ©è¦è«‹"
        role="button"
        aria-live="assertive"
        aria-busy="{{c.sos_sending}}">
        <svg class="sos-icon" viewBox="0 0 24 24" ng-if="!c.sos_sending" style="width: 1.4rem; height: 1.4rem; fill: none; stroke: currentColor; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round;">
  <circle cx="12" cy="12" r="10"></circle>
  <line x1="12" y1="8" x2="12" y2="12"></line>
  <line x1="12" y1="16" x2="12.01" y2="16"></line>
</svg>
        <span ng-if="c.sos_sending"><i class="fa fa-spinner fa-spin"></i></span>
        <span class="sos-text" ng-if="!c.sos_sending">ç·Šæ€¥SOS</span>
        <span class="sos-text" ng-if="c.sos_sending">é€ä¿¡ä¸­...</span>
      </button>
      <p class="sos-hint">â€» ç¾åœ¨åœ°ã¨åŸºæœ¬æƒ…å ±ã‚’è‡ªå‹•é€ä¿¡ã—ã¾ã™</p>
    </div>
  </div>
  
  <div class="history-overlay" ng-if="c.show_history" role="dialog" aria-modal="true" aria-label="ç”³è«‹å±¥æ­´">
  <div class="history-card">
    <div class="card-header">
      <h3><i class="fa fa-list-alt" style="color: #ec407a;"></i> ç”³è«‹å±¥æ­´</h3>
      <button class="close-btn" ng-click="c.toggleHistory()">&times;</button>
    </div>
    
    <div class="history-list" style="overflow-y: auto; max-height: 60vh; padding-bottom: 20px;">
      
      <div ng-if="c.data.my_requests === undefined" style="text-align:center; padding: 40px; color:#666;">
         <i class="fa fa-spinner fa-spin fa-2x"></i><br>èª­ã¿è¾¼ã¿ä¸­...
      </div>

      <div ng-if="c.data.my_requests && c.data.my_requests.length === 0" 
           style="text-align:center; padding: 40px; color:#aaa; display: flex; flex-direction: column; align-items: center;">
        <i class="fa fa-folder-open-o" style="font-size: 40px; margin-bottom:15px; opacity: 0.5;"></i>
        <span>ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>
        <small style="margin-top:5px; font-size:11px;">(Guest Token: {{c.guest_token ? 'ã‚ã‚Š' : 'ãªã—'}})</small>
      </div>

      <div class="history-item" 
           ng-if="c.data.my_requests && c.data.my_requests.length > 0"
           ng-repeat="item in c.data.my_requests track by item.sys_id" 
           ng-click="c.loadTicket(item)">
        
        <div class="item-icon">
          {{c.statusDetails[item.state] ? c.statusDetails[item.state].icon : ']]>ğŸ“<![CDATA['}}
        </div>
        
        <div class="item-info">
          <span class="item-cat">
            {{ c.dict[item.category] || item.category_display || 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆ' }}
          </span>
          <span class="item-date"><i class="fa fa-clock-o"></i> {{item.time_ago}}</span>
        </div>
        
        <div class="item-status" ng-class="'status-' + item.state">
          {{item.state_label || 'é€ä¿¡æ¸ˆã¿'}}
        </div>
      </div>
      
    </div>
  </div>
</div>
  

  
  <div class="will-overlay" ng-if="c.show_will_input">
    <div class="will-card">
        <h3 class="will-title"><i class="fa fa-heartbeat"></i> ç”Ÿå­˜ç¢ºèªå®Œäº†</h3>
        <p class="will-desc">KokoroãŒã‚ãªãŸã®è„ˆå‹•ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚<br>ä¸‡ä¸€ã«å‚™ãˆã€æ•‘åŠ©éšŠã¸ã®ä¼è¨€ã‚’æ®‹ã—ã¾ã™ã‹ï¼Ÿ</p>
        
        <div class="guest-heartbeat-hint" ng-if="c.is_guest">
            <i class="fa fa-info-circle"></i>
            <span>ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€å‹é”ãŒã‚ãªãŸã®ç„¡äº‹ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</span>
        </div>
      <textarea class="will-textarea" ng-model="c.digital_will" placeholder="ä¾‹ï¼šä½“è‚²é¤¨ã®2éšå€‰åº«ã«ã„ã¾ã™ã€‚ç³–å°¿ç—…ã®è–¬ãŒå¿…è¦ã§ã™..."
          aria-label="æ•‘åŠ©éšŠã¸ã®ä¼è¨€ã‚’å…¥åŠ›"></textarea>
      <div class="will-actions">
        <button class="btn-will-skip" ng-click="c.finishHeartbeat(false)">ä»Šã¯ã—ãªã„</button>
        <button class="btn-will-save" ng-click="c.finishHeartbeat(true)">ä¿å­˜ã—ã¦é€²ã‚€</button>
      </div>
    </div>
  </div>

  <div class="form-stage" ng-if="c.step > 0">
    <div class="floating-header" ng-if="c.step < 5">
      <h2 class="form-title"><i class="fa fa-heartbeat"></i> æ”¯æ´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h2>
      <div class="progress-indicator" role="progressbar" 
     aria-label="å…¥åŠ›é€²æ—" 
     aria-valuenow="{{c.step}}" 
     aria-valuemin="1" 
     aria-valuemax="4">
        <span class="progress-step" ng-class="{'active': c.step >= 1}">1</span>
        <span class="progress-line" ng-class="{'active': c.step >= 2}"></span>
        <span class="progress-step" ng-class="{'active': c.step >= 2}">2</span>
        <span class="progress-line" ng-class="{'active': c.step >= 3}"></span>
        <span class="progress-step" ng-class="{'active': c.step >= 3}">3</span>
        <span class="progress-line" ng-class="{'active': c.step >= 4}"></span>
        <span class="progress-step" ng-class="{'active': c.step >= 4}">4</span>
      </div>
    </div>
    
    <div class="form-wrapper" ng-if="c.step < 5">
      <div class="step-card" ng-if="c.step >= 1">
        <label class="big-label">1. ã„ã‚‰ã£ã—ã‚ƒã‚‹ã‚¨ãƒªã‚¢</label>
        <div class="input-wrapper">
          <select class="big-input" ng-model="c.data.location" ng-change="c.onLocationChange()"
        aria-label="é¿é›£ã‚¨ãƒªã‚¢ã‚’é¸æŠ"
        aria-required="true">
            <option value="" disabled selected>ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ...</option>
            <option value="Family Area">]]>ğŸ§¸<![CDATA[ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚¨ãƒªã‚¢ (å®¶æ—)</option>
            <option value="Single Area">]]>ğŸ”‘<![CDATA[å˜èº«ã‚¨ãƒªã‚¢ (ä¸€äºº)</option>
            <option value="Medical Area">]]>ğŸ©º<![CDATA[åŒ»ç™‚ãƒ»ã‚±ã‚¢ã‚¨ãƒªã‚¢</option>
          </select>
          <i class="fa fa-chevron-down select-arrow"></i>
        </div>
      </div>

      <div class="step-card" ng-if="c.step >= 2">
        <label class="big-label">2. è©³ç´°ãªå ´æ‰€ (éƒ¨å±‹ç•ªå·ãªã©)</label>
        <input type="text" class="big-input" ng-model="c.data.detail_loc" placeholder="ä¾‹ï¼š101å·å®¤ã€ä½“è‚²é¤¨ã®å³å´..." ng-change="c.checkDetail()"
       aria-label="è©³ç´°ãªå ´æ‰€ã‚’å…¥åŠ›"
       aria-required="true">
      </div>

      <div class="step-card" ng-if="c.step >= 3">
        <label class="big-label">3. å¿…è¦ãªæ”¯æ´</label>
        <div class="input-wrapper mb-3">
          <select class="big-input" ng-model="c.data.category" ng-change="c.checkInput()"
        aria-label="å¿…è¦ãªæ”¯æ´ã®ç¨®é¡ã‚’é¸æŠ"
        aria-required="true">
            <option value="" disabled selected>ä½•ãŒå¿…è¦ã§ã™ã‹ï¼Ÿ</option>
            <option value="Water">]]>ğŸ’§<![CDATA[é£²æ–™æ°´ (Water)</option>
            <option value="Food">]]>ğŸ±<![CDATA[é£Ÿæ–™ (Food)</option>
            <option value="Medical">]]>ğŸ’Š<![CDATA[åŒ»ç™‚ãƒ»è–¬ (Medical)</option>
            <option value="Baby">]]>ğŸ‘¶<![CDATA[ä¹³å¹¼å…ç”¨å“ (Baby)</option>
            <option value="Power">]]>ğŸ”‹<![CDATA[é›»æºãƒ»å……é›» (Power)</option>
            <option value="Other">]]>ğŸ“¦<![CDATA[ãã®ä»– (Other)</option>
          </select>
          <i class="fa fa-chevron-down select-arrow"></i>
        </div>

        <div class="flex-row">
          <div class="half-col">
            <input type="number" class="big-input" ng-model="c.data.quantity" placeholder="æ•°é‡" ng-change="c.checkInput()" style="text-align:center;"
       aria-label="å¿…è¦æ•°é‡"
       aria-required="true"
       min="1">
          </div>
          <div class="half-col input-wrapper">
            <select class="big-input" ng-model="c.data.affected_count" ng-change="c.checkInput()" style="text-align:center;"
        aria-label="å¯¾è±¡äººæ•°ã‚’é¸æŠ">
              <option value="" disabled selected>äººæ•°</option>
              <option value="1">1äºº</option>
              <option value="2-4">2-4äºº</option>
              <option value="5+">5äºº+</option>
            </select>
          </div>
        </div>

        <div class="input-wrapper mb-3" style="margin-top: 15px;">
           <input type="text" class="big-input" ng-model="c.data.contact" placeholder="é€£çµ¡å…ˆ (é›»è©±ç•ªå·/Email)..." ng-change="c.checkInput()"
       aria-label="é€£çµ¡å…ˆã‚’å…¥åŠ›">
        </div>

        <div class="input-wrapper mb-3">
          <select class="big-input" ng-model="c.data.urgency" ng-change="c.checkInput()" ng-class="{'critical-bg': c.data.urgency === 'Critical'}"
        aria-label="ç·Šæ€¥åº¦ã‚’é¸æŠ"
        aria-required="true">
            <option value="" disabled selected>ç·Šæ€¥åº¦ã¯ï¼Ÿ</option>
            <option value="Low">]]>ğŸ¢<![CDATA[æ€¥ãã¾ã›ã‚“</option>
            <option value="Medium">]]>ğŸš¶<![CDATA[æ™®é€š (ãªã‚‹ã¹ãæ—©ã)</option>
            <option value="High">]]>ğŸƒ<![CDATA[å›°ã£ã¦ã„ã¾ã™ (æ—©æ€¥ã«)</option>
            <option value="Critical">]]>ğŸ†˜<![CDATA[é™ç•Œã§ã™/ä»Šã™ã</option>
          </select>
          <i class="fa fa-chevron-down select-arrow"></i>
        </div>
        <textarea class="glass-textarea" ng-model="c.data.remarks" placeholder="å‚™è€ƒ (ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãªã©)..."
          aria-label="å‚™è€ƒã‚„ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±ã‚’å…¥åŠ›"></textarea>
      </div>
      
      <div ng-if="c.fileData" style="text-align: center; margin-bottom: 26px;">
        <div style="position: relative; display: inline-block;">
          <img ng-src="{{c.fileData}}" style="height: 170px; border-radius: 18px; border: 4px solid #fff; box-shadow: 0 10px 28px rgba(0,0,0,0.15);" />
          <div ng-click="c.clearFile()" style="position: absolute; top: -14px; right: -14px; background: #ff5252; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; border: 3px solid #fff;">
            <i class="fa fa-times" style="font-size:18px;"></i>
          </div>
        </div>
        <div style="color: #43a047; font-weight: 800; font-size: 0.95rem; margin-top: 12px;">å†™çœŸãŒæ·»ä»˜ã•ã‚Œã¾ã—ãŸ</div>
      </div>
      <div class="action-row" ng-if="c.step >= 4">
        <label class="big-attach-btn">
          <input type="file" style="display: none;" onchange="angular.element(this).scope().c.uploadFiles(this.files)"/>
          <i class="fa fa-camera"></i>
        </label>
        <button class="big-submit-btn" ng-click="c.submitWish()"
        aria-label="æ”¯æ´ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡"
        aria-busy="{{c.submitting}}">
          <span ng-if="!c.is_editing && !c.submitting">é¡˜ã„ã‚’é€ã‚‹</span>
          <span ng-if="c.is_editing && !c.submitting">å†…å®¹ã‚’æ›´æ–°</span>
          <span ng-if="c.submitting"><i class="fa fa-spinner fa-spin"></i> é€ä¿¡ä¸­...</span>
        </button>
      </div>
    </div>

    <div class="success-card" ng-if="c.step === 5">
      <div class="status-tracker">
        <div class="status-step" ng-class="{'active': c.visual_step >= 0}">
            <div class="icon">]]>ğŸ“¨<![CDATA[</div><div class="text">æå‡º</div>
        </div>
        
        <div class="line" ng-class="{'active': c.visual_step >= 1}"></div>
        
        <div class="status-step" ng-class="{'active': c.visual_step >= 1}">
            <div class="icon">]]>ğŸ‘€<![CDATA[</div><div class="text">ç¢ºèª</div>
        </div>
        
        <div class="line" ng-class="{'active': c.visual_step >= 2}"></div>
        
        <div class="status-step" ng-class="{'active': c.visual_step >= 2}">
            <div class="icon">]]>ğŸ™‹<![CDATA[</div><div class="text">æ‹…å½“</div>
        </div>
        
        <div class="line" ng-class="{'active': c.visual_step >= 3}"></div>
        
        <div class="status-step" ng-class="{'active': c.visual_step >= 3}">
            <div class="icon">]]>ğŸƒ<![CDATA[</div><div class="text">é…é€</div>
        </div>
        
        <div class="line" ng-class="{'active': c.visual_step >= 4}"></div>
        
        <div class="status-step" ng-class="{'active': c.visual_step >= 4}">
            <div class="icon">âœ…</div><div class="text">å®Œäº†</div>
        </div>
        </div>

      
      <h2 class="success-title">æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸ</h2>
      <p class="ticket-id">ID: {{c.ticket_number}}</p>
      
      <div class="summary-card">
        <div class="row-item"><strong>å ´æ‰€:</strong> {{c.dict[c.data.location]}} - {{c.data.detail_loc}}</div>
        <div class="row-item"><strong>å†…å®¹:</strong> {{c.dict[c.data.category]}} <span class="badge">x{{c.data.quantity}}</span></div>
        <div class="row-item" ng-if="c.data.contact"><strong>é€£çµ¡å…ˆ:</strong> {{c.data.contact}}</div>
        <div class="row-item"><strong>ç·Šæ€¥åº¦:</strong> <span ng-class="{'text-crit': c.data.urgency==='Critical'}">{{c.dict[c.data.urgency]}}</span></div>
        <div class="row-item" ng-if="c.data.remarks"><small style="color:#888;">{{c.data.remarks}}</small></div>
      </div>

      <div class="live-status-pill"><span class="pulse-dot"></span> {{c.status_message}}</div>

      <div class="status-detail-card" ng-if="c.statusDetails[c.current_state_val]">
        <div class="status-header">
          <span class="status-icon">{{c.statusDetails[c.current_state_val].icon}}</span>
          <h3 class="status-title">{{c.statusDetails[c.current_state_val].title}}</h3>
        </div>
        <p class="status-desc">{{c.statusDetails[c.current_state_val].desc}}</p>
        <p class="status-next">æ¬¡: {{c.statusDetails[c.current_state_val].nextStep}}</p>
      </div>

      <div class="btn-group">
        <button class="edit-btn" ng-click="c.editMode()" ng-if="c.current_state_val === 1 || c.current_state_val === 10">ä¿®æ­£ã™ã‚‹</button>
        <button class="big-reset-btn" ng-click="c.reset()">æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
      </div>
    </div>
  </div>

  <div ng-if="c.submitting" class="loading-overlay">
    <div class="loading-content">
      <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
      <p>é€ä¿¡ä¸­...</p>
      <small>ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã—ã¦è»¢é€ã—ã¦ã„ã¾ã™</small>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
