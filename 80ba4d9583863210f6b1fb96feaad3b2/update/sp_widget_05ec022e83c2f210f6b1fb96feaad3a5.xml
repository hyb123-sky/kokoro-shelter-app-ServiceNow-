<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $uibModal, spUtil, $timeout, $window, $interval) {
    var c = this;

    // ============================================================
    // KOKORO SHELTER - Client Script (White Industrial Style)
    // ============================================================

    // ==========================================
    // 1. Âä®ÊÄÅÊ≥®ÂÖ•ModalÂÖ®Â±ÄCSS (ÁôΩËâ≤Â∑•‰∏öÈ£éÊ†º)
    // ==========================================
    function injectGlobalModalStyles() {
        if (document.getElementById('kokoro-modal-global-css')) return;
        
        var css = document.createElement('style');
        css.id = 'kokoro-modal-global-css';
        css.type = 'text/css';
        css.innerHTML = '.kokoro-modal-window .modal-dialog{max-width:1100px;margin:30px auto}.kokoro-modal-window .modal-content{background:#fff;border:1px solid #1a1a1a;border-radius:0;box-shadow:0 25px 50px rgba(0,0,0,.15);overflow:hidden}.kokoro-modal-header{background:#fafafa;border-bottom:1px solid #e0e0e0;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}.modal-header-left{display:flex;align-items:center;gap:16px}.modal-ticket-type{font-family:"JetBrains Mono",monospace;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;background:#1a1a1a;color:#fff;padding:6px 12px}.modal-ticket-id{font-family:"Orbitron",monospace;font-size:13px;color:#666;font-weight:700;letter-spacing:1px}.modal-close-btn{background:0 0;border:1px solid #e0e0e0;color:#999;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s ease}.modal-close-btn:hover{background:#1a1a1a;border-color:#1a1a1a;color:#fff}.kokoro-modal-body{padding:0!important;max-height:calc(90vh - 80px)!important;overflow-y:auto!important;background:#fff}.jira-layout-container{display:flex;min-height:500px}.jira-main-column{flex:1;padding:28px 32px;background:#fff;border-right:1px solid #e0e0e0;overflow-y:auto}.jira-sidebar-column{width:360px;min-width:360px;background:#fafafa;padding:28px 24px;overflow-y:auto}.issue-title{font-family:Rajdhani,sans-serif;font-size:24px;font-weight:700;color:#1a1a1a;margin:0 0 24px;line-height:1.3;display:flex;align-items:center;gap:14px;flex-wrap:wrap}.qty-badge-lg{background:#1a1a1a;color:#fff;font-family:Orbitron,monospace;font-size:14px;padding:6px 14px;font-weight:700}.action-buttons-row{display:flex;gap:14px;margin-bottom:28px;flex-wrap:wrap}.jira-dropdown{position:relative;display:inline-block}.jira-dropdown-toggle{display:flex;align-items:center;gap:10px;padding:10px 16px;border:1px solid #e0e0e0;background:#fff;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s ease;text-transform:uppercase;letter-spacing:.5px;font-family:"JetBrains Mono",monospace}.jira-dropdown-toggle:hover{border-color:#1a1a1a;background:#fafafa}.jira-dropdown-toggle i.fa-chevron-down{font-size:10px;opacity:.6}.status-btn{color:#1a1a1a}.status-bg-1,.status-bg-10{background:rgba(0,212,255,.1);color:#0094cc;border-color:#00d4ff}.status-bg-11{background:rgba(175,82,222,.1);color:#9333ea;border-color:#af52de}.status-bg-2{background:rgba(255,149,0,.1);color:#cc7700;border-color:#ff9500}.status-bg-4{background:rgba(52,199,89,.1);color:#28a745;border-color:#34c759}.status-bg-5{background:rgba(255,59,48,.1);color:#dc3545;border-color:#ff3b30}.assignee-btn{color:#666}.assignee-btn:disabled{opacity:.5;cursor:not-allowed}.jira-dropdown-menu{position:absolute;top:100%;left:0;z-index:1000;min-width:240px;background:#fff;border:1px solid #1a1a1a;box-shadow:0 12px 40px rgba(0,0,0,.15);margin-top:4px;padding:6px 0;max-height:320px;overflow-y:auto}.dropdown-item{padding:12px 18px;cursor:pointer;font-size:13px;color:#333;display:flex;align-items:center;gap:12px;transition:all .15s ease;border-left:3px solid transparent}.dropdown-item:hover{background:#f5f5f5;border-left-color:#1a1a1a}.dropdown-item.highlight{background:#f0fff4;color:#28a745;font-weight:700}.dropdown-item.highlight:hover{background:#dcfce7}.dropdown-item.text-danger{color:#dc3545}.dropdown-item.text-muted{color:#999;font-size:12px}.dropdown-divider{height:1px;background:#e0e0e0;margin:6px 0}.assignee-avatar{width:26px;height:26px;border-radius:4px;background:#1a1a1a;color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700}.section-block{margin-bottom:32px}.section-title{font-size:11px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:2px;margin:0 0 14px;display:flex;align-items:center;gap:10px;padding-bottom:10px;border-bottom:1px solid #e0e0e0}.section-title i{color:#1a1a1a}.description-content{background:#fafafa;border:1px solid #e0e0e0;padding:18px}.desc-row{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid #eee;font-size:14px;color:#333}.desc-row:last-child{border-bottom:none}.desc-row i{width:18px;text-align:center;margin-top:3px}.desc-row strong{min-width:90px;color:#666;font-weight:600}.text-danger{color:#dc3545!important}.text-primary{color:#0094cc!important}.text-info{color:#17a2b8!important}.text-warning{color:#cc7700!important}.text-success{color:#28a745!important}.attachment-preview{margin-top:18px;text-align:center}.attachment-preview img{max-width:100%;max-height:280px;border:1px solid #e0e0e0}.comment-input-area{margin-bottom:20px}.comment-textarea{width:100%;padding:14px;background:#fff;border:1px solid #e0e0e0;color:#333;font-size:14px;font-family:inherit;resize:vertical;transition:border-color .2s ease;box-sizing:border-box}.comment-textarea:focus{outline:0;border-color:#1a1a1a}.comment-submit-btn{margin-top:10px;padding:10px 20px;background:#1a1a1a;color:#fff;border:none;font-weight:700;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:.5px;transition:all .2s ease}.comment-submit-btn:hover{background:#333}.comment-submit-btn:disabled{background:#ccc;cursor:not-allowed}.activity-list{margin-top:18px}.activity-item{display:flex;gap:14px;padding:14px 0;border-top:1px solid #eee}.activity-avatar{width:34px;height:34px;border-radius:4px;background:#666;color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}.activity-content{flex:1;min-width:0}.activity-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}.activity-user{font-weight:700;font-size:13px;color:#1a1a1a}.activity-date{font-size:11px;color:#999;font-family:Orbitron,monospace}.activity-text{font-size:14px;color:#333;line-height:1.5;word-break:break-word}.no-activity{text-align:center;padding:28px;color:#999;font-size:13px;background:#fafafa;border:1px dashed #e0e0e0}.no-activity i{font-size:28px;display:block;margin-bottom:10px;color:#ccc}.sidebar-group{margin-bottom:22px;padding-bottom:18px;border-bottom:1px solid #e0e0e0}.sidebar-group:last-child{border-bottom:none}.sb-label{font-size:10px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;display:block}.sb-value{font-size:14px;color:#1a1a1a;font-weight:600;display:flex;align-items:center;gap:10px}.sb-sub{font-size:12px;color:#999;margin-top:6px}.assignee-display{display:flex;align-items:center;gap:12px}.user-avatar{width:32px;height:32px;border-radius:4px;background:#1a1a1a;color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700}.user-avatar.empty{background:#e0e0e0;color:#999}.user-avatar.reporter{background:#ff9500}.status-lozenge{display:inline-block;padding:6px 14px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;border:1px solid}.lozenge-1,.lozenge-10{background:rgba(0,212,255,.1);color:#0094cc;border-color:#00d4ff}.lozenge-11{background:rgba(175,82,222,.1);color:#9333ea;border-color:#af52de}.lozenge-2{background:rgba(255,149,0,.1);color:#cc7700;border-color:#ff9500}.lozenge-4{background:rgba(52,199,89,.1);color:#28a745;border-color:#34c759}.lozenge-5{background:rgba(255,59,48,.1);color:#dc3545;border-color:#ff3b30}.priority-lozenge{display:inline-flex;align-items:center;gap:8px;padding:6px 14px;font-size:12px;font-weight:700;border:1px solid}.priority-lozenge.priority-Critical{background:rgba(255,59,48,.1);color:#dc3545;border-color:#ff3b30}.priority-lozenge.priority-High{background:rgba(255,149,0,.1);color:#cc7700;border-color:#ff9500}.priority-lozenge.priority-Medium{background:rgba(0,212,255,.1);color:#0094cc;border-color:#00d4ff}.priority-lozenge.priority-Low{background:rgba(52,199,89,.1);color:#28a745;border-color:#34c759}.location-value{display:flex;align-items:center;gap:8px}.location-value i{color:#dc3545}.date-value{display:flex;align-items:center;gap:8px;font-family:Orbitron,monospace;font-size:12px}.date-value i{color:#999}.ai-analysis-box{background:#fff;border:1px solid #e0e0e0;border-left:4px solid #1a1a1a;padding:16px}.ai-analysis-box .sb-label{color:#1a1a1a}.ai-content{font-size:13px;line-height:1.6;color:#333}.sla-section{background:#fff;border:1px solid #e0e0e0;padding:16px}.sla-bar-bg{width:100%;height:8px;background:#e0e0e0;overflow:hidden;margin:12px 0}.sla-bar-fill{height:100%;transition:width .8s ease}.sla-bar-fill.sla-ok{background:#34c759}.sla-bar-fill.sla-warning{background:#ff9500;animation:slaPulse 2s infinite}.sla-bar-fill.sla-critical{background:#ff3b30;animation:slaPulse 1s infinite}@keyframes slaPulse{0%,100%{opacity:1}50%{opacity:.7}}.sla-details{margin-top:14px;font-size:12px}.sla-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee}.sla-row:last-child{border-bottom:none}.sla-label{color:#999}.sla-value{color:#1a1a1a;font-weight:700;font-family:Orbitron,monospace}.sla-status-badge{margin-top:14px;padding:12px 16px;text-align:center;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:1px;border:1px solid}.sla-status-badge.badge-ok{background:rgba(52,199,89,.1);color:#28a745;border-color:#34c759}.sla-status-badge.badge-warning{background:rgba(255,149,0,.1);color:#cc7700;border-color:#ff9500}.sla-status-badge.badge-critical{background:rgba(255,59,48,.1);color:#dc3545;border-color:#ff3b30}@media (max-width:768px){.jira-layout-container{flex-direction:column}.jira-main-column{border-right:none;border-bottom:1px solid #e0e0e0;padding:20px}.jira-sidebar-column{width:100%;min-width:100%;padding:20px}.action-buttons-row{flex-direction:column}.jira-dropdown{width:100%}.jira-dropdown-toggle{width:100%;justify-content:space-between}.jira-dropdown-menu{width:100%}}';
        document.head.appendChild(css);
    }

    injectGlobalModalStyles();

    // ==========================================
    // 2. ÈÖçÁΩÆÂ∏∏Èáè
    // ==========================================
    var CONFIG = {
        states: { DRAFT: 1, SUBMITTED: 10, ASSIGNED: 11, IN_PROGRESS: 2, COMPLETED: 4, CANCELLED: 5, ON_HOLD: 6 },
        debounceDelay: 300,
        slaRefreshInterval: 60000
    };

    // ==========================================
    // 3. Áä∂ÊÄÅÂàùÂßãÂåñ
    // ==========================================
    c.mode = c.data.is_volunteer ? 'volunteer' : 'refugee';
    c.view = 'dashboard';
    c.step = 0;
    c.is_poked = false;
    c.show_will_input = false;
    c.digital_will = "";
    c.current_state_val = 0;
    c.is_editing = false;
    c.submitting = false;
    c.saving = false;
    c.status_message = "ÂæÖÊ©ü‰∏≠...";
    c.newComment = "";
    c.filteredList = null;
    c.currentFilter = null;
    c.showSettings = false;
    c.current_heartbeat_id = null;
    c.ticket_number = "";
    c.ticket_sys_id = null;
    c.files = null;
    c.fileData = null;
    c.currentTime = "";
    c.data.user_name = c.data.user_name || "„ÅäÂÆ¢Êßò";
    c.data.resources = c.data.resources || {};
    c.temp_settings = { email: c.data.emergency_email || "", medical_info: c.data.medical_info || "", blood_type: c.data.blood_type || "", will: c.data.saved_will || "" };

    // ==========================================
    // 4. Á≥ªÁªüÊó∂Èó¥Êõ¥Êñ∞
    // ==========================================
    function updateSystemTime() {
        var now = new Date();
        c.currentTime = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
    }
    updateSystemTime();
    var timeInterval = $interval(updateSystemTime, 1000);

    // ==========================================
    // 5. Â≠óÂÖ∏Êò†Â∞Ñ
    // ==========================================
    c.statusNames = { '1': 'DRAFT', '10': 'SUBMITTED', '11': 'ASSIGNED', '2': 'IN_PROGRESS', '4': 'COMPLETED', '5': 'CANCELLED', '6': 'ON_HOLD' };
    c.dict = { 'Water': 'È£≤ÊñôÊ∞¥', 'Food': 'È£üÊñô', 'Medical': 'ÂåªÁôÇ„ÉªËñ¨', 'Baby': '‰π≥ÂπºÂÖêÁî®ÂìÅ', 'Power': 'ÈõªÊ∫ê„ÉªÂÖÖÈõª', 'Other': '„Åù„ÅÆ‰ªñ', 'Family Area': '„Éï„Ç°„Éü„É™„Éº„Ç®„É™„Ç¢', 'Single Area': 'ÂçòË∫´„Ç®„É™„Ç¢', 'Medical Area': 'ÂåªÁôÇ„Éª„Ç±„Ç¢„Ç®„É™„Ç¢', 'Critical': 'ÈôêÁïå (SOS)', 'High': 'Âõ∞„Å£„Å¶„ÅÑ„Çã', 'Medium': 'ÊôÆÈÄö', 'Low': 'ÊÄ•„Åé„Åæ„Åõ„Çì' };
    c.statusDetails = { 1: { icon: ']]>üìù<![CDATA[', title: 'DRAFT', desc: 'ÈÄÅ‰ø°Ââç„ÅÆÁä∂ÊÖã', nextStep: 'ÈÄÅ‰ø°„Åó„Å¶„Åè„Å†„Åï„ÅÑ' }, 10: { icon: ']]>üì®<![CDATA[', title: 'SUBMITTED', desc: '„Ç∑„Çπ„ÉÜ„É†„Åå„É™„ÇØ„Ç®„Çπ„Éà„ÇíÂèó‰ø°', nextStep: '„Éú„É©„É≥„ÉÜ„Ç£„Ç¢Á¢∫Ë™çÂæÖ„Å°' }, 11: { icon: ']]>üôã<![CDATA[', title: 'ASSIGNED', desc: '„Éú„É©„É≥„ÉÜ„Ç£„Ç¢„ÅåÊãÖÂΩì', nextStep: 'ÈÖçÈÄÅÊ∫ñÂÇô‰∏≠' }, 2: { icon: ']]>üèÉ<![CDATA[', title: 'IN_PROGRESS', desc: 'ÊïëÊè¥Áâ©Ë≥á„ÇíÊåÅ„Å£„Å¶ÁßªÂãï‰∏≠', nextStep: '„Åæ„ÇÇ„Å™„ÅèÂà∞ÁùÄ' }, 4: { icon: '‚úÖ', title: 'COMPLETED', desc: '„ÅäÂ±ä„ÅëÂÆå‰∫Ü', nextStep: '„ÅäÂ§ß‰∫ã„Å´' }, 5: { icon: '‚ùå', title: 'CANCELLED', desc: '„É™„ÇØ„Ç®„Çπ„Éà„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü', nextStep: '' }, 6: { icon: '‚è∏Ô∏è', title: 'ON_HOLD', desc: '‰∏ÄÊôÇÂÅúÊ≠¢', nextStep: 'ÂÜçÈñãÂæÖ„Å°' } };

    // ==========================================
    // 6. Â∑•ÂÖ∑ÂáΩÊï∞
    // ==========================================
    function showSuccess(msg) { spUtil.addInfoMessage(msg); }
    function showError(msg) { spUtil.addErrorMessage(msg || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü'); }
    function handleServerResponse(response, successCallback) {
        if (!response || !response.data) { showError('„Çµ„Éº„Éê„Éº„Ç®„É©„Éº'); return false; }
        if (response.data.error) { showError(response.data.error); return false; }
        if (successCallback) successCallback(response.data);
        return true;
    }
    c.formatHours = function(minutes) {
        if (!minutes && minutes !== 0) return '--';
        minutes = parseInt(minutes) || 0;
        if (minutes < 0) { var om = Math.abs(minutes); return om < 60 ? '-' + om + 'ÂàÜ' : '-' + Math.floor(om/60) + 'ÊôÇÈñì' + (om%60 > 0 ? om%60 + 'ÂàÜ' : ''); }
        if (minutes < 60) return minutes + 'ÂàÜ';
        if (minutes < 1440) return Math.floor(minutes/60) + 'ÊôÇÈñì' + (minutes%60 > 0 ? minutes%60 + 'ÂàÜ' : '');
        return Math.floor(minutes/1440) + 'Êó•' + (Math.floor((minutes%1440)/60) > 0 ? Math.floor((minutes%1440)/60) + 'ÊôÇÈñì' : '');
    };

    // ==========================================
    // 7. ÂøóÊÑøËÄÖÊ®°Âºè
    // ==========================================
    if (c.data.is_volunteer) {
        spUtil.recordWatch($scope, 'x_1821654_kokoro_0_silent_wish', "", function() { c.server.update(); });
        c.filterByUrgency = function(urgency) { c.currentFilter = { type: 'urgency', value: urgency }; c.filteredList = c.data.list.filter(function(i) { return i.urgency === urgency; }); };
        c.filterByAssignment = function(status) { c.currentFilter = { type: 'assignment', value: status }; c.filteredList = c.data.list.filter(function(i) { return status === 'unassigned' ? !i.assigned_to_id : !!i.assigned_to_id; }); };
        c.clearFilters = function() { c.currentFilter = null; c.filteredList = null; };
        
        c.openModal = function(item) {
            if (!c.data.volunteers) c.server.get({ action: 'get_volunteers' }).then(function(r) { if (r && r.data && r.data.volunteers) c.data.volunteers = r.data.volunteers; });
            var modalInstance = $uibModal.open({ templateUrl: 'modalTemplate', scope: $scope, size: 'lg', backdrop: 'static', windowClass: 'kokoro-modal-window' });
            $scope.item = angular.copy(item); $scope.c = c; $scope.newComment = ""; $scope.showStatusDropdown = false; $scope.showAssigneeDropdown = false;
            $scope.cancel = function() { modalInstance.dismiss('cancel'); };
            $scope.assignToMe = function(item) {
                c.server.get({ action: 'assign_to_me', sys_id: item.sys_id }).then(function(r) {
                    if (handleServerResponse(r, function() {
                        item.assigned_to_id = c.data.user_id; item.assigned_to_name = c.data.user_name;
                        $scope.item.assigned_to_id = c.data.user_id; $scope.item.assigned_to_name = c.data.user_name;
                        if (item.state == 1 || item.state == 10) { item.state = 11; $scope.item.state = 11; }
                        showSuccess('ÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü'); c.server.update();
                    }));
                });
            };
            $scope.assignTo = function(item, userId, userName) {
                c.server.get({ action: 'assign_to', sys_id: item.sys_id, assignee_id: userId }).then(function(r) {
                    if (handleServerResponse(r, function() {
                        item.assigned_to_id = userId; item.assigned_to_name = userName;
                        $scope.item.assigned_to_id = userId; $scope.item.assigned_to_name = userName;
                        if (item.state == 1 || item.state == 10) { item.state = 11; $scope.item.state = 11; }
                        showSuccess(userName + '„ÇíÊãÖÂΩìËÄÖ„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü'); c.server.update();
                    }));
                });
            };
            $scope.changeStatus = function(item, newState) {
                var ns = parseInt(newState);
                if (ns === 11 && !item.assigned_to_id) { $scope.assignToMe(item); return; }
                if (ns === 2 && !item.assigned_to_id) { showError('ÂÖà„Å´ÊãÖÂΩìËÄÖ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                c.server.get({ action: 'change_status', sys_id: item.sys_id, new_state: newState }).then(function(r) {
                    if (handleServerResponse(r, function() {
                        item.state = ns; $scope.item.state = ns;
                        showSuccess('„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü'); c.server.update();
                        if (ns === 4 || ns === 5) $timeout(function() { modalInstance.close(); }, 1000);
                    }));
                });
            };
            $scope.postComment = function(item) {
                if (!$scope.newComment || !$scope.newComment.trim()) return;
                c.server.get({ action: 'add_comment', sys_id: item.sys_id, message: $scope.newComment }).then(function(r) {
                    if (handleServerResponse(r, function() {
                        if (!item.history) item.history = [];
                        item.history.unshift({ user: c.data.user_name || 'Me', text: $scope.newComment, date: new Date().toLocaleString('ja-JP') });
                        $scope.item.history = item.history; $scope.newComment = "";
                        showSuccess('„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
                    }));
                });
            };
            modalInstance.result.finally(function() { c.server.update(); });
        };
        c.updateStatus = function(sys_id, action) {
            if (!sys_id || !action) return;
            c.server.get({ action: action, sys_id: sys_id }).then(function(r) { handleServerResponse(r, function() { showSuccess('„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞„Åó„Åæ„Åó„Åü'); c.server.update(); }); });
        };
        var slaInterval = $interval(function() {
            angular.forEach(c.data.list, function(item) {
                if (!item.sla) return;
                item.sla.elapsed++; item.sla.remaining = item.sla.target - item.sla.elapsed;
                item.sla.percentage = Math.min((item.sla.elapsed / item.sla.target) * 100, 100);
                item.sla.status = item.sla.percentage > 100 ? 'critical' : (item.sla.percentage > 80 ? 'warning' : 'ok');
            });
        }, CONFIG.slaRefreshInterval);
    }

    // ==========================================
    // 8. ÈÅøÈöæËÄÖÊ®°Âºè - ÁúºÁùõË∑üÈöè
    // ==========================================
    $scope.eyeX = 0; $scope.eyeY = 0;
    var targetEyeX = 0, targetEyeY = 0, eyeAnimationFrame = null;
    function animateEyes() {
        $scope.eyeX += (targetEyeX - $scope.eyeX) * 0.15;
        $scope.eyeY += (targetEyeY - $scope.eyeY) * 0.15;
        if (Math.abs(targetEyeX - $scope.eyeX) > 0.01 || Math.abs(targetEyeY - $scope.eyeY) > 0.01) {
            eyeAnimationFrame = requestAnimationFrame(function() { $scope.$apply(); animateEyes(); });
        }
    }
    function handleMouseMove(e) {
        if (c.mode !== 'refugee') return;
        var cx = $window.innerWidth / 2, cy = $window.innerHeight / 2, r = 8;
        targetEyeX = Math.max(Math.min((e.clientX - cx) / cx * r, r), -r);
        targetEyeY = Math.max(Math.min((e.clientY - cy) / cy * r, r * 0.5), -r * 0.5);
        if (!eyeAnimationFrame) animateEyes();
    }
    $window.addEventListener('mousemove', handleMouseMove);

    c.pokeSlime = function() {
        if (c.step > 0 || c.show_will_input || c.is_poked) return;
        c.is_poked = true;
        c.server.get({ action: 'register_heartbeat' }).then(function(r) {
            handleServerResponse(r, function(data) {
                c.current_heartbeat_id = data.heartbeat_id;
                $timeout(function() { c.show_will_input = true; c.is_poked = false; }, 800);
            });
        }).catch(function() { c.is_poked = false; showError('Êé•Á∂ö„Ç®„É©„Éº'); });
    };
    c.finishHeartbeat = function(save) {
        if (save && c.digital_will && c.digital_will.trim()) {
            c.server.get({ action: 'update_will', heartbeat_id: c.current_heartbeat_id, message: c.digital_will }).then(function(r) { if (r && r.data && r.data.success) showSuccess("„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü"); });
        }
        c.show_will_input = false; c.digital_will = ""; c.step = 1;
    };
    c.onLocationChange = function() { if (c.step === 1 && !c.is_editing && c.data.location) $timeout(function() { c.step = 2; }, CONFIG.debounceDelay); };
    var detailCheckTimer = null;
    c.checkDetail = function() {
        if (detailCheckTimer) $timeout.cancel(detailCheckTimer);
        detailCheckTimer = $timeout(function() { if (c.data.detail_loc && c.data.detail_loc.trim().length > 0 && c.step < 3) c.step = 3; }, CONFIG.debounceDelay);
    };
    c.checkInput = function() { if (c.data.category && c.data.quantity && c.data.urgency && c.step < 4) c.step = 4; };
    c.editMode = function() { c.step = 4; c.is_editing = true; c.status_message = "ÂÜÖÂÆπ‰øÆÊ≠£‰∏≠..."; };
    c.submitWish = function() {
        if (!c.data.location) { showError("„Ç®„É™„Ç¢„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
        if (!c.data.detail_loc || c.data.detail_loc.trim() === '') { showError("Ë©≥Á¥∞„Å™Â†¥ÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
        if (!c.data.category) { showError("ÊîØÊè¥ÂÜÖÂÆπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
        if (!c.data.quantity || parseInt(c.data.quantity) < 1) { showError("Êï∞Èáè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
        if (!c.data.urgency) { showError("Á∑äÊÄ•Â∫¶„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
        c.submitting = true;
        c.server.get({ action: c.is_editing ? 'update_record' : 'submit_record', sys_id: c.ticket_sys_id, location: c.data.location, detail_loc: c.data.detail_loc, category: c.data.category, quantity: c.data.quantity, affected_count: c.data.affected_count, urgency: c.data.urgency, remarks: c.data.remarks, contact: c.data.contact }).then(function(response) {
            if (!handleServerResponse(response, function(data) {
                if (data.ticketNumber) { c.ticket_number = data.ticketNumber; c.ticket_sys_id = data.newRecordID || c.ticket_sys_id; }
                if (c.fileData && c.ticket_sys_id) { uploadFile(c.ticket_sys_id); } else { finishSubmit(c.ticket_sys_id); }
            })) { c.submitting = false; }
        }).catch(function() { c.submitting = false; showError('ÈÄÅ‰ø°Â§±Êïó'); });
    };
    function uploadFile(sysId) {
        c.server.get({ action: 'upload_attachment', sys_id: sysId, table: 'x_1821654_kokoro_0_silent_wish', file_name: c.files.name, file_data: c.fileData, content_type: c.files.type }).then(function() { finishSubmit(sysId); }).catch(function() { showError('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó'); finishSubmit(sysId); });
    }
    function finishSubmit(sysId) {
        c.submitting = false; c.is_editing = false; c.step = 5;
        c.current_state_val = CONFIG.states.SUBMITTED;
        c.status_message = c.statusDetails[CONFIG.states.SUBMITTED].desc;
        var slime = document.getElementById('the-slime'); if (slime) slime.classList.add('happy-slime');
        if (sysId) initRecordWatcher(sysId);
        showSuccess('„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ');
    }
    c.uploadFiles = function(files) {
        if (!files || !files.length) return;
        var file = files[0];
        if (['image/jpeg', 'image/png', 'image/gif', 'image/webp'].indexOf(file.type) === -1) { showError('JPEG„ÄÅPNG„ÄÅGIF„ÄÅWebPÂΩ¢Âºè„ÅÆÁîªÂÉè„ÅÆ„ÅøË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô'); return; }
        if (file.size > 5 * 1024 * 1024) { showError('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅØ5MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        c.files = file;
        var reader = new FileReader();
        reader.onload = function(e) { $scope.$apply(function() { c.fileData = e.target.result; }); };
        reader.readAsDataURL(file);
    };
    c.clearFile = function() { c.files = null; c.fileData = null; var inp = document.querySelector('input[type="file"]'); if (inp) inp.value = ''; };
    function initRecordWatcher(sysId) {
        spUtil.recordWatch($scope, 'x_1821654_kokoro_0_silent_wish', "sys_id=" + sysId, function(name, data) {
            if (!data || !data.record) return;
            $timeout(function() {
                if (data.record.state) { var sv = parseInt(data.record.state.value); c.current_state_val = sv; if (c.statusDetails[sv]) c.status_message = c.statusDetails[sv].desc; }
                if (data.record.assigned_to) c.assigned_to = data.record.assigned_to.display_value;
            });
        });
    }
    c.reset = function() {
        c.step = 0; c.data.category = ""; c.data.remarks = ""; c.data.quantity = ""; c.data.urgency = ""; c.data.detail_loc = ""; c.data.location = ""; c.data.affected_count = "";
        c.is_editing = false; c.ticket_number = ""; c.assigned_to = null; c.ticket_sys_id = null; c.files = null; c.fileData = null;
        c.show_will_input = false; c.digital_will = ""; c.current_state_val = 0; c.status_message = "ÂæÖÊ©ü‰∏≠...";
        var slime = document.getElementById('the-slime'); if (slime) slime.classList.remove('happy-slime');
    };
    c.toggleSettings = function() {
        c.showSettings = !c.showSettings;
        if (c.showSettings) c.temp_settings = { email: c.data.emergency_email || "", medical_info: c.data.medical_info || "", blood_type: c.data.blood_type || "", will: c.data.saved_will || "" };
    };
    c.saveSettings = function() {
        if (!c.temp_settings.email || c.temp_settings.email.trim() === '') { showError('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c.temp_settings.email)) { showError('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        c.saving = true;
        c.server.get({ action: 'save_settings', email: c.temp_settings.email, medical_info: c.temp_settings.medical_info, blood_type: c.temp_settings.blood_type, will: c.temp_settings.will }).then(function(response) {
            c.saving = false;
            if (handleServerResponse(response, function() {
                c.data.emergency_email = c.temp_settings.email; c.data.medical_info = c.temp_settings.medical_info; c.data.blood_type = c.temp_settings.blood_type; c.data.saved_will = c.temp_settings.will;
                c.showSettings = false; showSuccess('ÂÆâÂÖ®Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            }));
        }).catch(function() { c.saving = false; showError('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); });
    };

    $scope.$on('$destroy', function() {
        $window.removeEventListener('mousemove', handleMouseMove);
        if (eyeAnimationFrame) cancelAnimationFrame(eyeAnimationFrame);
        if (timeInterval) $interval.cancel(timeInterval);
        if (typeof slaInterval !== 'undefined' && slaInterval) $interval.cancel(slaInterval);
    });
}]]></client_script>
        <controller_as>c</controller_as>
        <css>@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&amp;family=Rajdhani:wght@400;500;600;700&amp;family=JetBrains+Mono:wght@400;500;700&amp;family=M+PLUS+Rounded+1c:wght@400;500;700;800&amp;display=swap');

:root {
  --bg-primary: #f5f5f5;
  --bg-secondary: #ffffff;
  --bg-tertiary: #fafafa;
  --border-color: #e0e0e0;
  --border-dark: #1a1a1a;
  --text-primary: #1a1a1a;
  --text-secondary: #666666;
  --text-muted: #999999;
  --accent-cyan: #00d4ff;
  --accent-red: #ff3b30;
  --accent-orange: #ff9500;
  --accent-green: #34c759;
  --accent-purple: #af52de;
  --tag-bg: #1a1a1a;
  --tag-text: #ffffff;
}

nav.navbar, .navbar-inverse, .sp-page-header, footer, .sp-footer, .row.marketing-header { 
  display: none !important; 
}

.kokoro-app-container {
  font-family: "JetBrains Mono", "Rajdhani", "M PLUS Rounded 1c", monospace;
  position: fixed !important;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100vw; height: 100vh;
  z-index: 100; 
  overflow-x: hidden;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-weight: 500;
}

/* ==========================================
   VOLUNTEER APP - White Industrial Style
   ========================================== */

.volunteer-app {
  width: 100%; 
  height: 100%; 
  overflow-y: auto;
  padding-bottom: 80px;
  background: var(--bg-primary);
  position: relative;
}

/* Safety Banner */
.safety-banner {
  background: var(--accent-red);
  color: #fff;
  padding: 12px 24px;
  font-size: 0.85rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  z-index: 10;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.safety-banner::before {
  content: '';
  position: absolute;
  left: 0; top: 0;
  width: 4px; height: 100%;
  background: #fff;
  animation: alertPulse 1s infinite;
}

@keyframes alertPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.safety-banner button {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.5);
  color: #fff !important;
  padding: 6px 14px;
  font-weight: 700;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 0.75rem;
  font-family: inherit;
}

.safety-banner button:hover {
  background: rgba(255,255,255,0.3);
}

/* Command Header */
.command-header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  padding: 16px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.command-logo {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo-icon {
  width: 40px;
  height: 40px;
  background: var(--tag-bg);
  color: var(--tag-text);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 1.2rem;
}

.logo-text {
  display: flex;
  flex-direction: column;
}

.logo-title {
  font-family: "Orbitron", monospace;
  font-size: 1.3rem;
  font-weight: 900;
  color: var(--text-primary);
  letter-spacing: 2px;
}

.logo-subtitle {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 3px;
}

.system-status {
  display: flex;
  align-items: center;
  gap: 20px;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
}

.status-dot {
  width: 8px;
  height: 8px;
  background: var(--accent-green);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.status-text {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.version-tag {
  font-size: 0.65rem;
  color: var(--text-muted);
  padding: 4px 8px;
  border: 1px solid var(--border-color);
}

.system-time {
  font-family: "Orbitron", monospace;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--text-secondary);
}

/* Navigation Tabs */
.nav-tabs {
  display: flex;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  padding: 0 28px;
  position: sticky;
  top: 0;
  z-index: 50;
}

.nav-tabs .tab {
  padding: 16px 24px;
  color: var(--text-muted);
  font-weight: 700;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s ease;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
}

.nav-tabs .tab-number {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-right: 4px;
}

.nav-tabs .tab:hover {
  color: var(--text-primary);
  background: var(--bg-tertiary);
}

.nav-tabs .tab.active {
  color: var(--text-primary);
  border-bottom-color: var(--text-primary);
  background: var(--bg-tertiary);
}

/* Scan Line Header */
.scan-line-header {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px 28px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
}

.scan-line {
  flex: 1;
  height: 1px;
  background: repeating-linear-gradient(90deg, var(--border-color) 0px, var(--border-color) 4px, transparent 4px, transparent 8px);
}

.scan-label {
  padding: 0 20px;
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 3px;
}

/* Board Container */
.board-container {
  padding: 28px;
  max-width: 1600px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

/* Stats Row - Metrics Overview Style */
.stats-section {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  margin-bottom: 28px;
}

.section-header {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border-color);
  background: var(--bg-tertiary);
}

.section-tag {
  background: var(--tag-bg);
  color: var(--tag-text);
  font-size: 0.7rem;
  font-weight: 700;
  padding: 4px 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-right: 10px;
}

.section-title {
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-primary);
}

.section-time {
  margin-left: auto;
  font-family: "Orbitron", monospace;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.stats-row { 
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  border-bottom: 1px solid var(--border-color);
}

.stat-card {
  padding: 24px 28px;
  border-right: 1px solid var(--border-color);
  position: relative;
  cursor: pointer;
  transition: background 0.2s ease;
}

.stat-card:last-child {
  border-right: none;
}

.stat-card:hover {
  background: var(--bg-tertiary);
}

.stat-card.clickable::after {
  content: '\2192';
  position: absolute;
  top: 16px;
  right: 16px;
  color: var(--text-muted);
  font-size: 1rem;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.stat-card.clickable:hover::after {
  opacity: 1;
}

.stat-label {
  display: flex;
  align-items: baseline;
  gap: 4px;
  margin-bottom: 8px;
}

.stat-code {
  font-family: "Orbitron", monospace;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--text-primary);
}

.stat-suffix {
  font-size: 0.7rem;
  color: var(--text-muted);
}

.stat-num {
  font-family: "Orbitron", monospace;
  font-size: 3.5rem;
  font-weight: 900;
  line-height: 1;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.stat-num .unit {
  font-size: 1.2rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin-left: 4px;
}

.stat-name {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 12px;
}

.stat-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

.stat-change {
  font-size: 0.75rem;
  font-weight: 700;
}

.stat-change.positive { color: var(--accent-green); }
.stat-change.negative { color: var(--accent-red); }

.stat-status {
  font-size: 0.65rem;
  padding: 3px 8px;
  border: 1px solid var(--border-color);
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
}

.stat-status.nominal { border-color: var(--accent-green); color: var(--accent-green); }
.stat-status.warning { border-color: var(--accent-orange); color: var(--accent-orange); }
.stat-status.critical { border-color: var(--accent-red); color: var(--accent-red); }

.stat-sparkline {
  display: flex;
  align-items: flex-end;
  gap: 2px;
  height: 20px;
  margin-top: 8px;
}

.spark-bar {
  width: 4px;
  background: var(--border-color);
  transition: height 0.3s ease;
}

/* Two Column Layout */
.two-column-layout {
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 28px;
}

/* Alert Feed Section */
.alert-section {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
}

.alert-list {
  max-height: 500px;
  overflow-y: auto;
}

.alert-item {
  display: grid;
  grid-template-columns: auto 1fr auto auto auto auto;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  border-left: 4px solid transparent;
  cursor: pointer;
  transition: all 0.2s ease;
}

.alert-item:hover {
  background: var(--bg-tertiary);
}

.alert-item:last-child {
  border-bottom: none;
}

.alert-item.priority-Critical {
  border-left-color: var(--accent-red);
}

.alert-item.priority-High {
  border-left-color: var(--accent-orange);
}

.alert-item.priority-Medium {
  border-left-color: var(--accent-cyan);
}

.alert-item.priority-Low {
  border-left-color: var(--accent-green);
}

.alert-id {
  font-family: "Orbitron", monospace;
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--text-secondary);
  min-width: 60px;
}

.alert-priority {
  font-size: 0.65rem;
  font-weight: 700;
  padding: 4px 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: var(--tag-bg);
  color: var(--tag-text);
}

.alert-priority.p-critical { background: var(--accent-red); }
.alert-priority.p-high { background: var(--accent-orange); }
.alert-priority.p-medium { background: var(--accent-cyan); color: #000; }
.alert-priority.p-low { background: var(--accent-green); color: #000; }

.alert-zone {
  font-size: 0.7rem;
  padding: 4px 8px;
  border: 1px solid var(--border-color);
  text-transform: uppercase;
  min-width: 50px;
  text-align: center;
}

.alert-time {
  font-family: "Orbitron", monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
  min-width: 70px;
}

.alert-content {
  font-size: 0.85rem;
  color: var(--text-primary);
  font-weight: 500;
}

.alert-arrow {
  color: var(--text-muted);
  font-size: 1.2rem;
}

/* Resource Status Section */
.resource-section {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
}

.resource-list {
  padding: 0;
}

.resource-item {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
}

.resource-item:last-child {
  border-bottom: none;
}

.resource-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.resource-tag {
  font-size: 0.65rem;
  padding: 3px 6px;
  border: 1px solid var(--border-color);
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
}

.resource-name {
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--text-primary);
}

.resource-percent {
  font-family: "Orbitron", monospace;
  font-size: 0.9rem;
  font-weight: 700;
}

.resource-bar {
  height: 6px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  margin-bottom: 8px;
  overflow: hidden;
}

.resource-fill {
  height: 100%;
  background: var(--text-primary);
  transition: width 0.5s ease;
}

.resource-fill.low { background: var(--accent-red); }
.resource-fill.medium { background: var(--accent-orange); }
.resource-fill.high { background: var(--accent-green); }

.resource-count {
  font-family: "Orbitron", monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* Card Grid for Tasks */
.card-section {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  margin-top: 28px;
}

.card-grid, .task-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 0;
}

.jira-card {
  background: var(--bg-secondary);
  border-right: 1px solid var(--border-color);
  border-bottom: 1px solid var(--border-color);
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.jira-card:hover {
  background: var(--bg-tertiary);
}

.jira-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 4px; height: 100%;
}

.jira-card.priority-Critical::before { background: var(--accent-red); }
.jira-card.priority-High::before { background: var(--accent-orange); }
.jira-card.priority-Medium::before { background: var(--accent-cyan); }
.jira-card.priority-Low::before { background: var(--accent-green); }

.card-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.card-id {
  font-family: "Orbitron", monospace;
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-muted);
  letter-spacing: 1px;
}

.card-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.qty-badge {
  background: var(--tag-bg);
  color: var(--tag-text);
  font-family: "Orbitron", monospace;
  font-size: 0.7rem;
  padding: 3px 8px;
  font-weight: 700;
}

.card-loc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.card-loc i { color: var(--accent-red); }

.card-detail {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 8px;
  padding: 10px 12px;
  background: var(--bg-tertiary);
  border-left: 2px solid var(--border-color);
}

.card-footer {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

.status-tag {
  font-size: 0.65rem;
  padding: 4px 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 1px solid;
}

.status-tag.status-1, .status-tag.status-10 { 
  background: rgba(0,212,255,0.1); 
  color: #0094cc; 
  border-color: var(--accent-cyan);
}
.status-tag.status-11 { 
  background: rgba(175,82,222,0.1); 
  color: var(--accent-purple); 
  border-color: var(--accent-purple);
}
.status-tag.status-2 { 
  background: rgba(255,149,0,0.1); 
  color: #cc7700; 
  border-color: var(--accent-orange);
}
.status-tag.status-4 { 
  background: rgba(52,199,89,0.1); 
  color: #28a745; 
  border-color: var(--accent-green);
}
.status-tag.status-5 { 
  background: rgba(255,59,48,0.1); 
  color: var(--accent-red); 
  border-color: var(--accent-red);
}

.priority-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
}

.priority-badge.priority-Critical { border-color: var(--accent-red); color: var(--accent-red); }
.priority-badge.priority-High { border-color: var(--accent-orange); color: #cc7700; }
.priority-badge.priority-Medium { border-color: var(--accent-cyan); color: #0094cc; }
.priority-badge.priority-Low { border-color: var(--accent-green); color: #28a745; }

/* Buttons */
.btn-jira {
  width: 100%;
  border: 1px solid var(--border-dark);
  background: var(--bg-secondary);
  padding: 12px 16px;
  font-size: 0.8rem;
  font-weight: 700;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s ease;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-family: inherit;
  color: var(--text-primary);
}

.btn-jira:hover {
  background: var(--tag-bg);
  color: var(--tag-text);
}

.btn-jira.progress { 
  background: var(--accent-orange);
  border-color: var(--accent-orange);
  color: #fff;
}

.btn-jira.progress:hover {
  background: #cc7700;
}

.btn-jira.success { 
  background: var(--accent-green);
  border-color: var(--accent-green);
  color: #fff;
}

.btn-jira.success:hover {
  background: #28a745;
}

.completed-msg {
  cursor: pointer;
  padding: 12px;
  background: rgba(52,199,89,0.1);
  border: 1px solid var(--accent-green);
  color: #28a745;
  font-weight: 700;
  text-align: center;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.completed-msg:hover {
  background: rgba(52,199,89,0.2);
}

/* Empty State */
.empty-board {
  text-align: center;
  padding: 60px 40px;
  color: var(--text-muted);
  background: var(--bg-tertiary);
  border: 1px dashed var(--border-color);
}

.empty-board i {
  font-size: 3rem;
  margin-bottom: 16px;
  color: var(--border-color);
}

.empty-board h4 {
  color: var(--text-secondary);
  margin-bottom: 8px;
}

/* ==========================================
   REFUGEE MODE - Kokoro World (Pink Theme)
   ========================================== */

.kokoro-world {
  width: 100%;
  height: 100%;
  background: linear-gradient(180deg, #ffe4e1 0%, #fff0f0 40%, #fdf8f8 100%);
  position: relative;
  overflow: hidden;
}

.slime-stage-container {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  pointer-events: none;
}

.kokoro-slime {
  width: 260px;
  height: 240px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), #ff9a9e);
  box-shadow: 
    0 15px 50px rgba(255, 150, 150, 0.4),
    inset 5px 5px 30px rgba(255, 255, 255, 0.8);
  border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
  animation: slimeMorph 8s ease-in-out infinite;
  position: relative;
  margin-bottom: 280px;
  transform-origin: center bottom;
  cursor: pointer;
  pointer-events: auto !important;
  z-index: 100;
}

.kokoro-slime .slime-eyes {
  position: absolute;
  top: 40%;
  left: 50%;
  margin-left: -35px;
  width: 70px;
  height: 15px;
  transition: transform 0.15s ease-out;
}

.kokoro-slime .slime-eyes::before,
.kokoro-slime .slime-eyes::after {
  content: '';
  position: absolute;
  top: 0;
  width: 14px;
  height: 14px;
  background: #5d4037;
  border-radius: 50%;
  animation: blink 4s infinite;
}

.kokoro-slime .slime-eyes::before { left: 0; }
.kokoro-slime .slime-eyes::after { right: 0; }

.kokoro-slime .slime-mouth { display: none !important; }

.kokoro-slime.happy-slime {
  animation: happyJump 1s ease infinite;
  filter: saturate(1.2) brightness(1.05);
}

.kokoro-slime.poked {
  animation: gentleHeartbeat 0.6s ease-in-out forwards !important;
  filter: saturate(1.2) brightness(1.1);
}

.kokoro-slime.hungry-slime {
  filter: saturate(0.4) brightness(0.95);
  transform: scale(0.9);
  animation: slimeMorph 10s ease-in-out infinite;
}

.pulse-overlay {
  position: absolute;
  top: 15%;
  width: 100%;
  text-align: center;
  z-index: 5;
  animation: fadeIn 1.5s ease;
  pointer-events: none;
}

.pulse-title {
  font-family: "M PLUS Rounded 1c", sans-serif;
  font-size: 2.2rem;
  color: #5d4037;
  font-weight: 800;
  text-shadow: 0 4px 15px rgba(255, 255, 255, 0.9);
  letter-spacing: 2px;
}

.sub-text {
  font-size: 0.9rem;
  opacity: 0.7;
  font-weight: 600;
}

.dialog-stage-container {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 10;
  overflow-y: auto;
  scroll-behavior: smooth;
  padding: 80px 20px 40px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.floating-header {
  position: relative;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 20px 24px;
  border-radius: 24px;
  margin-bottom: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  z-index: 5;
}

.form-title {
  font-size: 1.4rem;
  color: #ec407a;
  margin: 0 0 16px 0;
  text-align: center;
  font-weight: 800;
}

.progress-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.progress-step {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #eceff1;
  color: #90a4ae;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.progress-step.active {
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(236, 64, 122, 0.35);
}

.progress-line {
  width: 36px;
  height: 4px;
  background: #eceff1;
  border-radius: 2px;
  transition: all 0.3s ease;
}

.progress-line.active {
  background: linear-gradient(90deg, #ec407a, #f48fb1);
}

.form-wrapper {
  width: 100%;
  max-width: 500px;
}

.step-card {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(12px);
  border-radius: 28px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 10px 40px -10px rgba(255, 180, 180, 0.3);
  border: 2px solid rgba(255, 255, 255, 0.8);
  animation: slideUp 0.4s ease;
}

.big-label {
  display: block;
  font-size: 1.1rem;
  font-weight: 800;
  color: #4e342e;
  margin-bottom: 10px;
  margin-left: 4px;
}

.input-wrapper {
  position: relative;
  width: 100%;
}

.input-wrapper i.select-arrow {
  position: absolute;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  color: #ff80ab;
  pointer-events: none;
  font-size: 1.1rem;
}

.big-input {
  width: 100%;
  height: 60px;
  background: #fff;
  border: 3px solid #fce4ec;
  border-radius: 30px;
  font-size: 1.1rem;
  font-weight: 500;
  color: #333;
  padding: 0 24px;
  outline: none;
  transition: all 0.2s ease;
  box-sizing: border-box;
  font-family: inherit;
}

.big-input:focus {
  border-color: #ff80ab;
  box-shadow: 0 0 0 4px rgba(255, 128, 171, 0.15);
}

select.big-input {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  padding-right: 50px;
  cursor: pointer;
}

.glass-textarea {
  width: 100%;
  min-height: 100px;
  background: #fff;
  border: 3px solid #fce4ec;
  border-radius: 20px;
  padding: 16px;
  font-size: 1rem;
  font-weight: 500;
  color: #333;
  outline: none;
  resize: vertical;
  font-family: inherit;
  transition: all 0.2s ease;
  box-sizing: border-box;
}

.glass-textarea:focus {
  border-color: #ff80ab;
  box-shadow: 0 0 0 4px rgba(255, 128, 171, 0.15);
}

.action-row {
  display: flex;
  gap: 14px;
  margin-top: 16px;
}

.flex-row {
  display: flex;
  gap: 14px;
  margin-bottom: 16px;
}

.half-col { flex: 1; }
.mb-3 { margin-bottom: 20px; }

.critical-bg {
  background-color: #ffebee !important;
  color: #c62828 !important;
  border-color: #ffcdd2 !important;
}

.big-attach-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #fff;
  border: 3px solid #ff80ab;
  color: #ff80ab;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 22px;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.big-attach-btn:hover {
  background: #ff80ab;
  color: white;
  transform: scale(1.05);
}

.big-submit-btn {
  flex: 1;
  height: 60px;
  border-radius: 30px;
  background: linear-gradient(135deg, #ff80ab, #f8bbd0);
  color: #fff;
  font-size: 1.2rem;
  font-weight: 800;
  border: none;
  box-shadow: 0 10px 30px rgba(255, 150, 150, 0.4);
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  transition: all 0.2s ease;
  font-family: inherit;
}

.big-submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 14px 36px rgba(255, 150, 150, 0.5);
}

.success-card {
  width: 100%;
  max-width: 500px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 32px;
  padding: 28px;
  text-align: center;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
  border: 3px solid #fce4ec;
}

.success-title {
  font-size: 1.5rem;
  color: #ec407a;
  font-weight: 800;
  margin-bottom: 4px;
}

.ticket-id {
  font-family: 'Orbitron', monospace;
  color: #90a4ae;
  margin-bottom: 20px;
  font-weight: 600;
  font-size: 0.9rem;
}

.status-tracker {
  display: flex;
  justify-content: space-between;
  margin: 24px 0;
  padding: 0 8px;
}

.status-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  opacity: 0.3;
  transition: all 0.3s ease;
}

.status-step .icon { font-size: 1.8rem; margin-bottom: 6px; }
.status-step .text { font-size: 0.7rem; font-weight: 800; }
.status-step.active { opacity: 1; transform: scale(1.1); }
.status-step.active .text { color: #d81b60; }

.status-tracker .line {
  flex-grow: 1;
  height: 4px;
  background: #eee;
  margin: 15px 6px 0;
  border-radius: 2px;
  transition: all 0.3s ease;
}

.status-tracker .line.active {
  background: linear-gradient(90deg, #ff9a9e, #f48fb1);
}

.summary-card {
  background: #fafafa;
  border-radius: 20px;
  padding: 20px;
  text-align: left;
  margin-bottom: 20px;
}

.summary-card .row-item {
  margin-bottom: 10px;
  color: #37474f;
  font-size: 0.95rem;
  font-weight: 500;
  border-bottom: 1px dashed #e0e0e0;
  padding-bottom: 10px;
}

.summary-card .row-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.summary-card strong {
  font-weight: 800;
  margin-right: 6px;
  color: #5d4037;
}

.summary-card .badge {
  background: #e3f2fd;
  color: #1e88e5;
  padding: 3px 10px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 700;
}

.summary-card .text-crit {
  color: #c62828;
  font-weight: 800;
}

.live-status-pill {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  background: #e0f7fa;
  color: #006064;
  height: 56px;
  border-radius: 28px;
  font-weight: 800;
  font-size: 1rem;
  margin-bottom: 20px;
}

.pulse-dot {
  width: 10px;
  height: 10px;
  background: #00bcd4;
  border-radius: 50%;
  animation: pulse 1.5s infinite;
}

.status-detail-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 20px;
  margin: 20px 0;
  text-align: center;
}

.status-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 8px;
}

.status-icon { font-size: 2rem; }

.status-detail-card .status-title {
  font-size: 1.3rem;
  font-weight: 800;
  margin: 0;
}

.status-desc {
  font-size: 0.95rem;
  opacity: 0.92;
  margin: 10px 0;
}

.status-next {
  font-size: 0.85rem;
  opacity: 0.8;
  font-style: italic;
}

.btn-group {
  display: flex;
  gap: 14px;
  justify-content: center;
}

.edit-btn, .big-reset-btn {
  flex: 1;
  height: 56px;
  border-radius: 28px;
  border: none;
  font-weight: 800;
  font-size: 0.95rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  font-family: inherit;
}

.edit-btn {
  background: #fff;
  border: 2px solid #ff80ab;
  color: #ff80ab;
}

.edit-btn:hover {
  background: #ff80ab;
  color: white;
}

.big-reset-btn {
  background: #eceff1;
  color: #546e7a;
}

.big-reset-btn:hover {
  background: #cfd8dc;
}

.will-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 240, 245, 0.8);
  backdrop-filter: blur(8px);
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.will-card {
  width: 90%;
  max-width: 400px;
  background: rgba(255, 255, 255, 0.98);
  border: 2px solid #ffcfdc;
  border-radius: 28px;
  padding: 28px 24px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(255, 182, 193, 0.4);
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.will-title {
  font-size: 1.3rem;
  color: #ec407a;
  font-weight: 800;
  margin-bottom: 8px;
}

.will-desc {
  font-size: 0.92rem;
  color: #5d4037;
  margin-bottom: 20px;
  line-height: 1.6;
}

.will-textarea {
  width: 100%;
  height: 100px;
  border: 2px solid #f8bbd0;
  border-radius: 16px;
  padding: 14px;
  font-size: 1rem;
  color: #333;
  outline: none;
  resize: none;
  background: #fff;
  font-family: inherit;
  transition: all 0.2s ease;
  box-sizing: border-box;
}

.will-textarea:focus {
  border-color: #ec407a;
  background: #fff5f8;
}

.will-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.btn-will-skip, .btn-will-save {
  flex: 1;
  padding: 14px;
  border-radius: 22px;
  border: none;
  font-weight: 700;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
}

.btn-will-skip {
  background: #f5f5f5;
  color: #757575;
}

.btn-will-skip:hover {
  background: #e0e0e0;
}

.btn-will-save {
  background: linear-gradient(135deg, #ec407a, #f48fb1);
  color: white;
  box-shadow: 0 6px 18px rgba(236, 64, 122, 0.35);
}

.btn-will-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(236, 64, 122, 0.45);
}

.safety-settings-btn {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(4px);
  padding: 10px 16px;
  border-radius: 22px;
  border: 1px solid rgba(255, 255, 255, 0.9);
  color: #5d4037;
  font-weight: 700;
  font-size: 0.9rem;
  cursor: pointer;
  z-index: 200;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.safety-settings-btn:hover {
  background: #fff;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.safety-settings-btn i { color: #ec407a; }

.settings-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(93, 64, 55, 0.4);
  backdrop-filter: blur(5px);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.settings-card {
  width: 90%;
  max-width: 480px;
  background: #fff;
  border-radius: 24px;
  padding: 28px;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease;
  max-height: 85vh;
  overflow-y: auto;
}

.settings-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #fce4ec;
}

.settings-card .card-header h3 {
  margin: 0;
  color: #ec407a;
  font-weight: 800;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.settings-card .close-btn {
  font-size: 1.6rem;
  color: #999;
  cursor: pointer;
  transition: all 0.15s ease;
  line-height: 1;
  padding: 4px;
  border: none;
  background: none;
}

.settings-card .close-btn:hover {
  color: #ec407a;
  transform: scale(1.1);
}

.settings-desc {
  font-size: 0.85rem;
  color: #666;
  margin-bottom: 24px;
  line-height: 1.6;
  background: #fff5f8;
  padding: 14px 16px;
  border-radius: 12px;
  border-left: 4px solid #ec407a;
}

.input-group {
  margin-bottom: 20px;
  text-align: left;
}

.input-group label {
  display: block;
  font-weight: 700;
  color: #5d4037;
  margin-bottom: 8px;
  font-size: 0.95rem;
}

.glass-input {
  width: 100%;
  background: #fff;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  padding: 14px 16px;
  font-size: 1rem;
  color: #333;
  outline: none;
  font-family: inherit;
  transition: all 0.15s ease;
  box-sizing: border-box;
}

.glass-input:focus {
  border-color: #ec407a;
  box-shadow: 0 0 0 3px rgba(236, 64, 122, 0.12);
}

select.glass-input {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ec407a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 40px;
}

textarea.glass-input {
  min-height: 80px;
  resize: vertical;
}

.save-settings-btn {
  width: 100%;
  height: 52px;
  margin-top: 8px;
  background: linear-gradient(135deg, #ec407a, #d81b60);
  color: white;
  border: none;
  border-radius: 26px;
  font-size: 1.05rem;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(236, 64, 122, 0.35);
  transition: all 0.15s ease;
  font-family: inherit;
}

.save-settings-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 28px rgba(236, 64, 122, 0.45);
}

.debug-switch {
  position: absolute;
  top: 16px;
  right: 16px;
  opacity: 0.5;
  cursor: pointer;
  font-size: 1.8rem;
  z-index: 999;
  pointer-events: auto !important;
  color: #5d4037;
  transition: all 0.2s ease;
}

.debug-switch:hover { opacity: 1; }

.loading-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.9);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(5px);
}

.loading-content {
  text-align: center;
  color: #ff80ab;
}

.loading-content p {
  margin-top: 16px;
  font-size: 1.4rem;
  font-weight: 700;
  color: #333;
}

.loading-content small {
  color: #666;
  font-size: 0.9rem;
}

/* Animations */
@keyframes slimeMorph {
  0%, 100% {
    border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
    transform: translate(0, 0) scale(1);
  }
  33% {
    border-radius: 50% 60% 40% 70% / 50% 60% 40% 60%;
    transform: translate(8px, -5px) scale(1.02, 0.98);
  }
  66% {
    border-radius: 70% 40% 60% 30% / 70% 40% 60% 30%;
    transform: translate(-8px, 5px) scale(0.98, 1.02);
  }
}

@keyframes gentleHeartbeat {
  0% { transform: scale(1); }
  15% { transform: scale(1.08); }
  30% { transform: scale(1); }
  45% { transform: scale(1.08); }
  60% { transform: scale(1); }
  100% { transform: scale(1); }
}

@keyframes happyJump {
  0%, 100% { transform: scale(1) translateY(0); }
  50% { transform: scale(1.02, 0.98) translateY(-10px); }
}

@keyframes blink {
  0%, 96%, 100% { transform: scaleY(1); }
  98% { transform: scaleY(0.1); }
}

@keyframes popIn {
  from { opacity: 0; transform: scale(0.5); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 1200px) {
  .two-column-layout {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .stats-row { 
    grid-template-columns: 1fr 1fr;
  }
  .stat-card {
    border-bottom: 1px solid var(--border-color);
  }
  .card-grid, .task-grid { 
    grid-template-columns: 1fr; 
  }
  .nav-tabs .tab { 
    padding: 12px 16px; 
    font-size: 0.7rem; 
  }
  .command-header {
    flex-direction: column;
    gap: 16px;
    align-items: flex-start;
  }
  .alert-item {
    grid-template-columns: auto auto 1fr auto;
    gap: 10px;
  }
  .alert-zone, .alert-time {
    display: none;
  }
}

@media (max-width: 480px) {
  .board-container { padding: 12px; }
  .nav-tabs { padding: 0 12px; }
  .nav-tabs .tab i { display: none; }
  .stats-row { grid-template-columns: 1fr; }
  .stat-num { font-size: 2.5rem; }
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>kokoro_interaction</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
  // 1. Ëé∑Âèñ DOM ÂÖÉÁ¥†
  // ‰ΩøÁî® .find() Âú®ÂΩìÂâçÁªÑ‰ª∂ÂÜÖÊü•ÊâæÔºåÈÅøÂÖçÂÜ≤Á™Å
  var $slime = element.find('.kokoro-slime');
  var $eyes = element.find('.slime-eyes');
  var $window = $(window);
  var ticking = false; // Áî®‰∫é requestAnimationFrame ÁöÑÈîÅ

  // 2. ÂÆö‰πâÈº†Ê†áÁßªÂä®ÈÄªËæë
  var onMouseMove = function(e) {
    if (ticking) return; // Â¶ÇÊûú‰∏ä‰∏ÄÂ∏ßËøòÊ≤°ÁîªÂÆåÔºåË∑≥ËøáËøôÊ¨°ËÆ°ÁÆó

    ticking = true;
    window.requestAnimationFrame(function() {
      
      // ÂÆπÈîôÔºöÂ¶ÇÊûúÈ°µÈù¢ÂàáÊç¢‰∫ÜÔºåÂÖÉÁ¥†Êâæ‰∏çÂà∞ÔºåÂ∞±ÂÅúÊ≠¢
      if ($slime.length === 0 || $eyes.length === 0) {
        $slime = element.find('.kokoro-slime');
        $eyes = element.find('.slime-eyes');
        ticking = false;
        return;
      }

      // --- A. ËÆ°ÁÆó‰∏≠ÂøÉÁÇπ ---
      // ÂÆûÊó∂Ëé∑ÂèñÂè≤Ëé±ÂßÜÂú®Â±èÂπïÁöÑ‰ΩçÁΩÆ
      var rect = $slime[0].getBoundingClientRect();
      var slimeCenterX = rect.left + rect.width / 2;
      var slimeCenterY = rect.top + rect.height / 2;

      // --- B. ËÆ°ÁÆóÈº†Ê†áÂÅèÁßªÈáè (Delta) ---
      var dx = e.clientX - slimeCenterX;
      var dy = e.clientY - slimeCenterY;

      // --- C. ÂÆö‰πâÁßªÂä®ÂèÇÊï∞ (Áâ©ÁêÜÊâãÊÑü) ---
      
      // 1. Ë∫´‰ΩìÊôÉÂä® (Body Sway)
      // Èô§Êï∞Ë∂äÂ§ßÔºåÂä®ÂæóË∂äÂ∞ë„ÄÇdx/100 ÊÑèÂë≥ÁùÄÈº†Ê†áÂä®100pxÔºåË∫´‰ΩìÂä®1px
      var bodyX = dx / 80; 
      var bodyY = dy / 80;

      // 2. ÁúºÁ•ûË∑üÈöè (Eye Tracking)
      // ÈôêÂà∂ËåÉÂõ¥ (Clamp)ÔºåÈò≤Ê≠¢ÁúºÁêÉÈ£ûÂá∫ÁúºÁú∂
      // Math.max(-25, Math.min(val, 25)) ÊÑèÊÄùÊòØÊääÂÄºÈôêÂà∂Âú® -25 Âà∞ 25 ‰πãÈó¥
      var eyeX = Math.max(-25, Math.min(dx / 12, 25)); 
      var eyeY = Math.max(-15, Math.min(dy / 10, 15));

      // --- D. Â∫îÁî®Ê†∑Âºè (CSS Transform) ---
      // ÂÖ≥ÈîÆÔºöÂøÖÈ°ª‰øùÁïô scale(1) ÊàñÂÖ∂‰ªñÂéüÊúâÂ±ûÊÄßÔºåÂπ∂ÁªìÂêà translate
      
      // Ë∫´‰ΩìÔºö‰øùÊåÅÂéüÊú¨ÁöÑÂ±Ö‰∏≠ (-50%, -50%) Âä†‰∏äÂæÆÂ∞èÁöÑ bodyX/Y
      // Ê≥®ÊÑèÔºöËøôÈáåÊàë‰ª¨‰∏çÊîπÂèò CSS ÈáåÁöÑ translate(-50%, -50%)ÔºåËÄåÊòØÈÄöËøá margin ÊàñËÄÖ Á¥ØÂä† translate Êù•ÂÆûÁé∞
      // ÊúÄÁ®≥Â¶•ÁöÑÊñπÊ≥ïÊòØÁõ¥Êé•Ë¶ÜÁõñ transformÔºå‰ΩÜË¶ÅÊääÂü∫ÂáÜÂÄºÂÜôËøõÂéª
      // CSS ‰∏≠ÊòØ: translate(-50%, -50%)
      // JS Ë¶ÜÁõñ‰∏∫: translate(calc(-50% + Xpx), calc(-50% + Ypx))
      $slime.css('transform', 
        'translate(calc(-50% + ' + bodyX + 'px), calc(-50% + ' + bodyY + 'px))'
      );

      // ÁúºÁùõÔºöÁõ∏ÂØπ‰∫éËÑ∏ÈÉ®ÁßªÂä®
      $eyes.css('transform', 
        'translate(' + eyeX + 'px, ' + eyeY + 'px)'
      );

      ticking = false;
    });
  };

  // 3. ÁªëÂÆö‰∫ã‰ª∂
  $window.on('mousemove', onMouseMove);

  // 4. Ê∏ÖÁêÜÊú∫Âà∂ (Best Practice)
  // ÂΩì Widget Ë¢´ÈîÄÊØÅÊó∂Ôºà‰æãÂ¶ÇÁî®Êà∑Á¶ªÂºÄ‰∫ÜÈ°µÈù¢ÔºâÔºåÂøÖÈ°ªÁßªÈô§ÁõëÂê¨Âô®ÔºåÂê¶Âàô‰ºöÂÜÖÂ≠òÊ≥ÑÊºè
  scope.$on('$destroy', function() {
    $window.off('mousemove', onMouseMove);
  });
}]]></link>
        <name>Kokoro Interaction</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
    // ============================================================
    // KOKORO SHELTER - Server Script (Fixed Version)
    // ============================================================

    var CONFIG = {
        tables: {
            SILENT_WISH: 'x_1821654_kokoro_0_silent_wish',
            USER_PROFILE: 'x_1821654_kokoro_0_x_kokoro_user_profile',
            HEARTBEAT: 'x_1821654_kokoro_0_x_1821654_kokoro_0_heartbeat',
            EMERGENCY_MESSAGE: 'x_1821654_kokoro_0_emergency_message',
            PROCESS_EVENT: 'x_1821654_kokoro_0_process_event'
        },
        wishStates: {
            DRAFT: '1',
            SUBMITTED: '10',
            ASSIGNED: '11',
            IN_PROGRESS: '2',
            COMPLETED: '4',
            CANCELLED: '5',
            ON_HOLD: '6'
        },
        slaTargets: {
            'Critical': 30,
            'High': 60,
            'Medium': 120,
            'Low': 240
        }
    };

    data.user_id = gs.getUserID();
    data.user_name = gs.getUserDisplayName();
    
    var isVolunteer = gs.hasRole('admin') || gs.hasRole('x_1821654_kokoro_0.volunteer');
    data.is_volunteer = isVolunteer;

    data.emergency_email = "";
    data.medical_info = "";
    data.blood_type = "";
    data.saved_will = "";
    data.list = [];
    data.myTasks = [];
    data.volunteers = [];
    data.openCount = 0;
    data.sosCount = 0;

    function sanitizeInput(inputVal, maxLength) {
        if (!inputVal) return '';
        var cleaned = String(inputVal)
            .replace(/[<>\"'&]/g, '')
            .replace(/[\r\n]+/g, ' ')
            .trim();
        if (maxLength && cleaned.length > maxLength) {
            cleaned = cleaned.substring(0, maxLength);
        }
        return cleaned;
    }

    function validateSysId(sysId) {
        if (!sysId) return false;
        return /^[a-f0-9]{32}$/.test(String(sysId));
    }

    function logProcessEvent(caseId, activity, userId) {
        try {
            var pe = new GlideRecord(CONFIG.tables.PROCESS_EVENT);
            pe.initialize();
            pe.setValue('case_id', caseId || '');
            pe.setValue('activity', sanitizeInput(activity, 200));
            pe.setValue('timestamp', new GlideDateTime());
            pe.setValue('user', userId || gs.getUserID());
            pe.insert();
        } catch (e) {
            gs.error('[Kokoro] Process event log error: ' + e.message);
        }
    }

    var StateValidator = {
        allowedTransitions: {
            '1':  ['10', '11', '5'],
            '10': ['1', '11', '5'],
            '11': ['10', '2', '5', '6'],
            '2':  ['4', '5', '6'],
            '4':  [],
            '5':  [],
            '6':  ['11', '2', '5']
        },
        
        validateTransition: function(fromState, toState) {
            fromState = String(fromState);
            toState = String(toState);
            
            if (!fromState || fromState === '' || fromState === 'undefined' || fromState === 'null') {
                return { valid: true };
            }
            
            if (!this.allowedTransitions.hasOwnProperty(fromState)) {
                return { valid: false, message: 'ÁÑ°Âäπ„Å™ÁèæÂú®Áä∂ÊÖã: ' + fromState };
            }
            
            var allowed = this.allowedTransitions[fromState];
            if (allowed.indexOf(toState) === -1) {
                return { 
                    valid: false, 
                    message: fromState + ' „Åã„Çâ ' + toState + ' „Å∏„ÅÆÈÅ∑Áßª„ÅØË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì' 
                };
            }
            
            return { valid: true };
        }
    };

    function loadUserProfile() {
        try {
            var grProfile = new GlideRecord(CONFIG.tables.USER_PROFILE);
            grProfile.addQuery('user', data.user_id);
            grProfile.setLimit(1);
            grProfile.query();

            if (grProfile.next()) {
                data.emergency_email = grProfile.getValue('emergency_conact_email') || "";
                data.medical_info = grProfile.getValue('medical_conditions') || "";
                data.blood_type = grProfile.getValue('blood_type') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Profile load error: " + e.message);
        }
    }

    function loadDigitalWill() {
        try {
            var grWill = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
            grWill.addQuery('user', data.user_id);
            grWill.addQuery('is_active', true);
            grWill.addQuery('message_type', 'Last_Will');
            grWill.orderByDesc('sys_created_on');
            grWill.setLimit(1);
            grWill.query();

            if (grWill.next()) {
                data.saved_will = grWill.getValue('message_encrypted') || "";
            }
        } catch (e) {
            gs.error("[Kokoro] Will load error: " + e.message);
        }
    }

    loadUserProfile();
    loadDigitalWill();

    function buildTaskItem(gr) {
        var taskItem = {
            sys_id: gr.getUniqueValue(),
            number: gr.getValue('number') || '',
            category: gr.getValue('u_category') || '',
            category_display: gr.getDisplayValue('u_category') || 'Êú™ÂàÜÈ°û',
            zone: gr.getDisplayValue('shelter_zone') || '',
            detail_loc: gr.getValue('detail_loc') || gr.getValue('wish_content') || '',
            desc: gr.getValue('u_remarks') || '',
            urgency: gr.getValue('u_urgency') || 'Medium',
            contact: gr.getValue('u_contact_info') || '',
            reporter_name: gr.getDisplayValue('opened_by') || '„Ç≤„Çπ„Éà',
            assigned_to_name: gr.getDisplayValue('assigned_to') || '',
            assigned_to_id: gr.getValue('assigned_to') || '',
            state: parseInt(gr.getValue('state')) || 10,
            state_label: gr.getDisplayValue('state') || '',
            quantity: parseInt(gr.getValue('u_quantity')) || 1,
            location: gr.getValue('shelter_zone') || '',
            remarks: gr.getValue('u_remarks') || '',
            affected_count: gr.getValue('u_affected_count') || '‰∏çÊòé',
            history: [],
            attachments: []
        };

        var created = new GlideDateTime(gr.sys_created_on);
        var now = new GlideDateTime();
        var diffMs = GlideDateTime.subtract(now, created).getNumericValue();
        var minutes = Math.floor(diffMs / 1000 / 60);

        if (minutes < 60) {
            taskItem.time_ago = minutes + "ÂàÜÂâç";
        } else if (minutes < 1440) {
            taskItem.time_ago = Math.floor(minutes / 60) + "ÊôÇÈñìÂâç";
        } else {
            taskItem.time_ago = Math.floor(minutes / 1440) + "Êó•Ââç";
        }

        taskItem.created_on = gr.getDisplayValue('sys_created_on');

        var slaTarget = CONFIG.slaTargets[taskItem.urgency] || 180;
        var slaPercentage = Math.min((minutes / slaTarget) * 100, 100);
        var remainingMinutes = slaTarget - minutes;

        taskItem.sla = {
            elapsed: Math.floor(minutes),
            target: slaTarget,
            percentage: Math.round(slaPercentage),
            remaining: Math.floor(remainingMinutes),
            status: slaPercentage > 100 ? 'critical' : (slaPercentage > 80 ? 'warning' : 'ok')
        };

        try {
            var att = new GlideRecord('sys_attachment');
            att.addQuery('table_sys_id', taskItem.sys_id);
            att.setLimit(1);
            att.orderByDesc('sys_created_on');
            att.query();
            if (att.next()) {
                taskItem.image_url = '/' + att.sys_id + '.iix';
            }
        } catch (e) {}

        try {
            var journal = new GlideRecord('sys_journal_field');
            journal.addQuery('element_id', taskItem.sys_id);
            journal.addQuery('element', 'work_notes');
            journal.orderByDesc('sys_created_on');
            journal.setLimit(10);
            journal.query();
            while (journal.next()) {
                taskItem.history.push({
                    user: journal.getDisplayValue('sys_created_by') || 'System',
                    text: journal.getValue('value') || '',
                    date: journal.getDisplayValue('sys_created_on')
                });
            }
        } catch (e) {}

        return taskItem;
    }

    function loadVolunteerList() {
        var volunteerList = [];
        try {
            var roleGr = new GlideRecord('sys_user_has_role');
            roleGr.addQuery('role.name', 'x_1821654_kokoro_0.volunteer');
            roleGr.query();
            var volIds = [];
            while (roleGr.next()) {
                volIds.push(roleGr.getValue('user'));
            }
            
            if (volIds.length > 0) {
                var userGr = new GlideRecord('sys_user');
                userGr.addQuery('sys_id', 'IN', volIds.join(','));
                userGr.addQuery('active', true);
                userGr.query();
                while (userGr.next()) {
                    volunteerList.push({
                        sys_id: userGr.getUniqueValue(),
                        name: userGr.getDisplayValue('name') || userGr.getValue('user_name')
                    });
                }
            }
            
            var adminGr = new GlideRecord('sys_user');
            adminGr.addQuery('active', true);
            adminGr.addQuery('roles', 'CONTAINS', 'admin');
            adminGr.setLimit(10);
            adminGr.query();
            while (adminGr.next()) {
                var alreadyExists = volunteerList.some(function(v) { 
                    return v.sys_id === adminGr.getUniqueValue(); 
                });
                if (!alreadyExists) {
                    volunteerList.push({
                        sys_id: adminGr.getUniqueValue(),
                        name: adminGr.getDisplayValue('name') || adminGr.getValue('user_name')
                    });
                }
            }
        } catch (e) {
            gs.error("[Kokoro] Load volunteer list error: " + e.message);
        }
        return volunteerList;
    }

    if (input) {

        if (input.action === 'get_volunteers') {
            data.volunteers = loadVolunteerList();
            data.success = true;
            return;
        }

        if (input.action === 'save_settings') {
            try {
                var successProfile = false;
                var successWill = true;

                var grUp = new GlideRecord(CONFIG.tables.USER_PROFILE);
                grUp.addQuery('user', data.user_id);
                grUp.query();

                if (grUp.next()) {
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.update() != null);
                } else {
                    grUp.initialize();
                    grUp.setValue('user', data.user_id);
                    grUp.setValue('emergency_conact_email', sanitizeInput(input.email, 100));
                    grUp.setValue('medical_conditions', sanitizeInput(input.medical_info, 1000));
                    grUp.setValue('blood_type', sanitizeInput(input.blood_type, 20));
                    successProfile = (grUp.insert() != null);
                }

                if (input.will && String(input.will).trim() !== '') {
                    var oldMsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldMsg.addQuery('user', data.user_id);
                    oldMsg.addQuery('is_active', true);
                    oldMsg.addQuery('message_type', 'Last_Will');
                    oldMsg.query();
                    while (oldMsg.next()) {
                        oldMsg.setValue('is_active', false);
                        oldMsg.update();
                    }

                    var emsg = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsg.initialize();
                    emsg.setValue('user', data.user_id);
                    emsg.setValue('message_encrypted', sanitizeInput(input.will, 4000));
                    emsg.setValue('message_type', 'Last_Will');
                    emsg.setValue('is_active', true);
                    emsg.setValue('created_at', new GlideDateTime());
                    successWill = (emsg.insert() != null);
                }

                if (successProfile && successWill) {
                    data.success = true;
                    logProcessEvent(data.user_id, 'User settings updated', data.user_id);
                } else {
                    data.error = "‰øùÂ≠òÂ§±Êïó";
                }

            } catch (e) {
                gs.error("[Kokoro] Save error: " + e.message);
                data.error = "‰øùÂ≠ò„Ç®„É©„Éº";
            }
            return;
        }

        if (input.action === 'submit_record' || input.action === 'update_record') {
            if (!input.location || !input.category || !input.urgency) {
                data.error = "ÂøÖÈ†àÈ†ÖÁõÆ„Åå‰∏çË∂≥";
                return;
            }

            try {
                var gr = new GlideRecord(CONFIG.tables.SILENT_WISH);

                if (input.action === 'update_record' && input.sys_id) {
                    if (!validateSysId(input.sys_id)) {
                        data.error = "ÁÑ°Âäπ„Å™ID";
                        return;
                    }
                    if (!gr.get(input.sys_id)) {
                        data.error = "„É¨„Ç≥„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì";
                        return;
                    }
                } else {
                    gr.initialize();
                    gr.setValue('opened_by', data.user_id);
                    gr.setValue('state', CONFIG.wishStates.SUBMITTED);
                }

                gr.setValue('shelter_zone', sanitizeInput(input.location, 100));
                gr.setValue('u_category', sanitizeInput(input.category, 50));
                gr.setValue('u_quantity', parseInt(input.quantity) || 1);
                gr.setValue('u_urgency', sanitizeInput(input.urgency, 20));
                gr.setValue('u_affected_count', sanitizeInput(input.affected_count, 10));
                gr.setValue('u_remarks', sanitizeInput(input.remarks, 1000));
                gr.setValue('u_contact_info', sanitizeInput(input.contact, 200));
                gr.setValue('detail_loc', sanitizeInput(input.detail_loc, 200));

                var fullDescription =
                    "„ÄêË©≥Á¥∞Â†¥ÊâÄ„Äë: " + sanitizeInput(input.detail_loc, 200) + "\n" +
                    "„ÄêÊîØÊè¥Á®ÆÂà•„Äë: " + input.category + " x " + (input.quantity || 1) + "\n" +
                    "„ÄêÁ∑äÊÄ•Â∫¶„Äë: " + input.urgency + "\n" +
                    "„ÄêÂØæË±°‰∫∫Êï∞„Äë: " + (input.affected_count || '1') + "\n" +
                    "„ÄêÂÇôËÄÉ„Äë: " + (input.remarks || '„Å™„Åó');

                gr.setValue('wish_content', fullDescription);

                if (input.action === 'submit_record') {
                    var sysId = gr.insert();
                    if (sysId) {
                        data.ticketNumber = gr.getValue('number');
                        data.newRecordID = sysId;
                        data.success = true;
                        logProcessEvent(sysId, 'Wish submitted: ' + input.category, data.user_id);
                    } else {
                        data.error = "‰ΩúÊàêÂ§±Êïó";
                    }
                } else {
                    if (gr.update()) {
                        data.ticketNumber = gr.getValue('number');
                        data.success = true;
                        logProcessEvent(input.sys_id, 'Wish updated', data.user_id);
                    } else {
                        data.error = "Êõ¥Êñ∞Â§±Êïó";
                    }
                }
            } catch (e) {
                gs.error("[Kokoro] Submit error: " + e.message);
                data.error = "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü";
            }
            return;
        }

        if (input.action === 'upload_attachment' && input.sys_id) {
            try {
                if (!validateSysId(input.sys_id)) {
                    data.error = "ÁÑ°Âäπ„Å™ID";
                    return;
                }
                var attachment = new GlideSysAttachment();
                if (input.file_data) {
                    var cleanBase64 = input.file_data.split(',')[1] || input.file_data;
                    attachment.writeBase64(
                        input.table || CONFIG.tables.SILENT_WISH,
                        input.sys_id,
                        sanitizeInput(input.file_name, 100),
                        input.content_type,
                        cleanBase64
                    );
                    data.success = true;
                }
            } catch (e) {
                gs.error("[Kokoro] Attachment error: " + e.message);
            }
            return;
        }

        if (input.action === 'register_heartbeat') {
            try {
                var hb = new GlideRecord(CONFIG.tables.HEARTBEAT);
                hb.initialize();
                hb.setValue('u_user', data.user_id);
                hb.setValue('u_timestamp', new GlideDateTime());
                hb.setValue('u_status', 'Safe');

                var hbId = hb.insert();
                data.heartbeat_id = hbId;
                data.success = true;
                logProcessEvent(hbId, 'Heartbeat registered', data.user_id);
            } catch (e) {
                gs.error("[Kokoro] Heartbeat error: " + e.message);
                data.error = "ÂøÉË∑≥Ê≥®ÂÜåÂ§±Ë¥•";
            }
            return;
        }

        if (input.action === 'update_will') {
            try {
                if (input.message) {
                    var oldQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    oldQuick.addQuery('user', data.user_id);
                    oldQuick.addQuery('is_active', true);
                    oldQuick.addQuery('message_type', 'Quick_Will');
                    oldQuick.query();
                    while (oldQuick.next()) {
                        oldQuick.setValue('is_active', false);
                        oldQuick.update();
                    }

                    var emsgQuick = new GlideRecord(CONFIG.tables.EMERGENCY_MESSAGE);
                    emsgQuick.initialize();
                    emsgQuick.setValue('user', data.user_id);
                    emsgQuick.setValue('message_encrypted', sanitizeInput(input.message, 4000));
                    emsgQuick.setValue('message_type', 'Quick_Will');
                    emsgQuick.setValue('is_active', true);
                    emsgQuick.setValue('created_at', new GlideDateTime());

                    if (emsgQuick.insert()) {
                        data.success = true;
                    }
                }
            } catch (e) {
                gs.error("[Kokoro] Quick will error: " + e.message);
            }
            return;
        }

        if (input.sys_id) {
            if (!validateSysId(input.sys_id)) {
                data.error = "ÁÑ°Âäπ„Å™ID";
                return;
            }

            var taskGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            if (!taskGr.get(input.sys_id)) {
                data.error = "„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì";
                return;
            }

            var currentState = String(taskGr.getValue('state') || '10');

            if (input.action === 'assign_to_me') {
                if (!isVolunteer) {
                    data.error = "„Éú„É©„É≥„ÉÜ„Ç£„Ç¢Ê®©Èôê„ÅåÂøÖË¶Å„Åß„Åô";
                    return;
                }

                taskGr.setValue('assigned_to', data.user_id);
                
                if (currentState === '1' || currentState === '10') {
                    var validationAssign = StateValidator.validateTransition(currentState, '11');
                    if (validationAssign.valid) {
                        taskGr.setValue('state', '11');
                    }
                }
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + data.user_name, data.user_id);
                } else {
                    data.error = "Êõ¥Êñ∞Â§±Êïó";
                }
                return;
            }

            if (input.action === 'assign_to' && input.assignee_id) {
                if (!isVolunteer) {
                    data.error = "„Éú„É©„É≥„ÉÜ„Ç£„Ç¢Ê®©Èôê„ÅåÂøÖË¶Å„Åß„Åô";
                    return;
                }

                taskGr.setValue('assigned_to', input.assignee_id);
                
                if (currentState === '1' || currentState === '10') {
                    var validationAssignTo = StateValidator.validateTransition(currentState, '11');
                    if (validationAssignTo.valid) {
                        taskGr.setValue('state', '11');
                    }
                }
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task assigned to ' + input.assignee_id, data.user_id);
                } else {
                    data.error = "Êõ¥Êñ∞Â§±Êïó";
                }
                return;
            }

            if (input.action === 'change_status' && input.new_state) {
                var newState = String(input.new_state);
                var validationChange = StateValidator.validateTransition(currentState, newState);
                
                if (!validationChange.valid) {
                    data.error = validationChange.message;
                    return;
                }

                if ((newState === '2' || newState === '4') && taskGr.assigned_to.nil()) {
                    data.error = "ÂÖà„Å´ÊãÖÂΩìËÄÖ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
                    return;
                }

                taskGr.setValue('state', newState);
                
                if (newState === '4') {
                    taskGr.setValue('u_completed_at', new GlideDateTime());
                }
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Status changed to ' + newState, data.user_id);
                } else {
                    data.error = "Êõ¥Êñ∞Â§±Êïó";
                }
                return;
            }

            if (input.action === 'start') {
                var validationStart = StateValidator.validateTransition(currentState, '2');
                if (!validationStart.valid) {
                    data.error = validationStart.message;
                    return;
                }

                if (taskGr.getValue('assigned_to') != data.user_id && !gs.hasRole('admin')) {
                    data.error = "Ëá™ÂàÜ„Å´ÊãÖÂΩì„Åï„Çå„Åü„Çø„Çπ„ÇØ„ÅÆ„ÅøÈñãÂßã„Åß„Åç„Åæ„Åô";
                    return;
                }

                taskGr.setValue('state', '2');
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task started', data.user_id);
                } else {
                    data.error = "Êõ¥Êñ∞Â§±Êïó";
                }
                return;
            }

            if (input.action === 'complete') {
                var validationComplete = StateValidator.validateTransition(currentState, '4');
                if (!validationComplete.valid) {
                    data.error = validationComplete.message;
                    return;
                }

                taskGr.setValue('state', '4');
                taskGr.setValue('u_completed_at', new GlideDateTime());
                
                if (taskGr.update()) {
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Task completed', data.user_id);
                } else {
                    data.error = "Êõ¥Êñ∞Â§±Êïó";
                }
                return;
            }

            if (input.action === 'add_comment' && input.message) {
                try {
                    taskGr.work_notes = sanitizeInput(input.message, 1000);
                    taskGr.update();
                    data.success = true;
                    logProcessEvent(input.sys_id, 'Comment added', data.user_id);
                } catch (e) {
                    data.error = "„Ç≥„É°„É≥„ÉàËøΩÂä†Â§±Êïó";
                }
                return;
            }
        }
    }

    if (isVolunteer) {
        try {
            var myGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            myGr.addQuery('assigned_to', data.user_id);
            myGr.orderByDesc('sys_updated_on');
            myGr.setLimit(50);
            myGr.query();
            while (myGr.next()) {
                data.myTasks.push(buildTaskItem(myGr));
            }
        } catch (e) {
            gs.error("[Kokoro] My tasks load error: " + e.message);
        }

        try {
            var allGr = new GlideRecord(CONFIG.tables.SILENT_WISH);
            allGr.orderByDesc('sys_created_on');
            allGr.setLimit(100);
            allGr.query();
            while (allGr.next()) {
                data.list.push(buildTaskItem(allGr));
            }
        } catch (e) {
            gs.error("[Kokoro] All tasks load error: " + e.message);
        }

        try {
            var gaOpen = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaOpen.addNullQuery('assigned_to');
            gaOpen.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaOpen.addAggregate('COUNT');
            gaOpen.query();
            if (gaOpen.next()) {
                data.openCount = parseInt(gaOpen.getAggregate('COUNT')) || 0;
            }

            var gaSOS = new GlideAggregate(CONFIG.tables.SILENT_WISH);
            gaSOS.addQuery('u_urgency', 'Critical');
            gaSOS.addQuery('state', 'NOT IN', [CONFIG.wishStates.COMPLETED, CONFIG.wishStates.CANCELLED]);
            gaSOS.addAggregate('COUNT');
            gaSOS.query();
            if (gaSOS.next()) {
                data.sosCount = parseInt(gaSOS.getAggregate('COUNT')) || 0;
            }
        } catch (e) {
            gs.error("[Kokoro] Stats error: " + e.message);
        }

        data.volunteers = loadVolunteerList();
    }

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-29 07:47:06</sys_created_on>
        <sys_id>05ec022e83c2f210f6b1fb96feaad3a5</sys_id>
        <sys_mod_count>246</sys_mod_count>
        <sys_name>Kokoro Interaction</sys_name>
        <sys_package display_value="Kokoro Shelter" source="x_1821654_kokoro_0">80ba4d9583863210f6b1fb96feaad3b2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Kokoro Shelter">80ba4d9583863210f6b1fb96feaad3b2</sys_scope>
        <sys_update_name>sp_widget_05ec022e83c2f210f6b1fb96feaad3a5</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-27 05:47:55</sys_updated_on>
        <template><![CDATA[<div class="kokoro-app-container">

  <!-- ============================================
       ÂøóÊÑøËÄÖÊ®°Âºè - KOKORO COMMAND INTERFACE
       ============================================ -->
  <div class="volunteer-app" ng-if="c.mode === 'volunteer'">
    
    <div class="safety-banner">
      <div><i class="fa fa-exclamation-triangle"></i> ALERT: ÁèæÂú®„ÄÅ‰ΩôÈúáË≠¶Â†±Áô∫‰ª§‰∏≠„ÄÇÂÆâÂÖ®„ÇíÁ¢∫‰øù„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
      <button ng-click="c.mode='refugee'">
        <i class="fa fa-mobile"></i> USER_VIEW
      </button>
    </div>

    <!-- Command Header -->
    <div class="command-header">
      <div class="command-logo">
        <div class="logo-icon">K</div>
        <div class="logo-text">
          <span class="logo-title">KOKORO</span>
          <span class="logo-subtitle">COMMAND_INTERFACE</span>
        </div>
      </div>
      <div class="system-status">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span class="status-text">SYS_ONLINE</span>
        </div>
        <span class="version-tag">v2.4.1-stable</span>
        <span class="system-time" id="systemTime">{{c.currentTime}}</span>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <div class="tab" ng-class="{'active': c.view === 'dashboard'}" ng-click="c.view = 'dashboard'">
        <span class="tab-number">01</span> / OVERVIEW
      </div>
      <div class="tab" ng-class="{'active': c.view === 'tactical'}" ng-click="c.view = 'tactical'">
        <span class="tab-number">02</span> / TACTICAL
      </div>
      <div class="tab" ng-class="{'active': c.view === 'mine'}" ng-click="c.view = 'mine'">
        <span class="tab-number">03</span> / OPERATORS ({{c.data.myTasks.length}})
      </div>
    </div>

    <!-- Scan Line -->
    <div class="scan-line-header">
      <div class="scan-line"></div>
      <span class="scan-label">DISASTER_RESPONSE_SYSTEM</span>
      <div class="scan-line"></div>
    </div>

    <div class="board-container">
      
      <!-- OVERVIEW VIEW -->
      <div class="view-dashboard" ng-if="c.view === 'dashboard' || c.view === 'tactical'">
        
        <!-- Metrics Overview Section -->
        <div class="stats-section">
          <div class="section-header">
            <span class="section-tag">01</span>
            <span class="section-title">METRICS_OVERVIEW</span>
            <span class="section-time">{{c.currentTime}}</span>
          </div>
          
          <div class="stats-row">
            <div class="stat-card clickable" ng-click="c.filterByUrgency('Critical')">
              <div class="stat-label">
                <span class="stat-code">REQ</span>
                <span class="stat-suffix">_01</span>
              </div>
              <div class="stat-num">{{c.data.sosCount}}</div>
              <div class="stat-name">CRITICAL_SOS</div>
              <div class="stat-footer">
                <span class="stat-change negative" ng-if="c.data.sosCount > 0">URGENT</span>
                <span class="stat-change positive" ng-if="c.data.sosCount === 0">CLEAR</span>
                <span class="stat-status" ng-class="{'critical': c.data.sosCount > 0, 'nominal': c.data.sosCount === 0}">
                  {{c.data.sosCount > 0 ? 'ALERT' : 'NOMINAL'}}
                </span>
              </div>
            </div>
            
            <div class="stat-card clickable" ng-click="c.filterByAssignment('unassigned')">
              <div class="stat-label">
                <span class="stat-code">OPN</span>
                <span class="stat-suffix">_02</span>
              </div>
              <div class="stat-num">{{c.data.openCount}}</div>
              <div class="stat-name">UNASSIGNED_REQUESTS</div>
              <div class="stat-footer">
                <span class="stat-change" ng-class="{'negative': c.data.openCount > 5, 'positive': c.data.openCount <= 5}">
                  {{c.data.openCount > 5 ? 'HIGH' : 'NORMAL'}}
                </span>
                <span class="stat-status" ng-class="{'warning': c.data.openCount > 5, 'nominal': c.data.openCount <= 5}">
                  {{c.data.openCount > 5 ? 'BACKLOG' : 'NOMINAL'}}
                </span>
              </div>
            </div>
            
            <div class="stat-card clickable" ng-click="c.clearFilters()">
              <div class="stat-label">
                <span class="stat-code">TOT</span>
                <span class="stat-suffix">_03</span>
              </div>
              <div class="stat-num">{{c.data.list.length}}</div>
              <div class="stat-name">TOTAL_ACTIVE</div>
              <div class="stat-footer">
                <span class="stat-change positive">TRACKED</span>
                <span class="stat-status nominal">[NOMINAL]</span>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-label">
                <span class="stat-code">OPR</span>
                <span class="stat-suffix">_04</span>
              </div>
              <div class="stat-num">{{c.data.volunteers.length || '--'}}</div>
              <div class="stat-name">ACTIVE_OPERATORS</div>
              <div class="stat-footer">
                <span class="stat-change positive">ONLINE</span>
                <span class="stat-status nominal">[NOMINAL]</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Two Column Layout -->
        <div class="two-column-layout">
          
          <!-- Alert Feed -->
          <div class="alert-section">
            <div class="section-header">
              <span class="section-tag">02</span>
              <span class="section-title">ALERT_FEED</span>
              <span class="section-tag" style="margin-left:auto; background:transparent; border:1px solid var(--border-color); color:var(--text-muted);">
                {{(c.filteredList || c.data.list).length}}
              </span>
            </div>
            
            <div class="alert-list">
              <div class="alert-item" ng-class="'priority-' + item.urgency" 
                   ng-repeat="item in (c.filteredList || c.data.list) | limitTo:20" 
                   ng-click="c.openModal(item)">
                <span class="alert-id">{{item.number | limitTo:10}}</span>
                <span class="alert-priority" ng-class="{
                  'p-critical': item.urgency === 'Critical',
                  'p-high': item.urgency === 'High',
                  'p-medium': item.urgency === 'Medium',
                  'p-low': item.urgency === 'Low'
                }">P{{item.urgency === 'Critical' ? '1' : item.urgency === 'High' ? '2' : item.urgency === 'Medium' ? '3' : '4'}}_{{item.urgency | uppercase | limitTo:4}}</span>
                <span class="alert-zone">{{item.zone | limitTo:6}}</span>
                <span class="alert-time">{{item.time_ago}}</span>
                <span class="alert-content">{{c.dict[item.category] || item.category}} x{{item.quantity}} - {{item.detail_loc | limitTo:30}}</span>
                <span class="alert-arrow">&rarr;</span>
              </div>

              <div class="empty-board" ng-if="!(c.filteredList || c.data.list) || (c.filteredList || c.data.list).length === 0">
                <i class="fa fa-check-circle"></i>
                <h4>ALL_CLEAR</h4>
                <p>ÁèæÂú®„ÄÅÂæÖÊ©ü‰∏≠„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
              </div>
            </div>
          </div>

          <!-- Resource Status -->
          <div class="resource-section">
            <div class="section-header">
              <span class="section-tag">03</span>
              <span class="section-title">RESOURCE_STATUS</span>
            </div>
            
            <div class="resource-list">
              <div class="resource-item">
                <div class="resource-header">
                  <span class="resource-tag">[FOOD]</span>
                  <span class="resource-name">È£üÊñô</span>
                  <span class="resource-percent">{{c.data.resources.food || 42}}%</span>
                </div>
                <div class="resource-bar">
                  <div class="resource-fill" ng-class="{'low': (c.data.resources.food || 42) < 30, 'medium': (c.data.resources.food || 42) >= 30 && (c.data.resources.food || 42) < 60, 'high': (c.data.resources.food || 42) >= 60}" 
                       ng-style="{width: (c.data.resources.food || 42) + '%'}"></div>
                </div>
                <span class="resource-count">{{c.data.resources.foodCount || 420}} / 1000</span>
              </div>
              
              <div class="resource-item">
                <div class="resource-header">
                  <span class="resource-tag">[WATR]</span>
                  <span class="resource-name">È£≤ÊñôÊ∞¥</span>
                  <span class="resource-percent">{{c.data.resources.water || 78}}%</span>
                </div>
                <div class="resource-bar">
                  <div class="resource-fill high" ng-style="{width: (c.data.resources.water || 78) + '%'}"></div>
                </div>
                <span class="resource-count">{{c.data.resources.waterCount || 780}} / 1000</span>
              </div>
              
              <div class="resource-item">
                <div class="resource-header">
                  <span class="resource-tag">[MEDI]</span>
                  <span class="resource-name">ÂåªÁôÇÂìÅ</span>
                  <span class="resource-percent">{{c.data.resources.medical || 12}}%</span>
                </div>
                <div class="resource-bar">
                  <div class="resource-fill low" ng-style="{width: (c.data.resources.medical || 12) + '%'}"></div>
                </div>
                <span class="resource-count">{{c.data.resources.medicalCount || 120}} / 1000</span>
              </div>
              
              <div class="resource-item">
                <div class="resource-header">
                  <span class="resource-tag">[CLTH]</span>
                  <span class="resource-name">Ë°£È°û</span>
                  <span class="resource-percent">{{c.data.resources.clothing || 89}}%</span>
                </div>
                <div class="resource-bar">
                  <div class="resource-fill high" ng-style="{width: (c.data.resources.clothing || 89) + '%'}"></div>
                </div>
                <span class="resource-count">{{c.data.resources.clothingCount || 890}} / 1000</span>
              </div>
              
              <div class="resource-item">
                <div class="resource-header">
                  <span class="resource-tag">[HYGN]</span>
                  <span class="resource-name">Ë°õÁîüÁî®ÂìÅ</span>
                  <span class="resource-percent">{{c.data.resources.hygiene || 34}}%</span>
                </div>
                <div class="resource-bar">
                  <div class="resource-fill medium" ng-style="{width: (c.data.resources.hygiene || 34) + '%'}"></div>
                </div>
                <span class="resource-count">{{c.data.resources.hygieneCount || 340}} / 1000</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Card Grid Section -->
        <div class="card-section" ng-if="c.view === 'tactical'">
          <div class="section-header">
            <span class="section-tag">04</span>
            <span class="section-title">REQUEST_GRID</span>
            <span class="section-tag" style="margin-left:auto; background:transparent; border:1px solid var(--border-color); color:var(--text-muted);">
              {{(c.filteredList || c.data.list).length}} ITEMS
            </span>
          </div>
          
          <div class="card-grid">
            <div class="jira-card" ng-class="'priority-' + item.urgency" 
                 ng-repeat="item in (c.filteredList || c.data.list)" 
                 ng-click="c.openModal(item)">
              <div class="card-top">
                <span class="card-id">{{item.number}}</span>
                <span class="status-tag" ng-class="'status-' + item.state">
                  {{c.statusNames[item.state] || item.state_label || 'OPEN'}}
                </span>
              </div>
              
              <div class="card-title">
                {{c.dict[item.category] || item.category_display}}
                <span class="qty-badge">x{{item.quantity}}</span>
              </div>
              
              <div class="card-loc">
                <i class="fa fa-map-marker"></i> {{item.zone}} - {{item.detail_loc}}
              </div>
              
              <div class="card-detail" ng-if="item.remarks">
                {{item.remarks | limitTo:50}}{{item.remarks.length > 50 ? '...' : ''}}
              </div>
              
              <div class="card-footer">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <span class="priority-badge" ng-class="'priority-' + item.urgency">
                    <i class="fa fa-arrow-up" ng-if="item.urgency === 'Critical'"></i>
                    {{c.dict[item.urgency] || item.urgency}}
                  </span>
                  <span style="font-size:11px; color:var(--text-muted); font-family:'Orbitron',monospace;">
                    {{item.time_ago}}
                  </span>
                </div>
                <div style="margin-top:8px; font-size:11px; color:var(--text-secondary);">
                  <i class="fa fa-user"></i> 
                  {{item.assigned_to_name || 'UNASSIGNED'}}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MY TASKS VIEW -->
      <div class="view-mine" ng-if="c.view === 'mine'">
        <div class="card-section">
          <div class="section-header">
            <span class="section-tag">03</span>
            <span class="section-title">MY_OPERATIONS</span>
            <span class="section-tag" style="margin-left:auto; background:transparent; border:1px solid var(--border-color); color:var(--text-muted);">
              {{c.data.myTasks.length}} ACTIVE
            </span>
          </div>

          <div class="task-grid">
            <div class="jira-card" ng-class="'priority-' + task.urgency" ng-repeat="task in c.data.myTasks">
              <div class="card-top">
                <span class="card-id">{{task.number}}</span>
                <span class="status-tag" ng-class="'status-' + task.state">
                  {{c.statusNames[task.state] || task.state_label}}
                </span>
              </div>
              <div class="card-main">
                <div class="card-title">
                  {{c.dict[task.category] || task.category}}
                  <span class="qty-badge">x{{task.quantity}}</span>
                </div>
                <div class="card-loc">
                  <i class="fa fa-map-marker"></i> {{c.dict[task.location] || task.location}}
                </div>
                <div class="card-detail">
                  {{task.detail_loc || 'NO_DETAIL'}}
                </div>
              </div>
              
              <div class="card-footer">
                <button class="btn-jira progress" ng-if="task.state == 11" ng-click="c.updateStatus(task.sys_id, 'start')">
                  <i class="fa fa-play"></i> START_DELIVERY
                </button>
                
                <button class="btn-jira success" ng-if="task.state == 2" ng-click="c.updateStatus(task.sys_id, 'complete')">
                  <i class="fa fa-check"></i> MARK_COMPLETE
                </button>
                
                <div class="completed-msg" ng-if="task.state == 4" ng-click="c.openModal(task)">
                  <i class="fa fa-check-circle"></i> COMPLETED - VIEW_DETAILS
                </div>
              </div>
            </div>
            
            <div class="empty-board" ng-if="c.data.myTasks.length === 0" style="grid-column: 1 / -1;">
              <i class="fa fa-inbox"></i>
              <h4>NO_ACTIVE_OPERATIONS</h4>
              <p>OVERVIEW„Çø„Éñ„Åã„Çâ„Çø„Çπ„ÇØ„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>

  <!-- ============================================
       ÈÅøÈõ£ËÄÖ„É¢„Éº„Éâ - Kokoro World (Pink Theme)
       ============================================ -->
  <div class="kokoro-world" ng-if="c.mode === 'refugee'">
    
    <div class="safety-settings-btn" ng-click="c.toggleSettings()">
       <i class="fa fa-cog"></i> Ë®≠ÂÆö
    </div>
    
    <div class="debug-switch" ng-if="c.data.is_volunteer" ng-click="c.mode='volunteer'">
      <i class="fa fa-user-md"></i>
    </div>

    <!-- Ë®≠ÂÆö„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="settings-overlay" ng-if="c.showSettings">
      <div class="settings-card">
        <div class="card-header">
          <h3><i class="fa fa-cog"></i> ÂÆâÂÖ®Ë®≠ÂÆö</h3>
          <button class="close-btn" ng-click="c.toggleSettings()">&times;</button>
        </div>
        
        <div class="settings-desc">
          „Åì„Åì„ÅØ„ÅÇ„Å™„Åü„ÅÆ„ÄåÂëΩ„ÅÆ„Éñ„É©„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Äç„Åß„Åô„ÄÇ<br>
          ‰∏á‰∏Ä„ÅÆÈöõÔºà24ÊôÇÈñìÂøúÁ≠î„Å™„ÅóÔºâ„ÄÅ„Ç∑„Çπ„ÉÜ„É†„ÅåËá™ÂãïÁöÑ„Å´‰ΩøÁî®„Åô„ÇãÊÉÖÂ†±„ÇíÁôªÈå≤„Åó„Åæ„Åô„ÄÇ
        </div>

        <div class="input-group">
          <label><i class="fa fa-envelope" style="color:#ec407a;"></i> Á∑äÊÄ•ÈÄ£Áµ°ÂÖà (Email)</label>
          <input type="email" class="glass-input" ng-model="c.temp_settings.email" placeholder="‰æãÔºöpartner@example.com">
        </div>

        <div class="input-group">
          <label><i class="fa fa-tint" style="color:#e53935;"></i> Ë°ÄÊ∂≤Âûã (Blood Type)</label>
          <select class="glass-input" ng-model="c.temp_settings.blood_type">
            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ...</option>
            <option value="A+">AÂûã (+)</option>
            <option value="A-">AÂûã (-)</option>
            <option value="B+">BÂûã (+)</option>
            <option value="B-">BÂûã (-)</option>
            <option value="O+">OÂûã (+)</option>
            <option value="O-">OÂûã (-)</option>
            <option value="AB+">ABÂûã (+)</option>
            <option value="AB-">ABÂûã (-)</option>
          </select>
        </div>

        <div class="input-group">
          <label><i class="fa fa-medkit" style="color:#43a047;"></i> ÊåÅÁóÖ„ÉªÂåªÁôÇÊÉÖÂ†± (Medical Info)</label>
          <textarea class="glass-input" ng-model="c.temp_settings.medical_info" placeholder="‰æãÔºöÁ≥ñÂ∞øÁóÖ„ÄÅÈ´òË°ÄÂúß„ÄÅ„Ç¢„É¨„É´„ÇÆ„Éº„Å™„Å©..." rows="3"></textarea>
        </div>
        
        <div class="input-group">
          <label><i class="fa fa-pencil" style="color:#5c6bc0;"></i> „Åù„ÅÆ‰ªñ„ÅÆ‰ºùË®Ä (Digital Will)</label>
          <textarea class="glass-input" ng-model="c.temp_settings.will" placeholder="„Åù„ÅÆ‰ªñ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÔºàÈÅøÈõ£Â†¥ÊâÄ„ÅÆÂ∏åÊúõ„Å™„Å©Ôºâ..." rows="3"></textarea>
        </div>

        <button class="save-settings-btn" ng-click="c.saveSettings()">
           <span ng-if="!c.saving">Ë®≠ÂÆö„Çí‰øùÂ≠ò (Save)</span>
           <span ng-if="c.saving"><i class="fa fa-spinner fa-spin"></i> Saving...</span>
        </button>
      </div>
    </div>
    
    <!-- Ê®ôÈ°å -->
    <div class="pulse-overlay" ng-if="c.step === 0 && !c.show_will_input">
      <h2 class="pulse-title">
        ‰ªäÊó•„ÄÅÁÑ°‰∫ã„Åß„Åô„ÅãÔºü
        <span class="sub-text"><br>(Â§ß‰∏àÂ§´Ôºü„Åì„Åì„Çç„ÇíÁπã„ÅÑ„Åß„ÄÅÁÑ°‰∫ã„ÇíÁ¢∫Ë™ç„ÄÇ)</span>
      </h2>
    </div>

    <!-- Âè≤ËêäÂßÜ -->
    <div class="slime-stage-container" ng-if="c.step === 0">
      <div id="the-slime" class="kokoro-slime" 
           ng-class="{'happy-slime': c.step >= 1, 'hungry-slime': c.step === 0 && !c.is_poked, 'poked': c.is_poked}"
           ng-click="c.pokeSlime()">
        <div class="slime-eyes" ng-style="{'transform': 'translate(' + eyeX + 'px, ' + eyeY + 'px)'}"></div>
      </div>
    </div>

    <!-- ÈÅ∫Ë®ÄÂÖ•Âäõ -->
    <div class="will-overlay" ng-if="c.show_will_input">
      <div class="will-card">
        <h3 class="will-title"><i class="fa fa-heartbeat"></i> ÁîüÂ≠òÁ¢∫Ë™çÂÆå‰∫Ü</h3>
        <p class="will-desc">Kokoro„Åå„ÅÇ„Å™„Åü„ÅÆËÑàÂãï„ÇíÂèó„ÅëÂèñ„Çä„Åæ„Åó„Åü„ÄÇ<br>‰∏á‰∏Ä„Å´ÂÇô„Åà„ÄÅÊïëÂä©Èöä„Å∏„ÅÆ‰ºùË®Ä„ÇíÊÆã„Åó„Åæ„Åô„ÅãÔºü</p>
        <textarea class="will-textarea" ng-model="c.digital_will" placeholder="‰æãÔºö‰ΩìËÇ≤È§®„ÅÆ2ÈöéÂÄâÂ∫´„Å´„ÅÑ„Åæ„Åô„ÄÇÁ≥ñÂ∞øÁóÖ„ÅÆËñ¨„ÅåÂøÖË¶Å„Åß„Åô..."></textarea>
        <div class="will-actions">
          <button class="btn-will-skip" ng-click="c.finishHeartbeat(false)">‰ªä„ÅØ„Åó„Å™„ÅÑ</button>
          <button class="btn-will-save" ng-click="c.finishHeartbeat(true)">‰øùÂ≠ò„Åó„Å¶ÈÄ≤„ÇÄ</button>
        </div>
      </div>
    </div>

    <!-- „Éï„Ç©„Éº„É†„Ç≥„É≥„ÉÜ„Éä -->
    <div class="dialog-stage-container" ng-if="c.step > 0">
      <div class="floating-header" ng-if="c.step < 5">
        <h2 class="form-title"><i class="fa fa-heartbeat"></i> ÊîØÊè¥„É™„ÇØ„Ç®„Çπ„Éà</h2>
        <div class="progress-indicator">
          <span class="progress-step" ng-class="{'active': c.step >= 1}">1</span>
          <span class="progress-line" ng-class="{'active': c.step >= 2}"></span>
          <span class="progress-step" ng-class="{'active': c.step >= 2}">2</span>
          <span class="progress-line" ng-class="{'active': c.step >= 3}"></span>
          <span class="progress-step" ng-class="{'active': c.step >= 3}">3</span>
          <span class="progress-line" ng-class="{'active': c.step >= 4}"></span>
          <span class="progress-step" ng-class="{'active': c.step >= 4}">4</span>
        </div>
      </div>
      
      <div class="form-wrapper" ng-if="c.step < 5">
        <div class="step-card" ng-if="c.step >= 1">
          <label class="big-label">1. „ÅÑ„Çâ„Å£„Åó„ÇÉ„Çã„Ç®„É™„Ç¢</label>
          <div class="input-wrapper">
            <select class="big-input" ng-model="c.data.location" ng-change="c.onLocationChange()">
              <option value="" disabled selected>„Çø„ÉÉ„Éó„Åó„Å¶ÈÅ∏Êäû...</option>
              <option value="Family Area">„Éï„Ç°„Éü„É™„Éº„Ç®„É™„Ç¢ (ÂÆ∂Êóè)</option>
              <option value="Single Area">ÂçòË∫´„Ç®„É™„Ç¢ (‰∏Ä‰∫∫)</option>
              <option value="Medical Area">ÂåªÁôÇ„Éª„Ç±„Ç¢„Ç®„É™„Ç¢</option>
            </select>
            <i class="fa fa-chevron-down select-arrow"></i>
          </div>
        </div>

        <div class="step-card" ng-if="c.step >= 2">
          <label class="big-label">2. Ë©≥Á¥∞„Å™Â†¥ÊâÄ (ÈÉ®Â±ãÁï™Âè∑„Å™„Å©)</label>
          <input type="text" class="big-input" ng-model="c.data.detail_loc" placeholder="‰æãÔºö101Âè∑ÂÆ§„ÄÅ‰ΩìËÇ≤È§®„ÅÆÂè≥ÂÅ¥..." ng-change="c.checkDetail()">
        </div>

        <div class="step-card" ng-if="c.step >= 3">
          <label class="big-label">3. ÂøÖË¶Å„Å™ÊîØÊè¥</label>
          <div class="input-wrapper mb-3">
            <select class="big-input" ng-model="c.data.category" ng-change="c.checkInput()">
              <option value="" disabled selected>‰Ωï„ÅåÂøÖË¶Å„Åß„Åô„ÅãÔºü</option>
              <option value="Water">È£≤ÊñôÊ∞¥ (Water)</option>
              <option value="Food">È£üÊñô (Food)</option>
              <option value="Medical">ÂåªÁôÇ„ÉªËñ¨ (Medical)</option>
              <option value="Baby">‰π≥ÂπºÂÖêÁî®ÂìÅ (Baby)</option>
              <option value="Power">ÈõªÊ∫ê„ÉªÂÖÖÈõª (Power)</option>
              <option value="Other">„Åù„ÅÆ‰ªñ (Other)</option>
            </select>
            <i class="fa fa-chevron-down select-arrow"></i>
          </div>
          <div class="flex-row">
            <div class="half-col">
              <input type="number" class="big-input" ng-model="c.data.quantity" placeholder="Êï∞Èáè" ng-change="c.checkInput()" style="text-align:center;">
            </div>
            <div class="half-col input-wrapper">
                <select class="big-input" ng-model="c.data.affected_count" ng-change="c.checkInput()" style="text-align:center;">
                <option value="" disabled selected>‰∫∫Êï∞</option>
                <option value="1">1‰∫∫</option>
                <option value="2-4">2-4‰∫∫</option>
                <option value="5+">5‰∫∫+</option>
              </select>
            </div>
          </div>
          <div class="input-wrapper mb-3">
            <select class="big-input" ng-model="c.data.urgency" ng-change="c.checkInput()" ng-class="{'critical-bg': c.data.urgency === 'Critical'}">
              <option value="" disabled selected>Á∑äÊÄ•Â∫¶„ÅØÔºü</option>
              <option value="Low">ÊÄ•„Åé„Åæ„Åõ„Çì</option>
              <option value="Medium">ÊôÆÈÄö („Å™„Çã„Åπ„ÅèÊó©„Åè)</option>
              <option value="High">Âõ∞„Å£„Å¶„ÅÑ„Åæ„Åô (Êó©ÊÄ•„Å´)</option>
              <option value="Critical">ÈôêÁïå„Åß„Åô/‰ªä„Åô„Åê</option>
            </select>
            <i class="fa fa-chevron-down select-arrow"></i>
          </div>
          <textarea class="glass-textarea" ng-model="c.data.remarks" placeholder="ÂÇôËÄÉ („Ç¢„É¨„É´„ÇÆ„Éº„Å™„Å©)..."></textarea>
        </div>
        
        <div ng-if="c.fileData" style="text-align: center; margin-bottom: 25px;">
           <div style="position: relative; display: inline-block;">
             <img ng-src="{{c.fileData}}" style="height: 160px; border-radius: 16px; border: 4px solid #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.15);" />
             <div ng-click="c.clearFile()" style="position: absolute; top: -12px; right: -12px; background: #ff5252; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; border: 3px solid #fff;">
                 <i class="fa fa-times" style="font-size:18px;"></i>
             </div>
           </div>
           <div style="color: #43a047; font-weight: 800; font-size: 0.9rem; margin-top: 10px;">ÂÜôÁúü„ÅåÊ∑ª‰ªò„Åï„Çå„Åæ„Åó„Åü</div>
        </div>
        <div class="action-row" ng-if="c.step >= 4">
          <label class="big-attach-btn">
            <input type="file" style="display: none;" onchange="angular.element(this).scope().c.uploadFiles(this.files)"/>
            <i class="fa fa-camera"></i>
          </label>
          <button class="big-submit-btn" ng-click="c.submitWish()">
            <span ng-if="!c.is_editing && !c.submitting">È°ò„ÅÑ„ÇíÈÄÅ„Çã</span>
            <span ng-if="c.is_editing && !c.submitting">ÂÜÖÂÆπ„ÇíÊõ¥Êñ∞</span>
            <span ng-if="c.submitting"><i class="fa fa-spinner fa-spin"></i> ÈÄÅ‰ø°‰∏≠...</span>
          </button>
        </div>
      </div>

      <!-- ÊàêÂäü„Ç´„Éº„Éâ -->
      <div class="success-card" ng-if="c.step === 5">
        <div class="status-tracker">
          <div class="status-step" ng-class="{'active': c.current_state_val >= 1}"><div class="icon">]]>üì®<![CDATA[</div><div class="text">ÊèêÂá∫</div></div>
          <div class="line" ng-class="{'active': c.current_state_val >= 10}"></div>
          <div class="status-step" ng-class="{'active': c.current_state_val >= 10}"><div class="icon">]]>üëÄ<![CDATA[</div><div class="text">Á¢∫Ë™ç</div></div>
          <div class="line" ng-class="{'active': c.current_state_val >= 11}"></div>
          <div class="status-step" ng-class="{'active': c.current_state_val >= 11}"><div class="icon">]]>üôã<![CDATA[</div><div class="text">ÊãÖÂΩì</div></div>
          <div class="line" ng-class="{'active': c.current_state_val >= 2}"></div>
          <div class="status-step" ng-class="{'active': c.current_state_val >= 2}"><div class="icon">]]>üèÉ<![CDATA[</div><div class="text">ÈÖçÈÄÅ</div></div>
          <div class="line" ng-class="{'active': c.current_state_val >= 4}"></div>
          <div class="status-step" ng-class="{'active': c.current_state_val >= 4}"><div class="icon">‚úÖ</div><div class="text">ÂÆå‰∫Ü</div></div>
        </div>
        
        <h2 class="success-title">ÊâøÁü•„ÅÑ„Åü„Åó„Åæ„Åó„Åü</h2>
        <p class="ticket-id">ID: {{c.ticket_number}}</p>
        
        <div class="summary-card">
          <div class="row-item"><strong>Â†¥ÊâÄ:</strong> {{c.dict[c.data.location]}} - {{c.data.detail_loc}}</div>
          <div class="row-item"><strong>ÂÜÖÂÆπ:</strong> {{c.dict[c.data.category]}} <span class="badge">x{{c.data.quantity}}</span></div>
          <div class="row-item"><strong>Á∑äÊÄ•Â∫¶:</strong> <span ng-class="{'text-crit': c.data.urgency==='Critical'}">{{c.dict[c.data.urgency]}}</span></div>
          <div class="row-item" ng-if="c.data.remarks"><small style="color:#888;">{{c.data.remarks}}</small></div>
        </div>

        <div class="live-status-pill"><span class="pulse-dot"></span> {{c.status_message}}</div>

        <div class="status-detail-card" ng-if="c.statusDetails[c.current_state_val]">
            <div class="status-header">
                <span class="status-icon">{{c.statusDetails[c.current_state_val].icon}}</span>
                <h3 class="status-title">{{c.statusDetails[c.current_state_val].title}}</h3>
            </div>
            <p class="status-desc">{{c.statusDetails[c.current_state_val].desc}}</p>
            <p class="status-next">Ê¨°: {{c.statusDetails[c.current_state_val].nextStep}}</p>
        </div>

        <div class="btn-group">
          <button class="edit-btn" ng-click="c.editMode()" ng-if="c.current_state_val === 1 || c.current_state_val === 10">‰øÆÊ≠£„Åô„Çã</button>
          <button class="big-reset-btn" ng-click="c.reset()">Êñ∞„Åó„ÅÑ„É™„ÇØ„Ç®„Çπ„Éà</button>
        </div>
      </div>
    </div>
  </div>

  <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
  <div ng-if="c.submitting" class="loading-overlay">
    <div class="loading-content">
      <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
      <p>ÈÄÅ‰ø°‰∏≠...</p>
      <small>„Éá„Éº„Çø„ÇíÊöóÂè∑Âåñ„Åó„Å¶Ëª¢ÈÄÅ„Åó„Å¶„ÅÑ„Åæ„Åô</small>
    </div>
  </div>
</div>

<!-- ============================================
     JIRAÈ¢® Modal „ÉÜ„É≥„Éó„É¨„Éº„Éà (White Industrial)
     ============================================ -->
<script type="text/ng-template" id="modalTemplate">
  <div class="modal-content">
    
    <div class="kokoro-modal-header">
       <div class="modal-header-left">
          <span class="modal-ticket-type">
            <i class="fa fa-ambulance"></i> RESCUE_REQUEST
          </span>
          <span class="modal-ticket-id">{{item.number}}</span>
       </div>
       <div class="modal-header-right">
          <button type="button" class="modal-close-btn" ng-click="cancel()">
            <i class="fa fa-times"></i>
          </button>
       </div>
    </div>

    <div class="modal-body kokoro-modal-body">
      <div class="jira-layout-container">
        
        <div class="jira-main-column">
           
           <h1 class="issue-title">
              {{c.dict[item.category] || item.category_display || 'Áâ©Ë≥áÊîØÊè¥'}}„ÅÆÊïëÊè¥Ë¶ÅË´ã
              <span class="qty-badge-lg">x{{item.quantity}}</span>
           </h1>

           <div class="action-buttons-row">
              <div class="jira-dropdown" ng-class="{'open': showStatusDropdown}">
                <button class="jira-dropdown-toggle status-btn" 
                        ng-class="'status-bg-' + item.state"
                        ng-click="showStatusDropdown = !showStatusDropdown; showAssigneeDropdown = false;">
                  {{c.statusNames[item.state] || 'OPEN'}}
                  <i class="fa fa-chevron-down"></i>
                </button>
                <div class="jira-dropdown-menu" ng-show="showStatusDropdown">
                  <div class="dropdown-item" ng-click="changeStatus(item, '10'); showStatusDropdown=false" 
                       ng-if="item.state != 10 && item.state != 4 && item.state != 5">
                    <i class="fa fa-inbox"></i> SUBMITTED
                  </div>
                  <div class="dropdown-item" ng-click="changeStatus(item, '11'); showStatusDropdown=false"
                       ng-if="item.state != 11 && item.state != 4 && item.state != 5">
                    <i class="fa fa-user-plus"></i> ASSIGNED
                  </div>
                  <div class="dropdown-item" ng-click="changeStatus(item, '2'); showStatusDropdown=false"
                       ng-if="item.state == 11">
                    <i class="fa fa-bicycle"></i> IN_PROGRESS
                  </div>
                  <div class="dropdown-item" ng-click="changeStatus(item, '4'); showStatusDropdown=false"
                       ng-if="item.state == 2">
                    <i class="fa fa-check"></i> COMPLETED
                  </div>
                  <div class="dropdown-item text-danger" ng-click="changeStatus(item, '5'); showStatusDropdown=false"
                       ng-if="item.state != 4 && item.state != 5">
                    <i class="fa fa-ban"></i> CANCELLED
                  </div>
                </div>
              </div>

              <div class="jira-dropdown" ng-class="{'open': showAssigneeDropdown}">
                <button class="jira-dropdown-toggle assignee-btn" 
                        ng-click="showAssigneeDropdown = !showAssigneeDropdown; showStatusDropdown = false;"
                        ng-disabled="item.state == 4 || item.state == 5">
                  <i class="fa fa-user"></i>
                  {{item.assigned_to_name || 'SELECT_OPERATOR'}}
                  <i class="fa fa-chevron-down"></i>
                </button>
                <div class="jira-dropdown-menu" ng-show="showAssigneeDropdown">
                  <div class="dropdown-item highlight" ng-click="assignToMe(item); showAssigneeDropdown=false">
                    <i class="fa fa-hand-paper-o"></i> ASSIGN_TO_ME
                  </div>
                  <div class="dropdown-divider"></div>
                  <div class="dropdown-item" ng-repeat="vol in c.data.volunteers" 
                       ng-click="assignTo(item, vol.sys_id, vol.name); showAssigneeDropdown=false">
                    <div class="assignee-avatar">{{vol.name.charAt(0)}}</div>
                    {{vol.name}}
                  </div>
                  <div class="dropdown-item text-muted" ng-if="!c.data.volunteers || c.data.volunteers.length === 0">
                    <i class="fa fa-info-circle"></i> LOADING_OPERATORS...
                  </div>
                </div>
              </div>
           </div>

           <div class="section-block">
              <h4 class="section-title">
                <i class="fa fa-align-left"></i> DESCRIPTION
              </h4>
              <div class="description-content">
                <div class="desc-row">
                  <i class="fa fa-map-marker text-danger"></i>
                  <strong>LOCATION:</strong> {{item.zone}} - {{item.detail_loc}}
                </div>
                <div class="desc-row">
                  <i class="fa fa-cube text-primary"></i>
                  <strong>TYPE:</strong> {{c.dict[item.category] || item.category}} x {{item.quantity}}
                </div>
                <div class="desc-row">
                  <i class="fa fa-users text-info"></i>
                  <strong>AFFECTED:</strong> {{item.affected_count || 'UNKNOWN'}}
                </div>
                <div class="desc-row" ng-if="item.remarks">
                  <i class="fa fa-sticky-note text-warning"></i>
                  <strong>NOTES:</strong> {{item.remarks}}
                </div>
              </div>
              
              <div class="attachment-preview" ng-if="item.image_url">
                <img ng-src="{{item.image_url}}" alt="ATTACHMENT">
              </div>
           </div>

           <div class="section-block">
              <h4 class="section-title">
                <i class="fa fa-comments"></i> ACTIVITY_LOG
              </h4>
              
              <div class="comment-input-area">
                 <textarea class="comment-textarea" 
                           ng-model="newComment" 
                           placeholder="ADD_INTERNAL_NOTE..."
                           rows="3"></textarea>
                 <button class="comment-submit-btn" ng-click="postComment(item)" ng-disabled="!newComment">
                   <i class="fa fa-paper-plane"></i> SUBMIT
                 </button>
              </div>

              <div class="activity-list" ng-if="item.history && item.history.length > 0">
                 <div class="activity-item" ng-repeat="h in item.history">
                    <div class="activity-avatar">{{h.user.charAt(0)}}</div>
                    <div class="activity-content">
                      <div class="activity-header">
                        <span class="activity-user">{{h.user}}</span>
                        <span class="activity-date">{{h.date}}</span>
                      </div>
                      <div class="activity-text">{{h.text}}</div>
                    </div>
                 </div>
              </div>
              
              <div class="no-activity" ng-if="!item.history || item.history.length === 0">
                <i class="fa fa-comment-o"></i>
                <span>NO_ACTIVITY_YET</span>
              </div>
           </div>
        </div>

        <div class="jira-sidebar-column">
           
           <div class="sidebar-group">
              <div class="sb-label">STATUS</div>
              <div class="sb-value">
                <span class="status-lozenge" ng-class="'lozenge-' + item.state">
                  {{c.statusNames[item.state] || 'OPEN'}}
                </span>
              </div>
           </div>

           <div class="sidebar-group">
              <div class="sb-label">ASSIGNEE</div>
              <div class="sb-value assignee-display">
                <div class="user-avatar" ng-if="item.assigned_to_name">
                  {{item.assigned_to_name.charAt(0)}}
                </div>
                <div class="user-avatar empty" ng-if="!item.assigned_to_name">
                  <i class="fa fa-user"></i>
                </div>
                <span>{{item.assigned_to_name || 'UNASSIGNED'}}</span>
              </div>
           </div>

           <div class="sidebar-group">
              <div class="sb-label">REPORTER</div>
              <div class="sb-value assignee-display">
                <div class="user-avatar reporter">
                  {{(item.reporter_name || item.contact || 'G').charAt(0)}}
                </div>
                <span>{{item.reporter_name || item.contact || 'GUEST'}}</span>
              </div>
           </div>

           <div class="sidebar-group">
              <div class="sb-label">PRIORITY</div>
              <div class="sb-value">
                <span class="priority-lozenge" ng-class="'priority-' + item.urgency">
                  <i class="fa fa-arrow-up" ng-if="item.urgency === 'Critical' || item.urgency === 'High'"></i>
                  <i class="fa fa-arrow-right" ng-if="item.urgency === 'Medium'"></i>
                  <i class="fa fa-arrow-down" ng-if="item.urgency === 'Low'"></i>
                  {{item.urgency}}
                </span>
              </div>
           </div>

           <div class="sidebar-group">
              <div class="sb-label">LOCATION</div>
              <div class="sb-value location-value">
                <i class="fa fa-map-marker"></i>
                {{item.zone}}
              </div>
              <div class="sb-sub">{{item.detail_loc}}</div>
           </div>

           <div class="sidebar-group ai-analysis-box">
              <div class="sb-label">
                <i class="fa fa-magic"></i> AI_ANALYSIS
              </div>
              <div class="ai-content">
                <span ng-if="item.urgency === 'Critical'" class="text-danger">
                  <strong>[CRITICAL]</strong> ÁîüÂëΩ„ÅÆÂç±Èô∫„ÅÇ„Çä„ÄÇÂç≥ÊôÇÂØæÂøúÂøÖÈ†à„ÄÇ
                </span>
                <span ng-if="item.urgency === 'High'" class="text-warning">
                  <strong>[HIGH]</strong> Êó©ÊÄ•„Å™ÂØæÂøú„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                </span>
                <span ng-if="item.urgency === 'Medium'" class="text-info">
                  <strong>[MEDIUM]</strong> ÈÄöÂ∏∏ÂØæÂøú„ÅßÂïèÈ°å„Å™„Åó„ÄÇ
                </span>
                <span ng-if="item.urgency === 'Low'" class="text-success">
                  <strong>[LOW]</strong> Áä∂Ê≥Å„ÅØÂÆâÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                </span>
              </div>
           </div>

           <div class="sidebar-group sla-section">
              <div class="sb-label">SLA_TRACKING</div>
              
              <div class="sla-bar-bg">
                <div class="sla-bar-fill" 
                     ng-class="{'sla-ok': item.sla.status === 'ok', 'sla-warning': item.sla.status === 'warning', 'sla-critical': item.sla.status === 'critical'}"
                     ng-style="{width: item.sla.percentage + '%'}">
                </div>
              </div>
              
              <div class="sla-details">
                <div class="sla-row">
                  <span class="sla-label">ELAPSED</span>
                  <span class="sla-value">{{c.formatHours(item.sla.elapsed)}}</span>
                </div>
                <div class="sla-row">
                  <span class="sla-label">TARGET</span>
                  <span class="sla-value">{{c.formatHours(item.sla.target)}}</span>
                </div>
                <div class="sla-row">
                  <span class="sla-label">REMAINING</span>
                  <span class="sla-value" ng-class="{'text-danger': item.sla.status === 'critical'}">
                    {{c.formatHours(item.sla.remaining)}}
                  </span>
                </div>
              </div>
              
              <div class="sla-status-badge" ng-class="'badge-' + item.sla.status">
                <span ng-if="item.sla.status === 'ok'"><i class="fa fa-check"></i> WITHIN_SLA</span>
                <span ng-if="item.sla.status === 'warning'"><i class="fa fa-exclamation-triangle"></i> WARNING</span>
                <span ng-if="item.sla.status === 'critical'"><i class="fa fa-fire"></i> BREACHED</span>
              </div>
           </div>

           <div class="sidebar-group">
              <div class="sb-label">CREATED</div>
              <div class="sb-value date-value">
                <i class="fa fa-calendar"></i>
                {{item.created_on || item.time_ago}}
              </div>
           </div>
        </div>
      </div>
    </div>
  </div>
</script>]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>05ec022e83c2f210f6b1fb96feaad3a5</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-29 07:47:06</sys_created_on>
        <sys_id>ddec822e83c2f210f6b1fb96feaad336</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-29 07:47:06</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
